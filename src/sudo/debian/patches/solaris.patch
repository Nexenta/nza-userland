Index: sudo-1.7.4p4/Makefile.in
===================================================================
--- sudo-1.7.4p4.orig/Makefile.in	2011-06-07 09:03:08.172503707 +0400
+++ sudo-1.7.4p4/Makefile.in	2011-06-07 09:15:27.366436138 +0400
@@ -24,6 +24,8 @@
 
 #### Start of system configuration section. ####
 
+#$(shell if [ -z "$(MACH64)" ] ; then echo "Run make from Makfile.sfw" >&2 ; exit 1; else [ -d $(MACH64) ] || mkdir $(MACH64) ; fi)
+
 srcdir = @srcdir@
 devdir = @devdir@
 authdir = $(srcdir)/auth
@@ -40,6 +42,7 @@
 
 # Our install program supports extra flags...
 INSTALL = $(SHELL) $(srcdir)/install-sh -c
+INSTALLDOC = $(SHELL) install-sh -c
 
 # Libraries
 LIBS = @LIBS@
@@ -86,6 +89,9 @@
 mandirsu = $(mandir)/$(mantype)$(mansectsu)
 mandirform = $(mandir)/$(mantype)$(mansectform)
 
+datadir = @datadir@
+ldifdir = $(datadir)/lib/ldif
+
 # User and group ids the installed files should be "owned" by
 install_uid = 0
 install_gid = 0
@@ -207,6 +213,19 @@
 libsudo_noexec.la: sudo_noexec.lo
 	$(LIBTOOL) --mode=link $(CC) $(LDFLAGS) -o $@ sudo_noexec.lo -avoid-version -rpath $(noexecdir)
 
+#
+# Create 64-bit versions of the shared library
+#
+$(MACH64)/sudo_noexec.lo: $(srcdir)/sudo_noexec.c
+	mkdir -p $(MACH64)
+	$(LIBTOOL) --mode=compile $(CC) -m64 -c $(CPPFLAGS) $(CFLAGS64) $(DEFS) $(OPTIONS) -o $(MACH64)/sudo_noexec.o $(srcdir)/sudo_noexec.c
+
+$(MACH64)/libsudo_noexec.la: $(MACH64)/sudo_noexec.lo
+	mkdir -p $(MACH64)
+	$(LIBTOOL) --mode=link $(CC) $(LDFLAGS) -m64 -o $@ $(MACH64)/sudo_noexec.lo -avoid-version -rpath $(noexecdir)
+
+libsudo_noexec: libsudo_noexec.la $(MACH64)/libsudo_noexec.la
+
 # Uncomment the following if you want "make distclean" to clean the parser
 @DEV@GENERATED = gram.h gram.c toke.c def_data.c def_data.h getdate
 
@@ -475,45 +494,51 @@
 	    hg log --style=changelog -b default --date '<2010-01-18 00:00:00' >> $@; \
 	fi
 
-install: install-dirs install-binaries @INSTALL_NOEXEC@ install-sudoers install-doc
+install: install-dirs install-binaries @INSTALL_NOEXEC@ install-sudoers install-doc install-ldif
 
 install-dirs:
 	$(SHELL) $(srcdir)/mkinstalldirs $(DESTDIR)$(sudodir) \
-	    $(DESTDIR)$(visudodir) $(DESTDIR)$(noexecdir) \
+	    $(DESTDIR)$(visudodir) $(DESTDIR)$(noexecdir) $(DESTDIR)$(noexecdir)/$(MACH64) \
 	    $(DESTDIR)$(sudoersdir) $(DESTDIR)$(docdir) \
-	    $(DESTDIR)$(mandirsu) $(DESTDIR)$(mandirform)
-	$(SHELL) $(srcdir)/mkinstalldirs -m 0700 $(DESTDIR)$(timedir)
+	    $(DESTDIR)$(mandirsu) $(DESTDIR)$(mandirform) \
+	    $(DESTDIR)$(ldifdir)
 
 install-binaries: install-dirs $(PROGS)
-	$(INSTALL) -b~ -O $(install_uid) -G $(install_gid) -M 04111 sudo $(DESTDIR)$(sudodir)/sudo
+	$(INSTALL) -O $(install_uid) -G $(install_gid) -m 04111 sudo $(DESTDIR)$(sudodir)/sudo
 	rm -f $(DESTDIR)$(sudodir)/sudoedit
 	ln $(DESTDIR)$(sudodir)/sudo $(DESTDIR)$(sudodir)/sudoedit
-	if [ -f sudoreplay ]; then $(INSTALL) -b~ -O $(install_uid) -G $(install_gid) -M 0111 sudoreplay $(DESTDIR)$(sudodir)/sudoreplay; fi
-	$(INSTALL) -b~ -O $(install_uid) -G $(install_gid) -M 0111 visudo $(DESTDIR)$(visudodir)/visudo
-	if [ -f sesh ]; then $(INSTALL) -b~ -O $(install_uid) -G $(install_gid) -M 0111 sesh $(DESTDIR)$(libexecdir)/sesh; fi
-
-install-noexec: install-dirs libsudo_noexec.la
-	if [ -f .libs/lib$(noexecfile) ]; then $(INSTALL) -b~ -O $(install_uid) -G $(install_gid) -M 0755 .libs/lib$(noexecfile) $(DESTDIR)$(noexecdir)/$(noexecfile); fi
+	if [ -f sudoreplay ]; then $(INSTALL) -O $(install_uid) -G $(install_gid) -m 0111 sudoreplay $(DESTDIR)$(sudodir)/sudoreplay; fi
+	$(INSTALL) -O $(install_uid) -G $(install_gid) -m 0111 visudo $(DESTDIR)$(visudodir)/visudo
+	if [ -f sesh ]; then $(INSTALL) -O $(install_uid) -G $(install_gid) -m 0111 sesh $(DESTDIR)$(libexecdir)/sesh; fi
+
+install-noexec: install-dirs libsudo_noexec.la $(MACH64)/libsudo_noexec.la
+	if [ -f .libs/lib$(noexecfile) ]; then $(INSTALL) -O $(install_uid) -G $(install_gid) -m 0755 .libs/lib$(noexecfile) $(DESTDIR)$(noexecdir)/$(noexecfile); fi
+	if [ -f $(MACH64)/.libs/lib$(noexecfile) ]; then $(INSTALL) -O $(install_uid) -G $(install_gid) -m 0755 $(MACH64)/.libs/lib$(noexecfile) $(DESTDIR)$(noexecdir)/$(MACH64)/$(noexecfile); fi
 
 install-sudoers: install-dirs
-	$(INSTALL) -d -O $(sudoers_uid) -G $(sudoers_gid) -M 0750 \
+	$(INSTALL) -d -O $(sudoers_uid) -G $(sudoers_gid) -m 0750 \
 	    $(DESTDIR)$(sudoersdir)/sudoers.d
 	test -f $(DESTDIR)$(sudoersdir)/sudoers || \
-	    $(INSTALL) -O $(sudoers_uid) -G $(sudoers_gid) -M $(sudoers_mode) \
+	    $(INSTALL) -O $(sudoers_uid) -G $(sudoers_gid) -m $(sudoers_mode) \
 		sudoers $(DESTDIR)$(sudoersdir)/sudoers
 
 install-doc: install-dirs ChangeLog
-	(cd $(srcdir) && for f in ChangeLog HISTORY LICENSE NEWS README TROUBLESHOOTING UPGRADE sample.*; do $(INSTALL) -O $(install_uid) -G $(install_gid) -M 0444 $$f $(DESTDIR)$(docdir); done)
-	@LDAP@(cd $(srcdir) && for f in README.LDAP schema.* sudoers2ldif; do $(INSTALL) -O $(install_uid) -G $(install_gid) -M 0444 $$f $(DESTDIR)$(docdir); done)
-	$(INSTALL) -O $(install_uid) -G $(install_gid) -M 0444 @mansrcdir@/sudo.$(mantype) $(DESTDIR)$(mandirsu)/sudo.$(mansectsu)
+	(cd $(srcdir) && for f in ChangeLog HISTORY LICENSE NEWS README TROUBLESHOOTING UPGRADE sample.*; do $(INSTALLDOC) -O $(install_uid) -G $(install_gid) -m 0444 $$f $(DESTDIR)$(docdir); done)
+	@LDAP@(cd $(srcdir) && for f in README.LDAP schema.* sudoers2ldif; do $(INSTALL) -O $(install_uid) -G $(install_gid) -m 0444 $$f $(DESTDIR)$(docdir); done)
+	$(INSTALL) -O $(install_uid) -G $(install_gid) -m 0444 @mansrcdir@/sudo.$(mantype) $(DESTDIR)$(mandirsu)/sudo.$(mansectsu)
 	@rm -f $(DESTDIR)$(mandirsu)/sudoedit.$(mansectsu)
 	ln $(DESTDIR)$(mandirsu)/sudo.$(mansectsu) $(DESTDIR)$(mandirsu)/sudoedit.$(mansectsu)
-	@REPLAY@$(INSTALL) -O $(install_uid) -G $(install_gid) -M 0444 @mansrcdir@/sudoreplay.$(mantype) $(DESTDIR)$(mandirsu)/sudoreplay.$(mansectsu)
-	$(INSTALL) -O $(install_uid) -G $(install_gid) -M 0444 @mansrcdir@/visudo.$(mantype) $(DESTDIR)$(mandirsu)/visudo.$(mansectsu)
-	$(INSTALL) -O $(install_uid) -G $(install_gid) -M 0444 @mansrcdir@/sudoers.$(mantype) $(DESTDIR)$(mandirform)/sudoers.$(mansectform)
-	@LDAP@$(INSTALL) -O $(install_uid) -G $(install_gid) -M 0444 @mansrcdir@/sudoers.ldap.$(mantype) $(DESTDIR)$(mandirform)/sudoers.ldap.$(mansectform)
+	@REPLAY@$(INSTALL) -O $(install_uid) -G $(install_gid) -m 0444 @mansrcdir@/sudoreplay.$(mantype) $(DESTDIR)$(mandirsu)/sudoreplay.$(mansectsu)
+	$(INSTALL) -O $(install_uid) -G $(install_gid) -m 0444 @mansrcdir@/visudo.$(mantype) $(DESTDIR)$(mandirsu)/visudo.$(mansectsu)
+	$(INSTALL) -O $(install_uid) -G $(install_gid) -m 0444 @mansrcdir@/sudoers.$(mantype) $(DESTDIR)$(mandirform)/sudoers.$(mansectform)
+	@LDAP@$(INSTALL) -O $(install_uid) -G $(install_gid) -m 0444 @mansrcdir@/sudoers.ldap.$(mantype) $(DESTDIR)$(mandirform)/sudoers.ldap.$(mansectform)
 @MAN_POSTINSTALL@
 
+install-ldif:
+	$(INSTALL) -O $(install_uid) -G $(install_gid) -m 0444 $(srcdir)/schema.OpenLDAP $(DESTDIR)$(ldifdir)/sudo-schema.OpenLDAP
+	$(INSTALL) -O $(install_uid) -G $(install_gid) -m 0444 $(srcdir)/schema.iPlanet $(DESTDIR)$(ldifdir)/sudo-schema.iPlanet
+	$(INSTALL) -O $(install_uid) -G $(install_gid) -m 0444 $(srcdir)/sudoers2ldif $(DESTDIR)$(ldifdir)/sudoers2ldif
+
 check:
 	@echo nothing to check
 
@@ -524,7 +549,8 @@
 
 distclean: clean
 	-rm -rf Makefile pathnames.h config.h config.status config.cache \
-		config.log libtool sudoers sudo_noexec.lo .libs $(GENERATED) \
+		config.log libtool sudoers sudo_noexec.lo .libs $(MACH64) $(GENERATED) \
+		.libs $(GENERATED) \
 		sudo.man sudoers.man sudoers.ldap.man sudoreplay.man \
 		visudo.man sudo_usage.h Makefile.binary
 
Index: sudo-1.7.4p4/configure
===================================================================
--- sudo-1.7.4p4.orig/configure	2011-06-07 09:03:07.970847440 +0400
+++ sudo-1.7.4p4/configure	2011-06-07 09:03:10.000000000 +0400
@@ -18438,7 +18438,7 @@
 	fi
     fi
     if test X"$with_noexec" != X"no"; then
-	PROGS="${PROGS} libsudo_noexec.la"
+	PROGS="${PROGS} libsudo_noexec"
 	INSTALL_NOEXEC="install-noexec"
 
 	eval noexec_file="$with_noexec"
Index: sudo-1.7.4p4/env.c
===================================================================
--- sudo-1.7.4p4.orig/env.c	2011-06-07 09:03:10.000000000 +0400
+++ sudo-1.7.4p4/env.c	2011-06-07 09:03:10.000000000 +0400
@@ -805,7 +805,28 @@
 #  ifdef _AIX
 	sudo_setenv("LDR_PRELOAD", def_noexec_file, TRUE);
 #  else
+#    ifdef __sun
+	{
+	    char *p = NULL;
+	    char path[MAXPATHLEN], path64[MAXPATHLEN];
+
+	    if (strlcpy(path, def_noexec_file, sizeof (path)) < sizeof (path))
+	        p = strrchr(path, '/');
+	    if (p != NULL) {
+	        /* full pathname specified; set both 32/64 LD_PRELOAD vars */
+		*p = '\0';
+		if (snprintf(path64, sizeof (path64), "%s/64/%s",
+			path, p+1) < sizeof (path64))
+		    sudo_setenv("LD_PRELOAD_64", path64, TRUE);
+		sudo_setenv("LD_PRELOAD_32", def_noexec_file, TRUE);
+	    } else {
+	        /* relative pathname specified, ld.so.1 will search */
+		sudo_setenv("LD_PRELOAD", def_noexec_file,  TRUE);
+	    }
+	}
+#    else
 	sudo_setenv("LD_PRELOAD", def_noexec_file, TRUE);
+#    endif /* __sun */
 #  endif /* _AIX */
 # endif /* __osf__ || __sgi */
 #endif /* __darwin__ || __APPLE__ */
Index: sudo-1.7.4p4/config.h.in
===================================================================
--- sudo-1.7.4p4.orig/config.h.in	2011-06-07 09:03:08.304557256 +0400
+++ sudo-1.7.4p4/config.h.in	2011-06-07 09:03:10.000000000 +0400
@@ -371,7 +371,7 @@
 #undef HAVE_PAM_PAM_APPL_H
 
 /* Define to 1 if you have the <paths.h> header file. */
-#undef HAVE_PATHS_H
+//#undef HAVE_PATHS_H
 
 /* Define to 1 if you have the `posix_openpt' function. */
 #undef HAVE_POSIX_OPENPT
