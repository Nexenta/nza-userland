Description: Upstream changes introduced in version 1.25-3nexenta2
 This patch has been created by dpkg-source during the package build.
 Here's the last changelog entry, hopefully it gives details on why
 those changes were made:
 .
 tar (1.25-3nexenta2) unstable; urgency=low
 .
   * Updated to NCP4 with SFW configs
 .
 The person named in the Author field signed this changelog entry.
Author: Igor Kozhukhov <igor.kozhukhov@nexenta.com>

---
The information above should follow the Patch Tagging Guidelines, please
checkout http://dep.debian.net/deps/dep3/ to learn about the format. Here
are templates for supplementary fields that you might want to add:

Origin: <vendor|upstream|other>, <url of original patch>
Bug: <url in upstream bugtracker>
Bug-Debian: http://bugs.debian.org/<bugnumber>
Bug-Ubuntu: https://launchpad.net/bugs/<bugnumber>
Forwarded: <no|not-needed|url proving that it has been forwarded>
Reviewed-By: <name and email of someone who approved the patch>
Last-Update: <YYYY-MM-DD>

--- tar-1.25.orig/src/tar.c
+++ tar-1.25/src/tar.c
@@ -2566,16 +2566,6 @@ decode_options (int argc, char **argv)
   report_textual_dates (&args);
 }
 
-/* Debian specific environment variable used by pristine-tar to enable use of
- * longlinks for filenames exactly 100 bytes long. */
-void debian_longlink_hack_init () {
- char *s=getenv ("TAR_LONGLINK_100");
- if (s && strcmp(s, "1") == 0)
-	 debian_longlink_hack=1;
- else
-	 debian_longlink_hack=0;
-}
-
 
 /* Tar proper.  */
 
@@ -2595,8 +2585,6 @@ main (int argc, char **argv)
   filename_terminator = '\n';
   set_quoting_style (0, DEFAULT_QUOTING_STYLE);
 
-  debian_longlink_hack_init ();
-
   /* Make sure we have first three descriptors available */
   stdopen ();
 
--- tar-1.25.orig/src/create.c
+++ tar-1.25/src/create.c
@@ -26,8 +26,6 @@
 #include "common.h"
 #include <hash.h>
 
-extern int debian_longlink_hack;
-
 /* Error number to use when an impostor is discovered.
    Pretend the impostor isn't there.  */
 enum { IMPOSTOR_ERRNO = ENOENT };
@@ -737,7 +735,7 @@ write_header_name (struct tar_stat_info
       return write_short_name (st);
     }
   else if (NAME_FIELD_SIZE - (archive_format == OLDGNU_FORMAT)
-	   < strlen (st->file_name) + debian_longlink_hack)
+	   < strlen (st->file_name))
     return write_long_name (st);
   else
     return write_short_name (st);
@@ -1458,7 +1456,7 @@ dump_hard_link (struct tar_stat_info *st
 	  block_ordinal = current_block_ordinal ();
 	  assign_string (&st->link_name, link_name);
 	  if (NAME_FIELD_SIZE - (archive_format == OLDGNU_FORMAT)
-	      < strlen (link_name) + debian_longlink_hack)
+	      < strlen (link_name))
 	    write_long_link (st);
 
 	  st->stat.st_size = 0;
--- tar-1.25.orig/src/common.h
+++ tar-1.25/src/common.h
@@ -834,5 +834,3 @@ void finish_deferred_unlinks (void);
 
 /* Module exit.c */
 extern void (*fatal_exit_hook) (void);
-
-GLOBAL int debian_longlink_hack;
--- tar-1.25.orig/build-aux/config.guess
+++ tar-1.25/build-aux/config.guess
@@ -4,7 +4,7 @@
 #   2000, 2001, 2002, 2003, 2004, 2005, 2006, 2007, 2008, 2009, 2010
 #   Free Software Foundation, Inc.
 
-timestamp='2010-09-24'
+timestamp='2009-12-30'
 
 # This file is free software; you can redistribute it and/or modify it
 # under the terms of the GNU General Public License as published by
@@ -92,7 +92,7 @@ if test $# != 0; then
   exit 1
 fi
 
-trap 'exit 1' HUP INT TERM
+trap 'exit 1' 1 2 15
 
 # CC_FOR_BUILD -- compiler used by this script. Note that the use of a
 # compiler to aid in system detection is discouraged as it requires
@@ -106,7 +106,7 @@ trap 'exit 1' HUP INT TERM
 
 set_cc_for_build='
 trap "exitcode=\$?; (rm -f \$tmpfiles 2>/dev/null; rmdir \$tmp 2>/dev/null) && exit \$exitcode" 0 ;
-trap "rm -f \$tmpfiles 2>/dev/null; rmdir \$tmp 2>/dev/null; exit 1" HUP INT PIPE TERM ;
+trap "rm -f \$tmpfiles 2>/dev/null; rmdir \$tmp 2>/dev/null; exit 1" 1 2 13 15 ;
 : ${TMPDIR=/tmp} ;
  { tmp=`(umask 077 && mktemp -d "$TMPDIR/cgXXXXXX") 2>/dev/null` && test -n "$tmp" && test -d "$tmp" ; } ||
  { test -n "$RANDOM" && tmp=$TMPDIR/cg$$-$RANDOM && (umask 077 && mkdir $tmp) ; } ||
@@ -552,7 +552,7 @@ EOF
 		echo rs6000-ibm-aix3.2
 	fi
 	exit ;;
-    *:AIX:*:[4567])
+    *:AIX:*:[456])
 	IBM_CPU_ID=`/usr/sbin/lsdev -C -c processor -S available | sed 1q | awk '{ print $1 }'`
 	if /usr/sbin/lsattr -El ${IBM_CPU_ID} | grep ' POWER' >/dev/null 2>&1; then
 		IBM_ARCH=rs6000
@@ -968,9 +968,6 @@ EOF
     sparc:Linux:*:* | sparc64:Linux:*:*)
 	echo ${UNAME_MACHINE}-unknown-linux-gnu
 	exit ;;
-    tile*:Linux:*:*)
-	echo ${UNAME_MACHINE}-tilera-linux-gnu
-	exit ;;
     vax:Linux:*:*)
 	echo ${UNAME_MACHINE}-dec-linux-gnu
 	exit ;;
@@ -1234,9 +1231,6 @@ EOF
     *:QNX:*:4*)
 	echo i386-pc-qnx
 	exit ;;
-    NEO-?:NONSTOP_KERNEL:*:*)
-	echo neo-tandem-nsk${UNAME_RELEASE}
-	exit ;;
     NSE-?:NONSTOP_KERNEL:*:*)
 	echo nse-tandem-nsk${UNAME_RELEASE}
 	exit ;;
--- tar-1.25.orig/build-aux/config.sub
+++ tar-1.25/build-aux/config.sub
@@ -4,7 +4,7 @@
 #   2000, 2001, 2002, 2003, 2004, 2005, 2006, 2007, 2008, 2009, 2010
 #   Free Software Foundation, Inc.
 
-timestamp='2010-09-11'
+timestamp='2010-01-22'
 
 # This file is (in principle) common to ALL GNU software.
 # The presence of a machine in this file suggests that SOME GNU software
@@ -124,9 +124,8 @@ esac
 # Here we must recognize all the valid KERNEL-OS combinations.
 maybe_os=`echo $1 | sed 's/^\(.*\)-\([^-]*-[^-]*\)$/\2/'`
 case $maybe_os in
-  nto-qnx* | linux-gnu* | linux-android* | linux-dietlibc | linux-newlib* | \
-  linux-uclibc* | uclinux-uclibc* | uclinux-gnu* | kfreebsd*-gnu* | \
-  knetbsd*-gnu* | netbsd*-gnu* | \
+  nto-qnx* | linux-gnu* | linux-dietlibc | linux-newlib* | linux-uclibc* | \
+  uclinux-uclibc* | uclinux-gnu* | kfreebsd*-gnu* | knetbsd*-gnu* | netbsd*-gnu* | \
   kopensolaris*-gnu* | \
   storm-chaos* | os2-emx* | rtmk-nova*)
     os=-$maybe_os
@@ -283,7 +282,6 @@ case $basic_machine in
 	| moxie \
 	| mt \
 	| msp430 \
-	| nds32 | nds32le | nds32be \
 	| nios | nios2 \
 	| ns16k | ns32k \
 	| or32 \
@@ -297,7 +295,7 @@ case $basic_machine in
 	| sparc | sparc64 | sparc64b | sparc64v | sparc86x | sparclet | sparclite \
 	| sparcv8 | sparcv9 | sparcv9b | sparcv9v \
 	| spu | strongarm \
-	| tahoe | thumb | tic4x | tic54x | tic55x | tic6x | tic80 | tron \
+	| tahoe | thumb | tic4x | tic80 | tron \
 	| ubicom32 \
 	| v850 | v850e \
 	| we32k \
@@ -305,15 +303,6 @@ case $basic_machine in
 	| z8k | z80)
 		basic_machine=$basic_machine-unknown
 		;;
-	c54x)
-		basic_machine=tic54x-unknown
-		;;
-	c55x)
-		basic_machine=tic55x-unknown
-		;;
-	c6x)
-		basic_machine=tic6x-unknown
-		;;
 	m6811 | m68hc11 | m6812 | m68hc12 | picochip)
 		# Motorola 68HC11/12.
 		basic_machine=$basic_machine-unknown
@@ -345,7 +334,7 @@ case $basic_machine in
 	| arm-*  | armbe-* | armle-* | armeb-* | armv*-* \
 	| avr-* | avr32-* \
 	| bfin-* | bs2000-* \
-	| c[123]* | c30-* | [cjt]90-* | c4x-* \
+	| c[123]* | c30-* | [cjt]90-* | c4x-* | c54x-* | c55x-* | c6x-* \
 	| clipper-* | craynv-* | cydra-* \
 	| d10v-* | d30v-* | dlx-* \
 	| elxsi-* \
@@ -379,7 +368,6 @@ case $basic_machine in
 	| mmix-* \
 	| mt-* \
 	| msp430-* \
-	| nds32-* | nds32le-* | nds32be-* \
 	| nios-* | nios2-* \
 	| none-* | np1-* | ns16k-* | ns32k-* \
 	| orion-* \
@@ -494,15 +482,6 @@ case $basic_machine in
 		basic_machine=powerpc-ibm
 		os=-cnk
 		;;
-	c54x-*)
-		basic_machine=tic54x-`echo $basic_machine | sed 's/^[^-]*-//'`
-		;;
-	c55x-*)
-		basic_machine=tic55x-`echo $basic_machine | sed 's/^[^-]*-//'`
-		;;
-	c6x-*)
-		basic_machine=tic6x-`echo $basic_machine | sed 's/^[^-]*-//'`
-		;;
 	c90)
 		basic_machine=c90-cray
 		os=-unicos
@@ -862,12 +841,6 @@ case $basic_machine in
 	np1)
 		basic_machine=np1-gould
 		;;
-        neo-tandem)
-		basic_machine=neo-tandem
-		;;
-        nse-tandem)
-		basic_machine=nse-tandem
-		;;
 	nsr-tandem)
 		basic_machine=nsr-tandem
 		;;
@@ -1102,6 +1075,18 @@ case $basic_machine in
 		basic_machine=t90-cray
 		os=-unicos
 		;;
+	tic54x | c54x*)
+		basic_machine=tic54x-unknown
+		os=-coff
+		;;
+	tic55x | c55x*)
+		basic_machine=tic55x-unknown
+		os=-coff
+		;;
+	tic6x | c6x*)
+		basic_machine=tic6x-unknown
+		os=-coff
+		;;
         # This must be matched before tile*.
         tilegx*)
 		basic_machine=tilegx-unknown
@@ -1316,8 +1301,7 @@ case $os in
 	      | -udi* | -eabi* | -lites* | -ieee* | -go32* | -aux* \
 	      | -chorusos* | -chorusrdb* | -cegcc* \
 	      | -cygwin* | -pe* | -psos* | -moss* | -proelf* | -rtems* \
-	      | -mingw32* | -linux-gnu* | -linux-android* \
-	      | -linux-newlib* | -linux-uclibc* \
+	      | -mingw32* | -linux-gnu* | -linux-newlib* | -linux-uclibc* \
 	      | -uxpv* | -beos* | -mpeix* | -udk* \
 	      | -interix* | -uwin* | -mks* | -rhapsody* | -darwin* | -opened* \
 	      | -openstep* | -oskit* | -conix* | -pw32* | -nonstopux* \
@@ -1500,15 +1484,6 @@ case $basic_machine in
         c4x-* | tic4x-*)
         	os=-coff
 		;;
-	tic54x-*)
-		os=-coff
-		;;
-	tic55x-*)
-		os=-coff
-		;;
-	tic6x-*)
-		os=-coff
-		;;
 	# This must come before the *-dec entry.
 	pdp10-*)
 		os=-tops20
--- /dev/null
+++ tar-1.25/tests/listed04.at
@@ -0,0 +1,47 @@
+# Process this file with autom4te to create testsuite. -*- Autotest -*-
+
+# Test suite for GNU tar.
+# Copyright (C) 2010 Free Software Foundation, Inc.
+
+# This program is free software; you can redistribute it and/or modify
+# it under the terms of the GNU General Public License as published by
+# the Free Software Foundation; either version 3, or (at your option)
+# any later version.
+
+# This program is distributed in the hope that it will be useful,
+# but WITHOUT ANY WARRANTY; without even the implied warranty of
+# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+# GNU General Public License for more details.
+
+# You should have received a copy of the GNU General Public License
+# along with this program.  If not, see <http://www.gnu.org/licenses/>.
+
+# This checks for the bug reported by Martin Weigel
+# <http://lists.gnu.org/archive/html/bug-tar/2010-11/msg00071.html>.
+# The test is derived from the ideas in Jean-Louis Martineau's followup email
+# <http://lists.gnu.org/archive/html/bug-tar/2010-11/msg00087.html>.
+
+AT_SETUP([--listed-incremental and --one-file-system])
+AT_KEYWORDS([listed incremental listed04])
+
+AT_TAR_CHECK([
+
+mkdir dir
+echo a >dir/a
+echo b >dir/b
+
+tar --one-file-system -cvf archive.tar -g archive.incr dir || exit
+tar -tf archive.tar || exit
+],
+[0],
+[dir/
+dir/a
+dir/b
+dir/
+dir/a
+dir/b
+],
+[tar: dir: Directory is new
+],[],[],[gnu])
+
+AT_CLEANUP
--- tar-1.25.orig/tests/testsuite
+++ tar-1.25/tests/testsuite
@@ -1,17 +1,17 @@
 #! /bin/sh
-# Generated from testsuite.at by GNU Autoconf 2.63.
+# Generated from testsuite.at by GNU Autoconf 2.67.
+#
+# Copyright (C) 2009, 2010 Free Software Foundation, Inc.
 #
-# Copyright (C) 2000, 2001, 2002, 2003, 2004, 2005, 2006, 2007, 2008
-# Free Software Foundation, Inc.
 # This test suite is free software; the Free Software Foundation gives
 # unlimited permission to copy, distribute and modify it.
-## --------------------- ##
-## M4sh Initialization.  ##
-## --------------------- ##
+## -------------------- ##
+## M4sh Initialization. ##
+## -------------------- ##
 
 # Be more Bourne compatible
 DUALCASE=1; export DUALCASE # for MKS sh
-if test -n "${ZSH_VERSION+set}" && (emulate sh) >/dev/null 2>&1; then
+if test -n "${ZSH_VERSION+set}" && (emulate sh) >/dev/null 2>&1; then :
   emulate sh
   NULLCMD=:
   # Pre-4.2 versions of Zsh do word splitting on ${1+"$@"}, which
@@ -19,23 +19,15 @@ if test -n "${ZSH_VERSION+set}" && (emul
   alias -g '${1+"$@"}'='"$@"'
   setopt NO_GLOB_SUBST
 else
-  case `(set -o) 2>/dev/null` in
-  *posix*) set -o posix ;;
+  case `(set -o) 2>/dev/null` in #(
+  *posix*) :
+    set -o posix ;; #(
+  *) :
+     ;;
 esac
-
 fi
 
 
-
-
-# PATH needs CR
-# Avoid depending upon Character Ranges.
-as_cr_letters='abcdefghijklmnopqrstuvwxyz'
-as_cr_LETTERS='ABCDEFGHIJKLMNOPQRSTUVWXYZ'
-as_cr_Letters=$as_cr_letters$as_cr_LETTERS
-as_cr_digits='0123456789'
-as_cr_alnum=$as_cr_Letters$as_cr_digits
-
 as_nl='
 '
 export as_nl
@@ -43,7 +35,13 @@ export as_nl
 as_echo='\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\'
 as_echo=$as_echo$as_echo$as_echo$as_echo$as_echo
 as_echo=$as_echo$as_echo$as_echo$as_echo$as_echo$as_echo
-if (test "X`printf %s $as_echo`" = "X$as_echo") 2>/dev/null; then
+# Prefer a ksh shell builtin over an external printf program on Solaris,
+# but without wasting forks for bash or zsh.
+if test -z "$BASH_VERSION$ZSH_VERSION" \
+    && (test "X`print -r -- $as_echo`" = "X$as_echo") 2>/dev/null; then
+  as_echo='print -r --'
+  as_echo_n='print -rn --'
+elif (test "X`printf %s $as_echo`" = "X$as_echo") 2>/dev/null; then
   as_echo='printf %s\n'
   as_echo_n='printf %s'
 else
@@ -54,7 +52,7 @@ else
     as_echo_body='eval expr "X$1" : "X\\(.*\\)"'
     as_echo_n_body='eval
       arg=$1;
-      case $arg in
+      case $arg in #(
       *"$as_nl"*)
 	expr "X$arg" : "X\\(.*\\)$as_nl";
 	arg=`expr "X$arg" : ".*$as_nl\\(.*\\)"`;;
@@ -77,13 +75,6 @@ if test "${PATH_SEPARATOR+set}" != set;
   }
 fi
 
-# Support unset when possible.
-if ( (MAIL=60; unset MAIL) || exit) >/dev/null 2>&1; then
-  as_unset=unset
-else
-  as_unset=false
-fi
-
 
 # IFS
 # We need space, tab and new line, in precisely that order.  Quoting is
@@ -93,15 +84,15 @@ fi
 IFS=" ""	$as_nl"
 
 # Find who we are.  Look in the path if we contain no directory separator.
-case $0 in
+case $0 in #((
   *[\\/]* ) as_myself=$0 ;;
   *) as_save_IFS=$IFS; IFS=$PATH_SEPARATOR
 for as_dir in $PATH
 do
   IFS=$as_save_IFS
   test -z "$as_dir" && as_dir=.
-  test -r "$as_dir/$0" && as_myself=$as_dir/$0 && break
-done
+    test -r "$as_dir/$0" && as_myself=$as_dir/$0 && break
+  done
 IFS=$as_save_IFS
 
      ;;
@@ -113,12 +104,16 @@ if test "x$as_myself" = x; then
 fi
 if test ! -f "$as_myself"; then
   $as_echo "$as_myself: error: cannot find myself; rerun with an absolute file name" >&2
-  { (exit 1); exit 1; }
+  exit 1
 fi
 
-# Work around bugs in pre-3.0 UWIN ksh.
-for as_var in ENV MAIL MAILPATH
-do ($as_unset $as_var) >/dev/null 2>&1 && $as_unset $as_var
+# Unset variables that we do not need and which cause bugs (e.g. in
+# pre-3.0 UWIN ksh).  But do not cause bugs in bash 2.01; the "|| exit 1"
+# suppresses any "Segmentation fault" message there.  '((' could
+# trigger a bug in pdksh 5.2.14.
+for as_var in BASH_ENV ENV MAIL MAILPATH
+do eval test x\${$as_var+set} = xset \
+  && ( (unset $as_var) || exit 1) >/dev/null 2>&1 && unset $as_var || :
 done
 PS1='$ '
 PS2='> '
@@ -130,330 +125,299 @@ export LC_ALL
 LANGUAGE=C
 export LANGUAGE
 
-# Required to use basename.
-if expr a : '\(a\)' >/dev/null 2>&1 &&
-   test "X`expr 00001 : '.*\(...\)'`" = X001; then
-  as_expr=expr
-else
-  as_expr=false
-fi
-
-if (basename -- /) >/dev/null 2>&1 && test "X`basename -- / 2>&1`" = "X/"; then
-  as_basename=basename
-else
-  as_basename=false
-fi
-
-
-# Name of the executable.
-as_me=`$as_basename -- "$0" ||
-$as_expr X/"$0" : '.*/\([^/][^/]*\)/*$' \| \
-	 X"$0" : 'X\(//\)$' \| \
-	 X"$0" : 'X\(/\)' \| . 2>/dev/null ||
-$as_echo X/"$0" |
-    sed '/^.*\/\([^/][^/]*\)\/*$/{
-	    s//\1/
-	    q
-	  }
-	  /^X\/\(\/\/\)$/{
-	    s//\1/
-	    q
-	  }
-	  /^X\/\(\/\).*/{
-	    s//\1/
-	    q
-	  }
-	  s/.*/./; q'`
-
 # CDPATH.
-$as_unset CDPATH
-
+(unset CDPATH) >/dev/null 2>&1 && unset CDPATH
 
 if test "x$CONFIG_SHELL" = x; then
-  if (eval ":") 2>/dev/null; then
-  as_have_required=yes
+  as_bourne_compatible="if test -n \"\${ZSH_VERSION+set}\" && (emulate sh) >/dev/null 2>&1; then :
+  emulate sh
+  NULLCMD=:
+  # Pre-4.2 versions of Zsh do word splitting on \${1+\"\$@\"}, which
+  # is contrary to our usage.  Disable this feature.
+  alias -g '\${1+\"\$@\"}'='\"\$@\"'
+  setopt NO_GLOB_SUBST
 else
-  as_have_required=no
+  case \`(set -o) 2>/dev/null\` in #(
+  *posix*) :
+    set -o posix ;; #(
+  *) :
+     ;;
+esac
 fi
-
-  if test $as_have_required = yes &&	 (eval ":
-(as_func_return () {
-  (exit \$1)
-}
-as_func_success () {
-  as_func_return 0
-}
-as_func_failure () {
-  as_func_return 1
-}
-as_func_ret_success () {
-  return 0
-}
-as_func_ret_failure () {
-  return 1
-}
+"
+  as_required="as_fn_return () { (exit \$1); }
+as_fn_success () { as_fn_return 0; }
+as_fn_failure () { as_fn_return 1; }
+as_fn_ret_success () { return 0; }
+as_fn_ret_failure () { return 1; }
 
 exitcode=0
-if as_func_success; then
-  :
-else
-  exitcode=1
-  echo as_func_success failed.
-fi
-
-if as_func_failure; then
-  exitcode=1
-  echo as_func_failure succeeded.
-fi
-
-if as_func_ret_success; then
-  :
-else
-  exitcode=1
-  echo as_func_ret_success failed.
-fi
-
-if as_func_ret_failure; then
-  exitcode=1
-  echo as_func_ret_failure succeeded.
-fi
-
-if ( set x; as_func_ret_success y && test x = \"\$1\" ); then
-  :
+as_fn_success || { exitcode=1; echo as_fn_success failed.; }
+as_fn_failure && { exitcode=1; echo as_fn_failure succeeded.; }
+as_fn_ret_success || { exitcode=1; echo as_fn_ret_success failed.; }
+as_fn_ret_failure && { exitcode=1; echo as_fn_ret_failure succeeded.; }
+if ( set x; as_fn_ret_success y && test x = \"\$1\" ); then :
+
+else
+  exitcode=1; echo positional parameters were not saved.
+fi
+test x\$exitcode = x0 || exit 1"
+  as_suggested="  as_lineno_1=";as_suggested=$as_suggested$LINENO;as_suggested=$as_suggested" as_lineno_1a=\$LINENO
+  as_lineno_2=";as_suggested=$as_suggested$LINENO;as_suggested=$as_suggested" as_lineno_2a=\$LINENO
+  eval 'test \"x\$as_lineno_1'\$as_run'\" != \"x\$as_lineno_2'\$as_run'\" &&
+  test \"x\`expr \$as_lineno_1'\$as_run' + 1\`\" = \"x\$as_lineno_2'\$as_run'\"' || exit 1
+test \$(( 1 + 1 )) = 2 || exit 1"
+  if (eval "$as_required") 2>/dev/null; then :
+  as_have_required=yes
 else
-  exitcode=1
-  echo positional parameters were not saved.
+  as_have_required=no
 fi
+  if test x$as_have_required = xyes && (eval "$as_suggested") 2>/dev/null; then :
 
-test \$exitcode = 0) || { (exit 1); exit 1; }
-
-(
-  as_lineno_1=\$LINENO
-  as_lineno_2=\$LINENO
-  test \"x\$as_lineno_1\" != \"x\$as_lineno_2\" &&
-  test \"x\`expr \$as_lineno_1 + 1\`\" = \"x\$as_lineno_2\") || { (exit 1); exit 1; }
-") 2> /dev/null; then
-  :
 else
-  as_candidate_shells=
-    as_save_IFS=$IFS; IFS=$PATH_SEPARATOR
+  as_save_IFS=$IFS; IFS=$PATH_SEPARATOR
+as_found=false
 for as_dir in /bin$PATH_SEPARATOR/usr/bin$PATH_SEPARATOR$PATH
 do
   IFS=$as_save_IFS
   test -z "$as_dir" && as_dir=.
-  case $as_dir in
+  as_found=:
+  case $as_dir in #(
 	 /*)
 	   for as_base in sh bash ksh sh5; do
-	     as_candidate_shells="$as_candidate_shells $as_dir/$as_base"
+	     # Try only shells that exist, to save several forks.
+	     as_shell=$as_dir/$as_base
+	     if { test -f "$as_shell" || test -f "$as_shell.exe"; } &&
+		    { $as_echo "$as_bourne_compatible""$as_required" | as_run=a "$as_shell"; } 2>/dev/null; then :
+  CONFIG_SHELL=$as_shell as_have_required=yes
+		   if { $as_echo "$as_bourne_compatible""$as_suggested" | as_run=a "$as_shell"; } 2>/dev/null; then :
+  break 2
+fi
+fi
 	   done;;
        esac
+  as_found=false
 done
+$as_found || { if { test -f "$SHELL" || test -f "$SHELL.exe"; } &&
+	      { $as_echo "$as_bourne_compatible""$as_required" | as_run=a "$SHELL"; } 2>/dev/null; then :
+  CONFIG_SHELL=$SHELL as_have_required=yes
+fi; }
 IFS=$as_save_IFS
 
 
-      for as_shell in $as_candidate_shells $SHELL; do
-	 # Try only shells that exist, to save several forks.
-	 if { test -f "$as_shell" || test -f "$as_shell.exe"; } &&
-		{ ("$as_shell") 2> /dev/null <<\_ASEOF
-if test -n "${ZSH_VERSION+set}" && (emulate sh) >/dev/null 2>&1; then
-  emulate sh
-  NULLCMD=:
-  # Pre-4.2 versions of Zsh do word splitting on ${1+"$@"}, which
-  # is contrary to our usage.  Disable this feature.
-  alias -g '${1+"$@"}'='"$@"'
-  setopt NO_GLOB_SUBST
-else
-  case `(set -o) 2>/dev/null` in
-  *posix*) set -o posix ;;
-esac
-
-fi
-
-
-:
-_ASEOF
-}; then
-  CONFIG_SHELL=$as_shell
-	       as_have_required=yes
-	       if { "$as_shell" 2> /dev/null <<\_ASEOF
-if test -n "${ZSH_VERSION+set}" && (emulate sh) >/dev/null 2>&1; then
-  emulate sh
-  NULLCMD=:
-  # Pre-4.2 versions of Zsh do word splitting on ${1+"$@"}, which
-  # is contrary to our usage.  Disable this feature.
-  alias -g '${1+"$@"}'='"$@"'
-  setopt NO_GLOB_SUBST
-else
-  case `(set -o) 2>/dev/null` in
-  *posix*) set -o posix ;;
-esac
-
-fi
-
-
-:
-(as_func_return () {
-  (exit $1)
-}
-as_func_success () {
-  as_func_return 0
-}
-as_func_failure () {
-  as_func_return 1
-}
-as_func_ret_success () {
-  return 0
-}
-as_func_ret_failure () {
-  return 1
-}
-
-exitcode=0
-if as_func_success; then
-  :
-else
-  exitcode=1
-  echo as_func_success failed.
-fi
-
-if as_func_failure; then
-  exitcode=1
-  echo as_func_failure succeeded.
-fi
-
-if as_func_ret_success; then
-  :
-else
-  exitcode=1
-  echo as_func_ret_success failed.
-fi
-
-if as_func_ret_failure; then
-  exitcode=1
-  echo as_func_ret_failure succeeded.
+      if test "x$CONFIG_SHELL" != x; then :
+  # We cannot yet assume a decent shell, so we have to provide a
+	# neutralization value for shells without unset; and this also
+	# works around shells that cannot unset nonexistent variables.
+	BASH_ENV=/dev/null
+	ENV=/dev/null
+	(unset BASH_ENV) >/dev/null 2>&1 && unset BASH_ENV ENV
+	export CONFIG_SHELL
+	exec "$CONFIG_SHELL" "$as_myself" ${1+"$@"}
 fi
 
-if ( set x; as_func_ret_success y && test x = "$1" ); then
-  :
-else
-  exitcode=1
-  echo positional parameters were not saved.
+    if test x$as_have_required = xno; then :
+  $as_echo "$0: This script requires a shell more modern than all"
+  $as_echo "$0: the shells that I found on your system."
+  if test x${ZSH_VERSION+set} = xset ; then
+    $as_echo "$0: In particular, zsh $ZSH_VERSION has bugs and should"
+    $as_echo "$0: be upgraded to zsh 4.3.4 or later."
+  else
+    $as_echo "$0: Please tell bug-autoconf@gnu.org about your system,
+$0: including any error possibly output before this
+$0: message. Then install a modern shell, or manually run
+$0: the script under such a shell if you do have one."
+  fi
+  exit 1
 fi
-
-test $exitcode = 0) || { (exit 1); exit 1; }
-
-(
-  as_lineno_1=$LINENO
-  as_lineno_2=$LINENO
-  test "x$as_lineno_1" != "x$as_lineno_2" &&
-  test "x`expr $as_lineno_1 + 1`" = "x$as_lineno_2") || { (exit 1); exit 1; }
-
-_ASEOF
-}; then
-  break
 fi
-
 fi
+SHELL=${CONFIG_SHELL-/bin/sh}
+export SHELL
+# Unset more variables known to interfere with behavior of common tools.
+CLICOLOR_FORCE= GREP_OPTIONS=
+unset CLICOLOR_FORCE GREP_OPTIONS
 
-      done
+## --------------------- ##
+## M4sh Shell Functions. ##
+## --------------------- ##
+# as_fn_unset VAR
+# ---------------
+# Portably unset VAR.
+as_fn_unset ()
+{
+  { eval $1=; unset $1;}
+}
+as_unset=as_fn_unset
 
-      if test "x$CONFIG_SHELL" != x; then
-  for as_var in BASH_ENV ENV
-	do ($as_unset $as_var) >/dev/null 2>&1 && $as_unset $as_var
-	done
-	export CONFIG_SHELL
-	exec "$CONFIG_SHELL" "$as_myself" ${1+"$@"}
-fi
+# as_fn_set_status STATUS
+# -----------------------
+# Set $? to STATUS, without forking.
+as_fn_set_status ()
+{
+  return $1
+} # as_fn_set_status
 
+# as_fn_exit STATUS
+# -----------------
+# Exit the shell with STATUS, even in a "trap 0" or "set -e" context.
+as_fn_exit ()
+{
+  set +e
+  as_fn_set_status $1
+  exit $1
+} # as_fn_exit
 
-    if test $as_have_required = no; then
-  echo This script requires a shell more modern than all the
-      echo shells that I found on your system.  Please install a
-      echo modern shell, or manually run the script under such a
-      echo shell if you do have one.
-      { (exit 1); exit 1; }
-fi
+# as_fn_mkdir_p
+# -------------
+# Create "$as_dir" as a directory, including parents if necessary.
+as_fn_mkdir_p ()
+{
 
+  case $as_dir in #(
+  -*) as_dir=./$as_dir;;
+  esac
+  test -d "$as_dir" || eval $as_mkdir_p || {
+    as_dirs=
+    while :; do
+      case $as_dir in #(
+      *\'*) as_qdir=`$as_echo "$as_dir" | sed "s/'/'\\\\\\\\''/g"`;; #'(
+      *) as_qdir=$as_dir;;
+      esac
+      as_dirs="'$as_qdir' $as_dirs"
+      as_dir=`$as_dirname -- "$as_dir" ||
+$as_expr X"$as_dir" : 'X\(.*[^/]\)//*[^/][^/]*/*$' \| \
+	 X"$as_dir" : 'X\(//\)[^/]' \| \
+	 X"$as_dir" : 'X\(//\)$' \| \
+	 X"$as_dir" : 'X\(/\)' \| . 2>/dev/null ||
+$as_echo X"$as_dir" |
+    sed '/^X\(.*[^/]\)\/\/*[^/][^/]*\/*$/{
+	    s//\1/
+	    q
+	  }
+	  /^X\(\/\/\)[^/].*/{
+	    s//\1/
+	    q
+	  }
+	  /^X\(\/\/\)$/{
+	    s//\1/
+	    q
+	  }
+	  /^X\(\/\).*/{
+	    s//\1/
+	    q
+	  }
+	  s/.*/./; q'`
+      test -d "$as_dir" && break
+    done
+    test -z "$as_dirs" || eval "mkdir $as_dirs"
+  } || test -d "$as_dir" || as_fn_error $? "cannot create directory $as_dir"
 
-fi
 
-fi
+} # as_fn_mkdir_p
+# as_fn_append VAR VALUE
+# ----------------------
+# Append the text in VALUE to the end of the definition contained in VAR. Take
+# advantage of any shell optimizations that allow amortized linear growth over
+# repeated appends, instead of the typical quadratic growth present in naive
+# implementations.
+if (eval "as_var=1; as_var+=2; test x\$as_var = x12") 2>/dev/null; then :
+  eval 'as_fn_append ()
+  {
+    eval $1+=\$2
+  }'
+else
+  as_fn_append ()
+  {
+    eval $1=\$$1\$2
+  }
+fi # as_fn_append
 
+# as_fn_arith ARG...
+# ------------------
+# Perform arithmetic evaluation on the ARGs, and store the result in the
+# global $as_val. Take advantage of shells that can avoid forks. The arguments
+# must be portable across $(()) and expr.
+if (eval "test \$(( 1 + 1 )) = 2") 2>/dev/null; then :
+  eval 'as_fn_arith ()
+  {
+    as_val=$(( $* ))
+  }'
+else
+  as_fn_arith ()
+  {
+    as_val=`expr "$@" || test $? -eq 1`
+  }
+fi # as_fn_arith
 
 
-(eval "as_func_return () {
-  (exit \$1)
-}
-as_func_success () {
-  as_func_return 0
-}
-as_func_failure () {
-  as_func_return 1
-}
-as_func_ret_success () {
-  return 0
-}
-as_func_ret_failure () {
-  return 1
-}
+# as_fn_error STATUS ERROR [LINENO LOG_FD]
+# ----------------------------------------
+# Output "`basename $0`: error: ERROR" to stderr. If LINENO and LOG_FD are
+# provided, also output the error to LOG_FD, referencing LINENO. Then exit the
+# script with STATUS, using 1 if that was 0.
+as_fn_error ()
+{
+  as_status=$1; test $as_status -eq 0 && as_status=1
+  if test "$4"; then
+    as_lineno=${as_lineno-"$3"} as_lineno_stack=as_lineno_stack=$as_lineno_stack
+    $as_echo "$as_me:${as_lineno-$LINENO}: error: $2" >&$4
+  fi
+  $as_echo "$as_me: error: $2" >&2
+  as_fn_exit $as_status
+} # as_fn_error
 
-exitcode=0
-if as_func_success; then
-  :
+if expr a : '\(a\)' >/dev/null 2>&1 &&
+   test "X`expr 00001 : '.*\(...\)'`" = X001; then
+  as_expr=expr
 else
-  exitcode=1
-  echo as_func_success failed.
-fi
-
-if as_func_failure; then
-  exitcode=1
-  echo as_func_failure succeeded.
+  as_expr=false
 fi
 
-if as_func_ret_success; then
-  :
+if (basename -- /) >/dev/null 2>&1 && test "X`basename -- / 2>&1`" = "X/"; then
+  as_basename=basename
 else
-  exitcode=1
-  echo as_func_ret_success failed.
+  as_basename=false
 fi
 
-if as_func_ret_failure; then
-  exitcode=1
-  echo as_func_ret_failure succeeded.
-fi
+as_me=`$as_basename -- "$0" ||
+$as_expr X/"$0" : '.*/\([^/][^/]*\)/*$' \| \
+	 X"$0" : 'X\(//\)$' \| \
+	 X"$0" : 'X\(/\)' \| . 2>/dev/null ||
+$as_echo X/"$0" |
+    sed '/^.*\/\([^/][^/]*\)\/*$/{
+	    s//\1/
+	    q
+	  }
+	  /^X\/\(\/\/\)$/{
+	    s//\1/
+	    q
+	  }
+	  /^X\/\(\/\).*/{
+	    s//\1/
+	    q
+	  }
+	  s/.*/./; q'`
 
-if ( set x; as_func_ret_success y && test x = \"\$1\" ); then
-  :
+if (as_dir=`dirname -- /` && test "X$as_dir" = X/) >/dev/null 2>&1; then
+  as_dirname=dirname
 else
-  exitcode=1
-  echo positional parameters were not saved.
+  as_dirname=false
 fi
 
-test \$exitcode = 0") || {
-  echo No shell found that supports shell functions.
-  echo Please tell bug-autoconf@gnu.org about your system,
-  echo including any error possibly output before this message.
-  echo This can help us improve future autoconf versions.
-  echo Configuration will now proceed without shell functions.
-}
-
+# Avoid depending upon Character Ranges.
+as_cr_letters='abcdefghijklmnopqrstuvwxyz'
+as_cr_LETTERS='ABCDEFGHIJKLMNOPQRSTUVWXYZ'
+as_cr_Letters=$as_cr_letters$as_cr_LETTERS
+as_cr_digits='0123456789'
+as_cr_alnum=$as_cr_Letters$as_cr_digits
 
 
-  as_lineno_1=$LINENO
-  as_lineno_2=$LINENO
-  test "x$as_lineno_1" != "x$as_lineno_2" &&
-  test "x`expr $as_lineno_1 + 1`" = "x$as_lineno_2" || {
-
-  # Create $as_me.lineno as a copy of $as_myself, but with $LINENO
-  # uniformly replaced by the line number.  The first 'sed' inserts a
-  # line-number line after each line using $LINENO; the second 'sed'
-  # does the real work.  The second script uses 'N' to pair each
-  # line-number line with the line containing $LINENO, and appends
-  # trailing '-' during substitution so that $LINENO is not a special
-  # case at line end.
-  # (Raja R Harinath suggested sed '=', and Paul Eggert wrote the
-  # scripts with optimization help from Paolo Bonzini.  Blame Lee
-  # E. McMahon (1931-1989) for sed's syntax.  :-)
+  as_lineno_1=$LINENO as_lineno_1a=$LINENO
+  as_lineno_2=$LINENO as_lineno_2a=$LINENO
+  eval 'test "x$as_lineno_1'$as_run'" != "x$as_lineno_2'$as_run'" &&
+  test "x`expr $as_lineno_1'$as_run' + 1`" = "x$as_lineno_2'$as_run'"' || {
+  # Blame Lee E. McMahon (1931-1989) for sed's syntax.  :-)
   sed -n '
     p
     /[$]LINENO/=
@@ -470,9 +434,7 @@ test \$exitcode = 0") || {
       s/-\n.*//
     ' >$as_me.lineno &&
   chmod +x "$as_me.lineno" ||
-    { { $as_echo "$as_me:$LINENO: error: cannot create $as_me.lineno; rerun with a POSIX shell" >&5
-$as_echo "$as_me: error: cannot create $as_me.lineno; rerun with a POSIX shell" >&2;}
-   { (exit 1); exit 1; }; }
+    { $as_echo "$as_me: error: cannot create $as_me.lineno; rerun with a POSIX shell" >&2; as_fn_exit 1; }
 
   # Don't try to exec as it changes $[0], causing all sort of problems
   # (the dirname of $[0] is not the place where we might find the
@@ -482,29 +444,18 @@ $as_echo "$as_me: error: cannot create $
   exit
 }
 
-
-if (as_dir=`dirname -- /` && test "X$as_dir" = X/) >/dev/null 2>&1; then
-  as_dirname=dirname
-else
-  as_dirname=false
-fi
-
 ECHO_C= ECHO_N= ECHO_T=
-case `echo -n x` in
+case `echo -n x` in #(((((
 -n*)
-  case `echo 'x\c'` in
+  case `echo 'xy\c'` in
   *c*) ECHO_T='	';;	# ECHO_T is single tab character.
-  *)   ECHO_C='\c';;
+  xy)  ECHO_C='\c';;
+  *)   echo `echo ksh88 bug on AIX 6.1` > /dev/null
+       ECHO_T='	';;
   esac;;
 *)
   ECHO_N='-n';;
 esac
-if expr a : '\(a\)' >/dev/null 2>&1 &&
-   test "X`expr 00001 : '.*\(...\)'`" = X001; then
-  as_expr=expr
-else
-  as_expr=false
-fi
 
 rm -f conf$$ conf$$.exe conf$$.file
 if test -d conf$$.dir; then
@@ -534,7 +485,7 @@ rm -f conf$$ conf$$.exe conf$$.dir/conf$
 rmdir conf$$.dir 2>/dev/null
 
 if mkdir -p . 2>/dev/null; then
-  as_mkdir_p=:
+  as_mkdir_p='mkdir -p "$as_dir"'
 else
   test -d ./-p && rmdir ./-p
   as_mkdir_p=false
@@ -553,10 +504,10 @@ else
       if test -d "$1"; then
 	test -d "$1/.";
       else
-	case $1 in
+	case $1 in #(
 	-*)set "./$1";;
 	esac;
-	case `ls -ld'$as_ls_L_option' "$1" 2>/dev/null` in
+	case `ls -ld'$as_ls_L_option' "$1" 2>/dev/null` in #((
 	???[sx]*):;;*)false;;esac;fi
     '\'' sh
   '
@@ -591,6 +542,11 @@ at_errexit_p=false
 # Shall we be verbose?  ':' means no, empty means yes.
 at_verbose=:
 at_quiet=
+# Running several jobs in parallel, 0 means as many as test groups.
+at_jobs=1
+at_traceon=:
+at_trace_echo=:
+at_check_filter_trace=:
 
 # Shall we keep the debug scripts?  Must be `:' when the suite is
 # run by a debug script, so that the script doesn't remove itself.
@@ -605,6 +561,8 @@ at_list_p=false
 at_clean=false
 # Test groups to run
 at_groups=
+# Whether to rerun failed tests.
+at_recheck=
 # Whether a write failure occurred
 at_write_fail=0
 
@@ -618,6 +576,8 @@ esac
 # Whether -C is in effect.
 at_change_dir=false
 
+# Whether to enable colored test results.
+at_color=no
 # List of the tested programs.
 at_tested='tar'
 # List of the all the test groups.
@@ -747,11 +707,11 @@ at_help_all="1;version.at:19;tar version
 118;pax-big-10g.at:21;pax-big-10g;star pax-big-10g;
 "
 
-# at_func_validate_ranges [NAME...]
-# ---------------------------------
-# Validate and normalize the test group number contained in each
-# variable NAME.  Leading zeroes are treated as decimal.
-at_func_validate_ranges ()
+# at_fn_validate_ranges file...
+# -----------------------------
+# Validate and normalize the test group number contained in each variable
+# NAME. Leading zeroes are treated as decimal.
+at_fn_validate_ranges ()
 {
   for at_grp
   do
@@ -762,7 +722,7 @@ at_func_validate_ranges ()
     fi
     case $at_value in
       0*) # We want to treat leading 0 as decimal, like expr and test, but
-	  # at_func_arith treats it as octal if it uses $(( )).
+	  # AS_VAR_ARITH treats it as octal if it uses $(( )).
 	  # With XSI shells, ${at_value#${at_value%%[1-9]*}} avoids the
 	  # expr fork, but it is not worth the effort to determine if the
 	  # shell supports XSI when the user can just avoid leading 0.
@@ -781,8 +741,8 @@ do
   fi
 
   case $at_option in
-  *=*) at_optarg=`expr "x$at_option" : 'x[^=]*=\(.*\)'` ;;
-  *)   at_optarg= ;;
+  *=?*) at_optarg=`expr "X$at_option" : '[^=]*=\(.*\)'` ;;
+  *)    at_optarg= ;;
   esac
 
   # Accept the important Cygnus configure options, so we can diagnose typos.
@@ -804,6 +764,19 @@ do
 	at_clean=:
 	;;
 
+    --color )
+	at_color=always
+	;;
+    --color=* )
+	case $at_optarg in
+	no | never | none) at_color=never ;;
+	auto | tty | if-tty) at_color=auto ;;
+	always | yes | force) at_color=always ;;
+	*) at_optname=`echo " $at_option" | sed 's/^ //; s/=.*//'`
+	   as_fn_error $? "unrecognized argument to $at_optname: $at_optarg" ;;
+	esac
+	;;
+
     --debug | -d )
 	at_debug_p=:
 	;;
@@ -818,29 +791,31 @@ do
 	;;
 
     --trace | -x )
-	at_traceon='set -x'; at_traceoff='set +x'
+	at_traceon='set -x'
+	at_trace_echo=echo
+	at_check_filter_trace=at_fn_filter_trace
 	;;
 
     [0-9] | [0-9][0-9] | [0-9][0-9][0-9] | [0-9][0-9][0-9][0-9])
-	at_func_validate_ranges at_option
-	at_groups="$at_groups$at_option "
+	at_fn_validate_ranges at_option
+	as_fn_append at_groups "$at_option "
 	;;
 
     # Ranges
     [0-9]- | [0-9][0-9]- | [0-9][0-9][0-9]- | [0-9][0-9][0-9][0-9]-)
 	at_range_start=`echo $at_option |tr -d X-`
-	at_func_validate_ranges at_range_start
+	at_fn_validate_ranges at_range_start
 	at_range=`$as_echo " $at_groups_all " | \
 	  sed -e 's/^.* \('$at_range_start' \)/\1/'`
-	at_groups="$at_groups$at_range "
+	as_fn_append at_groups "$at_range "
 	;;
 
     -[0-9] | -[0-9][0-9] | -[0-9][0-9][0-9] | -[0-9][0-9][0-9][0-9])
 	at_range_end=`echo $at_option |tr -d X-`
-	at_func_validate_ranges at_range_end
+	at_fn_validate_ranges at_range_end
 	at_range=`$as_echo " $at_groups_all " | \
 	  sed -e 's/\( '$at_range_end'\) .*$/\1/'`
-	at_groups="$at_groups$at_range "
+	as_fn_append at_groups "$at_range "
 	;;
 
     [0-9]-[0-9] | [0-9]-[0-9][0-9] | [0-9]-[0-9][0-9][0-9] | \
@@ -856,11 +831,11 @@ do
 	  at_range_end=$at_range_start
 	  at_range_start=$at_tmp
 	fi
-	at_func_validate_ranges at_range_start at_range_end
+	at_fn_validate_ranges at_range_start at_range_end
 	at_range=`$as_echo " $at_groups_all " | \
 	  sed -e 's/^.*\( '$at_range_start' \)/\1/' \
 	      -e 's/\( '$at_range_end'\) .*$/\1/'`
-	at_groups="$at_groups$at_range "
+	as_fn_append at_groups "$at_range "
 	;;
 
     # Directory selection.
@@ -870,6 +845,25 @@ do
     --directory=* )
 	at_change_dir=:
 	at_dir=$at_optarg
+	if test x- = "x$at_dir" ; then
+	  at_dir=./-
+	fi
+	;;
+
+    # Parallel execution.
+    --jobs | -j )
+	at_jobs=0
+	;;
+    --jobs=* | -j[0-9]* )
+	if test -n "$at_optarg"; then
+	  at_jobs=$at_optarg
+	else
+	  at_jobs=`expr X$at_option : 'X-j\(.*\)'`
+	fi
+	case $at_jobs in *[!0-9]*)
+	  at_optname=`echo " $at_option" | sed 's/^ //; s/[0-9=].*//'`
+	  as_fn_error $? "non-numeric argument to $at_optname: $at_jobs" ;;
+	esac
 	;;
 
     # Keywords.
@@ -900,7 +894,10 @@ do
 	at_groups_selected=`$as_echo "$at_groups_selected" | sed 's/;.*//' |
 	  tr "$as_nl" ' '
 	`
-	at_groups="$at_groups$at_groups_selected "
+	as_fn_append at_groups "$at_groups_selected "
+	;;
+    --recheck)
+	at_recheck=:
 	;;
 
     *=*)
@@ -908,14 +905,12 @@ do
 	# Reject names that are not valid shell variable names.
 	case $at_envvar in
 	  '' | [0-9]* | *[!_$as_cr_alnum]* )
-	    { { $as_echo "$as_me:$LINENO: error: invalid variable name: $at_envvar" >&5
-$as_echo "$as_me: error: invalid variable name: $at_envvar" >&2;}
-   { (exit 1); exit 1; }; } ;;
+	    as_fn_error $? "invalid variable name: \`$at_envvar'" ;;
 	esac
 	at_value=`$as_echo "$at_optarg" | sed "s/'/'\\\\\\\\''/g"`
 	# Export now, but save eval for later and for debug scripts.
 	export $at_envvar
-	at_debug_args="$at_debug_args $at_envvar='$at_value'"
+	as_fn_append at_debug_args " $at_envvar='$at_value'"
 	;;
 
      *) $as_echo "$as_me: invalid option: $at_option" >&2
@@ -926,21 +921,44 @@ $as_echo "$as_me: error: invalid variabl
 done
 
 # Verify our last option didn't require an argument
-if test -n "$at_prev"; then
-  { { $as_echo "$as_me:$LINENO: error: \`$at_prev' requires an argument." >&5
-$as_echo "$as_me: error: \`$at_prev' requires an argument." >&2;}
-   { (exit 1); exit 1; }; }
+if test -n "$at_prev"; then :
+  as_fn_error $? "\`$at_prev' requires an argument"
 fi
 
+# The file containing the suite.
+at_suite_log=$at_dir/$as_me.log
 
 # Selected test groups.
-if test -z "$at_groups"; then
+if test -z "$at_groups$at_recheck"; then
   at_groups=$at_groups_all
 else
+  if test -n "$at_recheck" && test -r "$at_suite_log"; then
+    at_oldfails=`sed -n '
+      /^Failed tests:$/,/^Skipped tests:$/{
+	s/^[ ]*\([1-9][0-9]*\):.*/\1/p
+      }
+      /^Unexpected passes:$/,/^## Detailed failed tests/{
+	s/^[ ]*\([1-9][0-9]*\):.*/\1/p
+      }
+      /^## Detailed failed tests/q
+      ' "$at_suite_log" | tr "$as_nl" ' '`
+    as_fn_append at_groups "$at_oldfails"
+  fi
   # Sort the tests, removing duplicates.
   at_groups=`$as_echo "$at_groups" | tr ' ' "$as_nl" | sort -nu`
 fi
 
+if test x"$at_color" = xalways \
+   || { test x"$at_color" = xauto && test -t 1; }; then
+  at_red=`printf '\033[0;31m'`
+  at_grn=`printf '\033[0;32m'`
+  at_lgn=`printf '\033[1;32m'`
+  at_blu=`printf '\033[1;34m'`
+  at_std=`printf '\033[m'`
+else
+  at_red= at_grn= at_lgn= at_blu= at_std=
+fi
+
 # Help message.
 if $at_help_p; then
   cat <<_ATEOF || at_write_fail=1
@@ -949,16 +967,17 @@ Usage: $0 [OPTION]... [VARIABLE=VALUE]..
 Run all the tests, or the selected TESTS, given by numeric ranges, and
 save a detailed log file.  Upon failure, create debugging scripts.
 
-You should not change environment variables unless explicitly passed
-as command line arguments.  Set \`AUTOTEST_PATH' to select the executables
+Do not change environment variables directly.  Instead, set them via
+command line arguments.  Set \`AUTOTEST_PATH' to select the executables
 to exercise.  Each relative directory is expanded as build and source
-directories relatively to the top level of this distribution.  E.g.,
+directories relative to the top level of this distribution.
+E.g., from within the build directory /tmp/foo-1.0, invoking this:
 
   $ $0 AUTOTEST_PATH=bin
 
-possibly amounts into
+is equivalent to the following, assuming the source directory is /src/foo-1.0:
 
-  PATH=/tmp/foo-1.0/bin:/src/foo-1.0/bin:\$PATH
+  PATH=/tmp/foo-1.0/bin:/src/foo-1.0/bin:\$PATH $0
 _ATEOF
 cat <<_ATEOF || at_write_fail=1
 
@@ -971,11 +990,16 @@ _ATEOF
 cat <<_ATEOF || at_write_fail=1
 
 Execution tuning:
-  -C, --directory=DIR
+  -C, --directory=this_is_a_very_long_name_for_a_directory_which_causes_problems
                  change to directory DIR before starting
+      --color[=never|auto|always]
+                 enable colored test results on terminal, or always
+  -j, --jobs[=N]
+                 Allow N jobs at once; infinite jobs with no arg (default 1)
   -k, --keywords=KEYWORDS
                  select the tests matching all the comma-separated KEYWORDS
                  multiple \`-k' accumulate; prefixed \`!' negates a KEYWORD
+      --recheck  select all tests that failed or passed unexpectedly last time
   -e, --errexit  abort as soon as a test fails; implies --debug
   -v, --verbose  force more detailed output
                  default for debugging scripts
@@ -986,6 +1010,7 @@ _ATEOF
 cat <<_ATEOF || at_write_fail=1
 
 Report bugs to <bug-tar@gnu.org>.
+General help using GNU software: <http://www.gnu.org/gethelp/>.
 _ATEOF
   exit $at_write_fail
 fi
@@ -1010,26 +1035,45 @@ _ATEOF
   $as_echo "$at_groups$as_nl$at_help_all" |
     awk 'BEGIN { FS = ";" }
 	 NR == 1 {
-	   for (n = split($ 0, a, " "); n; n--) selected[a[n]] = 1
+	   for (n = split ($ 0, a, " "); n; n--)
+	     selected[a[n]] = 1
 	   next
 	 }
-	 {
+	 NF > 0 {
 	   if (selected[$ 1]) {
 	     printf " %3d: %-18s %s\n", $ 1, $ 2, $ 3
-	     if ($ 4) printf "      %s\n", $ 4
+	     if ($ 4) {
+	       lmax = 79
+	       indent = "     "
+	       line = indent
+	       len = length (line)
+	       n = split ($ 4, a, " ")
+	       for (i = 1; i <= n; i++) {
+		 l = length (a[i]) + 1
+		 if (i > 1 && len + l > lmax) {
+		   print line
+		   line = indent " " a[i]
+		   len = length (line)
+		 } else {
+		   line = line " " a[i]
+		   len += l
+		 }
+	       }
+	       if (n)
+		 print line
+	     }
 	   }
 	 }' || at_write_fail=1
   exit $at_write_fail
 fi
 if $at_version_p; then
   $as_echo "$as_me (GNU tar 1.25)" &&
-  cat <<\_ACEOF || at_write_fail=1
+  cat <<\_ATEOF || at_write_fail=1
 
-Copyright (C) 2000, 2001, 2002, 2003, 2004, 2005, 2006, 2007, 2008
-Free Software Foundation, Inc.
+Copyright (C) 2010 Free Software Foundation, Inc.
 This test suite is free software; the Free Software Foundation gives
 unlimited permission to copy, distribute and modify it.
-_ACEOF
+_ATEOF
   exit $at_write_fail
 fi
 
@@ -1044,13 +1088,8 @@ esac
 
 # Take any -C into account.
 if $at_change_dir ; then
-  if test x- = "x$at_dir" ; then
-    at_dir=./-
-  fi
   test x != "x$at_dir" && cd "$at_dir" \
-    || { { $as_echo "$as_me:$LINENO: error: unable to change directory" >&5
-$as_echo "$as_me: error: unable to change directory" >&2;}
-   { (exit 1); exit 1; }; }
+    || as_fn_error $? "unable to change directory"
   at_dir=`pwd`
 fi
 
@@ -1058,9 +1097,7 @@ fi
 for at_file in atconfig atlocal
 do
   test -r $at_file || continue
-  . ./$at_file || { { $as_echo "$as_me:$LINENO: error: invalid content: $at_file" >&5
-$as_echo "$as_me: error: invalid content: $at_file" >&2;}
-   { (exit 1); exit 1; }; }
+  . ./$at_file || as_fn_error $? "invalid content: $at_file"
 done
 
 # Autoconf <=2.59b set at_top_builddir instead of at_top_build_prefix:
@@ -1075,8 +1112,7 @@ if test -n "$at_top_srcdir"; then
   builddir=../..
   for at_dir_var in srcdir top_srcdir top_build_prefix
   do
-    at_val=`eval 'as_val=${'at_$at_dir_var'}
-		 $as_echo "$as_val"'`
+    eval at_val=\$at_$at_dir_var
     case $at_val in
       [\\/$]* | ?:[\\/]* ) at_prefix= ;;
       *) at_prefix=../../ ;;
@@ -1085,9 +1121,9 @@ if test -n "$at_top_srcdir"; then
   done
 fi
 
-## ------------------- ##
-## Directory structure ##
-## ------------------- ##
+## -------------------- ##
+## Directory structure. ##
+## -------------------- ##
 
 # This is the set of directories and files used by this script
 # (non-literals are capitalized):
@@ -1118,12 +1154,14 @@ fi
 # The directory the whole suite works in.
 # Should be absolute to let the user `cd' at will.
 at_suite_dir=$at_dir/$as_me.dir
-# The file containing the suite.
+# The file containing the suite ($at_dir might have changed since earlier).
 at_suite_log=$at_dir/$as_me.log
 # The directory containing helper files per test group.
 at_helper_dir=$at_suite_dir/at-groups
 # Stop file: if it exists, do not start new jobs.
 at_stop_file=$at_suite_dir/at-stop
+# The fifo used for the job dispatcher.
+at_job_fifo=$at_suite_dir/at-job-fifo
 
 if $at_clean; then
   test -d "$at_suite_dir" &&
@@ -1147,23 +1185,23 @@ for as_dir in $AUTOTEST_PATH $PATH
 do
   IFS=$as_save_IFS
   test -z "$as_dir" && as_dir=.
-  test -n "$at_path" && at_path=$at_path$PATH_SEPARATOR
+    test -n "$at_path" && as_fn_append at_path $PATH_SEPARATOR
 case $as_dir in
   [\\/]* | ?:[\\/]* )
-    at_path=$at_path$as_dir
+    as_fn_append at_path "$as_dir"
     ;;
   * )
     if test -z "$at_top_build_prefix"; then
       # Stand-alone test suite.
-      at_path=$at_path$as_dir
+      as_fn_append at_path "$as_dir"
     else
       # Embedded test suite.
-      at_path=$at_path$at_top_build_prefix$as_dir$PATH_SEPARATOR
-      at_path=$at_path$at_top_srcdir/$as_dir
+      as_fn_append at_path "$at_top_build_prefix$as_dir$PATH_SEPARATOR"
+      as_fn_append at_path "$at_top_srcdir/$as_dir"
     fi
     ;;
 esac
-done
+  done
 IFS=$as_save_IFS
 
 
@@ -1177,7 +1215,7 @@ for as_dir in $at_path
 do
   IFS=$as_save_IFS
   test -z "$as_dir" && as_dir=.
-  test -d "$as_dir" || continue
+    test -d "$as_dir" || continue
 case $as_dir in
   [\\/]* | ?:[\\/]* ) ;;
   * ) as_dir=`(cd "$as_dir" && pwd) 2>/dev/null` ;;
@@ -1185,15 +1223,18 @@ esac
 case $PATH_SEPARATOR$at_new_path$PATH_SEPARATOR in
   *$PATH_SEPARATOR$as_dir$PATH_SEPARATOR*) ;;
   $PATH_SEPARATOR$PATH_SEPARATOR) at_new_path=$as_dir ;;
-  *) at_new_path=$at_new_path$PATH_SEPARATOR$as_dir ;;
+  *) as_fn_append at_new_path "$PATH_SEPARATOR$as_dir" ;;
 esac
-done
+  done
 IFS=$as_save_IFS
 
 PATH=$at_new_path
 export PATH
 
 # Setting up the FDs.
+
+
+
 # 5 is the log file.  Not to be overwritten if `-d'.
 if $at_debug_p; then
   at_suite_log=/dev/null
@@ -1203,43 +1244,28 @@ fi
 exec 5>>"$at_suite_log"
 
 # Banners and logs.
-cat <<\_ASBOX
-## ------------------------ ##
+$as_echo "## ------------------------ ##
 ## GNU tar 1.25 test suite. ##
-## ------------------------ ##
-_ASBOX
+## ------------------------ ##"
 {
-  cat <<\_ASBOX
-## ------------------------ ##
+  $as_echo "## ------------------------ ##
 ## GNU tar 1.25 test suite. ##
-## ------------------------ ##
-_ASBOX
+## ------------------------ ##"
   echo
 
   $as_echo "$as_me: command line was:"
   $as_echo "  \$ $0 $at_cli_args"
   echo
 
-  # Try to find a few ChangeLogs in case it might help determining the
-  # exact version.  Use the relative dir: if the top dir is a symlink,
-  # find will not follow it (and options to follow the links are not
-  # portable), which would result in no output here.  Prune directories
-  # matching the package tarname, since they tend to be leftovers from
-  # `make dist' or `make distcheck' and contain redundant or stale logs.
-  if test -n "$at_top_srcdir"; then
-    cat <<\_ASBOX
-## ----------- ##
-## ChangeLogs. ##
-## ----------- ##
-_ASBOX
+  # If ChangeLog exists, list a few lines in case it might help determining
+  # the exact version.
+  if test -n "$at_top_srcdir" && test -f "$at_top_srcdir/ChangeLog"; then
+    $as_echo "## ---------- ##
+## ChangeLog. ##
+## ---------- ##"
+    echo
+    sed 's/^/| /;10q' "$at_top_srcdir/ChangeLog"
     echo
-    for at_file in `find "$at_top_srcdir" -name "tar-*" -prune -o -name ChangeLog -print`
-    do
-      $as_echo "$as_me: $at_file:"
-      sed 's/^/| /;10q' $at_file
-      echo
-    done
-
   fi
 
   {
@@ -1272,8 +1298,8 @@ for as_dir in $PATH
 do
   IFS=$as_save_IFS
   test -z "$as_dir" && as_dir=.
-  $as_echo "PATH: $as_dir"
-done
+    $as_echo "PATH: $as_dir"
+  done
 IFS=$as_save_IFS
 
 }
@@ -1290,53 +1316,76 @@ IFS=$as_save_IFS
 } >&5
 
 
-## --------------- ##
-## Shell functions ##
-## --------------- ##
-
-# at_func_banner NUMBER
-# ---------------------
-# Output banner NUMBER, provided the testsuite is running multiple groups
-# and this particular banner has not yet been printed.
-at_func_banner ()
+## ------------------------- ##
+## Autotest shell functions. ##
+## ------------------------- ##
+
+# at_fn_banner NUMBER
+# -------------------
+# Output banner NUMBER, provided the testsuite is running multiple groups and
+# this particular banner has not yet been printed.
+at_fn_banner ()
 {
   $at_print_banners || return 0
   eval at_banner_text=\$at_banner_text_$1
   test "x$at_banner_text" = x && return 0
   eval at_banner_text_$1=
   $as_echo "$as_nl$at_banner_text$as_nl"
-} # at_func_banner
+} # at_fn_banner
 
-# at_func_check_newline COMMAND
-# -----------------------------
-# Test if COMMAND includes a newline and, if so, print a message and return
-# exit code 1
-at_func_check_newline ()
+# at_fn_check_prepare_notrace REASON LINE
+# ---------------------------------------
+# Perform AT_CHECK preparations for the command at LINE for an untraceable
+# command; REASON is the reason for disabling tracing.
+at_fn_check_prepare_notrace ()
 {
-  case "$1" in
- *'
-'*) echo 'Not enabling shell tracing (command contains an embedded newline)'
-    return 1 ;;
- *) return 0 ;;
-  esac
+  $at_trace_echo "Not enabling shell tracing (command contains $1)"
+  $as_echo "$2" >"$at_check_line_file"
+  at_check_trace=: at_check_filter=:
+  : >"$at_stdout"; : >"$at_stderr"
 }
 
-# at_func_filter_trace EXIT-CODE
+# at_fn_check_prepare_trace LINE
 # ------------------------------
-# Split the contents of file "$at_stder1" into the "set -x" trace (on stderr)
-# and the other lines (on file "$at_stderr").  Return the exit code EXIT-CODE.
-at_func_filter_trace ()
+# Perform AT_CHECK preparations for the command at LINE for a traceable
+# command.
+at_fn_check_prepare_trace ()
 {
+  $as_echo "$1" >"$at_check_line_file"
+  at_check_trace=$at_traceon at_check_filter=$at_check_filter_trace
+  : >"$at_stdout"; : >"$at_stderr"
+}
+
+# at_fn_check_prepare_dynamic COMMAND LINE
+# ----------------------------------------
+# Decide if COMMAND at LINE is traceable at runtime, and call the appropriate
+# preparation function.
+at_fn_check_prepare_dynamic ()
+{
+  case $1 in
+    *$as_nl*)
+      at_fn_check_prepare_notrace 'an embedded newline' "$2" ;;
+    *)
+      at_fn_check_prepare_trace "$2" ;;
+  esac
+}
+
+# at_fn_filter_trace
+# ------------------
+# Remove the lines in the file "$at_stderr" generated by "set -x" and print
+# them to stderr.
+at_fn_filter_trace ()
+{
+  mv "$at_stderr" "$at_stder1"
   grep '^ *+' "$at_stder1" >&2
   grep -v '^ *+' "$at_stder1" >"$at_stderr"
-  return $1
 }
 
-# at_func_log_failure FILE-LIST
-# -----------------------------
+# at_fn_log_failure FILE-LIST
+# ---------------------------
 # Copy the files in the list on stdout with a "> " prefix, and exit the shell
 # with a failure exit code.
-at_func_log_failure ()
+at_fn_log_failure ()
 {
   for file
     do $as_echo "$file:"; sed 's/^/> /' "$file"; done
@@ -1344,56 +1393,62 @@ at_func_log_failure ()
   exit 1
 }
 
-# at_func_check_skip EXIT-CODE
-# ----------------------------
-# Check whether EXIT-CODE is the special exit code 77, and if so exit the shell
-# with that same exit code.
-at_func_check_skip ()
+# at_fn_check_skip EXIT-CODE LINE
+# -------------------------------
+# Check whether EXIT-CODE is a special exit code (77 or 99), and if so exit
+# the test group subshell with that same exit code. Use LINE in any report
+# about test failure.
+at_fn_check_skip ()
 {
   case $1 in
+    99) echo 99 > "$at_status_file"; at_failed=:
+	$as_echo "$2: hard failure"; exit 99;;
     77) echo 77 > "$at_status_file"; exit 77;;
   esac
 }
 
-# at_func_check_status EXPECTED EXIT-CODE LINE
-# --------------------------------------------
-# Check whether EXIT-CODE is the expected exit code, and if so do nothing.
-# Otherwise, if it is 77 exit the shell with that same exit code; if it is
-# anything else print an error message and fail the test.
-at_func_check_status ()
+# at_fn_check_status EXPECTED EXIT-CODE LINE
+# ------------------------------------------
+# Check whether EXIT-CODE is the EXPECTED exit code, and if so do nothing.
+# Otherwise, if it is 77 or 99, exit the test group subshell with that same
+# exit code; if it is anything else print an error message referring to LINE,
+# and fail the test.
+at_fn_check_status ()
 {
   case $2 in
     $1 ) ;;
     77) echo 77 > "$at_status_file"; exit 77;;
+    99) echo 99 > "$at_status_file"; at_failed=:
+	$as_echo "$3: hard failure"; exit 99;;
     *) $as_echo "$3: exit code was $2, expected $1"
       at_failed=:;;
   esac
 }
 
-# at_func_diff_devnull FILE
-# -------------------------
-# Emit a diff between /dev/null and FILE.  Uses "test -s" to avoid useless
-# diff invocations.
-at_func_diff_devnull ()
+# at_fn_diff_devnull FILE
+# -----------------------
+# Emit a diff between /dev/null and FILE. Uses "test -s" to avoid useless diff
+# invocations.
+at_fn_diff_devnull ()
 {
   test -s "$1" || return 0
   $at_diff "$at_devnull" "$1"
 }
 
-# at_func_test NUMBER
-# -------------------
+# at_fn_test NUMBER
+# -----------------
 # Parse out test NUMBER from the tail of this file.
-at_func_test ()
+at_fn_test ()
 {
   eval at_sed=\$at_sed$1
   sed "$at_sed" "$at_myself" > "$at_test_source"
 }
 
-# at_func_create_debugging_script
-# -------------------------------
+# at_fn_create_debugging_script
+# -----------------------------
 # Create the debugging script $at_group_dir/run which will reproduce the
 # current test group.
-at_func_create_debugging_script ()
+at_fn_create_debugging_script ()
 {
   {
     echo "#! /bin/sh" &&
@@ -1405,34 +1460,13 @@ at_func_create_debugging_script ()
   chmod +x "$at_group_dir/run"
 }
 
-# at_func_arith
-# -------------
-# Arithmetic evaluation, avoids expr if the shell is sane.  The
-# interpretation of leading zeroes is unspecified.
-#
-# subshell and eval are needed to keep Solaris sh from bailing out:
-if ( eval 'test $(( 1 + 1 )) = 2' ) 2>/dev/null; then
-  # With "$@", bash does not split positional parameters:
-  eval 'at_func_arith ()
-  {
-    at_func_arith_result=$(( $* ))
-  }'
-else
-  at_func_arith ()
-  {
-    at_func_arith_result=`expr "$@"`
-  }
-fi
-
-## ---------------------- ##
-## End of shell functions ##
-## ---------------------- ##
+## -------------------------------- ##
+## End of autotest shell functions. ##
+## -------------------------------- ##
 {
-  cat <<\_ASBOX
-## ---------------- ##
+  $as_echo "## ---------------- ##
 ## Tested programs. ##
-## ---------------- ##
-_ASBOX
+## ---------------- ##"
   echo
 } >&5
 
@@ -1440,34 +1474,35 @@ _ASBOX
 for at_program in : $at_tested
 do
   test "$at_program" = : && continue
-  as_save_IFS=$IFS; IFS=$PATH_SEPARATOR
+  case $at_program in
+    [\\/]* | ?:[\\/]* ) $at_program_=$at_program ;;
+    * )
+    as_save_IFS=$IFS; IFS=$PATH_SEPARATOR
 for as_dir in $PATH
 do
   IFS=$as_save_IFS
   test -z "$as_dir" && as_dir=.
-  test -f "$as_dir/$at_program" && break
-done
+    test -f "$as_dir/$at_program" && break
+  done
 IFS=$as_save_IFS
 
-  if test -f "$as_dir/$at_program"; then
+    at_program_=$as_dir/$at_program ;;
+  esac
+  if test -f "$at_program_"; then
     {
-      $as_echo "$at_srcdir/testsuite.at:104: $as_dir/$at_program --version"
-      "$as_dir/$at_program" --version </dev/null
+      $as_echo "$at_srcdir/testsuite.at:104: $at_program_ --version"
+      "$at_program_" --version </dev/null
       echo
     } >&5 2>&1
   else
-    { { $as_echo "$as_me:$LINENO: error: cannot find $at_program" >&5
-$as_echo "$as_me: error: cannot find $at_program" >&2;}
-   { (exit 1); exit 1; }; }
+    as_fn_error $? "cannot find $at_program" "$LINENO" 5
   fi
 done
 
 {
-  cat <<\_ASBOX
-## ------------------ ##
+  $as_echo "## ------------------ ##
 ## Running the tests. ##
-## ------------------ ##
-_ASBOX
+## ------------------ ##"
 } >&5
 
 at_start_date=`date`
@@ -1475,11 +1510,8 @@ at_start_time=`date +%s 2>/dev/null`
 $as_echo "$as_me: starting at: $at_start_date" >&5
 
 # Create the master directory if it doesn't already exist.
-test -d "$at_suite_dir" ||
-  mkdir "$at_suite_dir" ||
-  { { $as_echo "$as_me:$LINENO: error: cannot create '$at_suite_dir'" >&5
-$as_echo "$as_me: error: cannot create '$at_suite_dir'" >&2;}
-   { (exit 1); exit 1; }; }
+as_dir="$at_suite_dir"; as_fn_mkdir_p ||
+  as_fn_error $? "cannot create \`$at_suite_dir'" "$LINENO" 5
 
 # Can we diff with `/dev/null'?  DU 5.0 refuses.
 if diff /dev/null /dev/null >/dev/null 2>&1; then
@@ -1513,28 +1545,40 @@ BEGIN { FS="" }
   if (test == "'"$at_group"'") exit
 }' "$at_myself" > "$at_suite_dir/at-source-lines" &&
 . "$at_suite_dir/at-source-lines" ||
-  { { $as_echo "$as_me:$LINENO: error: cannot create test line number cache" >&5
-$as_echo "$as_me: error: cannot create test line number cache" >&2;}
-   { (exit 1); exit 1; }; }
+  as_fn_error $? "cannot create test line number cache" "$LINENO" 5
 rm -f "$at_suite_dir/at-source-lines"
 
+# Set number of jobs for `-j'; avoid more jobs than test groups.
+set X $at_groups; shift; at_max_jobs=$#
+if test $at_max_jobs -eq 0; then
+  at_jobs=1
+fi
+if test $at_jobs -ne 1 &&
+   { test $at_jobs -eq 0 || test $at_jobs -gt $at_max_jobs; }; then
+  at_jobs=$at_max_jobs
+fi
+
+# If parallel mode, don't output banners, don't split summary lines.
+if test $at_jobs -ne 1; then
+  at_print_banners=false
+  at_quiet=:
+fi
+
 # Set up helper dirs.
 rm -rf "$at_helper_dir" &&
 mkdir "$at_helper_dir" &&
 cd "$at_helper_dir" &&
 { test -z "$at_groups" || mkdir $at_groups; } ||
-{ { $as_echo "$as_me:$LINENO: error: testsuite directory setup failed" >&5
-$as_echo "$as_me: error: testsuite directory setup failed" >&2;}
-   { (exit 1); exit 1; }; }
+as_fn_error $? "testsuite directory setup failed" "$LINENO" 5
 
 # Functions for running a test group.  We leave the actual
 # test group execution outside of a shell function in order
 # to avoid hitting zsh 4.x exit status bugs.
 
-# at_func_group_prepare
-# ---------------------
-# Prepare running a test group
-at_func_group_prepare ()
+# at_fn_group_prepare
+# -------------------
+# Prepare for running a test group.
+at_fn_group_prepare ()
 {
   # The directory for additional per-group helper files.
   at_job_dir=$at_helper_dir/$at_group
@@ -1568,56 +1612,20 @@ at_func_group_prepare ()
 
 
   # Create a fresh directory for the next test group, and enter.
+  # If one already exists, the user may have invoked ./run from
+  # within that directory; we remove the contents, but not the
+  # directory itself, so that we aren't pulling the rug out from
+  # under the shell's notion of the current directory.
   at_group_dir=$at_suite_dir/$at_group_normalized
   at_group_log=$at_group_dir/$as_me.log
   if test -d "$at_group_dir"; then
-    find "$at_group_dir" -type d ! -perm -700 -exec chmod u+rwx \{\} \;
-    rm -fr "$at_group_dir" ||
-    { $as_echo "$as_me:$LINENO: WARNING: test directory for $at_group_normalized could not be cleaned." >&5
-$as_echo "$as_me: WARNING: test directory for $at_group_normalized could not be cleaned." >&2;}
-  fi
+  find "$at_group_dir" -type d ! -perm -700 -exec chmod u+rwx {} \;
+  rm -fr "$at_group_dir"/* "$at_group_dir"/.[!.] "$at_group_dir"/.??*
+fi ||
+    { $as_echo "$as_me:${as_lineno-$LINENO}: WARNING: test directory for $at_group_normalized could not be cleaned" >&5
+$as_echo "$as_me: WARNING: test directory for $at_group_normalized could not be cleaned" >&2;}
   # Be tolerant if the above `rm' was not able to remove the directory.
-  { as_dir="$at_group_dir"
-  case $as_dir in #(
-  -*) as_dir=./$as_dir;;
-  esac
-  test -d "$as_dir" || { $as_mkdir_p && mkdir -p "$as_dir"; } || {
-    as_dirs=
-    while :; do
-      case $as_dir in #(
-      *\'*) as_qdir=`$as_echo "$as_dir" | sed "s/'/'\\\\\\\\''/g"`;; #'(
-      *) as_qdir=$as_dir;;
-      esac
-      as_dirs="'$as_qdir' $as_dirs"
-      as_dir=`$as_dirname -- "$as_dir" ||
-$as_expr X"$as_dir" : 'X\(.*[^/]\)//*[^/][^/]*/*$' \| \
-	 X"$as_dir" : 'X\(//\)[^/]' \| \
-	 X"$as_dir" : 'X\(//\)$' \| \
-	 X"$as_dir" : 'X\(/\)' \| . 2>/dev/null ||
-$as_echo X"$as_dir" |
-    sed '/^X\(.*[^/]\)\/\/*[^/][^/]*\/*$/{
-	    s//\1/
-	    q
-	  }
-	  /^X\(\/\/\)[^/].*/{
-	    s//\1/
-	    q
-	  }
-	  /^X\(\/\/\)$/{
-	    s//\1/
-	    q
-	  }
-	  /^X\(\/\).*/{
-	    s//\1/
-	    q
-	  }
-	  s/.*/./; q'`
-      test -d "$as_dir" && break
-    done
-    test -z "$as_dirs" || eval "mkdir $as_dirs"
-  } || test -d "$as_dir" || { { $as_echo "$as_me:$LINENO: error: cannot create directory $as_dir" >&5
-$as_echo "$as_me: error: cannot create directory $as_dir" >&2;}
-   { (exit 1); exit 1; }; }; }
+  as_dir="$at_group_dir"; as_fn_mkdir_p
 
   echo 0 > "$at_status_file"
 
@@ -1630,9 +1638,29 @@ $as_echo "$as_me: error: cannot create d
   fi
 }
 
-# at_func_group_postprocess
-# -------------------------
-at_func_group_postprocess ()
+# at_fn_group_banner ORDINAL LINE DESC PAD [BANNER]
+# -------------------------------------------------
+# Declare the test group ORDINAL, located at LINE with group description DESC,
+# and residing under BANNER. Use PAD to align the status column.
+at_fn_group_banner ()
+{
+  at_setup_line="$2"
+  test -n "$5" && at_fn_banner $5
+  at_desc="$3"
+  case $1 in
+    [0-9])      at_desc_line="  $1: ";;
+    [0-9][0-9]) at_desc_line=" $1: " ;;
+    *)          at_desc_line="$1: "  ;;
+  esac
+  as_fn_append at_desc_line "$3$4"
+  $at_quiet $as_echo_n "$at_desc_line"
+  echo "#                             -*- compilation -*-" >> "$at_group_log"
+}
+
+# at_fn_group_postprocess
+# -----------------------
+# Perform cleanup after running a test group.
+at_fn_group_postprocess ()
 {
   # Be sure to come back to the suite directory, in particular
   # since below we might `rm' the group directory we are in currently.
@@ -1645,6 +1673,7 @@ at_func_group_postprocess ()
       report this failure to <bug-tar@gnu.org>.
 _ATEOF
     $as_echo "$at_setup_line" >"$at_check_line_file"
+    at_status=99
   fi
   $at_verbose $as_echo_n "$at_group. $at_setup_line: "
   $as_echo_n "$at_group. $at_setup_line: " >> "$at_group_log"
@@ -1653,31 +1682,41 @@ _ATEOF
 	at_msg="UNEXPECTED PASS"
 	at_res=xpass
 	at_errexit=$at_errexit_p
+	at_color=$at_red
 	;;
     no:0)
 	at_msg="ok"
 	at_res=pass
 	at_errexit=false
+	at_color=$at_grn
 	;;
     *:77)
 	at_msg='skipped ('`cat "$at_check_line_file"`')'
 	at_res=skip
 	at_errexit=false
+	at_color=$at_blu
+	;;
+    no:* | *:99)
+	at_msg='FAILED ('`cat "$at_check_line_file"`')'
+	at_res=fail
+	at_errexit=$at_errexit_p
+	at_color=$at_red
 	;;
     yes:*)
 	at_msg='expected failure ('`cat "$at_check_line_file"`')'
 	at_res=xfail
 	at_errexit=false
-	;;
-    no:*)
-	at_msg='FAILED ('`cat "$at_check_line_file"`')'
-	at_res=fail
-	at_errexit=$at_errexit_p
+	at_color=$at_lgn
 	;;
   esac
   echo "$at_res" > "$at_job_dir/$at_res"
-  # Make sure there is a separator even with long titles.
-  $as_echo " $at_msg"
+  # In parallel mode, output the summary line only afterwards.
+  if test $at_jobs -ne 1 && test -n "$at_verbose"; then
+    $as_echo "$at_desc_line $at_color$at_msg$at_std"
+  else
+    # Make sure there is a separator even with long titles.
+    $as_echo " $at_color$at_msg$at_std"
+  fi
   at_log_msg="$at_group. $at_desc ($at_setup_line): $at_msg"
   case $at_status in
     0|77)
@@ -1694,7 +1733,7 @@ _ATEOF
 
       # Cleanup the group directory, unless the user wants the files.
       if $at_debug_p; then
-	at_func_create_debugging_script
+	at_fn_create_debugging_script
       else
 	if test -d "$at_group_dir"; then
 	  find "$at_group_dir" -type d ! -perm -700 -exec chmod u+rwx \{\} \;
@@ -1711,7 +1750,7 @@ _ATEOF
 
       # Upon failure, keep the group directory for autopsy, and create
       # the debugging script.  With -e, do not start any further tests.
-      at_func_create_debugging_script
+      at_fn_create_debugging_script
       if $at_errexit; then
 	echo stop > "$at_stop_file"
       fi
@@ -1724,22 +1763,135 @@ _ATEOF
 ## Driver loop. ##
 ## ------------ ##
 
+
+if (set -m && set +m && set +b) >/dev/null 2>&1; then
+  set +b
+  at_job_control_on='set -m' at_job_control_off='set +m' at_job_group=-
+else
+  at_job_control_on=: at_job_control_off=: at_job_group=
+fi
+
+for at_signal in 1 2 15; do
+  trap 'set +x; set +e
+	$at_job_control_off
+	at_signal='"$at_signal"'
+	echo stop > "$at_stop_file"
+	trap "" $at_signal
+	at_pgids=
+	for at_pgid in `jobs -p 2>/dev/null`; do
+	  at_pgids="$at_pgids $at_job_group$at_pgid"
+	done
+	test -z "$at_pgids" || kill -$at_signal $at_pgids 2>/dev/null
+	wait
+	if test "$at_jobs" -eq 1 || test -z "$at_verbose"; then
+	  echo >&2
+	fi
+	at_signame=`kill -l $at_signal 2>&1 || echo $at_signal`
+	set x $at_signame
+	test 0 -gt 2 && at_signame=$at_signal
+	{ $as_echo "$as_me:${as_lineno-$LINENO}: WARNING: caught signal $at_signame, bailing out" >&5
+$as_echo "$as_me: WARNING: caught signal $at_signame, bailing out" >&2;}
+	as_fn_arith 128 + $at_signal && exit_status=$as_val
+	as_fn_exit $exit_status' $at_signal
+done
+
 rm -f "$at_stop_file"
 at_first=:
 
-for at_group in $at_groups; do
-  at_func_group_prepare
-  if cd "$at_group_dir" &&
-     at_func_test $at_group &&
-     . "$at_test_source"; then :; else
-    { $as_echo "$as_me:$LINENO: WARNING: unable to parse test group: $at_group" >&5
+if test $at_jobs -ne 1 &&
+     rm -f "$at_job_fifo" &&
+     test -n "$at_job_group" &&
+     ( mkfifo "$at_job_fifo" && trap 'exit 1' PIPE STOP TSTP ) 2>/dev/null
+then
+  # FIFO job dispatcher.
+
+  trap 'at_pids=
+	for at_pid in `jobs -p`; do
+	  at_pids="$at_pids $at_job_group$at_pid"
+	done
+	if test -n "$at_pids"; then
+	  at_sig=TSTP
+	  test "${TMOUT+set}" = set && at_sig=STOP
+	  kill -$at_sig $at_pids 2>/dev/null
+	fi
+	kill -STOP $$
+	test -z "$at_pids" || kill -CONT $at_pids 2>/dev/null' TSTP
+
+  echo
+  # Turn jobs into a list of numbers, starting from 1.
+  at_joblist=`$as_echo " $at_groups_all " | \
+    sed 's/\( '$at_jobs'\) .*/\1/'`
+
+  set X $at_joblist
+  shift
+  for at_group in $at_groups; do
+    $at_job_control_on 2>/dev/null
+    (
+      # Start one test group.
+      $at_job_control_off
+      if $at_first; then
+	exec 7>"$at_job_fifo"
+      else
+	exec 6<&-
+      fi
+      trap 'set +x; set +e
+	    trap "" PIPE
+	    echo stop > "$at_stop_file"
+	    echo >&7
+	    as_fn_exit 141' PIPE
+      at_fn_group_prepare
+      if cd "$at_group_dir" &&
+	 at_fn_test $at_group &&
+	 . "$at_test_source"
+      then :; else
+	{ $as_echo "$as_me:${as_lineno-$LINENO}: WARNING: unable to parse test group: $at_group" >&5
 $as_echo "$as_me: WARNING: unable to parse test group: $at_group" >&2;}
-    at_failed=:
+	at_failed=:
+      fi
+      at_fn_group_postprocess
+      echo >&7
+    ) &
+    $at_job_control_off
+    if $at_first; then
+      at_first=false
+      exec 6<"$at_job_fifo" 7>"$at_job_fifo"
+    fi
+    shift # Consume one token.
+    if test $# -gt 0; then :; else
+      read at_token <&6 || break
+      set x $*
+    fi
+    test -f "$at_stop_file" && break
+  done
+  exec 7>&-
+  # Read back the remaining ($at_jobs - 1) tokens.
+  set X $at_joblist
+  shift
+  if test $# -gt 0; then
+    shift
+    for at_job
+    do
+      read at_token
+    done <&6
   fi
-  at_func_group_postprocess
-  test -f "$at_stop_file" && break
-  at_first=false
-done
+  exec 6<&-
+  wait
+else
+  # Run serially, avoid forks and other potential surprises.
+  for at_group in $at_groups; do
+    at_fn_group_prepare
+    if cd "$at_group_dir" &&
+       at_fn_test $at_group &&
+       . "$at_test_source"; then :; else
+      { $as_echo "$as_me:${as_lineno-$LINENO}: WARNING: unable to parse test group: $at_group" >&5
+$as_echo "$as_me: WARNING: unable to parse test group: $at_group" >&2;}
+      at_failed=:
+    fi
+    at_fn_group_postprocess
+    test -f "$at_stop_file" && break
+    at_first=false
+  done
+fi
 
 # Wrap up the test suite with summary statistics.
 cd "$at_helper_dir"
@@ -1760,12 +1912,9 @@ set X $at_xfail_list; shift; at_xfail_co
 set X $at_fail_list; shift; at_fail_count=$#; at_fail_list=$*
 set X $at_skip_list; shift; at_skip_count=$#
 
-at_func_arith $at_group_count - $at_skip_count
-at_run_count=$at_func_arith_result
-at_func_arith $at_xpass_count + $at_fail_count
-at_unexpected_count=$at_func_arith_result
-at_func_arith $at_xfail_count + $at_fail_count
-at_total_fail_count=$at_func_arith_result
+as_fn_arith $at_group_count - $at_skip_count && at_run_count=$as_val
+as_fn_arith $at_xpass_count + $at_fail_count && at_unexpected_count=$as_val
+as_fn_arith $at_xfail_count + $at_fail_count && at_total_fail_count=$as_val
 
 # Back to the top directory.
 cd "$at_dir"
@@ -1777,35 +1926,26 @@ at_stop_time=`date +%s 2>/dev/null`
 $as_echo "$as_me: ending at: $at_stop_date" >&5
 case $at_start_time,$at_stop_time in
   [0-9]*,[0-9]*)
-    at_func_arith $at_stop_time - $at_start_time
-    at_duration_s=$at_func_arith_result
-    at_func_arith $at_duration_s / 60
-    at_duration_m=$at_func_arith_result
-    at_func_arith $at_duration_m / 60
-    at_duration_h=$at_func_arith_result
-    at_func_arith $at_duration_s % 60
-    at_duration_s=$at_func_arith_result
-    at_func_arith $at_duration_m % 60
-    at_duration_m=$at_func_arith_result
+    as_fn_arith $at_stop_time - $at_start_time && at_duration_s=$as_val
+    as_fn_arith $at_duration_s / 60 && at_duration_m=$as_val
+    as_fn_arith $at_duration_m / 60 && at_duration_h=$as_val
+    as_fn_arith $at_duration_s % 60 && at_duration_s=$as_val
+    as_fn_arith $at_duration_m % 60 && at_duration_m=$as_val
     at_duration="${at_duration_h}h ${at_duration_m}m ${at_duration_s}s"
     $as_echo "$as_me: test suite duration: $at_duration" >&5
     ;;
 esac
 
 echo
-cat <<\_ASBOX
-## ------------- ##
+$as_echo "## ------------- ##
 ## Test results. ##
-## ------------- ##
-_ASBOX
+## ------------- ##"
 echo
 {
   echo
-  cat <<\_ASBOX
-## ------------- ##
+  $as_echo "## ------------- ##
 ## Test results. ##
-## ------------- ##
-_ASBOX
+## ------------- ##"
   echo
 } >&5
 
@@ -1823,12 +1963,14 @@ if $at_errexit_p && test $at_unexpected_
     at_result="$at_result $at_were run, one failed"
   fi
   at_result="$at_result unexpectedly and inhibited subsequent tests."
+  at_color=$at_red
 else
   # Don't you just love exponential explosion of the number of cases?
+  at_color=$at_red
   case $at_xpass_count:$at_fail_count:$at_xfail_count in
     # So far, so good.
-    0:0:0) at_result="$at_result $at_were successful." ;;
-    0:0:*) at_result="$at_result behaved as expected." ;;
+    0:0:0) at_result="$at_result $at_were successful." at_color=$at_grn ;;
+    0:0:*) at_result="$at_result behaved as expected." at_color=$at_lgn ;;
 
     # Some unexpected failures
     0:*:0) at_result="$at_result $at_were run,
@@ -1874,18 +2016,16 @@ $at_skip_count tests were skipped." ;;
 esac
 
 if test $at_unexpected_count = 0; then
-  echo "$at_result"
+  echo "$at_color$at_result$at_std"
   echo "$at_result" >&5
 else
-  echo "ERROR: $at_result" >&2
+  echo "${at_color}ERROR: $at_result$at_std" >&2
   echo "ERROR: $at_result" >&5
   {
     echo
-    cat <<\_ASBOX
-## ------------------------ ##
+    $as_echo "## ------------------------ ##
 ## Summary of the failures. ##
-## ------------------------ ##
-_ASBOX
+## ------------------------ ##"
 
     # Summary of failed and skipped tests.
     if test $at_fail_count != 0; then
@@ -1904,11 +2044,9 @@ _ASBOX
       echo
     fi
     if test $at_fail_count != 0; then
-      cat <<\_ASBOX
-## ---------------------- ##
+      $as_echo "## ---------------------- ##
 ## Detailed failed tests. ##
-## ---------------------- ##
-_ASBOX
+## ---------------------- ##"
       echo
       for at_group in $at_fail_list
       do
@@ -1940,19 +2078,21 @@ _ASBOX
 _ASBOX
 
   echo
-  $as_echo "Please send \`${at_testdir+${at_testdir}/}$as_me.log' and all information you think might help:
+  if $at_debug_p; then
+    at_msg='per-test log files'
+  else
+    at_msg="\`${at_testdir+${at_testdir}/}$as_me.log'"
+  fi
+  $as_echo "Please send $at_msg and all information you think might help:
 
    To: <bug-tar@gnu.org>
    Subject: [GNU tar 1.25] $as_me: $at_fail_list${at_fail_list:+ failed${at_xpass_list:+, }}$at_xpass_list${at_xpass_list:+ passed unexpectedly}
+
+You may investigate any problem if you feel able to do so, in which
+case the test suite provides a good starting point.  Its output may
+be found below \`${at_testdir+${at_testdir}/}$as_me.dir'.
 "
-  if test $at_debug_p = false; then
-    echo
-    echo 'You may investigate any problem if you feel able to do so, in which'
-    echo 'case the test suite provides a good starting point.  Its output may'
-    $as_echo "be found below \`${at_testdir+${at_testdir}/}$as_me.dir'."
-    echo
-  fi
-    exit 1
+  exit 1
 fi
 
 exit 0
@@ -1961,35 +2101,27 @@ exit 0
 ## Actual tests. ##
 ## ------------- ##
 #AT_START_1
-# 1. version.at:19: tar version
-at_setup_line='version.at:19'
-at_desc="tar version"
-$at_quiet $as_echo_n "  1: $at_desc                                    "
+at_fn_group_banner 1 'version.at:19' \
+  "tar version" "                                    "
 at_xfail=no
-echo "#                             -*- compilation -*-" >> "$at_group_log"
 (
-  $as_echo "1. version.at:19: testing ..."
+  $as_echo "1. $at_setup_line: testing $at_desc ..."
   $at_traceon
 
 
-{ $at_traceoff
+{ set +x
 $as_echo "$at_srcdir/version.at:21: tar --version | sed 1q"
-echo version.at:21 >"$at_check_line_file"
-
-if test -n "$at_traceon"; then
-  ( $at_traceon; tar --version | sed 1q ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :; tar --version | sed 1q ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+at_fn_check_prepare_notrace 'a shell pipeline' "version.at:21"
+( $at_check_trace; tar --version | sed 1q
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "tar (GNU tar) 1.25
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/version.at:21"
-if $at_failed; then
+at_fn_check_status 0 $at_status "$at_srcdir/version.at:21"
+if $at_failed; then :
   cat >$XFAILFILE <<'_EOT'
 
 ==============================================================
@@ -2000,26 +2132,22 @@ _EOT
 else
   rm -f $XFAILFILE
 fi
-
-$at_failed && at_func_log_failure
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
 
-  $at_traceoff
+  set +x
   $at_times_p && times >"$at_times_file"
-) 5>&1 2>&1 | eval $at_tee_pipe
-at_status=`cat "$at_status_file"`
+) 5>&1 2>&1 7>&- | eval $at_tee_pipe
+read at_status <"$at_status_file"
 #AT_STOP_1
 #AT_START_2
-# 2. pipe.at:30: decompressing from stdin
-at_setup_line='pipe.at:30'
-at_desc="decompressing from stdin"
-$at_quiet $as_echo_n "  2: $at_desc                       "
+at_fn_group_banner 2 'pipe.at:30' \
+  "decompressing from stdin" "                       "
 at_xfail=no
       test -f $XFAILFILE && at_xfail=yes
-echo "#                             -*- compilation -*-" >> "$at_group_log"
 (
-  $as_echo "2. pipe.at:30: testing ..."
+  $as_echo "2. $at_setup_line: testing $at_desc ..."
   $at_traceon
 
 
@@ -2027,7 +2155,7 @@ echo "#                             -*-
 
 
 
-  { $at_traceoff
+  { set +x
 $as_echo "$at_srcdir/pipe.at:34:
 mkdir v7
 (cd v7
@@ -2038,7 +2166,7 @@ export TAR_OPTIONS
 rm -rf *
 
 
-test -z "`sort < /dev/null 2>&1`" || exit 77
+test -z \"\`sort < /dev/null 2>&1\`\" || exit 77
 
 
 mkdir directory
@@ -2051,36 +2179,8 @@ echo \"separator\"
 cmp orig/file1 directory/file1
 echo \"separator\"
 cmp orig/file2 directory/file2)"
-echo pipe.at:34 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir v7
-(cd v7
-TEST_TAR_FORMAT=v7
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H v7"
-export TAR_OPTIONS
-rm -rf *
-
-
-test -z "`sort < /dev/null 2>&1`" || exit 77
-
-
-mkdir directory
-genfile --length 10240 --pattern zeros --file directory/file1
-genfile --length 13 --file directory/file2
-tar cf archive directory
-mv directory orig
-cat archive | tar xfv - --warning=no-timestamp | sort
-echo "separator"
-cmp orig/file1 directory/file1
-echo "separator"
-cmp orig/file2 directory/file2) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'a `...` command substitution' "pipe.at:34"
+( $at_check_trace;
 mkdir v7
 (cd v7
 TEST_TAR_FORMAT=v7
@@ -2102,11 +2202,11 @@ cat archive | tar xfv - --warning=no-tim
 echo "separator"
 cmp orig/file1 directory/file1
 echo "separator"
-cmp orig/file2 directory/file2) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+cmp orig/file2 directory/file2)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "directory/
 directory/file1
 directory/file2
@@ -2114,12 +2214,11 @@ separator
 separator
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/pipe.at:34"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/pipe.at:34"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/pipe.at:34:
 mkdir oldgnu
 (cd oldgnu
@@ -2130,7 +2229,7 @@ export TAR_OPTIONS
 rm -rf *
 
 
-test -z "`sort < /dev/null 2>&1`" || exit 77
+test -z \"\`sort < /dev/null 2>&1\`\" || exit 77
 
 
 mkdir directory
@@ -2143,36 +2242,8 @@ echo \"separator\"
 cmp orig/file1 directory/file1
 echo \"separator\"
 cmp orig/file2 directory/file2)"
-echo pipe.at:34 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir oldgnu
-(cd oldgnu
-TEST_TAR_FORMAT=oldgnu
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H oldgnu"
-export TAR_OPTIONS
-rm -rf *
-
-
-test -z "`sort < /dev/null 2>&1`" || exit 77
-
-
-mkdir directory
-genfile --length 10240 --pattern zeros --file directory/file1
-genfile --length 13 --file directory/file2
-tar cf archive directory
-mv directory orig
-cat archive | tar xfv - --warning=no-timestamp | sort
-echo "separator"
-cmp orig/file1 directory/file1
-echo "separator"
-cmp orig/file2 directory/file2) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'a `...` command substitution' "pipe.at:34"
+( $at_check_trace;
 mkdir oldgnu
 (cd oldgnu
 TEST_TAR_FORMAT=oldgnu
@@ -2194,11 +2265,11 @@ cat archive | tar xfv - --warning=no-tim
 echo "separator"
 cmp orig/file1 directory/file1
 echo "separator"
-cmp orig/file2 directory/file2) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+cmp orig/file2 directory/file2)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "directory/
 directory/file1
 directory/file2
@@ -2206,12 +2277,11 @@ separator
 separator
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/pipe.at:34"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/pipe.at:34"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/pipe.at:34:
 mkdir ustar
 (cd ustar
@@ -2222,7 +2292,7 @@ export TAR_OPTIONS
 rm -rf *
 
 
-test -z "`sort < /dev/null 2>&1`" || exit 77
+test -z \"\`sort < /dev/null 2>&1\`\" || exit 77
 
 
 mkdir directory
@@ -2235,11 +2305,8 @@ echo \"separator\"
 cmp orig/file1 directory/file1
 echo \"separator\"
 cmp orig/file2 directory/file2)"
-echo pipe.at:34 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
+at_fn_check_prepare_notrace 'a `...` command substitution' "pipe.at:34"
+( $at_check_trace;
 mkdir ustar
 (cd ustar
 TEST_TAR_FORMAT=ustar
@@ -2261,60 +2328,34 @@ cat archive | tar xfv - --warning=no-tim
 echo "separator"
 cmp orig/file1 directory/file1
 echo "separator"
-cmp orig/file2 directory/file2) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
-mkdir ustar
-(cd ustar
-TEST_TAR_FORMAT=ustar
+cmp orig/file2 directory/file2)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
+echo >>"$at_stdout"; $as_echo "directory/
+directory/file1
+directory/file2
+separator
+separator
+" | \
+  $at_diff - "$at_stdout" || at_failed=:
+at_fn_check_status 0 $at_status "$at_srcdir/pipe.at:34"
+$at_failed && at_fn_log_failure
+$at_traceon; }
+
+              { set +x
+$as_echo "$at_srcdir/pipe.at:34:
+mkdir posix
+(cd posix
+TEST_TAR_FORMAT=posix
 export TEST_TAR_FORMAT
-TAR_OPTIONS="-H ustar"
+TAR_OPTIONS=\"-H posix\"
 export TAR_OPTIONS
 rm -rf *
 
 
-test -z "`sort < /dev/null 2>&1`" || exit 77
-
-
-mkdir directory
-genfile --length 10240 --pattern zeros --file directory/file1
-genfile --length 13 --file directory/file2
-tar cf archive directory
-mv directory orig
-cat archive | tar xfv - --warning=no-timestamp | sort
-echo "separator"
-cmp orig/file1 directory/file1
-echo "separator"
-cmp orig/file2 directory/file2) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
-echo >>"$at_stdout"; $as_echo "directory/
-directory/file1
-directory/file2
-separator
-separator
-" | \
-  $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/pipe.at:34"
-
-$at_failed && at_func_log_failure
-$at_traceon; }
-
-              { $at_traceoff
-$as_echo "$at_srcdir/pipe.at:34:
-mkdir posix
-(cd posix
-TEST_TAR_FORMAT=posix
-export TEST_TAR_FORMAT
-TAR_OPTIONS=\"-H posix\"
-export TAR_OPTIONS
-rm -rf *
-
-
-test -z "`sort < /dev/null 2>&1`" || exit 77
+test -z \"\`sort < /dev/null 2>&1\`\" || exit 77
 
 
 mkdir directory
@@ -2327,36 +2368,8 @@ echo \"separator\"
 cmp orig/file1 directory/file1
 echo \"separator\"
 cmp orig/file2 directory/file2)"
-echo pipe.at:34 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir posix
-(cd posix
-TEST_TAR_FORMAT=posix
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H posix"
-export TAR_OPTIONS
-rm -rf *
-
-
-test -z "`sort < /dev/null 2>&1`" || exit 77
-
-
-mkdir directory
-genfile --length 10240 --pattern zeros --file directory/file1
-genfile --length 13 --file directory/file2
-tar cf archive directory
-mv directory orig
-cat archive | tar xfv - --warning=no-timestamp | sort
-echo "separator"
-cmp orig/file1 directory/file1
-echo "separator"
-cmp orig/file2 directory/file2) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'a `...` command substitution' "pipe.at:34"
+( $at_check_trace;
 mkdir posix
 (cd posix
 TEST_TAR_FORMAT=posix
@@ -2378,11 +2391,11 @@ cat archive | tar xfv - --warning=no-tim
 echo "separator"
 cmp orig/file1 directory/file1
 echo "separator"
-cmp orig/file2 directory/file2) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+cmp orig/file2 directory/file2)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "directory/
 directory/file1
 directory/file2
@@ -2390,12 +2403,11 @@ separator
 separator
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/pipe.at:34"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/pipe.at:34"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/pipe.at:34:
 mkdir gnu
 (cd gnu
@@ -2406,7 +2418,7 @@ export TAR_OPTIONS
 rm -rf *
 
 
-test -z "`sort < /dev/null 2>&1`" || exit 77
+test -z \"\`sort < /dev/null 2>&1\`\" || exit 77
 
 
 mkdir directory
@@ -2419,36 +2431,8 @@ echo \"separator\"
 cmp orig/file1 directory/file1
 echo \"separator\"
 cmp orig/file2 directory/file2)"
-echo pipe.at:34 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir gnu
-(cd gnu
-TEST_TAR_FORMAT=gnu
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H gnu"
-export TAR_OPTIONS
-rm -rf *
-
-
-test -z "`sort < /dev/null 2>&1`" || exit 77
-
-
-mkdir directory
-genfile --length 10240 --pattern zeros --file directory/file1
-genfile --length 13 --file directory/file2
-tar cf archive directory
-mv directory orig
-cat archive | tar xfv - --warning=no-timestamp | sort
-echo "separator"
-cmp orig/file1 directory/file1
-echo "separator"
-cmp orig/file2 directory/file2) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'a `...` command substitution' "pipe.at:34"
+( $at_check_trace;
 mkdir gnu
 (cd gnu
 TEST_TAR_FORMAT=gnu
@@ -2470,11 +2454,11 @@ cat archive | tar xfv - --warning=no-tim
 echo "separator"
 cmp orig/file1 directory/file1
 echo "separator"
-cmp orig/file2 directory/file2) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+cmp orig/file2 directory/file2)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "directory/
 directory/file1
 directory/file2
@@ -2482,135 +2466,103 @@ separator
 separator
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/pipe.at:34"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/pipe.at:34"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
 
 
 
-  $at_traceoff
+  set +x
   $at_times_p && times >"$at_times_file"
-) 5>&1 2>&1 | eval $at_tee_pipe
-at_status=`cat "$at_status_file"`
+) 5>&1 2>&1 7>&- | eval $at_tee_pipe
+read at_status <"$at_status_file"
 #AT_STOP_2
 #AT_START_3
-# 3. options.at:24: mixing options
-at_setup_line='options.at:24'
-at_desc="mixing options"
-$at_quiet $as_echo_n "  3: $at_desc                                 "
+at_fn_group_banner 3 'options.at:24' \
+  "mixing options" "                                 "
 at_xfail=no
-echo "#                             -*- compilation -*-" >> "$at_group_log"
 (
-  $as_echo "3. options.at:24: testing ..."
+  $as_echo "3. $at_setup_line: testing $at_desc ..."
   $at_traceon
 
 
 
-{ $at_traceoff
+{ set +x
 $as_echo "$at_srcdir/options.at:27:
 echo > file1
 TAR_OPTIONS=--numeric-owner tar chof archive file1
 tar tf archive
 "
-echo options.at:27 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-echo > file1
-TAR_OPTIONS=--numeric-owner tar chof archive file1
-tar tf archive
- ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'an embedded newline' "options.at:27"
+( $at_check_trace;
 echo > file1
 TAR_OPTIONS=--numeric-owner tar chof archive file1
 tar tf archive
- ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "file1
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/options.at:27"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/options.at:27"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
 
-  $at_traceoff
+  set +x
   $at_times_p && times >"$at_times_file"
-) 5>&1 2>&1 | eval $at_tee_pipe
-at_status=`cat "$at_status_file"`
+) 5>&1 2>&1 7>&- | eval $at_tee_pipe
+read at_status <"$at_status_file"
 #AT_STOP_3
 #AT_START_4
-# 4. options02.at:26: interspersed options
-at_setup_line='options02.at:26'
-at_desc="interspersed options"
-$at_quiet $as_echo_n "  4: $at_desc                           "
+at_fn_group_banner 4 'options02.at:26' \
+  "interspersed options" "                           "
 at_xfail=no
-echo "#                             -*- compilation -*-" >> "$at_group_log"
 (
-  $as_echo "4. options02.at:26: testing ..."
+  $as_echo "4. $at_setup_line: testing $at_desc ..."
   $at_traceon
 
 
 
-{ $at_traceoff
+{ set +x
 $as_echo "$at_srcdir/options02.at:29:
 echo > file1
 tar c file1 -f archive
 tar tf archive
 "
-echo options02.at:29 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-echo > file1
-tar c file1 -f archive
-tar tf archive
- ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'an embedded newline' "options02.at:29"
+( $at_check_trace;
 echo > file1
 tar c file1 -f archive
 tar tf archive
- ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "file1
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/options02.at:29"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/options02.at:29"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
 
-  $at_traceoff
+  set +x
   $at_times_p && times >"$at_times_file"
-) 5>&1 2>&1 | eval $at_tee_pipe
-at_status=`cat "$at_status_file"`
+) 5>&1 2>&1 7>&- | eval $at_tee_pipe
+read at_status <"$at_status_file"
 #AT_STOP_4
 #AT_START_5
-# 5. T-empty.at:26: files-from: empty entries
-at_setup_line='T-empty.at:26'
-at_desc="files-from: empty entries"
-$at_quiet $as_echo_n "  5: $at_desc                      "
+at_fn_group_banner 5 'T-empty.at:26' \
+  "files-from: empty entries" "                      "
 at_xfail=no
       test -f $XFAILFILE && at_xfail=yes
-echo "#                             -*- compilation -*-" >> "$at_group_log"
 (
-  $as_echo "5. T-empty.at:26: testing ..."
+  $as_echo "5. $at_setup_line: testing $at_desc ..."
   $at_traceon
 
 
@@ -2625,7 +2577,7 @@ _ATEOF
 
 
 
-  { $at_traceoff
+  { set +x
 $as_echo "$at_srcdir/T-empty.at:36:
 mkdir ustar
 (cd ustar
@@ -2636,7 +2588,7 @@ export TAR_OPTIONS
 rm -rf *
 
 
-test -z "`sort < /dev/null 2>&1`" || exit 77
+test -z \"\`sort < /dev/null 2>&1\`\" || exit 77
 
 
 genfile --file jeden
@@ -2645,32 +2597,8 @@ genfile --file trzy
 
 tar cfvT archive ../file-list | sort
 )"
-echo T-empty.at:36 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir ustar
-(cd ustar
-TEST_TAR_FORMAT=ustar
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H ustar"
-export TAR_OPTIONS
-rm -rf *
-
-
-test -z "`sort < /dev/null 2>&1`" || exit 77
-
-
-genfile --file jeden
-genfile --file dwa
-genfile --file trzy
-
-tar cfvT archive ../file-list | sort
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'a `...` command substitution' "T-empty.at:36"
+( $at_check_trace;
 mkdir ustar
 (cd ustar
 TEST_TAR_FORMAT=ustar
@@ -2688,39 +2616,35 @@ genfile --file dwa
 genfile --file trzy
 
 tar cfvT archive ../file-list | sort
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "dwa
 jeden
 trzy
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/T-empty.at:36"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/T-empty.at:36"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
 
  # Testing one format is enough
 
-  $at_traceoff
+  set +x
   $at_times_p && times >"$at_times_file"
-) 5>&1 2>&1 | eval $at_tee_pipe
-at_status=`cat "$at_status_file"`
+) 5>&1 2>&1 7>&- | eval $at_tee_pipe
+read at_status <"$at_status_file"
 #AT_STOP_5
 #AT_START_6
-# 6. T-null.at:21: files-from: 0-separated file without -0
-at_setup_line='T-null.at:21'
-at_desc="files-from: 0-separated file without -0"
-$at_quiet $as_echo_n "  6: $at_desc        "
+at_fn_group_banner 6 'T-null.at:21' \
+  "files-from: 0-separated file without -0" "        "
 at_xfail=no
       test -f $XFAILFILE && at_xfail=yes
-echo "#                             -*- compilation -*-" >> "$at_group_log"
 (
-  $as_echo "6. T-null.at:21: testing ..."
+  $as_echo "6. $at_setup_line: testing $at_desc ..."
   $at_traceon
 
 
@@ -2733,7 +2657,7 @@ _ATEOF
 
 
 
-  { $at_traceoff
+  { set +x
 $as_echo "$at_srcdir/T-null.at:28:
 mkdir ustar
 (cd ustar
@@ -2744,7 +2668,7 @@ export TAR_OPTIONS
 rm -rf *
 
 
-test -z "`sort < /dev/null 2>&1`" || exit 77
+test -z \"\`sort < /dev/null 2>&1\`\" || exit 77
 
 
 echo dwa > temp
@@ -2759,38 +2683,8 @@ genfile -f trzy
 
 tar cfTv archive file-list | sort
 )"
-echo T-null.at:28 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir ustar
-(cd ustar
-TEST_TAR_FORMAT=ustar
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H ustar"
-export TAR_OPTIONS
-rm -rf *
-
-
-test -z "`sort < /dev/null 2>&1`" || exit 77
-
-
-echo dwa > temp
-echo trzy >> temp
-cat temp | tr '\n' '\0' > temp1
-echo jeden > file-list
-cat temp1 >> file-list
-
-genfile -f "jeden
-dwa" || exit 77
-genfile -f trzy
-
-tar cfTv archive file-list | sort
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'a `...` command substitution' "T-null.at:28"
+( $at_check_trace;
 mkdir ustar
 (cd ustar
 TEST_TAR_FORMAT=ustar
@@ -2814,44 +2708,40 @@ dwa" || exit 77
 genfile -f trzy
 
 tar cfTv archive file-list | sort
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
 echo >>"$at_stderr"; $as_echo "tar: file-list: file name read contains nul character
 " | \
   $at_diff - "$at_stderr" || at_failed=:
 $at_diff expout "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/T-null.at:28"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/T-null.at:28"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
 
  # Testing one format is enough
 
-  $at_traceoff
+  set +x
   $at_times_p && times >"$at_times_file"
-) 5>&1 2>&1 | eval $at_tee_pipe
-at_status=`cat "$at_status_file"`
+) 5>&1 2>&1 7>&- | eval $at_tee_pipe
+read at_status <"$at_status_file"
 #AT_STOP_6
 #AT_START_7
-# 7. indexfile.at:26: tar --index-file=FILE --file=-
-at_setup_line='indexfile.at:26'
-at_desc="tar --index-file=FILE --file=-"
-$at_quiet $as_echo_n "  7: $at_desc                 "
+at_fn_group_banner 7 'indexfile.at:26' \
+  "tar --index-file=FILE --file=-" "                 "
 at_xfail=no
       test -f $XFAILFILE && at_xfail=yes
-echo "#                             -*- compilation -*-" >> "$at_group_log"
 (
-  $as_echo "7. indexfile.at:26: testing ..."
+  $as_echo "7. $at_setup_line: testing $at_desc ..."
   $at_traceon
 
 
 
 
 
-  { $at_traceoff
+  { set +x
 $as_echo "$at_srcdir/indexfile.at:29:
 mkdir v7
 (cd v7
@@ -2871,32 +2761,8 @@ tar -c -v -f - --index-file=idx director
 echo \"Testing the archive\"
 tar -tf archive
 )"
-echo indexfile.at:29 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir v7
-(cd v7
-TEST_TAR_FORMAT=v7
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H v7"
-export TAR_OPTIONS
-rm -rf *
-
-
-mkdir directory
-genfile --file=directory/a --length=1035
-
-echo "Creating the archive"
-tar -c -v -f - --index-file=idx directory > archive
-
-echo "Testing the archive"
-tar -tf archive
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'an embedded newline' "indexfile.at:29"
+( $at_check_trace;
 mkdir v7
 (cd v7
 TEST_TAR_FORMAT=v7
@@ -2914,23 +2780,22 @@ tar -c -v -f - --index-file=idx director
 
 echo "Testing the archive"
 tar -tf archive
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "Creating the archive
 Testing the archive
 directory/
 directory/a
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/indexfile.at:29"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/indexfile.at:29"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/indexfile.at:29:
 mkdir oldgnu
 (cd oldgnu
@@ -2950,32 +2815,8 @@ tar -c -v -f - --index-file=idx director
 echo \"Testing the archive\"
 tar -tf archive
 )"
-echo indexfile.at:29 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir oldgnu
-(cd oldgnu
-TEST_TAR_FORMAT=oldgnu
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H oldgnu"
-export TAR_OPTIONS
-rm -rf *
-
-
-mkdir directory
-genfile --file=directory/a --length=1035
-
-echo "Creating the archive"
-tar -c -v -f - --index-file=idx directory > archive
-
-echo "Testing the archive"
-tar -tf archive
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'an embedded newline' "indexfile.at:29"
+( $at_check_trace;
 mkdir oldgnu
 (cd oldgnu
 TEST_TAR_FORMAT=oldgnu
@@ -2993,23 +2834,22 @@ tar -c -v -f - --index-file=idx director
 
 echo "Testing the archive"
 tar -tf archive
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "Creating the archive
 Testing the archive
 directory/
 directory/a
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/indexfile.at:29"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/indexfile.at:29"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/indexfile.at:29:
 mkdir ustar
 (cd ustar
@@ -3029,32 +2869,8 @@ tar -c -v -f - --index-file=idx director
 echo \"Testing the archive\"
 tar -tf archive
 )"
-echo indexfile.at:29 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir ustar
-(cd ustar
-TEST_TAR_FORMAT=ustar
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H ustar"
-export TAR_OPTIONS
-rm -rf *
-
-
-mkdir directory
-genfile --file=directory/a --length=1035
-
-echo "Creating the archive"
-tar -c -v -f - --index-file=idx directory > archive
-
-echo "Testing the archive"
-tar -tf archive
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'an embedded newline' "indexfile.at:29"
+( $at_check_trace;
 mkdir ustar
 (cd ustar
 TEST_TAR_FORMAT=ustar
@@ -3072,23 +2888,22 @@ tar -c -v -f - --index-file=idx director
 
 echo "Testing the archive"
 tar -tf archive
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "Creating the archive
 Testing the archive
 directory/
 directory/a
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/indexfile.at:29"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/indexfile.at:29"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/indexfile.at:29:
 mkdir posix
 (cd posix
@@ -3108,32 +2923,8 @@ tar -c -v -f - --index-file=idx director
 echo \"Testing the archive\"
 tar -tf archive
 )"
-echo indexfile.at:29 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir posix
-(cd posix
-TEST_TAR_FORMAT=posix
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H posix"
-export TAR_OPTIONS
-rm -rf *
-
-
-mkdir directory
-genfile --file=directory/a --length=1035
-
-echo "Creating the archive"
-tar -c -v -f - --index-file=idx directory > archive
-
-echo "Testing the archive"
-tar -tf archive
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'an embedded newline' "indexfile.at:29"
+( $at_check_trace;
 mkdir posix
 (cd posix
 TEST_TAR_FORMAT=posix
@@ -3151,23 +2942,22 @@ tar -c -v -f - --index-file=idx director
 
 echo "Testing the archive"
 tar -tf archive
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "Creating the archive
 Testing the archive
 directory/
 directory/a
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/indexfile.at:29"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/indexfile.at:29"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/indexfile.at:29:
 mkdir gnu
 (cd gnu
@@ -3187,32 +2977,8 @@ tar -c -v -f - --index-file=idx director
 echo \"Testing the archive\"
 tar -tf archive
 )"
-echo indexfile.at:29 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir gnu
-(cd gnu
-TEST_TAR_FORMAT=gnu
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H gnu"
-export TAR_OPTIONS
-rm -rf *
-
-
-mkdir directory
-genfile --file=directory/a --length=1035
-
-echo "Creating the archive"
-tar -c -v -f - --index-file=idx directory > archive
-
-echo "Testing the archive"
-tar -tf archive
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'an embedded newline' "indexfile.at:29"
+( $at_check_trace;
 mkdir gnu
 (cd gnu
 TEST_TAR_FORMAT=gnu
@@ -3230,47 +2996,43 @@ tar -c -v -f - --index-file=idx director
 
 echo "Testing the archive"
 tar -tf archive
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "Creating the archive
 Testing the archive
 directory/
 directory/a
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/indexfile.at:29"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/indexfile.at:29"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
 
 
 
-  $at_traceoff
+  set +x
   $at_times_p && times >"$at_times_file"
-) 5>&1 2>&1 | eval $at_tee_pipe
-at_status=`cat "$at_status_file"`
+) 5>&1 2>&1 7>&- | eval $at_tee_pipe
+read at_status <"$at_status_file"
 #AT_STOP_7
 #AT_START_8
-# 8. verbose.at:26: tar cvf -
-at_setup_line='verbose.at:26'
-at_desc="tar cvf -"
-$at_quiet $as_echo_n "  8: $at_desc                                      "
+at_fn_group_banner 8 'verbose.at:26' \
+  "tar cvf -" "                                      "
 at_xfail=no
       test -f $XFAILFILE && at_xfail=yes
-echo "#                             -*- compilation -*-" >> "$at_group_log"
 (
-  $as_echo "8. verbose.at:26: testing ..."
+  $as_echo "8. $at_setup_line: testing $at_desc ..."
   $at_traceon
 
 
 
 
 
-  { $at_traceoff
+  { set +x
 $as_echo "$at_srcdir/verbose.at:29:
 mkdir v7
 (cd v7
@@ -3286,28 +3048,8 @@ tar cvf - file > archive
 echo Testing the archive
 tar tf archive
 )"
-echo verbose.at:29 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir v7
-(cd v7
-TEST_TAR_FORMAT=v7
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H v7"
-export TAR_OPTIONS
-rm -rf *
-
-genfile --file file --length 10240
-echo Creating the archive
-tar cvf - file > archive
-echo Testing the archive
-tar tf archive
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'an embedded newline' "verbose.at:29"
+( $at_check_trace;
 mkdir v7
 (cd v7
 TEST_TAR_FORMAT=v7
@@ -3321,10 +3063,10 @@ echo Creating the archive
 tar cvf - file > archive
 echo Testing the archive
 tar tf archive
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
 echo >>"$at_stderr"; $as_echo "file
 " | \
   $at_diff - "$at_stderr" || at_failed=:
@@ -3333,12 +3075,11 @@ Testing the archive
 file
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/verbose.at:29"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/verbose.at:29"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/verbose.at:29:
 mkdir oldgnu
 (cd oldgnu
@@ -3354,28 +3095,8 @@ tar cvf - file > archive
 echo Testing the archive
 tar tf archive
 )"
-echo verbose.at:29 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir oldgnu
-(cd oldgnu
-TEST_TAR_FORMAT=oldgnu
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H oldgnu"
-export TAR_OPTIONS
-rm -rf *
-
-genfile --file file --length 10240
-echo Creating the archive
-tar cvf - file > archive
-echo Testing the archive
-tar tf archive
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'an embedded newline' "verbose.at:29"
+( $at_check_trace;
 mkdir oldgnu
 (cd oldgnu
 TEST_TAR_FORMAT=oldgnu
@@ -3389,10 +3110,10 @@ echo Creating the archive
 tar cvf - file > archive
 echo Testing the archive
 tar tf archive
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
 echo >>"$at_stderr"; $as_echo "file
 " | \
   $at_diff - "$at_stderr" || at_failed=:
@@ -3401,12 +3122,11 @@ Testing the archive
 file
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/verbose.at:29"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/verbose.at:29"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/verbose.at:29:
 mkdir ustar
 (cd ustar
@@ -3422,28 +3142,8 @@ tar cvf - file > archive
 echo Testing the archive
 tar tf archive
 )"
-echo verbose.at:29 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir ustar
-(cd ustar
-TEST_TAR_FORMAT=ustar
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H ustar"
-export TAR_OPTIONS
-rm -rf *
-
-genfile --file file --length 10240
-echo Creating the archive
-tar cvf - file > archive
-echo Testing the archive
-tar tf archive
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'an embedded newline' "verbose.at:29"
+( $at_check_trace;
 mkdir ustar
 (cd ustar
 TEST_TAR_FORMAT=ustar
@@ -3457,10 +3157,10 @@ echo Creating the archive
 tar cvf - file > archive
 echo Testing the archive
 tar tf archive
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
 echo >>"$at_stderr"; $as_echo "file
 " | \
   $at_diff - "$at_stderr" || at_failed=:
@@ -3469,12 +3169,11 @@ Testing the archive
 file
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/verbose.at:29"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/verbose.at:29"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/verbose.at:29:
 mkdir posix
 (cd posix
@@ -3490,28 +3189,8 @@ tar cvf - file > archive
 echo Testing the archive
 tar tf archive
 )"
-echo verbose.at:29 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir posix
-(cd posix
-TEST_TAR_FORMAT=posix
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H posix"
-export TAR_OPTIONS
-rm -rf *
-
-genfile --file file --length 10240
-echo Creating the archive
-tar cvf - file > archive
-echo Testing the archive
-tar tf archive
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'an embedded newline' "verbose.at:29"
+( $at_check_trace;
 mkdir posix
 (cd posix
 TEST_TAR_FORMAT=posix
@@ -3525,10 +3204,10 @@ echo Creating the archive
 tar cvf - file > archive
 echo Testing the archive
 tar tf archive
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
 echo >>"$at_stderr"; $as_echo "file
 " | \
   $at_diff - "$at_stderr" || at_failed=:
@@ -3537,12 +3216,11 @@ Testing the archive
 file
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/verbose.at:29"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/verbose.at:29"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/verbose.at:29:
 mkdir gnu
 (cd gnu
@@ -3558,28 +3236,8 @@ tar cvf - file > archive
 echo Testing the archive
 tar tf archive
 )"
-echo verbose.at:29 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir gnu
-(cd gnu
-TEST_TAR_FORMAT=gnu
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H gnu"
-export TAR_OPTIONS
-rm -rf *
-
-genfile --file file --length 10240
-echo Creating the archive
-tar cvf - file > archive
-echo Testing the archive
-tar tf archive
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'an embedded newline' "verbose.at:29"
+( $at_check_trace;
 mkdir gnu
 (cd gnu
 TEST_TAR_FORMAT=gnu
@@ -3593,10 +3251,10 @@ echo Creating the archive
 tar cvf - file > archive
 echo Testing the archive
 tar tf archive
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
 echo >>"$at_stderr"; $as_echo "file
 " | \
   $at_diff - "$at_stderr" || at_failed=:
@@ -3605,36 +3263,32 @@ Testing the archive
 file
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/verbose.at:29"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/verbose.at:29"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
 
 
 
-  $at_traceoff
+  set +x
   $at_times_p && times >"$at_times_file"
-) 5>&1 2>&1 | eval $at_tee_pipe
-at_status=`cat "$at_status_file"`
+) 5>&1 2>&1 7>&- | eval $at_tee_pipe
+read at_status <"$at_status_file"
 #AT_STOP_8
 #AT_START_9
-# 9. append.at:21: append
-at_setup_line='append.at:21'
-at_desc="append"
-$at_quiet $as_echo_n "  9: $at_desc                                         "
+at_fn_group_banner 9 'append.at:21' \
+  "append" "                                         "
 at_xfail=no
       test -f $XFAILFILE && at_xfail=yes
-echo "#                             -*- compilation -*-" >> "$at_group_log"
 (
-  $as_echo "9. append.at:21: testing ..."
+  $as_echo "9. $at_setup_line: testing $at_desc ..."
   $at_traceon
 
 
 
 
 
-  { $at_traceoff
+  { set +x
 $as_echo "$at_srcdir/append.at:24:
 mkdir v7
 (cd v7
@@ -3648,26 +3302,8 @@ touch file1
           tar cf archive file1
           tar rf archive file2
           tar tf archive)"
-echo append.at:24 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir v7
-(cd v7
-TEST_TAR_FORMAT=v7
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H v7"
-export TAR_OPTIONS
-rm -rf *
-touch file1
-          touch file2
-          tar cf archive file1
-          tar rf archive file2
-          tar tf archive) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'an embedded newline' "append.at:24"
+( $at_check_trace;
 mkdir v7
 (cd v7
 TEST_TAR_FORMAT=v7
@@ -3679,21 +3315,20 @@ touch file1
           touch file2
           tar cf archive file1
           tar rf archive file2
-          tar tf archive) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+          tar tf archive)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "file1
 file2
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/append.at:24"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/append.at:24"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/append.at:24:
 mkdir oldgnu
 (cd oldgnu
@@ -3707,26 +3342,8 @@ touch file1
           tar cf archive file1
           tar rf archive file2
           tar tf archive)"
-echo append.at:24 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir oldgnu
-(cd oldgnu
-TEST_TAR_FORMAT=oldgnu
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H oldgnu"
-export TAR_OPTIONS
-rm -rf *
-touch file1
-          touch file2
-          tar cf archive file1
-          tar rf archive file2
-          tar tf archive) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'an embedded newline' "append.at:24"
+( $at_check_trace;
 mkdir oldgnu
 (cd oldgnu
 TEST_TAR_FORMAT=oldgnu
@@ -3738,21 +3355,20 @@ touch file1
           touch file2
           tar cf archive file1
           tar rf archive file2
-          tar tf archive) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+          tar tf archive)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "file1
 file2
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/append.at:24"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/append.at:24"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/append.at:24:
 mkdir ustar
 (cd ustar
@@ -3766,26 +3382,8 @@ touch file1
           tar cf archive file1
           tar rf archive file2
           tar tf archive)"
-echo append.at:24 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir ustar
-(cd ustar
-TEST_TAR_FORMAT=ustar
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H ustar"
-export TAR_OPTIONS
-rm -rf *
-touch file1
-          touch file2
-          tar cf archive file1
-          tar rf archive file2
-          tar tf archive) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'an embedded newline' "append.at:24"
+( $at_check_trace;
 mkdir ustar
 (cd ustar
 TEST_TAR_FORMAT=ustar
@@ -3797,21 +3395,20 @@ touch file1
           touch file2
           tar cf archive file1
           tar rf archive file2
-          tar tf archive) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+          tar tf archive)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "file1
 file2
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/append.at:24"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/append.at:24"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/append.at:24:
 mkdir posix
 (cd posix
@@ -3825,26 +3422,8 @@ touch file1
           tar cf archive file1
           tar rf archive file2
           tar tf archive)"
-echo append.at:24 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir posix
-(cd posix
-TEST_TAR_FORMAT=posix
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H posix"
-export TAR_OPTIONS
-rm -rf *
-touch file1
-          touch file2
-          tar cf archive file1
-          tar rf archive file2
-          tar tf archive) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'an embedded newline' "append.at:24"
+( $at_check_trace;
 mkdir posix
 (cd posix
 TEST_TAR_FORMAT=posix
@@ -3856,21 +3435,20 @@ touch file1
           touch file2
           tar cf archive file1
           tar rf archive file2
-          tar tf archive) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+          tar tf archive)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "file1
 file2
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/append.at:24"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/append.at:24"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/append.at:24:
 mkdir gnu
 (cd gnu
@@ -3884,26 +3462,8 @@ touch file1
           tar cf archive file1
           tar rf archive file2
           tar tf archive)"
-echo append.at:24 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir gnu
-(cd gnu
-TEST_TAR_FORMAT=gnu
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H gnu"
-export TAR_OPTIONS
-rm -rf *
-touch file1
-          touch file2
-          tar cf archive file1
-          tar rf archive file2
-          tar tf archive) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'an embedded newline' "append.at:24"
+( $at_check_trace;
 mkdir gnu
 (cd gnu
 TEST_TAR_FORMAT=gnu
@@ -3915,38 +3475,34 @@ touch file1
           touch file2
           tar cf archive file1
           tar rf archive file2
-          tar tf archive) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+          tar tf archive)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "file1
 file2
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/append.at:24"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/append.at:24"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
 
 
 
-  $at_traceoff
+  set +x
   $at_times_p && times >"$at_times_file"
-) 5>&1 2>&1 | eval $at_tee_pipe
-at_status=`cat "$at_status_file"`
+) 5>&1 2>&1 7>&- | eval $at_tee_pipe
+read at_status <"$at_status_file"
 #AT_STOP_9
 #AT_START_10
-# 10. append01.at:29: appending files with long names
-at_setup_line='append01.at:29'
-at_desc="appending files with long names"
-$at_quiet $as_echo_n " 10: $at_desc                "
+at_fn_group_banner 10 'append01.at:29' \
+  "appending files with long names" "                "
 at_xfail=no
       test -f $XFAILFILE && at_xfail=yes
-echo "#                             -*- compilation -*-" >> "$at_group_log"
 (
-  $as_echo "10. append01.at:29: testing ..."
+  $as_echo "10. $at_setup_line: testing $at_desc ..."
   $at_traceon
 
 
@@ -3955,7 +3511,7 @@ echo "#                             -*-
 
 
 
-  { $at_traceoff
+  { set +x
 $as_echo "$at_srcdir/append01.at:34:
 mkdir oldgnu
 (cd oldgnu
@@ -3971,28 +3527,8 @@ tar cf archive This_is_a_very_long_file_
 tar rf archive This_is_a_very_long_file_name_prefix_that_is_designed_to_cause_problems_with_appending_long_file_names_that_run_into_a_limit_of_the_ustar_tarX/file2
 tar tf archive
 )"
-echo append01.at:34 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir oldgnu
-(cd oldgnu
-TEST_TAR_FORMAT=oldgnu
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H oldgnu"
-export TAR_OPTIONS
-rm -rf *
-
-mkdir This_is_a_very_long_file_name_prefix_that_is_designed_to_cause_problems_with_appending_long_file_names_that_run_into_a_limit_of_the_ustar_tarX
-touch This_is_a_very_long_file_name_prefix_that_is_designed_to_cause_problems_with_appending_long_file_names_that_run_into_a_limit_of_the_ustar_tarX/file1 This_is_a_very_long_file_name_prefix_that_is_designed_to_cause_problems_with_appending_long_file_names_that_run_into_a_limit_of_the_ustar_tarX/file2
-tar cf archive This_is_a_very_long_file_name_prefix_that_is_designed_to_cause_problems_with_appending_long_file_names_that_run_into_a_limit_of_the_ustar_tarX/file1
-tar rf archive This_is_a_very_long_file_name_prefix_that_is_designed_to_cause_problems_with_appending_long_file_names_that_run_into_a_limit_of_the_ustar_tarX/file2
-tar tf archive
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'an embedded newline' "append01.at:34"
+( $at_check_trace;
 mkdir oldgnu
 (cd oldgnu
 TEST_TAR_FORMAT=oldgnu
@@ -4006,21 +3542,20 @@ touch This_is_a_very_long_file_name_pref
 tar cf archive This_is_a_very_long_file_name_prefix_that_is_designed_to_cause_problems_with_appending_long_file_names_that_run_into_a_limit_of_the_ustar_tarX/file1
 tar rf archive This_is_a_very_long_file_name_prefix_that_is_designed_to_cause_problems_with_appending_long_file_names_that_run_into_a_limit_of_the_ustar_tarX/file2
 tar tf archive
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "This_is_a_very_long_file_name_prefix_that_is_designed_to_cause_problems_with_appending_long_file_names_that_run_into_a_limit_of_the_ustar_tarX/file1
 This_is_a_very_long_file_name_prefix_that_is_designed_to_cause_problems_with_appending_long_file_names_that_run_into_a_limit_of_the_ustar_tarX/file2
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/append01.at:34"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/append01.at:34"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/append01.at:34:
 mkdir ustar
 (cd ustar
@@ -4036,28 +3571,8 @@ tar cf archive This_is_a_very_long_file_
 tar rf archive This_is_a_very_long_file_name_prefix_that_is_designed_to_cause_problems_with_appending_long_file_names_that_run_into_a_limit_of_the_ustar_tarX/file2
 tar tf archive
 )"
-echo append01.at:34 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir ustar
-(cd ustar
-TEST_TAR_FORMAT=ustar
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H ustar"
-export TAR_OPTIONS
-rm -rf *
-
-mkdir This_is_a_very_long_file_name_prefix_that_is_designed_to_cause_problems_with_appending_long_file_names_that_run_into_a_limit_of_the_ustar_tarX
-touch This_is_a_very_long_file_name_prefix_that_is_designed_to_cause_problems_with_appending_long_file_names_that_run_into_a_limit_of_the_ustar_tarX/file1 This_is_a_very_long_file_name_prefix_that_is_designed_to_cause_problems_with_appending_long_file_names_that_run_into_a_limit_of_the_ustar_tarX/file2
-tar cf archive This_is_a_very_long_file_name_prefix_that_is_designed_to_cause_problems_with_appending_long_file_names_that_run_into_a_limit_of_the_ustar_tarX/file1
-tar rf archive This_is_a_very_long_file_name_prefix_that_is_designed_to_cause_problems_with_appending_long_file_names_that_run_into_a_limit_of_the_ustar_tarX/file2
-tar tf archive
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'an embedded newline' "append01.at:34"
+( $at_check_trace;
 mkdir ustar
 (cd ustar
 TEST_TAR_FORMAT=ustar
@@ -4071,21 +3586,20 @@ touch This_is_a_very_long_file_name_pref
 tar cf archive This_is_a_very_long_file_name_prefix_that_is_designed_to_cause_problems_with_appending_long_file_names_that_run_into_a_limit_of_the_ustar_tarX/file1
 tar rf archive This_is_a_very_long_file_name_prefix_that_is_designed_to_cause_problems_with_appending_long_file_names_that_run_into_a_limit_of_the_ustar_tarX/file2
 tar tf archive
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "This_is_a_very_long_file_name_prefix_that_is_designed_to_cause_problems_with_appending_long_file_names_that_run_into_a_limit_of_the_ustar_tarX/file1
 This_is_a_very_long_file_name_prefix_that_is_designed_to_cause_problems_with_appending_long_file_names_that_run_into_a_limit_of_the_ustar_tarX/file2
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/append01.at:34"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/append01.at:34"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/append01.at:34:
 mkdir posix
 (cd posix
@@ -4101,28 +3615,8 @@ tar cf archive This_is_a_very_long_file_
 tar rf archive This_is_a_very_long_file_name_prefix_that_is_designed_to_cause_problems_with_appending_long_file_names_that_run_into_a_limit_of_the_ustar_tarX/file2
 tar tf archive
 )"
-echo append01.at:34 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir posix
-(cd posix
-TEST_TAR_FORMAT=posix
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H posix"
-export TAR_OPTIONS
-rm -rf *
-
-mkdir This_is_a_very_long_file_name_prefix_that_is_designed_to_cause_problems_with_appending_long_file_names_that_run_into_a_limit_of_the_ustar_tarX
-touch This_is_a_very_long_file_name_prefix_that_is_designed_to_cause_problems_with_appending_long_file_names_that_run_into_a_limit_of_the_ustar_tarX/file1 This_is_a_very_long_file_name_prefix_that_is_designed_to_cause_problems_with_appending_long_file_names_that_run_into_a_limit_of_the_ustar_tarX/file2
-tar cf archive This_is_a_very_long_file_name_prefix_that_is_designed_to_cause_problems_with_appending_long_file_names_that_run_into_a_limit_of_the_ustar_tarX/file1
-tar rf archive This_is_a_very_long_file_name_prefix_that_is_designed_to_cause_problems_with_appending_long_file_names_that_run_into_a_limit_of_the_ustar_tarX/file2
-tar tf archive
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'an embedded newline' "append01.at:34"
+( $at_check_trace;
 mkdir posix
 (cd posix
 TEST_TAR_FORMAT=posix
@@ -4136,21 +3630,20 @@ touch This_is_a_very_long_file_name_pref
 tar cf archive This_is_a_very_long_file_name_prefix_that_is_designed_to_cause_problems_with_appending_long_file_names_that_run_into_a_limit_of_the_ustar_tarX/file1
 tar rf archive This_is_a_very_long_file_name_prefix_that_is_designed_to_cause_problems_with_appending_long_file_names_that_run_into_a_limit_of_the_ustar_tarX/file2
 tar tf archive
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "This_is_a_very_long_file_name_prefix_that_is_designed_to_cause_problems_with_appending_long_file_names_that_run_into_a_limit_of_the_ustar_tarX/file1
 This_is_a_very_long_file_name_prefix_that_is_designed_to_cause_problems_with_appending_long_file_names_that_run_into_a_limit_of_the_ustar_tarX/file2
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/append01.at:34"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/append01.at:34"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/append01.at:34:
 mkdir gnu
 (cd gnu
@@ -4166,28 +3659,8 @@ tar cf archive This_is_a_very_long_file_
 tar rf archive This_is_a_very_long_file_name_prefix_that_is_designed_to_cause_problems_with_appending_long_file_names_that_run_into_a_limit_of_the_ustar_tarX/file2
 tar tf archive
 )"
-echo append01.at:34 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir gnu
-(cd gnu
-TEST_TAR_FORMAT=gnu
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H gnu"
-export TAR_OPTIONS
-rm -rf *
-
-mkdir This_is_a_very_long_file_name_prefix_that_is_designed_to_cause_problems_with_appending_long_file_names_that_run_into_a_limit_of_the_ustar_tarX
-touch This_is_a_very_long_file_name_prefix_that_is_designed_to_cause_problems_with_appending_long_file_names_that_run_into_a_limit_of_the_ustar_tarX/file1 This_is_a_very_long_file_name_prefix_that_is_designed_to_cause_problems_with_appending_long_file_names_that_run_into_a_limit_of_the_ustar_tarX/file2
-tar cf archive This_is_a_very_long_file_name_prefix_that_is_designed_to_cause_problems_with_appending_long_file_names_that_run_into_a_limit_of_the_ustar_tarX/file1
-tar rf archive This_is_a_very_long_file_name_prefix_that_is_designed_to_cause_problems_with_appending_long_file_names_that_run_into_a_limit_of_the_ustar_tarX/file2
-tar tf archive
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'an embedded newline' "append01.at:34"
+( $at_check_trace;
 mkdir gnu
 (cd gnu
 TEST_TAR_FORMAT=gnu
@@ -4201,45 +3674,41 @@ touch This_is_a_very_long_file_name_pref
 tar cf archive This_is_a_very_long_file_name_prefix_that_is_designed_to_cause_problems_with_appending_long_file_names_that_run_into_a_limit_of_the_ustar_tarX/file1
 tar rf archive This_is_a_very_long_file_name_prefix_that_is_designed_to_cause_problems_with_appending_long_file_names_that_run_into_a_limit_of_the_ustar_tarX/file2
 tar tf archive
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "This_is_a_very_long_file_name_prefix_that_is_designed_to_cause_problems_with_appending_long_file_names_that_run_into_a_limit_of_the_ustar_tarX/file1
 This_is_a_very_long_file_name_prefix_that_is_designed_to_cause_problems_with_appending_long_file_names_that_run_into_a_limit_of_the_ustar_tarX/file2
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/append01.at:34"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/append01.at:34"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
 
 
 
-  $at_traceoff
+  set +x
   $at_times_p && times >"$at_times_file"
-) 5>&1 2>&1 | eval $at_tee_pipe
-at_status=`cat "$at_status_file"`
+) 5>&1 2>&1 7>&- | eval $at_tee_pipe
+read at_status <"$at_status_file"
 #AT_STOP_10
 #AT_START_11
-# 11. append02.at:54: append vs. create
-at_setup_line='append02.at:54'
-at_desc="append vs. create"
-$at_quiet $as_echo_n " 11: $at_desc                              "
+at_fn_group_banner 11 'append02.at:54' \
+  "append vs. create" "                              "
 at_xfail=no
       test -f $XFAILFILE && at_xfail=yes
-echo "#                             -*- compilation -*-" >> "$at_group_log"
 (
-  $as_echo "11. append02.at:54: testing ..."
+  $as_echo "11. $at_setup_line: testing $at_desc ..."
   $at_traceon
 
 
 
 
 
-  { $at_traceoff
+  { set +x
 $as_echo "$at_srcdir/append02.at:57:
 mkdir v7
 (cd v7
@@ -4272,11 +3741,8 @@ tar \$MTIME -rf archive.2 file2
 echo Comparing archives
 cmp archive.1 archive.2
 )"
-echo append02.at:57 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
+at_fn_check_prepare_notrace 'an embedded newline' "append02.at:57"
+( $at_check_trace;
 mkdir v7
 (cd v7
 TEST_TAR_FORMAT=v7
@@ -4307,15 +3773,27 @@ tar $MTIME -rf archive.2 file2
 
 echo Comparing archives
 cmp archive.1 archive.2
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
-mkdir v7
-(cd v7
-TEST_TAR_FORMAT=v7
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
+echo >>"$at_stdout"; $as_echo "Creating archive.1
+Creating archive.2
+Comparing archives
+" | \
+  $at_diff - "$at_stdout" || at_failed=:
+at_fn_check_status 0 $at_status "$at_srcdir/append02.at:57"
+$at_failed && at_fn_log_failure
+$at_traceon; }
+
+              { set +x
+$as_echo "$at_srcdir/append02.at:57:
+mkdir oldgnu
+(cd oldgnu
+TEST_TAR_FORMAT=oldgnu
 export TEST_TAR_FORMAT
-TAR_OPTIONS="-H v7"
+TAR_OPTIONS=\"-H oldgnu\"
 export TAR_OPTIONS
 rm -rf *
 
@@ -4323,63 +3801,16 @@ genfile --file file1
 genfile --file file2
 
 # Make sure file timestamps in the archive will not differ
-MTIME="--mtime=@0"
+MTIME=\"--mtime=@0\"
 
 # For PAX archives, we need to make sure extended header names are
 # reproducible and that their contents won't change with time
-if test $TEST_TAR_FORMAT = posix; then
-  TAR_OPTIONS="$TAR_OPTIONS --pax-option=exthdr.name=%d/PaxHeaders/%f,delete=mtime,delete=atime,delete=ctime"
+if test \$TEST_TAR_FORMAT = posix; then
+  TAR_OPTIONS=\"\$TAR_OPTIONS --pax-option=exthdr.name=%d/PaxHeaders/%f,delete=mtime,delete=atime,delete=ctime\"
 fi
 
 echo Creating archive.1
-tar $MTIME -cf archive.1 file1 file2
-
-echo Creating archive.2
-tar $MTIME -cf archive.2 -T /dev/null
-tar $MTIME -rf archive.2 file1
-tar $MTIME -rf archive.2 file2
-
-echo Comparing archives
-cmp archive.1 archive.2
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
-echo >>"$at_stdout"; $as_echo "Creating archive.1
-Creating archive.2
-Comparing archives
-" | \
-  $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/append02.at:57"
-
-$at_failed && at_func_log_failure
-$at_traceon; }
-
-              { $at_traceoff
-$as_echo "$at_srcdir/append02.at:57:
-mkdir oldgnu
-(cd oldgnu
-TEST_TAR_FORMAT=oldgnu
-export TEST_TAR_FORMAT
-TAR_OPTIONS=\"-H oldgnu\"
-export TAR_OPTIONS
-rm -rf *
-
-genfile --file file1
-genfile --file file2
-
-# Make sure file timestamps in the archive will not differ
-MTIME=\"--mtime=@0\"
-
-# For PAX archives, we need to make sure extended header names are
-# reproducible and that their contents won't change with time
-if test \$TEST_TAR_FORMAT = posix; then
-  TAR_OPTIONS=\"\$TAR_OPTIONS --pax-option=exthdr.name=%d/PaxHeaders/%f,delete=mtime,delete=atime,delete=ctime\"
-fi
-
-echo Creating archive.1
-tar \$MTIME -cf archive.1 file1 file2
+tar \$MTIME -cf archive.1 file1 file2
 
 echo Creating archive.2
 tar \$MTIME -cf archive.2 -T /dev/null
@@ -4389,45 +3820,8 @@ tar \$MTIME -rf archive.2 file2
 echo Comparing archives
 cmp archive.1 archive.2
 )"
-echo append02.at:57 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir oldgnu
-(cd oldgnu
-TEST_TAR_FORMAT=oldgnu
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H oldgnu"
-export TAR_OPTIONS
-rm -rf *
-
-genfile --file file1
-genfile --file file2
-
-# Make sure file timestamps in the archive will not differ
-MTIME="--mtime=@0"
-
-# For PAX archives, we need to make sure extended header names are
-# reproducible and that their contents won't change with time
-if test $TEST_TAR_FORMAT = posix; then
-  TAR_OPTIONS="$TAR_OPTIONS --pax-option=exthdr.name=%d/PaxHeaders/%f,delete=mtime,delete=atime,delete=ctime"
-fi
-
-echo Creating archive.1
-tar $MTIME -cf archive.1 file1 file2
-
-echo Creating archive.2
-tar $MTIME -cf archive.2 -T /dev/null
-tar $MTIME -rf archive.2 file1
-tar $MTIME -rf archive.2 file2
-
-echo Comparing archives
-cmp archive.1 archive.2
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'an embedded newline' "append02.at:57"
+( $at_check_trace;
 mkdir oldgnu
 (cd oldgnu
 TEST_TAR_FORMAT=oldgnu
@@ -4458,22 +3852,21 @@ tar $MTIME -rf archive.2 file2
 
 echo Comparing archives
 cmp archive.1 archive.2
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "Creating archive.1
 Creating archive.2
 Comparing archives
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/append02.at:57"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/append02.at:57"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/append02.at:57:
 mkdir ustar
 (cd ustar
@@ -4506,45 +3899,8 @@ tar \$MTIME -rf archive.2 file2
 echo Comparing archives
 cmp archive.1 archive.2
 )"
-echo append02.at:57 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir ustar
-(cd ustar
-TEST_TAR_FORMAT=ustar
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H ustar"
-export TAR_OPTIONS
-rm -rf *
-
-genfile --file file1
-genfile --file file2
-
-# Make sure file timestamps in the archive will not differ
-MTIME="--mtime=@0"
-
-# For PAX archives, we need to make sure extended header names are
-# reproducible and that their contents won't change with time
-if test $TEST_TAR_FORMAT = posix; then
-  TAR_OPTIONS="$TAR_OPTIONS --pax-option=exthdr.name=%d/PaxHeaders/%f,delete=mtime,delete=atime,delete=ctime"
-fi
-
-echo Creating archive.1
-tar $MTIME -cf archive.1 file1 file2
-
-echo Creating archive.2
-tar $MTIME -cf archive.2 -T /dev/null
-tar $MTIME -rf archive.2 file1
-tar $MTIME -rf archive.2 file2
-
-echo Comparing archives
-cmp archive.1 archive.2
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'an embedded newline' "append02.at:57"
+( $at_check_trace;
 mkdir ustar
 (cd ustar
 TEST_TAR_FORMAT=ustar
@@ -4575,22 +3931,21 @@ tar $MTIME -rf archive.2 file2
 
 echo Comparing archives
 cmp archive.1 archive.2
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "Creating archive.1
 Creating archive.2
 Comparing archives
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/append02.at:57"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/append02.at:57"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/append02.at:57:
 mkdir posix
 (cd posix
@@ -4623,45 +3978,8 @@ tar \$MTIME -rf archive.2 file2
 echo Comparing archives
 cmp archive.1 archive.2
 )"
-echo append02.at:57 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir posix
-(cd posix
-TEST_TAR_FORMAT=posix
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H posix"
-export TAR_OPTIONS
-rm -rf *
-
-genfile --file file1
-genfile --file file2
-
-# Make sure file timestamps in the archive will not differ
-MTIME="--mtime=@0"
-
-# For PAX archives, we need to make sure extended header names are
-# reproducible and that their contents won't change with time
-if test $TEST_TAR_FORMAT = posix; then
-  TAR_OPTIONS="$TAR_OPTIONS --pax-option=exthdr.name=%d/PaxHeaders/%f,delete=mtime,delete=atime,delete=ctime"
-fi
-
-echo Creating archive.1
-tar $MTIME -cf archive.1 file1 file2
-
-echo Creating archive.2
-tar $MTIME -cf archive.2 -T /dev/null
-tar $MTIME -rf archive.2 file1
-tar $MTIME -rf archive.2 file2
-
-echo Comparing archives
-cmp archive.1 archive.2
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'an embedded newline' "append02.at:57"
+( $at_check_trace;
 mkdir posix
 (cd posix
 TEST_TAR_FORMAT=posix
@@ -4692,22 +4010,21 @@ tar $MTIME -rf archive.2 file2
 
 echo Comparing archives
 cmp archive.1 archive.2
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "Creating archive.1
 Creating archive.2
 Comparing archives
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/append02.at:57"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/append02.at:57"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/append02.at:57:
 mkdir gnu
 (cd gnu
@@ -4740,45 +4057,8 @@ tar \$MTIME -rf archive.2 file2
 echo Comparing archives
 cmp archive.1 archive.2
 )"
-echo append02.at:57 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir gnu
-(cd gnu
-TEST_TAR_FORMAT=gnu
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H gnu"
-export TAR_OPTIONS
-rm -rf *
-
-genfile --file file1
-genfile --file file2
-
-# Make sure file timestamps in the archive will not differ
-MTIME="--mtime=@0"
-
-# For PAX archives, we need to make sure extended header names are
-# reproducible and that their contents won't change with time
-if test $TEST_TAR_FORMAT = posix; then
-  TAR_OPTIONS="$TAR_OPTIONS --pax-option=exthdr.name=%d/PaxHeaders/%f,delete=mtime,delete=atime,delete=ctime"
-fi
-
-echo Creating archive.1
-tar $MTIME -cf archive.1 file1 file2
-
-echo Creating archive.2
-tar $MTIME -cf archive.2 -T /dev/null
-tar $MTIME -rf archive.2 file1
-tar $MTIME -rf archive.2 file2
-
-echo Comparing archives
-cmp archive.1 archive.2
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'an embedded newline' "append02.at:57"
+( $at_check_trace;
 mkdir gnu
 (cd gnu
 TEST_TAR_FORMAT=gnu
@@ -4809,39 +4089,35 @@ tar $MTIME -rf archive.2 file2
 
 echo Comparing archives
 cmp archive.1 archive.2
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "Creating archive.1
 Creating archive.2
 Comparing archives
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/append02.at:57"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/append02.at:57"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
 
 
 
-  $at_traceoff
+  set +x
   $at_times_p && times >"$at_times_file"
-) 5>&1 2>&1 | eval $at_tee_pipe
-at_status=`cat "$at_status_file"`
+) 5>&1 2>&1 7>&- | eval $at_tee_pipe
+read at_status <"$at_status_file"
 #AT_STOP_11
 #AT_START_12
-# 12. append03.at:19: append with name transformation
-at_setup_line='append03.at:19'
-at_desc="append with name transformation"
-$at_quiet $as_echo_n " 12: $at_desc                "
+at_fn_group_banner 12 'append03.at:19' \
+  "append with name transformation" "                "
 at_xfail=no
       test -f $XFAILFILE && at_xfail=yes
-echo "#                             -*- compilation -*-" >> "$at_group_log"
 (
-  $as_echo "12. append03.at:19: testing ..."
+  $as_echo "12. $at_setup_line: testing $at_desc ..."
   $at_traceon
 
 
@@ -4850,7 +4126,7 @@ echo "#                             -*-
 
 
 
-  { $at_traceoff
+  { set +x
 $as_echo "$at_srcdir/append03.at:24:
 mkdir v7
 (cd v7
@@ -4869,31 +4145,8 @@ tar -r -f archive --transform 's/file/pl
 echo Testing
 tar tf archive
 )"
-echo append03.at:24 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir v7
-(cd v7
-TEST_TAR_FORMAT=v7
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H v7"
-export TAR_OPTIONS
-rm -rf *
-
-genfile --file file.1
-genfile --file file.2
-
-tar -c -f archive --transform 's/file/plik/' file.*
-echo Appending
-tar -r -f archive --transform 's/file/plik/' -v --show-transformed-names file.1
-echo Testing
-tar tf archive
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'an embedded newline' "append03.at:24"
+( $at_check_trace;
 mkdir v7
 (cd v7
 TEST_TAR_FORMAT=v7
@@ -4910,11 +4163,11 @@ echo Appending
 tar -r -f archive --transform 's/file/plik/' -v --show-transformed-names file.1
 echo Testing
 tar tf archive
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "Appending
 plik.1
 Testing
@@ -4923,12 +4176,11 @@ plik.2
 plik.1
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/append03.at:24"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/append03.at:24"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/append03.at:24:
 mkdir oldgnu
 (cd oldgnu
@@ -4947,31 +4199,8 @@ tar -r -f archive --transform 's/file/pl
 echo Testing
 tar tf archive
 )"
-echo append03.at:24 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir oldgnu
-(cd oldgnu
-TEST_TAR_FORMAT=oldgnu
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H oldgnu"
-export TAR_OPTIONS
-rm -rf *
-
-genfile --file file.1
-genfile --file file.2
-
-tar -c -f archive --transform 's/file/plik/' file.*
-echo Appending
-tar -r -f archive --transform 's/file/plik/' -v --show-transformed-names file.1
-echo Testing
-tar tf archive
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'an embedded newline' "append03.at:24"
+( $at_check_trace;
 mkdir oldgnu
 (cd oldgnu
 TEST_TAR_FORMAT=oldgnu
@@ -4988,11 +4217,11 @@ echo Appending
 tar -r -f archive --transform 's/file/plik/' -v --show-transformed-names file.1
 echo Testing
 tar tf archive
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "Appending
 plik.1
 Testing
@@ -5001,12 +4230,11 @@ plik.2
 plik.1
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/append03.at:24"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/append03.at:24"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/append03.at:24:
 mkdir ustar
 (cd ustar
@@ -5025,31 +4253,8 @@ tar -r -f archive --transform 's/file/pl
 echo Testing
 tar tf archive
 )"
-echo append03.at:24 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir ustar
-(cd ustar
-TEST_TAR_FORMAT=ustar
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H ustar"
-export TAR_OPTIONS
-rm -rf *
-
-genfile --file file.1
-genfile --file file.2
-
-tar -c -f archive --transform 's/file/plik/' file.*
-echo Appending
-tar -r -f archive --transform 's/file/plik/' -v --show-transformed-names file.1
-echo Testing
-tar tf archive
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'an embedded newline' "append03.at:24"
+( $at_check_trace;
 mkdir ustar
 (cd ustar
 TEST_TAR_FORMAT=ustar
@@ -5066,11 +4271,11 @@ echo Appending
 tar -r -f archive --transform 's/file/plik/' -v --show-transformed-names file.1
 echo Testing
 tar tf archive
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "Appending
 plik.1
 Testing
@@ -5079,12 +4284,11 @@ plik.2
 plik.1
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/append03.at:24"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/append03.at:24"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/append03.at:24:
 mkdir posix
 (cd posix
@@ -5103,31 +4307,8 @@ tar -r -f archive --transform 's/file/pl
 echo Testing
 tar tf archive
 )"
-echo append03.at:24 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir posix
-(cd posix
-TEST_TAR_FORMAT=posix
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H posix"
-export TAR_OPTIONS
-rm -rf *
-
-genfile --file file.1
-genfile --file file.2
-
-tar -c -f archive --transform 's/file/plik/' file.*
-echo Appending
-tar -r -f archive --transform 's/file/plik/' -v --show-transformed-names file.1
-echo Testing
-tar tf archive
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'an embedded newline' "append03.at:24"
+( $at_check_trace;
 mkdir posix
 (cd posix
 TEST_TAR_FORMAT=posix
@@ -5144,11 +4325,11 @@ echo Appending
 tar -r -f archive --transform 's/file/plik/' -v --show-transformed-names file.1
 echo Testing
 tar tf archive
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "Appending
 plik.1
 Testing
@@ -5157,12 +4338,11 @@ plik.2
 plik.1
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/append03.at:24"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/append03.at:24"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/append03.at:24:
 mkdir gnu
 (cd gnu
@@ -5181,11 +4361,8 @@ tar -r -f archive --transform 's/file/pl
 echo Testing
 tar tf archive
 )"
-echo append03.at:24 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
+at_fn_check_prepare_notrace 'an embedded newline' "append03.at:24"
+( $at_check_trace;
 mkdir gnu
 (cd gnu
 TEST_TAR_FORMAT=gnu
@@ -5202,31 +4379,11 @@ echo Appending
 tar -r -f archive --transform 's/file/plik/' -v --show-transformed-names file.1
 echo Testing
 tar tf archive
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
-mkdir gnu
-(cd gnu
-TEST_TAR_FORMAT=gnu
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H gnu"
-export TAR_OPTIONS
-rm -rf *
-
-genfile --file file.1
-genfile --file file.2
-
-tar -c -f archive --transform 's/file/plik/' file.*
-echo Appending
-tar -r -f archive --transform 's/file/plik/' -v --show-transformed-names file.1
-echo Testing
-tar tf archive
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "Appending
 plik.1
 Testing
@@ -5235,29 +4392,25 @@ plik.2
 plik.1
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/append03.at:24"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/append03.at:24"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
 
 
 
-  $at_traceoff
+  set +x
   $at_times_p && times >"$at_times_file"
-) 5>&1 2>&1 | eval $at_tee_pipe
-at_status=`cat "$at_status_file"`
+) 5>&1 2>&1 7>&- | eval $at_tee_pipe
+read at_status <"$at_status_file"
 #AT_STOP_12
 #AT_START_13
-# 13. xform-h.at:30: transforming hard links on create
-at_setup_line='xform-h.at:30'
-at_desc="transforming hard links on create"
-$at_quiet $as_echo_n " 13: $at_desc              "
+at_fn_group_banner 13 'xform-h.at:30' \
+  "transforming hard links on create" "              "
 at_xfail=no
       test -f $XFAILFILE && at_xfail=yes
-echo "#                             -*- compilation -*-" >> "$at_group_log"
 (
-  $as_echo "13. xform-h.at:30: testing ..."
+  $as_echo "13. $at_setup_line: testing $at_desc ..."
   $at_traceon
 
 
@@ -5266,7 +4419,7 @@ echo "#                             -*-
 
 
 
-  { $at_traceoff
+  { set +x
 $as_echo "$at_srcdir/xform-h.at:39:
 mkdir v7
 (cd v7
@@ -5281,57 +4434,23 @@ echo \"hello\" > basedir/test
 ln basedir/test basedir/test_link
 
 
-echo "Default transform scope"
-tar cf archive --transform="s,^basedir/,," basedir/test basedir/test_link
+echo \"Default transform scope\"
+tar cf archive --transform=\"s,^basedir/,,\" basedir/test basedir/test_link
 tar tvf archive | sed -n 's/.*test_link link to //p'
 
 
-echo "Transforming hard links"
-tar cf archive --transform="s,^basedir/,,h" basedir/test basedir/test_link
+echo \"Transforming hard links\"
+tar cf archive --transform=\"s,^basedir/,,h\" basedir/test basedir/test_link
 tar tvf archive | sed -n 's/.*test_link link to //p'
 
 
-echo "Not transforming hard links"
-tar cf archive --transform="s,^basedir/,,H" basedir/test basedir/test_link
+echo \"Not transforming hard links\"
+tar cf archive --transform=\"s,^basedir/,,H\" basedir/test basedir/test_link
 tar tvf archive | sed -n 's/.*test_link link to //p'
 
 )"
-echo xform-h.at:39 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir v7
-(cd v7
-TEST_TAR_FORMAT=v7
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H v7"
-export TAR_OPTIONS
-rm -rf *
-
-mkdir basedir
-echo "hello" > basedir/test
-ln basedir/test basedir/test_link
-
-
-echo "Default transform scope"
-tar cf archive --transform="s,^basedir/,," basedir/test basedir/test_link
-tar tvf archive | sed -n 's/.*test_link link to //p'
-
-
-echo "Transforming hard links"
-tar cf archive --transform="s,^basedir/,,h" basedir/test basedir/test_link
-tar tvf archive | sed -n 's/.*test_link link to //p'
-
-
-echo "Not transforming hard links"
-tar cf archive --transform="s,^basedir/,,H" basedir/test basedir/test_link
-tar tvf archive | sed -n 's/.*test_link link to //p'
-
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'an embedded newline' "xform-h.at:39"
+( $at_check_trace;
 mkdir v7
 (cd v7
 TEST_TAR_FORMAT=v7
@@ -5359,11 +4478,11 @@ echo "Not transforming hard links"
 tar cf archive --transform="s,^basedir/,,H" basedir/test basedir/test_link
 tar tvf archive | sed -n 's/.*test_link link to //p'
 
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "Default transform scope
 test
 Transforming hard links
@@ -5372,12 +4491,11 @@ Not transforming hard links
 basedir/test
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/xform-h.at:39"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/xform-h.at:39"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/xform-h.at:39:
 mkdir oldgnu
 (cd oldgnu
@@ -5392,57 +4510,23 @@ echo \"hello\" > basedir/test
 ln basedir/test basedir/test_link
 
 
-echo "Default transform scope"
-tar cf archive --transform="s,^basedir/,," basedir/test basedir/test_link
+echo \"Default transform scope\"
+tar cf archive --transform=\"s,^basedir/,,\" basedir/test basedir/test_link
 tar tvf archive | sed -n 's/.*test_link link to //p'
 
 
-echo "Transforming hard links"
-tar cf archive --transform="s,^basedir/,,h" basedir/test basedir/test_link
+echo \"Transforming hard links\"
+tar cf archive --transform=\"s,^basedir/,,h\" basedir/test basedir/test_link
 tar tvf archive | sed -n 's/.*test_link link to //p'
 
 
-echo "Not transforming hard links"
-tar cf archive --transform="s,^basedir/,,H" basedir/test basedir/test_link
+echo \"Not transforming hard links\"
+tar cf archive --transform=\"s,^basedir/,,H\" basedir/test basedir/test_link
 tar tvf archive | sed -n 's/.*test_link link to //p'
 
 )"
-echo xform-h.at:39 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir oldgnu
-(cd oldgnu
-TEST_TAR_FORMAT=oldgnu
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H oldgnu"
-export TAR_OPTIONS
-rm -rf *
-
-mkdir basedir
-echo "hello" > basedir/test
-ln basedir/test basedir/test_link
-
-
-echo "Default transform scope"
-tar cf archive --transform="s,^basedir/,," basedir/test basedir/test_link
-tar tvf archive | sed -n 's/.*test_link link to //p'
-
-
-echo "Transforming hard links"
-tar cf archive --transform="s,^basedir/,,h" basedir/test basedir/test_link
-tar tvf archive | sed -n 's/.*test_link link to //p'
-
-
-echo "Not transforming hard links"
-tar cf archive --transform="s,^basedir/,,H" basedir/test basedir/test_link
-tar tvf archive | sed -n 's/.*test_link link to //p'
-
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'an embedded newline' "xform-h.at:39"
+( $at_check_trace;
 mkdir oldgnu
 (cd oldgnu
 TEST_TAR_FORMAT=oldgnu
@@ -5470,11 +4554,11 @@ echo "Not transforming hard links"
 tar cf archive --transform="s,^basedir/,,H" basedir/test basedir/test_link
 tar tvf archive | sed -n 's/.*test_link link to //p'
 
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "Default transform scope
 test
 Transforming hard links
@@ -5483,12 +4567,11 @@ Not transforming hard links
 basedir/test
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/xform-h.at:39"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/xform-h.at:39"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/xform-h.at:39:
 mkdir ustar
 (cd ustar
@@ -5503,57 +4586,23 @@ echo \"hello\" > basedir/test
 ln basedir/test basedir/test_link
 
 
-echo "Default transform scope"
-tar cf archive --transform="s,^basedir/,," basedir/test basedir/test_link
+echo \"Default transform scope\"
+tar cf archive --transform=\"s,^basedir/,,\" basedir/test basedir/test_link
 tar tvf archive | sed -n 's/.*test_link link to //p'
 
 
-echo "Transforming hard links"
-tar cf archive --transform="s,^basedir/,,h" basedir/test basedir/test_link
+echo \"Transforming hard links\"
+tar cf archive --transform=\"s,^basedir/,,h\" basedir/test basedir/test_link
 tar tvf archive | sed -n 's/.*test_link link to //p'
 
 
-echo "Not transforming hard links"
-tar cf archive --transform="s,^basedir/,,H" basedir/test basedir/test_link
+echo \"Not transforming hard links\"
+tar cf archive --transform=\"s,^basedir/,,H\" basedir/test basedir/test_link
 tar tvf archive | sed -n 's/.*test_link link to //p'
 
 )"
-echo xform-h.at:39 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir ustar
-(cd ustar
-TEST_TAR_FORMAT=ustar
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H ustar"
-export TAR_OPTIONS
-rm -rf *
-
-mkdir basedir
-echo "hello" > basedir/test
-ln basedir/test basedir/test_link
-
-
-echo "Default transform scope"
-tar cf archive --transform="s,^basedir/,," basedir/test basedir/test_link
-tar tvf archive | sed -n 's/.*test_link link to //p'
-
-
-echo "Transforming hard links"
-tar cf archive --transform="s,^basedir/,,h" basedir/test basedir/test_link
-tar tvf archive | sed -n 's/.*test_link link to //p'
-
-
-echo "Not transforming hard links"
-tar cf archive --transform="s,^basedir/,,H" basedir/test basedir/test_link
-tar tvf archive | sed -n 's/.*test_link link to //p'
-
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'an embedded newline' "xform-h.at:39"
+( $at_check_trace;
 mkdir ustar
 (cd ustar
 TEST_TAR_FORMAT=ustar
@@ -5581,11 +4630,11 @@ echo "Not transforming hard links"
 tar cf archive --transform="s,^basedir/,,H" basedir/test basedir/test_link
 tar tvf archive | sed -n 's/.*test_link link to //p'
 
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "Default transform scope
 test
 Transforming hard links
@@ -5594,12 +4643,11 @@ Not transforming hard links
 basedir/test
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/xform-h.at:39"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/xform-h.at:39"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/xform-h.at:39:
 mkdir posix
 (cd posix
@@ -5614,57 +4662,23 @@ echo \"hello\" > basedir/test
 ln basedir/test basedir/test_link
 
 
-echo "Default transform scope"
-tar cf archive --transform="s,^basedir/,," basedir/test basedir/test_link
+echo \"Default transform scope\"
+tar cf archive --transform=\"s,^basedir/,,\" basedir/test basedir/test_link
 tar tvf archive | sed -n 's/.*test_link link to //p'
 
 
-echo "Transforming hard links"
-tar cf archive --transform="s,^basedir/,,h" basedir/test basedir/test_link
+echo \"Transforming hard links\"
+tar cf archive --transform=\"s,^basedir/,,h\" basedir/test basedir/test_link
 tar tvf archive | sed -n 's/.*test_link link to //p'
 
 
-echo "Not transforming hard links"
-tar cf archive --transform="s,^basedir/,,H" basedir/test basedir/test_link
+echo \"Not transforming hard links\"
+tar cf archive --transform=\"s,^basedir/,,H\" basedir/test basedir/test_link
 tar tvf archive | sed -n 's/.*test_link link to //p'
 
 )"
-echo xform-h.at:39 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir posix
-(cd posix
-TEST_TAR_FORMAT=posix
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H posix"
-export TAR_OPTIONS
-rm -rf *
-
-mkdir basedir
-echo "hello" > basedir/test
-ln basedir/test basedir/test_link
-
-
-echo "Default transform scope"
-tar cf archive --transform="s,^basedir/,," basedir/test basedir/test_link
-tar tvf archive | sed -n 's/.*test_link link to //p'
-
-
-echo "Transforming hard links"
-tar cf archive --transform="s,^basedir/,,h" basedir/test basedir/test_link
-tar tvf archive | sed -n 's/.*test_link link to //p'
-
-
-echo "Not transforming hard links"
-tar cf archive --transform="s,^basedir/,,H" basedir/test basedir/test_link
-tar tvf archive | sed -n 's/.*test_link link to //p'
-
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'an embedded newline' "xform-h.at:39"
+( $at_check_trace;
 mkdir posix
 (cd posix
 TEST_TAR_FORMAT=posix
@@ -5692,11 +4706,11 @@ echo "Not transforming hard links"
 tar cf archive --transform="s,^basedir/,,H" basedir/test basedir/test_link
 tar tvf archive | sed -n 's/.*test_link link to //p'
 
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "Default transform scope
 test
 Transforming hard links
@@ -5705,12 +4719,11 @@ Not transforming hard links
 basedir/test
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/xform-h.at:39"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/xform-h.at:39"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/xform-h.at:39:
 mkdir gnu
 (cd gnu
@@ -5725,57 +4738,23 @@ echo \"hello\" > basedir/test
 ln basedir/test basedir/test_link
 
 
-echo "Default transform scope"
-tar cf archive --transform="s,^basedir/,," basedir/test basedir/test_link
+echo \"Default transform scope\"
+tar cf archive --transform=\"s,^basedir/,,\" basedir/test basedir/test_link
 tar tvf archive | sed -n 's/.*test_link link to //p'
 
 
-echo "Transforming hard links"
-tar cf archive --transform="s,^basedir/,,h" basedir/test basedir/test_link
+echo \"Transforming hard links\"
+tar cf archive --transform=\"s,^basedir/,,h\" basedir/test basedir/test_link
 tar tvf archive | sed -n 's/.*test_link link to //p'
 
 
-echo "Not transforming hard links"
-tar cf archive --transform="s,^basedir/,,H" basedir/test basedir/test_link
+echo \"Not transforming hard links\"
+tar cf archive --transform=\"s,^basedir/,,H\" basedir/test basedir/test_link
 tar tvf archive | sed -n 's/.*test_link link to //p'
 
 )"
-echo xform-h.at:39 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir gnu
-(cd gnu
-TEST_TAR_FORMAT=gnu
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H gnu"
-export TAR_OPTIONS
-rm -rf *
-
-mkdir basedir
-echo "hello" > basedir/test
-ln basedir/test basedir/test_link
-
-
-echo "Default transform scope"
-tar cf archive --transform="s,^basedir/,," basedir/test basedir/test_link
-tar tvf archive | sed -n 's/.*test_link link to //p'
-
-
-echo "Transforming hard links"
-tar cf archive --transform="s,^basedir/,,h" basedir/test basedir/test_link
-tar tvf archive | sed -n 's/.*test_link link to //p'
-
-
-echo "Not transforming hard links"
-tar cf archive --transform="s,^basedir/,,H" basedir/test basedir/test_link
-tar tvf archive | sed -n 's/.*test_link link to //p'
-
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'an embedded newline' "xform-h.at:39"
+( $at_check_trace;
 mkdir gnu
 (cd gnu
 TEST_TAR_FORMAT=gnu
@@ -5803,11 +4782,11 @@ echo "Not transforming hard links"
 tar cf archive --transform="s,^basedir/,,H" basedir/test basedir/test_link
 tar tvf archive | sed -n 's/.*test_link link to //p'
 
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "Default transform scope
 test
 Transforming hard links
@@ -5816,9 +4795,8 @@ Not transforming hard links
 basedir/test
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/xform-h.at:39"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/xform-h.at:39"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
 
@@ -5826,28 +4804,25 @@ $at_traceon; }
 
 
 
-  $at_traceoff
+  set +x
   $at_times_p && times >"$at_times_file"
-) 5>&1 2>&1 | eval $at_tee_pipe
-at_status=`cat "$at_status_file"`
+) 5>&1 2>&1 7>&- | eval $at_tee_pipe
+read at_status <"$at_status_file"
 #AT_STOP_13
 #AT_START_14
-# 14. xform01.at:26: transformations and GNU volume labels
-at_setup_line='xform01.at:26'
-at_desc="transformations and GNU volume labels"
-$at_quiet $as_echo_n " 14: $at_desc          "
+at_fn_group_banner 14 'xform01.at:26' \
+  "transformations and GNU volume labels" "          "
 at_xfail=no
       test -f $XFAILFILE && at_xfail=yes
-echo "#                             -*- compilation -*-" >> "$at_group_log"
 (
-  $as_echo "14. xform01.at:26: testing ..."
+  $as_echo "14. $at_setup_line: testing $at_desc ..."
   $at_traceon
 
 
 
 
 
-  { $at_traceoff
+  { set +x
 $as_echo "$at_srcdir/xform01.at:29:
 mkdir gnu
 (cd gnu
@@ -5861,26 +4836,8 @@ genfile --file file
 tar -cf archive.tar -V /label/ file
 tar tf archive.tar
 )"
-echo xform01.at:29 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir gnu
-(cd gnu
-TEST_TAR_FORMAT=gnu
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H gnu"
-export TAR_OPTIONS
-rm -rf *
-
-genfile --file file
-tar -cf archive.tar -V /label/ file
-tar tf archive.tar
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'an embedded newline' "xform01.at:29"
+( $at_check_trace;
 mkdir gnu
 (cd gnu
 TEST_TAR_FORMAT=gnu
@@ -5892,45 +4849,41 @@ rm -rf *
 genfile --file file
 tar -cf archive.tar -V /label/ file
 tar tf archive.tar
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "/label/
 file
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/xform01.at:29"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/xform01.at:29"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
 
 
 
-  $at_traceoff
+  set +x
   $at_times_p && times >"$at_times_file"
-) 5>&1 2>&1 | eval $at_tee_pipe
-at_status=`cat "$at_status_file"`
+) 5>&1 2>&1 7>&- | eval $at_tee_pipe
+read at_status <"$at_status_file"
 #AT_STOP_14
 #AT_START_15
-# 15. exclude.at:23: exclude
-at_setup_line='exclude.at:23'
-at_desc="exclude"
-$at_quiet $as_echo_n " 15: $at_desc                                        "
+at_fn_group_banner 15 'exclude.at:23' \
+  "exclude" "                                        "
 at_xfail=no
       test -f $XFAILFILE && at_xfail=yes
-echo "#                             -*- compilation -*-" >> "$at_group_log"
 (
-  $as_echo "15. exclude.at:23: testing ..."
+  $as_echo "15. $at_setup_line: testing $at_desc ..."
   $at_traceon
 
 
 
 
 
-  { $at_traceoff
+  { set +x
 $as_echo "$at_srcdir/exclude.at:26:
 mkdir ustar
 (cd ustar
@@ -5941,7 +4894,7 @@ export TAR_OPTIONS
 rm -rf *
 
 
-test -z "`sort < /dev/null 2>&1`" || exit 77
+test -z \"\`sort < /dev/null 2>&1\`\" || exit 77
 
 
 mkdir dir
@@ -5972,11 +4925,8 @@ do
   tar tf archive.tar | sort
 done
 )"
-echo exclude.at:26 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains a ${...} parameter expansion)'
-   false; }; then
-  ( $at_traceon;
+at_fn_check_prepare_notrace 'a `...` command substitution' "exclude.at:26"
+( $at_check_trace;
 mkdir ustar
 (cd ustar
 TEST_TAR_FORMAT=ustar
@@ -6016,54 +4966,11 @@ do
   echo ARCHIVE
   tar tf archive.tar | sort
 done
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
-mkdir ustar
-(cd ustar
-TEST_TAR_FORMAT=ustar
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H ustar"
-export TAR_OPTIONS
-rm -rf *
-
-
-test -z "`sort < /dev/null 2>&1`" || exit 77
-
-
-mkdir dir
-echo blues > dir/blues
-echo jazz > dir/jazz
-mkdir dir/folk
-echo tagfile > dir/folk/tagfile
-echo sanjuan > dir/folk/sanjuan
-mkdir dir/rock
-echo "Signature: 8a477f597d28d172789f06886806bc55" > dir/rock/CACHEDIR.TAG
-echo "test" > dir/rock/file
-
-for option in exclude-caches exclude-caches-under exclude-caches-all
-do
-  echo OPTION $option
-  tar -cf archive.tar --$option -v dir 2>err | sort
-  cat err
-  echo ARCHIVE
-  tar tf archive.tar | sort
-done
-
-for option in exclude-tag exclude-tag-under exclude-tag-all
-do
-  echo OPTION $option
-  tar -cf archive.tar --${option}=tagfile -v dir 2>err | sort
-  cat err
-  echo ARCHIVE
-  tar tf archive.tar | sort
-done
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "OPTION exclude-caches
 dir/
 dir/blues
@@ -6168,36 +5075,32 @@ dir/rock/CACHEDIR.TAG
 dir/rock/file
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/exclude.at:26"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/exclude.at:26"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
 
 
 
-  $at_traceoff
+  set +x
   $at_times_p && times >"$at_times_file"
-) 5>&1 2>&1 | eval $at_tee_pipe
-at_status=`cat "$at_status_file"`
+) 5>&1 2>&1 7>&- | eval $at_tee_pipe
+read at_status <"$at_status_file"
 #AT_STOP_15
 #AT_START_16
-# 16. exclude01.at:17: exclude wildcards
-at_setup_line='exclude01.at:17'
-at_desc="exclude wildcards"
-$at_quiet $as_echo_n " 16: $at_desc                              "
+at_fn_group_banner 16 'exclude01.at:17' \
+  "exclude wildcards" "                              "
 at_xfail=no
       test -f $XFAILFILE && at_xfail=yes
-echo "#                             -*- compilation -*-" >> "$at_group_log"
 (
-  $as_echo "16. exclude01.at:17: testing ..."
+  $as_echo "16. $at_setup_line: testing $at_desc ..."
   $at_traceon
 
 
 
 
 
-  { $at_traceoff
+  { set +x
 $as_echo "$at_srcdir/exclude01.at:20:
 mkdir v7
 (cd v7
@@ -6208,7 +5111,7 @@ export TAR_OPTIONS
 rm -rf *
 
 
-test -z "`sort < /dev/null 2>&1`" || exit 77
+test -z \"\`sort < /dev/null 2>&1\`\" || exit 77
 
 
 rm -rf testdir
@@ -6242,57 +5145,8 @@ tar t --wildcards \"testdir/dir1/*\" -f
 
 rm -rf testdir
 )"
-echo exclude01.at:20 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir v7
-(cd v7
-TEST_TAR_FORMAT=v7
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H v7"
-export TAR_OPTIONS
-rm -rf *
-
-
-test -z "`sort < /dev/null 2>&1`" || exit 77
-
-
-rm -rf testdir
-mkdir -p testdir/dir1 testdir/dir2 testdir/dir3
-touch testdir/dir1/file1
-touch testdir/dir1/\*
-touch testdir/dir2/file2
-touch testdir/dir2/\*
-touch testdir/dir3/file3
-touch testdir/dir3/\*
-
-tar cf archive --exclude=testdir/dir1/\* \
-               --no-wildcards \
-               --exclude=testdir/dir2/\* \
-               --wildcards \
-               --exclude=testdir/dir3/\* \
-               testdir
-tar tf archive | sort
-
-echo "NEXT"
-tar cf archive testdir
-tar t "testdir/dir1/*" -f archive | sort
-
-echo "NEXT"
-tar cf archive testdir/dir1
-tar t --no-wildcards "testdir/dir1/*" -f archive | sort
-
-echo "NEXT"
-tar cf archive testdir
-tar t --wildcards "testdir/dir1/*" -f archive | sort
-
-rm -rf testdir
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'a `...` command substitution' "exclude01.at:20"
+( $at_check_trace;
 mkdir v7
 (cd v7
 TEST_TAR_FORMAT=v7
@@ -6335,11 +5189,11 @@ tar cf archive testdir
 tar t --wildcards "testdir/dir1/*" -f archive | sort
 
 rm -rf testdir
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "testdir/
 testdir/dir1/
 testdir/dir2/
@@ -6354,12 +5208,11 @@ testdir/dir1/*
 testdir/dir1/file1
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/exclude01.at:20"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/exclude01.at:20"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/exclude01.at:20:
 mkdir oldgnu
 (cd oldgnu
@@ -6370,7 +5223,7 @@ export TAR_OPTIONS
 rm -rf *
 
 
-test -z "`sort < /dev/null 2>&1`" || exit 77
+test -z \"\`sort < /dev/null 2>&1\`\" || exit 77
 
 
 rm -rf testdir
@@ -6404,57 +5257,8 @@ tar t --wildcards \"testdir/dir1/*\" -f
 
 rm -rf testdir
 )"
-echo exclude01.at:20 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir oldgnu
-(cd oldgnu
-TEST_TAR_FORMAT=oldgnu
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H oldgnu"
-export TAR_OPTIONS
-rm -rf *
-
-
-test -z "`sort < /dev/null 2>&1`" || exit 77
-
-
-rm -rf testdir
-mkdir -p testdir/dir1 testdir/dir2 testdir/dir3
-touch testdir/dir1/file1
-touch testdir/dir1/\*
-touch testdir/dir2/file2
-touch testdir/dir2/\*
-touch testdir/dir3/file3
-touch testdir/dir3/\*
-
-tar cf archive --exclude=testdir/dir1/\* \
-               --no-wildcards \
-               --exclude=testdir/dir2/\* \
-               --wildcards \
-               --exclude=testdir/dir3/\* \
-               testdir
-tar tf archive | sort
-
-echo "NEXT"
-tar cf archive testdir
-tar t "testdir/dir1/*" -f archive | sort
-
-echo "NEXT"
-tar cf archive testdir/dir1
-tar t --no-wildcards "testdir/dir1/*" -f archive | sort
-
-echo "NEXT"
-tar cf archive testdir
-tar t --wildcards "testdir/dir1/*" -f archive | sort
-
-rm -rf testdir
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'a `...` command substitution' "exclude01.at:20"
+( $at_check_trace;
 mkdir oldgnu
 (cd oldgnu
 TEST_TAR_FORMAT=oldgnu
@@ -6497,11 +5301,11 @@ tar cf archive testdir
 tar t --wildcards "testdir/dir1/*" -f archive | sort
 
 rm -rf testdir
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "testdir/
 testdir/dir1/
 testdir/dir2/
@@ -6516,12 +5320,11 @@ testdir/dir1/*
 testdir/dir1/file1
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/exclude01.at:20"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/exclude01.at:20"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/exclude01.at:20:
 mkdir ustar
 (cd ustar
@@ -6532,7 +5335,7 @@ export TAR_OPTIONS
 rm -rf *
 
 
-test -z "`sort < /dev/null 2>&1`" || exit 77
+test -z \"\`sort < /dev/null 2>&1\`\" || exit 77
 
 
 rm -rf testdir
@@ -6566,57 +5369,8 @@ tar t --wildcards \"testdir/dir1/*\" -f
 
 rm -rf testdir
 )"
-echo exclude01.at:20 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir ustar
-(cd ustar
-TEST_TAR_FORMAT=ustar
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H ustar"
-export TAR_OPTIONS
-rm -rf *
-
-
-test -z "`sort < /dev/null 2>&1`" || exit 77
-
-
-rm -rf testdir
-mkdir -p testdir/dir1 testdir/dir2 testdir/dir3
-touch testdir/dir1/file1
-touch testdir/dir1/\*
-touch testdir/dir2/file2
-touch testdir/dir2/\*
-touch testdir/dir3/file3
-touch testdir/dir3/\*
-
-tar cf archive --exclude=testdir/dir1/\* \
-               --no-wildcards \
-               --exclude=testdir/dir2/\* \
-               --wildcards \
-               --exclude=testdir/dir3/\* \
-               testdir
-tar tf archive | sort
-
-echo "NEXT"
-tar cf archive testdir
-tar t "testdir/dir1/*" -f archive | sort
-
-echo "NEXT"
-tar cf archive testdir/dir1
-tar t --no-wildcards "testdir/dir1/*" -f archive | sort
-
-echo "NEXT"
-tar cf archive testdir
-tar t --wildcards "testdir/dir1/*" -f archive | sort
-
-rm -rf testdir
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'a `...` command substitution' "exclude01.at:20"
+( $at_check_trace;
 mkdir ustar
 (cd ustar
 TEST_TAR_FORMAT=ustar
@@ -6659,11 +5413,11 @@ tar cf archive testdir
 tar t --wildcards "testdir/dir1/*" -f archive | sort
 
 rm -rf testdir
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "testdir/
 testdir/dir1/
 testdir/dir2/
@@ -6678,12 +5432,11 @@ testdir/dir1/*
 testdir/dir1/file1
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/exclude01.at:20"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/exclude01.at:20"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/exclude01.at:20:
 mkdir posix
 (cd posix
@@ -6694,7 +5447,7 @@ export TAR_OPTIONS
 rm -rf *
 
 
-test -z "`sort < /dev/null 2>&1`" || exit 77
+test -z \"\`sort < /dev/null 2>&1\`\" || exit 77
 
 
 rm -rf testdir
@@ -6728,57 +5481,8 @@ tar t --wildcards \"testdir/dir1/*\" -f
 
 rm -rf testdir
 )"
-echo exclude01.at:20 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir posix
-(cd posix
-TEST_TAR_FORMAT=posix
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H posix"
-export TAR_OPTIONS
-rm -rf *
-
-
-test -z "`sort < /dev/null 2>&1`" || exit 77
-
-
-rm -rf testdir
-mkdir -p testdir/dir1 testdir/dir2 testdir/dir3
-touch testdir/dir1/file1
-touch testdir/dir1/\*
-touch testdir/dir2/file2
-touch testdir/dir2/\*
-touch testdir/dir3/file3
-touch testdir/dir3/\*
-
-tar cf archive --exclude=testdir/dir1/\* \
-               --no-wildcards \
-               --exclude=testdir/dir2/\* \
-               --wildcards \
-               --exclude=testdir/dir3/\* \
-               testdir
-tar tf archive | sort
-
-echo "NEXT"
-tar cf archive testdir
-tar t "testdir/dir1/*" -f archive | sort
-
-echo "NEXT"
-tar cf archive testdir/dir1
-tar t --no-wildcards "testdir/dir1/*" -f archive | sort
-
-echo "NEXT"
-tar cf archive testdir
-tar t --wildcards "testdir/dir1/*" -f archive | sort
-
-rm -rf testdir
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'a `...` command substitution' "exclude01.at:20"
+( $at_check_trace;
 mkdir posix
 (cd posix
 TEST_TAR_FORMAT=posix
@@ -6821,11 +5525,11 @@ tar cf archive testdir
 tar t --wildcards "testdir/dir1/*" -f archive | sort
 
 rm -rf testdir
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "testdir/
 testdir/dir1/
 testdir/dir2/
@@ -6840,12 +5544,11 @@ testdir/dir1/*
 testdir/dir1/file1
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/exclude01.at:20"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/exclude01.at:20"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/exclude01.at:20:
 mkdir gnu
 (cd gnu
@@ -6856,7 +5559,7 @@ export TAR_OPTIONS
 rm -rf *
 
 
-test -z "`sort < /dev/null 2>&1`" || exit 77
+test -z \"\`sort < /dev/null 2>&1\`\" || exit 77
 
 
 rm -rf testdir
@@ -6890,57 +5593,8 @@ tar t --wildcards \"testdir/dir1/*\" -f
 
 rm -rf testdir
 )"
-echo exclude01.at:20 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir gnu
-(cd gnu
-TEST_TAR_FORMAT=gnu
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H gnu"
-export TAR_OPTIONS
-rm -rf *
-
-
-test -z "`sort < /dev/null 2>&1`" || exit 77
-
-
-rm -rf testdir
-mkdir -p testdir/dir1 testdir/dir2 testdir/dir3
-touch testdir/dir1/file1
-touch testdir/dir1/\*
-touch testdir/dir2/file2
-touch testdir/dir2/\*
-touch testdir/dir3/file3
-touch testdir/dir3/\*
-
-tar cf archive --exclude=testdir/dir1/\* \
-               --no-wildcards \
-               --exclude=testdir/dir2/\* \
-               --wildcards \
-               --exclude=testdir/dir3/\* \
-               testdir
-tar tf archive | sort
-
-echo "NEXT"
-tar cf archive testdir
-tar t "testdir/dir1/*" -f archive | sort
-
-echo "NEXT"
-tar cf archive testdir/dir1
-tar t --no-wildcards "testdir/dir1/*" -f archive | sort
-
-echo "NEXT"
-tar cf archive testdir
-tar t --wildcards "testdir/dir1/*" -f archive | sort
-
-rm -rf testdir
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'a `...` command substitution' "exclude01.at:20"
+( $at_check_trace;
 mkdir gnu
 (cd gnu
 TEST_TAR_FORMAT=gnu
@@ -6983,11 +5637,11 @@ tar cf archive testdir
 tar t --wildcards "testdir/dir1/*" -f archive | sort
 
 rm -rf testdir
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "testdir/
 testdir/dir1/
 testdir/dir2/
@@ -7002,36 +5656,32 @@ testdir/dir1/*
 testdir/dir1/file1
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/exclude01.at:20"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/exclude01.at:20"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
 
 
 
-  $at_traceoff
+  set +x
   $at_times_p && times >"$at_times_file"
-) 5>&1 2>&1 | eval $at_tee_pipe
-at_status=`cat "$at_status_file"`
+) 5>&1 2>&1 7>&- | eval $at_tee_pipe
+read at_status <"$at_status_file"
 #AT_STOP_16
 #AT_START_17
-# 17. exclude02.at:17: exclude: anchoring
-at_setup_line='exclude02.at:17'
-at_desc="exclude: anchoring"
-$at_quiet $as_echo_n " 17: $at_desc                             "
+at_fn_group_banner 17 'exclude02.at:17' \
+  "exclude: anchoring" "                             "
 at_xfail=no
       test -f $XFAILFILE && at_xfail=yes
-echo "#                             -*- compilation -*-" >> "$at_group_log"
 (
-  $as_echo "17. exclude02.at:17: testing ..."
+  $as_echo "17. $at_setup_line: testing $at_desc ..."
   $at_traceon
 
 
 
 
 
-  { $at_traceoff
+  { set +x
 $as_echo "$at_srcdir/exclude02.at:20:
 mkdir v7
 (cd v7
@@ -7042,7 +5692,7 @@ export TAR_OPTIONS
 rm -rf *
 
 
-test -z "`sort < /dev/null 2>&1`" || exit 77
+test -z \"\`sort < /dev/null 2>&1\`\" || exit 77
 
 
 rm -rf testdir
@@ -7080,11 +5730,8 @@ tar t --anchored \"file1.txt\" -f archiv
 rm -rf testdir file1.txt
 
 )"
-echo exclude02.at:20 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
+at_fn_check_prepare_notrace 'a `...` command substitution' "exclude02.at:20"
+( $at_check_trace;
 mkdir v7
 (cd v7
 TEST_TAR_FORMAT=v7
@@ -7131,61 +5778,11 @@ tar t --anchored "file1.txt" -f archive
 
 rm -rf testdir file1.txt
 
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
-mkdir v7
-(cd v7
-TEST_TAR_FORMAT=v7
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H v7"
-export TAR_OPTIONS
-rm -rf *
-
-
-test -z "`sort < /dev/null 2>&1`" || exit 77
-
-
-rm -rf testdir
-mkdir -p testdir
-touch file1.txt
-touch testdir/file1.txt
-touch testdir/file2
-
-tar cf archive --exclude="file1.txt" \
-               testdir
-tar tf archive | sort
-
-echo "SUB 1"
-tar cf archive --no-anchored \
-               --exclude="file1.txt" \
-               testdir
-tar tf archive | sort
-
-echo "SUB 2"
-tar cf archive --anchored \
-               --exclude="file1.txt" \
-               testdir
-tar tf archive | sort
-
-echo "SUB 3"
-tar cf archive testdir file1.txt
-tar t "file1.txt" -f archive | sort
-
-echo "SUB 4"
-tar t --no-anchored "file1.txt" -f archive | sort
-
-echo "SUB 5"
-tar t --anchored "file1.txt" -f archive | sort
-
-rm -rf testdir file1.txt
-
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "testdir/
 testdir/file2
 SUB 1
@@ -7204,12 +5801,11 @@ SUB 5
 file1.txt
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/exclude02.at:20"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/exclude02.at:20"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/exclude02.at:20:
 mkdir oldgnu
 (cd oldgnu
@@ -7220,7 +5816,7 @@ export TAR_OPTIONS
 rm -rf *
 
 
-test -z "`sort < /dev/null 2>&1`" || exit 77
+test -z \"\`sort < /dev/null 2>&1\`\" || exit 77
 
 
 rm -rf testdir
@@ -7258,61 +5854,8 @@ tar t --anchored \"file1.txt\" -f archiv
 rm -rf testdir file1.txt
 
 )"
-echo exclude02.at:20 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir oldgnu
-(cd oldgnu
-TEST_TAR_FORMAT=oldgnu
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H oldgnu"
-export TAR_OPTIONS
-rm -rf *
-
-
-test -z "`sort < /dev/null 2>&1`" || exit 77
-
-
-rm -rf testdir
-mkdir -p testdir
-touch file1.txt
-touch testdir/file1.txt
-touch testdir/file2
-
-tar cf archive --exclude="file1.txt" \
-               testdir
-tar tf archive | sort
-
-echo "SUB 1"
-tar cf archive --no-anchored \
-               --exclude="file1.txt" \
-               testdir
-tar tf archive | sort
-
-echo "SUB 2"
-tar cf archive --anchored \
-               --exclude="file1.txt" \
-               testdir
-tar tf archive | sort
-
-echo "SUB 3"
-tar cf archive testdir file1.txt
-tar t "file1.txt" -f archive | sort
-
-echo "SUB 4"
-tar t --no-anchored "file1.txt" -f archive | sort
-
-echo "SUB 5"
-tar t --anchored "file1.txt" -f archive | sort
-
-rm -rf testdir file1.txt
-
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'a `...` command substitution' "exclude02.at:20"
+( $at_check_trace;
 mkdir oldgnu
 (cd oldgnu
 TEST_TAR_FORMAT=oldgnu
@@ -7359,11 +5902,11 @@ tar t --anchored "file1.txt" -f archive
 
 rm -rf testdir file1.txt
 
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "testdir/
 testdir/file2
 SUB 1
@@ -7382,12 +5925,11 @@ SUB 5
 file1.txt
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/exclude02.at:20"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/exclude02.at:20"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/exclude02.at:20:
 mkdir ustar
 (cd ustar
@@ -7398,7 +5940,7 @@ export TAR_OPTIONS
 rm -rf *
 
 
-test -z "`sort < /dev/null 2>&1`" || exit 77
+test -z \"\`sort < /dev/null 2>&1\`\" || exit 77
 
 
 rm -rf testdir
@@ -7436,61 +5978,8 @@ tar t --anchored \"file1.txt\" -f archiv
 rm -rf testdir file1.txt
 
 )"
-echo exclude02.at:20 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir ustar
-(cd ustar
-TEST_TAR_FORMAT=ustar
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H ustar"
-export TAR_OPTIONS
-rm -rf *
-
-
-test -z "`sort < /dev/null 2>&1`" || exit 77
-
-
-rm -rf testdir
-mkdir -p testdir
-touch file1.txt
-touch testdir/file1.txt
-touch testdir/file2
-
-tar cf archive --exclude="file1.txt" \
-               testdir
-tar tf archive | sort
-
-echo "SUB 1"
-tar cf archive --no-anchored \
-               --exclude="file1.txt" \
-               testdir
-tar tf archive | sort
-
-echo "SUB 2"
-tar cf archive --anchored \
-               --exclude="file1.txt" \
-               testdir
-tar tf archive | sort
-
-echo "SUB 3"
-tar cf archive testdir file1.txt
-tar t "file1.txt" -f archive | sort
-
-echo "SUB 4"
-tar t --no-anchored "file1.txt" -f archive | sort
-
-echo "SUB 5"
-tar t --anchored "file1.txt" -f archive | sort
-
-rm -rf testdir file1.txt
-
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'a `...` command substitution' "exclude02.at:20"
+( $at_check_trace;
 mkdir ustar
 (cd ustar
 TEST_TAR_FORMAT=ustar
@@ -7537,11 +6026,11 @@ tar t --anchored "file1.txt" -f archive
 
 rm -rf testdir file1.txt
 
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "testdir/
 testdir/file2
 SUB 1
@@ -7560,12 +6049,11 @@ SUB 5
 file1.txt
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/exclude02.at:20"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/exclude02.at:20"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/exclude02.at:20:
 mkdir posix
 (cd posix
@@ -7576,7 +6064,7 @@ export TAR_OPTIONS
 rm -rf *
 
 
-test -z "`sort < /dev/null 2>&1`" || exit 77
+test -z \"\`sort < /dev/null 2>&1\`\" || exit 77
 
 
 rm -rf testdir
@@ -7614,61 +6102,8 @@ tar t --anchored \"file1.txt\" -f archiv
 rm -rf testdir file1.txt
 
 )"
-echo exclude02.at:20 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir posix
-(cd posix
-TEST_TAR_FORMAT=posix
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H posix"
-export TAR_OPTIONS
-rm -rf *
-
-
-test -z "`sort < /dev/null 2>&1`" || exit 77
-
-
-rm -rf testdir
-mkdir -p testdir
-touch file1.txt
-touch testdir/file1.txt
-touch testdir/file2
-
-tar cf archive --exclude="file1.txt" \
-               testdir
-tar tf archive | sort
-
-echo "SUB 1"
-tar cf archive --no-anchored \
-               --exclude="file1.txt" \
-               testdir
-tar tf archive | sort
-
-echo "SUB 2"
-tar cf archive --anchored \
-               --exclude="file1.txt" \
-               testdir
-tar tf archive | sort
-
-echo "SUB 3"
-tar cf archive testdir file1.txt
-tar t "file1.txt" -f archive | sort
-
-echo "SUB 4"
-tar t --no-anchored "file1.txt" -f archive | sort
-
-echo "SUB 5"
-tar t --anchored "file1.txt" -f archive | sort
-
-rm -rf testdir file1.txt
-
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'a `...` command substitution' "exclude02.at:20"
+( $at_check_trace;
 mkdir posix
 (cd posix
 TEST_TAR_FORMAT=posix
@@ -7715,11 +6150,11 @@ tar t --anchored "file1.txt" -f archive
 
 rm -rf testdir file1.txt
 
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "testdir/
 testdir/file2
 SUB 1
@@ -7738,12 +6173,11 @@ SUB 5
 file1.txt
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/exclude02.at:20"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/exclude02.at:20"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/exclude02.at:20:
 mkdir gnu
 (cd gnu
@@ -7754,7 +6188,7 @@ export TAR_OPTIONS
 rm -rf *
 
 
-test -z "`sort < /dev/null 2>&1`" || exit 77
+test -z \"\`sort < /dev/null 2>&1\`\" || exit 77
 
 
 rm -rf testdir
@@ -7792,61 +6226,8 @@ tar t --anchored \"file1.txt\" -f archiv
 rm -rf testdir file1.txt
 
 )"
-echo exclude02.at:20 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir gnu
-(cd gnu
-TEST_TAR_FORMAT=gnu
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H gnu"
-export TAR_OPTIONS
-rm -rf *
-
-
-test -z "`sort < /dev/null 2>&1`" || exit 77
-
-
-rm -rf testdir
-mkdir -p testdir
-touch file1.txt
-touch testdir/file1.txt
-touch testdir/file2
-
-tar cf archive --exclude="file1.txt" \
-               testdir
-tar tf archive | sort
-
-echo "SUB 1"
-tar cf archive --no-anchored \
-               --exclude="file1.txt" \
-               testdir
-tar tf archive | sort
-
-echo "SUB 2"
-tar cf archive --anchored \
-               --exclude="file1.txt" \
-               testdir
-tar tf archive | sort
-
-echo "SUB 3"
-tar cf archive testdir file1.txt
-tar t "file1.txt" -f archive | sort
-
-echo "SUB 4"
-tar t --no-anchored "file1.txt" -f archive | sort
-
-echo "SUB 5"
-tar t --anchored "file1.txt" -f archive | sort
-
-rm -rf testdir file1.txt
-
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'a `...` command substitution' "exclude02.at:20"
+( $at_check_trace;
 mkdir gnu
 (cd gnu
 TEST_TAR_FORMAT=gnu
@@ -7893,11 +6274,11 @@ tar t --anchored "file1.txt" -f archive
 
 rm -rf testdir file1.txt
 
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "testdir/
 testdir/file2
 SUB 1
@@ -7916,36 +6297,32 @@ SUB 5
 file1.txt
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/exclude02.at:20"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/exclude02.at:20"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
 
 
 
-  $at_traceoff
+  set +x
   $at_times_p && times >"$at_times_file"
-) 5>&1 2>&1 | eval $at_tee_pipe
-at_status=`cat "$at_status_file"`
+) 5>&1 2>&1 7>&- | eval $at_tee_pipe
+read at_status <"$at_status_file"
 #AT_STOP_17
 #AT_START_18
-# 18. exclude03.at:17: exclude: wildcards match slash
-at_setup_line='exclude03.at:17'
-at_desc="exclude: wildcards match slash"
-$at_quiet $as_echo_n " 18: $at_desc                 "
+at_fn_group_banner 18 'exclude03.at:17' \
+  "exclude: wildcards match slash" "                 "
 at_xfail=no
       test -f $XFAILFILE && at_xfail=yes
-echo "#                             -*- compilation -*-" >> "$at_group_log"
 (
-  $as_echo "18. exclude03.at:17: testing ..."
+  $as_echo "18. $at_setup_line: testing $at_desc ..."
   $at_traceon
 
 
 
 
 
-  { $at_traceoff
+  { set +x
 $as_echo "$at_srcdir/exclude03.at:20:
 mkdir v7
 (cd v7
@@ -7956,7 +6333,7 @@ export TAR_OPTIONS
 rm -rf *
 
 
-test -z "`sort < /dev/null 2>&1`" || exit 77
+test -z \"\`sort < /dev/null 2>&1\`\" || exit 77
 
 
 rm -rf testdir
@@ -7990,11 +6367,8 @@ tar t --wildcards --wildcards-match-slas
 rm -rf testdir
 
 )"
-echo exclude03.at:20 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
+at_fn_check_prepare_notrace 'a `...` command substitution' "exclude03.at:20"
+( $at_check_trace;
 mkdir v7
 (cd v7
 TEST_TAR_FORMAT=v7
@@ -8037,57 +6411,11 @@ tar t --wildcards --wildcards-match-slas
 
 rm -rf testdir
 
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
-mkdir v7
-(cd v7
-TEST_TAR_FORMAT=v7
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H v7"
-export TAR_OPTIONS
-rm -rf *
-
-
-test -z "`sort < /dev/null 2>&1`" || exit 77
-
-
-rm -rf testdir
-mkdir -p testdir/dir1 testdir/dir2 testdir/dir3
-touch testdir/\*f\*1
-touch testdir/dir1/file1
-touch testdir/dir1/\*
-touch testdir/dir2/file2
-touch testdir/dir2/\*
-touch testdir/dir3/file3
-touch testdir/dir3/\*
-
-tar cf archive --exclude='testdir*f*1' \
-               --no-wildcards-match-slash \
-               --exclude='testdir*f*2' \
-               --wildcards-match-slash \
-               --exclude='testdir*f*3' \
-               testdir
-tar tf archive | sort
-
-echo "NEXT"
-tar cf archive testdir
-tar t --wildcards 'testdir/*f*1' -f archive | sort
-
-echo "NEXT"
-tar t --wildcards --no-wildcards-match-slash 'testdir/*f*1' -f archive | sort
-
-echo "NEXT"
-tar t --wildcards --wildcards-match-slash 'testdir/*f*1' -f archive | sort
-
-rm -rf testdir
-
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "testdir/
 testdir/dir1/
 testdir/dir1/*
@@ -8106,12 +6434,11 @@ testdir/*f*1
 testdir/dir1/file1
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/exclude03.at:20"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/exclude03.at:20"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/exclude03.at:20:
 mkdir oldgnu
 (cd oldgnu
@@ -8122,7 +6449,7 @@ export TAR_OPTIONS
 rm -rf *
 
 
-test -z "`sort < /dev/null 2>&1`" || exit 77
+test -z \"\`sort < /dev/null 2>&1\`\" || exit 77
 
 
 rm -rf testdir
@@ -8156,57 +6483,8 @@ tar t --wildcards --wildcards-match-slas
 rm -rf testdir
 
 )"
-echo exclude03.at:20 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir oldgnu
-(cd oldgnu
-TEST_TAR_FORMAT=oldgnu
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H oldgnu"
-export TAR_OPTIONS
-rm -rf *
-
-
-test -z "`sort < /dev/null 2>&1`" || exit 77
-
-
-rm -rf testdir
-mkdir -p testdir/dir1 testdir/dir2 testdir/dir3
-touch testdir/\*f\*1
-touch testdir/dir1/file1
-touch testdir/dir1/\*
-touch testdir/dir2/file2
-touch testdir/dir2/\*
-touch testdir/dir3/file3
-touch testdir/dir3/\*
-
-tar cf archive --exclude='testdir*f*1' \
-               --no-wildcards-match-slash \
-               --exclude='testdir*f*2' \
-               --wildcards-match-slash \
-               --exclude='testdir*f*3' \
-               testdir
-tar tf archive | sort
-
-echo "NEXT"
-tar cf archive testdir
-tar t --wildcards 'testdir/*f*1' -f archive | sort
-
-echo "NEXT"
-tar t --wildcards --no-wildcards-match-slash 'testdir/*f*1' -f archive | sort
-
-echo "NEXT"
-tar t --wildcards --wildcards-match-slash 'testdir/*f*1' -f archive | sort
-
-rm -rf testdir
-
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'a `...` command substitution' "exclude03.at:20"
+( $at_check_trace;
 mkdir oldgnu
 (cd oldgnu
 TEST_TAR_FORMAT=oldgnu
@@ -8249,11 +6527,11 @@ tar t --wildcards --wildcards-match-slas
 
 rm -rf testdir
 
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "testdir/
 testdir/dir1/
 testdir/dir1/*
@@ -8272,12 +6550,11 @@ testdir/*f*1
 testdir/dir1/file1
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/exclude03.at:20"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/exclude03.at:20"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/exclude03.at:20:
 mkdir ustar
 (cd ustar
@@ -8288,7 +6565,7 @@ export TAR_OPTIONS
 rm -rf *
 
 
-test -z "`sort < /dev/null 2>&1`" || exit 77
+test -z \"\`sort < /dev/null 2>&1\`\" || exit 77
 
 
 rm -rf testdir
@@ -8322,57 +6599,8 @@ tar t --wildcards --wildcards-match-slas
 rm -rf testdir
 
 )"
-echo exclude03.at:20 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir ustar
-(cd ustar
-TEST_TAR_FORMAT=ustar
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H ustar"
-export TAR_OPTIONS
-rm -rf *
-
-
-test -z "`sort < /dev/null 2>&1`" || exit 77
-
-
-rm -rf testdir
-mkdir -p testdir/dir1 testdir/dir2 testdir/dir3
-touch testdir/\*f\*1
-touch testdir/dir1/file1
-touch testdir/dir1/\*
-touch testdir/dir2/file2
-touch testdir/dir2/\*
-touch testdir/dir3/file3
-touch testdir/dir3/\*
-
-tar cf archive --exclude='testdir*f*1' \
-               --no-wildcards-match-slash \
-               --exclude='testdir*f*2' \
-               --wildcards-match-slash \
-               --exclude='testdir*f*3' \
-               testdir
-tar tf archive | sort
-
-echo "NEXT"
-tar cf archive testdir
-tar t --wildcards 'testdir/*f*1' -f archive | sort
-
-echo "NEXT"
-tar t --wildcards --no-wildcards-match-slash 'testdir/*f*1' -f archive | sort
-
-echo "NEXT"
-tar t --wildcards --wildcards-match-slash 'testdir/*f*1' -f archive | sort
-
-rm -rf testdir
-
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'a `...` command substitution' "exclude03.at:20"
+( $at_check_trace;
 mkdir ustar
 (cd ustar
 TEST_TAR_FORMAT=ustar
@@ -8415,11 +6643,11 @@ tar t --wildcards --wildcards-match-slas
 
 rm -rf testdir
 
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "testdir/
 testdir/dir1/
 testdir/dir1/*
@@ -8438,12 +6666,11 @@ testdir/*f*1
 testdir/dir1/file1
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/exclude03.at:20"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/exclude03.at:20"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/exclude03.at:20:
 mkdir posix
 (cd posix
@@ -8454,7 +6681,7 @@ export TAR_OPTIONS
 rm -rf *
 
 
-test -z "`sort < /dev/null 2>&1`" || exit 77
+test -z \"\`sort < /dev/null 2>&1\`\" || exit 77
 
 
 rm -rf testdir
@@ -8488,57 +6715,8 @@ tar t --wildcards --wildcards-match-slas
 rm -rf testdir
 
 )"
-echo exclude03.at:20 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir posix
-(cd posix
-TEST_TAR_FORMAT=posix
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H posix"
-export TAR_OPTIONS
-rm -rf *
-
-
-test -z "`sort < /dev/null 2>&1`" || exit 77
-
-
-rm -rf testdir
-mkdir -p testdir/dir1 testdir/dir2 testdir/dir3
-touch testdir/\*f\*1
-touch testdir/dir1/file1
-touch testdir/dir1/\*
-touch testdir/dir2/file2
-touch testdir/dir2/\*
-touch testdir/dir3/file3
-touch testdir/dir3/\*
-
-tar cf archive --exclude='testdir*f*1' \
-               --no-wildcards-match-slash \
-               --exclude='testdir*f*2' \
-               --wildcards-match-slash \
-               --exclude='testdir*f*3' \
-               testdir
-tar tf archive | sort
-
-echo "NEXT"
-tar cf archive testdir
-tar t --wildcards 'testdir/*f*1' -f archive | sort
-
-echo "NEXT"
-tar t --wildcards --no-wildcards-match-slash 'testdir/*f*1' -f archive | sort
-
-echo "NEXT"
-tar t --wildcards --wildcards-match-slash 'testdir/*f*1' -f archive | sort
-
-rm -rf testdir
-
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'a `...` command substitution' "exclude03.at:20"
+( $at_check_trace;
 mkdir posix
 (cd posix
 TEST_TAR_FORMAT=posix
@@ -8581,11 +6759,11 @@ tar t --wildcards --wildcards-match-slas
 
 rm -rf testdir
 
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "testdir/
 testdir/dir1/
 testdir/dir1/*
@@ -8604,12 +6782,11 @@ testdir/*f*1
 testdir/dir1/file1
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/exclude03.at:20"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/exclude03.at:20"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/exclude03.at:20:
 mkdir gnu
 (cd gnu
@@ -8620,7 +6797,7 @@ export TAR_OPTIONS
 rm -rf *
 
 
-test -z "`sort < /dev/null 2>&1`" || exit 77
+test -z \"\`sort < /dev/null 2>&1\`\" || exit 77
 
 
 rm -rf testdir
@@ -8654,57 +6831,8 @@ tar t --wildcards --wildcards-match-slas
 rm -rf testdir
 
 )"
-echo exclude03.at:20 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir gnu
-(cd gnu
-TEST_TAR_FORMAT=gnu
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H gnu"
-export TAR_OPTIONS
-rm -rf *
-
-
-test -z "`sort < /dev/null 2>&1`" || exit 77
-
-
-rm -rf testdir
-mkdir -p testdir/dir1 testdir/dir2 testdir/dir3
-touch testdir/\*f\*1
-touch testdir/dir1/file1
-touch testdir/dir1/\*
-touch testdir/dir2/file2
-touch testdir/dir2/\*
-touch testdir/dir3/file3
-touch testdir/dir3/\*
-
-tar cf archive --exclude='testdir*f*1' \
-               --no-wildcards-match-slash \
-               --exclude='testdir*f*2' \
-               --wildcards-match-slash \
-               --exclude='testdir*f*3' \
-               testdir
-tar tf archive | sort
-
-echo "NEXT"
-tar cf archive testdir
-tar t --wildcards 'testdir/*f*1' -f archive | sort
-
-echo "NEXT"
-tar t --wildcards --no-wildcards-match-slash 'testdir/*f*1' -f archive | sort
-
-echo "NEXT"
-tar t --wildcards --wildcards-match-slash 'testdir/*f*1' -f archive | sort
-
-rm -rf testdir
-
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'a `...` command substitution' "exclude03.at:20"
+( $at_check_trace;
 mkdir gnu
 (cd gnu
 TEST_TAR_FORMAT=gnu
@@ -8747,11 +6875,11 @@ tar t --wildcards --wildcards-match-slas
 
 rm -rf testdir
 
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "testdir/
 testdir/dir1/
 testdir/dir1/*
@@ -8770,36 +6898,32 @@ testdir/*f*1
 testdir/dir1/file1
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/exclude03.at:20"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/exclude03.at:20"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
 
 
 
-  $at_traceoff
+  set +x
   $at_times_p && times >"$at_times_file"
-) 5>&1 2>&1 | eval $at_tee_pipe
-at_status=`cat "$at_status_file"`
+) 5>&1 2>&1 7>&- | eval $at_tee_pipe
+read at_status <"$at_status_file"
 #AT_STOP_18
 #AT_START_19
-# 19. exclude04.at:17: exclude: case insensitive
-at_setup_line='exclude04.at:17'
-at_desc="exclude: case insensitive"
-$at_quiet $as_echo_n " 19: $at_desc                      "
+at_fn_group_banner 19 'exclude04.at:17' \
+  "exclude: case insensitive" "                      "
 at_xfail=no
       test -f $XFAILFILE && at_xfail=yes
-echo "#                             -*- compilation -*-" >> "$at_group_log"
 (
-  $as_echo "19. exclude04.at:17: testing ..."
+  $as_echo "19. $at_setup_line: testing $at_desc ..."
   $at_traceon
 
 
 
 
 
-  { $at_traceoff
+  { set +x
 $as_echo "$at_srcdir/exclude04.at:20:
 mkdir v7
 (cd v7
@@ -8810,7 +6934,7 @@ export TAR_OPTIONS
 rm -rf *
 
 
-test -z "`sort < /dev/null 2>&1`" || exit 77
+test -z \"\`sort < /dev/null 2>&1\`\" || exit 77
 
 
 rm -rf testdir
@@ -8847,11 +6971,8 @@ tar t --wildcards --wildcards-match-slas
 rm -rf testdir
 
 )"
-echo exclude04.at:20 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
+at_fn_check_prepare_notrace 'a `...` command substitution' "exclude04.at:20"
+( $at_check_trace;
 mkdir v7
 (cd v7
 TEST_TAR_FORMAT=v7
@@ -8897,92 +7018,42 @@ tar t --wildcards --wildcards-match-slas
 
 rm -rf testdir
 
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
-mkdir v7
-(cd v7
-TEST_TAR_FORMAT=v7
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
+echo >>"$at_stdout"; $as_echo "testdir/
+testdir/dir/
+testdir/dir/File1
+testdir/dir/File2
+testdir/dir/File4
+testdir/file2
+SUB 1
+testdir/dir/File2
+SUB 2
+testdir/dir/File2
+testdir/file2
+SUB 3
+testdir/dir/File2
+" | \
+  $at_diff - "$at_stdout" || at_failed=:
+at_fn_check_status 0 $at_status "$at_srcdir/exclude04.at:20"
+$at_failed && at_fn_log_failure
+$at_traceon; }
+
+              { set +x
+$as_echo "$at_srcdir/exclude04.at:20:
+mkdir oldgnu
+(cd oldgnu
+TEST_TAR_FORMAT=oldgnu
 export TEST_TAR_FORMAT
-TAR_OPTIONS="-H v7"
+TAR_OPTIONS=\"-H oldgnu\"
 export TAR_OPTIONS
 rm -rf *
 
 
-test -z "`sort < /dev/null 2>&1`" || exit 77
-
-
-rm -rf testdir
-mkdir -p testdir/dir
-touch testdir/file1
-touch testdir/file2
-touch testdir/file3
-touch testdir/file4
-touch testdir/dir/File1
-touch testdir/dir/File2
-touch testdir/dir/File3
-touch testdir/dir/File4
-
-tar cf archive --exclude=FILE2 \
-               --exclude=file1 \
-               --ignore-case \
-               --exclude=file3 \
-               --no-ignore-case \
-               --exclude=FILE2 \
-               --exclude=file4 \
-               testdir
-tar tf archive | sort
-
-echo "SUB 1"
-tar cf archive testdir
-tar t --wildcards --wildcards-match-slash '*File2' -f archive | sort
-
-echo "SUB 2"
-tar t --wildcards --wildcards-match-slash --ignore-case '*File2' -f archive | sort
-
-echo "SUB 3"
-tar t --wildcards --wildcards-match-slash --no-ignore-case '*File2' -f archive | sort
-
-rm -rf testdir
-
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
-echo >>"$at_stdout"; $as_echo "testdir/
-testdir/dir/
-testdir/dir/File1
-testdir/dir/File2
-testdir/dir/File4
-testdir/file2
-SUB 1
-testdir/dir/File2
-SUB 2
-testdir/dir/File2
-testdir/file2
-SUB 3
-testdir/dir/File2
-" | \
-  $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/exclude04.at:20"
-
-$at_failed && at_func_log_failure
-$at_traceon; }
-
-              { $at_traceoff
-$as_echo "$at_srcdir/exclude04.at:20:
-mkdir oldgnu
-(cd oldgnu
-TEST_TAR_FORMAT=oldgnu
-export TEST_TAR_FORMAT
-TAR_OPTIONS=\"-H oldgnu\"
-export TAR_OPTIONS
-rm -rf *
-
-
-test -z "`sort < /dev/null 2>&1`" || exit 77
+test -z \"\`sort < /dev/null 2>&1\`\" || exit 77
 
 
 rm -rf testdir
@@ -9019,60 +7090,8 @@ tar t --wildcards --wildcards-match-slas
 rm -rf testdir
 
 )"
-echo exclude04.at:20 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir oldgnu
-(cd oldgnu
-TEST_TAR_FORMAT=oldgnu
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H oldgnu"
-export TAR_OPTIONS
-rm -rf *
-
-
-test -z "`sort < /dev/null 2>&1`" || exit 77
-
-
-rm -rf testdir
-mkdir -p testdir/dir
-touch testdir/file1
-touch testdir/file2
-touch testdir/file3
-touch testdir/file4
-touch testdir/dir/File1
-touch testdir/dir/File2
-touch testdir/dir/File3
-touch testdir/dir/File4
-
-tar cf archive --exclude=FILE2 \
-               --exclude=file1 \
-               --ignore-case \
-               --exclude=file3 \
-               --no-ignore-case \
-               --exclude=FILE2 \
-               --exclude=file4 \
-               testdir
-tar tf archive | sort
-
-echo "SUB 1"
-tar cf archive testdir
-tar t --wildcards --wildcards-match-slash '*File2' -f archive | sort
-
-echo "SUB 2"
-tar t --wildcards --wildcards-match-slash --ignore-case '*File2' -f archive | sort
-
-echo "SUB 3"
-tar t --wildcards --wildcards-match-slash --no-ignore-case '*File2' -f archive | sort
-
-rm -rf testdir
-
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'a `...` command substitution' "exclude04.at:20"
+( $at_check_trace;
 mkdir oldgnu
 (cd oldgnu
 TEST_TAR_FORMAT=oldgnu
@@ -9118,11 +7137,11 @@ tar t --wildcards --wildcards-match-slas
 
 rm -rf testdir
 
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "testdir/
 testdir/dir/
 testdir/dir/File1
@@ -9138,12 +7157,11 @@ SUB 3
 testdir/dir/File2
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/exclude04.at:20"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/exclude04.at:20"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/exclude04.at:20:
 mkdir ustar
 (cd ustar
@@ -9154,7 +7172,7 @@ export TAR_OPTIONS
 rm -rf *
 
 
-test -z "`sort < /dev/null 2>&1`" || exit 77
+test -z \"\`sort < /dev/null 2>&1\`\" || exit 77
 
 
 rm -rf testdir
@@ -9191,60 +7209,8 @@ tar t --wildcards --wildcards-match-slas
 rm -rf testdir
 
 )"
-echo exclude04.at:20 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir ustar
-(cd ustar
-TEST_TAR_FORMAT=ustar
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H ustar"
-export TAR_OPTIONS
-rm -rf *
-
-
-test -z "`sort < /dev/null 2>&1`" || exit 77
-
-
-rm -rf testdir
-mkdir -p testdir/dir
-touch testdir/file1
-touch testdir/file2
-touch testdir/file3
-touch testdir/file4
-touch testdir/dir/File1
-touch testdir/dir/File2
-touch testdir/dir/File3
-touch testdir/dir/File4
-
-tar cf archive --exclude=FILE2 \
-               --exclude=file1 \
-               --ignore-case \
-               --exclude=file3 \
-               --no-ignore-case \
-               --exclude=FILE2 \
-               --exclude=file4 \
-               testdir
-tar tf archive | sort
-
-echo "SUB 1"
-tar cf archive testdir
-tar t --wildcards --wildcards-match-slash '*File2' -f archive | sort
-
-echo "SUB 2"
-tar t --wildcards --wildcards-match-slash --ignore-case '*File2' -f archive | sort
-
-echo "SUB 3"
-tar t --wildcards --wildcards-match-slash --no-ignore-case '*File2' -f archive | sort
-
-rm -rf testdir
-
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'a `...` command substitution' "exclude04.at:20"
+( $at_check_trace;
 mkdir ustar
 (cd ustar
 TEST_TAR_FORMAT=ustar
@@ -9290,11 +7256,11 @@ tar t --wildcards --wildcards-match-slas
 
 rm -rf testdir
 
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "testdir/
 testdir/dir/
 testdir/dir/File1
@@ -9310,12 +7276,11 @@ SUB 3
 testdir/dir/File2
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/exclude04.at:20"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/exclude04.at:20"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/exclude04.at:20:
 mkdir posix
 (cd posix
@@ -9326,7 +7291,7 @@ export TAR_OPTIONS
 rm -rf *
 
 
-test -z "`sort < /dev/null 2>&1`" || exit 77
+test -z \"\`sort < /dev/null 2>&1\`\" || exit 77
 
 
 rm -rf testdir
@@ -9363,60 +7328,8 @@ tar t --wildcards --wildcards-match-slas
 rm -rf testdir
 
 )"
-echo exclude04.at:20 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir posix
-(cd posix
-TEST_TAR_FORMAT=posix
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H posix"
-export TAR_OPTIONS
-rm -rf *
-
-
-test -z "`sort < /dev/null 2>&1`" || exit 77
-
-
-rm -rf testdir
-mkdir -p testdir/dir
-touch testdir/file1
-touch testdir/file2
-touch testdir/file3
-touch testdir/file4
-touch testdir/dir/File1
-touch testdir/dir/File2
-touch testdir/dir/File3
-touch testdir/dir/File4
-
-tar cf archive --exclude=FILE2 \
-               --exclude=file1 \
-               --ignore-case \
-               --exclude=file3 \
-               --no-ignore-case \
-               --exclude=FILE2 \
-               --exclude=file4 \
-               testdir
-tar tf archive | sort
-
-echo "SUB 1"
-tar cf archive testdir
-tar t --wildcards --wildcards-match-slash '*File2' -f archive | sort
-
-echo "SUB 2"
-tar t --wildcards --wildcards-match-slash --ignore-case '*File2' -f archive | sort
-
-echo "SUB 3"
-tar t --wildcards --wildcards-match-slash --no-ignore-case '*File2' -f archive | sort
-
-rm -rf testdir
-
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'a `...` command substitution' "exclude04.at:20"
+( $at_check_trace;
 mkdir posix
 (cd posix
 TEST_TAR_FORMAT=posix
@@ -9462,11 +7375,11 @@ tar t --wildcards --wildcards-match-slas
 
 rm -rf testdir
 
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "testdir/
 testdir/dir/
 testdir/dir/File1
@@ -9482,12 +7395,11 @@ SUB 3
 testdir/dir/File2
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/exclude04.at:20"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/exclude04.at:20"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/exclude04.at:20:
 mkdir gnu
 (cd gnu
@@ -9498,7 +7410,7 @@ export TAR_OPTIONS
 rm -rf *
 
 
-test -z "`sort < /dev/null 2>&1`" || exit 77
+test -z \"\`sort < /dev/null 2>&1\`\" || exit 77
 
 
 rm -rf testdir
@@ -9535,60 +7447,8 @@ tar t --wildcards --wildcards-match-slas
 rm -rf testdir
 
 )"
-echo exclude04.at:20 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir gnu
-(cd gnu
-TEST_TAR_FORMAT=gnu
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H gnu"
-export TAR_OPTIONS
-rm -rf *
-
-
-test -z "`sort < /dev/null 2>&1`" || exit 77
-
-
-rm -rf testdir
-mkdir -p testdir/dir
-touch testdir/file1
-touch testdir/file2
-touch testdir/file3
-touch testdir/file4
-touch testdir/dir/File1
-touch testdir/dir/File2
-touch testdir/dir/File3
-touch testdir/dir/File4
-
-tar cf archive --exclude=FILE2 \
-               --exclude=file1 \
-               --ignore-case \
-               --exclude=file3 \
-               --no-ignore-case \
-               --exclude=FILE2 \
-               --exclude=file4 \
-               testdir
-tar tf archive | sort
-
-echo "SUB 1"
-tar cf archive testdir
-tar t --wildcards --wildcards-match-slash '*File2' -f archive | sort
-
-echo "SUB 2"
-tar t --wildcards --wildcards-match-slash --ignore-case '*File2' -f archive | sort
-
-echo "SUB 3"
-tar t --wildcards --wildcards-match-slash --no-ignore-case '*File2' -f archive | sort
-
-rm -rf testdir
-
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'a `...` command substitution' "exclude04.at:20"
+( $at_check_trace;
 mkdir gnu
 (cd gnu
 TEST_TAR_FORMAT=gnu
@@ -9634,11 +7494,11 @@ tar t --wildcards --wildcards-match-slas
 
 rm -rf testdir
 
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "testdir/
 testdir/dir/
 testdir/dir/File1
@@ -9654,36 +7514,32 @@ SUB 3
 testdir/dir/File2
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/exclude04.at:20"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/exclude04.at:20"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
 
 
 
-  $at_traceoff
+  set +x
   $at_times_p && times >"$at_times_file"
-) 5>&1 2>&1 | eval $at_tee_pipe
-at_status=`cat "$at_status_file"`
+) 5>&1 2>&1 7>&- | eval $at_tee_pipe
+read at_status <"$at_status_file"
 #AT_STOP_19
 #AT_START_20
-# 20. exclude05.at:19: exclude: lots of excludes
-at_setup_line='exclude05.at:19'
-at_desc="exclude: lots of excludes"
-$at_quiet $as_echo_n " 20: $at_desc                      "
+at_fn_group_banner 20 'exclude05.at:19' \
+  "exclude: lots of excludes" "                      "
 at_xfail=no
       test -f $XFAILFILE && at_xfail=yes
-echo "#                             -*- compilation -*-" >> "$at_group_log"
 (
-  $as_echo "20. exclude05.at:19: testing ..."
+  $as_echo "20. $at_setup_line: testing $at_desc ..."
   $at_traceon
 
 
 
 
 
-  { $at_traceoff
+  { set +x
 $as_echo "$at_srcdir/exclude05.at:22:
 mkdir v7
 (cd v7
@@ -9694,7 +7550,7 @@ export TAR_OPTIONS
 rm -rf *
 
 
-test -z "`sort < /dev/null 2>&1`" || exit 77
+test -z \"\`sort < /dev/null 2>&1\`\" || exit 77
 
 
 rm -rf testdir exclfile
@@ -9719,48 +7575,8 @@ tar tf archive | sort
 rm -rf testdir exclfile
 
 )"
-echo exclude05.at:22 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir v7
-(cd v7
-TEST_TAR_FORMAT=v7
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H v7"
-export TAR_OPTIONS
-rm -rf *
-
-
-test -z "`sort < /dev/null 2>&1`" || exit 77
-
-
-rm -rf testdir exclfile
-mkdir -p testdir
-awk 'BEGIN {for (i=9; i < 100; ++i ) { print "testdir/file" i; }}' < /dev/null | \
- while read name
- do
-   genfile --file $name
- done
-
-awk 'BEGIN {for (i=1000000; i >= 12; --i ) { print "testdir/file" i }}' < /dev/null > exclfile
-
-tar cf archive --anchored --exclude-from=exclfile \
-               testdir
-tar tf archive | sort
-
-echo "NEXT"
-tar cf archive --exclude-from=exclfile \
-               testdir
-tar tf archive | sort
-
-rm -rf testdir exclfile
-
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'a `...` command substitution' "exclude05.at:22"
+( $at_check_trace;
 mkdir v7
 (cd v7
 TEST_TAR_FORMAT=v7
@@ -9794,11 +7610,11 @@ tar tf archive | sort
 
 rm -rf testdir exclfile
 
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "testdir/
 testdir/file10
 testdir/file11
@@ -9810,12 +7626,11 @@ testdir/file11
 testdir/file9
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/exclude05.at:22"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/exclude05.at:22"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/exclude05.at:22:
 mkdir oldgnu
 (cd oldgnu
@@ -9826,7 +7641,7 @@ export TAR_OPTIONS
 rm -rf *
 
 
-test -z "`sort < /dev/null 2>&1`" || exit 77
+test -z \"\`sort < /dev/null 2>&1\`\" || exit 77
 
 
 rm -rf testdir exclfile
@@ -9851,48 +7666,8 @@ tar tf archive | sort
 rm -rf testdir exclfile
 
 )"
-echo exclude05.at:22 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir oldgnu
-(cd oldgnu
-TEST_TAR_FORMAT=oldgnu
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H oldgnu"
-export TAR_OPTIONS
-rm -rf *
-
-
-test -z "`sort < /dev/null 2>&1`" || exit 77
-
-
-rm -rf testdir exclfile
-mkdir -p testdir
-awk 'BEGIN {for (i=9; i < 100; ++i ) { print "testdir/file" i; }}' < /dev/null | \
- while read name
- do
-   genfile --file $name
- done
-
-awk 'BEGIN {for (i=1000000; i >= 12; --i ) { print "testdir/file" i }}' < /dev/null > exclfile
-
-tar cf archive --anchored --exclude-from=exclfile \
-               testdir
-tar tf archive | sort
-
-echo "NEXT"
-tar cf archive --exclude-from=exclfile \
-               testdir
-tar tf archive | sort
-
-rm -rf testdir exclfile
-
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'a `...` command substitution' "exclude05.at:22"
+( $at_check_trace;
 mkdir oldgnu
 (cd oldgnu
 TEST_TAR_FORMAT=oldgnu
@@ -9926,11 +7701,11 @@ tar tf archive | sort
 
 rm -rf testdir exclfile
 
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "testdir/
 testdir/file10
 testdir/file11
@@ -9942,12 +7717,11 @@ testdir/file11
 testdir/file9
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/exclude05.at:22"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/exclude05.at:22"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/exclude05.at:22:
 mkdir ustar
 (cd ustar
@@ -9958,7 +7732,7 @@ export TAR_OPTIONS
 rm -rf *
 
 
-test -z "`sort < /dev/null 2>&1`" || exit 77
+test -z \"\`sort < /dev/null 2>&1\`\" || exit 77
 
 
 rm -rf testdir exclfile
@@ -9983,48 +7757,8 @@ tar tf archive | sort
 rm -rf testdir exclfile
 
 )"
-echo exclude05.at:22 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir ustar
-(cd ustar
-TEST_TAR_FORMAT=ustar
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H ustar"
-export TAR_OPTIONS
-rm -rf *
-
-
-test -z "`sort < /dev/null 2>&1`" || exit 77
-
-
-rm -rf testdir exclfile
-mkdir -p testdir
-awk 'BEGIN {for (i=9; i < 100; ++i ) { print "testdir/file" i; }}' < /dev/null | \
- while read name
- do
-   genfile --file $name
- done
-
-awk 'BEGIN {for (i=1000000; i >= 12; --i ) { print "testdir/file" i }}' < /dev/null > exclfile
-
-tar cf archive --anchored --exclude-from=exclfile \
-               testdir
-tar tf archive | sort
-
-echo "NEXT"
-tar cf archive --exclude-from=exclfile \
-               testdir
-tar tf archive | sort
-
-rm -rf testdir exclfile
-
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'a `...` command substitution' "exclude05.at:22"
+( $at_check_trace;
 mkdir ustar
 (cd ustar
 TEST_TAR_FORMAT=ustar
@@ -10058,11 +7792,11 @@ tar tf archive | sort
 
 rm -rf testdir exclfile
 
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "testdir/
 testdir/file10
 testdir/file11
@@ -10074,12 +7808,11 @@ testdir/file11
 testdir/file9
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/exclude05.at:22"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/exclude05.at:22"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/exclude05.at:22:
 mkdir posix
 (cd posix
@@ -10090,7 +7823,7 @@ export TAR_OPTIONS
 rm -rf *
 
 
-test -z "`sort < /dev/null 2>&1`" || exit 77
+test -z \"\`sort < /dev/null 2>&1\`\" || exit 77
 
 
 rm -rf testdir exclfile
@@ -10115,48 +7848,8 @@ tar tf archive | sort
 rm -rf testdir exclfile
 
 )"
-echo exclude05.at:22 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir posix
-(cd posix
-TEST_TAR_FORMAT=posix
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H posix"
-export TAR_OPTIONS
-rm -rf *
-
-
-test -z "`sort < /dev/null 2>&1`" || exit 77
-
-
-rm -rf testdir exclfile
-mkdir -p testdir
-awk 'BEGIN {for (i=9; i < 100; ++i ) { print "testdir/file" i; }}' < /dev/null | \
- while read name
- do
-   genfile --file $name
- done
-
-awk 'BEGIN {for (i=1000000; i >= 12; --i ) { print "testdir/file" i }}' < /dev/null > exclfile
-
-tar cf archive --anchored --exclude-from=exclfile \
-               testdir
-tar tf archive | sort
-
-echo "NEXT"
-tar cf archive --exclude-from=exclfile \
-               testdir
-tar tf archive | sort
-
-rm -rf testdir exclfile
-
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'a `...` command substitution' "exclude05.at:22"
+( $at_check_trace;
 mkdir posix
 (cd posix
 TEST_TAR_FORMAT=posix
@@ -10190,11 +7883,11 @@ tar tf archive | sort
 
 rm -rf testdir exclfile
 
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "testdir/
 testdir/file10
 testdir/file11
@@ -10206,12 +7899,11 @@ testdir/file11
 testdir/file9
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/exclude05.at:22"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/exclude05.at:22"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/exclude05.at:22:
 mkdir gnu
 (cd gnu
@@ -10222,7 +7914,7 @@ export TAR_OPTIONS
 rm -rf *
 
 
-test -z "`sort < /dev/null 2>&1`" || exit 77
+test -z \"\`sort < /dev/null 2>&1\`\" || exit 77
 
 
 rm -rf testdir exclfile
@@ -10247,48 +7939,8 @@ tar tf archive | sort
 rm -rf testdir exclfile
 
 )"
-echo exclude05.at:22 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir gnu
-(cd gnu
-TEST_TAR_FORMAT=gnu
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H gnu"
-export TAR_OPTIONS
-rm -rf *
-
-
-test -z "`sort < /dev/null 2>&1`" || exit 77
-
-
-rm -rf testdir exclfile
-mkdir -p testdir
-awk 'BEGIN {for (i=9; i < 100; ++i ) { print "testdir/file" i; }}' < /dev/null | \
- while read name
- do
-   genfile --file $name
- done
-
-awk 'BEGIN {for (i=1000000; i >= 12; --i ) { print "testdir/file" i }}' < /dev/null > exclfile
-
-tar cf archive --anchored --exclude-from=exclfile \
-               testdir
-tar tf archive | sort
-
-echo "NEXT"
-tar cf archive --exclude-from=exclfile \
-               testdir
-tar tf archive | sort
-
-rm -rf testdir exclfile
-
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'a `...` command substitution' "exclude05.at:22"
+( $at_check_trace;
 mkdir gnu
 (cd gnu
 TEST_TAR_FORMAT=gnu
@@ -10322,11 +7974,11 @@ tar tf archive | sort
 
 rm -rf testdir exclfile
 
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "testdir/
 testdir/file10
 testdir/file11
@@ -10338,29 +7990,25 @@ testdir/file11
 testdir/file9
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/exclude05.at:22"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/exclude05.at:22"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
 
 
 
-  $at_traceoff
+  set +x
   $at_times_p && times >"$at_times_file"
-) 5>&1 2>&1 | eval $at_tee_pipe
-at_status=`cat "$at_status_file"`
+) 5>&1 2>&1 7>&- | eval $at_tee_pipe
+read at_status <"$at_status_file"
 #AT_STOP_20
 #AT_START_21
-# 21. exclude06.at:24: exclude: long files in pax archives
-at_setup_line='exclude06.at:24'
-at_desc="exclude: long files in pax archives"
-$at_quiet $as_echo_n " 21: $at_desc            "
+at_fn_group_banner 21 'exclude06.at:24' \
+  "exclude: long files in pax archives" "            "
 at_xfail=no
       test -f $XFAILFILE && at_xfail=yes
-echo "#                             -*- compilation -*-" >> "$at_group_log"
 (
-  $as_echo "21. exclude06.at:24: testing ..."
+  $as_echo "21. $at_setup_line: testing $at_desc ..."
   $at_traceon
 
 
@@ -10369,7 +8017,7 @@ echo "#                             -*-
 
 
 
-  { $at_traceoff
+  { set +x
 $as_echo "$at_srcdir/exclude06.at:29:
 mkdir pax
 (cd pax
@@ -10389,11 +8037,8 @@ mkdir out
 tar -C out -xf archive.tar --exclude='*.txt' --warning=no-timestamp
 find out -type f
 )"
-echo exclude06.at:29 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
+at_fn_check_prepare_notrace 'an embedded newline' "exclude06.at:29"
+( $at_check_trace;
 mkdir pax
 (cd pax
 TEST_TAR_FORMAT=pax
@@ -10411,65 +8056,40 @@ tar cf archive.tar one/two/three/four/fi
 mkdir out
 tar -C out -xf archive.tar --exclude='*.txt' --warning=no-timestamp
 find out -type f
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
-mkdir pax
-(cd pax
-TEST_TAR_FORMAT=pax
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H pax"
-export TAR_OPTIONS
-rm -rf *
-
-
-install-sh -d one/two/three/four/five/six/seven/eight/nine/ten/eleven/twelve/thirteen/fourteen/fifteen/sixteen/seventeen >/dev/null  || exit 77
-genfile --length 20 -f one/two/three/four/five/six/seven/eight/nine/ten/eleven/twelve/thirteen/fourteen/fifteen/sixteen/seventeen/1.txt
-genfile --length 20 -f one/two/three/four/five/six/seven/eight/nine/ten/eleven/twelve/thirteen/fourteen/fifteen/sixteen/seventeen/1.c
-
-tar cf archive.tar one/two/three/four/five/six/seven/eight/nine/ten/eleven/twelve/thirteen/fourteen/fifteen/sixteen/seventeen
-mkdir out
-tar -C out -xf archive.tar --exclude='*.txt' --warning=no-timestamp
-find out -type f
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "out/one/two/three/four/five/six/seven/eight/nine/ten/eleven/twelve/thirteen/fourteen/fifteen/sixteen/seventeen/1.c
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/exclude06.at:29"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/exclude06.at:29"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
 
 
 
-  $at_traceoff
+  set +x
   $at_times_p && times >"$at_times_file"
-) 5>&1 2>&1 | eval $at_tee_pipe
-at_status=`cat "$at_status_file"`
+) 5>&1 2>&1 7>&- | eval $at_tee_pipe
+read at_status <"$at_status_file"
 #AT_STOP_21
 #AT_START_22
-# 22. delete01.at:23: deleting a member after a big one
-at_setup_line='delete01.at:23'
-at_desc="deleting a member after a big one"
-$at_quiet $as_echo_n " 22: $at_desc              "
+at_fn_group_banner 22 'delete01.at:23' \
+  "deleting a member after a big one" "              "
 at_xfail=no
       test -f $XFAILFILE && at_xfail=yes
-echo "#                             -*- compilation -*-" >> "$at_group_log"
 (
-  $as_echo "22. delete01.at:23: testing ..."
+  $as_echo "22. $at_setup_line: testing $at_desc ..."
   $at_traceon
 
 
 
 
 
-  { $at_traceoff
+  { set +x
 $as_echo "$at_srcdir/delete01.at:26:
 mkdir v7
 (cd v7
@@ -10484,27 +8104,8 @@ genfile -l 1024 --file file2
 tar cf archive file1 file2
 tar f archive --delete file2
 tar tf archive)"
-echo delete01.at:26 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir v7
-(cd v7
-TEST_TAR_FORMAT=v7
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H v7"
-export TAR_OPTIONS
-rm -rf *
-
-genfile -l 50000 --file file1
-genfile -l 1024 --file file2
-tar cf archive file1 file2
-tar f archive --delete file2
-tar tf archive) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'an embedded newline' "delete01.at:26"
+( $at_check_trace;
 mkdir v7
 (cd v7
 TEST_TAR_FORMAT=v7
@@ -10517,20 +8118,19 @@ genfile -l 50000 --file file1
 genfile -l 1024 --file file2
 tar cf archive file1 file2
 tar f archive --delete file2
-tar tf archive) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+tar tf archive)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "file1
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/delete01.at:26"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/delete01.at:26"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/delete01.at:26:
 mkdir oldgnu
 (cd oldgnu
@@ -10545,27 +8145,8 @@ genfile -l 1024 --file file2
 tar cf archive file1 file2
 tar f archive --delete file2
 tar tf archive)"
-echo delete01.at:26 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir oldgnu
-(cd oldgnu
-TEST_TAR_FORMAT=oldgnu
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H oldgnu"
-export TAR_OPTIONS
-rm -rf *
-
-genfile -l 50000 --file file1
-genfile -l 1024 --file file2
-tar cf archive file1 file2
-tar f archive --delete file2
-tar tf archive) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'an embedded newline' "delete01.at:26"
+( $at_check_trace;
 mkdir oldgnu
 (cd oldgnu
 TEST_TAR_FORMAT=oldgnu
@@ -10578,20 +8159,19 @@ genfile -l 50000 --file file1
 genfile -l 1024 --file file2
 tar cf archive file1 file2
 tar f archive --delete file2
-tar tf archive) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+tar tf archive)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "file1
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/delete01.at:26"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/delete01.at:26"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/delete01.at:26:
 mkdir ustar
 (cd ustar
@@ -10606,11 +8186,8 @@ genfile -l 1024 --file file2
 tar cf archive file1 file2
 tar f archive --delete file2
 tar tf archive)"
-echo delete01.at:26 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
+at_fn_check_prepare_notrace 'an embedded newline' "delete01.at:26"
+( $at_check_trace;
 mkdir ustar
 (cd ustar
 TEST_TAR_FORMAT=ustar
@@ -10623,36 +8200,19 @@ genfile -l 50000 --file file1
 genfile -l 1024 --file file2
 tar cf archive file1 file2
 tar f archive --delete file2
-tar tf archive) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
-mkdir ustar
-(cd ustar
-TEST_TAR_FORMAT=ustar
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H ustar"
-export TAR_OPTIONS
-rm -rf *
-
-genfile -l 50000 --file file1
-genfile -l 1024 --file file2
-tar cf archive file1 file2
-tar f archive --delete file2
-tar tf archive) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+tar tf archive)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "file1
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/delete01.at:26"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/delete01.at:26"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/delete01.at:26:
 mkdir posix
 (cd posix
@@ -10667,27 +8227,8 @@ genfile -l 1024 --file file2
 tar cf archive file1 file2
 tar f archive --delete file2
 tar tf archive)"
-echo delete01.at:26 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir posix
-(cd posix
-TEST_TAR_FORMAT=posix
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H posix"
-export TAR_OPTIONS
-rm -rf *
-
-genfile -l 50000 --file file1
-genfile -l 1024 --file file2
-tar cf archive file1 file2
-tar f archive --delete file2
-tar tf archive) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'an embedded newline' "delete01.at:26"
+( $at_check_trace;
 mkdir posix
 (cd posix
 TEST_TAR_FORMAT=posix
@@ -10700,20 +8241,19 @@ genfile -l 50000 --file file1
 genfile -l 1024 --file file2
 tar cf archive file1 file2
 tar f archive --delete file2
-tar tf archive) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+tar tf archive)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "file1
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/delete01.at:26"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/delete01.at:26"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/delete01.at:26:
 mkdir gnu
 (cd gnu
@@ -10728,27 +8268,8 @@ genfile -l 1024 --file file2
 tar cf archive file1 file2
 tar f archive --delete file2
 tar tf archive)"
-echo delete01.at:26 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir gnu
-(cd gnu
-TEST_TAR_FORMAT=gnu
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H gnu"
-export TAR_OPTIONS
-rm -rf *
-
-genfile -l 50000 --file file1
-genfile -l 1024 --file file2
-tar cf archive file1 file2
-tar f archive --delete file2
-tar tf archive) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'an embedded newline' "delete01.at:26"
+( $at_check_trace;
 mkdir gnu
 (cd gnu
 TEST_TAR_FORMAT=gnu
@@ -10761,44 +8282,40 @@ genfile -l 50000 --file file1
 genfile -l 1024 --file file2
 tar cf archive file1 file2
 tar f archive --delete file2
-tar tf archive) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+tar tf archive)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "file1
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/delete01.at:26"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/delete01.at:26"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
 
 
 
-  $at_traceoff
+  set +x
   $at_times_p && times >"$at_times_file"
-) 5>&1 2>&1 | eval $at_tee_pipe
-at_status=`cat "$at_status_file"`
+) 5>&1 2>&1 7>&- | eval $at_tee_pipe
+read at_status <"$at_status_file"
 #AT_STOP_22
 #AT_START_23
-# 23. delete02.at:23: deleting a member from stdin archive
-at_setup_line='delete02.at:23'
-at_desc="deleting a member from stdin archive"
-$at_quiet $as_echo_n " 23: $at_desc           "
+at_fn_group_banner 23 'delete02.at:23' \
+  "deleting a member from stdin archive" "           "
 at_xfail=no
       test -f $XFAILFILE && at_xfail=yes
-echo "#                             -*- compilation -*-" >> "$at_group_log"
 (
-  $as_echo "23. delete02.at:23: testing ..."
+  $as_echo "23. $at_setup_line: testing $at_desc ..."
   $at_traceon
 
 
 
 
 
-  { $at_traceoff
+  { set +x
 $as_echo "$at_srcdir/delete02.at:26:
 mkdir v7
 (cd v7
@@ -10816,30 +8333,8 @@ tar tf archive
 cat archive | tar f - --delete 2 > archive2
 echo separator
 tar tf archive2)"
-echo delete02.at:26 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir v7
-(cd v7
-TEST_TAR_FORMAT=v7
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H v7"
-export TAR_OPTIONS
-rm -rf *
-
-genfile -l 3073 -p zeros --file 1
-cp 1 2
-cp 2 3
-tar cf archive 1 2 3
-tar tf archive
-cat archive | tar f - --delete 2 > archive2
-echo separator
-tar tf archive2) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'an embedded newline' "delete02.at:26"
+( $at_check_trace;
 mkdir v7
 (cd v7
 TEST_TAR_FORMAT=v7
@@ -10855,11 +8350,11 @@ tar cf archive 1 2 3
 tar tf archive
 cat archive | tar f - --delete 2 > archive2
 echo separator
-tar tf archive2) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+tar tf archive2)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "1
 2
 3
@@ -10868,12 +8363,11 @@ separator
 3
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/delete02.at:26"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/delete02.at:26"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/delete02.at:26:
 mkdir oldgnu
 (cd oldgnu
@@ -10891,30 +8385,8 @@ tar tf archive
 cat archive | tar f - --delete 2 > archive2
 echo separator
 tar tf archive2)"
-echo delete02.at:26 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir oldgnu
-(cd oldgnu
-TEST_TAR_FORMAT=oldgnu
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H oldgnu"
-export TAR_OPTIONS
-rm -rf *
-
-genfile -l 3073 -p zeros --file 1
-cp 1 2
-cp 2 3
-tar cf archive 1 2 3
-tar tf archive
-cat archive | tar f - --delete 2 > archive2
-echo separator
-tar tf archive2) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'an embedded newline' "delete02.at:26"
+( $at_check_trace;
 mkdir oldgnu
 (cd oldgnu
 TEST_TAR_FORMAT=oldgnu
@@ -10930,11 +8402,11 @@ tar cf archive 1 2 3
 tar tf archive
 cat archive | tar f - --delete 2 > archive2
 echo separator
-tar tf archive2) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+tar tf archive2)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "1
 2
 3
@@ -10943,12 +8415,11 @@ separator
 3
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/delete02.at:26"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/delete02.at:26"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/delete02.at:26:
 mkdir ustar
 (cd ustar
@@ -10966,30 +8437,8 @@ tar tf archive
 cat archive | tar f - --delete 2 > archive2
 echo separator
 tar tf archive2)"
-echo delete02.at:26 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir ustar
-(cd ustar
-TEST_TAR_FORMAT=ustar
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H ustar"
-export TAR_OPTIONS
-rm -rf *
-
-genfile -l 3073 -p zeros --file 1
-cp 1 2
-cp 2 3
-tar cf archive 1 2 3
-tar tf archive
-cat archive | tar f - --delete 2 > archive2
-echo separator
-tar tf archive2) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'an embedded newline' "delete02.at:26"
+( $at_check_trace;
 mkdir ustar
 (cd ustar
 TEST_TAR_FORMAT=ustar
@@ -11005,11 +8454,11 @@ tar cf archive 1 2 3
 tar tf archive
 cat archive | tar f - --delete 2 > archive2
 echo separator
-tar tf archive2) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+tar tf archive2)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "1
 2
 3
@@ -11018,12 +8467,11 @@ separator
 3
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/delete02.at:26"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/delete02.at:26"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/delete02.at:26:
 mkdir posix
 (cd posix
@@ -11041,30 +8489,8 @@ tar tf archive
 cat archive | tar f - --delete 2 > archive2
 echo separator
 tar tf archive2)"
-echo delete02.at:26 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir posix
-(cd posix
-TEST_TAR_FORMAT=posix
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H posix"
-export TAR_OPTIONS
-rm -rf *
-
-genfile -l 3073 -p zeros --file 1
-cp 1 2
-cp 2 3
-tar cf archive 1 2 3
-tar tf archive
-cat archive | tar f - --delete 2 > archive2
-echo separator
-tar tf archive2) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'an embedded newline' "delete02.at:26"
+( $at_check_trace;
 mkdir posix
 (cd posix
 TEST_TAR_FORMAT=posix
@@ -11080,11 +8506,11 @@ tar cf archive 1 2 3
 tar tf archive
 cat archive | tar f - --delete 2 > archive2
 echo separator
-tar tf archive2) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+tar tf archive2)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "1
 2
 3
@@ -11093,12 +8519,11 @@ separator
 3
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/delete02.at:26"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/delete02.at:26"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/delete02.at:26:
 mkdir gnu
 (cd gnu
@@ -11116,30 +8541,8 @@ tar tf archive
 cat archive | tar f - --delete 2 > archive2
 echo separator
 tar tf archive2)"
-echo delete02.at:26 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir gnu
-(cd gnu
-TEST_TAR_FORMAT=gnu
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H gnu"
-export TAR_OPTIONS
-rm -rf *
-
-genfile -l 3073 -p zeros --file 1
-cp 1 2
-cp 2 3
-tar cf archive 1 2 3
-tar tf archive
-cat archive | tar f - --delete 2 > archive2
-echo separator
-tar tf archive2) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'an embedded newline' "delete02.at:26"
+( $at_check_trace;
 mkdir gnu
 (cd gnu
 TEST_TAR_FORMAT=gnu
@@ -11155,11 +8558,11 @@ tar cf archive 1 2 3
 tar tf archive
 cat archive | tar f - --delete 2 > archive2
 echo separator
-tar tf archive2) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+tar tf archive2)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "1
 2
 3
@@ -11168,29 +8571,25 @@ separator
 3
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/delete02.at:26"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/delete02.at:26"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
 
 
 
-  $at_traceoff
+  set +x
   $at_times_p && times >"$at_times_file"
-) 5>&1 2>&1 | eval $at_tee_pipe
-at_status=`cat "$at_status_file"`
+) 5>&1 2>&1 7>&- | eval $at_tee_pipe
+read at_status <"$at_status_file"
 #AT_STOP_23
 #AT_START_24
-# 24. delete03.at:21: deleting members with long names
-at_setup_line='delete03.at:21'
-at_desc="deleting members with long names"
-$at_quiet $as_echo_n " 24: $at_desc               "
+at_fn_group_banner 24 'delete03.at:21' \
+  "deleting members with long names" "               "
 at_xfail=no
       test -f $XFAILFILE && at_xfail=yes
-echo "#                             -*- compilation -*-" >> "$at_group_log"
 (
-  $as_echo "24. delete03.at:21: testing ..."
+  $as_echo "24. $at_setup_line: testing $at_desc ..."
   $at_traceon
 
 
@@ -11199,7 +8598,7 @@ echo "#                             -*-
 
 
 
-  { $at_traceoff
+  { set +x
 $as_echo "$at_srcdir/delete03.at:26:
 mkdir gnu
 (cd gnu
@@ -11219,32 +8618,8 @@ tar -cf archive ./\$prefix* &&
  tar --delete -f archive ./\${prefix}5 &&
  tar -tf archive
 )"
-echo delete03.at:26 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains a ${...} parameter expansion)'
-   false; }; then
-  ( $at_traceon;
-mkdir gnu
-(cd gnu
-TEST_TAR_FORMAT=gnu
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H gnu"
-export TAR_OPTIONS
-rm -rf *
-
-
-prefix=This_is_a_very_long_file_name_prefix_that_is_designed_to_cause_problems_with_file_names_that_run_into_a_limit_of_the_posix_tar_formatXX
-rm -f $prefix*
-for i in 1 2 3 4 5 6 7 8 9
-do touch $prefix$i
-done
-tar -cf archive ./$prefix* &&
- tar --delete -f archive ./${prefix}5 &&
- tar -tf archive
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'a ${...} parameter expansion' "delete03.at:26"
+( $at_check_trace;
 mkdir gnu
 (cd gnu
 TEST_TAR_FORMAT=gnu
@@ -11262,11 +8637,11 @@ done
 tar -cf archive ./$prefix* &&
  tar --delete -f archive ./${prefix}5 &&
  tar -tf archive
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "./This_is_a_very_long_file_name_prefix_that_is_designed_to_cause_problems_with_file_names_that_run_into_a_limit_of_the_posix_tar_formatXX1
 ./This_is_a_very_long_file_name_prefix_that_is_designed_to_cause_problems_with_file_names_that_run_into_a_limit_of_the_posix_tar_formatXX2
 ./This_is_a_very_long_file_name_prefix_that_is_designed_to_cause_problems_with_file_names_that_run_into_a_limit_of_the_posix_tar_formatXX3
@@ -11277,12 +8652,11 @@ echo >>"$at_stdout"; $as_echo "./This_is
 ./This_is_a_very_long_file_name_prefix_that_is_designed_to_cause_problems_with_file_names_that_run_into_a_limit_of_the_posix_tar_formatXX9
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/delete03.at:26"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/delete03.at:26"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/delete03.at:26:
 mkdir oldgnu
 (cd oldgnu
@@ -11302,32 +8676,8 @@ tar -cf archive ./\$prefix* &&
  tar --delete -f archive ./\${prefix}5 &&
  tar -tf archive
 )"
-echo delete03.at:26 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains a ${...} parameter expansion)'
-   false; }; then
-  ( $at_traceon;
-mkdir oldgnu
-(cd oldgnu
-TEST_TAR_FORMAT=oldgnu
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H oldgnu"
-export TAR_OPTIONS
-rm -rf *
-
-
-prefix=This_is_a_very_long_file_name_prefix_that_is_designed_to_cause_problems_with_file_names_that_run_into_a_limit_of_the_posix_tar_formatXX
-rm -f $prefix*
-for i in 1 2 3 4 5 6 7 8 9
-do touch $prefix$i
-done
-tar -cf archive ./$prefix* &&
- tar --delete -f archive ./${prefix}5 &&
- tar -tf archive
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'a ${...} parameter expansion' "delete03.at:26"
+( $at_check_trace;
 mkdir oldgnu
 (cd oldgnu
 TEST_TAR_FORMAT=oldgnu
@@ -11345,11 +8695,11 @@ done
 tar -cf archive ./$prefix* &&
  tar --delete -f archive ./${prefix}5 &&
  tar -tf archive
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "./This_is_a_very_long_file_name_prefix_that_is_designed_to_cause_problems_with_file_names_that_run_into_a_limit_of_the_posix_tar_formatXX1
 ./This_is_a_very_long_file_name_prefix_that_is_designed_to_cause_problems_with_file_names_that_run_into_a_limit_of_the_posix_tar_formatXX2
 ./This_is_a_very_long_file_name_prefix_that_is_designed_to_cause_problems_with_file_names_that_run_into_a_limit_of_the_posix_tar_formatXX3
@@ -11360,12 +8710,11 @@ echo >>"$at_stdout"; $as_echo "./This_is
 ./This_is_a_very_long_file_name_prefix_that_is_designed_to_cause_problems_with_file_names_that_run_into_a_limit_of_the_posix_tar_formatXX9
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/delete03.at:26"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/delete03.at:26"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/delete03.at:26:
 mkdir posix
 (cd posix
@@ -11385,32 +8734,8 @@ tar -cf archive ./\$prefix* &&
  tar --delete -f archive ./\${prefix}5 &&
  tar -tf archive
 )"
-echo delete03.at:26 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains a ${...} parameter expansion)'
-   false; }; then
-  ( $at_traceon;
-mkdir posix
-(cd posix
-TEST_TAR_FORMAT=posix
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H posix"
-export TAR_OPTIONS
-rm -rf *
-
-
-prefix=This_is_a_very_long_file_name_prefix_that_is_designed_to_cause_problems_with_file_names_that_run_into_a_limit_of_the_posix_tar_formatXX
-rm -f $prefix*
-for i in 1 2 3 4 5 6 7 8 9
-do touch $prefix$i
-done
-tar -cf archive ./$prefix* &&
- tar --delete -f archive ./${prefix}5 &&
- tar -tf archive
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'a ${...} parameter expansion' "delete03.at:26"
+( $at_check_trace;
 mkdir posix
 (cd posix
 TEST_TAR_FORMAT=posix
@@ -11428,11 +8753,11 @@ done
 tar -cf archive ./$prefix* &&
  tar --delete -f archive ./${prefix}5 &&
  tar -tf archive
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "./This_is_a_very_long_file_name_prefix_that_is_designed_to_cause_problems_with_file_names_that_run_into_a_limit_of_the_posix_tar_formatXX1
 ./This_is_a_very_long_file_name_prefix_that_is_designed_to_cause_problems_with_file_names_that_run_into_a_limit_of_the_posix_tar_formatXX2
 ./This_is_a_very_long_file_name_prefix_that_is_designed_to_cause_problems_with_file_names_that_run_into_a_limit_of_the_posix_tar_formatXX3
@@ -11443,36 +8768,32 @@ echo >>"$at_stdout"; $as_echo "./This_is
 ./This_is_a_very_long_file_name_prefix_that_is_designed_to_cause_problems_with_file_names_that_run_into_a_limit_of_the_posix_tar_formatXX9
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/delete03.at:26"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/delete03.at:26"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
 
 
 
-  $at_traceoff
+  set +x
   $at_times_p && times >"$at_times_file"
-) 5>&1 2>&1 | eval $at_tee_pipe
-at_status=`cat "$at_status_file"`
+) 5>&1 2>&1 7>&- | eval $at_tee_pipe
+read at_status <"$at_status_file"
 #AT_STOP_24
 #AT_START_25
-# 25. delete04.at:23: deleting a large last member
-at_setup_line='delete04.at:23'
-at_desc="deleting a large last member"
-$at_quiet $as_echo_n " 25: $at_desc                   "
+at_fn_group_banner 25 'delete04.at:23' \
+  "deleting a large last member" "                   "
 at_xfail=no
       test -f $XFAILFILE && at_xfail=yes
-echo "#                             -*- compilation -*-" >> "$at_group_log"
 (
-  $as_echo "25. delete04.at:23: testing ..."
+  $as_echo "25. $at_setup_line: testing $at_desc ..."
   $at_traceon
 
 
 
 
 
-  { $at_traceoff
+  { set +x
 $as_echo "$at_srcdir/delete04.at:26:
 mkdir v7
 (cd v7
@@ -11496,36 +8817,8 @@ tar cf archive file1 file2 file3 file4 f
 tar f archive --delete file10
 tar tf archive
 )"
-echo delete04.at:26 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir v7
-(cd v7
-TEST_TAR_FORMAT=v7
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H v7"
-export TAR_OPTIONS
-rm -rf *
-
-genfile -l      3 -f file1
-genfile -l      5 -f file2
-genfile -l      3 -f file3
-genfile -l      6 -f file4
-genfile -l     24 -f file5
-genfile -l     13 -f file6
-genfile -l   1385 -f file7
-genfile -l     30 -f file8
-genfile -l     10 -f file9
-genfile -l 256000 -f file10
-tar cf archive file1 file2 file3 file4 file5 file6 file7 file8 file9 file10
-tar f archive --delete file10
-tar tf archive
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'an embedded newline' "delete04.at:26"
+( $at_check_trace;
 mkdir v7
 (cd v7
 TEST_TAR_FORMAT=v7
@@ -11547,11 +8840,11 @@ genfile -l 256000 -f file10
 tar cf archive file1 file2 file3 file4 file5 file6 file7 file8 file9 file10
 tar f archive --delete file10
 tar tf archive
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "file1
 file2
 file3
@@ -11563,12 +8856,11 @@ file8
 file9
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/delete04.at:26"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/delete04.at:26"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/delete04.at:26:
 mkdir oldgnu
 (cd oldgnu
@@ -11592,36 +8884,8 @@ tar cf archive file1 file2 file3 file4 f
 tar f archive --delete file10
 tar tf archive
 )"
-echo delete04.at:26 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir oldgnu
-(cd oldgnu
-TEST_TAR_FORMAT=oldgnu
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H oldgnu"
-export TAR_OPTIONS
-rm -rf *
-
-genfile -l      3 -f file1
-genfile -l      5 -f file2
-genfile -l      3 -f file3
-genfile -l      6 -f file4
-genfile -l     24 -f file5
-genfile -l     13 -f file6
-genfile -l   1385 -f file7
-genfile -l     30 -f file8
-genfile -l     10 -f file9
-genfile -l 256000 -f file10
-tar cf archive file1 file2 file3 file4 file5 file6 file7 file8 file9 file10
-tar f archive --delete file10
-tar tf archive
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'an embedded newline' "delete04.at:26"
+( $at_check_trace;
 mkdir oldgnu
 (cd oldgnu
 TEST_TAR_FORMAT=oldgnu
@@ -11643,11 +8907,11 @@ genfile -l 256000 -f file10
 tar cf archive file1 file2 file3 file4 file5 file6 file7 file8 file9 file10
 tar f archive --delete file10
 tar tf archive
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "file1
 file2
 file3
@@ -11659,12 +8923,11 @@ file8
 file9
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/delete04.at:26"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/delete04.at:26"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/delete04.at:26:
 mkdir ustar
 (cd ustar
@@ -11688,11 +8951,8 @@ tar cf archive file1 file2 file3 file4 f
 tar f archive --delete file10
 tar tf archive
 )"
-echo delete04.at:26 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
+at_fn_check_prepare_notrace 'an embedded newline' "delete04.at:26"
+( $at_check_trace;
 mkdir ustar
 (cd ustar
 TEST_TAR_FORMAT=ustar
@@ -11714,36 +8974,11 @@ genfile -l 256000 -f file10
 tar cf archive file1 file2 file3 file4 file5 file6 file7 file8 file9 file10
 tar f archive --delete file10
 tar tf archive
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
-mkdir ustar
-(cd ustar
-TEST_TAR_FORMAT=ustar
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H ustar"
-export TAR_OPTIONS
-rm -rf *
-
-genfile -l      3 -f file1
-genfile -l      5 -f file2
-genfile -l      3 -f file3
-genfile -l      6 -f file4
-genfile -l     24 -f file5
-genfile -l     13 -f file6
-genfile -l   1385 -f file7
-genfile -l     30 -f file8
-genfile -l     10 -f file9
-genfile -l 256000 -f file10
-tar cf archive file1 file2 file3 file4 file5 file6 file7 file8 file9 file10
-tar f archive --delete file10
-tar tf archive
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "file1
 file2
 file3
@@ -11755,12 +8990,11 @@ file8
 file9
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/delete04.at:26"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/delete04.at:26"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/delete04.at:26:
 mkdir posix
 (cd posix
@@ -11784,36 +9018,8 @@ tar cf archive file1 file2 file3 file4 f
 tar f archive --delete file10
 tar tf archive
 )"
-echo delete04.at:26 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir posix
-(cd posix
-TEST_TAR_FORMAT=posix
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H posix"
-export TAR_OPTIONS
-rm -rf *
-
-genfile -l      3 -f file1
-genfile -l      5 -f file2
-genfile -l      3 -f file3
-genfile -l      6 -f file4
-genfile -l     24 -f file5
-genfile -l     13 -f file6
-genfile -l   1385 -f file7
-genfile -l     30 -f file8
-genfile -l     10 -f file9
-genfile -l 256000 -f file10
-tar cf archive file1 file2 file3 file4 file5 file6 file7 file8 file9 file10
-tar f archive --delete file10
-tar tf archive
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'an embedded newline' "delete04.at:26"
+( $at_check_trace;
 mkdir posix
 (cd posix
 TEST_TAR_FORMAT=posix
@@ -11835,11 +9041,11 @@ genfile -l 256000 -f file10
 tar cf archive file1 file2 file3 file4 file5 file6 file7 file8 file9 file10
 tar f archive --delete file10
 tar tf archive
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "file1
 file2
 file3
@@ -11851,12 +9057,11 @@ file8
 file9
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/delete04.at:26"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/delete04.at:26"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/delete04.at:26:
 mkdir gnu
 (cd gnu
@@ -11880,36 +9085,8 @@ tar cf archive file1 file2 file3 file4 f
 tar f archive --delete file10
 tar tf archive
 )"
-echo delete04.at:26 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir gnu
-(cd gnu
-TEST_TAR_FORMAT=gnu
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H gnu"
-export TAR_OPTIONS
-rm -rf *
-
-genfile -l      3 -f file1
-genfile -l      5 -f file2
-genfile -l      3 -f file3
-genfile -l      6 -f file4
-genfile -l     24 -f file5
-genfile -l     13 -f file6
-genfile -l   1385 -f file7
-genfile -l     30 -f file8
-genfile -l     10 -f file9
-genfile -l 256000 -f file10
-tar cf archive file1 file2 file3 file4 file5 file6 file7 file8 file9 file10
-tar f archive --delete file10
-tar tf archive
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'an embedded newline' "delete04.at:26"
+( $at_check_trace;
 mkdir gnu
 (cd gnu
 TEST_TAR_FORMAT=gnu
@@ -11931,11 +9108,11 @@ genfile -l 256000 -f file10
 tar cf archive file1 file2 file3 file4 file5 file6 file7 file8 file9 file10
 tar f archive --delete file10
 tar tf archive
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "file1
 file2
 file3
@@ -11947,36 +9124,32 @@ file8
 file9
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/delete04.at:26"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/delete04.at:26"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
 
 
 
-  $at_traceoff
+  set +x
   $at_times_p && times >"$at_times_file"
-) 5>&1 2>&1 | eval $at_tee_pipe
-at_status=`cat "$at_status_file"`
+) 5>&1 2>&1 7>&- | eval $at_tee_pipe
+read at_status <"$at_status_file"
 #AT_STOP_25
 #AT_START_26
-# 26. delete05.at:27: deleting non-existing member
-at_setup_line='delete05.at:27'
-at_desc="deleting non-existing member"
-$at_quiet $as_echo_n " 26: $at_desc                   "
+at_fn_group_banner 26 'delete05.at:27' \
+  "deleting non-existing member" "                   "
 at_xfail=no
       test -f $XFAILFILE && at_xfail=yes
-echo "#                             -*- compilation -*-" >> "$at_group_log"
 (
-  $as_echo "26. delete05.at:27: testing ..."
+  $as_echo "26. $at_setup_line: testing $at_desc ..."
   $at_traceon
 
 
 
 
 
-  { $at_traceoff
+  { set +x
 $as_echo "$at_srcdir/delete05.at:30:
 mkdir v7
 (cd v7
@@ -11995,11 +9168,8 @@ tar cf archive en to
 tar --file archive --blocking-factor=20 --delete tre
 tar tf archive
 )"
-echo delete05.at:30 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
+at_fn_check_prepare_notrace 'an embedded newline' "delete05.at:30"
+( $at_check_trace;
 mkdir v7
 (cd v7
 TEST_TAR_FORMAT=v7
@@ -12016,30 +9186,10 @@ tar cf archive en to
 # GNU tar up to and including 1.14.91 produced an empty archive this way:
 tar --file archive --blocking-factor=20 --delete tre
 tar tf archive
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
-mkdir v7
-(cd v7
-TEST_TAR_FORMAT=v7
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H v7"
-export TAR_OPTIONS
-rm -rf *
-
-genfile -l 1024 -f en
-genfile -l 1024 -f to
-
-tar cf archive en to
-# Make sure we don't use bogus blocking factor.
-# GNU tar up to and including 1.14.91 produced an empty archive this way:
-tar --file archive --blocking-factor=20 --delete tre
-tar tf archive
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
 echo >>"$at_stderr"; $as_echo "tar: tre: Not found in archive
 tar: Exiting with failure status due to previous errors
 " | \
@@ -12048,12 +9198,11 @@ echo >>"$at_stdout"; $as_echo "en
 to
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/delete05.at:30"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/delete05.at:30"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/delete05.at:30:
 mkdir oldgnu
 (cd oldgnu
@@ -12072,31 +9221,8 @@ tar cf archive en to
 tar --file archive --blocking-factor=20 --delete tre
 tar tf archive
 )"
-echo delete05.at:30 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir oldgnu
-(cd oldgnu
-TEST_TAR_FORMAT=oldgnu
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H oldgnu"
-export TAR_OPTIONS
-rm -rf *
-
-genfile -l 1024 -f en
-genfile -l 1024 -f to
-
-tar cf archive en to
-# Make sure we don't use bogus blocking factor.
-# GNU tar up to and including 1.14.91 produced an empty archive this way:
-tar --file archive --blocking-factor=20 --delete tre
-tar tf archive
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'an embedded newline' "delete05.at:30"
+( $at_check_trace;
 mkdir oldgnu
 (cd oldgnu
 TEST_TAR_FORMAT=oldgnu
@@ -12113,10 +9239,10 @@ tar cf archive en to
 # GNU tar up to and including 1.14.91 produced an empty archive this way:
 tar --file archive --blocking-factor=20 --delete tre
 tar tf archive
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
 echo >>"$at_stderr"; $as_echo "tar: tre: Not found in archive
 tar: Exiting with failure status due to previous errors
 " | \
@@ -12125,12 +9251,11 @@ echo >>"$at_stdout"; $as_echo "en
 to
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/delete05.at:30"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/delete05.at:30"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/delete05.at:30:
 mkdir ustar
 (cd ustar
@@ -12149,31 +9274,8 @@ tar cf archive en to
 tar --file archive --blocking-factor=20 --delete tre
 tar tf archive
 )"
-echo delete05.at:30 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir ustar
-(cd ustar
-TEST_TAR_FORMAT=ustar
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H ustar"
-export TAR_OPTIONS
-rm -rf *
-
-genfile -l 1024 -f en
-genfile -l 1024 -f to
-
-tar cf archive en to
-# Make sure we don't use bogus blocking factor.
-# GNU tar up to and including 1.14.91 produced an empty archive this way:
-tar --file archive --blocking-factor=20 --delete tre
-tar tf archive
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'an embedded newline' "delete05.at:30"
+( $at_check_trace;
 mkdir ustar
 (cd ustar
 TEST_TAR_FORMAT=ustar
@@ -12190,10 +9292,10 @@ tar cf archive en to
 # GNU tar up to and including 1.14.91 produced an empty archive this way:
 tar --file archive --blocking-factor=20 --delete tre
 tar tf archive
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
 echo >>"$at_stderr"; $as_echo "tar: tre: Not found in archive
 tar: Exiting with failure status due to previous errors
 " | \
@@ -12202,12 +9304,11 @@ echo >>"$at_stdout"; $as_echo "en
 to
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/delete05.at:30"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/delete05.at:30"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/delete05.at:30:
 mkdir posix
 (cd posix
@@ -12226,31 +9327,8 @@ tar cf archive en to
 tar --file archive --blocking-factor=20 --delete tre
 tar tf archive
 )"
-echo delete05.at:30 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir posix
-(cd posix
-TEST_TAR_FORMAT=posix
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H posix"
-export TAR_OPTIONS
-rm -rf *
-
-genfile -l 1024 -f en
-genfile -l 1024 -f to
-
-tar cf archive en to
-# Make sure we don't use bogus blocking factor.
-# GNU tar up to and including 1.14.91 produced an empty archive this way:
-tar --file archive --blocking-factor=20 --delete tre
-tar tf archive
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'an embedded newline' "delete05.at:30"
+( $at_check_trace;
 mkdir posix
 (cd posix
 TEST_TAR_FORMAT=posix
@@ -12267,10 +9345,10 @@ tar cf archive en to
 # GNU tar up to and including 1.14.91 produced an empty archive this way:
 tar --file archive --blocking-factor=20 --delete tre
 tar tf archive
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
 echo >>"$at_stderr"; $as_echo "tar: tre: Not found in archive
 tar: Exiting with failure status due to previous errors
 " | \
@@ -12279,12 +9357,11 @@ echo >>"$at_stdout"; $as_echo "en
 to
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/delete05.at:30"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/delete05.at:30"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/delete05.at:30:
 mkdir gnu
 (cd gnu
@@ -12303,31 +9380,8 @@ tar cf archive en to
 tar --file archive --blocking-factor=20 --delete tre
 tar tf archive
 )"
-echo delete05.at:30 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir gnu
-(cd gnu
-TEST_TAR_FORMAT=gnu
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H gnu"
-export TAR_OPTIONS
-rm -rf *
-
-genfile -l 1024 -f en
-genfile -l 1024 -f to
-
-tar cf archive en to
-# Make sure we don't use bogus blocking factor.
-# GNU tar up to and including 1.14.91 produced an empty archive this way:
-tar --file archive --blocking-factor=20 --delete tre
-tar tf archive
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'an embedded newline' "delete05.at:30"
+( $at_check_trace;
 mkdir gnu
 (cd gnu
 TEST_TAR_FORMAT=gnu
@@ -12344,10 +9398,10 @@ tar cf archive en to
 # GNU tar up to and including 1.14.91 produced an empty archive this way:
 tar --file archive --blocking-factor=20 --delete tre
 tar tf archive
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
 echo >>"$at_stderr"; $as_echo "tar: tre: Not found in archive
 tar: Exiting with failure status due to previous errors
 " | \
@@ -12356,36 +9410,32 @@ echo >>"$at_stdout"; $as_echo "en
 to
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/delete05.at:30"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/delete05.at:30"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
 
 
 
-  $at_traceoff
+  set +x
   $at_times_p && times >"$at_times_file"
-) 5>&1 2>&1 | eval $at_tee_pipe
-at_status=`cat "$at_status_file"`
+) 5>&1 2>&1 7>&- | eval $at_tee_pipe
+read at_status <"$at_status_file"
 #AT_STOP_26
 #AT_START_27
-# 27. extrac01.at:23: extract over an existing directory
-at_setup_line='extrac01.at:23'
-at_desc="extract over an existing directory"
-$at_quiet $as_echo_n " 27: $at_desc             "
+at_fn_group_banner 27 'extrac01.at:23' \
+  "extract over an existing directory" "             "
 at_xfail=no
       test -f $XFAILFILE && at_xfail=yes
-echo "#                             -*- compilation -*-" >> "$at_group_log"
 (
-  $as_echo "27. extrac01.at:23: testing ..."
+  $as_echo "27. $at_setup_line: testing $at_desc ..."
   $at_traceon
 
 
 
 
 
-  { $at_traceoff
+  { set +x
 $as_echo "$at_srcdir/extrac01.at:26:
 mkdir v7
 (cd v7
@@ -12400,27 +9450,8 @@ touch directory/file
 tar cf archive directory || exit 1
 tar xf archive --warning=no-timestamp || exit 1
 )"
-echo extrac01.at:26 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir v7
-(cd v7
-TEST_TAR_FORMAT=v7
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H v7"
-export TAR_OPTIONS
-rm -rf *
-
-mkdir directory
-touch directory/file
-tar cf archive directory || exit 1
-tar xf archive --warning=no-timestamp || exit 1
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'an embedded newline' "extrac01.at:26"
+( $at_check_trace;
 mkdir v7
 (cd v7
 TEST_TAR_FORMAT=v7
@@ -12433,18 +9464,17 @@ mkdir directory
 touch directory/file
 tar cf archive directory || exit 1
 tar xf archive --warning=no-timestamp || exit 1
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
-at_func_diff_devnull "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/extrac01.at:26"
-
-$at_failed && at_func_log_failure
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
+at_fn_diff_devnull "$at_stdout" || at_failed=:
+at_fn_check_status 0 $at_status "$at_srcdir/extrac01.at:26"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/extrac01.at:26:
 mkdir oldgnu
 (cd oldgnu
@@ -12459,27 +9489,8 @@ touch directory/file
 tar cf archive directory || exit 1
 tar xf archive --warning=no-timestamp || exit 1
 )"
-echo extrac01.at:26 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir oldgnu
-(cd oldgnu
-TEST_TAR_FORMAT=oldgnu
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H oldgnu"
-export TAR_OPTIONS
-rm -rf *
-
-mkdir directory
-touch directory/file
-tar cf archive directory || exit 1
-tar xf archive --warning=no-timestamp || exit 1
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'an embedded newline' "extrac01.at:26"
+( $at_check_trace;
 mkdir oldgnu
 (cd oldgnu
 TEST_TAR_FORMAT=oldgnu
@@ -12492,18 +9503,17 @@ mkdir directory
 touch directory/file
 tar cf archive directory || exit 1
 tar xf archive --warning=no-timestamp || exit 1
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
-at_func_diff_devnull "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/extrac01.at:26"
-
-$at_failed && at_func_log_failure
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
+at_fn_diff_devnull "$at_stdout" || at_failed=:
+at_fn_check_status 0 $at_status "$at_srcdir/extrac01.at:26"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/extrac01.at:26:
 mkdir ustar
 (cd ustar
@@ -12518,27 +9528,8 @@ touch directory/file
 tar cf archive directory || exit 1
 tar xf archive --warning=no-timestamp || exit 1
 )"
-echo extrac01.at:26 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir ustar
-(cd ustar
-TEST_TAR_FORMAT=ustar
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H ustar"
-export TAR_OPTIONS
-rm -rf *
-
-mkdir directory
-touch directory/file
-tar cf archive directory || exit 1
-tar xf archive --warning=no-timestamp || exit 1
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'an embedded newline' "extrac01.at:26"
+( $at_check_trace;
 mkdir ustar
 (cd ustar
 TEST_TAR_FORMAT=ustar
@@ -12551,18 +9542,17 @@ mkdir directory
 touch directory/file
 tar cf archive directory || exit 1
 tar xf archive --warning=no-timestamp || exit 1
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
-at_func_diff_devnull "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/extrac01.at:26"
-
-$at_failed && at_func_log_failure
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
+at_fn_diff_devnull "$at_stdout" || at_failed=:
+at_fn_check_status 0 $at_status "$at_srcdir/extrac01.at:26"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/extrac01.at:26:
 mkdir posix
 (cd posix
@@ -12577,27 +9567,8 @@ touch directory/file
 tar cf archive directory || exit 1
 tar xf archive --warning=no-timestamp || exit 1
 )"
-echo extrac01.at:26 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir posix
-(cd posix
-TEST_TAR_FORMAT=posix
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H posix"
-export TAR_OPTIONS
-rm -rf *
-
-mkdir directory
-touch directory/file
-tar cf archive directory || exit 1
-tar xf archive --warning=no-timestamp || exit 1
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'an embedded newline' "extrac01.at:26"
+( $at_check_trace;
 mkdir posix
 (cd posix
 TEST_TAR_FORMAT=posix
@@ -12610,18 +9581,17 @@ mkdir directory
 touch directory/file
 tar cf archive directory || exit 1
 tar xf archive --warning=no-timestamp || exit 1
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
-at_func_diff_devnull "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/extrac01.at:26"
-
-$at_failed && at_func_log_failure
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
+at_fn_diff_devnull "$at_stdout" || at_failed=:
+at_fn_check_status 0 $at_status "$at_srcdir/extrac01.at:26"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/extrac01.at:26:
 mkdir gnu
 (cd gnu
@@ -12636,27 +9606,8 @@ touch directory/file
 tar cf archive directory || exit 1
 tar xf archive --warning=no-timestamp || exit 1
 )"
-echo extrac01.at:26 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir gnu
-(cd gnu
-TEST_TAR_FORMAT=gnu
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H gnu"
-export TAR_OPTIONS
-rm -rf *
-
-mkdir directory
-touch directory/file
-tar cf archive directory || exit 1
-tar xf archive --warning=no-timestamp || exit 1
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'an embedded newline' "extrac01.at:26"
+( $at_check_trace;
 mkdir gnu
 (cd gnu
 TEST_TAR_FORMAT=gnu
@@ -12669,35 +9620,31 @@ mkdir directory
 touch directory/file
 tar cf archive directory || exit 1
 tar xf archive --warning=no-timestamp || exit 1
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
-at_func_diff_devnull "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/extrac01.at:26"
-
-$at_failed && at_func_log_failure
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
+at_fn_diff_devnull "$at_stdout" || at_failed=:
+at_fn_check_status 0 $at_status "$at_srcdir/extrac01.at:26"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
 
 
 
-  $at_traceoff
+  set +x
   $at_times_p && times >"$at_times_file"
-) 5>&1 2>&1 | eval $at_tee_pipe
-at_status=`cat "$at_status_file"`
+) 5>&1 2>&1 7>&- | eval $at_tee_pipe
+read at_status <"$at_status_file"
 #AT_STOP_27
 #AT_START_28
-# 28. extrac02.at:23: extracting symlinks over an existing file
-at_setup_line='extrac02.at:23'
-at_desc="extracting symlinks over an existing file"
-$at_quiet $as_echo_n " 28: $at_desc      "
+at_fn_group_banner 28 'extrac02.at:23' \
+  "extracting symlinks over an existing file" "      "
 at_xfail=no
       test -f $XFAILFILE && at_xfail=yes
-echo "#                             -*- compilation -*-" >> "$at_group_log"
 (
-  $as_echo "28. extrac02.at:23: testing ..."
+  $as_echo "28. $at_setup_line: testing $at_desc ..."
   $at_traceon
 
 
@@ -12706,7 +9653,7 @@ echo "#                             -*-
 
 
 
-  { $at_traceoff
+  { set +x
 $as_echo "$at_srcdir/extrac02.at:28:
 mkdir v7
 (cd v7
@@ -12723,11 +9670,8 @@ rm link
 touch link
 tar xf archive
 )"
-echo extrac02.at:28 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
+at_fn_check_prepare_notrace 'an embedded newline' "extrac02.at:28"
+( $at_check_trace;
 mkdir v7
 (cd v7
 TEST_TAR_FORMAT=v7
@@ -12742,42 +9686,23 @@ tar cf archive link
 rm link
 touch link
 tar xf archive
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
-mkdir v7
-(cd v7
-TEST_TAR_FORMAT=v7
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
+at_fn_diff_devnull "$at_stdout" || at_failed=:
+at_fn_check_status 0 $at_status "$at_srcdir/extrac02.at:28"
+$at_failed && at_fn_log_failure
+$at_traceon; }
+
+              { set +x
+$as_echo "$at_srcdir/extrac02.at:28:
+mkdir oldgnu
+(cd oldgnu
+TEST_TAR_FORMAT=oldgnu
 export TEST_TAR_FORMAT
-TAR_OPTIONS="-H v7"
-export TAR_OPTIONS
-rm -rf *
-
-touch file
-ln -s file link 2> /dev/null || ln file link
-tar cf archive link
-rm link
-touch link
-tar xf archive
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
-at_func_diff_devnull "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/extrac02.at:28"
-
-$at_failed && at_func_log_failure
-$at_traceon; }
-
-              { $at_traceoff
-$as_echo "$at_srcdir/extrac02.at:28:
-mkdir oldgnu
-(cd oldgnu
-TEST_TAR_FORMAT=oldgnu
-export TEST_TAR_FORMAT
-TAR_OPTIONS=\"-H oldgnu\"
+TAR_OPTIONS=\"-H oldgnu\"
 export TAR_OPTIONS
 rm -rf *
 
@@ -12788,29 +9713,8 @@ rm link
 touch link
 tar xf archive
 )"
-echo extrac02.at:28 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir oldgnu
-(cd oldgnu
-TEST_TAR_FORMAT=oldgnu
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H oldgnu"
-export TAR_OPTIONS
-rm -rf *
-
-touch file
-ln -s file link 2> /dev/null || ln file link
-tar cf archive link
-rm link
-touch link
-tar xf archive
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'an embedded newline' "extrac02.at:28"
+( $at_check_trace;
 mkdir oldgnu
 (cd oldgnu
 TEST_TAR_FORMAT=oldgnu
@@ -12825,18 +9729,17 @@ tar cf archive link
 rm link
 touch link
 tar xf archive
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
-at_func_diff_devnull "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/extrac02.at:28"
-
-$at_failed && at_func_log_failure
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
+at_fn_diff_devnull "$at_stdout" || at_failed=:
+at_fn_check_status 0 $at_status "$at_srcdir/extrac02.at:28"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/extrac02.at:28:
 mkdir ustar
 (cd ustar
@@ -12853,29 +9756,8 @@ rm link
 touch link
 tar xf archive
 )"
-echo extrac02.at:28 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir ustar
-(cd ustar
-TEST_TAR_FORMAT=ustar
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H ustar"
-export TAR_OPTIONS
-rm -rf *
-
-touch file
-ln -s file link 2> /dev/null || ln file link
-tar cf archive link
-rm link
-touch link
-tar xf archive
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'an embedded newline' "extrac02.at:28"
+( $at_check_trace;
 mkdir ustar
 (cd ustar
 TEST_TAR_FORMAT=ustar
@@ -12890,18 +9772,17 @@ tar cf archive link
 rm link
 touch link
 tar xf archive
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
-at_func_diff_devnull "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/extrac02.at:28"
-
-$at_failed && at_func_log_failure
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
+at_fn_diff_devnull "$at_stdout" || at_failed=:
+at_fn_check_status 0 $at_status "$at_srcdir/extrac02.at:28"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/extrac02.at:28:
 mkdir posix
 (cd posix
@@ -12918,29 +9799,8 @@ rm link
 touch link
 tar xf archive
 )"
-echo extrac02.at:28 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir posix
-(cd posix
-TEST_TAR_FORMAT=posix
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H posix"
-export TAR_OPTIONS
-rm -rf *
-
-touch file
-ln -s file link 2> /dev/null || ln file link
-tar cf archive link
-rm link
-touch link
-tar xf archive
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'an embedded newline' "extrac02.at:28"
+( $at_check_trace;
 mkdir posix
 (cd posix
 TEST_TAR_FORMAT=posix
@@ -12955,18 +9815,17 @@ tar cf archive link
 rm link
 touch link
 tar xf archive
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
-at_func_diff_devnull "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/extrac02.at:28"
-
-$at_failed && at_func_log_failure
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
+at_fn_diff_devnull "$at_stdout" || at_failed=:
+at_fn_check_status 0 $at_status "$at_srcdir/extrac02.at:28"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/extrac02.at:28:
 mkdir gnu
 (cd gnu
@@ -12983,29 +9842,8 @@ rm link
 touch link
 tar xf archive
 )"
-echo extrac02.at:28 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir gnu
-(cd gnu
-TEST_TAR_FORMAT=gnu
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H gnu"
-export TAR_OPTIONS
-rm -rf *
-
-touch file
-ln -s file link 2> /dev/null || ln file link
-tar cf archive link
-rm link
-touch link
-tar xf archive
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'an embedded newline' "extrac02.at:28"
+( $at_check_trace;
 mkdir gnu
 (cd gnu
 TEST_TAR_FORMAT=gnu
@@ -13020,42 +9858,38 @@ tar cf archive link
 rm link
 touch link
 tar xf archive
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
-at_func_diff_devnull "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/extrac02.at:28"
-
-$at_failed && at_func_log_failure
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
+at_fn_diff_devnull "$at_stdout" || at_failed=:
+at_fn_check_status 0 $at_status "$at_srcdir/extrac02.at:28"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
 
 
 
-  $at_traceoff
+  set +x
   $at_times_p && times >"$at_times_file"
-) 5>&1 2>&1 | eval $at_tee_pipe
-at_status=`cat "$at_status_file"`
+) 5>&1 2>&1 7>&- | eval $at_tee_pipe
+read at_status <"$at_status_file"
 #AT_STOP_28
 #AT_START_29
-# 29. extrac03.at:23: extraction loops
-at_setup_line='extrac03.at:23'
-at_desc="extraction loops"
-$at_quiet $as_echo_n " 29: $at_desc                               "
+at_fn_group_banner 29 'extrac03.at:23' \
+  "extraction loops" "                               "
 at_xfail=no
       test -f $XFAILFILE && at_xfail=yes
-echo "#                             -*- compilation -*-" >> "$at_group_log"
 (
-  $as_echo "29. extrac03.at:23: testing ..."
+  $as_echo "29. $at_setup_line: testing $at_desc ..."
   $at_traceon
 
 
 
 
 
-  { $at_traceoff
+  { set +x
 $as_echo "$at_srcdir/extrac03.at:26:
 mkdir v7
 (cd v7
@@ -13069,26 +9903,8 @@ mkdir directory
 tar -cPvf archive directory/../directory
 echo separator
 tar -xPvf archive --warning=no-timestamp)"
-echo extrac03.at:26 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir v7
-(cd v7
-TEST_TAR_FORMAT=v7
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H v7"
-export TAR_OPTIONS
-rm -rf *
-
-mkdir directory
-tar -cPvf archive directory/../directory
-echo separator
-tar -xPvf archive --warning=no-timestamp) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'an embedded newline' "extrac03.at:26"
+( $at_check_trace;
 mkdir v7
 (cd v7
 TEST_TAR_FORMAT=v7
@@ -13100,22 +9916,21 @@ rm -rf *
 mkdir directory
 tar -cPvf archive directory/../directory
 echo separator
-tar -xPvf archive --warning=no-timestamp) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+tar -xPvf archive --warning=no-timestamp)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "directory/../directory/
 separator
 directory/../directory/
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/extrac03.at:26"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/extrac03.at:26"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/extrac03.at:26:
 mkdir oldgnu
 (cd oldgnu
@@ -13129,26 +9944,8 @@ mkdir directory
 tar -cPvf archive directory/../directory
 echo separator
 tar -xPvf archive --warning=no-timestamp)"
-echo extrac03.at:26 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir oldgnu
-(cd oldgnu
-TEST_TAR_FORMAT=oldgnu
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H oldgnu"
-export TAR_OPTIONS
-rm -rf *
-
-mkdir directory
-tar -cPvf archive directory/../directory
-echo separator
-tar -xPvf archive --warning=no-timestamp) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'an embedded newline' "extrac03.at:26"
+( $at_check_trace;
 mkdir oldgnu
 (cd oldgnu
 TEST_TAR_FORMAT=oldgnu
@@ -13160,22 +9957,21 @@ rm -rf *
 mkdir directory
 tar -cPvf archive directory/../directory
 echo separator
-tar -xPvf archive --warning=no-timestamp) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+tar -xPvf archive --warning=no-timestamp)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "directory/../directory/
 separator
 directory/../directory/
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/extrac03.at:26"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/extrac03.at:26"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/extrac03.at:26:
 mkdir ustar
 (cd ustar
@@ -13189,26 +9985,8 @@ mkdir directory
 tar -cPvf archive directory/../directory
 echo separator
 tar -xPvf archive --warning=no-timestamp)"
-echo extrac03.at:26 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir ustar
-(cd ustar
-TEST_TAR_FORMAT=ustar
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H ustar"
-export TAR_OPTIONS
-rm -rf *
-
-mkdir directory
-tar -cPvf archive directory/../directory
-echo separator
-tar -xPvf archive --warning=no-timestamp) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'an embedded newline' "extrac03.at:26"
+( $at_check_trace;
 mkdir ustar
 (cd ustar
 TEST_TAR_FORMAT=ustar
@@ -13220,22 +9998,21 @@ rm -rf *
 mkdir directory
 tar -cPvf archive directory/../directory
 echo separator
-tar -xPvf archive --warning=no-timestamp) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+tar -xPvf archive --warning=no-timestamp)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "directory/../directory/
 separator
 directory/../directory/
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/extrac03.at:26"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/extrac03.at:26"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/extrac03.at:26:
 mkdir posix
 (cd posix
@@ -13249,26 +10026,8 @@ mkdir directory
 tar -cPvf archive directory/../directory
 echo separator
 tar -xPvf archive --warning=no-timestamp)"
-echo extrac03.at:26 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir posix
-(cd posix
-TEST_TAR_FORMAT=posix
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H posix"
-export TAR_OPTIONS
-rm -rf *
-
-mkdir directory
-tar -cPvf archive directory/../directory
-echo separator
-tar -xPvf archive --warning=no-timestamp) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'an embedded newline' "extrac03.at:26"
+( $at_check_trace;
 mkdir posix
 (cd posix
 TEST_TAR_FORMAT=posix
@@ -13280,22 +10039,21 @@ rm -rf *
 mkdir directory
 tar -cPvf archive directory/../directory
 echo separator
-tar -xPvf archive --warning=no-timestamp) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+tar -xPvf archive --warning=no-timestamp)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "directory/../directory/
 separator
 directory/../directory/
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/extrac03.at:26"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/extrac03.at:26"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/extrac03.at:26:
 mkdir gnu
 (cd gnu
@@ -13309,26 +10067,8 @@ mkdir directory
 tar -cPvf archive directory/../directory
 echo separator
 tar -xPvf archive --warning=no-timestamp)"
-echo extrac03.at:26 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir gnu
-(cd gnu
-TEST_TAR_FORMAT=gnu
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H gnu"
-export TAR_OPTIONS
-rm -rf *
-
-mkdir directory
-tar -cPvf archive directory/../directory
-echo separator
-tar -xPvf archive --warning=no-timestamp) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'an embedded newline' "extrac03.at:26"
+( $at_check_trace;
 mkdir gnu
 (cd gnu
 TEST_TAR_FORMAT=gnu
@@ -13340,46 +10080,42 @@ rm -rf *
 mkdir directory
 tar -cPvf archive directory/../directory
 echo separator
-tar -xPvf archive --warning=no-timestamp) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+tar -xPvf archive --warning=no-timestamp)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "directory/../directory/
 separator
 directory/../directory/
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/extrac03.at:26"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/extrac03.at:26"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
 
 
 
-  $at_traceoff
+  set +x
   $at_times_p && times >"$at_times_file"
-) 5>&1 2>&1 | eval $at_tee_pipe
-at_status=`cat "$at_status_file"`
+) 5>&1 2>&1 7>&- | eval $at_tee_pipe
+read at_status <"$at_status_file"
 #AT_STOP_29
 #AT_START_30
-# 30. extrac04.at:23: extract + fnmatch
-at_setup_line='extrac04.at:23'
-at_desc="extract + fnmatch"
-$at_quiet $as_echo_n " 30: $at_desc                              "
+at_fn_group_banner 30 'extrac04.at:23' \
+  "extract + fnmatch" "                              "
 at_xfail=no
       test -f $XFAILFILE && at_xfail=yes
-echo "#                             -*- compilation -*-" >> "$at_group_log"
 (
-  $as_echo "30. extrac04.at:23: testing ..."
+  $as_echo "30. $at_setup_line: testing $at_desc ..."
   $at_traceon
 
 
 
 
 
-  { $at_traceoff
+  { set +x
 $as_echo "$at_srcdir/extrac04.at:26:
 mkdir v7
 (cd v7
@@ -13390,7 +10126,7 @@ export TAR_OPTIONS
 rm -rf *
 
 
-test -z "`sort < /dev/null 2>&1`" || exit 77
+test -z \"\`sort < /dev/null 2>&1\`\" || exit 77
 
 touch file1
 mkdir directory
@@ -13405,38 +10141,8 @@ tar -tf archive \\
   --exclude='d*/*1' \\
   --exclude='d*/s*/*2' | sort
 )"
-echo extrac04.at:26 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir v7
-(cd v7
-TEST_TAR_FORMAT=v7
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H v7"
-export TAR_OPTIONS
-rm -rf *
-
-
-test -z "`sort < /dev/null 2>&1`" || exit 77
-
-touch file1
-mkdir directory
-mkdir directory/subdirectory
-touch directory/file1
-touch directory/file2
-touch directory/subdirectory/file1
-touch directory/subdirectory/file2
-tar -cf archive ./file1 directory
-tar -tf archive \
-  --exclude='./*1' \
-  --exclude='d*/*1' \
-  --exclude='d*/s*/*2' | sort
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'a `...` command substitution' "extrac04.at:26"
+( $at_check_trace;
 mkdir v7
 (cd v7
 TEST_TAR_FORMAT=v7
@@ -13460,22 +10166,21 @@ tar -tf archive \
   --exclude='./*1' \
   --exclude='d*/*1' \
   --exclude='d*/s*/*2' | sort
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "directory/
 directory/file2
 directory/subdirectory/
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/extrac04.at:26"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/extrac04.at:26"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/extrac04.at:26:
 mkdir oldgnu
 (cd oldgnu
@@ -13486,7 +10191,7 @@ export TAR_OPTIONS
 rm -rf *
 
 
-test -z "`sort < /dev/null 2>&1`" || exit 77
+test -z \"\`sort < /dev/null 2>&1\`\" || exit 77
 
 touch file1
 mkdir directory
@@ -13501,38 +10206,8 @@ tar -tf archive \\
   --exclude='d*/*1' \\
   --exclude='d*/s*/*2' | sort
 )"
-echo extrac04.at:26 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir oldgnu
-(cd oldgnu
-TEST_TAR_FORMAT=oldgnu
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H oldgnu"
-export TAR_OPTIONS
-rm -rf *
-
-
-test -z "`sort < /dev/null 2>&1`" || exit 77
-
-touch file1
-mkdir directory
-mkdir directory/subdirectory
-touch directory/file1
-touch directory/file2
-touch directory/subdirectory/file1
-touch directory/subdirectory/file2
-tar -cf archive ./file1 directory
-tar -tf archive \
-  --exclude='./*1' \
-  --exclude='d*/*1' \
-  --exclude='d*/s*/*2' | sort
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'a `...` command substitution' "extrac04.at:26"
+( $at_check_trace;
 mkdir oldgnu
 (cd oldgnu
 TEST_TAR_FORMAT=oldgnu
@@ -13556,22 +10231,21 @@ tar -tf archive \
   --exclude='./*1' \
   --exclude='d*/*1' \
   --exclude='d*/s*/*2' | sort
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "directory/
 directory/file2
 directory/subdirectory/
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/extrac04.at:26"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/extrac04.at:26"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/extrac04.at:26:
 mkdir ustar
 (cd ustar
@@ -13582,7 +10256,7 @@ export TAR_OPTIONS
 rm -rf *
 
 
-test -z "`sort < /dev/null 2>&1`" || exit 77
+test -z \"\`sort < /dev/null 2>&1\`\" || exit 77
 
 touch file1
 mkdir directory
@@ -13597,11 +10271,8 @@ tar -tf archive \\
   --exclude='d*/*1' \\
   --exclude='d*/s*/*2' | sort
 )"
-echo extrac04.at:26 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
+at_fn_check_prepare_notrace 'a `...` command substitution' "extrac04.at:26"
+( $at_check_trace;
 mkdir ustar
 (cd ustar
 TEST_TAR_FORMAT=ustar
@@ -13625,49 +10296,21 @@ tar -tf archive \
   --exclude='./*1' \
   --exclude='d*/*1' \
   --exclude='d*/s*/*2' | sort
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
-mkdir ustar
-(cd ustar
-TEST_TAR_FORMAT=ustar
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H ustar"
-export TAR_OPTIONS
-rm -rf *
-
-
-test -z "`sort < /dev/null 2>&1`" || exit 77
-
-touch file1
-mkdir directory
-mkdir directory/subdirectory
-touch directory/file1
-touch directory/file2
-touch directory/subdirectory/file1
-touch directory/subdirectory/file2
-tar -cf archive ./file1 directory
-tar -tf archive \
-  --exclude='./*1' \
-  --exclude='d*/*1' \
-  --exclude='d*/s*/*2' | sort
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "directory/
 directory/file2
 directory/subdirectory/
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/extrac04.at:26"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/extrac04.at:26"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/extrac04.at:26:
 mkdir posix
 (cd posix
@@ -13678,7 +10321,7 @@ export TAR_OPTIONS
 rm -rf *
 
 
-test -z "`sort < /dev/null 2>&1`" || exit 77
+test -z \"\`sort < /dev/null 2>&1\`\" || exit 77
 
 touch file1
 mkdir directory
@@ -13693,11 +10336,8 @@ tar -tf archive \\
   --exclude='d*/*1' \\
   --exclude='d*/s*/*2' | sort
 )"
-echo extrac04.at:26 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
+at_fn_check_prepare_notrace 'a `...` command substitution' "extrac04.at:26"
+( $at_check_trace;
 mkdir posix
 (cd posix
 TEST_TAR_FORMAT=posix
@@ -13721,49 +10361,21 @@ tar -tf archive \
   --exclude='./*1' \
   --exclude='d*/*1' \
   --exclude='d*/s*/*2' | sort
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
-mkdir posix
-(cd posix
-TEST_TAR_FORMAT=posix
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H posix"
-export TAR_OPTIONS
-rm -rf *
-
-
-test -z "`sort < /dev/null 2>&1`" || exit 77
-
-touch file1
-mkdir directory
-mkdir directory/subdirectory
-touch directory/file1
-touch directory/file2
-touch directory/subdirectory/file1
-touch directory/subdirectory/file2
-tar -cf archive ./file1 directory
-tar -tf archive \
-  --exclude='./*1' \
-  --exclude='d*/*1' \
-  --exclude='d*/s*/*2' | sort
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "directory/
 directory/file2
 directory/subdirectory/
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/extrac04.at:26"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/extrac04.at:26"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/extrac04.at:26:
 mkdir gnu
 (cd gnu
@@ -13774,7 +10386,7 @@ export TAR_OPTIONS
 rm -rf *
 
 
-test -z "`sort < /dev/null 2>&1`" || exit 77
+test -z \"\`sort < /dev/null 2>&1\`\" || exit 77
 
 touch file1
 mkdir directory
@@ -13789,38 +10401,8 @@ tar -tf archive \\
   --exclude='d*/*1' \\
   --exclude='d*/s*/*2' | sort
 )"
-echo extrac04.at:26 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir gnu
-(cd gnu
-TEST_TAR_FORMAT=gnu
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H gnu"
-export TAR_OPTIONS
-rm -rf *
-
-
-test -z "`sort < /dev/null 2>&1`" || exit 77
-
-touch file1
-mkdir directory
-mkdir directory/subdirectory
-touch directory/file1
-touch directory/file2
-touch directory/subdirectory/file1
-touch directory/subdirectory/file2
-tar -cf archive ./file1 directory
-tar -tf archive \
-  --exclude='./*1' \
-  --exclude='d*/*1' \
-  --exclude='d*/s*/*2' | sort
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'a `...` command substitution' "extrac04.at:26"
+( $at_check_trace;
 mkdir gnu
 (cd gnu
 TEST_TAR_FORMAT=gnu
@@ -13844,39 +10426,35 @@ tar -tf archive \
   --exclude='./*1' \
   --exclude='d*/*1' \
   --exclude='d*/s*/*2' | sort
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "directory/
 directory/file2
 directory/subdirectory/
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/extrac04.at:26"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/extrac04.at:26"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
 
 
 
-  $at_traceoff
+  set +x
   $at_times_p && times >"$at_times_file"
-) 5>&1 2>&1 | eval $at_tee_pipe
-at_status=`cat "$at_status_file"`
+) 5>&1 2>&1 7>&- | eval $at_tee_pipe
+read at_status <"$at_status_file"
 #AT_STOP_30
 #AT_START_31
-# 31. extrac05.at:30: extracting selected members from pax
-at_setup_line='extrac05.at:30'
-at_desc="extracting selected members from pax"
-$at_quiet $as_echo_n " 31: $at_desc           "
+at_fn_group_banner 31 'extrac05.at:30' \
+  "extracting selected members from pax" "           "
 at_xfail=no
       test -f $XFAILFILE && at_xfail=yes
-echo "#                             -*- compilation -*-" >> "$at_group_log"
 (
-  $as_echo "31. extrac05.at:30: testing ..."
+  $as_echo "31. $at_setup_line: testing $at_desc ..."
   $at_traceon
 
 
@@ -13889,7 +10467,7 @@ _ATEOF
 
 
 
-  { $at_traceoff
+  { set +x
 $as_echo "$at_srcdir/extrac05.at:38:
 mkdir posix
 (cd posix
@@ -13914,37 +10492,8 @@ tar xvfT ../archive ../../list --warning
 
 cd ..
 )"
-echo extrac05.at:38 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir posix
-(cd posix
-TEST_TAR_FORMAT=posix
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H posix"
-export TAR_OPTIONS
-rm -rf *
-
-genfile --sparse --file sparsefile 0 ABCD 1M EFGH 2000K IJKL || exit 77
-genfile --length 118 --file jeden
-genfile --length 223 --file dwa
-genfile --length 517 --file trzy
-genfile --length 110 --file cztery
-
-tar cf archive jeden dwa trzy cztery || exit 1
-
-mkdir dir
-cd dir
-
-tar xvfT ../archive ../../list --warning=no-timestamp || exit 1
-
-cd ..
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'an embedded newline' "extrac05.at:38"
+( $at_check_trace;
 mkdir posix
 (cd posix
 TEST_TAR_FORMAT=posix
@@ -13967,45 +10516,41 @@ cd dir
 tar xvfT ../archive ../../list --warning=no-timestamp || exit 1
 
 cd ..
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "jeden
 cztery
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/extrac05.at:38"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/extrac05.at:38"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
 
 
 
-  $at_traceoff
+  set +x
   $at_times_p && times >"$at_times_file"
-) 5>&1 2>&1 | eval $at_tee_pipe
-at_status=`cat "$at_status_file"`
+) 5>&1 2>&1 7>&- | eval $at_tee_pipe
+read at_status <"$at_status_file"
 #AT_STOP_31
 #AT_START_32
-# 32. extrac06.at:33: mode of extracted directories
-at_setup_line='extrac06.at:33'
-at_desc="mode of extracted directories"
-$at_quiet $as_echo_n " 32: $at_desc                  "
+at_fn_group_banner 32 'extrac06.at:33' \
+  "mode of extracted directories" "                  "
 at_xfail=no
       test -f $XFAILFILE && at_xfail=yes
-echo "#                             -*- compilation -*-" >> "$at_group_log"
 (
-  $as_echo "32. extrac06.at:33: testing ..."
+  $as_echo "32. $at_setup_line: testing $at_desc ..."
   $at_traceon
 
 
 
 
 
-  { $at_traceoff
+  { set +x
 $as_echo "$at_srcdir/extrac06.at:36:
 mkdir v7
 (cd v7
@@ -14043,50 +10588,8 @@ genfile --stat=mode:777 directory
 
 # After both restores, the directory mode should be 755
 )"
-echo extrac06.at:36 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir v7
-(cd v7
-TEST_TAR_FORMAT=v7
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H v7"
-export TAR_OPTIONS
-rm -rf *
-
-
-# Force umask
-umask 022
-
-# Make sure user's umask is honored, even if we are superuser
-TAR_OPTIONS="$TAR_OPTIONS --no-same-permissions"
-
-# Create a directory
-mkdir directory
-chmod 777 directory
-genfile --stat=mode:777 directory
-
-# Archive it
-tar cf arc directory
-
-# Change its permissions ...
-chmod 755 directory
-genfile --stat=mode:777 directory
-
-# ... and attempt to restore it twice
-tar xf arc directory --warning=no-timestamp
-genfile --stat=mode:777 directory
-
-tar xf arc directory --warning=no-timestamp
-genfile --stat=mode:777 directory
-
-# After both restores, the directory mode should be 755
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'an embedded newline' "extrac06.at:36"
+( $at_check_trace;
 mkdir v7
 (cd v7
 TEST_TAR_FORMAT=v7
@@ -14122,23 +10625,22 @@ tar xf arc directory --warning=no-timest
 genfile --stat=mode:777 directory
 
 # After both restores, the directory mode should be 755
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "777
 755
 755
 755
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/extrac06.at:36"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/extrac06.at:36"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/extrac06.at:36:
 mkdir oldgnu
 (cd oldgnu
@@ -14176,50 +10678,8 @@ genfile --stat=mode:777 directory
 
 # After both restores, the directory mode should be 755
 )"
-echo extrac06.at:36 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir oldgnu
-(cd oldgnu
-TEST_TAR_FORMAT=oldgnu
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H oldgnu"
-export TAR_OPTIONS
-rm -rf *
-
-
-# Force umask
-umask 022
-
-# Make sure user's umask is honored, even if we are superuser
-TAR_OPTIONS="$TAR_OPTIONS --no-same-permissions"
-
-# Create a directory
-mkdir directory
-chmod 777 directory
-genfile --stat=mode:777 directory
-
-# Archive it
-tar cf arc directory
-
-# Change its permissions ...
-chmod 755 directory
-genfile --stat=mode:777 directory
-
-# ... and attempt to restore it twice
-tar xf arc directory --warning=no-timestamp
-genfile --stat=mode:777 directory
-
-tar xf arc directory --warning=no-timestamp
-genfile --stat=mode:777 directory
-
-# After both restores, the directory mode should be 755
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'an embedded newline' "extrac06.at:36"
+( $at_check_trace;
 mkdir oldgnu
 (cd oldgnu
 TEST_TAR_FORMAT=oldgnu
@@ -14255,23 +10715,22 @@ tar xf arc directory --warning=no-timest
 genfile --stat=mode:777 directory
 
 # After both restores, the directory mode should be 755
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "777
 755
 755
 755
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/extrac06.at:36"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/extrac06.at:36"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/extrac06.at:36:
 mkdir ustar
 (cd ustar
@@ -14309,50 +10768,8 @@ genfile --stat=mode:777 directory
 
 # After both restores, the directory mode should be 755
 )"
-echo extrac06.at:36 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir ustar
-(cd ustar
-TEST_TAR_FORMAT=ustar
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H ustar"
-export TAR_OPTIONS
-rm -rf *
-
-
-# Force umask
-umask 022
-
-# Make sure user's umask is honored, even if we are superuser
-TAR_OPTIONS="$TAR_OPTIONS --no-same-permissions"
-
-# Create a directory
-mkdir directory
-chmod 777 directory
-genfile --stat=mode:777 directory
-
-# Archive it
-tar cf arc directory
-
-# Change its permissions ...
-chmod 755 directory
-genfile --stat=mode:777 directory
-
-# ... and attempt to restore it twice
-tar xf arc directory --warning=no-timestamp
-genfile --stat=mode:777 directory
-
-tar xf arc directory --warning=no-timestamp
-genfile --stat=mode:777 directory
-
-# After both restores, the directory mode should be 755
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'an embedded newline' "extrac06.at:36"
+( $at_check_trace;
 mkdir ustar
 (cd ustar
 TEST_TAR_FORMAT=ustar
@@ -14388,23 +10805,22 @@ tar xf arc directory --warning=no-timest
 genfile --stat=mode:777 directory
 
 # After both restores, the directory mode should be 755
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "777
 755
 755
 755
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/extrac06.at:36"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/extrac06.at:36"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/extrac06.at:36:
 mkdir posix
 (cd posix
@@ -14442,50 +10858,8 @@ genfile --stat=mode:777 directory
 
 # After both restores, the directory mode should be 755
 )"
-echo extrac06.at:36 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir posix
-(cd posix
-TEST_TAR_FORMAT=posix
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H posix"
-export TAR_OPTIONS
-rm -rf *
-
-
-# Force umask
-umask 022
-
-# Make sure user's umask is honored, even if we are superuser
-TAR_OPTIONS="$TAR_OPTIONS --no-same-permissions"
-
-# Create a directory
-mkdir directory
-chmod 777 directory
-genfile --stat=mode:777 directory
-
-# Archive it
-tar cf arc directory
-
-# Change its permissions ...
-chmod 755 directory
-genfile --stat=mode:777 directory
-
-# ... and attempt to restore it twice
-tar xf arc directory --warning=no-timestamp
-genfile --stat=mode:777 directory
-
-tar xf arc directory --warning=no-timestamp
-genfile --stat=mode:777 directory
-
-# After both restores, the directory mode should be 755
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'an embedded newline' "extrac06.at:36"
+( $at_check_trace;
 mkdir posix
 (cd posix
 TEST_TAR_FORMAT=posix
@@ -14521,23 +10895,22 @@ tar xf arc directory --warning=no-timest
 genfile --stat=mode:777 directory
 
 # After both restores, the directory mode should be 755
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "777
 755
 755
 755
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/extrac06.at:36"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/extrac06.at:36"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/extrac06.at:36:
 mkdir gnu
 (cd gnu
@@ -14575,11 +10948,8 @@ genfile --stat=mode:777 directory
 
 # After both restores, the directory mode should be 755
 )"
-echo extrac06.at:36 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
+at_fn_check_prepare_notrace 'an embedded newline' "extrac06.at:36"
+( $at_check_trace;
 mkdir gnu
 (cd gnu
 TEST_TAR_FORMAT=gnu
@@ -14615,86 +10985,43 @@ tar xf arc directory --warning=no-timest
 genfile --stat=mode:777 directory
 
 # After both restores, the directory mode should be 755
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
-mkdir gnu
-(cd gnu
-TEST_TAR_FORMAT=gnu
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H gnu"
-export TAR_OPTIONS
-rm -rf *
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
+echo >>"$at_stdout"; $as_echo "777
+755
+755
+755
+" | \
+  $at_diff - "$at_stdout" || at_failed=:
+at_fn_check_status 0 $at_status "$at_srcdir/extrac06.at:36"
+$at_failed && at_fn_log_failure
+$at_traceon; }
 
 
-# Force umask
-umask 022
 
-# Make sure user's umask is honored, even if we are superuser
-TAR_OPTIONS="$TAR_OPTIONS --no-same-permissions"
 
-# Create a directory
-mkdir directory
-chmod 777 directory
-genfile --stat=mode:777 directory
-
-# Archive it
-tar cf arc directory
-
-# Change its permissions ...
-chmod 755 directory
-genfile --stat=mode:777 directory
-
-# ... and attempt to restore it twice
-tar xf arc directory --warning=no-timestamp
-genfile --stat=mode:777 directory
-
-tar xf arc directory --warning=no-timestamp
-genfile --stat=mode:777 directory
-
-# After both restores, the directory mode should be 755
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
-echo >>"$at_stdout"; $as_echo "777
-755
-755
-755
-" | \
-  $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/extrac06.at:36"
-
-$at_failed && at_func_log_failure
-$at_traceon; }
-
-
-
-
-  $at_traceoff
+  set +x
   $at_times_p && times >"$at_times_file"
-) 5>&1 2>&1 | eval $at_tee_pipe
-at_status=`cat "$at_status_file"`
+) 5>&1 2>&1 7>&- | eval $at_tee_pipe
+read at_status <"$at_status_file"
 #AT_STOP_32
 #AT_START_33
-# 33. extrac07.at:27: extracting symlinks to a read-only dir
-at_setup_line='extrac07.at:27'
-at_desc="extracting symlinks to a read-only dir"
-$at_quiet $as_echo_n " 33: $at_desc         "
+at_fn_group_banner 33 'extrac07.at:27' \
+  "extracting symlinks to a read-only dir" "         "
 at_xfail=no
       test -f $XFAILFILE && at_xfail=yes
-echo "#                             -*- compilation -*-" >> "$at_group_log"
 (
-  $as_echo "33. extrac07.at:27: testing ..."
+  $as_echo "33. $at_setup_line: testing $at_desc ..."
   $at_traceon
 
 
 
 
 
-  { $at_traceoff
+  { set +x
 $as_echo "$at_srcdir/extrac07.at:30:
 mkdir ustar
 (cd ustar
@@ -14705,12 +11032,12 @@ export TAR_OPTIONS
 rm -rf *
 
 
-echo "test" > $$
-chmod 0 $$
-cat $$ > /dev/null 2>&1
-result=$?
-rm -f $$
-test $result -eq 0 && exit 77
+echo \"test\" > \$\$
+chmod 0 \$\$
+cat \$\$ > /dev/null 2>&1
+result=\$?
+rm -f \$\$
+test \$result -eq 0 && exit 77
 
 
 echo Prepare the directory
@@ -14730,48 +11057,8 @@ echo Extract
 mkdir out
 tar -C out -xvf archive
 )"
-echo extrac07.at:30 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir ustar
-(cd ustar
-TEST_TAR_FORMAT=ustar
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H ustar"
-export TAR_OPTIONS
-rm -rf *
-
-
-echo "test" > $$
-chmod 0 $$
-cat $$ > /dev/null 2>&1
-result=$?
-rm -f $$
-test $result -eq 0 && exit 77
-
-
-echo Prepare the directory
-mkdir dir
-genfile -f foo
-cd dir
-ln -s ../foo .
-cd ..
-chmod a-w dir
-
-echo Create the archive
-tar cf archive dir || exit 1
-
-chmod +w dir
-
-echo Extract
-mkdir out
-tar -C out -xvf archive
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'an embedded newline' "extrac07.at:30"
+( $at_check_trace;
 mkdir ustar
 (cd ustar
 TEST_TAR_FORMAT=ustar
@@ -14805,11 +11092,11 @@ chmod +w dir
 echo Extract
 mkdir out
 tar -C out -xvf archive
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "Prepare the directory
 Create the archive
 Extract
@@ -14817,36 +11104,32 @@ dir/
 dir/foo
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/extrac07.at:30"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/extrac07.at:30"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
 
  # Testing one format is enough
 
-  $at_traceoff
+  set +x
   $at_times_p && times >"$at_times_file"
-) 5>&1 2>&1 | eval $at_tee_pipe
-at_status=`cat "$at_status_file"`
+) 5>&1 2>&1 7>&- | eval $at_tee_pipe
+read at_status <"$at_status_file"
 #AT_STOP_33
 #AT_START_34
-# 34. extrac08.at:33: restoring mode on existing directory
-at_setup_line='extrac08.at:33'
-at_desc="restoring mode on existing directory"
-$at_quiet $as_echo_n " 34: $at_desc           "
+at_fn_group_banner 34 'extrac08.at:33' \
+  "restoring mode on existing directory" "           "
 at_xfail=no
       test -f $XFAILFILE && at_xfail=yes
-echo "#                             -*- compilation -*-" >> "$at_group_log"
 (
-  $as_echo "34. extrac08.at:33: testing ..."
+  $as_echo "34. $at_setup_line: testing $at_desc ..."
   $at_traceon
 
 
 
 
 
-  { $at_traceoff
+  { set +x
 $as_echo "$at_srcdir/extrac08.at:36:
 mkdir v7
 (cd v7
@@ -14865,31 +11148,8 @@ chmod 700 dir
 tar xfv test.tar --warning=no-timestamp
 genfile --stat=mode.777 dir
 )"
-echo extrac08.at:36 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir v7
-(cd v7
-TEST_TAR_FORMAT=v7
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H v7"
-export TAR_OPTIONS
-rm -rf *
-
-umask 000
-mkdir dir
-chmod 755 dir
-echo bla > dir/file
-tar cf test.tar dir
-chmod 700 dir
-tar xfv test.tar --warning=no-timestamp
-genfile --stat=mode.777 dir
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'an embedded newline' "extrac08.at:36"
+( $at_check_trace;
 mkdir v7
 (cd v7
 TEST_TAR_FORMAT=v7
@@ -14906,22 +11166,21 @@ tar cf test.tar dir
 chmod 700 dir
 tar xfv test.tar --warning=no-timestamp
 genfile --stat=mode.777 dir
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "dir/
 dir/file
 755
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/extrac08.at:36"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/extrac08.at:36"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/extrac08.at:36:
 mkdir oldgnu
 (cd oldgnu
@@ -14940,31 +11199,8 @@ chmod 700 dir
 tar xfv test.tar --warning=no-timestamp
 genfile --stat=mode.777 dir
 )"
-echo extrac08.at:36 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir oldgnu
-(cd oldgnu
-TEST_TAR_FORMAT=oldgnu
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H oldgnu"
-export TAR_OPTIONS
-rm -rf *
-
-umask 000
-mkdir dir
-chmod 755 dir
-echo bla > dir/file
-tar cf test.tar dir
-chmod 700 dir
-tar xfv test.tar --warning=no-timestamp
-genfile --stat=mode.777 dir
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'an embedded newline' "extrac08.at:36"
+( $at_check_trace;
 mkdir oldgnu
 (cd oldgnu
 TEST_TAR_FORMAT=oldgnu
@@ -14981,22 +11217,21 @@ tar cf test.tar dir
 chmod 700 dir
 tar xfv test.tar --warning=no-timestamp
 genfile --stat=mode.777 dir
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "dir/
 dir/file
 755
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/extrac08.at:36"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/extrac08.at:36"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/extrac08.at:36:
 mkdir ustar
 (cd ustar
@@ -15015,31 +11250,8 @@ chmod 700 dir
 tar xfv test.tar --warning=no-timestamp
 genfile --stat=mode.777 dir
 )"
-echo extrac08.at:36 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir ustar
-(cd ustar
-TEST_TAR_FORMAT=ustar
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H ustar"
-export TAR_OPTIONS
-rm -rf *
-
-umask 000
-mkdir dir
-chmod 755 dir
-echo bla > dir/file
-tar cf test.tar dir
-chmod 700 dir
-tar xfv test.tar --warning=no-timestamp
-genfile --stat=mode.777 dir
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'an embedded newline' "extrac08.at:36"
+( $at_check_trace;
 mkdir ustar
 (cd ustar
 TEST_TAR_FORMAT=ustar
@@ -15056,22 +11268,21 @@ tar cf test.tar dir
 chmod 700 dir
 tar xfv test.tar --warning=no-timestamp
 genfile --stat=mode.777 dir
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "dir/
 dir/file
 755
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/extrac08.at:36"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/extrac08.at:36"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/extrac08.at:36:
 mkdir posix
 (cd posix
@@ -15090,31 +11301,8 @@ chmod 700 dir
 tar xfv test.tar --warning=no-timestamp
 genfile --stat=mode.777 dir
 )"
-echo extrac08.at:36 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir posix
-(cd posix
-TEST_TAR_FORMAT=posix
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H posix"
-export TAR_OPTIONS
-rm -rf *
-
-umask 000
-mkdir dir
-chmod 755 dir
-echo bla > dir/file
-tar cf test.tar dir
-chmod 700 dir
-tar xfv test.tar --warning=no-timestamp
-genfile --stat=mode.777 dir
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'an embedded newline' "extrac08.at:36"
+( $at_check_trace;
 mkdir posix
 (cd posix
 TEST_TAR_FORMAT=posix
@@ -15131,22 +11319,21 @@ tar cf test.tar dir
 chmod 700 dir
 tar xfv test.tar --warning=no-timestamp
 genfile --stat=mode.777 dir
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "dir/
 dir/file
 755
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/extrac08.at:36"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/extrac08.at:36"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/extrac08.at:36:
 mkdir gnu
 (cd gnu
@@ -15165,31 +11352,8 @@ chmod 700 dir
 tar xfv test.tar --warning=no-timestamp
 genfile --stat=mode.777 dir
 )"
-echo extrac08.at:36 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir gnu
-(cd gnu
-TEST_TAR_FORMAT=gnu
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H gnu"
-export TAR_OPTIONS
-rm -rf *
-
-umask 000
-mkdir dir
-chmod 755 dir
-echo bla > dir/file
-tar cf test.tar dir
-chmod 700 dir
-tar xfv test.tar --warning=no-timestamp
-genfile --stat=mode.777 dir
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'an embedded newline' "extrac08.at:36"
+( $at_check_trace;
 mkdir gnu
 (cd gnu
 TEST_TAR_FORMAT=gnu
@@ -15206,46 +11370,42 @@ tar cf test.tar dir
 chmod 700 dir
 tar xfv test.tar --warning=no-timestamp
 genfile --stat=mode.777 dir
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "dir/
 dir/file
 755
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/extrac08.at:36"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/extrac08.at:36"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
 
 
 
-  $at_traceoff
+  set +x
   $at_times_p && times >"$at_times_file"
-) 5>&1 2>&1 | eval $at_tee_pipe
-at_status=`cat "$at_status_file"`
+) 5>&1 2>&1 7>&- | eval $at_tee_pipe
+read at_status <"$at_status_file"
 #AT_STOP_34
 #AT_START_35
-# 35. extrac09.at:22: no need to save dir with unreadable . and ..
-at_setup_line='extrac09.at:22'
-at_desc="no need to save dir with unreadable . and .."
-$at_quiet $as_echo_n " 35: $at_desc   "
+at_fn_group_banner 35 'extrac09.at:22' \
+  "no need to save dir with unreadable . and .." "   "
 at_xfail=no
       test -f $XFAILFILE && at_xfail=yes
-echo "#                             -*- compilation -*-" >> "$at_group_log"
 (
-  $as_echo "35. extrac09.at:22: testing ..."
+  $as_echo "35. $at_setup_line: testing $at_desc ..."
   $at_traceon
 
 
 
 
 
-  { $at_traceoff
+  { set +x
 $as_echo "$at_srcdir/extrac09.at:25:
 mkdir gnu
 (cd gnu
@@ -15256,12 +11416,12 @@ export TAR_OPTIONS
 rm -rf *
 
 
-echo "test" > $$
-chmod 0 $$
-cat $$ > /dev/null 2>&1
-result=$?
-rm -f $$
-test $result -eq 0 && exit 77
+echo \"test\" > \$\$
+chmod 0 \$\$
+cat \$\$ > /dev/null 2>&1
+result=\$?
+rm -f \$\$
+test \$result -eq 0 && exit 77
 
 
 mkdir dir
@@ -15279,46 +11439,8 @@ chmod a+r . ..
 cmp f extract/f || status=\$?
 exit \$status
 )"
-echo extrac09.at:25 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir gnu
-(cd gnu
-TEST_TAR_FORMAT=gnu
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H gnu"
-export TAR_OPTIONS
-rm -rf *
-
-
-echo "test" > $$
-chmod 0 $$
-cat $$ > /dev/null 2>&1
-result=$?
-rm -f $$
-test $result -eq 0 && exit 77
-
-
-mkdir dir
-mkdir dir/sub
-mkdir dir/sub/extract
-genfile --file dir/sub/f
-cd dir/sub
-
-tar -cf archive.tar f
-
-chmod a-r . ..
-tar -xvf archive.tar -C extract f
-status=$?
-chmod a+r . ..
-cmp f extract/f || status=$?
-exit $status
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'an embedded newline' "extrac09.at:25"
+( $at_check_trace;
 mkdir gnu
 (cd gnu
 TEST_TAR_FORMAT=gnu
@@ -15350,44 +11472,40 @@ status=$?
 chmod a+r . ..
 cmp f extract/f || status=$?
 exit $status
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "f
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/extrac09.at:25"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/extrac09.at:25"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
 
 
 
-  $at_traceoff
+  set +x
   $at_times_p && times >"$at_times_file"
-) 5>&1 2>&1 | eval $at_tee_pipe
-at_status=`cat "$at_status_file"`
+) 5>&1 2>&1 7>&- | eval $at_tee_pipe
+read at_status <"$at_status_file"
 #AT_STOP_35
 #AT_START_36
-# 36. extrac10.at:27: -C and delayed setting of metadata
-at_setup_line='extrac10.at:27'
-at_desc="-C and delayed setting of metadata"
-$at_quiet $as_echo_n " 36: $at_desc             "
+at_fn_group_banner 36 'extrac10.at:27' \
+  "-C and delayed setting of metadata" "             "
 at_xfail=no
       test -f $XFAILFILE && at_xfail=yes
-echo "#                             -*- compilation -*-" >> "$at_group_log"
 (
-  $as_echo "36. extrac10.at:27: testing ..."
+  $as_echo "36. $at_setup_line: testing $at_desc ..."
   $at_traceon
 
 
 
 
 
-  { $at_traceoff
+  { set +x
 $as_echo "$at_srcdir/extrac10.at:30:
 mkdir gnu
 (cd gnu
@@ -15406,31 +11524,8 @@ tar -xf archive.tar -C x d -C y e &&
 diff -r d x/d &&
 diff e x/y/e
 )"
-echo extrac10.at:30 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir gnu
-(cd gnu
-TEST_TAR_FORMAT=gnu
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H gnu"
-export TAR_OPTIONS
-rm -rf *
-
-mkdir d x x/y
-echo foo >d/d1
-echo bar >e
-
-tar -cf archive.tar d e &&
-tar -xf archive.tar -C x d -C y e &&
-diff -r d x/d &&
-diff e x/y/e
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'an embedded newline' "extrac10.at:30"
+( $at_check_trace;
 mkdir gnu
 (cd gnu
 TEST_TAR_FORMAT=gnu
@@ -15447,42 +11542,38 @@ tar -cf archive.tar d e &&
 tar -xf archive.tar -C x d -C y e &&
 diff -r d x/d &&
 diff e x/y/e
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
-at_func_diff_devnull "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/extrac10.at:30"
-
-$at_failed && at_func_log_failure
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
+at_fn_diff_devnull "$at_stdout" || at_failed=:
+at_fn_check_status 0 $at_status "$at_srcdir/extrac10.at:30"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
 
 
 
-  $at_traceoff
+  set +x
   $at_times_p && times >"$at_times_file"
-) 5>&1 2>&1 | eval $at_tee_pipe
-at_status=`cat "$at_status_file"`
+) 5>&1 2>&1 7>&- | eval $at_tee_pipe
+read at_status <"$at_status_file"
 #AT_STOP_36
 #AT_START_37
-# 37. extrac11.at:23: scarce file descriptors
-at_setup_line='extrac11.at:23'
-at_desc="scarce file descriptors"
-$at_quiet $as_echo_n " 37: $at_desc                        "
+at_fn_group_banner 37 'extrac11.at:23' \
+  "scarce file descriptors" "                        "
 at_xfail=no
       test -f $XFAILFILE && at_xfail=yes
-echo "#                             -*- compilation -*-" >> "$at_group_log"
 (
-  $as_echo "37. extrac11.at:23: testing ..."
+  $as_echo "37. $at_setup_line: testing $at_desc ..."
   $at_traceon
 
 
 
 
 
-  { $at_traceoff
+  { set +x
 $as_echo "$at_srcdir/extrac11.at:26:
 mkdir gnu
 (cd gnu
@@ -15547,11 +11638,8 @@ done
   diff -r a dest3/a >/dev/null 2>&1
 ) || { diff -r a dest3/a; exit 1; }
 )"
-echo extrac11.at:26 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
+at_fn_check_prepare_notrace 'an embedded newline' "extrac11.at:26"
+( $at_check_trace;
 mkdir gnu
 (cd gnu
 TEST_TAR_FORMAT=gnu
@@ -15614,114 +11702,44 @@ done
   ) &&
   diff -r a dest3/a >/dev/null 2>&1
 ) || { diff -r a dest3/a; exit 1; }
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
+at_fn_diff_devnull "$at_stdout" || at_failed=:
+at_fn_check_status 0 $at_status "$at_srcdir/extrac11.at:26"
+$at_failed && at_fn_log_failure
+$at_traceon; }
+
+
+
+
+  set +x
+  $at_times_p && times >"$at_times_file"
+) 5>&1 2>&1 7>&- | eval $at_tee_pipe
+read at_status <"$at_status_file"
+#AT_STOP_37
+#AT_START_38
+at_fn_group_banner 38 'extrac12.at:23' \
+  "extract dot permissions" "                        "
+at_xfail=no
+      test -f $XFAILFILE && at_xfail=yes
+(
+  $as_echo "38. $at_setup_line: testing $at_desc ..."
+  $at_traceon
+
+
+
+
+
+  { set +x
+$as_echo "$at_srcdir/extrac12.at:26:
 mkdir gnu
 (cd gnu
 TEST_TAR_FORMAT=gnu
 export TEST_TAR_FORMAT
-TAR_OPTIONS="-H gnu"
-export TAR_OPTIONS
-rm -rf *
-
-exec </dev/null
-dirs='a
-      a/b
-      a/b/c
-      a/b/c/d
-      a/b/c/d/e
-      a/b/c/d/e/f
-      a/b/c/d/e/f/g
-      a/b/c/d/e/f/g/h
-      a/b/c/d/e/f/g/h/i
-      a/b/c/d/e/f/g/h/i/j
-      a/b/c/d/e/f/g/h/i/j/k
-'
-files=
-mkdir $dirs dest1 dest2 dest3 || exit
-for dir in $dirs; do
-  for file in X Y Z; do
-    echo $file >$dir/$file || exit
-    files="$files $file"
-  done
-done
-
-# Check that "ulimit" itself works.  Close file descriptors before
-# invoking ulimit, to work around a bug (or a "feature") in some shells,
-# where they squirrel away dups of file descriptors into FD 10 and up
-# before closing the originals.
-( (exec 3<&- 4<&- 5<&- 6<&- 7<&- 8<&- 9<&- &&
-   ulimit -n 100 &&
-   tar -cf archive1.tar a &&
-   tar -xf archive1.tar -C dest1 a
-  ) &&
-  diff -r a dest1/a
-) >/dev/null 2>&1 ||
-   exit 77
-
-# Another test that "ulimit" itself works:
-# tar should fail when completely starved of file descriptors.
-( (exec 3<&- 4<&- 5<&- 6<&- 7<&- 8<&- 9<&- &&
-   ulimit -n 4 &&
-   tar -cf archive2.tar a &&
-   tar -xf archive2.tar -C dest2 a
-  ) &&
-  diff -r a dest2/a
-) >/dev/null 2>&1 &&
-   exit 77
-
-# Tar should work when there are few, but enough, file descriptors.
-( (exec 3<&- 4<&- 5<&- 6<&- 7<&- 8<&- 9<&- &&
-   ulimit -n 10 &&
-   tar -cf archive3.tar a &&
-   tar -xf archive3.tar -C dest3 a
-  ) &&
-  diff -r a dest3/a >/dev/null 2>&1
-) || { diff -r a dest3/a; exit 1; }
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
-at_func_diff_devnull "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/extrac11.at:26"
-
-$at_failed && at_func_log_failure
-$at_traceon; }
-
-
-
-
-  $at_traceoff
-  $at_times_p && times >"$at_times_file"
-) 5>&1 2>&1 | eval $at_tee_pipe
-at_status=`cat "$at_status_file"`
-#AT_STOP_37
-#AT_START_38
-# 38. extrac12.at:23: extract dot permissions
-at_setup_line='extrac12.at:23'
-at_desc="extract dot permissions"
-$at_quiet $as_echo_n " 38: $at_desc                        "
-at_xfail=no
-      test -f $XFAILFILE && at_xfail=yes
-echo "#                             -*- compilation -*-" >> "$at_group_log"
-(
-  $as_echo "38. extrac12.at:23: testing ..."
-  $at_traceon
-
-
-
-
-
-  { $at_traceoff
-$as_echo "$at_srcdir/extrac12.at:26:
-mkdir gnu
-(cd gnu
-TEST_TAR_FORMAT=gnu
-export TEST_TAR_FORMAT
-TAR_OPTIONS=\"-H gnu\"
+TAR_OPTIONS=\"-H gnu\"
 export TAR_OPTIONS
 rm -rf *
 
@@ -15735,32 +11753,8 @@ tar -xf archive.tar -C dst &&
 cmp src/file1 dst/file1 &&
 cmp src/file2 dst/file2
 )"
-echo extrac12.at:26 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir gnu
-(cd gnu
-TEST_TAR_FORMAT=gnu
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H gnu"
-export TAR_OPTIONS
-rm -rf *
-
-mkdir src dst
-echo file1 >src/file1
-echo file2 >src/file2
-chmod a-w src
-
-tar --no-recursion -cf archive.tar -C src . ./file1 file2 &&
-tar -xf archive.tar -C dst &&
-cmp src/file1 dst/file1 &&
-cmp src/file2 dst/file2
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'an embedded newline' "extrac12.at:26"
+( $at_check_trace;
 mkdir gnu
 (cd gnu
 TEST_TAR_FORMAT=gnu
@@ -15778,42 +11772,38 @@ tar --no-recursion -cf archive.tar -C sr
 tar -xf archive.tar -C dst &&
 cmp src/file1 dst/file1 &&
 cmp src/file2 dst/file2
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
-at_func_diff_devnull "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/extrac12.at:26"
-
-$at_failed && at_func_log_failure
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
+at_fn_diff_devnull "$at_stdout" || at_failed=:
+at_fn_check_status 0 $at_status "$at_srcdir/extrac12.at:26"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
 
 
 
-  $at_traceoff
+  set +x
   $at_times_p && times >"$at_times_file"
-) 5>&1 2>&1 | eval $at_tee_pipe
-at_status=`cat "$at_status_file"`
+) 5>&1 2>&1 7>&- | eval $at_tee_pipe
+read at_status <"$at_status_file"
 #AT_STOP_38
 #AT_START_39
-# 39. extrac13.at:24: extract over symlinks
-at_setup_line='extrac13.at:24'
-at_desc="extract over symlinks"
-$at_quiet $as_echo_n " 39: $at_desc                          "
+at_fn_group_banner 39 'extrac13.at:24' \
+  "extract over symlinks" "                          "
 at_xfail=no
       test -f $XFAILFILE && at_xfail=yes
-echo "#                             -*- compilation -*-" >> "$at_group_log"
 (
-  $as_echo "39. extrac13.at:24: testing ..."
+  $as_echo "39. $at_setup_line: testing $at_desc ..."
   $at_traceon
 
 
 
 
 
-  { $at_traceoff
+  { set +x
 $as_echo "$at_srcdir/extrac13.at:27:
 mkdir gnu
 (cd gnu
@@ -15846,45 +11836,8 @@ tar --overwrite -xhf archive.tar -C dst3
 diff src/file1 dst3/file1 &&
 diff src/file1 dst3/target1
 )"
-echo extrac13.at:27 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir gnu
-(cd gnu
-TEST_TAR_FORMAT=gnu
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H gnu"
-export TAR_OPTIONS
-rm -rf *
-
-mkdir src dst1 dst2 dst3
-echo file1 >src/file1
-ln -s target1 dst1/file1
-echo target1 >dst1/target1
-echo target1 >target1
-
-tar -cf archive.tar -C src . &&
-tar -xf archive.tar -C dst1 --warning=no-timestamp &&
-diff src/file1 dst1/file1 &&
-diff target1 dst1/target1
-
-ln -s target1 dst2/file1
-echo target1 >dst2/target1
-tar --overwrite -xf archive.tar -C dst2 --warning=no-timestamp &&
-diff src/file1 dst2/file1 &&
-diff target1 dst2/target1
-
-ln -s target1 dst3/file1
-echo target1 >dst3/target1
-tar --overwrite -xhf archive.tar -C dst3 --warning=no-timestamp &&
-diff src/file1 dst3/file1 &&
-diff src/file1 dst3/target1
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'an embedded newline' "extrac13.at:27"
+( $at_check_trace;
 mkdir gnu
 (cd gnu
 TEST_TAR_FORMAT=gnu
@@ -15915,42 +11868,38 @@ echo target1 >dst3/target1
 tar --overwrite -xhf archive.tar -C dst3 --warning=no-timestamp &&
 diff src/file1 dst3/file1 &&
 diff src/file1 dst3/target1
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
-at_func_diff_devnull "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/extrac13.at:27"
-
-$at_failed && at_func_log_failure
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
+at_fn_diff_devnull "$at_stdout" || at_failed=:
+at_fn_check_status 0 $at_status "$at_srcdir/extrac13.at:27"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
 
 
 
-  $at_traceoff
+  set +x
   $at_times_p && times >"$at_times_file"
-) 5>&1 2>&1 | eval $at_tee_pipe
-at_status=`cat "$at_status_file"`
+) 5>&1 2>&1 7>&- | eval $at_tee_pipe
+read at_status <"$at_status_file"
 #AT_STOP_39
 #AT_START_40
-# 40. extrac14.at:23: extract -C symlink
-at_setup_line='extrac14.at:23'
-at_desc="extract -C symlink"
-$at_quiet $as_echo_n " 40: $at_desc                             "
+at_fn_group_banner 40 'extrac14.at:23' \
+  "extract -C symlink" "                             "
 at_xfail=no
       test -f $XFAILFILE && at_xfail=yes
-echo "#                             -*- compilation -*-" >> "$at_group_log"
 (
-  $as_echo "40. extrac14.at:23: testing ..."
+  $as_echo "40. $at_setup_line: testing $at_desc ..."
   $at_traceon
 
 
 
 
 
-  { $at_traceoff
+  { set +x
 $as_echo "$at_srcdir/extrac14.at:26:
 mkdir gnu
 (cd gnu
@@ -15967,29 +11916,8 @@ tar -cf archive.tar foo &&
 tar -xf archive.tar -C symlink --warning=no-timestamp &&
 cmp foo dest/foo
 )"
-echo extrac14.at:26 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir gnu
-(cd gnu
-TEST_TAR_FORMAT=gnu
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H gnu"
-export TAR_OPTIONS
-rm -rf *
-
-mkdir dest
-ln -s dest symlink
-echo foo >foo
-tar -cf archive.tar foo &&
-tar -xf archive.tar -C symlink --warning=no-timestamp &&
-cmp foo dest/foo
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'an embedded newline' "extrac14.at:26"
+( $at_check_trace;
 mkdir gnu
 (cd gnu
 TEST_TAR_FORMAT=gnu
@@ -16004,42 +11932,38 @@ echo foo >foo
 tar -cf archive.tar foo &&
 tar -xf archive.tar -C symlink --warning=no-timestamp &&
 cmp foo dest/foo
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
-at_func_diff_devnull "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/extrac14.at:26"
-
-$at_failed && at_func_log_failure
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
+at_fn_diff_devnull "$at_stdout" || at_failed=:
+at_fn_check_status 0 $at_status "$at_srcdir/extrac14.at:26"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
 
 
 
-  $at_traceoff
+  set +x
   $at_times_p && times >"$at_times_file"
-) 5>&1 2>&1 | eval $at_tee_pipe
-at_status=`cat "$at_status_file"`
+) 5>&1 2>&1 7>&- | eval $at_tee_pipe
+read at_status <"$at_status_file"
 #AT_STOP_40
 #AT_START_41
-# 41. extrac15.at:23: extract parent mkdir failure
-at_setup_line='extrac15.at:23'
-at_desc="extract parent mkdir failure"
-$at_quiet $as_echo_n " 41: $at_desc                   "
+at_fn_group_banner 41 'extrac15.at:23' \
+  "extract parent mkdir failure" "                   "
 at_xfail=no
       test -f $XFAILFILE && at_xfail=yes
-echo "#                             -*- compilation -*-" >> "$at_group_log"
 (
-  $as_echo "41. extrac15.at:23: testing ..."
+  $as_echo "41. $at_setup_line: testing $at_desc ..."
   $at_traceon
 
 
 
 
 
-  { $at_traceoff
+  { set +x
 $as_echo "$at_srcdir/extrac15.at:26:
 mkdir gnu
 (cd gnu
@@ -16050,12 +11974,12 @@ export TAR_OPTIONS
 rm -rf *
 
 
-echo "test" > $$
-chmod 0 $$
-cat $$ > /dev/null 2>&1
-result=$?
-rm -f $$
-test $result -eq 0 && exit 77
+echo \"test\" > \$\$
+chmod 0 \$\$
+cat \$\$ > /dev/null 2>&1
+result=\$?
+rm -f \$\$
+test \$result -eq 0 && exit 77
 
 
 mkdir src src/a src/a/b dest dest/a
@@ -16068,41 +11992,8 @@ then (exit 1)
 else (exit 0)
 fi
 )"
-echo extrac15.at:26 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir gnu
-(cd gnu
-TEST_TAR_FORMAT=gnu
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H gnu"
-export TAR_OPTIONS
-rm -rf *
-
-
-echo "test" > $$
-chmod 0 $$
-cat $$ > /dev/null 2>&1
-result=$?
-rm -f $$
-test $result -eq 0 && exit 77
-
-
-mkdir src src/a src/a/b dest dest/a
-touch src/a/b/c
-chmod a-w dest/a
-
-tar -cf archive.tar -C src a/b/c &&
-if tar -xf archive.tar -C dest a/b/c
-then (exit 1)
-else (exit 0)
-fi
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'an embedded newline' "extrac15.at:26"
+( $at_check_trace;
 mkdir gnu
 (cd gnu
 TEST_TAR_FORMAT=gnu
@@ -16129,46 +12020,42 @@ if tar -xf archive.tar -C dest a/b/c
 then (exit 1)
 else (exit 0)
 fi
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
 echo >>"$at_stderr"; $as_echo "tar: a/b: Cannot mkdir: Permission denied
 tar: a/b/c: Cannot open: No such file or directory
 tar: Exiting with failure status due to previous errors
 " | \
   $at_diff - "$at_stderr" || at_failed=:
-at_func_diff_devnull "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/extrac15.at:26"
-
-$at_failed && at_func_log_failure
+at_fn_diff_devnull "$at_stdout" || at_failed=:
+at_fn_check_status 0 $at_status "$at_srcdir/extrac15.at:26"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
 
 
 
-  $at_traceoff
+  set +x
   $at_times_p && times >"$at_times_file"
-) 5>&1 2>&1 | eval $at_tee_pipe
-at_status=`cat "$at_status_file"`
+) 5>&1 2>&1 7>&- | eval $at_tee_pipe
+read at_status <"$at_status_file"
 #AT_STOP_41
 #AT_START_42
-# 42. extrac16.at:24: extract empty directory with -C
-at_setup_line='extrac16.at:24'
-at_desc="extract empty directory with -C"
-$at_quiet $as_echo_n " 42: $at_desc                "
+at_fn_group_banner 42 'extrac16.at:24' \
+  "extract empty directory with -C" "                "
 at_xfail=no
       test -f $XFAILFILE && at_xfail=yes
-echo "#                             -*- compilation -*-" >> "$at_group_log"
 (
-  $as_echo "42. extrac16.at:24: testing ..."
+  $as_echo "42. $at_setup_line: testing $at_desc ..."
   $at_traceon
 
 
 
 
 
-  { $at_traceoff
+  { set +x
 $as_echo "$at_srcdir/extrac16.at:27:
 mkdir gnu
 (cd gnu
@@ -16184,28 +12071,8 @@ touch src/a/c
 tar -cf archive.tar -C src a &&
 tar -xf archive.tar -C dest
 )"
-echo extrac16.at:27 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir gnu
-(cd gnu
-TEST_TAR_FORMAT=gnu
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H gnu"
-export TAR_OPTIONS
-rm -rf *
-
-mkdir src src/a src/a/b dest
-touch src/a/c
-
-tar -cf archive.tar -C src a &&
-tar -xf archive.tar -C dest
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'an embedded newline' "extrac16.at:27"
+( $at_check_trace;
 mkdir gnu
 (cd gnu
 TEST_TAR_FORMAT=gnu
@@ -16219,35 +12086,31 @@ touch src/a/c
 
 tar -cf archive.tar -C src a &&
 tar -xf archive.tar -C dest
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
-at_func_diff_devnull "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/extrac16.at:27"
-
-$at_failed && at_func_log_failure
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
+at_fn_diff_devnull "$at_stdout" || at_failed=:
+at_fn_check_status 0 $at_status "$at_srcdir/extrac16.at:27"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
 
 
 
-  $at_traceoff
+  set +x
   $at_times_p && times >"$at_times_file"
-) 5>&1 2>&1 | eval $at_tee_pipe
-at_status=`cat "$at_status_file"`
+) 5>&1 2>&1 7>&- | eval $at_tee_pipe
+read at_status <"$at_status_file"
 #AT_STOP_42
 #AT_START_43
-# 43. extrac17.at:19: name matching/transformation ordering
-at_setup_line='extrac17.at:19'
-at_desc="name matching/transformation ordering"
-$at_quiet $as_echo_n " 43: $at_desc          "
+at_fn_group_banner 43 'extrac17.at:19' \
+  "name matching/transformation ordering" "          "
 at_xfail=no
       test -f $XFAILFILE && at_xfail=yes
-echo "#                             -*- compilation -*-" >> "$at_group_log"
 (
-  $as_echo "43. extrac17.at:19: testing ..."
+  $as_echo "43. $at_setup_line: testing $at_desc ..."
   $at_traceon
 
 
@@ -16264,7 +12127,7 @@ echo "#                             -*-
 
 
 
-  { $at_traceoff
+  { set +x
 $as_echo "$at_srcdir/extrac17.at:32:
 mkdir v7
 (cd v7
@@ -16283,31 +12146,8 @@ tar cf dir.tar dir
 tar -x -v -f dir.tar -C out --strip-components=2 --warning=no-timestamp \\
   dir/subdir1/
 )"
-echo extrac17.at:32 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir v7
-(cd v7
-TEST_TAR_FORMAT=v7
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H v7"
-export TAR_OPTIONS
-rm -rf *
-
-mkdir dir dir/subdir1 dir/subdir2 out
-genfile --file dir/subdir1/file1
-genfile --file dir/subdir2/file2
-
-tar cf dir.tar dir
-
-tar -x -v -f dir.tar -C out --strip-components=2 --warning=no-timestamp \
-  dir/subdir1/
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'an embedded newline' "extrac17.at:32"
+( $at_check_trace;
 mkdir v7
 (cd v7
 TEST_TAR_FORMAT=v7
@@ -16324,20 +12164,19 @@ tar cf dir.tar dir
 
 tar -x -v -f dir.tar -C out --strip-components=2 --warning=no-timestamp \
   dir/subdir1/
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "dir/subdir1/file1
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/extrac17.at:32"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/extrac17.at:32"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/extrac17.at:32:
 mkdir oldgnu
 (cd oldgnu
@@ -16356,31 +12195,8 @@ tar cf dir.tar dir
 tar -x -v -f dir.tar -C out --strip-components=2 --warning=no-timestamp \\
   dir/subdir1/
 )"
-echo extrac17.at:32 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir oldgnu
-(cd oldgnu
-TEST_TAR_FORMAT=oldgnu
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H oldgnu"
-export TAR_OPTIONS
-rm -rf *
-
-mkdir dir dir/subdir1 dir/subdir2 out
-genfile --file dir/subdir1/file1
-genfile --file dir/subdir2/file2
-
-tar cf dir.tar dir
-
-tar -x -v -f dir.tar -C out --strip-components=2 --warning=no-timestamp \
-  dir/subdir1/
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'an embedded newline' "extrac17.at:32"
+( $at_check_trace;
 mkdir oldgnu
 (cd oldgnu
 TEST_TAR_FORMAT=oldgnu
@@ -16397,20 +12213,19 @@ tar cf dir.tar dir
 
 tar -x -v -f dir.tar -C out --strip-components=2 --warning=no-timestamp \
   dir/subdir1/
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "dir/subdir1/file1
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/extrac17.at:32"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/extrac17.at:32"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/extrac17.at:32:
 mkdir ustar
 (cd ustar
@@ -16429,11 +12244,8 @@ tar cf dir.tar dir
 tar -x -v -f dir.tar -C out --strip-components=2 --warning=no-timestamp \\
   dir/subdir1/
 )"
-echo extrac17.at:32 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
+at_fn_check_prepare_notrace 'an embedded newline' "extrac17.at:32"
+( $at_check_trace;
 mkdir ustar
 (cd ustar
 TEST_TAR_FORMAT=ustar
@@ -16450,40 +12262,19 @@ tar cf dir.tar dir
 
 tar -x -v -f dir.tar -C out --strip-components=2 --warning=no-timestamp \
   dir/subdir1/
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
-mkdir ustar
-(cd ustar
-TEST_TAR_FORMAT=ustar
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H ustar"
-export TAR_OPTIONS
-rm -rf *
-
-mkdir dir dir/subdir1 dir/subdir2 out
-genfile --file dir/subdir1/file1
-genfile --file dir/subdir2/file2
-
-tar cf dir.tar dir
-
-tar -x -v -f dir.tar -C out --strip-components=2 --warning=no-timestamp \
-  dir/subdir1/
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "dir/subdir1/file1
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/extrac17.at:32"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/extrac17.at:32"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/extrac17.at:32:
 mkdir posix
 (cd posix
@@ -16502,31 +12293,8 @@ tar cf dir.tar dir
 tar -x -v -f dir.tar -C out --strip-components=2 --warning=no-timestamp \\
   dir/subdir1/
 )"
-echo extrac17.at:32 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir posix
-(cd posix
-TEST_TAR_FORMAT=posix
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H posix"
-export TAR_OPTIONS
-rm -rf *
-
-mkdir dir dir/subdir1 dir/subdir2 out
-genfile --file dir/subdir1/file1
-genfile --file dir/subdir2/file2
-
-tar cf dir.tar dir
-
-tar -x -v -f dir.tar -C out --strip-components=2 --warning=no-timestamp \
-  dir/subdir1/
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'an embedded newline' "extrac17.at:32"
+( $at_check_trace;
 mkdir posix
 (cd posix
 TEST_TAR_FORMAT=posix
@@ -16543,20 +12311,19 @@ tar cf dir.tar dir
 
 tar -x -v -f dir.tar -C out --strip-components=2 --warning=no-timestamp \
   dir/subdir1/
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "dir/subdir1/file1
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/extrac17.at:32"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/extrac17.at:32"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/extrac17.at:32:
 mkdir gnu
 (cd gnu
@@ -16575,11 +12342,8 @@ tar cf dir.tar dir
 tar -x -v -f dir.tar -C out --strip-components=2 --warning=no-timestamp \\
   dir/subdir1/
 )"
-echo extrac17.at:32 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
+at_fn_check_prepare_notrace 'an embedded newline' "extrac17.at:32"
+( $at_check_trace;
 mkdir gnu
 (cd gnu
 TEST_TAR_FORMAT=gnu
@@ -16596,64 +12360,40 @@ tar cf dir.tar dir
 
 tar -x -v -f dir.tar -C out --strip-components=2 --warning=no-timestamp \
   dir/subdir1/
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
-mkdir gnu
-(cd gnu
-TEST_TAR_FORMAT=gnu
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H gnu"
-export TAR_OPTIONS
-rm -rf *
-
-mkdir dir dir/subdir1 dir/subdir2 out
-genfile --file dir/subdir1/file1
-genfile --file dir/subdir2/file2
-
-tar cf dir.tar dir
-
-tar -x -v -f dir.tar -C out --strip-components=2 --warning=no-timestamp \
-  dir/subdir1/
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "dir/subdir1/file1
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/extrac17.at:32"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/extrac17.at:32"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
 
 
 
-  $at_traceoff
+  set +x
   $at_times_p && times >"$at_times_file"
-) 5>&1 2>&1 | eval $at_tee_pipe
-at_status=`cat "$at_status_file"`
+) 5>&1 2>&1 7>&- | eval $at_tee_pipe
+read at_status <"$at_status_file"
 #AT_STOP_43
 #AT_START_44
-# 44. label01.at:19: single-volume label
-at_setup_line='label01.at:19'
-at_desc="single-volume label"
-$at_quiet $as_echo_n " 44: $at_desc                            "
+at_fn_group_banner 44 'label01.at:19' \
+  "single-volume label" "                            "
 at_xfail=no
       test -f $XFAILFILE && at_xfail=yes
-echo "#                             -*- compilation -*-" >> "$at_group_log"
 (
-  $as_echo "44. label01.at:19: testing ..."
+  $as_echo "44. $at_setup_line: testing $at_desc ..."
   $at_traceon
 
 
 
 
 
-  { $at_traceoff
+  { set +x
 $as_echo "$at_srcdir/label01.at:22:
 mkdir gnu
 (cd gnu
@@ -16668,27 +12408,8 @@ genfile --file bar
 tar -cf archive --label=Test foo bar
 tar tf archive
 )"
-echo label01.at:22 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir gnu
-(cd gnu
-TEST_TAR_FORMAT=gnu
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H gnu"
-export TAR_OPTIONS
-rm -rf *
-
-genfile --file foo
-genfile --file bar
-tar -cf archive --label=Test foo bar
-tar tf archive
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'an embedded newline' "label01.at:22"
+( $at_check_trace;
 mkdir gnu
 (cd gnu
 TEST_TAR_FORMAT=gnu
@@ -16701,22 +12422,21 @@ genfile --file foo
 genfile --file bar
 tar -cf archive --label=Test foo bar
 tar tf archive
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "Test
 foo
 bar
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/label01.at:22"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/label01.at:22"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/label01.at:22:
 mkdir oldgnu
 (cd oldgnu
@@ -16731,27 +12451,8 @@ genfile --file bar
 tar -cf archive --label=Test foo bar
 tar tf archive
 )"
-echo label01.at:22 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir oldgnu
-(cd oldgnu
-TEST_TAR_FORMAT=oldgnu
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H oldgnu"
-export TAR_OPTIONS
-rm -rf *
-
-genfile --file foo
-genfile --file bar
-tar -cf archive --label=Test foo bar
-tar tf archive
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'an embedded newline' "label01.at:22"
+( $at_check_trace;
 mkdir oldgnu
 (cd oldgnu
 TEST_TAR_FORMAT=oldgnu
@@ -16764,22 +12465,21 @@ genfile --file foo
 genfile --file bar
 tar -cf archive --label=Test foo bar
 tar tf archive
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "Test
 foo
 bar
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/label01.at:22"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/label01.at:22"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/label01.at:22:
 mkdir posix
 (cd posix
@@ -16794,27 +12494,8 @@ genfile --file bar
 tar -cf archive --label=Test foo bar
 tar tf archive
 )"
-echo label01.at:22 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir posix
-(cd posix
-TEST_TAR_FORMAT=posix
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H posix"
-export TAR_OPTIONS
-rm -rf *
-
-genfile --file foo
-genfile --file bar
-tar -cf archive --label=Test foo bar
-tar tf archive
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'an embedded newline' "label01.at:22"
+( $at_check_trace;
 mkdir posix
 (cd posix
 TEST_TAR_FORMAT=posix
@@ -16827,46 +12508,42 @@ genfile --file foo
 genfile --file bar
 tar -cf archive --label=Test foo bar
 tar tf archive
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "Test
 foo
 bar
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/label01.at:22"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/label01.at:22"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
 
 
 
-  $at_traceoff
+  set +x
   $at_times_p && times >"$at_times_file"
-) 5>&1 2>&1 | eval $at_tee_pipe
-at_status=`cat "$at_status_file"`
+) 5>&1 2>&1 7>&- | eval $at_tee_pipe
+read at_status <"$at_status_file"
 #AT_STOP_44
 #AT_START_45
-# 45. label02.at:19: multi-volume label
-at_setup_line='label02.at:19'
-at_desc="multi-volume label"
-$at_quiet $as_echo_n " 45: $at_desc                             "
+at_fn_group_banner 45 'label02.at:19' \
+  "multi-volume label" "                             "
 at_xfail=no
       test -f $XFAILFILE && at_xfail=yes
-echo "#                             -*- compilation -*-" >> "$at_group_log"
 (
-  $as_echo "45. label02.at:19: testing ..."
+  $as_echo "45. $at_setup_line: testing $at_desc ..."
   $at_traceon
 
 
 
 
 
-  { $at_traceoff
+  { set +x
 $as_echo "$at_srcdir/label02.at:22:
 mkdir gnu
 (cd gnu
@@ -16883,29 +12560,8 @@ genfile --length 12288 --file baz
 tar --label=Test -cM -L10 -f 1.tar -f 2.tar -f 3.tar -f 4.tar foo bar baz
 tar -Mt -f 1.tar -f 2.tar -f 3.tar -f 4.tar
 )"
-echo label02.at:22 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir gnu
-(cd gnu
-TEST_TAR_FORMAT=gnu
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H gnu"
-export TAR_OPTIONS
-rm -rf *
-
-exec <&-
-genfile --length 0 --file foo
-genfile --length 12288 --file bar
-genfile --length 12288 --file baz
-tar --label=Test -cM -L10 -f 1.tar -f 2.tar -f 3.tar -f 4.tar foo bar baz
-tar -Mt -f 1.tar -f 2.tar -f 3.tar -f 4.tar
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'an embedded newline' "label02.at:22"
+( $at_check_trace;
 mkdir gnu
 (cd gnu
 TEST_TAR_FORMAT=gnu
@@ -16920,23 +12576,22 @@ genfile --length 12288 --file bar
 genfile --length 12288 --file baz
 tar --label=Test -cM -L10 -f 1.tar -f 2.tar -f 3.tar -f 4.tar foo bar baz
 tar -Mt -f 1.tar -f 2.tar -f 3.tar -f 4.tar
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "Test Volume 1
 foo
 bar
 baz
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/label02.at:22"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/label02.at:22"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/label02.at:22:
 mkdir oldgnu
 (cd oldgnu
@@ -16953,29 +12608,8 @@ genfile --length 12288 --file baz
 tar --label=Test -cM -L10 -f 1.tar -f 2.tar -f 3.tar -f 4.tar foo bar baz
 tar -Mt -f 1.tar -f 2.tar -f 3.tar -f 4.tar
 )"
-echo label02.at:22 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir oldgnu
-(cd oldgnu
-TEST_TAR_FORMAT=oldgnu
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H oldgnu"
-export TAR_OPTIONS
-rm -rf *
-
-exec <&-
-genfile --length 0 --file foo
-genfile --length 12288 --file bar
-genfile --length 12288 --file baz
-tar --label=Test -cM -L10 -f 1.tar -f 2.tar -f 3.tar -f 4.tar foo bar baz
-tar -Mt -f 1.tar -f 2.tar -f 3.tar -f 4.tar
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'an embedded newline' "label02.at:22"
+( $at_check_trace;
 mkdir oldgnu
 (cd oldgnu
 TEST_TAR_FORMAT=oldgnu
@@ -16990,23 +12624,22 @@ genfile --length 12288 --file bar
 genfile --length 12288 --file baz
 tar --label=Test -cM -L10 -f 1.tar -f 2.tar -f 3.tar -f 4.tar foo bar baz
 tar -Mt -f 1.tar -f 2.tar -f 3.tar -f 4.tar
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "Test Volume 1
 foo
 bar
 baz
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/label02.at:22"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/label02.at:22"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/label02.at:22:
 mkdir posix
 (cd posix
@@ -17023,29 +12656,8 @@ genfile --length 12288 --file baz
 tar --label=Test -cM -L10 -f 1.tar -f 2.tar -f 3.tar -f 4.tar foo bar baz
 tar -Mt -f 1.tar -f 2.tar -f 3.tar -f 4.tar
 )"
-echo label02.at:22 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir posix
-(cd posix
-TEST_TAR_FORMAT=posix
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H posix"
-export TAR_OPTIONS
-rm -rf *
-
-exec <&-
-genfile --length 0 --file foo
-genfile --length 12288 --file bar
-genfile --length 12288 --file baz
-tar --label=Test -cM -L10 -f 1.tar -f 2.tar -f 3.tar -f 4.tar foo bar baz
-tar -Mt -f 1.tar -f 2.tar -f 3.tar -f 4.tar
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'an embedded newline' "label02.at:22"
+( $at_check_trace;
 mkdir posix
 (cd posix
 TEST_TAR_FORMAT=posix
@@ -17060,47 +12672,43 @@ genfile --length 12288 --file bar
 genfile --length 12288 --file baz
 tar --label=Test -cM -L10 -f 1.tar -f 2.tar -f 3.tar -f 4.tar foo bar baz
 tar -Mt -f 1.tar -f 2.tar -f 3.tar -f 4.tar
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "Test Volume 1
 foo
 bar
 baz
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/label02.at:22"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/label02.at:22"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
 
 
 
-  $at_traceoff
+  set +x
   $at_times_p && times >"$at_times_file"
-) 5>&1 2>&1 | eval $at_tee_pipe
-at_status=`cat "$at_status_file"`
+) 5>&1 2>&1 7>&- | eval $at_tee_pipe
+read at_status <"$at_status_file"
 #AT_STOP_45
 #AT_START_46
-# 46. label03.at:25: test-label option
-at_setup_line='label03.at:25'
-at_desc="test-label option"
-$at_quiet $as_echo_n " 46: $at_desc                              "
+at_fn_group_banner 46 'label03.at:25' \
+  "test-label option" "                              "
 at_xfail=no
       test -f $XFAILFILE && at_xfail=yes
-echo "#                             -*- compilation -*-" >> "$at_group_log"
 (
-  $as_echo "46. label03.at:25: testing ..."
+  $as_echo "46. $at_setup_line: testing $at_desc ..."
   $at_traceon
 
 
 
 
 
-  { $at_traceoff
+  { set +x
 $as_echo "$at_srcdir/label03.at:28:
 mkdir gnu
 (cd gnu
@@ -17133,45 +12741,8 @@ tar --test-label --file=iamanarchive a i
 decho \"# Test label: wildcards\"
 tar --test-label --file=iamanarchive --wildcards '*label'; echo \$?
 )"
-echo label03.at:28 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir gnu
-(cd gnu
-TEST_TAR_FORMAT=gnu
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H gnu"
-export TAR_OPTIONS
-rm -rf *
-
-exec <&-
-genfile --file file
-tar -c --label='iamalabel' --file iamanarchive file
-tar -c --file unlabeled.tar file
-decho "# Display label"
-tar --test-label --file=iamanarchive; echo $?
-decho "# Display label: unlabeled"
-tar --test-label --file=unlabeled.tar; echo $?
-decho "# Test label: success"
-tar --test-label --file=iamanarchive 'iamalabel'; echo $?
-decho "# Test label: failure"
-tar --test-label --file=iamanarchive 'amalabel'; echo $?
-decho "# Test label: unlabeled"
-tar --test-label --file=unlabeled.tar 'amalabel'; echo $?
-decho "# Test label, verbose: success"
-tar --test-label --verbose --file=iamanarchive 'iamalabel'; echo $?
-decho "# Test label, verbose: failure"
-tar --test-label --verbose --file=iamanarchive 'amalabel'; echo $?
-decho "# Test label: multiple arguments"
-tar --test-label --file=iamanarchive a iamalabel b; echo $?
-decho "# Test label: wildcards"
-tar --test-label --file=iamanarchive --wildcards '*label'; echo $?
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'an embedded newline' "label03.at:28"
+( $at_check_trace;
 mkdir gnu
 (cd gnu
 TEST_TAR_FORMAT=gnu
@@ -17202,10 +12773,10 @@ decho "# Test label: multiple arguments"
 tar --test-label --file=iamanarchive a iamalabel b; echo $?
 decho "# Test label: wildcards"
 tar --test-label --file=iamanarchive --wildcards '*label'; echo $?
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
 echo >>"$at_stderr"; $as_echo "# Display label
 # Display label: unlabeled
 # Test label: success
@@ -17241,12 +12812,11 @@ iamalabel
 0
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/label03.at:28"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/label03.at:28"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/label03.at:28:
 mkdir oldgnu
 (cd oldgnu
@@ -17279,45 +12849,8 @@ tar --test-label --file=iamanarchive a i
 decho \"# Test label: wildcards\"
 tar --test-label --file=iamanarchive --wildcards '*label'; echo \$?
 )"
-echo label03.at:28 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir oldgnu
-(cd oldgnu
-TEST_TAR_FORMAT=oldgnu
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H oldgnu"
-export TAR_OPTIONS
-rm -rf *
-
-exec <&-
-genfile --file file
-tar -c --label='iamalabel' --file iamanarchive file
-tar -c --file unlabeled.tar file
-decho "# Display label"
-tar --test-label --file=iamanarchive; echo $?
-decho "# Display label: unlabeled"
-tar --test-label --file=unlabeled.tar; echo $?
-decho "# Test label: success"
-tar --test-label --file=iamanarchive 'iamalabel'; echo $?
-decho "# Test label: failure"
-tar --test-label --file=iamanarchive 'amalabel'; echo $?
-decho "# Test label: unlabeled"
-tar --test-label --file=unlabeled.tar 'amalabel'; echo $?
-decho "# Test label, verbose: success"
-tar --test-label --verbose --file=iamanarchive 'iamalabel'; echo $?
-decho "# Test label, verbose: failure"
-tar --test-label --verbose --file=iamanarchive 'amalabel'; echo $?
-decho "# Test label: multiple arguments"
-tar --test-label --file=iamanarchive a iamalabel b; echo $?
-decho "# Test label: wildcards"
-tar --test-label --file=iamanarchive --wildcards '*label'; echo $?
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'an embedded newline' "label03.at:28"
+( $at_check_trace;
 mkdir oldgnu
 (cd oldgnu
 TEST_TAR_FORMAT=oldgnu
@@ -17348,10 +12881,10 @@ decho "# Test label: multiple arguments"
 tar --test-label --file=iamanarchive a iamalabel b; echo $?
 decho "# Test label: wildcards"
 tar --test-label --file=iamanarchive --wildcards '*label'; echo $?
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
 echo >>"$at_stderr"; $as_echo "# Display label
 # Display label: unlabeled
 # Test label: success
@@ -17387,12 +12920,11 @@ iamalabel
 0
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/label03.at:28"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/label03.at:28"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/label03.at:28:
 mkdir posix
 (cd posix
@@ -17425,45 +12957,8 @@ tar --test-label --file=iamanarchive a i
 decho \"# Test label: wildcards\"
 tar --test-label --file=iamanarchive --wildcards '*label'; echo \$?
 )"
-echo label03.at:28 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir posix
-(cd posix
-TEST_TAR_FORMAT=posix
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H posix"
-export TAR_OPTIONS
-rm -rf *
-
-exec <&-
-genfile --file file
-tar -c --label='iamalabel' --file iamanarchive file
-tar -c --file unlabeled.tar file
-decho "# Display label"
-tar --test-label --file=iamanarchive; echo $?
-decho "# Display label: unlabeled"
-tar --test-label --file=unlabeled.tar; echo $?
-decho "# Test label: success"
-tar --test-label --file=iamanarchive 'iamalabel'; echo $?
-decho "# Test label: failure"
-tar --test-label --file=iamanarchive 'amalabel'; echo $?
-decho "# Test label: unlabeled"
-tar --test-label --file=unlabeled.tar 'amalabel'; echo $?
-decho "# Test label, verbose: success"
-tar --test-label --verbose --file=iamanarchive 'iamalabel'; echo $?
-decho "# Test label, verbose: failure"
-tar --test-label --verbose --file=iamanarchive 'amalabel'; echo $?
-decho "# Test label: multiple arguments"
-tar --test-label --file=iamanarchive a iamalabel b; echo $?
-decho "# Test label: wildcards"
-tar --test-label --file=iamanarchive --wildcards '*label'; echo $?
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'an embedded newline' "label03.at:28"
+( $at_check_trace;
 mkdir posix
 (cd posix
 TEST_TAR_FORMAT=posix
@@ -17494,10 +12989,10 @@ decho "# Test label: multiple arguments"
 tar --test-label --file=iamanarchive a iamalabel b; echo $?
 decho "# Test label: wildcards"
 tar --test-label --file=iamanarchive --wildcards '*label'; echo $?
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
 echo >>"$at_stderr"; $as_echo "# Display label
 # Display label: unlabeled
 # Test label: success
@@ -17533,36 +13028,32 @@ iamalabel
 0
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/label03.at:28"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/label03.at:28"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
 
 
 
-  $at_traceoff
+  set +x
   $at_times_p && times >"$at_times_file"
-) 5>&1 2>&1 | eval $at_tee_pipe
-at_status=`cat "$at_status_file"`
+) 5>&1 2>&1 7>&- | eval $at_tee_pipe
+read at_status <"$at_status_file"
 #AT_STOP_46
 #AT_START_47
-# 47. label04.at:25: label with non-create option
-at_setup_line='label04.at:25'
-at_desc="label with non-create option"
-$at_quiet $as_echo_n " 47: $at_desc                   "
+at_fn_group_banner 47 'label04.at:25' \
+  "label with non-create option" "                   "
 at_xfail=no
       test -f $XFAILFILE && at_xfail=yes
-echo "#                             -*- compilation -*-" >> "$at_group_log"
 (
-  $as_echo "47. label04.at:25: testing ..."
+  $as_echo "47. $at_setup_line: testing $at_desc ..."
   $at_traceon
 
 
 
 
 
-  { $at_traceoff
+  { set +x
 $as_echo "$at_srcdir/label04.at:28:
 mkdir gnu
 (cd gnu
@@ -17581,11 +13072,8 @@ tar -rf archive --label='My volume' file
 decho \"# Update: right label\"
 tar -rf archive --label='New volume' file
 )"
-echo label04.at:28 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
+at_fn_check_prepare_notrace 'an embedded newline' "label04.at:28"
+( $at_check_trace;
 mkdir gnu
 (cd gnu
 TEST_TAR_FORMAT=gnu
@@ -17602,30 +13090,10 @@ decho "# Update: wrong label"
 tar -rf archive --label='My volume' file; echo $?
 decho "# Update: right label"
 tar -rf archive --label='New volume' file
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
-mkdir gnu
-(cd gnu
-TEST_TAR_FORMAT=gnu
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H gnu"
-export TAR_OPTIONS
-rm -rf *
-
-exec <&-
-genfile --file file
-decho "# Create volume"
-tar -c -f archive --label='New volume' file
-decho "# Update: wrong label"
-tar -rf archive --label='My volume' file; echo $?
-decho "# Update: right label"
-tar -rf archive --label='New volume' file
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
 echo >>"$at_stderr"; $as_echo "# Create volume
 # Update: wrong label
 tar: Volume \`New volume' does not match \`My volume'
@@ -17639,12 +13107,11 @@ echo >>"$at_stdout"; $as_echo "# Create
 # Update: right label
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/label04.at:28"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/label04.at:28"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/label04.at:28:
 mkdir oldgnu
 (cd oldgnu
@@ -17663,31 +13130,8 @@ tar -rf archive --label='My volume' file
 decho \"# Update: right label\"
 tar -rf archive --label='New volume' file
 )"
-echo label04.at:28 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir oldgnu
-(cd oldgnu
-TEST_TAR_FORMAT=oldgnu
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H oldgnu"
-export TAR_OPTIONS
-rm -rf *
-
-exec <&-
-genfile --file file
-decho "# Create volume"
-tar -c -f archive --label='New volume' file
-decho "# Update: wrong label"
-tar -rf archive --label='My volume' file; echo $?
-decho "# Update: right label"
-tar -rf archive --label='New volume' file
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'an embedded newline' "label04.at:28"
+( $at_check_trace;
 mkdir oldgnu
 (cd oldgnu
 TEST_TAR_FORMAT=oldgnu
@@ -17704,10 +13148,10 @@ decho "# Update: wrong label"
 tar -rf archive --label='My volume' file; echo $?
 decho "# Update: right label"
 tar -rf archive --label='New volume' file
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
 echo >>"$at_stderr"; $as_echo "# Create volume
 # Update: wrong label
 tar: Volume \`New volume' does not match \`My volume'
@@ -17721,12 +13165,11 @@ echo >>"$at_stdout"; $as_echo "# Create
 # Update: right label
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/label04.at:28"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/label04.at:28"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/label04.at:28:
 mkdir posix
 (cd posix
@@ -17745,31 +13188,8 @@ tar -rf archive --label='My volume' file
 decho \"# Update: right label\"
 tar -rf archive --label='New volume' file
 )"
-echo label04.at:28 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir posix
-(cd posix
-TEST_TAR_FORMAT=posix
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H posix"
-export TAR_OPTIONS
-rm -rf *
-
-exec <&-
-genfile --file file
-decho "# Create volume"
-tar -c -f archive --label='New volume' file
-decho "# Update: wrong label"
-tar -rf archive --label='My volume' file; echo $?
-decho "# Update: right label"
-tar -rf archive --label='New volume' file
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'an embedded newline' "label04.at:28"
+( $at_check_trace;
 mkdir posix
 (cd posix
 TEST_TAR_FORMAT=posix
@@ -17786,10 +13206,10 @@ decho "# Update: wrong label"
 tar -rf archive --label='My volume' file; echo $?
 decho "# Update: right label"
 tar -rf archive --label='New volume' file
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
 echo >>"$at_stderr"; $as_echo "# Create volume
 # Update: wrong label
 tar: Volume \`New volume' does not match \`My volume'
@@ -17803,36 +13223,32 @@ echo >>"$at_stdout"; $as_echo "# Create
 # Update: right label
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/label04.at:28"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/label04.at:28"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
 
 
 
-  $at_traceoff
+  set +x
   $at_times_p && times >"$at_times_file"
-) 5>&1 2>&1 | eval $at_tee_pipe
-at_status=`cat "$at_status_file"`
+) 5>&1 2>&1 7>&- | eval $at_tee_pipe
+read at_status <"$at_status_file"
 #AT_STOP_47
 #AT_START_48
-# 48. label05.at:22: label with non-create option
-at_setup_line='label05.at:22'
-at_desc="label with non-create option"
-$at_quiet $as_echo_n " 48: $at_desc                   "
+at_fn_group_banner 48 'label05.at:22' \
+  "label with non-create option" "                   "
 at_xfail=no
       test -f $XFAILFILE && at_xfail=yes
-echo "#                             -*- compilation -*-" >> "$at_group_log"
 (
-  $as_echo "48. label05.at:22: testing ..."
+  $as_echo "48. $at_setup_line: testing $at_desc ..."
   $at_traceon
 
 
 
 
 
-  { $at_traceoff
+  { set +x
 $as_echo "$at_srcdir/label05.at:25:
 mkdir gnu
 (cd gnu
@@ -17851,31 +13267,8 @@ tar -rf archive --label='My volume' file
 decho \"# Update: right label\"
 tar -rf archive file
 )"
-echo label05.at:25 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir gnu
-(cd gnu
-TEST_TAR_FORMAT=gnu
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H gnu"
-export TAR_OPTIONS
-rm -rf *
-
-exec <&-
-genfile --file file
-decho "# Create volume"
-tar -c -f archive file
-decho "# Update: wrong label"
-tar -rf archive --label='My volume' file; echo $?
-decho "# Update: right label"
-tar -rf archive file
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'an embedded newline' "label05.at:25"
+( $at_check_trace;
 mkdir gnu
 (cd gnu
 TEST_TAR_FORMAT=gnu
@@ -17892,10 +13285,10 @@ decho "# Update: wrong label"
 tar -rf archive --label='My volume' file; echo $?
 decho "# Update: right label"
 tar -rf archive file
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
 echo >>"$at_stderr"; $as_echo "# Create volume
 # Update: wrong label
 tar: Archive not labeled to match \`My volume'
@@ -17909,12 +13302,11 @@ echo >>"$at_stdout"; $as_echo "# Create
 # Update: right label
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/label05.at:25"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/label05.at:25"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/label05.at:25:
 mkdir oldgnu
 (cd oldgnu
@@ -17933,31 +13325,8 @@ tar -rf archive --label='My volume' file
 decho \"# Update: right label\"
 tar -rf archive file
 )"
-echo label05.at:25 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir oldgnu
-(cd oldgnu
-TEST_TAR_FORMAT=oldgnu
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H oldgnu"
-export TAR_OPTIONS
-rm -rf *
-
-exec <&-
-genfile --file file
-decho "# Create volume"
-tar -c -f archive file
-decho "# Update: wrong label"
-tar -rf archive --label='My volume' file; echo $?
-decho "# Update: right label"
-tar -rf archive file
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'an embedded newline' "label05.at:25"
+( $at_check_trace;
 mkdir oldgnu
 (cd oldgnu
 TEST_TAR_FORMAT=oldgnu
@@ -17974,10 +13343,10 @@ decho "# Update: wrong label"
 tar -rf archive --label='My volume' file; echo $?
 decho "# Update: right label"
 tar -rf archive file
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
 echo >>"$at_stderr"; $as_echo "# Create volume
 # Update: wrong label
 tar: Archive not labeled to match \`My volume'
@@ -17991,12 +13360,11 @@ echo >>"$at_stdout"; $as_echo "# Create
 # Update: right label
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/label05.at:25"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/label05.at:25"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/label05.at:25:
 mkdir posix
 (cd posix
@@ -18015,31 +13383,8 @@ tar -rf archive --label='My volume' file
 decho \"# Update: right label\"
 tar -rf archive file
 )"
-echo label05.at:25 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir posix
-(cd posix
-TEST_TAR_FORMAT=posix
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H posix"
-export TAR_OPTIONS
-rm -rf *
-
-exec <&-
-genfile --file file
-decho "# Create volume"
-tar -c -f archive file
-decho "# Update: wrong label"
-tar -rf archive --label='My volume' file; echo $?
-decho "# Update: right label"
-tar -rf archive file
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'an embedded newline' "label05.at:25"
+( $at_check_trace;
 mkdir posix
 (cd posix
 TEST_TAR_FORMAT=posix
@@ -18056,10 +13401,10 @@ decho "# Update: wrong label"
 tar -rf archive --label='My volume' file; echo $?
 decho "# Update: right label"
 tar -rf archive file
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
 echo >>"$at_stderr"; $as_echo "# Create volume
 # Update: wrong label
 tar: Archive not labeled to match \`My volume'
@@ -18073,36 +13418,32 @@ echo >>"$at_stdout"; $as_echo "# Create
 # Update: right label
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/label05.at:25"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/label05.at:25"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
 
 
 
-  $at_traceoff
+  set +x
   $at_times_p && times >"$at_times_file"
-) 5>&1 2>&1 | eval $at_tee_pipe
-at_status=`cat "$at_status_file"`
+) 5>&1 2>&1 7>&- | eval $at_tee_pipe
+read at_status <"$at_status_file"
 #AT_STOP_48
 #AT_START_49
-# 49. backup01.at:33: extracting existing dir with --backup
-at_setup_line='backup01.at:33'
-at_desc="extracting existing dir with --backup"
-$at_quiet $as_echo_n " 49: $at_desc          "
+at_fn_group_banner 49 'backup01.at:33' \
+  "extracting existing dir with --backup" "          "
 at_xfail=no
       test -f $XFAILFILE && at_xfail=yes
-echo "#                             -*- compilation -*-" >> "$at_group_log"
 (
-  $as_echo "49. backup01.at:33: testing ..."
+  $as_echo "49. $at_setup_line: testing $at_desc ..."
   $at_traceon
 
 
 
 
 
-  { $at_traceoff
+  { set +x
 $as_echo "$at_srcdir/backup01.at:36:
 mkdir v7
 (cd v7
@@ -18117,27 +13458,8 @@ echo bla > dir1/file1
 tar cf test.tar dir1 dir2
 tar xfv test.tar --backup --warning=no-timestamp
 )"
-echo backup01.at:36 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir v7
-(cd v7
-TEST_TAR_FORMAT=v7
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H v7"
-export TAR_OPTIONS
-rm -rf *
-
-mkdir dir1 dir2
-echo bla > dir1/file1
-tar cf test.tar dir1 dir2
-tar xfv test.tar --backup --warning=no-timestamp
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'an embedded newline' "backup01.at:36"
+( $at_check_trace;
 mkdir v7
 (cd v7
 TEST_TAR_FORMAT=v7
@@ -18150,23 +13472,22 @@ mkdir dir1 dir2
 echo bla > dir1/file1
 tar cf test.tar dir1 dir2
 tar xfv test.tar --backup --warning=no-timestamp
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "dir1/
 dir1/file1
 Renaming \`dir1/file1' to \`dir1/file1~'
 dir2/
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/backup01.at:36"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/backup01.at:36"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/backup01.at:36:
 mkdir oldgnu
 (cd oldgnu
@@ -18181,27 +13502,8 @@ echo bla > dir1/file1
 tar cf test.tar dir1 dir2
 tar xfv test.tar --backup --warning=no-timestamp
 )"
-echo backup01.at:36 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir oldgnu
-(cd oldgnu
-TEST_TAR_FORMAT=oldgnu
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H oldgnu"
-export TAR_OPTIONS
-rm -rf *
-
-mkdir dir1 dir2
-echo bla > dir1/file1
-tar cf test.tar dir1 dir2
-tar xfv test.tar --backup --warning=no-timestamp
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'an embedded newline' "backup01.at:36"
+( $at_check_trace;
 mkdir oldgnu
 (cd oldgnu
 TEST_TAR_FORMAT=oldgnu
@@ -18214,23 +13516,22 @@ mkdir dir1 dir2
 echo bla > dir1/file1
 tar cf test.tar dir1 dir2
 tar xfv test.tar --backup --warning=no-timestamp
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "dir1/
 dir1/file1
 Renaming \`dir1/file1' to \`dir1/file1~'
 dir2/
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/backup01.at:36"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/backup01.at:36"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/backup01.at:36:
 mkdir ustar
 (cd ustar
@@ -18245,27 +13546,8 @@ echo bla > dir1/file1
 tar cf test.tar dir1 dir2
 tar xfv test.tar --backup --warning=no-timestamp
 )"
-echo backup01.at:36 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir ustar
-(cd ustar
-TEST_TAR_FORMAT=ustar
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H ustar"
-export TAR_OPTIONS
-rm -rf *
-
-mkdir dir1 dir2
-echo bla > dir1/file1
-tar cf test.tar dir1 dir2
-tar xfv test.tar --backup --warning=no-timestamp
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'an embedded newline' "backup01.at:36"
+( $at_check_trace;
 mkdir ustar
 (cd ustar
 TEST_TAR_FORMAT=ustar
@@ -18278,23 +13560,22 @@ mkdir dir1 dir2
 echo bla > dir1/file1
 tar cf test.tar dir1 dir2
 tar xfv test.tar --backup --warning=no-timestamp
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "dir1/
 dir1/file1
 Renaming \`dir1/file1' to \`dir1/file1~'
 dir2/
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/backup01.at:36"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/backup01.at:36"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/backup01.at:36:
 mkdir posix
 (cd posix
@@ -18309,27 +13590,8 @@ echo bla > dir1/file1
 tar cf test.tar dir1 dir2
 tar xfv test.tar --backup --warning=no-timestamp
 )"
-echo backup01.at:36 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir posix
-(cd posix
-TEST_TAR_FORMAT=posix
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H posix"
-export TAR_OPTIONS
-rm -rf *
-
-mkdir dir1 dir2
-echo bla > dir1/file1
-tar cf test.tar dir1 dir2
-tar xfv test.tar --backup --warning=no-timestamp
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'an embedded newline' "backup01.at:36"
+( $at_check_trace;
 mkdir posix
 (cd posix
 TEST_TAR_FORMAT=posix
@@ -18342,23 +13604,22 @@ mkdir dir1 dir2
 echo bla > dir1/file1
 tar cf test.tar dir1 dir2
 tar xfv test.tar --backup --warning=no-timestamp
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "dir1/
 dir1/file1
 Renaming \`dir1/file1' to \`dir1/file1~'
 dir2/
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/backup01.at:36"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/backup01.at:36"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/backup01.at:36:
 mkdir gnu
 (cd gnu
@@ -18373,27 +13634,8 @@ echo bla > dir1/file1
 tar cf test.tar dir1 dir2
 tar xfv test.tar --backup --warning=no-timestamp
 )"
-echo backup01.at:36 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir gnu
-(cd gnu
-TEST_TAR_FORMAT=gnu
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H gnu"
-export TAR_OPTIONS
-rm -rf *
-
-mkdir dir1 dir2
-echo bla > dir1/file1
-tar cf test.tar dir1 dir2
-tar xfv test.tar --backup --warning=no-timestamp
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'an embedded newline' "backup01.at:36"
+( $at_check_trace;
 mkdir gnu
 (cd gnu
 TEST_TAR_FORMAT=gnu
@@ -18406,46 +13648,42 @@ mkdir dir1 dir2
 echo bla > dir1/file1
 tar cf test.tar dir1 dir2
 tar xfv test.tar --backup --warning=no-timestamp
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "dir1/
 dir1/file1
 Renaming \`dir1/file1' to \`dir1/file1~'
 dir2/
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/backup01.at:36"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/backup01.at:36"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
 
 
 
-  $at_traceoff
+  set +x
   $at_times_p && times >"$at_times_file"
-) 5>&1 2>&1 | eval $at_tee_pipe
-at_status=`cat "$at_status_file"`
+) 5>&1 2>&1 7>&- | eval $at_tee_pipe
+read at_status <"$at_status_file"
 #AT_STOP_49
 #AT_START_50
-# 50. gzip.at:23: gzip
-at_setup_line='gzip.at:23'
-at_desc="gzip"
-$at_quiet $as_echo_n " 50: $at_desc                                           "
+at_fn_group_banner 50 'gzip.at:23' \
+  "gzip" "                                           "
 at_xfail=no
-echo "#                             -*- compilation -*-" >> "$at_group_log"
 (
-  $as_echo "50. gzip.at:23: testing ..."
+  $as_echo "50. $at_setup_line: testing $at_desc ..."
   $at_traceon
 
 
 
 unset TAR_OPTIONS
 
-{ $at_traceoff
+{ set +x
 $as_echo "$at_srcdir/gzip.at:28:
 
 cat /dev/null | gzip - > /dev/null 2>&1 || exit 77
@@ -18455,11 +13693,8 @@ RC=\$?
 sed -n '/^tar:/p' err >&2
 exit \$RC
 "
-echo gzip.at:28 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
+at_fn_check_prepare_notrace 'an embedded newline' "gzip.at:28"
+( $at_check_trace;
 
 cat /dev/null | gzip - > /dev/null 2>&1 || exit 77
 
@@ -18467,54 +13702,39 @@ tar xfvz /dev/null 2>err
 RC=$?
 sed -n '/^tar:/p' err >&2
 exit $RC
- ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
-
-cat /dev/null | gzip - > /dev/null 2>&1 || exit 77
 
-tar xfvz /dev/null 2>err
-RC=$?
-sed -n '/^tar:/p' err >&2
-exit $RC
- ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
 echo >>"$at_stderr"; $as_echo "tar: Child returned status 1
 tar: Error is not recoverable: exiting now
 " | \
   $at_diff - "$at_stderr" || at_failed=:
-at_func_diff_devnull "$at_stdout" || at_failed=:
-at_func_check_status 2 $at_status "$at_srcdir/gzip.at:28"
-
-$at_failed && at_func_log_failure
+at_fn_diff_devnull "$at_stdout" || at_failed=:
+at_fn_check_status 2 $at_status "$at_srcdir/gzip.at:28"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
 
-  $at_traceoff
+  set +x
   $at_times_p && times >"$at_times_file"
-) 5>&1 2>&1 | eval $at_tee_pipe
-at_status=`cat "$at_status_file"`
+) 5>&1 2>&1 7>&- | eval $at_tee_pipe
+read at_status <"$at_status_file"
 #AT_STOP_50
 #AT_START_51
-# 51. incremental.at:23: incremental
-at_setup_line='incremental.at:23'
-at_desc="incremental"
-$at_quiet $as_echo_n " 51: $at_desc                                    "
+at_fn_group_banner 51 'incremental.at:23' \
+  "incremental" "                                    "
 at_xfail=no
       test -f $XFAILFILE && at_xfail=yes
-echo "#                             -*- compilation -*-" >> "$at_group_log"
 (
-  $as_echo "51. incremental.at:23: testing ..."
+  $as_echo "51. $at_setup_line: testing $at_desc ..."
   $at_traceon
 
 
 
 
 
-  { $at_traceoff
+  { set +x
 $as_echo "$at_srcdir/incremental.at:26:
 mkdir gnu
 (cd gnu
@@ -18551,49 +13771,8 @@ sleep 2
 echo y >structure/file
 tar cfv archive --listed=list structure
 )"
-echo incremental.at:26 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains a `...` command substitution)'
-   false; }; then
-  ( $at_traceon;
-mkdir gnu
-(cd gnu
-TEST_TAR_FORMAT=gnu
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H gnu"
-export TAR_OPTIONS
-rm -rf *
-
-mkdir structure
-echo x >structure/file
-
-# On Nextstep (and perhaps other 4.3BSD systems),
-# a newly created file's ctime isn't updated
-# until the next sync or stat operation on the file.
-ls -l structure/file >/dev/null
-
-# If the time of an initial backup and the creation time of a file contained
-# in that backup are the same, the file will be backed up again when an
-# incremental backup is done, because the incremental backup backs up
-# files created `on or after' the initial backup time.  Without the sleep
-# command, behaviour of tar becomes variable, depending whether the system
-# clock ticked over to the next second between creating the file and
-# backing it up.
-sleep 1
-
-tar cf archive --listed=list structure
-tar cfv archive --listed=list structure
-echo separator
-# ReiserFS often offsets the timestamps of newly created files
-# 1 second to the past.  Try to compensate for it, until a better
-# solution is found.
-sleep 2
-echo y >structure/file
-tar cfv archive --listed=list structure
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'a `...` command substitution' "incremental.at:26"
+( $at_check_trace;
 mkdir gnu
 (cd gnu
 TEST_TAR_FORMAT=gnu
@@ -18628,23 +13807,22 @@ echo separator
 sleep 2
 echo y >structure/file
 tar cfv archive --listed=list structure
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "structure/
 separator
 structure/
 structure/file
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/incremental.at:26"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/incremental.at:26"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/incremental.at:26:
 mkdir oldgnu
 (cd oldgnu
@@ -18681,11 +13859,8 @@ sleep 2
 echo y >structure/file
 tar cfv archive --listed=list structure
 )"
-echo incremental.at:26 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains a `...` command substitution)'
-   false; }; then
-  ( $at_traceon;
+at_fn_check_prepare_notrace 'a `...` command substitution' "incremental.at:26"
+( $at_check_trace;
 mkdir oldgnu
 (cd oldgnu
 TEST_TAR_FORMAT=oldgnu
@@ -18720,61 +13895,22 @@ echo separator
 sleep 2
 echo y >structure/file
 tar cfv archive --listed=list structure
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
-mkdir oldgnu
-(cd oldgnu
-TEST_TAR_FORMAT=oldgnu
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H oldgnu"
-export TAR_OPTIONS
-rm -rf *
-
-mkdir structure
-echo x >structure/file
-
-# On Nextstep (and perhaps other 4.3BSD systems),
-# a newly created file's ctime isn't updated
-# until the next sync or stat operation on the file.
-ls -l structure/file >/dev/null
-
-# If the time of an initial backup and the creation time of a file contained
-# in that backup are the same, the file will be backed up again when an
-# incremental backup is done, because the incremental backup backs up
-# files created `on or after' the initial backup time.  Without the sleep
-# command, behaviour of tar becomes variable, depending whether the system
-# clock ticked over to the next second between creating the file and
-# backing it up.
-sleep 1
-
-tar cf archive --listed=list structure
-tar cfv archive --listed=list structure
-echo separator
-# ReiserFS often offsets the timestamps of newly created files
-# 1 second to the past.  Try to compensate for it, until a better
-# solution is found.
-sleep 2
-echo y >structure/file
-tar cfv archive --listed=list structure
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "structure/
 separator
 structure/
 structure/file
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/incremental.at:26"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/incremental.at:26"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/incremental.at:26:
 mkdir posix
 (cd posix
@@ -18811,49 +13947,8 @@ sleep 2
 echo y >structure/file
 tar cfv archive --listed=list structure
 )"
-echo incremental.at:26 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains a `...` command substitution)'
-   false; }; then
-  ( $at_traceon;
-mkdir posix
-(cd posix
-TEST_TAR_FORMAT=posix
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H posix"
-export TAR_OPTIONS
-rm -rf *
-
-mkdir structure
-echo x >structure/file
-
-# On Nextstep (and perhaps other 4.3BSD systems),
-# a newly created file's ctime isn't updated
-# until the next sync or stat operation on the file.
-ls -l structure/file >/dev/null
-
-# If the time of an initial backup and the creation time of a file contained
-# in that backup are the same, the file will be backed up again when an
-# incremental backup is done, because the incremental backup backs up
-# files created `on or after' the initial backup time.  Without the sleep
-# command, behaviour of tar becomes variable, depending whether the system
-# clock ticked over to the next second between creating the file and
-# backing it up.
-sleep 1
-
-tar cf archive --listed=list structure
-tar cfv archive --listed=list structure
-echo separator
-# ReiserFS often offsets the timestamps of newly created files
-# 1 second to the past.  Try to compensate for it, until a better
-# solution is found.
-sleep 2
-echo y >structure/file
-tar cfv archive --listed=list structure
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'a `...` command substitution' "incremental.at:26"
+( $at_check_trace;
 mkdir posix
 (cd posix
 TEST_TAR_FORMAT=posix
@@ -18888,47 +13983,43 @@ echo separator
 sleep 2
 echo y >structure/file
 tar cfv archive --listed=list structure
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "structure/
 separator
 structure/
 structure/file
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/incremental.at:26"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/incremental.at:26"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
 
 
 
-  $at_traceoff
+  set +x
   $at_times_p && times >"$at_times_file"
-) 5>&1 2>&1 | eval $at_tee_pipe
-at_status=`cat "$at_status_file"`
+) 5>&1 2>&1 7>&- | eval $at_tee_pipe
+read at_status <"$at_status_file"
 #AT_STOP_51
 #AT_START_52
-# 52. incr01.at:27: restore broken symlinks from incremental
-at_setup_line='incr01.at:27'
-at_desc="restore broken symlinks from incremental"
-$at_quiet $as_echo_n " 52: $at_desc       "
+at_fn_group_banner 52 'incr01.at:27' \
+  "restore broken symlinks from incremental" "       "
 at_xfail=no
       test -f $XFAILFILE && at_xfail=yes
-echo "#                             -*- compilation -*-" >> "$at_group_log"
 (
-  $as_echo "52. incr01.at:27: testing ..."
+  $as_echo "52. $at_setup_line: testing $at_desc ..."
   $at_traceon
 
 
 
 
 
-  { $at_traceoff
+  { set +x
 $as_echo "$at_srcdir/incr01.at:30:
 mkdir gnu
 (cd gnu
@@ -18951,35 +14042,8 @@ tar xvfg archive.0 /dev/null --warning=n
 echo separator
 tar xvfg archive.1 /dev/null --warning=no-timestamp
 )"
-echo incr01.at:30 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir gnu
-(cd gnu
-TEST_TAR_FORMAT=gnu
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H gnu"
-export TAR_OPTIONS
-rm -rf *
-
-mkdir directory
-$as_ln_s foo directory/bar
-
-tar -cf archive.0 -g db directory
-rm directory/bar
-tar -cf archive.1 -g db directory
-
-mv directory orig
-
-tar xvfg archive.0 /dev/null --warning=no-timestamp
-echo separator
-tar xvfg archive.1 /dev/null --warning=no-timestamp
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'an embedded newline' "incr01.at:30"
+( $at_check_trace;
 mkdir gnu
 (cd gnu
 TEST_TAR_FORMAT=gnu
@@ -19000,11 +14064,11 @@ mv directory orig
 tar xvfg archive.0 /dev/null --warning=no-timestamp
 echo separator
 tar xvfg archive.1 /dev/null --warning=no-timestamp
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "directory/
 directory/bar
 separator
@@ -19012,12 +14076,11 @@ directory/
 tar: Deleting \`directory/bar'
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/incr01.at:30"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/incr01.at:30"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/incr01.at:30:
 mkdir oldgnu
 (cd oldgnu
@@ -19040,35 +14103,8 @@ tar xvfg archive.0 /dev/null --warning=n
 echo separator
 tar xvfg archive.1 /dev/null --warning=no-timestamp
 )"
-echo incr01.at:30 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir oldgnu
-(cd oldgnu
-TEST_TAR_FORMAT=oldgnu
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H oldgnu"
-export TAR_OPTIONS
-rm -rf *
-
-mkdir directory
-$as_ln_s foo directory/bar
-
-tar -cf archive.0 -g db directory
-rm directory/bar
-tar -cf archive.1 -g db directory
-
-mv directory orig
-
-tar xvfg archive.0 /dev/null --warning=no-timestamp
-echo separator
-tar xvfg archive.1 /dev/null --warning=no-timestamp
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'an embedded newline' "incr01.at:30"
+( $at_check_trace;
 mkdir oldgnu
 (cd oldgnu
 TEST_TAR_FORMAT=oldgnu
@@ -19089,11 +14125,11 @@ mv directory orig
 tar xvfg archive.0 /dev/null --warning=no-timestamp
 echo separator
 tar xvfg archive.1 /dev/null --warning=no-timestamp
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "directory/
 directory/bar
 separator
@@ -19101,12 +14137,11 @@ directory/
 tar: Deleting \`directory/bar'
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/incr01.at:30"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/incr01.at:30"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/incr01.at:30:
 mkdir posix
 (cd posix
@@ -19129,35 +14164,8 @@ tar xvfg archive.0 /dev/null --warning=n
 echo separator
 tar xvfg archive.1 /dev/null --warning=no-timestamp
 )"
-echo incr01.at:30 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir posix
-(cd posix
-TEST_TAR_FORMAT=posix
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H posix"
-export TAR_OPTIONS
-rm -rf *
-
-mkdir directory
-$as_ln_s foo directory/bar
-
-tar -cf archive.0 -g db directory
-rm directory/bar
-tar -cf archive.1 -g db directory
-
-mv directory orig
-
-tar xvfg archive.0 /dev/null --warning=no-timestamp
-echo separator
-tar xvfg archive.1 /dev/null --warning=no-timestamp
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'an embedded newline' "incr01.at:30"
+( $at_check_trace;
 mkdir posix
 (cd posix
 TEST_TAR_FORMAT=posix
@@ -19178,11 +14186,11 @@ mv directory orig
 tar xvfg archive.0 /dev/null --warning=no-timestamp
 echo separator
 tar xvfg archive.1 /dev/null --warning=no-timestamp
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "directory/
 directory/bar
 separator
@@ -19190,36 +14198,32 @@ directory/
 tar: Deleting \`directory/bar'
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/incr01.at:30"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/incr01.at:30"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
 
 
 
-  $at_traceoff
+  set +x
   $at_times_p && times >"$at_times_file"
-) 5>&1 2>&1 | eval $at_tee_pipe
-at_status=`cat "$at_status_file"`
+) 5>&1 2>&1 7>&- | eval $at_tee_pipe
+read at_status <"$at_status_file"
 #AT_STOP_52
 #AT_START_53
-# 53. incr02.at:32: restoring timestamps from incremental
-at_setup_line='incr02.at:32'
-at_desc="restoring timestamps from incremental"
-$at_quiet $as_echo_n " 53: $at_desc          "
+at_fn_group_banner 53 'incr02.at:32' \
+  "restoring timestamps from incremental" "          "
 at_xfail=no
       test -f $XFAILFILE && at_xfail=yes
-echo "#                             -*- compilation -*-" >> "$at_group_log"
 (
-  $as_echo "53. incr02.at:32: testing ..."
+  $as_echo "53. $at_setup_line: testing $at_desc ..."
   $at_traceon
 
 
 
 
 
-  { $at_traceoff
+  { set +x
 $as_echo "$at_srcdir/incr02.at:35:
 mkdir gnu
 (cd gnu
@@ -19265,58 +14269,8 @@ tar -xf archive dir
 # Check the timestamp
 genfile --stat=mtime dir/subdir1 | diff ts -
 )"
-echo incr02.at:35 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains a `...` command substitution)'
-   false; }; then
-  ( $at_traceon;
-mkdir gnu
-(cd gnu
-TEST_TAR_FORMAT=gnu
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H gnu"
-export TAR_OPTIONS
-rm -rf *
-
-# Create directory structure
-mkdir dir
-mkdir dir/subdir1
-mkdir dir/subdir2
-genfile --length 10 --file dir/subdir1/file
-
-# Save mtime for later comparison
-genfile --stat=mtime dir/subdir1 > ts
-
-# Create an archive. Using incremental mode makes sure the
-# archive will have a directory-first member ordering,
-# i.e.:
-# dir/
-# dir/subdir1/
-# dir/subdir2/
-# dir/subdir1/foofile
-#
-# When restoring from this directory structure, `dir/subdir2/' used to
-# trigger apply_nonancestor_delayed_set_stat() which restored stats for
-# `subdir1' prior to restoring `dir/subdir1/foofile'. Then, restoring the
-# latter clobbered the directory timestamp.
-
-tar -cf archive -g db dir
-
-# Move away the directory
-mv dir orig
-
-# Wait enough time for timestamps to differ in case of failure.
-sleep 5
-
-# Restore the directory
-tar -xf archive dir
-
-# Check the timestamp
-genfile --stat=mtime dir/subdir1 | diff ts -
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'a `...` command substitution' "incr02.at:35"
+( $at_check_trace;
 mkdir gnu
 (cd gnu
 TEST_TAR_FORMAT=gnu
@@ -19360,18 +14314,17 @@ tar -xf archive dir
 
 # Check the timestamp
 genfile --stat=mtime dir/subdir1 | diff ts -
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
-at_func_diff_devnull "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/incr02.at:35"
-
-$at_failed && at_func_log_failure
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
+at_fn_diff_devnull "$at_stdout" || at_failed=:
+at_fn_check_status 0 $at_status "$at_srcdir/incr02.at:35"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/incr02.at:35:
 mkdir oldgnu
 (cd oldgnu
@@ -19417,58 +14370,8 @@ tar -xf archive dir
 # Check the timestamp
 genfile --stat=mtime dir/subdir1 | diff ts -
 )"
-echo incr02.at:35 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains a `...` command substitution)'
-   false; }; then
-  ( $at_traceon;
-mkdir oldgnu
-(cd oldgnu
-TEST_TAR_FORMAT=oldgnu
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H oldgnu"
-export TAR_OPTIONS
-rm -rf *
-
-# Create directory structure
-mkdir dir
-mkdir dir/subdir1
-mkdir dir/subdir2
-genfile --length 10 --file dir/subdir1/file
-
-# Save mtime for later comparison
-genfile --stat=mtime dir/subdir1 > ts
-
-# Create an archive. Using incremental mode makes sure the
-# archive will have a directory-first member ordering,
-# i.e.:
-# dir/
-# dir/subdir1/
-# dir/subdir2/
-# dir/subdir1/foofile
-#
-# When restoring from this directory structure, `dir/subdir2/' used to
-# trigger apply_nonancestor_delayed_set_stat() which restored stats for
-# `subdir1' prior to restoring `dir/subdir1/foofile'. Then, restoring the
-# latter clobbered the directory timestamp.
-
-tar -cf archive -g db dir
-
-# Move away the directory
-mv dir orig
-
-# Wait enough time for timestamps to differ in case of failure.
-sleep 5
-
-# Restore the directory
-tar -xf archive dir
-
-# Check the timestamp
-genfile --stat=mtime dir/subdir1 | diff ts -
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'a `...` command substitution' "incr02.at:35"
+( $at_check_trace;
 mkdir oldgnu
 (cd oldgnu
 TEST_TAR_FORMAT=oldgnu
@@ -19512,18 +14415,17 @@ tar -xf archive dir
 
 # Check the timestamp
 genfile --stat=mtime dir/subdir1 | diff ts -
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
-at_func_diff_devnull "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/incr02.at:35"
-
-$at_failed && at_func_log_failure
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
+at_fn_diff_devnull "$at_stdout" || at_failed=:
+at_fn_check_status 0 $at_status "$at_srcdir/incr02.at:35"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/incr02.at:35:
 mkdir posix
 (cd posix
@@ -19569,11 +14471,8 @@ tar -xf archive dir
 # Check the timestamp
 genfile --stat=mtime dir/subdir1 | diff ts -
 )"
-echo incr02.at:35 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains a `...` command substitution)'
-   false; }; then
-  ( $at_traceon;
+at_fn_check_prepare_notrace 'a `...` command substitution' "incr02.at:35"
+( $at_check_trace;
 mkdir posix
 (cd posix
 TEST_TAR_FORMAT=posix
@@ -19617,89 +14516,38 @@ tar -xf archive dir
 
 # Check the timestamp
 genfile --stat=mtime dir/subdir1 | diff ts -
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
-mkdir posix
-(cd posix
-TEST_TAR_FORMAT=posix
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H posix"
-export TAR_OPTIONS
-rm -rf *
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
+at_fn_diff_devnull "$at_stdout" || at_failed=:
+at_fn_check_status 0 $at_status "$at_srcdir/incr02.at:35"
+$at_failed && at_fn_log_failure
+$at_traceon; }
 
-# Create directory structure
-mkdir dir
-mkdir dir/subdir1
-mkdir dir/subdir2
-genfile --length 10 --file dir/subdir1/file
 
-# Save mtime for later comparison
-genfile --stat=mtime dir/subdir1 > ts
-
-# Create an archive. Using incremental mode makes sure the
-# archive will have a directory-first member ordering,
-# i.e.:
-# dir/
-# dir/subdir1/
-# dir/subdir2/
-# dir/subdir1/foofile
-#
-# When restoring from this directory structure, `dir/subdir2/' used to
-# trigger apply_nonancestor_delayed_set_stat() which restored stats for
-# `subdir1' prior to restoring `dir/subdir1/foofile'. Then, restoring the
-# latter clobbered the directory timestamp.
-
-tar -cf archive -g db dir
-
-# Move away the directory
-mv dir orig
-
-# Wait enough time for timestamps to differ in case of failure.
-sleep 5
-
-# Restore the directory
-tar -xf archive dir
-
-# Check the timestamp
-genfile --stat=mtime dir/subdir1 | diff ts -
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
-at_func_diff_devnull "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/incr02.at:35"
-
-$at_failed && at_func_log_failure
-$at_traceon; }
 
 
-
-
-  $at_traceoff
+  set +x
   $at_times_p && times >"$at_times_file"
-) 5>&1 2>&1 | eval $at_tee_pipe
-at_status=`cat "$at_status_file"`
+) 5>&1 2>&1 7>&- | eval $at_tee_pipe
+read at_status <"$at_status_file"
 #AT_STOP_53
 #AT_START_54
-# 54. listed01.at:26: --listed for individual files
-at_setup_line='listed01.at:26'
-at_desc="--listed for individual files"
-$at_quiet $as_echo_n " 54: $at_desc                  "
+at_fn_group_banner 54 'listed01.at:26' \
+  "--listed for individual files" "                  "
 at_xfail=no
       test -f $XFAILFILE && at_xfail=yes
-echo "#                             -*- compilation -*-" >> "$at_group_log"
 (
-  $as_echo "54. listed01.at:26: testing ..."
+  $as_echo "54. $at_setup_line: testing $at_desc ..."
   $at_traceon
 
 
 
 
 
-  { $at_traceoff
+  { set +x
 $as_echo "$at_srcdir/listed01.at:29:
 mkdir gnu
 (cd gnu
@@ -19734,47 +14582,8 @@ tar --create \\
 
 tar tf archive.2 || exit 1
 )"
-echo listed01.at:29 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir gnu
-(cd gnu
-TEST_TAR_FORMAT=gnu
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H gnu"
-export TAR_OPTIONS
-rm -rf *
-
-mkdir directory
-genfile --length 10240 --pattern zeros --file directory/file1
-# Let the things settle
-sleep 1
-
-tar --create \
-    --file=archive.1 \
-    --listed-incremental=listing \
-    directory/file*
-
-tar tf archive.1 || exit 1
-
-sleep 2
-
-genfile --length 10240 --pattern zeros --file directory/file2
-
-echo "separator"
-cp listing listing.old
-tar --create \
-    --file=archive.2 \
-    --listed-incremental=listing \
-    directory/file* || exit 1
-
-tar tf archive.2 || exit 1
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'an embedded newline' "listed01.at:29"
+( $at_check_trace;
 mkdir gnu
 (cd gnu
 TEST_TAR_FORMAT=gnu
@@ -19807,22 +14616,21 @@ tar --create \
     directory/file* || exit 1
 
 tar tf archive.2 || exit 1
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "directory/file1
 separator
 directory/file2
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/listed01.at:29"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/listed01.at:29"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/listed01.at:29:
 mkdir oldgnu
 (cd oldgnu
@@ -19857,47 +14665,8 @@ tar --create \\
 
 tar tf archive.2 || exit 1
 )"
-echo listed01.at:29 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir oldgnu
-(cd oldgnu
-TEST_TAR_FORMAT=oldgnu
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H oldgnu"
-export TAR_OPTIONS
-rm -rf *
-
-mkdir directory
-genfile --length 10240 --pattern zeros --file directory/file1
-# Let the things settle
-sleep 1
-
-tar --create \
-    --file=archive.1 \
-    --listed-incremental=listing \
-    directory/file*
-
-tar tf archive.1 || exit 1
-
-sleep 2
-
-genfile --length 10240 --pattern zeros --file directory/file2
-
-echo "separator"
-cp listing listing.old
-tar --create \
-    --file=archive.2 \
-    --listed-incremental=listing \
-    directory/file* || exit 1
-
-tar tf archive.2 || exit 1
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'an embedded newline' "listed01.at:29"
+( $at_check_trace;
 mkdir oldgnu
 (cd oldgnu
 TEST_TAR_FORMAT=oldgnu
@@ -19930,46 +14699,42 @@ tar --create \
     directory/file* || exit 1
 
 tar tf archive.2 || exit 1
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "directory/file1
 separator
 directory/file2
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/listed01.at:29"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/listed01.at:29"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
 
 
 
-  $at_traceoff
+  set +x
   $at_times_p && times >"$at_times_file"
-) 5>&1 2>&1 | eval $at_tee_pipe
-at_status=`cat "$at_status_file"`
+) 5>&1 2>&1 7>&- | eval $at_tee_pipe
+read at_status <"$at_status_file"
 #AT_STOP_54
 #AT_START_55
-# 55. listed02.at:28: working --listed
-at_setup_line='listed02.at:28'
-at_desc="working --listed"
-$at_quiet $as_echo_n " 55: $at_desc                               "
+at_fn_group_banner 55 'listed02.at:28' \
+  "working --listed" "                               "
 at_xfail=no
       test -f $XFAILFILE && at_xfail=yes
-echo "#                             -*- compilation -*-" >> "$at_group_log"
 (
-  $as_echo "55. listed02.at:28: testing ..."
+  $as_echo "55. $at_setup_line: testing $at_desc ..."
   $at_traceon
 
 
 
 
 
-  { $at_traceoff
+  { set +x
 $as_echo "$at_srcdir/listed02.at:31:
 mkdir gnu
 (cd gnu
@@ -19980,7 +14745,7 @@ export TAR_OPTIONS
 rm -rf *
 
 
-test -z "`sort < /dev/null 2>&1`" || exit 77
+test -z \"\`sort < /dev/null 2>&1\`\" || exit 77
 
 echo Create directories
 
@@ -20038,81 +14803,8 @@ tar -x -v --listed-incremental=tart.incr
 echo Final files:
 find tart -print | sort 2>/dev/null
 )"
-echo listed02.at:31 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir gnu
-(cd gnu
-TEST_TAR_FORMAT=gnu
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H gnu"
-export TAR_OPTIONS
-rm -rf *
-
-
-test -z "`sort < /dev/null 2>&1`" || exit 77
-
-echo Create directories
-
-mkdir tart
-sleep 1
-mkdir tart/c0
-sleep 1
-mkdir tart/c1
-sleep 1
-
-for file in tart/a1 tart/b1 tart/c0/cq1 tart/c0/cq2 tart/c1/ca1 tart/c1/ca2
-do
-  echo File $file > $file
-  sleep 1
-done
-
-sleep 1
-echo Creating main archive
-echo >&2 "Creating main archive"
-tar -c -v --listed-incremental=tart.incr1 -f archive.1 tart 2> err || exit 1
-
-# The above prints two lines to stderr announcing the new directories c0 and c1.
-# Ensure that they appear in this script's stderr in sorted order.
-sort err 1>&2; rm -f err
-
-sleep 1
-echo Modifying filesystem
-rm tart/a1
-
-mv tart/b1 tart/b2
-mv tart/c1 tart/c2
-touch tart/c2/ca3
-
-echo Directory contents
-find tart -print | sort 2>/dev/null
-
-sleep 1
-echo Creating incremental archive
-echo >&2 "Creating incremental archive"
-cp -p tart.incr1 tart.incr2
-tar -c -v --listed-incremental=tart.incr2 -f archive.2 tart || exit 1
-
-sleep 1
-
-rm -rf tart/*
-echo Extracting main archive
-echo >&2 "Extracting main archive"
-tar -x -v --listed-incremental=tart.incr1 -f archive.1 || exit 1
-echo Extracting incremental archive
-# This command should produce three messages about deletion
-# of the existing files, that may appear in any order. Piping
-# to sort makes sure we don't depend on any particular ordering.
-tar -x -v --listed-incremental=tart.incr2 -f archive.2 | sort 2>/dev/null
-
-echo Final files:
-find tart -print | sort 2>/dev/null
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'a `...` command substitution' "listed02.at:31"
+( $at_check_trace;
 mkdir gnu
 (cd gnu
 TEST_TAR_FORMAT=gnu
@@ -20179,10 +14871,10 @@ tar -x -v --listed-incremental=tart.incr
 
 echo Final files:
 find tart -print | sort 2>/dev/null
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
 echo >>"$at_stderr"; $as_echo "Creating main archive
 tar: tart/c0: Directory is new
 tar: tart/c1: Directory is new
@@ -20250,12 +14942,11 @@ tart/c2/ca2
 tart/c2/ca3
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/listed02.at:31"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/listed02.at:31"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/listed02.at:31:
 mkdir oldgnu
 (cd oldgnu
@@ -20266,7 +14957,7 @@ export TAR_OPTIONS
 rm -rf *
 
 
-test -z "`sort < /dev/null 2>&1`" || exit 77
+test -z \"\`sort < /dev/null 2>&1\`\" || exit 77
 
 echo Create directories
 
@@ -20324,81 +15015,8 @@ tar -x -v --listed-incremental=tart.incr
 echo Final files:
 find tart -print | sort 2>/dev/null
 )"
-echo listed02.at:31 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir oldgnu
-(cd oldgnu
-TEST_TAR_FORMAT=oldgnu
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H oldgnu"
-export TAR_OPTIONS
-rm -rf *
-
-
-test -z "`sort < /dev/null 2>&1`" || exit 77
-
-echo Create directories
-
-mkdir tart
-sleep 1
-mkdir tart/c0
-sleep 1
-mkdir tart/c1
-sleep 1
-
-for file in tart/a1 tart/b1 tart/c0/cq1 tart/c0/cq2 tart/c1/ca1 tart/c1/ca2
-do
-  echo File $file > $file
-  sleep 1
-done
-
-sleep 1
-echo Creating main archive
-echo >&2 "Creating main archive"
-tar -c -v --listed-incremental=tart.incr1 -f archive.1 tart 2> err || exit 1
-
-# The above prints two lines to stderr announcing the new directories c0 and c1.
-# Ensure that they appear in this script's stderr in sorted order.
-sort err 1>&2; rm -f err
-
-sleep 1
-echo Modifying filesystem
-rm tart/a1
-
-mv tart/b1 tart/b2
-mv tart/c1 tart/c2
-touch tart/c2/ca3
-
-echo Directory contents
-find tart -print | sort 2>/dev/null
-
-sleep 1
-echo Creating incremental archive
-echo >&2 "Creating incremental archive"
-cp -p tart.incr1 tart.incr2
-tar -c -v --listed-incremental=tart.incr2 -f archive.2 tart || exit 1
-
-sleep 1
-
-rm -rf tart/*
-echo Extracting main archive
-echo >&2 "Extracting main archive"
-tar -x -v --listed-incremental=tart.incr1 -f archive.1 || exit 1
-echo Extracting incremental archive
-# This command should produce three messages about deletion
-# of the existing files, that may appear in any order. Piping
-# to sort makes sure we don't depend on any particular ordering.
-tar -x -v --listed-incremental=tart.incr2 -f archive.2 | sort 2>/dev/null
-
-echo Final files:
-find tart -print | sort 2>/dev/null
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'a `...` command substitution' "listed02.at:31"
+( $at_check_trace;
 mkdir oldgnu
 (cd oldgnu
 TEST_TAR_FORMAT=oldgnu
@@ -20465,10 +15083,10 @@ tar -x -v --listed-incremental=tart.incr
 
 echo Final files:
 find tart -print | sort 2>/dev/null
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
 echo >>"$at_stderr"; $as_echo "Creating main archive
 tar: tart/c0: Directory is new
 tar: tart/c1: Directory is new
@@ -20536,36 +15154,32 @@ tart/c2/ca2
 tart/c2/ca3
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/listed02.at:31"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/listed02.at:31"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
 
 
 
-  $at_traceoff
+  set +x
   $at_times_p && times >"$at_times_file"
-) 5>&1 2>&1 | eval $at_tee_pipe
-at_status=`cat "$at_status_file"`
+) 5>&1 2>&1 7>&- | eval $at_tee_pipe
+read at_status <"$at_status_file"
 #AT_STOP_55
 #AT_START_56
-# 56. listed03.at:22: incremental dump when the parent directory is unreadable
-at_setup_line='listed03.at:22'
-at_desc="incremental dump when the parent directory is unreadable"
-$at_quiet $as_echo_n " 56: $at_desc"
+at_fn_group_banner 56 'listed03.at:22' \
+  "incremental dump when the parent directory is unreadable" ""
 at_xfail=no
       test -f $XFAILFILE && at_xfail=yes
-echo "#                             -*- compilation -*-" >> "$at_group_log"
 (
-  $as_echo "56. listed03.at:22: testing ..."
+  $as_echo "56. $at_setup_line: testing $at_desc ..."
   $at_traceon
 
 
 
 
 
-  { $at_traceoff
+  { set +x
 $as_echo "$at_srcdir/listed03.at:25:
 mkdir gnu
 (cd gnu
@@ -20576,12 +15190,12 @@ export TAR_OPTIONS
 rm -rf *
 
 
-echo "test" > $$
-chmod 0 $$
-cat $$ > /dev/null 2>&1
-result=$?
-rm -f $$
-test $result -eq 0 && exit 77
+echo \"test\" > \$\$
+chmod 0 \$\$
+cat \$\$ > /dev/null 2>&1
+result=\$?
+rm -f \$\$
+test \$result -eq 0 && exit 77
 
 
 mkdir dir
@@ -20596,11 +15210,8 @@ status=\$?
 chmod a+r ..
 exit \$status
 )"
-echo listed03.at:25 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
+at_fn_check_prepare_notrace 'an embedded newline' "listed03.at:25"
+( $at_check_trace;
 mkdir gnu
 (cd gnu
 TEST_TAR_FORMAT=gnu
@@ -20629,42 +15240,10 @@ tar -c -f archive.tar --listed-increment
 status=$?
 chmod a+r ..
 exit $status
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
-mkdir gnu
-(cd gnu
-TEST_TAR_FORMAT=gnu
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H gnu"
-export TAR_OPTIONS
-rm -rf *
-
-
-echo "test" > $$
-chmod 0 $$
-cat $$ > /dev/null 2>&1
-result=$?
-rm -f $$
-test $result -eq 0 && exit 77
-
-
-mkdir dir
-mkdir dir/sub
-mkdir dir/sub/a
-genfile --file dir/sub/a/file
-cd dir/sub
-
-chmod a-r ..
-tar -c -f archive.tar --listed-incremental=db.1 -v a
-status=$?
-chmod a+r ..
-exit $status
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
 echo >>"$at_stderr"; $as_echo "tar: a: Directory is new
 " | \
   $at_diff - "$at_stderr" || at_failed=:
@@ -20672,36 +15251,32 @@ echo >>"$at_stdout"; $as_echo "a/
 a/file
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/listed03.at:25"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/listed03.at:25"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
 
 
 
-  $at_traceoff
+  set +x
   $at_times_p && times >"$at_times_file"
-) 5>&1 2>&1 | eval $at_tee_pipe
-at_status=`cat "$at_status_file"`
+) 5>&1 2>&1 7>&- | eval $at_tee_pipe
+read at_status <"$at_status_file"
 #AT_STOP_56
 #AT_START_57
-# 57. incr03.at:28: renamed files in incrementals
-at_setup_line='incr03.at:28'
-at_desc="renamed files in incrementals"
-$at_quiet $as_echo_n " 57: $at_desc                  "
+at_fn_group_banner 57 'incr03.at:28' \
+  "renamed files in incrementals" "                  "
 at_xfail=no
       test -f $XFAILFILE && at_xfail=yes
-echo "#                             -*- compilation -*-" >> "$at_group_log"
 (
-  $as_echo "57. incr03.at:28: testing ..."
+  $as_echo "57. $at_setup_line: testing $at_desc ..."
   $at_traceon
 
 
 
 
 
-  { $at_traceoff
+  { set +x
 $as_echo "$at_srcdir/incr03.at:31:
 mkdir gnu
 (cd gnu
@@ -20712,7 +15287,7 @@ export TAR_OPTIONS
 rm -rf *
 
 
-test -z "`sort < /dev/null 2>&1`" || exit 77
+test -z \"\`sort < /dev/null 2>&1\`\" || exit 77
 
 mkdir directory
 genfile --file=directory/x
@@ -20741,52 +15316,8 @@ echo Directory after second restore
 tar -xf archive.2 -g db --warning=no-timestamp
 find directory | sort
 )"
-echo incr03.at:31 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir gnu
-(cd gnu
-TEST_TAR_FORMAT=gnu
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H gnu"
-export TAR_OPTIONS
-rm -rf *
-
-
-test -z "`sort < /dev/null 2>&1`" || exit 77
-
-mkdir directory
-genfile --file=directory/x
-genfile --file=directory/y
-
-sleep 1
-
-tar -cf archive.1 -g db directory
-
-mv directory/x directory/z
-cp db db.old
-tar -cf archive.2 -g db directory
-
-mv directory orig
-
-echo Listing of archive.1
-tar -tf archive.1 | sort
-echo Listing of archive.2
-tar -tf archive.2 | sort
-
-echo Directory after first restore
-tar -xf archive.1 -g db --warning=no-timestamp
-find directory | sort
-
-echo Directory after second restore
-tar -xf archive.2 -g db --warning=no-timestamp
-find directory | sort
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'a `...` command substitution' "incr03.at:31"
+( $at_check_trace;
 mkdir gnu
 (cd gnu
 TEST_TAR_FORMAT=gnu
@@ -20824,11 +15355,11 @@ find directory | sort
 echo Directory after second restore
 tar -xf archive.2 -g db --warning=no-timestamp
 find directory | sort
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "Listing of archive.1
 directory/
 directory/x
@@ -20846,12 +15377,11 @@ directory/y
 directory/z
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/incr03.at:31"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/incr03.at:31"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/incr03.at:31:
 mkdir oldgnu
 (cd oldgnu
@@ -20862,7 +15392,7 @@ export TAR_OPTIONS
 rm -rf *
 
 
-test -z "`sort < /dev/null 2>&1`" || exit 77
+test -z \"\`sort < /dev/null 2>&1\`\" || exit 77
 
 mkdir directory
 genfile --file=directory/x
@@ -20891,52 +15421,8 @@ echo Directory after second restore
 tar -xf archive.2 -g db --warning=no-timestamp
 find directory | sort
 )"
-echo incr03.at:31 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir oldgnu
-(cd oldgnu
-TEST_TAR_FORMAT=oldgnu
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H oldgnu"
-export TAR_OPTIONS
-rm -rf *
-
-
-test -z "`sort < /dev/null 2>&1`" || exit 77
-
-mkdir directory
-genfile --file=directory/x
-genfile --file=directory/y
-
-sleep 1
-
-tar -cf archive.1 -g db directory
-
-mv directory/x directory/z
-cp db db.old
-tar -cf archive.2 -g db directory
-
-mv directory orig
-
-echo Listing of archive.1
-tar -tf archive.1 | sort
-echo Listing of archive.2
-tar -tf archive.2 | sort
-
-echo Directory after first restore
-tar -xf archive.1 -g db --warning=no-timestamp
-find directory | sort
-
-echo Directory after second restore
-tar -xf archive.2 -g db --warning=no-timestamp
-find directory | sort
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'a `...` command substitution' "incr03.at:31"
+( $at_check_trace;
 mkdir oldgnu
 (cd oldgnu
 TEST_TAR_FORMAT=oldgnu
@@ -20974,11 +15460,11 @@ find directory | sort
 echo Directory after second restore
 tar -xf archive.2 -g db --warning=no-timestamp
 find directory | sort
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "Listing of archive.1
 directory/
 directory/x
@@ -20996,12 +15482,11 @@ directory/y
 directory/z
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/incr03.at:31"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/incr03.at:31"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/incr03.at:31:
 mkdir posix
 (cd posix
@@ -21012,7 +15497,7 @@ export TAR_OPTIONS
 rm -rf *
 
 
-test -z "`sort < /dev/null 2>&1`" || exit 77
+test -z \"\`sort < /dev/null 2>&1\`\" || exit 77
 
 mkdir directory
 genfile --file=directory/x
@@ -21041,52 +15526,8 @@ echo Directory after second restore
 tar -xf archive.2 -g db --warning=no-timestamp
 find directory | sort
 )"
-echo incr03.at:31 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir posix
-(cd posix
-TEST_TAR_FORMAT=posix
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H posix"
-export TAR_OPTIONS
-rm -rf *
-
-
-test -z "`sort < /dev/null 2>&1`" || exit 77
-
-mkdir directory
-genfile --file=directory/x
-genfile --file=directory/y
-
-sleep 1
-
-tar -cf archive.1 -g db directory
-
-mv directory/x directory/z
-cp db db.old
-tar -cf archive.2 -g db directory
-
-mv directory orig
-
-echo Listing of archive.1
-tar -tf archive.1 | sort
-echo Listing of archive.2
-tar -tf archive.2 | sort
-
-echo Directory after first restore
-tar -xf archive.1 -g db --warning=no-timestamp
-find directory | sort
-
-echo Directory after second restore
-tar -xf archive.2 -g db --warning=no-timestamp
-find directory | sort
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'a `...` command substitution' "incr03.at:31"
+( $at_check_trace;
 mkdir posix
 (cd posix
 TEST_TAR_FORMAT=posix
@@ -21124,11 +15565,11 @@ find directory | sort
 echo Directory after second restore
 tar -xf archive.2 -g db --warning=no-timestamp
 find directory | sort
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "Listing of archive.1
 directory/
 directory/x
@@ -21146,29 +15587,25 @@ directory/y
 directory/z
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/incr03.at:31"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/incr03.at:31"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
 
 
 
-  $at_traceoff
+  set +x
   $at_times_p && times >"$at_times_file"
-) 5>&1 2>&1 | eval $at_tee_pipe
-at_status=`cat "$at_status_file"`
+) 5>&1 2>&1 7>&- | eval $at_tee_pipe
+read at_status <"$at_status_file"
 #AT_STOP_57
 #AT_START_58
-# 58. incr04.at:29: proper icontents initialization
-at_setup_line='incr04.at:29'
-at_desc="proper icontents initialization"
-$at_quiet $as_echo_n " 58: $at_desc                "
+at_fn_group_banner 58 'incr04.at:29' \
+  "proper icontents initialization" "                "
 at_xfail=no
       test -f $XFAILFILE && at_xfail=yes
-echo "#                             -*- compilation -*-" >> "$at_group_log"
 (
-  $as_echo "58. incr04.at:29: testing ..."
+  $as_echo "58. $at_setup_line: testing $at_desc ..."
   $at_traceon
 
 
@@ -21177,7 +15614,7 @@ echo "#                             -*-
 
 
 
-  { $at_traceoff
+  { set +x
 $as_echo "$at_srcdir/incr04.at:34:
 mkdir gnu
 (cd gnu
@@ -21202,37 +15639,8 @@ mv a/b a/c
 echo \"Incremental dump\"
 tar cvf a1.tar -g a.sna a
 )"
-echo incr04.at:34 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir gnu
-(cd gnu
-TEST_TAR_FORMAT=gnu
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H gnu"
-export TAR_OPTIONS
-rm -rf *
-
-
-install-sh -d a/b >/dev/null  || exit 77
-awk 'BEGIN {
-  for (i=1;i<=142;i++)
-    printf("a/b/one_31_chars_long_file_name_%03d\n", i);
-  }' < /dev/null | genfile --files-from -
-
-sleep 1
-
-echo "Initial dump"
-tar cvf a0.tar -g a.sna a
-mv a/b a/c
-echo "Incremental dump"
-tar cvf a1.tar -g a.sna a
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'an embedded newline' "incr04.at:34"
+( $at_check_trace;
 mkdir gnu
 (cd gnu
 TEST_TAR_FORMAT=gnu
@@ -21255,10 +15663,10 @@ tar cvf a0.tar -g a.sna a
 mv a/b a/c
 echo "Incremental dump"
 tar cvf a1.tar -g a.sna a
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
 echo >>"$at_stderr"; $as_echo "tar: a: Directory is new
 tar: a/b: Directory is new
 tar: a/c: Directory has been renamed from \`a/b'
@@ -21414,12 +15822,11 @@ a/
 a/c/
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/incr04.at:34"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/incr04.at:34"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/incr04.at:34:
 mkdir oldgnu
 (cd oldgnu
@@ -21444,37 +15851,8 @@ mv a/b a/c
 echo \"Incremental dump\"
 tar cvf a1.tar -g a.sna a
 )"
-echo incr04.at:34 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir oldgnu
-(cd oldgnu
-TEST_TAR_FORMAT=oldgnu
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H oldgnu"
-export TAR_OPTIONS
-rm -rf *
-
-
-install-sh -d a/b >/dev/null  || exit 77
-awk 'BEGIN {
-  for (i=1;i<=142;i++)
-    printf("a/b/one_31_chars_long_file_name_%03d\n", i);
-  }' < /dev/null | genfile --files-from -
-
-sleep 1
-
-echo "Initial dump"
-tar cvf a0.tar -g a.sna a
-mv a/b a/c
-echo "Incremental dump"
-tar cvf a1.tar -g a.sna a
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'an embedded newline' "incr04.at:34"
+( $at_check_trace;
 mkdir oldgnu
 (cd oldgnu
 TEST_TAR_FORMAT=oldgnu
@@ -21497,10 +15875,10 @@ tar cvf a0.tar -g a.sna a
 mv a/b a/c
 echo "Incremental dump"
 tar cvf a1.tar -g a.sna a
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
 echo >>"$at_stderr"; $as_echo "tar: a: Directory is new
 tar: a/b: Directory is new
 tar: a/c: Directory has been renamed from \`a/b'
@@ -21656,12 +16034,11 @@ a/
 a/c/
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/incr04.at:34"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/incr04.at:34"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/incr04.at:34:
 mkdir posix
 (cd posix
@@ -21686,37 +16063,8 @@ mv a/b a/c
 echo \"Incremental dump\"
 tar cvf a1.tar -g a.sna a
 )"
-echo incr04.at:34 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir posix
-(cd posix
-TEST_TAR_FORMAT=posix
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H posix"
-export TAR_OPTIONS
-rm -rf *
-
-
-install-sh -d a/b >/dev/null  || exit 77
-awk 'BEGIN {
-  for (i=1;i<=142;i++)
-    printf("a/b/one_31_chars_long_file_name_%03d\n", i);
-  }' < /dev/null | genfile --files-from -
-
-sleep 1
-
-echo "Initial dump"
-tar cvf a0.tar -g a.sna a
-mv a/b a/c
-echo "Incremental dump"
-tar cvf a1.tar -g a.sna a
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'an embedded newline' "incr04.at:34"
+( $at_check_trace;
 mkdir posix
 (cd posix
 TEST_TAR_FORMAT=posix
@@ -21739,10 +16087,10 @@ tar cvf a0.tar -g a.sna a
 mv a/b a/c
 echo "Incremental dump"
 tar cvf a1.tar -g a.sna a
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
 echo >>"$at_stderr"; $as_echo "tar: a: Directory is new
 tar: a/b: Directory is new
 tar: a/c: Directory has been renamed from \`a/b'
@@ -21898,36 +16246,32 @@ a/
 a/c/
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/incr04.at:34"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/incr04.at:34"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
 
 
 
-  $at_traceoff
+  set +x
   $at_times_p && times >"$at_times_file"
-) 5>&1 2>&1 | eval $at_tee_pipe
-at_status=`cat "$at_status_file"`
+) 5>&1 2>&1 7>&- | eval $at_tee_pipe
+read at_status <"$at_status_file"
 #AT_STOP_58
 #AT_START_59
-# 59. incr05.at:19: incremental dumps with -C
-at_setup_line='incr05.at:19'
-at_desc="incremental dumps with -C"
-$at_quiet $as_echo_n " 59: $at_desc                      "
+at_fn_group_banner 59 'incr05.at:19' \
+  "incremental dumps with -C" "                      "
 at_xfail=no
       test -f $XFAILFILE && at_xfail=yes
-echo "#                             -*- compilation -*-" >> "$at_group_log"
 (
-  $as_echo "59. incr05.at:19: testing ..."
+  $as_echo "59. $at_setup_line: testing $at_desc ..."
   $at_traceon
 
 
 
 
 
-  { $at_traceoff
+  { set +x
 $as_echo "$at_srcdir/incr05.at:22:
 mkdir gnu
 (cd gnu
@@ -21949,34 +16293,8 @@ genfile --file dir/file3
 echo Level 1
 tar -c -f archive.tar -g db -C dir -v --warning=no-new-dir .
 )"
-echo incr05.at:22 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir gnu
-(cd gnu
-TEST_TAR_FORMAT=gnu
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H gnu"
-export TAR_OPTIONS
-rm -rf *
-
-mkdir dir
-mkdir dir/sub
-genfile --file dir/file1
-genfile --file dir/sub/file2
-
-echo Level 0
-tar -c -f archive.tar -g db -C dir -v --warning=no-new-dir .
-
-genfile --file dir/file3
-echo Level 1
-tar -c -f archive.tar -g db -C dir -v --warning=no-new-dir .
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'an embedded newline' "incr05.at:22"
+( $at_check_trace;
 mkdir gnu
 (cd gnu
 TEST_TAR_FORMAT=gnu
@@ -21996,11 +16314,11 @@ tar -c -f archive.tar -g db -C dir -v --
 genfile --file dir/file3
 echo Level 1
 tar -c -f archive.tar -g db -C dir -v --warning=no-new-dir .
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "Level 0
 ./
 ./sub/
@@ -22012,12 +16330,11 @@ Level 1
 ./file3
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/incr05.at:22"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/incr05.at:22"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/incr05.at:22:
 mkdir oldgnu
 (cd oldgnu
@@ -22039,11 +16356,8 @@ genfile --file dir/file3
 echo Level 1
 tar -c -f archive.tar -g db -C dir -v --warning=no-new-dir .
 )"
-echo incr05.at:22 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
+at_fn_check_prepare_notrace 'an embedded newline' "incr05.at:22"
+( $at_check_trace;
 mkdir oldgnu
 (cd oldgnu
 TEST_TAR_FORMAT=oldgnu
@@ -22063,34 +16377,11 @@ tar -c -f archive.tar -g db -C dir -v --
 genfile --file dir/file3
 echo Level 1
 tar -c -f archive.tar -g db -C dir -v --warning=no-new-dir .
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
-mkdir oldgnu
-(cd oldgnu
-TEST_TAR_FORMAT=oldgnu
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H oldgnu"
-export TAR_OPTIONS
-rm -rf *
-
-mkdir dir
-mkdir dir/sub
-genfile --file dir/file1
-genfile --file dir/sub/file2
-
-echo Level 0
-tar -c -f archive.tar -g db -C dir -v --warning=no-new-dir .
-
-genfile --file dir/file3
-echo Level 1
-tar -c -f archive.tar -g db -C dir -v --warning=no-new-dir .
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "Level 0
 ./
 ./sub/
@@ -22102,12 +16393,11 @@ Level 1
 ./file3
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/incr05.at:22"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/incr05.at:22"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/incr05.at:22:
 mkdir posix
 (cd posix
@@ -22129,34 +16419,8 @@ genfile --file dir/file3
 echo Level 1
 tar -c -f archive.tar -g db -C dir -v --warning=no-new-dir .
 )"
-echo incr05.at:22 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir posix
-(cd posix
-TEST_TAR_FORMAT=posix
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H posix"
-export TAR_OPTIONS
-rm -rf *
-
-mkdir dir
-mkdir dir/sub
-genfile --file dir/file1
-genfile --file dir/sub/file2
-
-echo Level 0
-tar -c -f archive.tar -g db -C dir -v --warning=no-new-dir .
-
-genfile --file dir/file3
-echo Level 1
-tar -c -f archive.tar -g db -C dir -v --warning=no-new-dir .
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'an embedded newline' "incr05.at:22"
+( $at_check_trace;
 mkdir posix
 (cd posix
 TEST_TAR_FORMAT=posix
@@ -22176,11 +16440,11 @@ tar -c -f archive.tar -g db -C dir -v --
 genfile --file dir/file3
 echo Level 1
 tar -c -f archive.tar -g db -C dir -v --warning=no-new-dir .
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "Level 0
 ./
 ./sub/
@@ -22192,36 +16456,32 @@ Level 1
 ./file3
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/incr05.at:22"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/incr05.at:22"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
 
 
 
-  $at_traceoff
+  set +x
   $at_times_p && times >"$at_times_file"
-) 5>&1 2>&1 | eval $at_tee_pipe
-at_status=`cat "$at_status_file"`
+) 5>&1 2>&1 7>&- | eval $at_tee_pipe
+read at_status <"$at_status_file"
 #AT_STOP_59
 #AT_START_60
-# 60. incr06.at:19: incremental dumps of nested directories
-at_setup_line='incr06.at:19'
-at_desc="incremental dumps of nested directories"
-$at_quiet $as_echo_n " 60: $at_desc        "
+at_fn_group_banner 60 'incr06.at:19' \
+  "incremental dumps of nested directories" "        "
 at_xfail=no
       test -f $XFAILFILE && at_xfail=yes
-echo "#                             -*- compilation -*-" >> "$at_group_log"
 (
-  $as_echo "60. incr06.at:19: testing ..."
+  $as_echo "60. $at_setup_line: testing $at_desc ..."
   $at_traceon
 
 
 
 
 
-  { $at_traceoff
+  { set +x
 $as_echo "$at_srcdir/incr06.at:22:
 mkdir gnu
 (cd gnu
@@ -22252,43 +16512,8 @@ tar -c -f archive-1.1.tar -g db.1 -C dir
 echo Level 1 sub .
 tar -c -f archive-1.2.tar -g db.2 -C dir -v --warning=no-new-dir sub .
 )"
-echo incr06.at:22 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir gnu
-(cd gnu
-TEST_TAR_FORMAT=gnu
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H gnu"
-export TAR_OPTIONS
-rm -rf *
-
-mkdir dir
-mkdir dir/sub
-mkdir dir/sub/a
-mkdir dir/sub/b
-genfile --file dir/file1
-genfile --file dir/sub/file2
-genfile --file dir/sub/a/file3
-
-echo Level 0 . sub
-tar -c -f archive-0.1.tar -g db.1 -C dir -v --warning=no-new-dir . sub
-echo Level 0 sub .
-tar -c -f archive-0.2.tar -g db.2 -C dir -v --warning=no-new-dir sub .
-
-mkdir dir/c
-genfile --file dir/sub/b/file4
-
-echo Level 1 . sub
-tar -c -f archive-1.1.tar -g db.1 -C dir -v --warning=no-new-dir . sub
-echo Level 1 sub .
-tar -c -f archive-1.2.tar -g db.2 -C dir -v --warning=no-new-dir sub .
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'an embedded newline' "incr06.at:22"
+( $at_check_trace;
 mkdir gnu
 (cd gnu
 TEST_TAR_FORMAT=gnu
@@ -22317,11 +16542,11 @@ echo Level 1 . sub
 tar -c -f archive-1.1.tar -g db.1 -C dir -v --warning=no-new-dir . sub
 echo Level 1 sub .
 tar -c -f archive-1.2.tar -g db.2 -C dir -v --warning=no-new-dir sub .
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "Level 0 . sub
 ./
 sub/
@@ -22354,12 +16579,11 @@ sub/b/
 sub/b/file4
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/incr06.at:22"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/incr06.at:22"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/incr06.at:22:
 mkdir oldgnu
 (cd oldgnu
@@ -22390,43 +16614,8 @@ tar -c -f archive-1.1.tar -g db.1 -C dir
 echo Level 1 sub .
 tar -c -f archive-1.2.tar -g db.2 -C dir -v --warning=no-new-dir sub .
 )"
-echo incr06.at:22 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir oldgnu
-(cd oldgnu
-TEST_TAR_FORMAT=oldgnu
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H oldgnu"
-export TAR_OPTIONS
-rm -rf *
-
-mkdir dir
-mkdir dir/sub
-mkdir dir/sub/a
-mkdir dir/sub/b
-genfile --file dir/file1
-genfile --file dir/sub/file2
-genfile --file dir/sub/a/file3
-
-echo Level 0 . sub
-tar -c -f archive-0.1.tar -g db.1 -C dir -v --warning=no-new-dir . sub
-echo Level 0 sub .
-tar -c -f archive-0.2.tar -g db.2 -C dir -v --warning=no-new-dir sub .
-
-mkdir dir/c
-genfile --file dir/sub/b/file4
-
-echo Level 1 . sub
-tar -c -f archive-1.1.tar -g db.1 -C dir -v --warning=no-new-dir . sub
-echo Level 1 sub .
-tar -c -f archive-1.2.tar -g db.2 -C dir -v --warning=no-new-dir sub .
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'an embedded newline' "incr06.at:22"
+( $at_check_trace;
 mkdir oldgnu
 (cd oldgnu
 TEST_TAR_FORMAT=oldgnu
@@ -22455,11 +16644,11 @@ echo Level 1 . sub
 tar -c -f archive-1.1.tar -g db.1 -C dir -v --warning=no-new-dir . sub
 echo Level 1 sub .
 tar -c -f archive-1.2.tar -g db.2 -C dir -v --warning=no-new-dir sub .
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "Level 0 . sub
 ./
 sub/
@@ -22492,12 +16681,11 @@ sub/b/
 sub/b/file4
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/incr06.at:22"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/incr06.at:22"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/incr06.at:22:
 mkdir posix
 (cd posix
@@ -22528,43 +16716,8 @@ tar -c -f archive-1.1.tar -g db.1 -C dir
 echo Level 1 sub .
 tar -c -f archive-1.2.tar -g db.2 -C dir -v --warning=no-new-dir sub .
 )"
-echo incr06.at:22 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir posix
-(cd posix
-TEST_TAR_FORMAT=posix
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H posix"
-export TAR_OPTIONS
-rm -rf *
-
-mkdir dir
-mkdir dir/sub
-mkdir dir/sub/a
-mkdir dir/sub/b
-genfile --file dir/file1
-genfile --file dir/sub/file2
-genfile --file dir/sub/a/file3
-
-echo Level 0 . sub
-tar -c -f archive-0.1.tar -g db.1 -C dir -v --warning=no-new-dir . sub
-echo Level 0 sub .
-tar -c -f archive-0.2.tar -g db.2 -C dir -v --warning=no-new-dir sub .
-
-mkdir dir/c
-genfile --file dir/sub/b/file4
-
-echo Level 1 . sub
-tar -c -f archive-1.1.tar -g db.1 -C dir -v --warning=no-new-dir . sub
-echo Level 1 sub .
-tar -c -f archive-1.2.tar -g db.2 -C dir -v --warning=no-new-dir sub .
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'an embedded newline' "incr06.at:22"
+( $at_check_trace;
 mkdir posix
 (cd posix
 TEST_TAR_FORMAT=posix
@@ -22593,11 +16746,11 @@ echo Level 1 . sub
 tar -c -f archive-1.1.tar -g db.1 -C dir -v --warning=no-new-dir . sub
 echo Level 1 sub .
 tar -c -f archive-1.2.tar -g db.2 -C dir -v --warning=no-new-dir sub .
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "Level 0 . sub
 ./
 sub/
@@ -22630,36 +16783,32 @@ sub/b/
 sub/b/file4
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/incr06.at:22"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/incr06.at:22"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
 
 
 
-  $at_traceoff
+  set +x
   $at_times_p && times >"$at_times_file"
-) 5>&1 2>&1 | eval $at_tee_pipe
-at_status=`cat "$at_status_file"`
+) 5>&1 2>&1 7>&- | eval $at_tee_pipe
+read at_status <"$at_status_file"
 #AT_STOP_60
 #AT_START_61
-# 61. filerem01.at:34: file removed as we read it (ca. 22 seconds)
-at_setup_line='filerem01.at:34'
-at_desc="file removed as we read it (ca. 22 seconds)"
-$at_quiet $as_echo_n " 61: $at_desc    "
+at_fn_group_banner 61 'filerem01.at:34' \
+  "file removed as we read it (ca. 22 seconds)" "    "
 at_xfail=no
       test -f $XFAILFILE && at_xfail=yes
-echo "#                             -*- compilation -*-" >> "$at_group_log"
 (
-  $as_echo "61. filerem01.at:34: testing ..."
+  $as_echo "61. $at_setup_line: testing $at_desc ..."
   $at_traceon
 
 
 
 
 
-  { $at_traceoff
+  { set +x
 $as_echo "$at_srcdir/filerem01.at:37:
 mkdir gnu
 (cd gnu
@@ -22679,32 +16828,8 @@ genfile --run --checkpoint=3 --unlink di
        --checkpoint-action='echo' -c -f archive.tar \\
        --listed-incremental db -v dir >/dev/null
 )"
-echo filerem01.at:37 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir gnu
-(cd gnu
-TEST_TAR_FORMAT=gnu
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H gnu"
-export TAR_OPTIONS
-rm -rf *
-
-mkdir dir
-mkdir dir/sub
-genfile --file dir/file1
-genfile --file dir/sub/file2
-
-genfile --run --checkpoint=3 --unlink dir/file1 -- \
-       tar --blocking-factor=1 --checkpoint=1 --checkpoint-action='sleep=1' \
-       --checkpoint-action='echo' -c -f archive.tar \
-       --listed-incremental db -v dir >/dev/null
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'an embedded newline' "filerem01.at:37"
+( $at_check_trace;
 mkdir gnu
 (cd gnu
 TEST_TAR_FORMAT=gnu
@@ -22722,22 +16847,21 @@ genfile --run --checkpoint=3 --unlink di
        tar --blocking-factor=1 --checkpoint=1 --checkpoint-action='sleep=1' \
        --checkpoint-action='echo' -c -f archive.tar \
        --listed-incremental db -v dir >/dev/null
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
 echo >>"$at_stderr"; $as_echo "tar: dir: Directory is new
 tar: dir/sub: Directory is new
 tar: dir/file1: File removed before we read it
 " | \
   $at_diff - "$at_stderr" || at_failed=:
 echo stdout:; cat "$at_stdout"
-at_func_check_status 1 $at_status "$at_srcdir/filerem01.at:37"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 1 $at_status "$at_srcdir/filerem01.at:37"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/filerem01.at:37:
 mkdir posix
 (cd posix
@@ -22757,32 +16881,8 @@ genfile --run --checkpoint=3 --unlink di
        --checkpoint-action='echo' -c -f archive.tar \\
        --listed-incremental db -v dir >/dev/null
 )"
-echo filerem01.at:37 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir posix
-(cd posix
-TEST_TAR_FORMAT=posix
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H posix"
-export TAR_OPTIONS
-rm -rf *
-
-mkdir dir
-mkdir dir/sub
-genfile --file dir/file1
-genfile --file dir/sub/file2
-
-genfile --run --checkpoint=3 --unlink dir/file1 -- \
-       tar --blocking-factor=1 --checkpoint=1 --checkpoint-action='sleep=1' \
-       --checkpoint-action='echo' -c -f archive.tar \
-       --listed-incremental db -v dir >/dev/null
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'an embedded newline' "filerem01.at:37"
+( $at_check_trace;
 mkdir posix
 (cd posix
 TEST_TAR_FORMAT=posix
@@ -22800,19 +16900,18 @@ genfile --run --checkpoint=3 --unlink di
        tar --blocking-factor=1 --checkpoint=1 --checkpoint-action='sleep=1' \
        --checkpoint-action='echo' -c -f archive.tar \
        --listed-incremental db -v dir >/dev/null
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
 echo >>"$at_stderr"; $as_echo "tar: dir: Directory is new
 tar: dir/sub: Directory is new
 tar: dir/file1: File removed before we read it
 " | \
   $at_diff - "$at_stderr" || at_failed=:
 echo stdout:; cat "$at_stdout"
-at_func_check_status 1 $at_status "$at_srcdir/filerem01.at:37"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 1 $at_status "$at_srcdir/filerem01.at:37"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
 
@@ -22863,28 +16962,25 @@ $at_traceon; }
 # ./tar: Write checkpoint 14
 
 
-  $at_traceoff
+  set +x
   $at_times_p && times >"$at_times_file"
-) 5>&1 2>&1 | eval $at_tee_pipe
-at_status=`cat "$at_status_file"`
+) 5>&1 2>&1 7>&- | eval $at_tee_pipe
+read at_status <"$at_status_file"
 #AT_STOP_61
 #AT_START_62
-# 62. filerem02.at:24: toplevel file removed (ca. 24 seconds)
-at_setup_line='filerem02.at:24'
-at_desc="toplevel file removed (ca. 24 seconds)"
-$at_quiet $as_echo_n " 62: $at_desc         "
+at_fn_group_banner 62 'filerem02.at:24' \
+  "toplevel file removed (ca. 24 seconds)" "         "
 at_xfail=no
       test -f $XFAILFILE && at_xfail=yes
-echo "#                             -*- compilation -*-" >> "$at_group_log"
 (
-  $as_echo "62. filerem02.at:24: testing ..."
+  $as_echo "62. $at_setup_line: testing $at_desc ..."
   $at_traceon
 
 
 
 
 
-  { $at_traceoff
+  { set +x
 $as_echo "$at_srcdir/filerem02.at:27:
 mkdir gnu
 (cd gnu
@@ -22906,34 +17002,8 @@ genfile --run --checkpoint=3 --exec 'rm
        --checkpoint-action='echo' -c -f archive.tar \\
        --listed-incremental db -v --warning=no-new-dir dir dir2 >/dev/null
 )"
-echo filerem02.at:27 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir gnu
-(cd gnu
-TEST_TAR_FORMAT=gnu
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H gnu"
-export TAR_OPTIONS
-rm -rf *
-
-mkdir dir
-mkdir dir/sub
-genfile --file dir/file1
-genfile --file dir/sub/file2
-mkdir dir2
-genfile --file dir2/file1
-
-genfile --run --checkpoint=3 --exec 'rm -rf dir2' -- \
-       tar --blocking-factor=1 --checkpoint=1 --checkpoint-action='sleep=1' \
-       --checkpoint-action='echo' -c -f archive.tar \
-       --listed-incremental db -v --warning=no-new-dir dir dir2 >/dev/null
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'an embedded newline' "filerem02.at:27"
+( $at_check_trace;
 mkdir gnu
 (cd gnu
 TEST_TAR_FORMAT=gnu
@@ -22953,18 +17023,17 @@ genfile --run --checkpoint=3 --exec 'rm
        tar --blocking-factor=1 --checkpoint=1 --checkpoint-action='sleep=1' \
        --checkpoint-action='echo' -c -f archive.tar \
        --listed-incremental db -v --warning=no-new-dir dir dir2 >/dev/null
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
 echo stderr:; cat "$at_stderr"
 echo stdout:; cat "$at_stdout"
-at_func_check_status 2 $at_status "$at_srcdir/filerem02.at:27"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 2 $at_status "$at_srcdir/filerem02.at:27"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/filerem02.at:27:
 mkdir posix
 (cd posix
@@ -22986,34 +17055,8 @@ genfile --run --checkpoint=3 --exec 'rm
        --checkpoint-action='echo' -c -f archive.tar \\
        --listed-incremental db -v --warning=no-new-dir dir dir2 >/dev/null
 )"
-echo filerem02.at:27 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir posix
-(cd posix
-TEST_TAR_FORMAT=posix
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H posix"
-export TAR_OPTIONS
-rm -rf *
-
-mkdir dir
-mkdir dir/sub
-genfile --file dir/file1
-genfile --file dir/sub/file2
-mkdir dir2
-genfile --file dir2/file1
-
-genfile --run --checkpoint=3 --exec 'rm -rf dir2' -- \
-       tar --blocking-factor=1 --checkpoint=1 --checkpoint-action='sleep=1' \
-       --checkpoint-action='echo' -c -f archive.tar \
-       --listed-incremental db -v --warning=no-new-dir dir dir2 >/dev/null
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'an embedded newline' "filerem02.at:27"
+( $at_check_trace;
 mkdir posix
 (cd posix
 TEST_TAR_FORMAT=posix
@@ -23033,15 +17076,14 @@ genfile --run --checkpoint=3 --exec 'rm
        tar --blocking-factor=1 --checkpoint=1 --checkpoint-action='sleep=1' \
        --checkpoint-action='echo' -c -f archive.tar \
        --listed-incremental db -v --warning=no-new-dir dir dir2 >/dev/null
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
 echo stderr:; cat "$at_stderr"
 echo stdout:; cat "$at_stdout"
-at_func_check_status 2 $at_status "$at_srcdir/filerem02.at:27"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 2 $at_status "$at_srcdir/filerem02.at:27"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
 
@@ -23052,28 +17094,25 @@ $at_traceon; }
 
 # Timing information: see filerem01.at
 
-  $at_traceoff
+  set +x
   $at_times_p && times >"$at_times_file"
-) 5>&1 2>&1 | eval $at_tee_pipe
-at_status=`cat "$at_status_file"`
+) 5>&1 2>&1 7>&- | eval $at_tee_pipe
+read at_status <"$at_status_file"
 #AT_STOP_62
 #AT_START_63
-# 63. rename01.at:24: renamed dirs in incrementals
-at_setup_line='rename01.at:24'
-at_desc="renamed dirs in incrementals"
-$at_quiet $as_echo_n " 63: $at_desc                   "
+at_fn_group_banner 63 'rename01.at:24' \
+  "renamed dirs in incrementals" "                   "
 at_xfail=no
       test -f $XFAILFILE && at_xfail=yes
-echo "#                             -*- compilation -*-" >> "$at_group_log"
 (
-  $as_echo "63. rename01.at:24: testing ..."
+  $as_echo "63. $at_setup_line: testing $at_desc ..."
   $at_traceon
 
 
 
 
 
-  { $at_traceoff
+  { set +x
 $as_echo "$at_srcdir/rename01.at:27:
 mkdir gnu
 (cd gnu
@@ -23084,7 +17123,7 @@ export TAR_OPTIONS
 rm -rf *
 
 
-test -z "`sort < /dev/null 2>&1`" || exit 77
+test -z \"\`sort < /dev/null 2>&1\`\" || exit 77
 
 
 mkdir foo
@@ -23114,11 +17153,8 @@ echo Begin directory listing 2
 find foo | sort
 echo End directory listing 2
 )"
-echo rename01.at:27 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
+at_fn_check_prepare_notrace 'a `...` command substitution' "rename01.at:27"
+( $at_check_trace;
 mkdir gnu
 (cd gnu
 TEST_TAR_FORMAT=gnu
@@ -23157,52 +17193,10 @@ tar xfg arch.2 /dev/null
 echo Begin directory listing 2
 find foo | sort
 echo End directory listing 2
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
-mkdir gnu
-(cd gnu
-TEST_TAR_FORMAT=gnu
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H gnu"
-export TAR_OPTIONS
-rm -rf *
-
-
-test -z "`sort < /dev/null 2>&1`" || exit 77
-
-
-mkdir foo
-genfile --file foo/file1
-genfile --file foo/file2
-mkdir foo/bar
-genfile --file foo/bar/file
-
-echo "Creating base archive"
-tar -g incr -cf arch.1 -v foo
-
-mv foo/bar foo/baz
-
-echo "Creating incremental archive"
-tar -g incr -cf arch.2 -v foo
-
-mv foo old
-
-tar xfg arch.1 /dev/null
-
-echo "Begin directory listing 1"
-find foo | sort
-echo "End directory listing 1"
-
-tar xfg arch.2 /dev/null
-echo Begin directory listing 2
-find foo | sort
-echo End directory listing 2
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
 echo >>"$at_stderr"; $as_echo "tar: foo: Directory is new
 tar: foo/bar: Directory is new
 tar: foo/baz: Directory has been renamed from \`foo/bar'
@@ -23233,12 +17227,11 @@ foo/file2
 End directory listing 2
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/rename01.at:27"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/rename01.at:27"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/rename01.at:27:
 mkdir oldgnu
 (cd oldgnu
@@ -23249,7 +17242,7 @@ export TAR_OPTIONS
 rm -rf *
 
 
-test -z "`sort < /dev/null 2>&1`" || exit 77
+test -z \"\`sort < /dev/null 2>&1\`\" || exit 77
 
 
 mkdir foo
@@ -23279,53 +17272,8 @@ echo Begin directory listing 2
 find foo | sort
 echo End directory listing 2
 )"
-echo rename01.at:27 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir oldgnu
-(cd oldgnu
-TEST_TAR_FORMAT=oldgnu
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H oldgnu"
-export TAR_OPTIONS
-rm -rf *
-
-
-test -z "`sort < /dev/null 2>&1`" || exit 77
-
-
-mkdir foo
-genfile --file foo/file1
-genfile --file foo/file2
-mkdir foo/bar
-genfile --file foo/bar/file
-
-echo "Creating base archive"
-tar -g incr -cf arch.1 -v foo
-
-mv foo/bar foo/baz
-
-echo "Creating incremental archive"
-tar -g incr -cf arch.2 -v foo
-
-mv foo old
-
-tar xfg arch.1 /dev/null
-
-echo "Begin directory listing 1"
-find foo | sort
-echo "End directory listing 1"
-
-tar xfg arch.2 /dev/null
-echo Begin directory listing 2
-find foo | sort
-echo End directory listing 2
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'a `...` command substitution' "rename01.at:27"
+( $at_check_trace;
 mkdir oldgnu
 (cd oldgnu
 TEST_TAR_FORMAT=oldgnu
@@ -23364,10 +17312,10 @@ tar xfg arch.2 /dev/null
 echo Begin directory listing 2
 find foo | sort
 echo End directory listing 2
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
 echo >>"$at_stderr"; $as_echo "tar: foo: Directory is new
 tar: foo/bar: Directory is new
 tar: foo/baz: Directory has been renamed from \`foo/bar'
@@ -23398,12 +17346,11 @@ foo/file2
 End directory listing 2
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/rename01.at:27"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/rename01.at:27"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/rename01.at:27:
 mkdir posix
 (cd posix
@@ -23414,7 +17361,7 @@ export TAR_OPTIONS
 rm -rf *
 
 
-test -z "`sort < /dev/null 2>&1`" || exit 77
+test -z \"\`sort < /dev/null 2>&1\`\" || exit 77
 
 
 mkdir foo
@@ -23444,53 +17391,8 @@ echo Begin directory listing 2
 find foo | sort
 echo End directory listing 2
 )"
-echo rename01.at:27 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir posix
-(cd posix
-TEST_TAR_FORMAT=posix
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H posix"
-export TAR_OPTIONS
-rm -rf *
-
-
-test -z "`sort < /dev/null 2>&1`" || exit 77
-
-
-mkdir foo
-genfile --file foo/file1
-genfile --file foo/file2
-mkdir foo/bar
-genfile --file foo/bar/file
-
-echo "Creating base archive"
-tar -g incr -cf arch.1 -v foo
-
-mv foo/bar foo/baz
-
-echo "Creating incremental archive"
-tar -g incr -cf arch.2 -v foo
-
-mv foo old
-
-tar xfg arch.1 /dev/null
-
-echo "Begin directory listing 1"
-find foo | sort
-echo "End directory listing 1"
-
-tar xfg arch.2 /dev/null
-echo Begin directory listing 2
-find foo | sort
-echo End directory listing 2
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'a `...` command substitution' "rename01.at:27"
+( $at_check_trace;
 mkdir posix
 (cd posix
 TEST_TAR_FORMAT=posix
@@ -23529,10 +17431,10 @@ tar xfg arch.2 /dev/null
 echo Begin directory listing 2
 find foo | sort
 echo End directory listing 2
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
 echo >>"$at_stderr"; $as_echo "tar: foo: Directory is new
 tar: foo/bar: Directory is new
 tar: foo/baz: Directory has been renamed from \`foo/bar'
@@ -23563,36 +17465,32 @@ foo/file2
 End directory listing 2
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/rename01.at:27"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/rename01.at:27"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
 
 
 
-  $at_traceoff
+  set +x
   $at_times_p && times >"$at_times_file"
-) 5>&1 2>&1 | eval $at_tee_pipe
-at_status=`cat "$at_status_file"`
+) 5>&1 2>&1 7>&- | eval $at_tee_pipe
+read at_status <"$at_status_file"
 #AT_STOP_63
 #AT_START_64
-# 64. rename02.at:24: move between hierarchies
-at_setup_line='rename02.at:24'
-at_desc="move between hierarchies"
-$at_quiet $as_echo_n " 64: $at_desc                       "
+at_fn_group_banner 64 'rename02.at:24' \
+  "move between hierarchies" "                       "
 at_xfail=no
       test -f $XFAILFILE && at_xfail=yes
-echo "#                             -*- compilation -*-" >> "$at_group_log"
 (
-  $as_echo "64. rename02.at:24: testing ..."
+  $as_echo "64. $at_setup_line: testing $at_desc ..."
   $at_traceon
 
 
 
 
 
-  { $at_traceoff
+  { set +x
 $as_echo "$at_srcdir/rename02.at:27:
 mkdir gnu
 (cd gnu
@@ -23603,7 +17501,7 @@ export TAR_OPTIONS
 rm -rf *
 
 
-test -z "`sort < /dev/null 2>&1`" || exit 77
+test -z \"\`sort < /dev/null 2>&1\`\" || exit 77
 
 mkdir foo
 genfile --file foo/file1
@@ -23637,57 +17535,8 @@ echo Begin directory listing 2
 find foo | sort
 echo End directory listing 2
 )"
-echo rename02.at:27 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir gnu
-(cd gnu
-TEST_TAR_FORMAT=gnu
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H gnu"
-export TAR_OPTIONS
-rm -rf *
-
-
-test -z "`sort < /dev/null 2>&1`" || exit 77
-
-mkdir foo
-genfile --file foo/file1
-genfile --file foo/file2
-mkdir foo/bar
-genfile --file foo/bar/file.r
-mkdir foo/bar/baz
-genfile --file foo/bar/baz/file.z
-
-sleep 1
-
-echo "Creating base archive"
-tar -g incr -cf arch.1 -v foo
-
-mv foo/bar/baz foo
-
-echo "Creating incremental archive"
-tar -g incr -cf arch.2 -v foo
-
-mv foo old
-
-tar xfg arch.1 /dev/null --warning=no-timestamp 2>tmperr
-sort tmperr >&2
-
-echo "Begin directory listing 1"
-find foo | sort
-echo "End directory listing 1"
-
-tar xfgv arch.2 /dev/null --warning=no-timestamp
-echo Begin directory listing 2
-find foo | sort
-echo End directory listing 2
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'a `...` command substitution' "rename02.at:27"
+( $at_check_trace;
 mkdir gnu
 (cd gnu
 TEST_TAR_FORMAT=gnu
@@ -23730,10 +17579,10 @@ tar xfgv arch.2 /dev/null --warning=no-t
 echo Begin directory listing 2
 find foo | sort
 echo End directory listing 2
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
 echo >>"$at_stderr"; $as_echo "tar: foo: Directory is new
 tar: foo/bar: Directory is new
 tar: foo/bar/baz: Directory is new
@@ -23775,12 +17624,11 @@ foo/file2
 End directory listing 2
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/rename02.at:27"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/rename02.at:27"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/rename02.at:27:
 mkdir oldgnu
 (cd oldgnu
@@ -23791,7 +17639,7 @@ export TAR_OPTIONS
 rm -rf *
 
 
-test -z "`sort < /dev/null 2>&1`" || exit 77
+test -z \"\`sort < /dev/null 2>&1\`\" || exit 77
 
 mkdir foo
 genfile --file foo/file1
@@ -23825,57 +17673,8 @@ echo Begin directory listing 2
 find foo | sort
 echo End directory listing 2
 )"
-echo rename02.at:27 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir oldgnu
-(cd oldgnu
-TEST_TAR_FORMAT=oldgnu
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H oldgnu"
-export TAR_OPTIONS
-rm -rf *
-
-
-test -z "`sort < /dev/null 2>&1`" || exit 77
-
-mkdir foo
-genfile --file foo/file1
-genfile --file foo/file2
-mkdir foo/bar
-genfile --file foo/bar/file.r
-mkdir foo/bar/baz
-genfile --file foo/bar/baz/file.z
-
-sleep 1
-
-echo "Creating base archive"
-tar -g incr -cf arch.1 -v foo
-
-mv foo/bar/baz foo
-
-echo "Creating incremental archive"
-tar -g incr -cf arch.2 -v foo
-
-mv foo old
-
-tar xfg arch.1 /dev/null --warning=no-timestamp 2>tmperr
-sort tmperr >&2
-
-echo "Begin directory listing 1"
-find foo | sort
-echo "End directory listing 1"
-
-tar xfgv arch.2 /dev/null --warning=no-timestamp
-echo Begin directory listing 2
-find foo | sort
-echo End directory listing 2
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'a `...` command substitution' "rename02.at:27"
+( $at_check_trace;
 mkdir oldgnu
 (cd oldgnu
 TEST_TAR_FORMAT=oldgnu
@@ -23918,10 +17717,10 @@ tar xfgv arch.2 /dev/null --warning=no-t
 echo Begin directory listing 2
 find foo | sort
 echo End directory listing 2
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
 echo >>"$at_stderr"; $as_echo "tar: foo: Directory is new
 tar: foo/bar: Directory is new
 tar: foo/bar/baz: Directory is new
@@ -23963,12 +17762,11 @@ foo/file2
 End directory listing 2
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/rename02.at:27"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/rename02.at:27"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/rename02.at:27:
 mkdir posix
 (cd posix
@@ -23979,7 +17777,7 @@ export TAR_OPTIONS
 rm -rf *
 
 
-test -z "`sort < /dev/null 2>&1`" || exit 77
+test -z \"\`sort < /dev/null 2>&1\`\" || exit 77
 
 mkdir foo
 genfile --file foo/file1
@@ -24013,11 +17811,8 @@ echo Begin directory listing 2
 find foo | sort
 echo End directory listing 2
 )"
-echo rename02.at:27 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
+at_fn_check_prepare_notrace 'a `...` command substitution' "rename02.at:27"
+( $at_check_trace;
 mkdir posix
 (cd posix
 TEST_TAR_FORMAT=posix
@@ -24060,56 +17855,10 @@ tar xfgv arch.2 /dev/null --warning=no-t
 echo Begin directory listing 2
 find foo | sort
 echo End directory listing 2
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
-mkdir posix
-(cd posix
-TEST_TAR_FORMAT=posix
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H posix"
-export TAR_OPTIONS
-rm -rf *
-
-
-test -z "`sort < /dev/null 2>&1`" || exit 77
-
-mkdir foo
-genfile --file foo/file1
-genfile --file foo/file2
-mkdir foo/bar
-genfile --file foo/bar/file.r
-mkdir foo/bar/baz
-genfile --file foo/bar/baz/file.z
-
-sleep 1
-
-echo "Creating base archive"
-tar -g incr -cf arch.1 -v foo
-
-mv foo/bar/baz foo
-
-echo "Creating incremental archive"
-tar -g incr -cf arch.2 -v foo
-
-mv foo old
-
-tar xfg arch.1 /dev/null --warning=no-timestamp 2>tmperr
-sort tmperr >&2
-
-echo "Begin directory listing 1"
-find foo | sort
-echo "End directory listing 1"
-
-tar xfgv arch.2 /dev/null --warning=no-timestamp
-echo Begin directory listing 2
-find foo | sort
-echo End directory listing 2
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
 echo >>"$at_stderr"; $as_echo "tar: foo: Directory is new
 tar: foo/bar: Directory is new
 tar: foo/bar/baz: Directory is new
@@ -24151,36 +17900,32 @@ foo/file2
 End directory listing 2
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/rename02.at:27"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/rename02.at:27"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
 
 
 
-  $at_traceoff
+  set +x
   $at_times_p && times >"$at_times_file"
-) 5>&1 2>&1 | eval $at_tee_pipe
-at_status=`cat "$at_status_file"`
+) 5>&1 2>&1 7>&- | eval $at_tee_pipe
+read at_status <"$at_status_file"
 #AT_STOP_64
 #AT_START_65
-# 65. rename03.at:23: cyclic renames
-at_setup_line='rename03.at:23'
-at_desc="cyclic renames"
-$at_quiet $as_echo_n " 65: $at_desc                                 "
+at_fn_group_banner 65 'rename03.at:23' \
+  "cyclic renames" "                                 "
 at_xfail=no
       test -f $XFAILFILE && at_xfail=yes
-echo "#                             -*- compilation -*-" >> "$at_group_log"
 (
-  $as_echo "65. rename03.at:23: testing ..."
+  $as_echo "65. $at_setup_line: testing $at_desc ..."
   $at_traceon
 
 
 
 
 
-  { $at_traceoff
+  { set +x
 $as_echo "$at_srcdir/rename03.at:26:
 mkdir gnu
 (cd gnu
@@ -24191,7 +17936,7 @@ export TAR_OPTIONS
 rm -rf *
 
 
-test -z "`sort < /dev/null 2>&1`" || exit 77
+test -z \"\`sort < /dev/null 2>&1\`\" || exit 77
 
 
 mkdir foo
@@ -24237,11 +17982,8 @@ echo Begin directory listing 2
 find foo | sort
 echo End directory listing 2
 )"
-echo rename03.at:26 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
+at_fn_check_prepare_notrace 'a `...` command substitution' "rename03.at:26"
+( $at_check_trace;
 mkdir gnu
 (cd gnu
 TEST_TAR_FORMAT=gnu
@@ -24296,68 +18038,10 @@ tar xfgv arch.2 /dev/null --warning=no-t
 echo Begin directory listing 2
 find foo | sort
 echo End directory listing 2
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
-mkdir gnu
-(cd gnu
-TEST_TAR_FORMAT=gnu
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H gnu"
-export TAR_OPTIONS
-rm -rf *
-
-
-test -z "`sort < /dev/null 2>&1`" || exit 77
-
-
-mkdir foo
-genfile --file foo/file1
-genfile --file foo/file2
-
-mkdir foo/a
-genfile --file foo/a/filea
-
-mkdir foo/b
-genfile --file foo/b/fileb
-
-mkdir foo/c
-genfile --file foo/c/filec
-
-sleep 1
-
-echo "First dump"
-echo "First dump">&2
-tar -g incr -cf arch.1 -v foo 2>tmperr
-sort tmperr >&2
-
-# Shuffle directories:
-(cd foo
-mv a $$
-mv c a
-mv b c
-mv $$ b)
-
-echo "Second dump"
-echo "Second dump" >&2
-tar -g incr -cf arch.2 -v foo 2>tmperr
-sort tmperr >&2
-
-tar xfg arch.1 /dev/null --warning=no-timestamp
-
-echo "Begin directory listing 1"
-find foo | sort
-echo "End directory listing 1"
-
-tar xfgv arch.2 /dev/null --warning=no-timestamp
-echo Begin directory listing 2
-find foo | sort
-echo End directory listing 2
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
 echo >>"$at_stderr"; $as_echo "First dump
 tar: foo/a: Directory is new
 tar: foo/b: Directory is new
@@ -24412,12 +18096,11 @@ foo/file2
 End directory listing 2
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/rename03.at:26"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/rename03.at:26"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/rename03.at:26:
 mkdir oldgnu
 (cd oldgnu
@@ -24428,7 +18111,7 @@ export TAR_OPTIONS
 rm -rf *
 
 
-test -z "`sort < /dev/null 2>&1`" || exit 77
+test -z \"\`sort < /dev/null 2>&1\`\" || exit 77
 
 
 mkdir foo
@@ -24474,69 +18157,8 @@ echo Begin directory listing 2
 find foo | sort
 echo End directory listing 2
 )"
-echo rename03.at:26 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir oldgnu
-(cd oldgnu
-TEST_TAR_FORMAT=oldgnu
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H oldgnu"
-export TAR_OPTIONS
-rm -rf *
-
-
-test -z "`sort < /dev/null 2>&1`" || exit 77
-
-
-mkdir foo
-genfile --file foo/file1
-genfile --file foo/file2
-
-mkdir foo/a
-genfile --file foo/a/filea
-
-mkdir foo/b
-genfile --file foo/b/fileb
-
-mkdir foo/c
-genfile --file foo/c/filec
-
-sleep 1
-
-echo "First dump"
-echo "First dump">&2
-tar -g incr -cf arch.1 -v foo 2>tmperr
-sort tmperr >&2
-
-# Shuffle directories:
-(cd foo
-mv a $$
-mv c a
-mv b c
-mv $$ b)
-
-echo "Second dump"
-echo "Second dump" >&2
-tar -g incr -cf arch.2 -v foo 2>tmperr
-sort tmperr >&2
-
-tar xfg arch.1 /dev/null --warning=no-timestamp
-
-echo "Begin directory listing 1"
-find foo | sort
-echo "End directory listing 1"
-
-tar xfgv arch.2 /dev/null --warning=no-timestamp
-echo Begin directory listing 2
-find foo | sort
-echo End directory listing 2
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'a `...` command substitution' "rename03.at:26"
+( $at_check_trace;
 mkdir oldgnu
 (cd oldgnu
 TEST_TAR_FORMAT=oldgnu
@@ -24591,10 +18213,10 @@ tar xfgv arch.2 /dev/null --warning=no-t
 echo Begin directory listing 2
 find foo | sort
 echo End directory listing 2
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
 echo >>"$at_stderr"; $as_echo "First dump
 tar: foo/a: Directory is new
 tar: foo/b: Directory is new
@@ -24649,12 +18271,11 @@ foo/file2
 End directory listing 2
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/rename03.at:26"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/rename03.at:26"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/rename03.at:26:
 mkdir posix
 (cd posix
@@ -24665,7 +18286,7 @@ export TAR_OPTIONS
 rm -rf *
 
 
-test -z "`sort < /dev/null 2>&1`" || exit 77
+test -z \"\`sort < /dev/null 2>&1\`\" || exit 77
 
 
 mkdir foo
@@ -24711,69 +18332,8 @@ echo Begin directory listing 2
 find foo | sort
 echo End directory listing 2
 )"
-echo rename03.at:26 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir posix
-(cd posix
-TEST_TAR_FORMAT=posix
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H posix"
-export TAR_OPTIONS
-rm -rf *
-
-
-test -z "`sort < /dev/null 2>&1`" || exit 77
-
-
-mkdir foo
-genfile --file foo/file1
-genfile --file foo/file2
-
-mkdir foo/a
-genfile --file foo/a/filea
-
-mkdir foo/b
-genfile --file foo/b/fileb
-
-mkdir foo/c
-genfile --file foo/c/filec
-
-sleep 1
-
-echo "First dump"
-echo "First dump">&2
-tar -g incr -cf arch.1 -v foo 2>tmperr
-sort tmperr >&2
-
-# Shuffle directories:
-(cd foo
-mv a $$
-mv c a
-mv b c
-mv $$ b)
-
-echo "Second dump"
-echo "Second dump" >&2
-tar -g incr -cf arch.2 -v foo 2>tmperr
-sort tmperr >&2
-
-tar xfg arch.1 /dev/null --warning=no-timestamp
-
-echo "Begin directory listing 1"
-find foo | sort
-echo "End directory listing 1"
-
-tar xfgv arch.2 /dev/null --warning=no-timestamp
-echo Begin directory listing 2
-find foo | sort
-echo End directory listing 2
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'a `...` command substitution' "rename03.at:26"
+( $at_check_trace;
 mkdir posix
 (cd posix
 TEST_TAR_FORMAT=posix
@@ -24828,10 +18388,10 @@ tar xfgv arch.2 /dev/null --warning=no-t
 echo Begin directory listing 2
 find foo | sort
 echo End directory listing 2
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
 echo >>"$at_stderr"; $as_echo "First dump
 tar: foo/a: Directory is new
 tar: foo/b: Directory is new
@@ -24886,36 +18446,32 @@ foo/file2
 End directory listing 2
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/rename03.at:26"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/rename03.at:26"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
 
 
 
-  $at_traceoff
+  set +x
   $at_times_p && times >"$at_times_file"
-) 5>&1 2>&1 | eval $at_tee_pipe
-at_status=`cat "$at_status_file"`
+) 5>&1 2>&1 7>&- | eval $at_tee_pipe
+read at_status <"$at_status_file"
 #AT_STOP_65
 #AT_START_66
-# 66. rename04.at:27: renamed directory containing subdirectories
-at_setup_line='rename04.at:27'
-at_desc="renamed directory containing subdirectories"
-$at_quiet $as_echo_n " 66: $at_desc    "
+at_fn_group_banner 66 'rename04.at:27' \
+  "renamed directory containing subdirectories" "    "
 at_xfail=no
       test -f $XFAILFILE && at_xfail=yes
-echo "#                             -*- compilation -*-" >> "$at_group_log"
 (
-  $as_echo "66. rename04.at:27: testing ..."
+  $as_echo "66. $at_setup_line: testing $at_desc ..."
   $at_traceon
 
 
 
 
 
-  { $at_traceoff
+  { set +x
 $as_echo "$at_srcdir/rename04.at:30:
 mkdir gnu
 (cd gnu
@@ -24926,7 +18482,7 @@ export TAR_OPTIONS
 rm -rf *
 
 
-test -z "`sort < /dev/null 2>&1`" || exit 77
+test -z \"\`sort < /dev/null 2>&1\`\" || exit 77
 
 
 decho Creating directory structure
@@ -24954,51 +18510,8 @@ decho Second restore
 tar -xf archive.2 -g db.2
 find dir | sort
 )"
-echo rename04.at:30 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir gnu
-(cd gnu
-TEST_TAR_FORMAT=gnu
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H gnu"
-export TAR_OPTIONS
-rm -rf *
-
-
-test -z "`sort < /dev/null 2>&1`" || exit 77
-
-
-decho Creating directory structure
-mkdir directory
-mkdir directory/subdir
-genfile --file=directory/file
-
-decho Creating initial archive
-tar -cf archive.1 -g db.1 directory
-
-decho Renaming
-mv directory dir
-
-decho Creating incremental archive
-cp db.1 db.2
-tar -cf archive.2 -g db.2 dir
-
-mv dir orig
-
-decho First restore
-tar -xf archive.1 -g db.1
-find directory | sort
-
-decho Second restore
-tar -xf archive.2 -g db.2
-find dir | sort
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'a `...` command substitution' "rename04.at:30"
+( $at_check_trace;
 mkdir gnu
 (cd gnu
 TEST_TAR_FORMAT=gnu
@@ -25035,10 +18548,10 @@ find directory | sort
 decho Second restore
 tar -xf archive.2 -g db.2
 find dir | sort
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
 echo >>"$at_stderr"; $as_echo "Creating directory structure
 Creating initial archive
 Renaming
@@ -25060,12 +18573,11 @@ dir
 dir/subdir
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/rename04.at:30"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/rename04.at:30"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/rename04.at:30:
 mkdir oldgnu
 (cd oldgnu
@@ -25076,7 +18588,7 @@ export TAR_OPTIONS
 rm -rf *
 
 
-test -z "`sort < /dev/null 2>&1`" || exit 77
+test -z \"\`sort < /dev/null 2>&1\`\" || exit 77
 
 
 decho Creating directory structure
@@ -25104,51 +18616,8 @@ decho Second restore
 tar -xf archive.2 -g db.2
 find dir | sort
 )"
-echo rename04.at:30 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir oldgnu
-(cd oldgnu
-TEST_TAR_FORMAT=oldgnu
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H oldgnu"
-export TAR_OPTIONS
-rm -rf *
-
-
-test -z "`sort < /dev/null 2>&1`" || exit 77
-
-
-decho Creating directory structure
-mkdir directory
-mkdir directory/subdir
-genfile --file=directory/file
-
-decho Creating initial archive
-tar -cf archive.1 -g db.1 directory
-
-decho Renaming
-mv directory dir
-
-decho Creating incremental archive
-cp db.1 db.2
-tar -cf archive.2 -g db.2 dir
-
-mv dir orig
-
-decho First restore
-tar -xf archive.1 -g db.1
-find directory | sort
-
-decho Second restore
-tar -xf archive.2 -g db.2
-find dir | sort
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'a `...` command substitution' "rename04.at:30"
+( $at_check_trace;
 mkdir oldgnu
 (cd oldgnu
 TEST_TAR_FORMAT=oldgnu
@@ -25185,10 +18654,10 @@ find directory | sort
 decho Second restore
 tar -xf archive.2 -g db.2
 find dir | sort
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
 echo >>"$at_stderr"; $as_echo "Creating directory structure
 Creating initial archive
 Renaming
@@ -25210,12 +18679,11 @@ dir
 dir/subdir
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/rename04.at:30"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/rename04.at:30"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/rename04.at:30:
 mkdir posix
 (cd posix
@@ -25226,7 +18694,7 @@ export TAR_OPTIONS
 rm -rf *
 
 
-test -z "`sort < /dev/null 2>&1`" || exit 77
+test -z \"\`sort < /dev/null 2>&1\`\" || exit 77
 
 
 decho Creating directory structure
@@ -25254,11 +18722,8 @@ decho Second restore
 tar -xf archive.2 -g db.2
 find dir | sort
 )"
-echo rename04.at:30 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
+at_fn_check_prepare_notrace 'a `...` command substitution' "rename04.at:30"
+( $at_check_trace;
 mkdir posix
 (cd posix
 TEST_TAR_FORMAT=posix
@@ -25295,50 +18760,10 @@ find directory | sort
 decho Second restore
 tar -xf archive.2 -g db.2
 find dir | sort
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
-mkdir posix
-(cd posix
-TEST_TAR_FORMAT=posix
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H posix"
-export TAR_OPTIONS
-rm -rf *
-
-
-test -z "`sort < /dev/null 2>&1`" || exit 77
-
-
-decho Creating directory structure
-mkdir directory
-mkdir directory/subdir
-genfile --file=directory/file
-
-decho Creating initial archive
-tar -cf archive.1 -g db.1 directory
-
-decho Renaming
-mv directory dir
-
-decho Creating incremental archive
-cp db.1 db.2
-tar -cf archive.2 -g db.2 dir
-
-mv dir orig
-
-decho First restore
-tar -xf archive.1 -g db.1
-find directory | sort
-
-decho Second restore
-tar -xf archive.2 -g db.2
-find dir | sort
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
 echo >>"$at_stderr"; $as_echo "Creating directory structure
 Creating initial archive
 Renaming
@@ -25360,36 +18785,32 @@ dir
 dir/subdir
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/rename04.at:30"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/rename04.at:30"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
 
 
 
-  $at_traceoff
+  set +x
   $at_times_p && times >"$at_times_file"
-) 5>&1 2>&1 | eval $at_tee_pipe
-at_status=`cat "$at_status_file"`
+) 5>&1 2>&1 7>&- | eval $at_tee_pipe
+read at_status <"$at_status_file"
 #AT_STOP_66
 #AT_START_67
-# 67. rename05.at:24: renamed subdirectories
-at_setup_line='rename05.at:24'
-at_desc="renamed subdirectories"
-$at_quiet $as_echo_n " 67: $at_desc                         "
+at_fn_group_banner 67 'rename05.at:24' \
+  "renamed subdirectories" "                         "
 at_xfail=no
       test -f $XFAILFILE && at_xfail=yes
-echo "#                             -*- compilation -*-" >> "$at_group_log"
 (
-  $as_echo "67. rename05.at:24: testing ..."
+  $as_echo "67. $at_setup_line: testing $at_desc ..."
   $at_traceon
 
 
 
 
 
-  { $at_traceoff
+  { set +x
 $as_echo "$at_srcdir/rename05.at:27:
 mkdir gnu
 (cd gnu
@@ -25400,7 +18821,7 @@ export TAR_OPTIONS
 rm -rf *
 
 
-test -z "`sort < /dev/null 2>&1`" || exit 77
+test -z \"\`sort < /dev/null 2>&1\`\" || exit 77
 
 
 decho Creating directory structure
@@ -25429,52 +18850,8 @@ decho Second restore
 tar -xf archive.2 -g db.2 --warning=no-timestamp
 find dir | sort
 )"
-echo rename05.at:27 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir gnu
-(cd gnu
-TEST_TAR_FORMAT=gnu
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H gnu"
-export TAR_OPTIONS
-rm -rf *
-
-
-test -z "`sort < /dev/null 2>&1`" || exit 77
-
-
-decho Creating directory structure
-mkdir directory
-mkdir directory/subdir
-genfile --file=directory/file
-
-decho Creating initial archive
-tar -cf archive.1 -g db.1 directory
-
-decho Renaming
-mv directory/subdir directory/subdir.0
-mv directory dir
-
-decho Creating incremental archive
-cp db.1 db.2
-tar -cf archive.2 -g db.2 dir
-
-mv dir orig
-
-decho First restore
-tar -xf archive.1 -g db.1 --warning=no-timestamp
-find directory | sort
-
-decho Second restore
-tar -xf archive.2 -g db.2 --warning=no-timestamp
-find dir | sort
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'a `...` command substitution' "rename05.at:27"
+( $at_check_trace;
 mkdir gnu
 (cd gnu
 TEST_TAR_FORMAT=gnu
@@ -25512,10 +18889,10 @@ find directory | sort
 decho Second restore
 tar -xf archive.2 -g db.2 --warning=no-timestamp
 find dir | sort
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
 echo >>"$at_stderr"; $as_echo "Creating directory structure
 Creating initial archive
 Renaming
@@ -25537,12 +18914,11 @@ dir
 dir/subdir.0
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/rename05.at:27"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/rename05.at:27"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/rename05.at:27:
 mkdir oldgnu
 (cd oldgnu
@@ -25553,7 +18929,7 @@ export TAR_OPTIONS
 rm -rf *
 
 
-test -z "`sort < /dev/null 2>&1`" || exit 77
+test -z \"\`sort < /dev/null 2>&1\`\" || exit 77
 
 
 decho Creating directory structure
@@ -25582,11 +18958,8 @@ decho Second restore
 tar -xf archive.2 -g db.2 --warning=no-timestamp
 find dir | sort
 )"
-echo rename05.at:27 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
+at_fn_check_prepare_notrace 'a `...` command substitution' "rename05.at:27"
+( $at_check_trace;
 mkdir oldgnu
 (cd oldgnu
 TEST_TAR_FORMAT=oldgnu
@@ -25624,51 +18997,10 @@ find directory | sort
 decho Second restore
 tar -xf archive.2 -g db.2 --warning=no-timestamp
 find dir | sort
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
-mkdir oldgnu
-(cd oldgnu
-TEST_TAR_FORMAT=oldgnu
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H oldgnu"
-export TAR_OPTIONS
-rm -rf *
-
-
-test -z "`sort < /dev/null 2>&1`" || exit 77
-
-
-decho Creating directory structure
-mkdir directory
-mkdir directory/subdir
-genfile --file=directory/file
-
-decho Creating initial archive
-tar -cf archive.1 -g db.1 directory
-
-decho Renaming
-mv directory/subdir directory/subdir.0
-mv directory dir
-
-decho Creating incremental archive
-cp db.1 db.2
-tar -cf archive.2 -g db.2 dir
-
-mv dir orig
-
-decho First restore
-tar -xf archive.1 -g db.1 --warning=no-timestamp
-find directory | sort
-
-decho Second restore
-tar -xf archive.2 -g db.2 --warning=no-timestamp
-find dir | sort
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
 echo >>"$at_stderr"; $as_echo "Creating directory structure
 Creating initial archive
 Renaming
@@ -25690,12 +19022,11 @@ dir
 dir/subdir.0
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/rename05.at:27"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/rename05.at:27"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/rename05.at:27:
 mkdir posix
 (cd posix
@@ -25706,7 +19037,7 @@ export TAR_OPTIONS
 rm -rf *
 
 
-test -z "`sort < /dev/null 2>&1`" || exit 77
+test -z \"\`sort < /dev/null 2>&1\`\" || exit 77
 
 
 decho Creating directory structure
@@ -25735,52 +19066,8 @@ decho Second restore
 tar -xf archive.2 -g db.2 --warning=no-timestamp
 find dir | sort
 )"
-echo rename05.at:27 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir posix
-(cd posix
-TEST_TAR_FORMAT=posix
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H posix"
-export TAR_OPTIONS
-rm -rf *
-
-
-test -z "`sort < /dev/null 2>&1`" || exit 77
-
-
-decho Creating directory structure
-mkdir directory
-mkdir directory/subdir
-genfile --file=directory/file
-
-decho Creating initial archive
-tar -cf archive.1 -g db.1 directory
-
-decho Renaming
-mv directory/subdir directory/subdir.0
-mv directory dir
-
-decho Creating incremental archive
-cp db.1 db.2
-tar -cf archive.2 -g db.2 dir
-
-mv dir orig
-
-decho First restore
-tar -xf archive.1 -g db.1 --warning=no-timestamp
-find directory | sort
-
-decho Second restore
-tar -xf archive.2 -g db.2 --warning=no-timestamp
-find dir | sort
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'a `...` command substitution' "rename05.at:27"
+( $at_check_trace;
 mkdir posix
 (cd posix
 TEST_TAR_FORMAT=posix
@@ -25818,10 +19105,10 @@ find directory | sort
 decho Second restore
 tar -xf archive.2 -g db.2 --warning=no-timestamp
 find dir | sort
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
 echo >>"$at_stderr"; $as_echo "Creating directory structure
 Creating initial archive
 Renaming
@@ -25843,36 +19130,32 @@ dir
 dir/subdir.0
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/rename05.at:27"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/rename05.at:27"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
 
 
 
-  $at_traceoff
+  set +x
   $at_times_p && times >"$at_times_file"
-) 5>&1 2>&1 | eval $at_tee_pipe
-at_status=`cat "$at_status_file"`
+) 5>&1 2>&1 7>&- | eval $at_tee_pipe
+read at_status <"$at_status_file"
 #AT_STOP_67
 #AT_START_68
-# 68. chtype.at:27: changed file types in incrementals
-at_setup_line='chtype.at:27'
-at_desc="changed file types in incrementals"
-$at_quiet $as_echo_n " 68: $at_desc             "
+at_fn_group_banner 68 'chtype.at:27' \
+  "changed file types in incrementals" "             "
 at_xfail=no
       test -f $XFAILFILE && at_xfail=yes
-echo "#                             -*- compilation -*-" >> "$at_group_log"
 (
-  $as_echo "68. chtype.at:27: testing ..."
+  $as_echo "68. $at_setup_line: testing $at_desc ..."
   $at_traceon
 
 
 
 
 
-  { $at_traceoff
+  { set +x
 $as_echo "$at_srcdir/chtype.at:30:
 mkdir gnu
 (cd gnu
@@ -25883,7 +19166,7 @@ export TAR_OPTIONS
 rm -rf *
 
 
-test -z "`sort < /dev/null 2>&1`" || exit 77
+test -z \"\`sort < /dev/null 2>&1\`\" || exit 77
 
 
 install-sh -d directory/b/c >/dev/null && genfile --file directory/b/c/x || exit 77
@@ -25913,53 +19196,8 @@ echo Restore archive.2
 tar -xf archive.2 --listed-incremental=/dev/null --warning=no-timestamp
 find directory | sort
 )"
-echo chtype.at:30 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir gnu
-(cd gnu
-TEST_TAR_FORMAT=gnu
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H gnu"
-export TAR_OPTIONS
-rm -rf *
-
-
-test -z "`sort < /dev/null 2>&1`" || exit 77
-
-
-install-sh -d directory/b/c >/dev/null && genfile --file directory/b/c/x || exit 77
-mkdir directory/a
-genfile --file directory/a/a
-
-echo First backup
-tar --create --file=archive.1 --listed-incremental=db.1 directory
-
-sleep 2
-
-# Remove directory b and create a file with this name.
-# Previous versions were not able to restore over this file.
-rm -r directory/b
-genfile --file directory/b
-genfile --file directory/a/b
-
-echo Second backup
-tar --create --file=archive.2 --listed-incremental=db.2 directory
-
-# Delete a
-rm -r directory
-
-echo Restore archive.1
-tar -xf archive.1 --listed-incremental=/dev/null --warning=no-timestamp
-echo Restore archive.2
-tar -xf archive.2 --listed-incremental=/dev/null --warning=no-timestamp
-find directory | sort
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'a `...` command substitution' "chtype.at:30"
+( $at_check_trace;
 mkdir gnu
 (cd gnu
 TEST_TAR_FORMAT=gnu
@@ -25998,11 +19236,11 @@ tar -xf archive.1 --listed-incremental=/
 echo Restore archive.2
 tar -xf archive.2 --listed-incremental=/dev/null --warning=no-timestamp
 find directory | sort
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "First backup
 Second backup
 Restore archive.1
@@ -26014,12 +19252,11 @@ directory/a/b
 directory/b
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/chtype.at:30"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/chtype.at:30"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/chtype.at:30:
 mkdir oldgnu
 (cd oldgnu
@@ -26030,7 +19267,7 @@ export TAR_OPTIONS
 rm -rf *
 
 
-test -z "`sort < /dev/null 2>&1`" || exit 77
+test -z \"\`sort < /dev/null 2>&1\`\" || exit 77
 
 
 install-sh -d directory/b/c >/dev/null && genfile --file directory/b/c/x || exit 77
@@ -26060,11 +19297,8 @@ echo Restore archive.2
 tar -xf archive.2 --listed-incremental=/dev/null --warning=no-timestamp
 find directory | sort
 )"
-echo chtype.at:30 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
+at_fn_check_prepare_notrace 'a `...` command substitution' "chtype.at:30"
+( $at_check_trace;
 mkdir oldgnu
 (cd oldgnu
 TEST_TAR_FORMAT=oldgnu
@@ -26103,53 +19337,11 @@ tar -xf archive.1 --listed-incremental=/
 echo Restore archive.2
 tar -xf archive.2 --listed-incremental=/dev/null --warning=no-timestamp
 find directory | sort
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
-mkdir oldgnu
-(cd oldgnu
-TEST_TAR_FORMAT=oldgnu
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H oldgnu"
-export TAR_OPTIONS
-rm -rf *
-
-
-test -z "`sort < /dev/null 2>&1`" || exit 77
-
-
-install-sh -d directory/b/c >/dev/null && genfile --file directory/b/c/x || exit 77
-mkdir directory/a
-genfile --file directory/a/a
-
-echo First backup
-tar --create --file=archive.1 --listed-incremental=db.1 directory
-
-sleep 2
-
-# Remove directory b and create a file with this name.
-# Previous versions were not able to restore over this file.
-rm -r directory/b
-genfile --file directory/b
-genfile --file directory/a/b
-
-echo Second backup
-tar --create --file=archive.2 --listed-incremental=db.2 directory
-
-# Delete a
-rm -r directory
-
-echo Restore archive.1
-tar -xf archive.1 --listed-incremental=/dev/null --warning=no-timestamp
-echo Restore archive.2
-tar -xf archive.2 --listed-incremental=/dev/null --warning=no-timestamp
-find directory | sort
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "First backup
 Second backup
 Restore archive.1
@@ -26161,12 +19353,11 @@ directory/a/b
 directory/b
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/chtype.at:30"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/chtype.at:30"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/chtype.at:30:
 mkdir posix
 (cd posix
@@ -26177,7 +19368,7 @@ export TAR_OPTIONS
 rm -rf *
 
 
-test -z "`sort < /dev/null 2>&1`" || exit 77
+test -z \"\`sort < /dev/null 2>&1\`\" || exit 77
 
 
 install-sh -d directory/b/c >/dev/null && genfile --file directory/b/c/x || exit 77
@@ -26207,53 +19398,8 @@ echo Restore archive.2
 tar -xf archive.2 --listed-incremental=/dev/null --warning=no-timestamp
 find directory | sort
 )"
-echo chtype.at:30 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir posix
-(cd posix
-TEST_TAR_FORMAT=posix
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H posix"
-export TAR_OPTIONS
-rm -rf *
-
-
-test -z "`sort < /dev/null 2>&1`" || exit 77
-
-
-install-sh -d directory/b/c >/dev/null && genfile --file directory/b/c/x || exit 77
-mkdir directory/a
-genfile --file directory/a/a
-
-echo First backup
-tar --create --file=archive.1 --listed-incremental=db.1 directory
-
-sleep 2
-
-# Remove directory b and create a file with this name.
-# Previous versions were not able to restore over this file.
-rm -r directory/b
-genfile --file directory/b
-genfile --file directory/a/b
-
-echo Second backup
-tar --create --file=archive.2 --listed-incremental=db.2 directory
-
-# Delete a
-rm -r directory
-
-echo Restore archive.1
-tar -xf archive.1 --listed-incremental=/dev/null --warning=no-timestamp
-echo Restore archive.2
-tar -xf archive.2 --listed-incremental=/dev/null --warning=no-timestamp
-find directory | sort
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'a `...` command substitution' "chtype.at:30"
+( $at_check_trace;
 mkdir posix
 (cd posix
 TEST_TAR_FORMAT=posix
@@ -26292,11 +19438,11 @@ tar -xf archive.1 --listed-incremental=/
 echo Restore archive.2
 tar -xf archive.2 --listed-incremental=/dev/null --warning=no-timestamp
 find directory | sort
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "First backup
 Second backup
 Restore archive.1
@@ -26308,36 +19454,32 @@ directory/a/b
 directory/b
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/chtype.at:30"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/chtype.at:30"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
 
 
 
-  $at_traceoff
+  set +x
   $at_times_p && times >"$at_times_file"
-) 5>&1 2>&1 | eval $at_tee_pipe
-at_status=`cat "$at_status_file"`
+) 5>&1 2>&1 7>&- | eval $at_tee_pipe
+read at_status <"$at_status_file"
 #AT_STOP_68
 #AT_START_69
-# 69. ignfail.at:23: ignfail
-at_setup_line='ignfail.at:23'
-at_desc="ignfail"
-$at_quiet $as_echo_n " 69: $at_desc                                        "
+at_fn_group_banner 69 'ignfail.at:23' \
+  "ignfail" "                                        "
 at_xfail=no
       test -f $XFAILFILE && at_xfail=yes
-echo "#                             -*- compilation -*-" >> "$at_group_log"
 (
-  $as_echo "69. ignfail.at:23: testing ..."
+  $as_echo "69. $at_setup_line: testing $at_desc ..."
   $at_traceon
 
 
 
 
 
-  { $at_traceoff
+  { set +x
 $as_echo "$at_srcdir/ignfail.at:26:
 mkdir v7
 (cd v7
@@ -26349,248 +19491,12 @@ rm -rf *
 
 # The test is meaningless for super-user.
 
-echo "test" > $$
-chmod 0 $$
-cat $$ > /dev/null 2>&1
-result=$?
-rm -f $$
-test $result -eq 0 && exit 77
-
-
-touch file
-mkdir directory
-touch directory/file
-
-echo 1>&2 -----
-chmod 000 file
-tar cf archive file
-status=\$?
-chmod 600 file
-test \$status = 2 || exit 1
-
-echo 1>&2 -----
-chmod 000 file
-tar cf archive --ignore-failed-read file || exit 1
-status=\$?
-chmod 600 file
-test \$status = 0 || exit 1
-
-echo 1>&2 -----
-chmod 000 directory
-tar cf archive directory
-status=\$?
-chmod 700 directory
-test \$status = 2 || exit 1
-
-echo 1>&2 -----
-chmod 000 directory
-tar cf archive --ignore-failed-read directory || exit 1
-status=\$?
-chmod 700 directory
-test \$status = 0
-)"
-echo ignfail.at:26 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir v7
-(cd v7
-TEST_TAR_FORMAT=v7
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H v7"
-export TAR_OPTIONS
-rm -rf *
-
-# The test is meaningless for super-user.
-
-echo "test" > $$
-chmod 0 $$
-cat $$ > /dev/null 2>&1
-result=$?
-rm -f $$
-test $result -eq 0 && exit 77
-
-
-touch file
-mkdir directory
-touch directory/file
-
-echo 1>&2 -----
-chmod 000 file
-tar cf archive file
-status=$?
-chmod 600 file
-test $status = 2 || exit 1
-
-echo 1>&2 -----
-chmod 000 file
-tar cf archive --ignore-failed-read file || exit 1
-status=$?
-chmod 600 file
-test $status = 0 || exit 1
-
-echo 1>&2 -----
-chmod 000 directory
-tar cf archive directory
-status=$?
-chmod 700 directory
-test $status = 2 || exit 1
-
-echo 1>&2 -----
-chmod 000 directory
-tar cf archive --ignore-failed-read directory || exit 1
-status=$?
-chmod 700 directory
-test $status = 0
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
-mkdir v7
-(cd v7
-TEST_TAR_FORMAT=v7
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H v7"
-export TAR_OPTIONS
-rm -rf *
-
-# The test is meaningless for super-user.
-
-echo "test" > $$
-chmod 0 $$
-cat $$ > /dev/null 2>&1
-result=$?
-rm -f $$
-test $result -eq 0 && exit 77
-
-
-touch file
-mkdir directory
-touch directory/file
-
-echo 1>&2 -----
-chmod 000 file
-tar cf archive file
-status=$?
-chmod 600 file
-test $status = 2 || exit 1
-
-echo 1>&2 -----
-chmod 000 file
-tar cf archive --ignore-failed-read file || exit 1
-status=$?
-chmod 600 file
-test $status = 0 || exit 1
-
-echo 1>&2 -----
-chmod 000 directory
-tar cf archive directory
-status=$?
-chmod 700 directory
-test $status = 2 || exit 1
-
-echo 1>&2 -----
-chmod 000 directory
-tar cf archive --ignore-failed-read directory || exit 1
-status=$?
-chmod 700 directory
-test $status = 0
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-echo >>"$at_stderr"; $as_echo "-----
-tar: file: Cannot open: Permission denied
-tar: Exiting with failure status due to previous errors
------
-tar: file: Warning: Cannot open: Permission denied
------
-tar: directory: Cannot open: Permission denied
-tar: Exiting with failure status due to previous errors
------
-tar: directory: Warning: Cannot open: Permission denied
-" | \
-  $at_diff - "$at_stderr" || at_failed=:
-at_func_diff_devnull "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/ignfail.at:26"
-
-$at_failed && at_func_log_failure
-$at_traceon; }
-
-              { $at_traceoff
-$as_echo "$at_srcdir/ignfail.at:26:
-mkdir oldgnu
-(cd oldgnu
-TEST_TAR_FORMAT=oldgnu
-export TEST_TAR_FORMAT
-TAR_OPTIONS=\"-H oldgnu\"
-export TAR_OPTIONS
-rm -rf *
-
-# The test is meaningless for super-user.
-
-echo "test" > $$
-chmod 0 $$
-cat $$ > /dev/null 2>&1
-result=$?
-rm -f $$
-test $result -eq 0 && exit 77
-
-
-touch file
-mkdir directory
-touch directory/file
-
-echo 1>&2 -----
-chmod 000 file
-tar cf archive file
-status=\$?
-chmod 600 file
-test \$status = 2 || exit 1
-
-echo 1>&2 -----
-chmod 000 file
-tar cf archive --ignore-failed-read file || exit 1
-status=\$?
-chmod 600 file
-test \$status = 0 || exit 1
-
-echo 1>&2 -----
-chmod 000 directory
-tar cf archive directory
-status=\$?
-chmod 700 directory
-test \$status = 2 || exit 1
-
-echo 1>&2 -----
-chmod 000 directory
-tar cf archive --ignore-failed-read directory || exit 1
-status=\$?
-chmod 700 directory
-test \$status = 0
-)"
-echo ignfail.at:26 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir oldgnu
-(cd oldgnu
-TEST_TAR_FORMAT=oldgnu
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H oldgnu"
-export TAR_OPTIONS
-rm -rf *
-
-# The test is meaningless for super-user.
-
-echo "test" > $$
-chmod 0 $$
-cat $$ > /dev/null 2>&1
-result=$?
-rm -f $$
-test $result -eq 0 && exit 77
+echo \"test\" > \$\$
+chmod 0 \$\$
+cat \$\$ > /dev/null 2>&1
+result=\$?
+rm -f \$\$
+test \$result -eq 0 && exit 77
 
 
 touch file
@@ -26600,39 +19506,38 @@ touch directory/file
 echo 1>&2 -----
 chmod 000 file
 tar cf archive file
-status=$?
+status=\$?
 chmod 600 file
-test $status = 2 || exit 1
+test \$status = 2 || exit 1
 
 echo 1>&2 -----
 chmod 000 file
 tar cf archive --ignore-failed-read file || exit 1
-status=$?
+status=\$?
 chmod 600 file
-test $status = 0 || exit 1
+test \$status = 0 || exit 1
 
 echo 1>&2 -----
 chmod 000 directory
 tar cf archive directory
-status=$?
+status=\$?
 chmod 700 directory
-test $status = 2 || exit 1
+test \$status = 2 || exit 1
 
 echo 1>&2 -----
 chmod 000 directory
 tar cf archive --ignore-failed-read directory || exit 1
-status=$?
+status=\$?
 chmod 700 directory
-test $status = 0
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
-mkdir oldgnu
-(cd oldgnu
-TEST_TAR_FORMAT=oldgnu
+test \$status = 0
+)"
+at_fn_check_prepare_notrace 'an embedded newline' "ignfail.at:26"
+( $at_check_trace;
+mkdir v7
+(cd v7
+TEST_TAR_FORMAT=v7
 export TEST_TAR_FORMAT
-TAR_OPTIONS="-H oldgnu"
+TAR_OPTIONS="-H v7"
 export TAR_OPTIONS
 rm -rf *
 
@@ -26677,10 +19582,10 @@ tar cf archive --ignore-failed-read dire
 status=$?
 chmod 700 directory
 test $status = 0
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
 echo >>"$at_stderr"; $as_echo "-----
 tar: file: Cannot open: Permission denied
 tar: Exiting with failure status due to previous errors
@@ -26693,30 +19598,29 @@ tar: Exiting with failure status due to
 tar: directory: Warning: Cannot open: Permission denied
 " | \
   $at_diff - "$at_stderr" || at_failed=:
-at_func_diff_devnull "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/ignfail.at:26"
-
-$at_failed && at_func_log_failure
+at_fn_diff_devnull "$at_stdout" || at_failed=:
+at_fn_check_status 0 $at_status "$at_srcdir/ignfail.at:26"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/ignfail.at:26:
-mkdir ustar
-(cd ustar
-TEST_TAR_FORMAT=ustar
+mkdir oldgnu
+(cd oldgnu
+TEST_TAR_FORMAT=oldgnu
 export TEST_TAR_FORMAT
-TAR_OPTIONS=\"-H ustar\"
+TAR_OPTIONS=\"-H oldgnu\"
 export TAR_OPTIONS
 rm -rf *
 
 # The test is meaningless for super-user.
 
-echo "test" > $$
-chmod 0 $$
-cat $$ > /dev/null 2>&1
-result=$?
-rm -f $$
-test $result -eq 0 && exit 77
+echo \"test\" > \$\$
+chmod 0 \$\$
+cat \$\$ > /dev/null 2>&1
+result=\$?
+rm -f \$\$
+test \$result -eq 0 && exit 77
 
 
 touch file
@@ -26751,16 +19655,13 @@ status=\$?
 chmod 700 directory
 test \$status = 0
 )"
-echo ignfail.at:26 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir ustar
-(cd ustar
-TEST_TAR_FORMAT=ustar
+at_fn_check_prepare_notrace 'an embedded newline' "ignfail.at:26"
+( $at_check_trace;
+mkdir oldgnu
+(cd oldgnu
+TEST_TAR_FORMAT=oldgnu
 export TEST_TAR_FORMAT
-TAR_OPTIONS="-H ustar"
+TAR_OPTIONS="-H oldgnu"
 export TAR_OPTIONS
 rm -rf *
 
@@ -26805,10 +19706,81 @@ tar cf archive --ignore-failed-read dire
 status=$?
 chmod 700 directory
 test $status = 0
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+echo >>"$at_stderr"; $as_echo "-----
+tar: file: Cannot open: Permission denied
+tar: Exiting with failure status due to previous errors
+-----
+tar: file: Warning: Cannot open: Permission denied
+-----
+tar: directory: Cannot open: Permission denied
+tar: Exiting with failure status due to previous errors
+-----
+tar: directory: Warning: Cannot open: Permission denied
+" | \
+  $at_diff - "$at_stderr" || at_failed=:
+at_fn_diff_devnull "$at_stdout" || at_failed=:
+at_fn_check_status 0 $at_status "$at_srcdir/ignfail.at:26"
+$at_failed && at_fn_log_failure
+$at_traceon; }
+
+              { set +x
+$as_echo "$at_srcdir/ignfail.at:26:
+mkdir ustar
+(cd ustar
+TEST_TAR_FORMAT=ustar
+export TEST_TAR_FORMAT
+TAR_OPTIONS=\"-H ustar\"
+export TAR_OPTIONS
+rm -rf *
+
+# The test is meaningless for super-user.
+
+echo \"test\" > \$\$
+chmod 0 \$\$
+cat \$\$ > /dev/null 2>&1
+result=\$?
+rm -f \$\$
+test \$result -eq 0 && exit 77
+
+
+touch file
+mkdir directory
+touch directory/file
+
+echo 1>&2 -----
+chmod 000 file
+tar cf archive file
+status=\$?
+chmod 600 file
+test \$status = 2 || exit 1
+
+echo 1>&2 -----
+chmod 000 file
+tar cf archive --ignore-failed-read file || exit 1
+status=\$?
+chmod 600 file
+test \$status = 0 || exit 1
+
+echo 1>&2 -----
+chmod 000 directory
+tar cf archive directory
+status=\$?
+chmod 700 directory
+test \$status = 2 || exit 1
+
+echo 1>&2 -----
+chmod 000 directory
+tar cf archive --ignore-failed-read directory || exit 1
+status=\$?
+chmod 700 directory
+test \$status = 0
+)"
+at_fn_check_prepare_notrace 'an embedded newline' "ignfail.at:26"
+( $at_check_trace;
 mkdir ustar
 (cd ustar
 TEST_TAR_FORMAT=ustar
@@ -26858,10 +19830,10 @@ tar cf archive --ignore-failed-read dire
 status=$?
 chmod 700 directory
 test $status = 0
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
 echo >>"$at_stderr"; $as_echo "-----
 tar: file: Cannot open: Permission denied
 tar: Exiting with failure status due to previous errors
@@ -26874,13 +19846,12 @@ tar: Exiting with failure status due to
 tar: directory: Warning: Cannot open: Permission denied
 " | \
   $at_diff - "$at_stderr" || at_failed=:
-at_func_diff_devnull "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/ignfail.at:26"
-
-$at_failed && at_func_log_failure
+at_fn_diff_devnull "$at_stdout" || at_failed=:
+at_fn_check_status 0 $at_status "$at_srcdir/ignfail.at:26"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/ignfail.at:26:
 mkdir posix
 (cd posix
@@ -26892,12 +19863,12 @@ rm -rf *
 
 # The test is meaningless for super-user.
 
-echo "test" > $$
-chmod 0 $$
-cat $$ > /dev/null 2>&1
-result=$?
-rm -f $$
-test $result -eq 0 && exit 77
+echo \"test\" > \$\$
+chmod 0 \$\$
+cat \$\$ > /dev/null 2>&1
+result=\$?
+rm -f \$\$
+test \$result -eq 0 && exit 77
 
 
 touch file
@@ -26932,64 +19903,8 @@ status=\$?
 chmod 700 directory
 test \$status = 0
 )"
-echo ignfail.at:26 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir posix
-(cd posix
-TEST_TAR_FORMAT=posix
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H posix"
-export TAR_OPTIONS
-rm -rf *
-
-# The test is meaningless for super-user.
-
-echo "test" > $$
-chmod 0 $$
-cat $$ > /dev/null 2>&1
-result=$?
-rm -f $$
-test $result -eq 0 && exit 77
-
-
-touch file
-mkdir directory
-touch directory/file
-
-echo 1>&2 -----
-chmod 000 file
-tar cf archive file
-status=$?
-chmod 600 file
-test $status = 2 || exit 1
-
-echo 1>&2 -----
-chmod 000 file
-tar cf archive --ignore-failed-read file || exit 1
-status=$?
-chmod 600 file
-test $status = 0 || exit 1
-
-echo 1>&2 -----
-chmod 000 directory
-tar cf archive directory
-status=$?
-chmod 700 directory
-test $status = 2 || exit 1
-
-echo 1>&2 -----
-chmod 000 directory
-tar cf archive --ignore-failed-read directory || exit 1
-status=$?
-chmod 700 directory
-test $status = 0
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'an embedded newline' "ignfail.at:26"
+( $at_check_trace;
 mkdir posix
 (cd posix
 TEST_TAR_FORMAT=posix
@@ -27039,10 +19954,10 @@ tar cf archive --ignore-failed-read dire
 status=$?
 chmod 700 directory
 test $status = 0
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
 echo >>"$at_stderr"; $as_echo "-----
 tar: file: Cannot open: Permission denied
 tar: Exiting with failure status due to previous errors
@@ -27055,13 +19970,12 @@ tar: Exiting with failure status due to
 tar: directory: Warning: Cannot open: Permission denied
 " | \
   $at_diff - "$at_stderr" || at_failed=:
-at_func_diff_devnull "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/ignfail.at:26"
-
-$at_failed && at_func_log_failure
+at_fn_diff_devnull "$at_stdout" || at_failed=:
+at_fn_check_status 0 $at_status "$at_srcdir/ignfail.at:26"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/ignfail.at:26:
 mkdir gnu
 (cd gnu
@@ -27073,12 +19987,12 @@ rm -rf *
 
 # The test is meaningless for super-user.
 
-echo "test" > $$
-chmod 0 $$
-cat $$ > /dev/null 2>&1
-result=$?
-rm -f $$
-test $result -eq 0 && exit 77
+echo \"test\" > \$\$
+chmod 0 \$\$
+cat \$\$ > /dev/null 2>&1
+result=\$?
+rm -f \$\$
+test \$result -eq 0 && exit 77
 
 
 touch file
@@ -27113,64 +20027,8 @@ status=\$?
 chmod 700 directory
 test \$status = 0
 )"
-echo ignfail.at:26 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir gnu
-(cd gnu
-TEST_TAR_FORMAT=gnu
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H gnu"
-export TAR_OPTIONS
-rm -rf *
-
-# The test is meaningless for super-user.
-
-echo "test" > $$
-chmod 0 $$
-cat $$ > /dev/null 2>&1
-result=$?
-rm -f $$
-test $result -eq 0 && exit 77
-
-
-touch file
-mkdir directory
-touch directory/file
-
-echo 1>&2 -----
-chmod 000 file
-tar cf archive file
-status=$?
-chmod 600 file
-test $status = 2 || exit 1
-
-echo 1>&2 -----
-chmod 000 file
-tar cf archive --ignore-failed-read file || exit 1
-status=$?
-chmod 600 file
-test $status = 0 || exit 1
-
-echo 1>&2 -----
-chmod 000 directory
-tar cf archive directory
-status=$?
-chmod 700 directory
-test $status = 2 || exit 1
-
-echo 1>&2 -----
-chmod 000 directory
-tar cf archive --ignore-failed-read directory || exit 1
-status=$?
-chmod 700 directory
-test $status = 0
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'an embedded newline' "ignfail.at:26"
+( $at_check_trace;
 mkdir gnu
 (cd gnu
 TEST_TAR_FORMAT=gnu
@@ -27220,10 +20078,10 @@ tar cf archive --ignore-failed-read dire
 status=$?
 chmod 700 directory
 test $status = 0
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
 echo >>"$at_stderr"; $as_echo "-----
 tar: file: Cannot open: Permission denied
 tar: Exiting with failure status due to previous errors
@@ -27236,70 +20094,39 @@ tar: Exiting with failure status due to
 tar: directory: Warning: Cannot open: Permission denied
 " | \
   $at_diff - "$at_stderr" || at_failed=:
-at_func_diff_devnull "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/ignfail.at:26"
-
-$at_failed && at_func_log_failure
+at_fn_diff_devnull "$at_stdout" || at_failed=:
+at_fn_check_status 0 $at_status "$at_srcdir/ignfail.at:26"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
 
 
 
-  $at_traceoff
+  set +x
   $at_times_p && times >"$at_times_file"
-) 5>&1 2>&1 | eval $at_tee_pipe
-at_status=`cat "$at_status_file"`
+) 5>&1 2>&1 7>&- | eval $at_tee_pipe
+read at_status <"$at_status_file"
 #AT_STOP_69
 #AT_START_70
-# 70. link01.at:33: link count gt 2
-at_setup_line='link01.at:33'
-at_desc="link count gt 2"
-$at_quiet $as_echo_n " 70: $at_desc                                "
+at_fn_group_banner 70 'link01.at:33' \
+  "link count gt 2" "                                "
 at_xfail=no
       test -f $XFAILFILE && at_xfail=yes
-echo "#                             -*- compilation -*-" >> "$at_group_log"
 (
-  $as_echo "70. link01.at:33: testing ..."
+  $as_echo "70. $at_setup_line: testing $at_desc ..."
   $at_traceon
 
 
 
 
-
-  { $at_traceoff
-$as_echo "$at_srcdir/link01.at:36:
-mkdir v7
-(cd v7
-TEST_TAR_FORMAT=v7
-export TEST_TAR_FORMAT
-TAR_OPTIONS=\"-H v7\"
-export TAR_OPTIONS
-rm -rf *
-
-mkdir directory
-mkdir directory/test1
-mkdir directory/test2
-
-echo TEST > directory/test1/test.txt
-ln directory/test1/test.txt directory/test2/test.txt || exit 77
-
-tar cf archive directory/test1/test.txt directory/test1/test.txt
-
-rm -r directory
-tar xf archive --warning=no-timestamp
-
-ls directory/test1
-)"
-echo link01.at:36 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
+
+  { set +x
+$as_echo "$at_srcdir/link01.at:36:
 mkdir v7
 (cd v7
 TEST_TAR_FORMAT=v7
 export TEST_TAR_FORMAT
-TAR_OPTIONS="-H v7"
+TAR_OPTIONS=\"-H v7\"
 export TAR_OPTIONS
 rm -rf *
 
@@ -27316,10 +20143,9 @@ rm -r directory
 tar xf archive --warning=no-timestamp
 
 ls directory/test1
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+)"
+at_fn_check_prepare_notrace 'an embedded newline' "link01.at:36"
+( $at_check_trace;
 mkdir v7
 (cd v7
 TEST_TAR_FORMAT=v7
@@ -27341,20 +20167,19 @@ rm -r directory
 tar xf archive --warning=no-timestamp
 
 ls directory/test1
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "test.txt
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/link01.at:36"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/link01.at:36"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/link01.at:36:
 mkdir oldgnu
 (cd oldgnu
@@ -27378,36 +20203,8 @@ tar xf archive --warning=no-timestamp
 
 ls directory/test1
 )"
-echo link01.at:36 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir oldgnu
-(cd oldgnu
-TEST_TAR_FORMAT=oldgnu
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H oldgnu"
-export TAR_OPTIONS
-rm -rf *
-
-mkdir directory
-mkdir directory/test1
-mkdir directory/test2
-
-echo TEST > directory/test1/test.txt
-ln directory/test1/test.txt directory/test2/test.txt || exit 77
-
-tar cf archive directory/test1/test.txt directory/test1/test.txt
-
-rm -r directory
-tar xf archive --warning=no-timestamp
-
-ls directory/test1
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'an embedded newline' "link01.at:36"
+( $at_check_trace;
 mkdir oldgnu
 (cd oldgnu
 TEST_TAR_FORMAT=oldgnu
@@ -27429,20 +20226,19 @@ rm -r directory
 tar xf archive --warning=no-timestamp
 
 ls directory/test1
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "test.txt
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/link01.at:36"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/link01.at:36"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/link01.at:36:
 mkdir ustar
 (cd ustar
@@ -27466,36 +20262,8 @@ tar xf archive --warning=no-timestamp
 
 ls directory/test1
 )"
-echo link01.at:36 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir ustar
-(cd ustar
-TEST_TAR_FORMAT=ustar
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H ustar"
-export TAR_OPTIONS
-rm -rf *
-
-mkdir directory
-mkdir directory/test1
-mkdir directory/test2
-
-echo TEST > directory/test1/test.txt
-ln directory/test1/test.txt directory/test2/test.txt || exit 77
-
-tar cf archive directory/test1/test.txt directory/test1/test.txt
-
-rm -r directory
-tar xf archive --warning=no-timestamp
-
-ls directory/test1
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'an embedded newline' "link01.at:36"
+( $at_check_trace;
 mkdir ustar
 (cd ustar
 TEST_TAR_FORMAT=ustar
@@ -27517,20 +20285,19 @@ rm -r directory
 tar xf archive --warning=no-timestamp
 
 ls directory/test1
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "test.txt
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/link01.at:36"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/link01.at:36"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/link01.at:36:
 mkdir posix
 (cd posix
@@ -27554,36 +20321,8 @@ tar xf archive --warning=no-timestamp
 
 ls directory/test1
 )"
-echo link01.at:36 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir posix
-(cd posix
-TEST_TAR_FORMAT=posix
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H posix"
-export TAR_OPTIONS
-rm -rf *
-
-mkdir directory
-mkdir directory/test1
-mkdir directory/test2
-
-echo TEST > directory/test1/test.txt
-ln directory/test1/test.txt directory/test2/test.txt || exit 77
-
-tar cf archive directory/test1/test.txt directory/test1/test.txt
-
-rm -r directory
-tar xf archive --warning=no-timestamp
-
-ls directory/test1
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'an embedded newline' "link01.at:36"
+( $at_check_trace;
 mkdir posix
 (cd posix
 TEST_TAR_FORMAT=posix
@@ -27605,20 +20344,19 @@ rm -r directory
 tar xf archive --warning=no-timestamp
 
 ls directory/test1
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "test.txt
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/link01.at:36"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/link01.at:36"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/link01.at:36:
 mkdir gnu
 (cd gnu
@@ -27642,36 +20380,8 @@ tar xf archive --warning=no-timestamp
 
 ls directory/test1
 )"
-echo link01.at:36 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir gnu
-(cd gnu
-TEST_TAR_FORMAT=gnu
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H gnu"
-export TAR_OPTIONS
-rm -rf *
-
-mkdir directory
-mkdir directory/test1
-mkdir directory/test2
-
-echo TEST > directory/test1/test.txt
-ln directory/test1/test.txt directory/test2/test.txt || exit 77
-
-tar cf archive directory/test1/test.txt directory/test1/test.txt
-
-rm -r directory
-tar xf archive --warning=no-timestamp
-
-ls directory/test1
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'an embedded newline' "link01.at:36"
+( $at_check_trace;
 mkdir gnu
 (cd gnu
 TEST_TAR_FORMAT=gnu
@@ -27693,44 +20403,40 @@ rm -r directory
 tar xf archive --warning=no-timestamp
 
 ls directory/test1
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "test.txt
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/link01.at:36"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/link01.at:36"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
 
 
 
-  $at_traceoff
+  set +x
   $at_times_p && times >"$at_times_file"
-) 5>&1 2>&1 | eval $at_tee_pipe
-at_status=`cat "$at_status_file"`
+) 5>&1 2>&1 7>&- | eval $at_tee_pipe
+read at_status <"$at_status_file"
 #AT_STOP_70
 #AT_START_71
-# 71. link02.at:32: preserve hard links with --remove-files
-at_setup_line='link02.at:32'
-at_desc="preserve hard links with --remove-files"
-$at_quiet $as_echo_n " 71: $at_desc        "
+at_fn_group_banner 71 'link02.at:32' \
+  "preserve hard links with --remove-files" "        "
 at_xfail=no
       test -f $XFAILFILE && at_xfail=yes
-echo "#                             -*- compilation -*-" >> "$at_group_log"
 (
-  $as_echo "71. link02.at:32: testing ..."
+  $as_echo "71. $at_setup_line: testing $at_desc ..."
   $at_traceon
 
 
 
 
 
-  { $at_traceoff
+  { set +x
 $as_echo "$at_srcdir/link02.at:35:
 mkdir v7
 (cd v7
@@ -27747,29 +20453,8 @@ ln file3 file4
 tar -c -f archive --remove-files file1 file2 file3 file4
 tar tfv archive | sed -n 's/.*file[2-4] link to //p'
 )"
-echo link02.at:35 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir v7
-(cd v7
-TEST_TAR_FORMAT=v7
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H v7"
-export TAR_OPTIONS
-rm -rf *
-
-genfile -l 64 -f file1
-ln file1 file2
-ln file2 file3
-ln file3 file4
-tar -c -f archive --remove-files file1 file2 file3 file4
-tar tfv archive | sed -n 's/.*file[2-4] link to //p'
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'an embedded newline' "link02.at:35"
+( $at_check_trace;
 mkdir v7
 (cd v7
 TEST_TAR_FORMAT=v7
@@ -27784,22 +20469,21 @@ ln file2 file3
 ln file3 file4
 tar -c -f archive --remove-files file1 file2 file3 file4
 tar tfv archive | sed -n 's/.*file[2-4] link to //p'
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "file1
 file1
 file1
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/link02.at:35"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/link02.at:35"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/link02.at:35:
 mkdir oldgnu
 (cd oldgnu
@@ -27816,29 +20500,8 @@ ln file3 file4
 tar -c -f archive --remove-files file1 file2 file3 file4
 tar tfv archive | sed -n 's/.*file[2-4] link to //p'
 )"
-echo link02.at:35 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir oldgnu
-(cd oldgnu
-TEST_TAR_FORMAT=oldgnu
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H oldgnu"
-export TAR_OPTIONS
-rm -rf *
-
-genfile -l 64 -f file1
-ln file1 file2
-ln file2 file3
-ln file3 file4
-tar -c -f archive --remove-files file1 file2 file3 file4
-tar tfv archive | sed -n 's/.*file[2-4] link to //p'
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'an embedded newline' "link02.at:35"
+( $at_check_trace;
 mkdir oldgnu
 (cd oldgnu
 TEST_TAR_FORMAT=oldgnu
@@ -27853,22 +20516,21 @@ ln file2 file3
 ln file3 file4
 tar -c -f archive --remove-files file1 file2 file3 file4
 tar tfv archive | sed -n 's/.*file[2-4] link to //p'
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "file1
 file1
 file1
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/link02.at:35"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/link02.at:35"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/link02.at:35:
 mkdir ustar
 (cd ustar
@@ -27885,29 +20547,8 @@ ln file3 file4
 tar -c -f archive --remove-files file1 file2 file3 file4
 tar tfv archive | sed -n 's/.*file[2-4] link to //p'
 )"
-echo link02.at:35 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir ustar
-(cd ustar
-TEST_TAR_FORMAT=ustar
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H ustar"
-export TAR_OPTIONS
-rm -rf *
-
-genfile -l 64 -f file1
-ln file1 file2
-ln file2 file3
-ln file3 file4
-tar -c -f archive --remove-files file1 file2 file3 file4
-tar tfv archive | sed -n 's/.*file[2-4] link to //p'
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'an embedded newline' "link02.at:35"
+( $at_check_trace;
 mkdir ustar
 (cd ustar
 TEST_TAR_FORMAT=ustar
@@ -27922,22 +20563,21 @@ ln file2 file3
 ln file3 file4
 tar -c -f archive --remove-files file1 file2 file3 file4
 tar tfv archive | sed -n 's/.*file[2-4] link to //p'
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "file1
 file1
 file1
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/link02.at:35"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/link02.at:35"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/link02.at:35:
 mkdir posix
 (cd posix
@@ -27954,29 +20594,8 @@ ln file3 file4
 tar -c -f archive --remove-files file1 file2 file3 file4
 tar tfv archive | sed -n 's/.*file[2-4] link to //p'
 )"
-echo link02.at:35 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir posix
-(cd posix
-TEST_TAR_FORMAT=posix
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H posix"
-export TAR_OPTIONS
-rm -rf *
-
-genfile -l 64 -f file1
-ln file1 file2
-ln file2 file3
-ln file3 file4
-tar -c -f archive --remove-files file1 file2 file3 file4
-tar tfv archive | sed -n 's/.*file[2-4] link to //p'
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'an embedded newline' "link02.at:35"
+( $at_check_trace;
 mkdir posix
 (cd posix
 TEST_TAR_FORMAT=posix
@@ -27991,22 +20610,21 @@ ln file2 file3
 ln file3 file4
 tar -c -f archive --remove-files file1 file2 file3 file4
 tar tfv archive | sed -n 's/.*file[2-4] link to //p'
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "file1
 file1
 file1
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/link02.at:35"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/link02.at:35"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/link02.at:35:
 mkdir gnu
 (cd gnu
@@ -28023,29 +20641,8 @@ ln file3 file4
 tar -c -f archive --remove-files file1 file2 file3 file4
 tar tfv archive | sed -n 's/.*file[2-4] link to //p'
 )"
-echo link02.at:35 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir gnu
-(cd gnu
-TEST_TAR_FORMAT=gnu
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H gnu"
-export TAR_OPTIONS
-rm -rf *
-
-genfile -l 64 -f file1
-ln file1 file2
-ln file2 file3
-ln file3 file4
-tar -c -f archive --remove-files file1 file2 file3 file4
-tar tfv archive | sed -n 's/.*file[2-4] link to //p'
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'an embedded newline' "link02.at:35"
+( $at_check_trace;
 mkdir gnu
 (cd gnu
 TEST_TAR_FORMAT=gnu
@@ -28060,39 +20657,35 @@ ln file2 file3
 ln file3 file4
 tar -c -f archive --remove-files file1 file2 file3 file4
 tar tfv archive | sed -n 's/.*file[2-4] link to //p'
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "file1
 file1
 file1
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/link02.at:35"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/link02.at:35"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
 
 
 
-  $at_traceoff
+  set +x
   $at_times_p && times >"$at_times_file"
-) 5>&1 2>&1 | eval $at_tee_pipe
-at_status=`cat "$at_status_file"`
+) 5>&1 2>&1 7>&- | eval $at_tee_pipe
+read at_status <"$at_status_file"
 #AT_STOP_71
 #AT_START_72
-# 72. link03.at:24: working -l with --remove-files
-at_setup_line='link03.at:24'
-at_desc="working -l with --remove-files"
-$at_quiet $as_echo_n " 72: $at_desc                 "
+at_fn_group_banner 72 'link03.at:24' \
+  "working -l with --remove-files" "                 "
 at_xfail=no
       test -f $XFAILFILE && at_xfail=yes
-echo "#                             -*- compilation -*-" >> "$at_group_log"
 (
-  $as_echo "72. link03.at:24: testing ..."
+  $as_echo "72. $at_setup_line: testing $at_desc ..."
   $at_traceon
 
 
@@ -28101,7 +20694,7 @@ echo "#                             -*-
 
 
 
-  { $at_traceoff
+  { set +x
 $as_echo "$at_srcdir/link03.at:34:
 mkdir v7
 (cd v7
@@ -28130,41 +20723,8 @@ tar -c -f archive.2 -l --remove-files fi
 echo testing archive.2
 tar tfv archive.2 | sed -n 's/.*file[2-3] link to //p'
 )"
-echo link03.at:34 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir v7
-(cd v7
-TEST_TAR_FORMAT=v7
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H v7"
-export TAR_OPTIONS
-rm -rf *
-
-
-genfile -l 64 -f file1
-ln file1 file2
-ln file2 file3
-ln file3 file4
-
-echo archive.1
-tar -c -f archive.1 -l --remove-files file1 file2 file3 file4
-
-genfile -l 64 -f file1
-ln file1 file2
-ln file2 file3
-ln file3 file4
-
-echo archive.2
-tar -c -f archive.2 -l --remove-files file1 file2 file3
-echo testing archive.2
-tar tfv archive.2 | sed -n 's/.*file[2-3] link to //p'
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'an embedded newline' "link03.at:34"
+( $at_check_trace;
 mkdir v7
 (cd v7
 TEST_TAR_FORMAT=v7
@@ -28191,10 +20751,10 @@ echo archive.2
 tar -c -f archive.2 -l --remove-files file1 file2 file3
 echo testing archive.2
 tar tfv archive.2 | sed -n 's/.*file[2-3] link to //p'
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
 echo >>"$at_stderr"; $as_echo "tar: Missing links to \`file1'.
 " | \
   $at_diff - "$at_stderr" || at_failed=:
@@ -28205,12 +20765,11 @@ file1
 file1
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/link03.at:34"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/link03.at:34"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/link03.at:34:
 mkdir oldgnu
 (cd oldgnu
@@ -28238,42 +20797,9 @@ echo archive.2
 tar -c -f archive.2 -l --remove-files file1 file2 file3
 echo testing archive.2
 tar tfv archive.2 | sed -n 's/.*file[2-3] link to //p'
-)"
-echo link03.at:34 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir oldgnu
-(cd oldgnu
-TEST_TAR_FORMAT=oldgnu
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H oldgnu"
-export TAR_OPTIONS
-rm -rf *
-
-
-genfile -l 64 -f file1
-ln file1 file2
-ln file2 file3
-ln file3 file4
-
-echo archive.1
-tar -c -f archive.1 -l --remove-files file1 file2 file3 file4
-
-genfile -l 64 -f file1
-ln file1 file2
-ln file2 file3
-ln file3 file4
-
-echo archive.2
-tar -c -f archive.2 -l --remove-files file1 file2 file3
-echo testing archive.2
-tar tfv archive.2 | sed -n 's/.*file[2-3] link to //p'
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+)"
+at_fn_check_prepare_notrace 'an embedded newline' "link03.at:34"
+( $at_check_trace;
 mkdir oldgnu
 (cd oldgnu
 TEST_TAR_FORMAT=oldgnu
@@ -28300,10 +20826,10 @@ echo archive.2
 tar -c -f archive.2 -l --remove-files file1 file2 file3
 echo testing archive.2
 tar tfv archive.2 | sed -n 's/.*file[2-3] link to //p'
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
 echo >>"$at_stderr"; $as_echo "tar: Missing links to \`file1'.
 " | \
   $at_diff - "$at_stderr" || at_failed=:
@@ -28314,12 +20840,11 @@ file1
 file1
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/link03.at:34"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/link03.at:34"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/link03.at:34:
 mkdir ustar
 (cd ustar
@@ -28348,41 +20873,8 @@ tar -c -f archive.2 -l --remove-files fi
 echo testing archive.2
 tar tfv archive.2 | sed -n 's/.*file[2-3] link to //p'
 )"
-echo link03.at:34 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir ustar
-(cd ustar
-TEST_TAR_FORMAT=ustar
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H ustar"
-export TAR_OPTIONS
-rm -rf *
-
-
-genfile -l 64 -f file1
-ln file1 file2
-ln file2 file3
-ln file3 file4
-
-echo archive.1
-tar -c -f archive.1 -l --remove-files file1 file2 file3 file4
-
-genfile -l 64 -f file1
-ln file1 file2
-ln file2 file3
-ln file3 file4
-
-echo archive.2
-tar -c -f archive.2 -l --remove-files file1 file2 file3
-echo testing archive.2
-tar tfv archive.2 | sed -n 's/.*file[2-3] link to //p'
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'an embedded newline' "link03.at:34"
+( $at_check_trace;
 mkdir ustar
 (cd ustar
 TEST_TAR_FORMAT=ustar
@@ -28409,10 +20901,10 @@ echo archive.2
 tar -c -f archive.2 -l --remove-files file1 file2 file3
 echo testing archive.2
 tar tfv archive.2 | sed -n 's/.*file[2-3] link to //p'
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
 echo >>"$at_stderr"; $as_echo "tar: Missing links to \`file1'.
 " | \
   $at_diff - "$at_stderr" || at_failed=:
@@ -28423,12 +20915,11 @@ file1
 file1
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/link03.at:34"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/link03.at:34"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/link03.at:34:
 mkdir posix
 (cd posix
@@ -28457,41 +20948,8 @@ tar -c -f archive.2 -l --remove-files fi
 echo testing archive.2
 tar tfv archive.2 | sed -n 's/.*file[2-3] link to //p'
 )"
-echo link03.at:34 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir posix
-(cd posix
-TEST_TAR_FORMAT=posix
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H posix"
-export TAR_OPTIONS
-rm -rf *
-
-
-genfile -l 64 -f file1
-ln file1 file2
-ln file2 file3
-ln file3 file4
-
-echo archive.1
-tar -c -f archive.1 -l --remove-files file1 file2 file3 file4
-
-genfile -l 64 -f file1
-ln file1 file2
-ln file2 file3
-ln file3 file4
-
-echo archive.2
-tar -c -f archive.2 -l --remove-files file1 file2 file3
-echo testing archive.2
-tar tfv archive.2 | sed -n 's/.*file[2-3] link to //p'
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'an embedded newline' "link03.at:34"
+( $at_check_trace;
 mkdir posix
 (cd posix
 TEST_TAR_FORMAT=posix
@@ -28518,10 +20976,10 @@ echo archive.2
 tar -c -f archive.2 -l --remove-files file1 file2 file3
 echo testing archive.2
 tar tfv archive.2 | sed -n 's/.*file[2-3] link to //p'
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
 echo >>"$at_stderr"; $as_echo "tar: Missing links to \`file1'.
 " | \
   $at_diff - "$at_stderr" || at_failed=:
@@ -28532,12 +20990,11 @@ file1
 file1
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/link03.at:34"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/link03.at:34"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/link03.at:34:
 mkdir gnu
 (cd gnu
@@ -28566,41 +21023,8 @@ tar -c -f archive.2 -l --remove-files fi
 echo testing archive.2
 tar tfv archive.2 | sed -n 's/.*file[2-3] link to //p'
 )"
-echo link03.at:34 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir gnu
-(cd gnu
-TEST_TAR_FORMAT=gnu
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H gnu"
-export TAR_OPTIONS
-rm -rf *
-
-
-genfile -l 64 -f file1
-ln file1 file2
-ln file2 file3
-ln file3 file4
-
-echo archive.1
-tar -c -f archive.1 -l --remove-files file1 file2 file3 file4
-
-genfile -l 64 -f file1
-ln file1 file2
-ln file2 file3
-ln file3 file4
-
-echo archive.2
-tar -c -f archive.2 -l --remove-files file1 file2 file3
-echo testing archive.2
-tar tfv archive.2 | sed -n 's/.*file[2-3] link to //p'
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'an embedded newline' "link03.at:34"
+( $at_check_trace;
 mkdir gnu
 (cd gnu
 TEST_TAR_FORMAT=gnu
@@ -28627,10 +21051,10 @@ echo archive.2
 tar -c -f archive.2 -l --remove-files file1 file2 file3
 echo testing archive.2
 tar tfv archive.2 | sed -n 's/.*file[2-3] link to //p'
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
 echo >>"$at_stderr"; $as_echo "tar: Missing links to \`file1'.
 " | \
   $at_diff - "$at_stderr" || at_failed=:
@@ -28641,36 +21065,32 @@ file1
 file1
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/link03.at:34"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/link03.at:34"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
 
 
 
-  $at_traceoff
+  set +x
   $at_times_p && times >"$at_times_file"
-) 5>&1 2>&1 | eval $at_tee_pipe
-at_status=`cat "$at_status_file"`
+) 5>&1 2>&1 7>&- | eval $at_tee_pipe
+read at_status <"$at_status_file"
 #AT_STOP_72
 #AT_START_73
-# 73. link04.at:29: link count is 1 but multiple occurrences
-at_setup_line='link04.at:29'
-at_desc="link count is 1 but multiple occurrences"
-$at_quiet $as_echo_n " 73: $at_desc       "
+at_fn_group_banner 73 'link04.at:29' \
+  "link count is 1 but multiple occurrences" "       "
 at_xfail=no
       test -f $XFAILFILE && at_xfail=yes
-echo "#                             -*- compilation -*-" >> "$at_group_log"
 (
-  $as_echo "73. link04.at:29: testing ..."
+  $as_echo "73. $at_setup_line: testing $at_desc ..."
   $at_traceon
 
 
 
 
 
-  { $at_traceoff
+  { set +x
 $as_echo "$at_srcdir/link04.at:32:
 mkdir v7
 (cd v7
@@ -28698,40 +21118,8 @@ tar tvf archive | sed '
   s,symlink,FOO,g
 ' | sort
 )"
-echo link04.at:32 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir v7
-(cd v7
-TEST_TAR_FORMAT=v7
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H v7"
-export TAR_OPTIONS
-rm -rf *
-
-mkdir dir
-echo TEST > dir/file
-ln -s file dir/symlink || exit 77
-
-tar cf archive dir dir
-tar tvf archive | sed '
-  s,.*[0-9] dir/,dir/,
-' | sort
-
-echo ==
-
-tar chf archive dir
-tar tvf archive | sed '
-  s,.*[0-9] dir/,dir/,
-  s,file,FOO,g
-  s,symlink,FOO,g
-' | sort
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'an embedded newline' "link04.at:32"
+( $at_check_trace;
 mkdir v7
 (cd v7
 TEST_TAR_FORMAT=v7
@@ -28757,11 +21145,11 @@ tar tvf archive | sed '
   s,file,FOO,g
   s,symlink,FOO,g
 ' | sort
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "dir/
 dir/
 dir/file
@@ -28774,12 +21162,11 @@ dir/FOO
 dir/FOO link to dir/FOO
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/link04.at:32"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/link04.at:32"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/link04.at:32:
 mkdir oldgnu
 (cd oldgnu
@@ -28807,40 +21194,8 @@ tar tvf archive | sed '
   s,symlink,FOO,g
 ' | sort
 )"
-echo link04.at:32 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir oldgnu
-(cd oldgnu
-TEST_TAR_FORMAT=oldgnu
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H oldgnu"
-export TAR_OPTIONS
-rm -rf *
-
-mkdir dir
-echo TEST > dir/file
-ln -s file dir/symlink || exit 77
-
-tar cf archive dir dir
-tar tvf archive | sed '
-  s,.*[0-9] dir/,dir/,
-' | sort
-
-echo ==
-
-tar chf archive dir
-tar tvf archive | sed '
-  s,.*[0-9] dir/,dir/,
-  s,file,FOO,g
-  s,symlink,FOO,g
-' | sort
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'an embedded newline' "link04.at:32"
+( $at_check_trace;
 mkdir oldgnu
 (cd oldgnu
 TEST_TAR_FORMAT=oldgnu
@@ -28866,11 +21221,11 @@ tar tvf archive | sed '
   s,file,FOO,g
   s,symlink,FOO,g
 ' | sort
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "dir/
 dir/
 dir/file
@@ -28883,12 +21238,11 @@ dir/FOO
 dir/FOO link to dir/FOO
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/link04.at:32"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/link04.at:32"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/link04.at:32:
 mkdir ustar
 (cd ustar
@@ -28916,40 +21270,8 @@ tar tvf archive | sed '
   s,symlink,FOO,g
 ' | sort
 )"
-echo link04.at:32 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir ustar
-(cd ustar
-TEST_TAR_FORMAT=ustar
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H ustar"
-export TAR_OPTIONS
-rm -rf *
-
-mkdir dir
-echo TEST > dir/file
-ln -s file dir/symlink || exit 77
-
-tar cf archive dir dir
-tar tvf archive | sed '
-  s,.*[0-9] dir/,dir/,
-' | sort
-
-echo ==
-
-tar chf archive dir
-tar tvf archive | sed '
-  s,.*[0-9] dir/,dir/,
-  s,file,FOO,g
-  s,symlink,FOO,g
-' | sort
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'an embedded newline' "link04.at:32"
+( $at_check_trace;
 mkdir ustar
 (cd ustar
 TEST_TAR_FORMAT=ustar
@@ -28975,11 +21297,11 @@ tar tvf archive | sed '
   s,file,FOO,g
   s,symlink,FOO,g
 ' | sort
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "dir/
 dir/
 dir/file
@@ -28992,12 +21314,11 @@ dir/FOO
 dir/FOO link to dir/FOO
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/link04.at:32"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/link04.at:32"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/link04.at:32:
 mkdir posix
 (cd posix
@@ -29025,40 +21346,8 @@ tar tvf archive | sed '
   s,symlink,FOO,g
 ' | sort
 )"
-echo link04.at:32 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir posix
-(cd posix
-TEST_TAR_FORMAT=posix
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H posix"
-export TAR_OPTIONS
-rm -rf *
-
-mkdir dir
-echo TEST > dir/file
-ln -s file dir/symlink || exit 77
-
-tar cf archive dir dir
-tar tvf archive | sed '
-  s,.*[0-9] dir/,dir/,
-' | sort
-
-echo ==
-
-tar chf archive dir
-tar tvf archive | sed '
-  s,.*[0-9] dir/,dir/,
-  s,file,FOO,g
-  s,symlink,FOO,g
-' | sort
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'an embedded newline' "link04.at:32"
+( $at_check_trace;
 mkdir posix
 (cd posix
 TEST_TAR_FORMAT=posix
@@ -29084,11 +21373,11 @@ tar tvf archive | sed '
   s,file,FOO,g
   s,symlink,FOO,g
 ' | sort
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "dir/
 dir/
 dir/file
@@ -29101,12 +21390,11 @@ dir/FOO
 dir/FOO link to dir/FOO
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/link04.at:32"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/link04.at:32"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/link04.at:32:
 mkdir gnu
 (cd gnu
@@ -29134,40 +21422,8 @@ tar tvf archive | sed '
   s,symlink,FOO,g
 ' | sort
 )"
-echo link04.at:32 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir gnu
-(cd gnu
-TEST_TAR_FORMAT=gnu
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H gnu"
-export TAR_OPTIONS
-rm -rf *
-
-mkdir dir
-echo TEST > dir/file
-ln -s file dir/symlink || exit 77
-
-tar cf archive dir dir
-tar tvf archive | sed '
-  s,.*[0-9] dir/,dir/,
-' | sort
-
-echo ==
-
-tar chf archive dir
-tar tvf archive | sed '
-  s,.*[0-9] dir/,dir/,
-  s,file,FOO,g
-  s,symlink,FOO,g
-' | sort
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'an embedded newline' "link04.at:32"
+( $at_check_trace;
 mkdir gnu
 (cd gnu
 TEST_TAR_FORMAT=gnu
@@ -29193,11 +21449,11 @@ tar tvf archive | sed '
   s,file,FOO,g
   s,symlink,FOO,g
 ' | sort
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "dir/
 dir/
 dir/file
@@ -29210,29 +21466,25 @@ dir/FOO
 dir/FOO link to dir/FOO
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/link04.at:32"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/link04.at:32"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
 
 
 
-  $at_traceoff
+  set +x
   $at_times_p && times >"$at_times_file"
-) 5>&1 2>&1 | eval $at_tee_pipe
-at_status=`cat "$at_status_file"`
+) 5>&1 2>&1 7>&- | eval $at_tee_pipe
+read at_status <"$at_status_file"
 #AT_STOP_73
 #AT_START_74
-# 74. longv7.at:24: long names in V7 archives
-at_setup_line='longv7.at:24'
-at_desc="long names in V7 archives"
-$at_quiet $as_echo_n " 74: $at_desc                      "
+at_fn_group_banner 74 'longv7.at:24' \
+  "long names in V7 archives" "                      "
 at_xfail=no
       test -f $XFAILFILE && at_xfail=yes
-echo "#                             -*- compilation -*-" >> "$at_group_log"
 (
-  $as_echo "74. longv7.at:24: testing ..."
+  $as_echo "74. $at_setup_line: testing $at_desc ..."
   $at_traceon
 
 
@@ -29242,33 +21494,13 @@ echo "#                             -*-
 
 
 
-  { $at_traceoff
+  { set +x
 $as_echo "$at_srcdir/longv7.at:30:
 mkdir v7
 (cd v7
 TEST_TAR_FORMAT=v7
 export TEST_TAR_FORMAT
-TAR_OPTIONS=\"-H v7\"
-export TAR_OPTIONS
-rm -rf *
-
-mkdir this_is_a_very_long_name_for_a_directory_which_causes_problems
-touch this_is_a_very_long_name_for_a_directory_which_causes_problems/this_is_a_very_long_file_name_which_raises_issues.c
-
-tar cf archive this_is_a_very_long_name_for_a_directory_which_causes_problems
-echo separator
-tar tf archive
-)"
-echo longv7.at:30 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir v7
-(cd v7
-TEST_TAR_FORMAT=v7
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H v7"
+TAR_OPTIONS=\"-H v7\"
 export TAR_OPTIONS
 rm -rf *
 
@@ -29278,10 +21510,9 @@ touch this_is_a_very_long_name_for_a_dir
 tar cf archive this_is_a_very_long_name_for_a_directory_which_causes_problems
 echo separator
 tar tf archive
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+)"
+at_fn_check_prepare_notrace 'an embedded newline' "longv7.at:30"
+( $at_check_trace;
 mkdir v7
 (cd v7
 TEST_TAR_FORMAT=v7
@@ -29296,10 +21527,10 @@ touch this_is_a_very_long_name_for_a_dir
 tar cf archive this_is_a_very_long_name_for_a_directory_which_causes_problems
 echo separator
 tar tf archive
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
 echo >>"$at_stderr"; $as_echo "tar: this_is_a_very_long_name_for_a_directory_which_causes_problems/this_is_a_very_long_file_name_which_raises_issues.c: file name is too long (max 99); not dumped
 tar: Exiting with failure status due to previous errors
 " | \
@@ -29308,29 +21539,25 @@ echo >>"$at_stdout"; $as_echo "separator
 this_is_a_very_long_name_for_a_directory_which_causes_problems/
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/longv7.at:30"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/longv7.at:30"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
 
 
 
-  $at_traceoff
+  set +x
   $at_times_p && times >"$at_times_file"
-) 5>&1 2>&1 | eval $at_tee_pipe
-at_status=`cat "$at_status_file"`
+) 5>&1 2>&1 7>&- | eval $at_tee_pipe
+read at_status <"$at_status_file"
 #AT_STOP_74
 #AT_START_75
-# 75. long01.at:28: long file names divisible by block size
-at_setup_line='long01.at:28'
-at_desc="long file names divisible by block size"
-$at_quiet $as_echo_n " 75: $at_desc        "
+at_fn_group_banner 75 'long01.at:28' \
+  "long file names divisible by block size" "        "
 at_xfail=no
       test -f $XFAILFILE && at_xfail=yes
-echo "#                             -*- compilation -*-" >> "$at_group_log"
 (
-  $as_echo "75. long01.at:28: testing ..."
+  $as_echo "75. $at_setup_line: testing $at_desc ..."
   $at_traceon
 
 
@@ -29341,7 +21568,7 @@ echo "#                             -*-
 
 
 
-  { $at_traceoff
+  { set +x
 $as_echo "$at_srcdir/long01.at:36:
 mkdir gnu
 (cd gnu
@@ -29357,28 +21584,8 @@ echo test > endfile
 
 tar cf archive 0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde endfile
 tar tf archive)"
-echo long01.at:36 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir gnu
-(cd gnu
-TEST_TAR_FORMAT=gnu
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H gnu"
-export TAR_OPTIONS
-rm -rf *
-
-
-install-sh -d 0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde >/dev/null && genfile --file 0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde || exit 77
-echo test > endfile
-
-tar cf archive 0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde endfile
-tar tf archive) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'an embedded newline' "long01.at:36"
+( $at_check_trace;
 mkdir gnu
 (cd gnu
 TEST_TAR_FORMAT=gnu
@@ -29392,21 +21599,20 @@ install-sh -d 0123456789abcde/0123456789
 echo test > endfile
 
 tar cf archive 0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde endfile
-tar tf archive) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+tar tf archive)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde
 endfile
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/long01.at:36"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/long01.at:36"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/long01.at:36:
 mkdir oldgnu
 (cd oldgnu
@@ -29422,28 +21628,8 @@ echo test > endfile
 
 tar cf archive 0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde endfile
 tar tf archive)"
-echo long01.at:36 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir oldgnu
-(cd oldgnu
-TEST_TAR_FORMAT=oldgnu
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H oldgnu"
-export TAR_OPTIONS
-rm -rf *
-
-
-install-sh -d 0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde >/dev/null && genfile --file 0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde || exit 77
-echo test > endfile
-
-tar cf archive 0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde endfile
-tar tf archive) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'an embedded newline' "long01.at:36"
+( $at_check_trace;
 mkdir oldgnu
 (cd oldgnu
 TEST_TAR_FORMAT=oldgnu
@@ -29457,38 +21643,34 @@ install-sh -d 0123456789abcde/0123456789
 echo test > endfile
 
 tar cf archive 0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde endfile
-tar tf archive) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+tar tf archive)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde/0123456789abcde
 endfile
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/long01.at:36"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/long01.at:36"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
 
 
 
-  $at_traceoff
+  set +x
   $at_times_p && times >"$at_times_file"
-) 5>&1 2>&1 | eval $at_tee_pipe
-at_status=`cat "$at_status_file"`
+) 5>&1 2>&1 7>&- | eval $at_tee_pipe
+read at_status <"$at_status_file"
 #AT_STOP_75
 #AT_START_76
-# 76. lustar01.at:21: ustar: unsplittable file name
-at_setup_line='lustar01.at:21'
-at_desc="ustar: unsplittable file name"
-$at_quiet $as_echo_n " 76: $at_desc                  "
+at_fn_group_banner 76 'lustar01.at:21' \
+  "ustar: unsplittable file name" "                  "
 at_xfail=no
       test -f $XFAILFILE && at_xfail=yes
-echo "#                             -*- compilation -*-" >> "$at_group_log"
 (
-  $as_echo "76. lustar01.at:21: testing ..."
+  $as_echo "76. $at_setup_line: testing $at_desc ..."
   $at_traceon
 
 
@@ -29497,7 +21679,7 @@ echo "#                             -*-
 
 
 
-  { $at_traceoff
+  { set +x
 $as_echo "$at_srcdir/lustar01.at:27:
 mkdir ustar
 (cd ustar
@@ -29510,25 +21692,8 @@ rm -rf *
 genfile --file=this_is_a_very_long_name_for_a_file_designed_to_test_generation_of_ustar_archives_by_gnu_tar_semicolon_it_will_not_fit_the_name_field_and_cannot_be_split_between_name_and_prefix || exit 77
 tar cf archive this_is_a_very_long_name_for_a_file_designed_to_test_generation_of_ustar_archives_by_gnu_tar_semicolon_it_will_not_fit_the_name_field_and_cannot_be_split_between_name_and_prefix
 )"
-echo lustar01.at:27 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir ustar
-(cd ustar
-TEST_TAR_FORMAT=ustar
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H ustar"
-export TAR_OPTIONS
-rm -rf *
-
-genfile --file=this_is_a_very_long_name_for_a_file_designed_to_test_generation_of_ustar_archives_by_gnu_tar_semicolon_it_will_not_fit_the_name_field_and_cannot_be_split_between_name_and_prefix || exit 77
-tar cf archive this_is_a_very_long_name_for_a_file_designed_to_test_generation_of_ustar_archives_by_gnu_tar_semicolon_it_will_not_fit_the_name_field_and_cannot_be_split_between_name_and_prefix
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'an embedded newline' "lustar01.at:27"
+( $at_check_trace;
 mkdir ustar
 (cd ustar
 TEST_TAR_FORMAT=ustar
@@ -29539,38 +21704,34 @@ rm -rf *
 
 genfile --file=this_is_a_very_long_name_for_a_file_designed_to_test_generation_of_ustar_archives_by_gnu_tar_semicolon_it_will_not_fit_the_name_field_and_cannot_be_split_between_name_and_prefix || exit 77
 tar cf archive this_is_a_very_long_name_for_a_file_designed_to_test_generation_of_ustar_archives_by_gnu_tar_semicolon_it_will_not_fit_the_name_field_and_cannot_be_split_between_name_and_prefix
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
 echo >>"$at_stderr"; $as_echo "tar: this_is_a_very_long_name_for_a_file_designed_to_test_generation_of_ustar_archives_by_gnu_tar_semicolon_it_will_not_fit_the_name_field_and_cannot_be_split_between_name_and_prefix: file name is too long (cannot be split); not dumped
 tar: Exiting with failure status due to previous errors
 " | \
   $at_diff - "$at_stderr" || at_failed=:
-at_func_diff_devnull "$at_stdout" || at_failed=:
-at_func_check_status 2 $at_status "$at_srcdir/lustar01.at:27"
-
-$at_failed && at_func_log_failure
+at_fn_diff_devnull "$at_stdout" || at_failed=:
+at_fn_check_status 2 $at_status "$at_srcdir/lustar01.at:27"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
 
 
 
-  $at_traceoff
+  set +x
   $at_times_p && times >"$at_times_file"
-) 5>&1 2>&1 | eval $at_tee_pipe
-at_status=`cat "$at_status_file"`
+) 5>&1 2>&1 7>&- | eval $at_tee_pipe
+read at_status <"$at_status_file"
 #AT_STOP_76
 #AT_START_77
-# 77. lustar02.at:21: ustar: unsplittable path name
-at_setup_line='lustar02.at:21'
-at_desc="ustar: unsplittable path name"
-$at_quiet $as_echo_n " 77: $at_desc                  "
+at_fn_group_banner 77 'lustar02.at:21' \
+  "ustar: unsplittable path name" "                  "
 at_xfail=no
       test -f $XFAILFILE && at_xfail=yes
-echo "#                             -*- compilation -*-" >> "$at_group_log"
 (
-  $as_echo "77. lustar02.at:21: testing ..."
+  $as_echo "77. $at_setup_line: testing $at_desc ..."
   $at_traceon
 
 
@@ -29583,7 +21744,7 @@ echo "#                             -*-
 
 
 
-  { $at_traceoff
+  { set +x
 $as_echo "$at_srcdir/lustar02.at:32:
 mkdir ustar
 (cd ustar
@@ -29597,26 +21758,8 @@ rm -rf *
 install-sh -d this_is_a_very_long_name_for_a_file_designed_to_test_generation_of_ustar_archives_by_gnu_tar_semicolon_it_will_not_fit_the_name_field_and_cannot_be_split_be >/dev/null && genfile --file this_is_a_very_long_name_for_a_file_designed_to_test_generation_of_ustar_archives_by_gnu_tar_semicolon_it_will_not_fit_the_name_field_and_cannot_be_split_be/tween_name_and_prefix || exit 77
 tar cf archive this_is_a_very_long_name_for_a_file_designed_to_test_generation_of_ustar_archives_by_gnu_tar_semicolon_it_will_not_fit_the_name_field_and_cannot_be_split_be
 )"
-echo lustar02.at:32 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir ustar
-(cd ustar
-TEST_TAR_FORMAT=ustar
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H ustar"
-export TAR_OPTIONS
-rm -rf *
-
-
-install-sh -d this_is_a_very_long_name_for_a_file_designed_to_test_generation_of_ustar_archives_by_gnu_tar_semicolon_it_will_not_fit_the_name_field_and_cannot_be_split_be >/dev/null && genfile --file this_is_a_very_long_name_for_a_file_designed_to_test_generation_of_ustar_archives_by_gnu_tar_semicolon_it_will_not_fit_the_name_field_and_cannot_be_split_be/tween_name_and_prefix || exit 77
-tar cf archive this_is_a_very_long_name_for_a_file_designed_to_test_generation_of_ustar_archives_by_gnu_tar_semicolon_it_will_not_fit_the_name_field_and_cannot_be_split_be
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'an embedded newline' "lustar02.at:32"
+( $at_check_trace;
 mkdir ustar
 (cd ustar
 TEST_TAR_FORMAT=ustar
@@ -29628,38 +21771,34 @@ rm -rf *
 
 install-sh -d this_is_a_very_long_name_for_a_file_designed_to_test_generation_of_ustar_archives_by_gnu_tar_semicolon_it_will_not_fit_the_name_field_and_cannot_be_split_be >/dev/null && genfile --file this_is_a_very_long_name_for_a_file_designed_to_test_generation_of_ustar_archives_by_gnu_tar_semicolon_it_will_not_fit_the_name_field_and_cannot_be_split_be/tween_name_and_prefix || exit 77
 tar cf archive this_is_a_very_long_name_for_a_file_designed_to_test_generation_of_ustar_archives_by_gnu_tar_semicolon_it_will_not_fit_the_name_field_and_cannot_be_split_be
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
 echo >>"$at_stderr"; $as_echo "tar: this_is_a_very_long_name_for_a_file_designed_to_test_generation_of_ustar_archives_by_gnu_tar_semicolon_it_will_not_fit_the_name_field_and_cannot_be_split_be/: file name is too long (cannot be split); not dumped
 tar: Exiting with failure status due to previous errors
 " | \
   $at_diff - "$at_stderr" || at_failed=:
-at_func_diff_devnull "$at_stdout" || at_failed=:
-at_func_check_status 2 $at_status "$at_srcdir/lustar02.at:32"
-
-$at_failed && at_func_log_failure
+at_fn_diff_devnull "$at_stdout" || at_failed=:
+at_fn_check_status 2 $at_status "$at_srcdir/lustar02.at:32"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
 
 
 
-  $at_traceoff
+  set +x
   $at_times_p && times >"$at_times_file"
-) 5>&1 2>&1 | eval $at_tee_pipe
-at_status=`cat "$at_status_file"`
+) 5>&1 2>&1 7>&- | eval $at_tee_pipe
+read at_status <"$at_status_file"
 #AT_STOP_77
 #AT_START_78
-# 78. lustar03.at:21: ustar: splitting long names
-at_setup_line='lustar03.at:21'
-at_desc="ustar: splitting long names"
-$at_quiet $as_echo_n " 78: $at_desc                    "
+at_fn_group_banner 78 'lustar03.at:21' \
+  "ustar: splitting long names" "                    "
 at_xfail=no
       test -f $XFAILFILE && at_xfail=yes
-echo "#                             -*- compilation -*-" >> "$at_group_log"
 (
-  $as_echo "78. lustar03.at:21: testing ..."
+  $as_echo "78. $at_setup_line: testing $at_desc ..."
   $at_traceon
 
 
@@ -29670,7 +21809,7 @@ echo "#                             -*-
 
 
 
-  { $at_traceoff
+  { set +x
 $as_echo "$at_srcdir/lustar03.at:29:
 mkdir ustar
 (cd ustar
@@ -29686,28 +21825,8 @@ echo \"Create archive\"
 tar cf archive this_is_a_very_long_name_for_a_file_designed_to_test_generation/of_ustar_archives_by_gnu_tar_semicolon_it_will_not_fit_the_name_field_and_cannot_be_split_be
 echo \"List archive\"
 tar tf archive)"
-echo lustar03.at:29 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir ustar
-(cd ustar
-TEST_TAR_FORMAT=ustar
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H ustar"
-export TAR_OPTIONS
-rm -rf *
-
-
-install-sh -d this_is_a_very_long_name_for_a_file_designed_to_test_generation/of_ustar_archives_by_gnu_tar_semicolon_it_will_not_fit_the_name_field_and_cannot_be_split_be >/dev/null && genfile --file this_is_a_very_long_name_for_a_file_designed_to_test_generation/of_ustar_archives_by_gnu_tar_semicolon_it_will_not_fit_the_name_field_and_cannot_be_split_be/file || exit 77
-echo "Create archive"
-tar cf archive this_is_a_very_long_name_for_a_file_designed_to_test_generation/of_ustar_archives_by_gnu_tar_semicolon_it_will_not_fit_the_name_field_and_cannot_be_split_be
-echo "List archive"
-tar tf archive) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'an embedded newline' "lustar03.at:29"
+( $at_check_trace;
 mkdir ustar
 (cd ustar
 TEST_TAR_FORMAT=ustar
@@ -29721,40 +21840,36 @@ install-sh -d this_is_a_very_long_name_f
 echo "Create archive"
 tar cf archive this_is_a_very_long_name_for_a_file_designed_to_test_generation/of_ustar_archives_by_gnu_tar_semicolon_it_will_not_fit_the_name_field_and_cannot_be_split_be
 echo "List archive"
-tar tf archive) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+tar tf archive)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "Create archive
 List archive
 this_is_a_very_long_name_for_a_file_designed_to_test_generation/of_ustar_archives_by_gnu_tar_semicolon_it_will_not_fit_the_name_field_and_cannot_be_split_be/
 this_is_a_very_long_name_for_a_file_designed_to_test_generation/of_ustar_archives_by_gnu_tar_semicolon_it_will_not_fit_the_name_field_and_cannot_be_split_be/file
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/lustar03.at:29"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/lustar03.at:29"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
 
 
 
-  $at_traceoff
+  set +x
   $at_times_p && times >"$at_times_file"
-) 5>&1 2>&1 | eval $at_tee_pipe
-at_status=`cat "$at_status_file"`
+) 5>&1 2>&1 7>&- | eval $at_tee_pipe
+read at_status <"$at_status_file"
 #AT_STOP_78
 #AT_START_79
-# 79. multiv01.at:23: multivolume dumps from pipes
-at_setup_line='multiv01.at:23'
-at_desc="multivolume dumps from pipes"
-$at_quiet $as_echo_n " 79: $at_desc                   "
+at_fn_group_banner 79 'multiv01.at:23' \
+  "multivolume dumps from pipes" "                   "
 at_xfail=no
       test -f $XFAILFILE && at_xfail=yes
-echo "#                             -*- compilation -*-" >> "$at_group_log"
 (
-  $as_echo "79. multiv01.at:23: testing ..."
+  $as_echo "79. $at_setup_line: testing $at_desc ..."
   $at_traceon
 
 
@@ -29765,7 +21880,7 @@ echo "#                             -*-
 
 
 
-  { $at_traceoff
+  { set +x
 $as_echo "$at_srcdir/multiv01.at:30:
 mkdir gnu
 (cd gnu
@@ -29804,51 +21919,8 @@ PATH=\$PATH \${TRUSS} tar -f t1-pipe.tar
 cmp file1 extract-dir-pipe/file1
 cmp file2 extract-dir-pipe/file2
 )"
-echo multiv01.at:30 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains a ${...} parameter expansion)'
-   false; }; then
-  ( $at_traceon;
-mkdir gnu
-(cd gnu
-TEST_TAR_FORMAT=gnu
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H gnu"
-export TAR_OPTIONS
-rm -rf *
-
-exec <&-
-genfile --length 7168 --file file1
-
-for block in " 1" " 2" " 3" " 4" " 5" " 6" " 7" " 8" \
-              " 9" "10" "11" "12" "13" "14" "15" "16" ; do \
-  echo "file2  block ${block} bla!bla!bla!bla!bla!bla!bla!bla!bla!bla!bla!bla"
-  for count in 2 3 4 5 6 7 8 ; do
-    echo "bla!bla!bla!bla!bla!bla!bla!bla!bla!bla!bla!bla!bla!bla!bla!bla"
-  done
-done >file2
-
-if test $TEST_TAR_FORMAT = pax; then
-  TAPE_LENGTH=11
-else
-  TAPE_LENGTH=10
-fi
-
-tar -c --multi-volume --tape-length=$TAPE_LENGTH \
-  -f t1-pipe.tar -f t2-pipe.tar ./file1 ./file2 || exit 1
-
-mkdir extract-dir-pipe
-dd bs=4096 count=$TAPE_LENGTH if=t2-pipe.tar 2>/dev/null |
-PATH=$PATH ${TRUSS} tar -f t1-pipe.tar -f - \
-      -C extract-dir-pipe -x --multi-volume --warning=no-timestamp \
-      --tape-length=$TAPE_LENGTH --read-full-records || exit 1
-
-cmp file1 extract-dir-pipe/file1
-cmp file2 extract-dir-pipe/file2
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'a ${...} parameter expansion' "multiv01.at:30"
+( $at_check_trace;
 mkdir gnu
 (cd gnu
 TEST_TAR_FORMAT=gnu
@@ -29885,18 +21957,17 @@ PATH=$PATH ${TRUSS} tar -f t1-pipe.tar -
 
 cmp file1 extract-dir-pipe/file1
 cmp file2 extract-dir-pipe/file2
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
-at_func_diff_devnull "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/multiv01.at:30"
-
-$at_failed && at_func_log_failure
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
+at_fn_diff_devnull "$at_stdout" || at_failed=:
+at_fn_check_status 0 $at_status "$at_srcdir/multiv01.at:30"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/multiv01.at:30:
 mkdir oldgnu
 (cd oldgnu
@@ -29935,51 +22006,8 @@ PATH=\$PATH \${TRUSS} tar -f t1-pipe.tar
 cmp file1 extract-dir-pipe/file1
 cmp file2 extract-dir-pipe/file2
 )"
-echo multiv01.at:30 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains a ${...} parameter expansion)'
-   false; }; then
-  ( $at_traceon;
-mkdir oldgnu
-(cd oldgnu
-TEST_TAR_FORMAT=oldgnu
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H oldgnu"
-export TAR_OPTIONS
-rm -rf *
-
-exec <&-
-genfile --length 7168 --file file1
-
-for block in " 1" " 2" " 3" " 4" " 5" " 6" " 7" " 8" \
-              " 9" "10" "11" "12" "13" "14" "15" "16" ; do \
-  echo "file2  block ${block} bla!bla!bla!bla!bla!bla!bla!bla!bla!bla!bla!bla"
-  for count in 2 3 4 5 6 7 8 ; do
-    echo "bla!bla!bla!bla!bla!bla!bla!bla!bla!bla!bla!bla!bla!bla!bla!bla"
-  done
-done >file2
-
-if test $TEST_TAR_FORMAT = pax; then
-  TAPE_LENGTH=11
-else
-  TAPE_LENGTH=10
-fi
-
-tar -c --multi-volume --tape-length=$TAPE_LENGTH \
-  -f t1-pipe.tar -f t2-pipe.tar ./file1 ./file2 || exit 1
-
-mkdir extract-dir-pipe
-dd bs=4096 count=$TAPE_LENGTH if=t2-pipe.tar 2>/dev/null |
-PATH=$PATH ${TRUSS} tar -f t1-pipe.tar -f - \
-      -C extract-dir-pipe -x --multi-volume --warning=no-timestamp \
-      --tape-length=$TAPE_LENGTH --read-full-records || exit 1
-
-cmp file1 extract-dir-pipe/file1
-cmp file2 extract-dir-pipe/file2
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'a ${...} parameter expansion' "multiv01.at:30"
+( $at_check_trace;
 mkdir oldgnu
 (cd oldgnu
 TEST_TAR_FORMAT=oldgnu
@@ -30016,18 +22044,17 @@ PATH=$PATH ${TRUSS} tar -f t1-pipe.tar -
 
 cmp file1 extract-dir-pipe/file1
 cmp file2 extract-dir-pipe/file2
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
-at_func_diff_devnull "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/multiv01.at:30"
-
-$at_failed && at_func_log_failure
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
+at_fn_diff_devnull "$at_stdout" || at_failed=:
+at_fn_check_status 0 $at_status "$at_srcdir/multiv01.at:30"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/multiv01.at:30:
 mkdir pax
 (cd pax
@@ -30066,51 +22093,8 @@ PATH=\$PATH \${TRUSS} tar -f t1-pipe.tar
 cmp file1 extract-dir-pipe/file1
 cmp file2 extract-dir-pipe/file2
 )"
-echo multiv01.at:30 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains a ${...} parameter expansion)'
-   false; }; then
-  ( $at_traceon;
-mkdir pax
-(cd pax
-TEST_TAR_FORMAT=pax
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H pax"
-export TAR_OPTIONS
-rm -rf *
-
-exec <&-
-genfile --length 7168 --file file1
-
-for block in " 1" " 2" " 3" " 4" " 5" " 6" " 7" " 8" \
-              " 9" "10" "11" "12" "13" "14" "15" "16" ; do \
-  echo "file2  block ${block} bla!bla!bla!bla!bla!bla!bla!bla!bla!bla!bla!bla"
-  for count in 2 3 4 5 6 7 8 ; do
-    echo "bla!bla!bla!bla!bla!bla!bla!bla!bla!bla!bla!bla!bla!bla!bla!bla"
-  done
-done >file2
-
-if test $TEST_TAR_FORMAT = pax; then
-  TAPE_LENGTH=11
-else
-  TAPE_LENGTH=10
-fi
-
-tar -c --multi-volume --tape-length=$TAPE_LENGTH \
-  -f t1-pipe.tar -f t2-pipe.tar ./file1 ./file2 || exit 1
-
-mkdir extract-dir-pipe
-dd bs=4096 count=$TAPE_LENGTH if=t2-pipe.tar 2>/dev/null |
-PATH=$PATH ${TRUSS} tar -f t1-pipe.tar -f - \
-      -C extract-dir-pipe -x --multi-volume --warning=no-timestamp \
-      --tape-length=$TAPE_LENGTH --read-full-records || exit 1
-
-cmp file1 extract-dir-pipe/file1
-cmp file2 extract-dir-pipe/file2
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'a ${...} parameter expansion' "multiv01.at:30"
+( $at_check_trace;
 mkdir pax
 (cd pax
 TEST_TAR_FORMAT=pax
@@ -30147,42 +22131,38 @@ PATH=$PATH ${TRUSS} tar -f t1-pipe.tar -
 
 cmp file1 extract-dir-pipe/file1
 cmp file2 extract-dir-pipe/file2
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
-at_func_diff_devnull "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/multiv01.at:30"
-
-$at_failed && at_func_log_failure
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
+at_fn_diff_devnull "$at_stdout" || at_failed=:
+at_fn_check_status 0 $at_status "$at_srcdir/multiv01.at:30"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
 
 
 
-  $at_traceoff
+  set +x
   $at_times_p && times >"$at_times_file"
-) 5>&1 2>&1 | eval $at_tee_pipe
-at_status=`cat "$at_status_file"`
+) 5>&1 2>&1 7>&- | eval $at_tee_pipe
+read at_status <"$at_status_file"
 #AT_STOP_79
 #AT_START_80
-# 80. multiv02.at:28: skipping a straddling member
-at_setup_line='multiv02.at:28'
-at_desc="skipping a straddling member"
-$at_quiet $as_echo_n " 80: $at_desc                   "
+at_fn_group_banner 80 'multiv02.at:28' \
+  "skipping a straddling member" "                   "
 at_xfail=no
       test -f $XFAILFILE && at_xfail=yes
-echo "#                             -*- compilation -*-" >> "$at_group_log"
 (
-  $as_echo "80. multiv02.at:28: testing ..."
+  $as_echo "80. $at_setup_line: testing $at_desc ..."
   $at_traceon
 
 
 
 
 
-  { $at_traceoff
+  { set +x
 $as_echo "$at_srcdir/multiv02.at:31:
 mkdir gnu
 (cd gnu
@@ -30202,73 +22182,14 @@ exec <&-
 tar -c -f A.tar -f B.tar -f C.tar -M -L 30 en to tre fire || exit 1
 echo separator
 tar -v -x -f A.tar -f B.tar -f C.tar -M en --warning=no-timestamp || exit 1
-)"
-echo multiv02.at:31 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir gnu
-(cd gnu
-TEST_TAR_FORMAT=gnu
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H gnu"
-export TAR_OPTIONS
-rm -rf *
-
-genfile --length 10240 --file en
-genfile --length 20000 --file to
-genfile --length 20000 --file tre
-genfile --length 10240 --file fire
-
-exec <&-
-
-tar -c -f A.tar -f B.tar -f C.tar -M -L 30 en to tre fire || exit 1
-echo separator
-tar -v -x -f A.tar -f B.tar -f C.tar -M en --warning=no-timestamp || exit 1
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
-mkdir gnu
-(cd gnu
-TEST_TAR_FORMAT=gnu
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H gnu"
-export TAR_OPTIONS
-rm -rf *
-
-genfile --length 10240 --file en
-genfile --length 20000 --file to
-genfile --length 20000 --file tre
-genfile --length 10240 --file fire
-
-exec <&-
-
-tar -c -f A.tar -f B.tar -f C.tar -M -L 30 en to tre fire || exit 1
-echo separator
-tar -v -x -f A.tar -f B.tar -f C.tar -M en --warning=no-timestamp || exit 1
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
-echo >>"$at_stdout"; $as_echo "separator
-en
-" | \
-  $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/multiv02.at:31"
-
-$at_failed && at_func_log_failure
-$at_traceon; }
-
-              { $at_traceoff
-$as_echo "$at_srcdir/multiv02.at:31:
-mkdir oldgnu
-(cd oldgnu
-TEST_TAR_FORMAT=oldgnu
+)"
+at_fn_check_prepare_notrace 'an embedded newline' "multiv02.at:31"
+( $at_check_trace;
+mkdir gnu
+(cd gnu
+TEST_TAR_FORMAT=gnu
 export TEST_TAR_FORMAT
-TAR_OPTIONS=\"-H oldgnu\"
+TAR_OPTIONS="-H gnu"
 export TAR_OPTIONS
 rm -rf *
 
@@ -30282,17 +22203,26 @@ exec <&-
 tar -c -f A.tar -f B.tar -f C.tar -M -L 30 en to tre fire || exit 1
 echo separator
 tar -v -x -f A.tar -f B.tar -f C.tar -M en --warning=no-timestamp || exit 1
-)"
-echo multiv02.at:31 >"$at_check_line_file"
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
+echo >>"$at_stdout"; $as_echo "separator
+en
+" | \
+  $at_diff - "$at_stdout" || at_failed=:
+at_fn_check_status 0 $at_status "$at_srcdir/multiv02.at:31"
+$at_failed && at_fn_log_failure
+$at_traceon; }
 
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
+              { set +x
+$as_echo "$at_srcdir/multiv02.at:31:
 mkdir oldgnu
 (cd oldgnu
 TEST_TAR_FORMAT=oldgnu
 export TEST_TAR_FORMAT
-TAR_OPTIONS="-H oldgnu"
+TAR_OPTIONS=\"-H oldgnu\"
 export TAR_OPTIONS
 rm -rf *
 
@@ -30306,10 +22236,9 @@ exec <&-
 tar -c -f A.tar -f B.tar -f C.tar -M -L 30 en to tre fire || exit 1
 echo separator
 tar -v -x -f A.tar -f B.tar -f C.tar -M en --warning=no-timestamp || exit 1
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+)"
+at_fn_check_prepare_notrace 'an embedded newline' "multiv02.at:31"
+( $at_check_trace;
 mkdir oldgnu
 (cd oldgnu
 TEST_TAR_FORMAT=oldgnu
@@ -30328,21 +22257,20 @@ exec <&-
 tar -c -f A.tar -f B.tar -f C.tar -M -L 30 en to tre fire || exit 1
 echo separator
 tar -v -x -f A.tar -f B.tar -f C.tar -M en --warning=no-timestamp || exit 1
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "separator
 en
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/multiv02.at:31"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/multiv02.at:31"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/multiv02.at:31:
 mkdir pax
 (cd pax
@@ -30363,33 +22291,8 @@ tar -c -f A.tar -f B.tar -f C.tar -M -L
 echo separator
 tar -v -x -f A.tar -f B.tar -f C.tar -M en --warning=no-timestamp || exit 1
 )"
-echo multiv02.at:31 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir pax
-(cd pax
-TEST_TAR_FORMAT=pax
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H pax"
-export TAR_OPTIONS
-rm -rf *
-
-genfile --length 10240 --file en
-genfile --length 20000 --file to
-genfile --length 20000 --file tre
-genfile --length 10240 --file fire
-
-exec <&-
-
-tar -c -f A.tar -f B.tar -f C.tar -M -L 30 en to tre fire || exit 1
-echo separator
-tar -v -x -f A.tar -f B.tar -f C.tar -M en --warning=no-timestamp || exit 1
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'an embedded newline' "multiv02.at:31"
+( $at_check_trace;
 mkdir pax
 (cd pax
 TEST_TAR_FORMAT=pax
@@ -30408,45 +22311,41 @@ exec <&-
 tar -c -f A.tar -f B.tar -f C.tar -M -L 30 en to tre fire || exit 1
 echo separator
 tar -v -x -f A.tar -f B.tar -f C.tar -M en --warning=no-timestamp || exit 1
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "separator
 en
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/multiv02.at:31"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/multiv02.at:31"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
 
 
 
-  $at_traceoff
+  set +x
   $at_times_p && times >"$at_times_file"
-) 5>&1 2>&1 | eval $at_tee_pipe
-at_status=`cat "$at_status_file"`
+) 5>&1 2>&1 7>&- | eval $at_tee_pipe
+read at_status <"$at_status_file"
 #AT_STOP_80
 #AT_START_81
-# 81. multiv03.at:30: MV archive & long filenames
-at_setup_line='multiv03.at:30'
-at_desc="MV archive & long filenames"
-$at_quiet $as_echo_n " 81: $at_desc                    "
+at_fn_group_banner 81 'multiv03.at:30' \
+  "MV archive & long filenames" "                    "
 at_xfail=no
       test -f $XFAILFILE && at_xfail=yes
-echo "#                             -*- compilation -*-" >> "$at_group_log"
 (
-  $as_echo "81. multiv03.at:30: testing ..."
+  $as_echo "81. $at_setup_line: testing $at_desc ..."
   $at_traceon
 
 
 
 
 
-  { $at_traceoff
+  { set +x
 $as_echo "$at_srcdir/multiv03.at:33:
 mkdir gnu
 (cd gnu
@@ -30487,53 +22386,8 @@ mv \$BFILE bfile
 tar -M -x -f arch.1 -f arch.2 --warning=no-timestamp || exit 1
 cmp \$BFILE bfile
 )"
-echo multiv03.at:33 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains a `...` command substitution)'
-   false; }; then
-  ( $at_traceon;
-mkdir gnu
-(cd gnu
-TEST_TAR_FORMAT=gnu
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H gnu"
-export TAR_OPTIONS
-rm -rf *
-
-AFILE=`awk 'BEGIN { for (i = 0; i < 100; i++) printf "a"; exit; }'`
-BFILE=`awk 'BEGIN { for (i = 0; i < 101; i++) printf "b"; exit; }'`
-
-cat > ../experr <<EOF
-tar: $BFILE: file name too long to be stored in a GNU multivolume header, truncated
-tar: \`$BFILE' is possibly continued on this volume: header contains truncated name
-EOF
-
-cat > ../expout <<EOF
-$AFILE
-separator-1
-separator-2
-EOF
-
-genfile --length 15360 --file $AFILE
-
-exec <&-
-
-tar -M -L 10 -c -f arch.1 -f arch.2 $AFILE || exit 1
-tar -tM -f arch.1 -f arch.2 || exit 1
-
-echo separator-1
-
-genfile --length 15360 --file $BFILE
-tar -M -L 10 -c -f arch.1 -f arch.2 $BFILE || exit 1
-
-echo separator-2
-mv $BFILE bfile
-tar -M -x -f arch.1 -f arch.2 --warning=no-timestamp || exit 1
-cmp $BFILE bfile
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'a `...` command substitution' "multiv03.at:33"
+( $at_check_trace;
 mkdir gnu
 (cd gnu
 TEST_TAR_FORMAT=gnu
@@ -30572,18 +22426,17 @@ echo separator-2
 mv $BFILE bfile
 tar -M -x -f arch.1 -f arch.2 --warning=no-timestamp || exit 1
 cmp $BFILE bfile
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
 $at_diff experr "$at_stderr" || at_failed=:
 $at_diff expout "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/multiv03.at:33"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/multiv03.at:33"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/multiv03.at:33:
 mkdir oldgnu
 (cd oldgnu
@@ -30624,53 +22477,8 @@ mv \$BFILE bfile
 tar -M -x -f arch.1 -f arch.2 --warning=no-timestamp || exit 1
 cmp \$BFILE bfile
 )"
-echo multiv03.at:33 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains a `...` command substitution)'
-   false; }; then
-  ( $at_traceon;
-mkdir oldgnu
-(cd oldgnu
-TEST_TAR_FORMAT=oldgnu
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H oldgnu"
-export TAR_OPTIONS
-rm -rf *
-
-AFILE=`awk 'BEGIN { for (i = 0; i < 100; i++) printf "a"; exit; }'`
-BFILE=`awk 'BEGIN { for (i = 0; i < 101; i++) printf "b"; exit; }'`
-
-cat > ../experr <<EOF
-tar: $BFILE: file name too long to be stored in a GNU multivolume header, truncated
-tar: \`$BFILE' is possibly continued on this volume: header contains truncated name
-EOF
-
-cat > ../expout <<EOF
-$AFILE
-separator-1
-separator-2
-EOF
-
-genfile --length 15360 --file $AFILE
-
-exec <&-
-
-tar -M -L 10 -c -f arch.1 -f arch.2 $AFILE || exit 1
-tar -tM -f arch.1 -f arch.2 || exit 1
-
-echo separator-1
-
-genfile --length 15360 --file $BFILE
-tar -M -L 10 -c -f arch.1 -f arch.2 $BFILE || exit 1
-
-echo separator-2
-mv $BFILE bfile
-tar -M -x -f arch.1 -f arch.2 --warning=no-timestamp || exit 1
-cmp $BFILE bfile
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'a `...` command substitution' "multiv03.at:33"
+( $at_check_trace;
 mkdir oldgnu
 (cd oldgnu
 TEST_TAR_FORMAT=oldgnu
@@ -30709,42 +22517,38 @@ echo separator-2
 mv $BFILE bfile
 tar -M -x -f arch.1 -f arch.2 --warning=no-timestamp || exit 1
 cmp $BFILE bfile
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
 $at_diff experr "$at_stderr" || at_failed=:
 $at_diff expout "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/multiv03.at:33"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/multiv03.at:33"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
 
 
 
-  $at_traceoff
+  set +x
   $at_times_p && times >"$at_times_file"
-) 5>&1 2>&1 | eval $at_tee_pipe
-at_status=`cat "$at_status_file"`
+) 5>&1 2>&1 7>&- | eval $at_tee_pipe
+read at_status <"$at_status_file"
 #AT_STOP_81
 #AT_START_82
-# 82. multiv04.at:36: split directory members in a MV archive
-at_setup_line='multiv04.at:36'
-at_desc="split directory members in a MV archive"
-$at_quiet $as_echo_n " 82: $at_desc        "
+at_fn_group_banner 82 'multiv04.at:36' \
+  "split directory members in a MV archive" "        "
 at_xfail=no
       test -f $XFAILFILE && at_xfail=yes
-echo "#                             -*- compilation -*-" >> "$at_group_log"
 (
-  $as_echo "82. multiv04.at:36: testing ..."
+  $as_echo "82. $at_setup_line: testing $at_desc ..."
   $at_traceon
 
 
 
 
 
-  { $at_traceoff
+  { set +x
 $as_echo "$at_srcdir/multiv04.at:39:
 mkdir gnu
 (cd gnu
@@ -30771,39 +22575,8 @@ tar --listed-incremental=list -c --recor
 echo separator
 
 tar -MRt -f arc.1 -f arc.2)"
-echo multiv04.at:39 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir gnu
-(cd gnu
-TEST_TAR_FORMAT=gnu
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H gnu"
-export TAR_OPTIONS
-rm -rf *
-
-
-mkdir directory
-awk 'BEGIN { for (i = 0; i < 1024; i++) printf("directory/%014x\n", i); }' </dev/null | genfile --files-from -
-
-exec <&-
-
-sleep 2
-
-tar --listed-incremental=list -c -f archive.a directory
-
-sleep 2
-
-tar --listed-incremental=list -c --record-size 1024 -L 16 -f arc.1 -f arc.2 -v directory
-
-echo separator
-
-tar -MRt -f arc.1 -f arc.2) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'an embedded newline' "multiv04.at:39"
+( $at_check_trace;
 mkdir gnu
 (cd gnu
 TEST_TAR_FORMAT=gnu
@@ -30828,23 +22601,22 @@ tar --listed-incremental=list -c --recor
 
 echo separator
 
-tar -MRt -f arc.1 -f arc.2) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+tar -MRt -f arc.1 -f arc.2)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "directory/
 separator
 block 0: directory/
 block 35: ** Block of NULs **
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/multiv04.at:39"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/multiv04.at:39"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/multiv04.at:39:
 mkdir oldgnu
 (cd oldgnu
@@ -30871,39 +22643,8 @@ tar --listed-incremental=list -c --recor
 echo separator
 
 tar -MRt -f arc.1 -f arc.2)"
-echo multiv04.at:39 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir oldgnu
-(cd oldgnu
-TEST_TAR_FORMAT=oldgnu
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H oldgnu"
-export TAR_OPTIONS
-rm -rf *
-
-
-mkdir directory
-awk 'BEGIN { for (i = 0; i < 1024; i++) printf("directory/%014x\n", i); }' </dev/null | genfile --files-from -
-
-exec <&-
-
-sleep 2
-
-tar --listed-incremental=list -c -f archive.a directory
-
-sleep 2
-
-tar --listed-incremental=list -c --record-size 1024 -L 16 -f arc.1 -f arc.2 -v directory
-
-echo separator
-
-tar -MRt -f arc.1 -f arc.2) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'an embedded newline' "multiv04.at:39"
+( $at_check_trace;
 mkdir oldgnu
 (cd oldgnu
 TEST_TAR_FORMAT=oldgnu
@@ -30928,40 +22669,36 @@ tar --listed-incremental=list -c --recor
 
 echo separator
 
-tar -MRt -f arc.1 -f arc.2) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+tar -MRt -f arc.1 -f arc.2)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "directory/
 separator
 block 0: directory/
 block 35: ** Block of NULs **
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/multiv04.at:39"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/multiv04.at:39"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
 
 
 
-  $at_traceoff
+  set +x
   $at_times_p && times >"$at_times_file"
-) 5>&1 2>&1 | eval $at_tee_pipe
-at_status=`cat "$at_status_file"`
+) 5>&1 2>&1 7>&- | eval $at_tee_pipe
+read at_status <"$at_status_file"
 #AT_STOP_82
 #AT_START_83
-# 83. multiv05.at:26: Restoring after an out of sync volume
-at_setup_line='multiv05.at:26'
-at_desc="Restoring after an out of sync volume"
-$at_quiet $as_echo_n " 83: $at_desc          "
+at_fn_group_banner 83 'multiv05.at:26' \
+  "Restoring after an out of sync volume" "          "
 at_xfail=no
       test -f $XFAILFILE && at_xfail=yes
-echo "#                             -*- compilation -*-" >> "$at_group_log"
 (
-  $as_echo "83. multiv05.at:26: testing ..."
+  $as_echo "83. $at_setup_line: testing $at_desc ..."
   $at_traceon
 
 
@@ -30969,7 +22706,7 @@ echo "#                             -*-
 
 
 
-  { $at_traceoff
+  { set +x
 $as_echo "$at_srcdir/multiv05.at:30:
 mkdir gnu
 (cd gnu
@@ -31008,51 +22745,8 @@ echo Diffing piec
 echo Diffing szesc
    cmp bak/szesc szesc || exit 1
 )"
-echo multiv05.at:30 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir gnu
-(cd gnu
-TEST_TAR_FORMAT=gnu
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H gnu"
-export TAR_OPTIONS
-rm -rf *
-
-exec <&-
-
-genfile --length 250k --file jeden
-genfile --length 250k --file dwa
-genfile --length 250k --file trzy
-genfile --length 250k --file cztery
-genfile --length 250k --file piec
-genfile --length 250k --file szesc
-
-
-echo Creating archive
-tar -c -M -L 502 -f a.tar -f b.tar -f c.tar jeden dwa trzy cztery piec szesc
-echo separator
-mkdir bak
-mv jeden dwa trzy cztery piec szesc bak
-tar -vxM -f a.tar -f c.tar -f b.tar -f c.tar
-echo Diffing jeden
-   cmp bak/jeden jeden || exit 1
-echo Diffing dwa
-   cmp bak/dwa dwa || exit 1
-echo Diffing trzy
-   cmp bak/trzy trzy || exit 1
-echo Diffing cztery
-   cmp bak/cztery cztery || exit 1
-echo Diffing piec
-   cmp bak/piec piec || exit 1
-echo Diffing szesc
-   cmp bak/szesc szesc || exit 1
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'an embedded newline' "multiv05.at:30"
+( $at_check_trace;
 mkdir gnu
 (cd gnu
 TEST_TAR_FORMAT=gnu
@@ -31089,10 +22783,10 @@ echo Diffing piec
    cmp bak/piec piec || exit 1
 echo Diffing szesc
    cmp bak/szesc szesc || exit 1
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
 echo >>"$at_stderr"; $as_echo "tar: \`trzy' is not continued on this volume
 " | \
   $at_diff - "$at_stderr" || at_failed=:
@@ -31112,36 +22806,32 @@ Diffing piec
 Diffing szesc
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/multiv05.at:30"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/multiv05.at:30"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
 
 
 
-  $at_traceoff
+  set +x
   $at_times_p && times >"$at_times_file"
-) 5>&1 2>&1 | eval $at_tee_pipe
-at_status=`cat "$at_status_file"`
+) 5>&1 2>&1 7>&- | eval $at_tee_pipe
+read at_status <"$at_status_file"
 #AT_STOP_83
 #AT_START_84
-# 84. multiv06.at:27: Multivolumes with L=record_size
-at_setup_line='multiv06.at:27'
-at_desc="Multivolumes with L=record_size"
-$at_quiet $as_echo_n " 84: $at_desc                "
+at_fn_group_banner 84 'multiv06.at:27' \
+  "Multivolumes with L=record_size" "                "
 at_xfail=no
       test -f $XFAILFILE && at_xfail=yes
-echo "#                             -*- compilation -*-" >> "$at_group_log"
 (
-  $as_echo "84. multiv06.at:27: testing ..."
+  $as_echo "84. $at_setup_line: testing $at_desc ..."
   $at_traceon
 
 
 
 
 
-  { $at_traceoff
+  { set +x
 $as_echo "$at_srcdir/multiv06.at:30:
 mkdir gnu
 (cd gnu
@@ -31158,29 +22848,8 @@ decho Creating archive
 tar -c -M -L10 -b20 -farc.1 -farc.2 -farc.3 file
 decho Testing archive
 tar -t -M -farc.1 -farc.2 -farc.3)"
-echo multiv06.at:30 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir gnu
-(cd gnu
-TEST_TAR_FORMAT=gnu
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H gnu"
-export TAR_OPTIONS
-rm -rf *
-
-exec <&-
-decho Creating file
-genfile --length 20139 --file file
-decho Creating archive
-tar -c -M -L10 -b20 -farc.1 -farc.2 -farc.3 file
-decho Testing archive
-tar -t -M -farc.1 -farc.2 -farc.3) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'an embedded newline' "multiv06.at:30"
+( $at_check_trace;
 mkdir gnu
 (cd gnu
 TEST_TAR_FORMAT=gnu
@@ -31195,10 +22864,10 @@ genfile --length 20139 --file file
 decho Creating archive
 tar -c -M -L10 -b20 -farc.1 -farc.2 -farc.3 file
 decho Testing archive
-tar -t -M -farc.1 -farc.2 -farc.3) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
+tar -t -M -farc.1 -farc.2 -farc.3)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
 echo >>"$at_stderr"; $as_echo "Creating file
 Creating archive
 Testing archive
@@ -31210,12 +22879,11 @@ Testing archive
 file
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/multiv06.at:30"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/multiv06.at:30"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/multiv06.at:30:
 mkdir pax
 (cd pax
@@ -31231,30 +22899,9 @@ genfile --length 20139 --file file
 decho Creating archive
 tar -c -M -L10 -b20 -farc.1 -farc.2 -farc.3 file
 decho Testing archive
-tar -t -M -farc.1 -farc.2 -farc.3)"
-echo multiv06.at:30 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir pax
-(cd pax
-TEST_TAR_FORMAT=pax
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H pax"
-export TAR_OPTIONS
-rm -rf *
-
-exec <&-
-decho Creating file
-genfile --length 20139 --file file
-decho Creating archive
-tar -c -M -L10 -b20 -farc.1 -farc.2 -farc.3 file
-decho Testing archive
-tar -t -M -farc.1 -farc.2 -farc.3) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+tar -t -M -farc.1 -farc.2 -farc.3)"
+at_fn_check_prepare_notrace 'an embedded newline' "multiv06.at:30"
+( $at_check_trace;
 mkdir pax
 (cd pax
 TEST_TAR_FORMAT=pax
@@ -31269,10 +22916,10 @@ genfile --length 20139 --file file
 decho Creating archive
 tar -c -M -L10 -b20 -farc.1 -farc.2 -farc.3 file
 decho Testing archive
-tar -t -M -farc.1 -farc.2 -farc.3) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
+tar -t -M -farc.1 -farc.2 -farc.3)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
 echo >>"$at_stderr"; $as_echo "Creating file
 Creating archive
 Testing archive
@@ -31284,55 +22931,46 @@ Testing archive
 file
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/multiv06.at:30"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/multiv06.at:30"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
 
 
 
-  $at_traceoff
+  set +x
   $at_times_p && times >"$at_times_file"
-) 5>&1 2>&1 | eval $at_tee_pipe
-at_status=`cat "$at_status_file"`
+) 5>&1 2>&1 7>&- | eval $at_tee_pipe
+read at_status <"$at_status_file"
 #AT_STOP_84
 #AT_START_85
-# 85. multiv07.at:26: volumes split at an extended header
-at_setup_line='multiv07.at:26'
-at_desc="volumes split at an extended header"
-$at_quiet $as_echo_n " 85: $at_desc            "
+at_fn_group_banner 85 'multiv07.at:26' \
+  "volumes split at an extended header" "            "
 at_xfail=no
-      test -f \$XFAILFILE && at_xfail=yes
-      test -f $XFAILFILE && at_xfail=yes
       test -f $XFAILFILE && at_xfail=yes
-echo "#                             -*- compilation -*-" >> "$at_group_log"
 (
-  $as_echo "85. multiv07.at:26: testing ..."
+  $as_echo "85. $at_setup_line: testing $at_desc ..."
   $at_traceon
 
 
 
-{ $at_traceoff
+{ set +x
 $as_echo "$at_srcdir/multiv07.at:29:
 
 
-test -z "$TEST_DATA_DIR" && exit 77
-tarball_prereq xsplit-1.tar 0e008c84c517e48fbf23ca6a7033cde6 $TEST_DATA_DIR $TEST_DATA_URL || exit 77
+test -z \"\$TEST_DATA_DIR\" && exit 77
+tarball_prereq xsplit-1.tar 0e008c84c517e48fbf23ca6a7033cde6 \$TEST_DATA_DIR \$TEST_DATA_URL || exit 77
 
-test -z "$TEST_DATA_DIR" && exit 77
-tarball_prereq xsplit-2.tar 03150b9852d285458f43734e9e0b9a45 $TEST_DATA_DIR $TEST_DATA_URL || exit 77
+test -z \"\$TEST_DATA_DIR\" && exit 77
+tarball_prereq xsplit-2.tar 03150b9852d285458f43734e9e0b9a45 \$TEST_DATA_DIR \$TEST_DATA_URL || exit 77
 
 exec <&-
 
 cd \$TEST_DATA_DIR
 tar -t -M -fxsplit-1.tar -fxsplit-2.tar
 "
-echo multiv07.at:29 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
+at_fn_check_prepare_notrace 'an embedded newline' "multiv07.at:29"
+( $at_check_trace;
 
 
 test -z "$TEST_DATA_DIR" && exit 77
@@ -31345,60 +22983,40 @@ exec <&-
 
 cd $TEST_DATA_DIR
 tar -t -M -fxsplit-1.tar -fxsplit-2.tar
- ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
-
-
-test -z "$TEST_DATA_DIR" && exit 77
-tarball_prereq xsplit-1.tar 0e008c84c517e48fbf23ca6a7033cde6 $TEST_DATA_DIR $TEST_DATA_URL || exit 77
-
-test -z "$TEST_DATA_DIR" && exit 77
-tarball_prereq xsplit-2.tar 03150b9852d285458f43734e9e0b9a45 $TEST_DATA_DIR $TEST_DATA_URL || exit 77
-
-exec <&-
 
-cd $TEST_DATA_DIR
-tar -t -M -fxsplit-1.tar -fxsplit-2.tar
- ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "Archive volumes split at an extended header Volume 1
 foo
 bar
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/multiv07.at:29"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/multiv07.at:29"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
 
-  $at_traceoff
+  set +x
   $at_times_p && times >"$at_times_file"
-) 5>&1 2>&1 | eval $at_tee_pipe
-at_status=`cat "$at_status_file"`
+) 5>&1 2>&1 7>&- | eval $at_tee_pipe
+read at_status <"$at_status_file"
 #AT_STOP_85
 #AT_START_86
-# 86. multiv08.at:23: multivolume header creation
-at_setup_line='multiv08.at:23'
-at_desc="multivolume header creation"
-$at_quiet $as_echo_n " 86: $at_desc                    "
+at_fn_group_banner 86 'multiv08.at:23' \
+  "multivolume header creation" "                    "
 at_xfail=no
       test -f $XFAILFILE && at_xfail=yes
-echo "#                             -*- compilation -*-" >> "$at_group_log"
 (
-  $as_echo "86. multiv08.at:23: testing ..."
+  $as_echo "86. $at_setup_line: testing $at_desc ..."
   $at_traceon
 
 
 
 
 
-  { $at_traceoff
+  { set +x
 $as_echo "$at_srcdir/multiv08.at:26:
 mkdir gnu
 (cd gnu
@@ -31415,29 +23033,8 @@ tar -c -M -L10 -f A.tar -f B.tar -f C.ta
 decho Testing
 tar -tMR -f A.tar -f B.tar -f C.tar
 )"
-echo multiv08.at:26 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir gnu
-(cd gnu
-TEST_TAR_FORMAT=gnu
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H gnu"
-export TAR_OPTIONS
-rm -rf *
-
-genfile --length 9472 --file a
-genfile --length 9984 --file b
-decho Creating
-tar -c -M -L10 -f A.tar -f B.tar -f C.tar a b
-decho Testing
-tar -tMR -f A.tar -f B.tar -f C.tar
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'an embedded newline' "multiv08.at:26"
+( $at_check_trace;
 mkdir gnu
 (cd gnu
 TEST_TAR_FORMAT=gnu
@@ -31452,10 +23049,10 @@ decho Creating
 tar -c -M -L10 -f A.tar -f B.tar -f C.tar a b
 decho Testing
 tar -tMR -f A.tar -f B.tar -f C.tar
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
 echo >>"$at_stderr"; $as_echo "Creating
 Testing
 " | \
@@ -31467,91 +23064,73 @@ block 21: b
 block 43: ** Block of NULs **
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/multiv08.at:26"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/multiv08.at:26"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
 
 
 
-  $at_traceoff
+  set +x
   $at_times_p && times >"$at_times_file"
-) 5>&1 2>&1 | eval $at_tee_pipe
-at_status=`cat "$at_status_file"`
+) 5>&1 2>&1 7>&- | eval $at_tee_pipe
+read at_status <"$at_status_file"
 #AT_STOP_86
 #AT_START_87
-# 87. old.at:23: old archives
-at_setup_line='old.at:23'
-at_desc="old archives"
-$at_quiet $as_echo_n " 87: $at_desc                                   "
+at_fn_group_banner 87 'old.at:23' \
+  "old archives" "                                   "
 at_xfail=no
-echo "#                             -*- compilation -*-" >> "$at_group_log"
 (
-  $as_echo "87. old.at:23: testing ..."
+  $as_echo "87. $at_setup_line: testing $at_desc ..."
   $at_traceon
 
 
 
 unset TAR_OPTIONS
-{ $at_traceoff
+{ set +x
 $as_echo "$at_srcdir/old.at:27:
 mkdir directory
 tar cfvo archive directory || exit 1
 tar tf archive
 "
-echo old.at:27 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir directory
-tar cfvo archive directory || exit 1
-tar tf archive
- ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'an embedded newline' "old.at:27"
+( $at_check_trace;
 mkdir directory
 tar cfvo archive directory || exit 1
 tar tf archive
- ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "directory/
 directory/
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/old.at:27"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/old.at:27"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
 
-  $at_traceoff
+  set +x
   $at_times_p && times >"$at_times_file"
-) 5>&1 2>&1 | eval $at_tee_pipe
-at_status=`cat "$at_status_file"`
+) 5>&1 2>&1 7>&- | eval $at_tee_pipe
+read at_status <"$at_status_file"
 #AT_STOP_87
 #AT_START_88
-# 88. recurse.at:21: recurse
-at_setup_line='recurse.at:21'
-at_desc="recurse"
-$at_quiet $as_echo_n " 88: $at_desc                                        "
+at_fn_group_banner 88 'recurse.at:21' \
+  "recurse" "                                        "
 at_xfail=no
       test -f $XFAILFILE && at_xfail=yes
-echo "#                             -*- compilation -*-" >> "$at_group_log"
 (
-  $as_echo "88. recurse.at:21: testing ..."
+  $as_echo "88. $at_setup_line: testing $at_desc ..."
   $at_traceon
 
 
 
 
 
-  { $at_traceoff
+  { set +x
 $as_echo "$at_srcdir/recurse.at:24:
 mkdir v7
 (cd v7
@@ -31566,27 +23145,8 @@ touch directory/file
 tar --create --file archive --no-recursion directory || exit 1
 tar tf archive
 )"
-echo recurse.at:24 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir v7
-(cd v7
-TEST_TAR_FORMAT=v7
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H v7"
-export TAR_OPTIONS
-rm -rf *
-
-mkdir directory
-touch directory/file
-tar --create --file archive --no-recursion directory || exit 1
-tar tf archive
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'an embedded newline' "recurse.at:24"
+( $at_check_trace;
 mkdir v7
 (cd v7
 TEST_TAR_FORMAT=v7
@@ -31599,20 +23159,19 @@ mkdir directory
 touch directory/file
 tar --create --file archive --no-recursion directory || exit 1
 tar tf archive
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "directory/
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/recurse.at:24"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/recurse.at:24"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/recurse.at:24:
 mkdir oldgnu
 (cd oldgnu
@@ -31627,27 +23186,8 @@ touch directory/file
 tar --create --file archive --no-recursion directory || exit 1
 tar tf archive
 )"
-echo recurse.at:24 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir oldgnu
-(cd oldgnu
-TEST_TAR_FORMAT=oldgnu
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H oldgnu"
-export TAR_OPTIONS
-rm -rf *
-
-mkdir directory
-touch directory/file
-tar --create --file archive --no-recursion directory || exit 1
-tar tf archive
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'an embedded newline' "recurse.at:24"
+( $at_check_trace;
 mkdir oldgnu
 (cd oldgnu
 TEST_TAR_FORMAT=oldgnu
@@ -31660,20 +23200,19 @@ mkdir directory
 touch directory/file
 tar --create --file archive --no-recursion directory || exit 1
 tar tf archive
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "directory/
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/recurse.at:24"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/recurse.at:24"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/recurse.at:24:
 mkdir ustar
 (cd ustar
@@ -31688,27 +23227,8 @@ touch directory/file
 tar --create --file archive --no-recursion directory || exit 1
 tar tf archive
 )"
-echo recurse.at:24 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir ustar
-(cd ustar
-TEST_TAR_FORMAT=ustar
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H ustar"
-export TAR_OPTIONS
-rm -rf *
-
-mkdir directory
-touch directory/file
-tar --create --file archive --no-recursion directory || exit 1
-tar tf archive
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'an embedded newline' "recurse.at:24"
+( $at_check_trace;
 mkdir ustar
 (cd ustar
 TEST_TAR_FORMAT=ustar
@@ -31721,20 +23241,19 @@ mkdir directory
 touch directory/file
 tar --create --file archive --no-recursion directory || exit 1
 tar tf archive
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "directory/
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/recurse.at:24"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/recurse.at:24"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/recurse.at:24:
 mkdir posix
 (cd posix
@@ -31749,27 +23268,8 @@ touch directory/file
 tar --create --file archive --no-recursion directory || exit 1
 tar tf archive
 )"
-echo recurse.at:24 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir posix
-(cd posix
-TEST_TAR_FORMAT=posix
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H posix"
-export TAR_OPTIONS
-rm -rf *
-
-mkdir directory
-touch directory/file
-tar --create --file archive --no-recursion directory || exit 1
-tar tf archive
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'an embedded newline' "recurse.at:24"
+( $at_check_trace;
 mkdir posix
 (cd posix
 TEST_TAR_FORMAT=posix
@@ -31782,20 +23282,19 @@ mkdir directory
 touch directory/file
 tar --create --file archive --no-recursion directory || exit 1
 tar tf archive
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "directory/
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/recurse.at:24"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/recurse.at:24"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/recurse.at:24:
 mkdir gnu
 (cd gnu
@@ -31810,27 +23309,8 @@ touch directory/file
 tar --create --file archive --no-recursion directory || exit 1
 tar tf archive
 )"
-echo recurse.at:24 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir gnu
-(cd gnu
-TEST_TAR_FORMAT=gnu
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H gnu"
-export TAR_OPTIONS
-rm -rf *
-
-mkdir directory
-touch directory/file
-tar --create --file archive --no-recursion directory || exit 1
-tar tf archive
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'an embedded newline' "recurse.at:24"
+( $at_check_trace;
 mkdir gnu
 (cd gnu
 TEST_TAR_FORMAT=gnu
@@ -31843,44 +23323,40 @@ mkdir directory
 touch directory/file
 tar --create --file archive --no-recursion directory || exit 1
 tar tf archive
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "directory/
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/recurse.at:24"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/recurse.at:24"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
 
 
 
-  $at_traceoff
+  set +x
   $at_times_p && times >"$at_times_file"
-) 5>&1 2>&1 | eval $at_tee_pipe
-at_status=`cat "$at_status_file"`
+) 5>&1 2>&1 7>&- | eval $at_tee_pipe
+read at_status <"$at_status_file"
 #AT_STOP_88
 #AT_START_89
-# 89. same-order01.at:26: working -C with --same-order
-at_setup_line='same-order01.at:26'
-at_desc="working -C with --same-order"
-$at_quiet $as_echo_n " 89: $at_desc                   "
+at_fn_group_banner 89 'same-order01.at:26' \
+  "working -C with --same-order" "                   "
 at_xfail=no
       test -f $XFAILFILE && at_xfail=yes
-echo "#                             -*- compilation -*-" >> "$at_group_log"
 (
-  $as_echo "89. same-order01.at:26: testing ..."
+  $as_echo "89. $at_setup_line: testing $at_desc ..."
   $at_traceon
 
 
 
 
 
-  { $at_traceoff
+  { set +x
 $as_echo "$at_srcdir/same-order01.at:29:
 mkdir v7
 (cd v7
@@ -31891,7 +23367,7 @@ export TAR_OPTIONS
 rm -rf *
 
 
-test -z "`sort < /dev/null 2>&1`" || exit 77
+test -z \"\`sort < /dev/null 2>&1\`\" || exit 77
 
 
 genfile -l 1024 -f file1
@@ -31903,35 +23379,8 @@ tar -xf archive --same-order -C director
 
 ls directory|sort
 )"
-echo same-order01.at:29 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir v7
-(cd v7
-TEST_TAR_FORMAT=v7
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H v7"
-export TAR_OPTIONS
-rm -rf *
-
-
-test -z "`sort < /dev/null 2>&1`" || exit 77
-
-
-genfile -l 1024 -f file1
-genfile -l 1024 -f file2
-tar cf archive file1 file2
-
-mkdir directory
-tar -xf archive --same-order -C directory --warning=no-timestamp || exit 1
-
-ls directory|sort
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'a `...` command substitution' "same-order01.at:29"
+( $at_check_trace;
 mkdir v7
 (cd v7
 TEST_TAR_FORMAT=v7
@@ -31952,21 +23401,20 @@ mkdir directory
 tar -xf archive --same-order -C directory --warning=no-timestamp || exit 1
 
 ls directory|sort
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "file1
 file2
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/same-order01.at:29"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/same-order01.at:29"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/same-order01.at:29:
 mkdir oldgnu
 (cd oldgnu
@@ -31977,7 +23425,7 @@ export TAR_OPTIONS
 rm -rf *
 
 
-test -z "`sort < /dev/null 2>&1`" || exit 77
+test -z \"\`sort < /dev/null 2>&1\`\" || exit 77
 
 
 genfile -l 1024 -f file1
@@ -31989,35 +23437,8 @@ tar -xf archive --same-order -C director
 
 ls directory|sort
 )"
-echo same-order01.at:29 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir oldgnu
-(cd oldgnu
-TEST_TAR_FORMAT=oldgnu
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H oldgnu"
-export TAR_OPTIONS
-rm -rf *
-
-
-test -z "`sort < /dev/null 2>&1`" || exit 77
-
-
-genfile -l 1024 -f file1
-genfile -l 1024 -f file2
-tar cf archive file1 file2
-
-mkdir directory
-tar -xf archive --same-order -C directory --warning=no-timestamp || exit 1
-
-ls directory|sort
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'a `...` command substitution' "same-order01.at:29"
+( $at_check_trace;
 mkdir oldgnu
 (cd oldgnu
 TEST_TAR_FORMAT=oldgnu
@@ -32038,21 +23459,20 @@ mkdir directory
 tar -xf archive --same-order -C directory --warning=no-timestamp || exit 1
 
 ls directory|sort
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "file1
 file2
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/same-order01.at:29"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/same-order01.at:29"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/same-order01.at:29:
 mkdir ustar
 (cd ustar
@@ -32063,7 +23483,7 @@ export TAR_OPTIONS
 rm -rf *
 
 
-test -z "`sort < /dev/null 2>&1`" || exit 77
+test -z \"\`sort < /dev/null 2>&1\`\" || exit 77
 
 
 genfile -l 1024 -f file1
@@ -32075,35 +23495,8 @@ tar -xf archive --same-order -C director
 
 ls directory|sort
 )"
-echo same-order01.at:29 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir ustar
-(cd ustar
-TEST_TAR_FORMAT=ustar
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H ustar"
-export TAR_OPTIONS
-rm -rf *
-
-
-test -z "`sort < /dev/null 2>&1`" || exit 77
-
-
-genfile -l 1024 -f file1
-genfile -l 1024 -f file2
-tar cf archive file1 file2
-
-mkdir directory
-tar -xf archive --same-order -C directory --warning=no-timestamp || exit 1
-
-ls directory|sort
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'a `...` command substitution' "same-order01.at:29"
+( $at_check_trace;
 mkdir ustar
 (cd ustar
 TEST_TAR_FORMAT=ustar
@@ -32124,21 +23517,20 @@ mkdir directory
 tar -xf archive --same-order -C directory --warning=no-timestamp || exit 1
 
 ls directory|sort
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "file1
 file2
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/same-order01.at:29"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/same-order01.at:29"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/same-order01.at:29:
 mkdir posix
 (cd posix
@@ -32149,7 +23541,7 @@ export TAR_OPTIONS
 rm -rf *
 
 
-test -z "`sort < /dev/null 2>&1`" || exit 77
+test -z \"\`sort < /dev/null 2>&1\`\" || exit 77
 
 
 genfile -l 1024 -f file1
@@ -32161,76 +23553,13 @@ tar -xf archive --same-order -C director
 
 ls directory|sort
 )"
-echo same-order01.at:29 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir posix
-(cd posix
-TEST_TAR_FORMAT=posix
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H posix"
-export TAR_OPTIONS
-rm -rf *
-
-
-test -z "`sort < /dev/null 2>&1`" || exit 77
-
-
-genfile -l 1024 -f file1
-genfile -l 1024 -f file2
-tar cf archive file1 file2
-
-mkdir directory
-tar -xf archive --same-order -C directory --warning=no-timestamp || exit 1
-
-ls directory|sort
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'a `...` command substitution' "same-order01.at:29"
+( $at_check_trace;
 mkdir posix
 (cd posix
 TEST_TAR_FORMAT=posix
 export TEST_TAR_FORMAT
-TAR_OPTIONS="-H posix"
-export TAR_OPTIONS
-rm -rf *
-
-
-test -z "`sort < /dev/null 2>&1`" || exit 77
-
-
-genfile -l 1024 -f file1
-genfile -l 1024 -f file2
-tar cf archive file1 file2
-
-mkdir directory
-tar -xf archive --same-order -C directory --warning=no-timestamp || exit 1
-
-ls directory|sort
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
-echo >>"$at_stdout"; $as_echo "file1
-file2
-" | \
-  $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/same-order01.at:29"
-
-$at_failed && at_func_log_failure
-$at_traceon; }
-
-              { $at_traceoff
-$as_echo "$at_srcdir/same-order01.at:29:
-mkdir gnu
-(cd gnu
-TEST_TAR_FORMAT=gnu
-export TEST_TAR_FORMAT
-TAR_OPTIONS=\"-H gnu\"
+TAR_OPTIONS="-H posix"
 export TAR_OPTIONS
 rm -rf *
 
@@ -32246,22 +23575,31 @@ mkdir directory
 tar -xf archive --same-order -C directory --warning=no-timestamp || exit 1
 
 ls directory|sort
-)"
-echo same-order01.at:29 >"$at_check_line_file"
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
+echo >>"$at_stdout"; $as_echo "file1
+file2
+" | \
+  $at_diff - "$at_stdout" || at_failed=:
+at_fn_check_status 0 $at_status "$at_srcdir/same-order01.at:29"
+$at_failed && at_fn_log_failure
+$at_traceon; }
 
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
+              { set +x
+$as_echo "$at_srcdir/same-order01.at:29:
 mkdir gnu
 (cd gnu
 TEST_TAR_FORMAT=gnu
 export TEST_TAR_FORMAT
-TAR_OPTIONS="-H gnu"
+TAR_OPTIONS=\"-H gnu\"
 export TAR_OPTIONS
 rm -rf *
 
 
-test -z "`sort < /dev/null 2>&1`" || exit 77
+test -z \"\`sort < /dev/null 2>&1\`\" || exit 77
 
 
 genfile -l 1024 -f file1
@@ -32272,10 +23610,9 @@ mkdir directory
 tar -xf archive --same-order -C directory --warning=no-timestamp || exit 1
 
 ls directory|sort
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+)"
+at_fn_check_prepare_notrace 'a `...` command substitution' "same-order01.at:29"
+( $at_check_trace;
 mkdir gnu
 (cd gnu
 TEST_TAR_FORMAT=gnu
@@ -32296,45 +23633,41 @@ mkdir directory
 tar -xf archive --same-order -C directory --warning=no-timestamp || exit 1
 
 ls directory|sort
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "file1
 file2
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/same-order01.at:29"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/same-order01.at:29"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
 
 
 
-  $at_traceoff
+  set +x
   $at_times_p && times >"$at_times_file"
-) 5>&1 2>&1 | eval $at_tee_pipe
-at_status=`cat "$at_status_file"`
+) 5>&1 2>&1 7>&- | eval $at_tee_pipe
+read at_status <"$at_status_file"
 #AT_STOP_89
 #AT_START_90
-# 90. same-order02.at:25: multiple -C options
-at_setup_line='same-order02.at:25'
-at_desc="multiple -C options"
-$at_quiet $as_echo_n " 90: $at_desc                            "
+at_fn_group_banner 90 'same-order02.at:25' \
+  "multiple -C options" "                            "
 at_xfail=no
       test -f $XFAILFILE && at_xfail=yes
-echo "#                             -*- compilation -*-" >> "$at_group_log"
 (
-  $as_echo "90. same-order02.at:25: testing ..."
+  $as_echo "90. $at_setup_line: testing $at_desc ..."
   $at_traceon
 
 
 
 
 
-  { $at_traceoff
+  { set +x
 $as_echo "$at_srcdir/same-order02.at:28:
 mkdir v7
 (cd v7
@@ -32360,38 +23693,8 @@ ls en
 echo separator
 ls to
 )"
-echo same-order02.at:28 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains a `...` command substitution)'
-   false; }; then
-  ( $at_traceon;
-mkdir v7
-(cd v7
-TEST_TAR_FORMAT=v7
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H v7"
-export TAR_OPTIONS
-rm -rf *
-
-genfile -l 1024 -f file1
-genfile -l 1024 -f file2
-tar cf archive file1 file2
-
-mkdir en
-mkdir to
-
-HERE=`pwd`
-tar -xf archive --same-order --warning=no-timestamp \
-  -C $HERE/en file1 \
-  -C $HERE/to file2 || exit 1
-
-ls en
-echo separator
-ls to
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'a `...` command substitution' "same-order02.at:28"
+( $at_check_trace;
 mkdir v7
 (cd v7
 TEST_TAR_FORMAT=v7
@@ -32415,22 +23718,21 @@ tar -xf archive --same-order --warning=n
 ls en
 echo separator
 ls to
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "file1
 separator
 file2
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/same-order02.at:28"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/same-order02.at:28"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/same-order02.at:28:
 mkdir oldgnu
 (cd oldgnu
@@ -32456,38 +23758,8 @@ ls en
 echo separator
 ls to
 )"
-echo same-order02.at:28 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains a `...` command substitution)'
-   false; }; then
-  ( $at_traceon;
-mkdir oldgnu
-(cd oldgnu
-TEST_TAR_FORMAT=oldgnu
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H oldgnu"
-export TAR_OPTIONS
-rm -rf *
-
-genfile -l 1024 -f file1
-genfile -l 1024 -f file2
-tar cf archive file1 file2
-
-mkdir en
-mkdir to
-
-HERE=`pwd`
-tar -xf archive --same-order --warning=no-timestamp \
-  -C $HERE/en file1 \
-  -C $HERE/to file2 || exit 1
-
-ls en
-echo separator
-ls to
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'a `...` command substitution' "same-order02.at:28"
+( $at_check_trace;
 mkdir oldgnu
 (cd oldgnu
 TEST_TAR_FORMAT=oldgnu
@@ -32511,22 +23783,21 @@ tar -xf archive --same-order --warning=n
 ls en
 echo separator
 ls to
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "file1
 separator
 file2
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/same-order02.at:28"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/same-order02.at:28"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/same-order02.at:28:
 mkdir ustar
 (cd ustar
@@ -32552,38 +23823,8 @@ ls en
 echo separator
 ls to
 )"
-echo same-order02.at:28 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains a `...` command substitution)'
-   false; }; then
-  ( $at_traceon;
-mkdir ustar
-(cd ustar
-TEST_TAR_FORMAT=ustar
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H ustar"
-export TAR_OPTIONS
-rm -rf *
-
-genfile -l 1024 -f file1
-genfile -l 1024 -f file2
-tar cf archive file1 file2
-
-mkdir en
-mkdir to
-
-HERE=`pwd`
-tar -xf archive --same-order --warning=no-timestamp \
-  -C $HERE/en file1 \
-  -C $HERE/to file2 || exit 1
-
-ls en
-echo separator
-ls to
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'a `...` command substitution' "same-order02.at:28"
+( $at_check_trace;
 mkdir ustar
 (cd ustar
 TEST_TAR_FORMAT=ustar
@@ -32607,22 +23848,21 @@ tar -xf archive --same-order --warning=n
 ls en
 echo separator
 ls to
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "file1
 separator
 file2
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/same-order02.at:28"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/same-order02.at:28"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/same-order02.at:28:
 mkdir posix
 (cd posix
@@ -32648,38 +23888,8 @@ ls en
 echo separator
 ls to
 )"
-echo same-order02.at:28 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains a `...` command substitution)'
-   false; }; then
-  ( $at_traceon;
-mkdir posix
-(cd posix
-TEST_TAR_FORMAT=posix
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H posix"
-export TAR_OPTIONS
-rm -rf *
-
-genfile -l 1024 -f file1
-genfile -l 1024 -f file2
-tar cf archive file1 file2
-
-mkdir en
-mkdir to
-
-HERE=`pwd`
-tar -xf archive --same-order --warning=no-timestamp \
-  -C $HERE/en file1 \
-  -C $HERE/to file2 || exit 1
-
-ls en
-echo separator
-ls to
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'a `...` command substitution' "same-order02.at:28"
+( $at_check_trace;
 mkdir posix
 (cd posix
 TEST_TAR_FORMAT=posix
@@ -32703,22 +23913,21 @@ tar -xf archive --same-order --warning=n
 ls en
 echo separator
 ls to
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "file1
 separator
 file2
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/same-order02.at:28"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/same-order02.at:28"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/same-order02.at:28:
 mkdir gnu
 (cd gnu
@@ -32744,38 +23953,8 @@ ls en
 echo separator
 ls to
 )"
-echo same-order02.at:28 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains a `...` command substitution)'
-   false; }; then
-  ( $at_traceon;
-mkdir gnu
-(cd gnu
-TEST_TAR_FORMAT=gnu
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H gnu"
-export TAR_OPTIONS
-rm -rf *
-
-genfile -l 1024 -f file1
-genfile -l 1024 -f file2
-tar cf archive file1 file2
-
-mkdir en
-mkdir to
-
-HERE=`pwd`
-tar -xf archive --same-order --warning=no-timestamp \
-  -C $HERE/en file1 \
-  -C $HERE/to file2 || exit 1
-
-ls en
-echo separator
-ls to
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'a `...` command substitution' "same-order02.at:28"
+( $at_check_trace;
 mkdir gnu
 (cd gnu
 TEST_TAR_FORMAT=gnu
@@ -32799,46 +23978,42 @@ tar -xf archive --same-order --warning=n
 ls en
 echo separator
 ls to
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "file1
 separator
 file2
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/same-order02.at:28"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/same-order02.at:28"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
 
 
 
-  $at_traceoff
+  set +x
   $at_times_p && times >"$at_times_file"
-) 5>&1 2>&1 | eval $at_tee_pipe
-at_status=`cat "$at_status_file"`
+) 5>&1 2>&1 7>&- | eval $at_tee_pipe
+read at_status <"$at_status_file"
 #AT_STOP_90
 #AT_START_91
-# 91. shortrec.at:25: short records
-at_setup_line='shortrec.at:25'
-at_desc="short records"
-$at_quiet $as_echo_n " 91: $at_desc                                  "
+at_fn_group_banner 91 'shortrec.at:25' \
+  "short records" "                                  "
 at_xfail=no
       test -f $XFAILFILE && at_xfail=yes
-echo "#                             -*- compilation -*-" >> "$at_group_log"
 (
-  $as_echo "91. shortrec.at:25: testing ..."
+  $as_echo "91. $at_setup_line: testing $at_desc ..."
   $at_traceon
 
 
 
 
 
-  { $at_traceoff
+  { set +x
 $as_echo "$at_srcdir/shortrec.at:28:
 mkdir v7
 (cd v7
@@ -32857,31 +24032,8 @@ tar -t -f - < archive > /dev/null
 
 rm -r directory
 )"
-echo shortrec.at:28 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir v7
-(cd v7
-TEST_TAR_FORMAT=v7
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H v7"
-export TAR_OPTIONS
-rm -rf *
-
-mkdir directory
-(cd directory && touch a b c d e f g h i j k l m n o p q r)
-tar -c -b 1 -f - directory | tar -t -f - > /dev/null
-tar -c -b 1 -f archive directory
-tar -t -f archive > /dev/null
-tar -t -f - < archive > /dev/null
-
-rm -r directory
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'an embedded newline' "shortrec.at:28"
+( $at_check_trace;
 mkdir v7
 (cd v7
 TEST_TAR_FORMAT=v7
@@ -32898,18 +24050,17 @@ tar -t -f archive > /dev/null
 tar -t -f - < archive > /dev/null
 
 rm -r directory
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
-at_func_diff_devnull "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/shortrec.at:28"
-
-$at_failed && at_func_log_failure
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
+at_fn_diff_devnull "$at_stdout" || at_failed=:
+at_fn_check_status 0 $at_status "$at_srcdir/shortrec.at:28"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/shortrec.at:28:
 mkdir oldgnu
 (cd oldgnu
@@ -32928,31 +24079,8 @@ tar -t -f - < archive > /dev/null
 
 rm -r directory
 )"
-echo shortrec.at:28 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir oldgnu
-(cd oldgnu
-TEST_TAR_FORMAT=oldgnu
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H oldgnu"
-export TAR_OPTIONS
-rm -rf *
-
-mkdir directory
-(cd directory && touch a b c d e f g h i j k l m n o p q r)
-tar -c -b 1 -f - directory | tar -t -f - > /dev/null
-tar -c -b 1 -f archive directory
-tar -t -f archive > /dev/null
-tar -t -f - < archive > /dev/null
-
-rm -r directory
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'an embedded newline' "shortrec.at:28"
+( $at_check_trace;
 mkdir oldgnu
 (cd oldgnu
 TEST_TAR_FORMAT=oldgnu
@@ -32969,18 +24097,17 @@ tar -t -f archive > /dev/null
 tar -t -f - < archive > /dev/null
 
 rm -r directory
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
-at_func_diff_devnull "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/shortrec.at:28"
-
-$at_failed && at_func_log_failure
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
+at_fn_diff_devnull "$at_stdout" || at_failed=:
+at_fn_check_status 0 $at_status "$at_srcdir/shortrec.at:28"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/shortrec.at:28:
 mkdir ustar
 (cd ustar
@@ -32999,11 +24126,8 @@ tar -t -f - < archive > /dev/null
 
 rm -r directory
 )"
-echo shortrec.at:28 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
+at_fn_check_prepare_notrace 'an embedded newline' "shortrec.at:28"
+( $at_check_trace;
 mkdir ustar
 (cd ustar
 TEST_TAR_FORMAT=ustar
@@ -33020,38 +24144,17 @@ tar -t -f archive > /dev/null
 tar -t -f - < archive > /dev/null
 
 rm -r directory
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
-mkdir ustar
-(cd ustar
-TEST_TAR_FORMAT=ustar
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H ustar"
-export TAR_OPTIONS
-rm -rf *
-
-mkdir directory
-(cd directory && touch a b c d e f g h i j k l m n o p q r)
-tar -c -b 1 -f - directory | tar -t -f - > /dev/null
-tar -c -b 1 -f archive directory
-tar -t -f archive > /dev/null
-tar -t -f - < archive > /dev/null
-
-rm -r directory
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
-at_func_diff_devnull "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/shortrec.at:28"
-
-$at_failed && at_func_log_failure
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
+at_fn_diff_devnull "$at_stdout" || at_failed=:
+at_fn_check_status 0 $at_status "$at_srcdir/shortrec.at:28"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/shortrec.at:28:
 mkdir posix
 (cd posix
@@ -33067,68 +24170,16 @@ tar -c -b 1 -f - directory | tar -t -f -
 tar -c -b 1 -f archive directory
 tar -t -f archive > /dev/null
 tar -t -f - < archive > /dev/null
-
-rm -r directory
-)"
-echo shortrec.at:28 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir posix
-(cd posix
-TEST_TAR_FORMAT=posix
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H posix"
-export TAR_OPTIONS
-rm -rf *
-
-mkdir directory
-(cd directory && touch a b c d e f g h i j k l m n o p q r)
-tar -c -b 1 -f - directory | tar -t -f - > /dev/null
-tar -c -b 1 -f archive directory
-tar -t -f archive > /dev/null
-tar -t -f - < archive > /dev/null
-
-rm -r directory
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
-mkdir posix
-(cd posix
-TEST_TAR_FORMAT=posix
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H posix"
-export TAR_OPTIONS
-rm -rf *
-
-mkdir directory
-(cd directory && touch a b c d e f g h i j k l m n o p q r)
-tar -c -b 1 -f - directory | tar -t -f - > /dev/null
-tar -c -b 1 -f archive directory
-tar -t -f archive > /dev/null
-tar -t -f - < archive > /dev/null
-
-rm -r directory
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
-at_func_diff_devnull "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/shortrec.at:28"
-
-$at_failed && at_func_log_failure
-$at_traceon; }
-
-              { $at_traceoff
-$as_echo "$at_srcdir/shortrec.at:28:
-mkdir gnu
-(cd gnu
-TEST_TAR_FORMAT=gnu
+
+rm -r directory
+)"
+at_fn_check_prepare_notrace 'an embedded newline' "shortrec.at:28"
+( $at_check_trace;
+mkdir posix
+(cd posix
+TEST_TAR_FORMAT=posix
 export TEST_TAR_FORMAT
-TAR_OPTIONS=\"-H gnu\"
+TAR_OPTIONS="-H posix"
 export TAR_OPTIONS
 rm -rf *
 
@@ -33140,17 +24191,23 @@ tar -t -f archive > /dev/null
 tar -t -f - < archive > /dev/null
 
 rm -r directory
-)"
-echo shortrec.at:28 >"$at_check_line_file"
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
+at_fn_diff_devnull "$at_stdout" || at_failed=:
+at_fn_check_status 0 $at_status "$at_srcdir/shortrec.at:28"
+$at_failed && at_fn_log_failure
+$at_traceon; }
 
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
+              { set +x
+$as_echo "$at_srcdir/shortrec.at:28:
 mkdir gnu
 (cd gnu
 TEST_TAR_FORMAT=gnu
 export TEST_TAR_FORMAT
-TAR_OPTIONS="-H gnu"
+TAR_OPTIONS=\"-H gnu\"
 export TAR_OPTIONS
 rm -rf *
 
@@ -33162,10 +24219,9 @@ tar -t -f archive > /dev/null
 tar -t -f - < archive > /dev/null
 
 rm -r directory
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+)"
+at_fn_check_prepare_notrace 'an embedded newline' "shortrec.at:28"
+( $at_check_trace;
 mkdir gnu
 (cd gnu
 TEST_TAR_FORMAT=gnu
@@ -33182,42 +24238,38 @@ tar -t -f archive > /dev/null
 tar -t -f - < archive > /dev/null
 
 rm -r directory
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
-at_func_diff_devnull "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/shortrec.at:28"
-
-$at_failed && at_func_log_failure
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
+at_fn_diff_devnull "$at_stdout" || at_failed=:
+at_fn_check_status 0 $at_status "$at_srcdir/shortrec.at:28"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
 
 
 
-  $at_traceoff
+  set +x
   $at_times_p && times >"$at_times_file"
-) 5>&1 2>&1 | eval $at_tee_pipe
-at_status=`cat "$at_status_file"`
+) 5>&1 2>&1 7>&- | eval $at_tee_pipe
+read at_status <"$at_status_file"
 #AT_STOP_91
 #AT_START_92
-# 92. sparse01.at:21: sparse files
-at_setup_line='sparse01.at:21'
-at_desc="sparse files"
-$at_quiet $as_echo_n " 92: $at_desc                                   "
+at_fn_group_banner 92 'sparse01.at:21' \
+  "sparse files" "                                   "
 at_xfail=no
       test -f $XFAILFILE && at_xfail=yes
-echo "#                             -*- compilation -*-" >> "$at_group_log"
 (
-  $as_echo "92. sparse01.at:21: testing ..."
+  $as_echo "92. $at_setup_line: testing $at_desc ..."
   $at_traceon
 
 
 
 
 
-  { $at_traceoff
+  { set +x
 $as_echo "$at_srcdir/sparse01.at:24:
 mkdir posix
 (cd posix
@@ -33240,35 +24292,8 @@ tar Cxf directory archive --warning=no-t
 genfile --stat=name,size sparsefile
 cmp sparsefile directory/sparsefile
 )"
-echo sparse01.at:24 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir posix
-(cd posix
-TEST_TAR_FORMAT=posix
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H posix"
-export TAR_OPTIONS
-rm -rf *
-
-genfile --length 1000 -f begin
-genfile --length 1000 -f end
-genfile --sparse --file sparsefile --block-size 512 0 ABCD 1M EFGH 2000K IJKL || exit 77
-tar -c -f archive --sparse begin sparsefile end || exit 1
-echo separator
-
-tar tfv archive
-echo separator
-mkdir directory
-tar Cxf directory archive --warning=no-timestamp
-genfile --stat=name,size sparsefile
-cmp sparsefile directory/sparsefile
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'an embedded newline' "sparse01.at:24"
+( $at_check_trace;
 mkdir posix
 (cd posix
 TEST_TAR_FORMAT=posix
@@ -33289,18 +24314,17 @@ mkdir directory
 tar Cxf directory archive --warning=no-timestamp
 genfile --stat=name,size sparsefile
 cmp sparsefile directory/sparsefile
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo stdout:; tee stdout <"$at_stdout"
-at_func_check_status 0 $at_status "$at_srcdir/sparse01.at:24"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/sparse01.at:24"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/sparse01.at:24:
 mkdir gnu
 (cd gnu
@@ -33323,35 +24347,8 @@ tar Cxf directory archive --warning=no-t
 genfile --stat=name,size sparsefile
 cmp sparsefile directory/sparsefile
 )"
-echo sparse01.at:24 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir gnu
-(cd gnu
-TEST_TAR_FORMAT=gnu
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H gnu"
-export TAR_OPTIONS
-rm -rf *
-
-genfile --length 1000 -f begin
-genfile --length 1000 -f end
-genfile --sparse --file sparsefile --block-size 512 0 ABCD 1M EFGH 2000K IJKL || exit 77
-tar -c -f archive --sparse begin sparsefile end || exit 1
-echo separator
-
-tar tfv archive
-echo separator
-mkdir directory
-tar Cxf directory archive --warning=no-timestamp
-genfile --stat=name,size sparsefile
-cmp sparsefile directory/sparsefile
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'an embedded newline' "sparse01.at:24"
+( $at_check_trace;
 mkdir gnu
 (cd gnu
 TEST_TAR_FORMAT=gnu
@@ -33372,18 +24369,17 @@ mkdir directory
 tar Cxf directory archive --warning=no-timestamp
 genfile --stat=name,size sparsefile
 cmp sparsefile directory/sparsefile
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo stdout:; tee stdout <"$at_stdout"
-at_func_check_status 0 $at_status "$at_srcdir/sparse01.at:24"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/sparse01.at:24"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/sparse01.at:24:
 mkdir oldgnu
 (cd oldgnu
@@ -33406,35 +24402,8 @@ tar Cxf directory archive --warning=no-t
 genfile --stat=name,size sparsefile
 cmp sparsefile directory/sparsefile
 )"
-echo sparse01.at:24 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir oldgnu
-(cd oldgnu
-TEST_TAR_FORMAT=oldgnu
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H oldgnu"
-export TAR_OPTIONS
-rm -rf *
-
-genfile --length 1000 -f begin
-genfile --length 1000 -f end
-genfile --sparse --file sparsefile --block-size 512 0 ABCD 1M EFGH 2000K IJKL || exit 77
-tar -c -f archive --sparse begin sparsefile end || exit 1
-echo separator
-
-tar tfv archive
-echo separator
-mkdir directory
-tar Cxf directory archive --warning=no-timestamp
-genfile --stat=name,size sparsefile
-cmp sparsefile directory/sparsefile
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'an embedded newline' "sparse01.at:24"
+( $at_check_trace;
 mkdir oldgnu
 (cd oldgnu
 TEST_TAR_FORMAT=oldgnu
@@ -33455,15 +24424,14 @@ mkdir directory
 tar Cxf directory archive --warning=no-timestamp
 genfile --stat=name,size sparsefile
 cmp sparsefile directory/sparsefile
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo stdout:; tee stdout <"$at_stdout"
-at_func_check_status 0 $at_status "$at_srcdir/sparse01.at:24"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/sparse01.at:24"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
 
@@ -33487,21 +24455,18 @@ do
 done
 
 
-  $at_traceoff
+  set +x
   $at_times_p && times >"$at_times_file"
-) 5>&1 2>&1 | eval $at_tee_pipe
-at_status=`cat "$at_status_file"`
+) 5>&1 2>&1 7>&- | eval $at_tee_pipe
+read at_status <"$at_status_file"
 #AT_STOP_92
 #AT_START_93
-# 93. sparse02.at:21: extracting sparse file over a pipe
-at_setup_line='sparse02.at:21'
-at_desc="extracting sparse file over a pipe"
-$at_quiet $as_echo_n " 93: $at_desc             "
+at_fn_group_banner 93 'sparse02.at:21' \
+  "extracting sparse file over a pipe" "             "
 at_xfail=no
       test -f $XFAILFILE && at_xfail=yes
-echo "#                             -*- compilation -*-" >> "$at_group_log"
 (
-  $as_echo "93. sparse02.at:21: testing ..."
+  $as_echo "93. $at_setup_line: testing $at_desc ..."
   $at_traceon
 
 
@@ -33512,7 +24477,7 @@ echo "#                             -*-
 
 
 
-  { $at_traceoff
+  { set +x
 $as_echo "$at_srcdir/sparse02.at:28:
 mkdir posix
 (cd posix
@@ -33529,29 +24494,8 @@ echo separator
 tar xfO archive | cat - > sparsecopy || exit 1
 cmp sparsefile sparsecopy
 )"
-echo sparse02.at:28 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir posix
-(cd posix
-TEST_TAR_FORMAT=posix
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H posix"
-export TAR_OPTIONS
-rm -rf *
-
-genfile --sparse --file sparsefile --block-size 512 0 ABCD 1M EFGH 2000K IJKL || exit 77
-tar -c -f archive --sparse sparsefile || exit 1
-echo separator
-
-tar xfO archive | cat - > sparsecopy || exit 1
-cmp sparsefile sparsecopy
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'an embedded newline' "sparse02.at:28"
+( $at_check_trace;
 mkdir posix
 (cd posix
 TEST_TAR_FORMAT=posix
@@ -33566,20 +24510,19 @@ echo separator
 
 tar xfO archive | cat - > sparsecopy || exit 1
 cmp sparsefile sparsecopy
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "separator
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/sparse02.at:28"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/sparse02.at:28"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/sparse02.at:28:
 mkdir gnu
 (cd gnu
@@ -33596,29 +24539,8 @@ echo separator
 tar xfO archive | cat - > sparsecopy || exit 1
 cmp sparsefile sparsecopy
 )"
-echo sparse02.at:28 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir gnu
-(cd gnu
-TEST_TAR_FORMAT=gnu
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H gnu"
-export TAR_OPTIONS
-rm -rf *
-
-genfile --sparse --file sparsefile --block-size 512 0 ABCD 1M EFGH 2000K IJKL || exit 77
-tar -c -f archive --sparse sparsefile || exit 1
-echo separator
-
-tar xfO archive | cat - > sparsecopy || exit 1
-cmp sparsefile sparsecopy
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'an embedded newline' "sparse02.at:28"
+( $at_check_trace;
 mkdir gnu
 (cd gnu
 TEST_TAR_FORMAT=gnu
@@ -33633,20 +24555,19 @@ echo separator
 
 tar xfO archive | cat - > sparsecopy || exit 1
 cmp sparsefile sparsecopy
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "separator
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/sparse02.at:28"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/sparse02.at:28"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/sparse02.at:28:
 mkdir oldgnu
 (cd oldgnu
@@ -33663,29 +24584,8 @@ echo separator
 tar xfO archive | cat - > sparsecopy || exit 1
 cmp sparsefile sparsecopy
 )"
-echo sparse02.at:28 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir oldgnu
-(cd oldgnu
-TEST_TAR_FORMAT=oldgnu
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H oldgnu"
-export TAR_OPTIONS
-rm -rf *
-
-genfile --sparse --file sparsefile --block-size 512 0 ABCD 1M EFGH 2000K IJKL || exit 77
-tar -c -f archive --sparse sparsefile || exit 1
-echo separator
-
-tar xfO archive | cat - > sparsecopy || exit 1
-cmp sparsefile sparsecopy
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'an embedded newline' "sparse02.at:28"
+( $at_check_trace;
 mkdir oldgnu
 (cd oldgnu
 TEST_TAR_FORMAT=oldgnu
@@ -33700,37 +24600,33 @@ echo separator
 
 tar xfO archive | cat - > sparsecopy || exit 1
 cmp sparsefile sparsecopy
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "separator
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/sparse02.at:28"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/sparse02.at:28"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
 
 
 
-  $at_traceoff
+  set +x
   $at_times_p && times >"$at_times_file"
-) 5>&1 2>&1 | eval $at_tee_pipe
-at_status=`cat "$at_status_file"`
+) 5>&1 2>&1 7>&- | eval $at_tee_pipe
+read at_status <"$at_status_file"
 #AT_STOP_93
 #AT_START_94
-# 94. sparse03.at:21: storing sparse files > 8G
-at_setup_line='sparse03.at:21'
-at_desc="storing sparse files > 8G"
-$at_quiet $as_echo_n " 94: $at_desc                      "
+at_fn_group_banner 94 'sparse03.at:21' \
+  "storing sparse files > 8G" "                      "
 at_xfail=no
       test -f $XFAILFILE && at_xfail=yes
-echo "#                             -*- compilation -*-" >> "$at_group_log"
 (
-  $as_echo "94. sparse03.at:21: testing ..."
+  $as_echo "94. $at_setup_line: testing $at_desc ..."
   $at_traceon
 
 
@@ -33742,7 +24638,7 @@ echo "#                             -*-
 
 
 
-  { $at_traceoff
+  { set +x
 $as_echo "$at_srcdir/sparse03.at:29:
 mkdir posix
 (cd posix
@@ -33765,35 +24661,8 @@ tar Cxf directory archive
 genfile --stat=name,size sparsefile
 cmp sparsefile directory/sparsefile
 )"
-echo sparse03.at:29 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir posix
-(cd posix
-TEST_TAR_FORMAT=posix
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H posix"
-export TAR_OPTIONS
-rm -rf *
-
-genfile --length 1000 --file begin
-genfile --length 1000 --file end
-genfile --sparse --file sparsefile --block-size 512 8G A || exit 77
-tar -c -f archive --sparse begin sparsefile end || exit 1
-echo separator
-
-tar tfv archive
-echo separator
-mkdir directory
-tar Cxf directory archive
-genfile --stat=name,size sparsefile
-cmp sparsefile directory/sparsefile
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'an embedded newline' "sparse03.at:29"
+( $at_check_trace;
 mkdir posix
 (cd posix
 TEST_TAR_FORMAT=posix
@@ -33814,15 +24683,14 @@ mkdir directory
 tar Cxf directory archive
 genfile --stat=name,size sparsefile
 cmp sparsefile directory/sparsefile
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo stdout:; tee stdout <"$at_stdout"
-at_func_check_status 0 $at_status "$at_srcdir/sparse03.at:29"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/sparse03.at:29"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
 
@@ -33846,21 +24714,18 @@ do
 done
 
 
-  $at_traceoff
+  set +x
   $at_times_p && times >"$at_times_file"
-) 5>&1 2>&1 | eval $at_tee_pipe
-at_status=`cat "$at_status_file"`
+) 5>&1 2>&1 7>&- | eval $at_tee_pipe
+read at_status <"$at_status_file"
 #AT_STOP_94
 #AT_START_95
-# 95. sparsemv.at:21: sparse files in MV archives
-at_setup_line='sparsemv.at:21'
-at_desc="sparse files in MV archives"
-$at_quiet $as_echo_n " 95: $at_desc                    "
+at_fn_group_banner 95 'sparsemv.at:21' \
+  "sparse files in MV archives" "                    "
 at_xfail=no
       test -f $XFAILFILE && at_xfail=yes
-echo "#                             -*- compilation -*-" >> "$at_group_log"
 (
-  $as_echo "95. sparsemv.at:21: testing ..."
+  $as_echo "95. $at_setup_line: testing $at_desc ..."
   $at_traceon
 
 
@@ -33874,7 +24739,7 @@ echo "#                             -*-
 
 
 
-  { $at_traceoff
+  { set +x
 $as_echo "$at_srcdir/sparsemv.at:31:
 mkdir gnu
 (cd gnu
@@ -33903,41 +24768,8 @@ tar --record-size=512 -t -M -f arc.1 -f
 echo \"Compare archive\"
 tar --record-size=512 -d -M -f arc.1 -f arc.2
 )"
-echo sparsemv.at:31 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir gnu
-(cd gnu
-TEST_TAR_FORMAT=gnu
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H gnu"
-export TAR_OPTIONS
-rm -rf *
-
-exec <&-
-genfile --sparse --file sparsefile 0 ABCDEFGHIJK 1M ABCDEFGHI || exit 77
-echo "Pass 1: Split between data blocks"
-echo "Create archive"
-tar --sparse -c --record-size=512 -M -L6 -f arc.1 -f arc.2 sparsefile || exit 1
-echo "Test archive"
-tar --record-size=512 -t -M -f arc.1 -f arc.2
-echo "Compare archive"
-tar --record-size=512 -d -M -f arc.1 -f arc.2
-
-echo "Pass 2: Split within a data block"
-genfile --sparse --file sparsefile 0 ABCDEFGHIJ 1M ABCDEFGHI || exit 77
-echo "Create archive"
-tar --sparse -c --record-size=512 -M -L6 -f arc.1 -f arc.2 sparsefile || exit 1
-echo "Test archive"
-tar --record-size=512 -t -M -f arc.1 -f arc.2
-echo "Compare archive"
-tar --record-size=512 -d -M -f arc.1 -f arc.2
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'an embedded newline' "sparsemv.at:31"
+( $at_check_trace;
 mkdir gnu
 (cd gnu
 TEST_TAR_FORMAT=gnu
@@ -33964,11 +24796,11 @@ echo "Test archive"
 tar --record-size=512 -t -M -f arc.1 -f arc.2
 echo "Compare archive"
 tar --record-size=512 -d -M -f arc.1 -f arc.2
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "Pass 1: Split between data blocks
 Create archive
 Test archive
@@ -33981,12 +24813,11 @@ sparsefile
 Compare archive
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/sparsemv.at:31"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/sparsemv.at:31"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/sparsemv.at:31:
 mkdir oldgnu
 (cd oldgnu
@@ -34015,41 +24846,8 @@ tar --record-size=512 -t -M -f arc.1 -f
 echo \"Compare archive\"
 tar --record-size=512 -d -M -f arc.1 -f arc.2
 )"
-echo sparsemv.at:31 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir oldgnu
-(cd oldgnu
-TEST_TAR_FORMAT=oldgnu
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H oldgnu"
-export TAR_OPTIONS
-rm -rf *
-
-exec <&-
-genfile --sparse --file sparsefile 0 ABCDEFGHIJK 1M ABCDEFGHI || exit 77
-echo "Pass 1: Split between data blocks"
-echo "Create archive"
-tar --sparse -c --record-size=512 -M -L6 -f arc.1 -f arc.2 sparsefile || exit 1
-echo "Test archive"
-tar --record-size=512 -t -M -f arc.1 -f arc.2
-echo "Compare archive"
-tar --record-size=512 -d -M -f arc.1 -f arc.2
-
-echo "Pass 2: Split within a data block"
-genfile --sparse --file sparsefile 0 ABCDEFGHIJ 1M ABCDEFGHI || exit 77
-echo "Create archive"
-tar --sparse -c --record-size=512 -M -L6 -f arc.1 -f arc.2 sparsefile || exit 1
-echo "Test archive"
-tar --record-size=512 -t -M -f arc.1 -f arc.2
-echo "Compare archive"
-tar --record-size=512 -d -M -f arc.1 -f arc.2
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'an embedded newline' "sparsemv.at:31"
+( $at_check_trace;
 mkdir oldgnu
 (cd oldgnu
 TEST_TAR_FORMAT=oldgnu
@@ -34076,11 +24874,11 @@ echo "Test archive"
 tar --record-size=512 -t -M -f arc.1 -f arc.2
 echo "Compare archive"
 tar --record-size=512 -d -M -f arc.1 -f arc.2
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "Pass 1: Split between data blocks
 Create archive
 Test archive
@@ -34093,29 +24891,25 @@ sparsefile
 Compare archive
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/sparsemv.at:31"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/sparsemv.at:31"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
 
 
 
-  $at_traceoff
+  set +x
   $at_times_p && times >"$at_times_file"
-) 5>&1 2>&1 | eval $at_tee_pipe
-at_status=`cat "$at_status_file"`
+) 5>&1 2>&1 7>&- | eval $at_tee_pipe
+read at_status <"$at_status_file"
 #AT_STOP_95
 #AT_START_96
-# 96. spmvp00.at:21: sparse files in PAX MV archives, v.0.0
-at_setup_line='spmvp00.at:21'
-at_desc="sparse files in PAX MV archives, v.0.0"
-$at_quiet $as_echo_n " 96: $at_desc         "
+at_fn_group_banner 96 'spmvp00.at:21' \
+  "sparse files in PAX MV archives, v.0.0" "         "
 at_xfail=no
       test -f $XFAILFILE && at_xfail=yes
-echo "#                             -*- compilation -*-" >> "$at_group_log"
 (
-  $as_echo "96. spmvp00.at:21: testing ..."
+  $as_echo "96. $at_setup_line: testing $at_desc ..."
   $at_traceon
 
 
@@ -34123,7 +24917,7 @@ echo "#                             -*-
 
 
 
-  { $at_traceoff
+  { set +x
 $as_echo "$at_srcdir/spmvp00.at:24:
 mkdir pax
 (cd pax
@@ -34147,46 +24941,13 @@ echo \"Pass 2: Split within a data block
 genfile --sparse --file sparsefile 0 ABCDEFGH 1M ABCDEFGHI || exit 77
 echo \"Create archive\"
 tar --sparse --sparse-version=0.0 -c --record-size=512 -M -L6 -f arc.1 -f arc.2 -f arc.3 sparsefile
-echo \"Test archive\"
-tar -t -M -f arc.1 -f arc.2 -f arc.3
-echo \"Compare archive\"
-tar -d -M -f arc.1 -f arc.2 -f arc.3
-)"
-echo spmvp00.at:24 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir pax
-(cd pax
-TEST_TAR_FORMAT=pax
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H pax"
-export TAR_OPTIONS
-rm -rf *
-
-exec <&-
-genfile --sparse --file sparsefile 0 ABCDEFGHI 1M ABCDEFGHI || exit 77
-echo "Pass 1: Split between data blocks"
-echo "Create archive"
-tar --sparse --sparse-version=0.0 -c --record-size=512 -M -L6 -f arc.1 -f arc.2 -f arc.3 sparsefile
-echo "Test archive"
-tar -t -M -f arc.1 -f arc.2 -f arc.3
-echo "Compare archive"
-tar -d -M -f arc.1 -f arc.2 -f arc.3
-
-echo "Pass 2: Split within a data block"
-genfile --sparse --file sparsefile 0 ABCDEFGH 1M ABCDEFGHI || exit 77
-echo "Create archive"
-tar --sparse --sparse-version=0.0 -c --record-size=512 -M -L6 -f arc.1 -f arc.2 -f arc.3 sparsefile
-echo "Test archive"
+echo \"Test archive\"
 tar -t -M -f arc.1 -f arc.2 -f arc.3
-echo "Compare archive"
+echo \"Compare archive\"
 tar -d -M -f arc.1 -f arc.2 -f arc.3
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+)"
+at_fn_check_prepare_notrace 'an embedded newline' "spmvp00.at:24"
+( $at_check_trace;
 mkdir pax
 (cd pax
 TEST_TAR_FORMAT=pax
@@ -34213,11 +24974,11 @@ echo "Test archive"
 tar -t -M -f arc.1 -f arc.2 -f arc.3
 echo "Compare archive"
 tar -d -M -f arc.1 -f arc.2 -f arc.3
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "Pass 1: Split between data blocks
 Create archive
 Test archive
@@ -34230,29 +24991,25 @@ sparsefile
 Compare archive
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/spmvp00.at:24"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/spmvp00.at:24"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
 
 
 
-  $at_traceoff
+  set +x
   $at_times_p && times >"$at_times_file"
-) 5>&1 2>&1 | eval $at_tee_pipe
-at_status=`cat "$at_status_file"`
+) 5>&1 2>&1 7>&- | eval $at_tee_pipe
+read at_status <"$at_status_file"
 #AT_STOP_96
 #AT_START_97
-# 97. spmvp01.at:21: sparse files in PAX MV archives, v.0.1
-at_setup_line='spmvp01.at:21'
-at_desc="sparse files in PAX MV archives, v.0.1"
-$at_quiet $as_echo_n " 97: $at_desc         "
+at_fn_group_banner 97 'spmvp01.at:21' \
+  "sparse files in PAX MV archives, v.0.1" "         "
 at_xfail=no
       test -f $XFAILFILE && at_xfail=yes
-echo "#                             -*- compilation -*-" >> "$at_group_log"
 (
-  $as_echo "97. spmvp01.at:21: testing ..."
+  $as_echo "97. $at_setup_line: testing $at_desc ..."
   $at_traceon
 
 
@@ -34260,7 +25017,7 @@ echo "#                             -*-
 
 
 
-  { $at_traceoff
+  { set +x
 $as_echo "$at_srcdir/spmvp01.at:24:
 mkdir pax
 (cd pax
@@ -34289,41 +25046,8 @@ tar -t -M -f arc.1 -f arc.2 -f arc.3
 echo \"Compare archive\"
 tar -d -M -f arc.1 -f arc.2 -f arc.3
 )"
-echo spmvp01.at:24 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir pax
-(cd pax
-TEST_TAR_FORMAT=pax
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H pax"
-export TAR_OPTIONS
-rm -rf *
-
-exec <&-
-genfile --sparse --file sparsefile 0 ABCDEFGHIJK 1M ABCDEFGHI || exit 77
-echo "Pass 1: Split between data blocks"
-echo "Create archive"
-tar --sparse --sparse-version=0.1 -c --record-size=512 -M -L6 -f arc.1 -f arc.2 -f arc.3 sparsefile
-echo "Test archive"
-tar -t -M -f arc.1 -f arc.2 -f arc.3
-echo "Compare archive"
-tar -d -M -f arc.1 -f arc.2 -f arc.3
-
-echo "Pass 2: Split within a data block"
-genfile --sparse --file sparsefile 0 ABCDEFGHIJ 1M ABCDEFGHI || exit 77
-echo "Create archive"
-tar --sparse --sparse-version=0.1 -c --record-size=512 -M -L6 -f arc.1 -f arc.2 -f arc.3 sparsefile
-echo "Test archive"
-tar -t -M -f arc.1 -f arc.2 -f arc.3
-echo "Compare archive"
-tar -d -M -f arc.1 -f arc.2 -f arc.3
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'an embedded newline' "spmvp01.at:24"
+( $at_check_trace;
 mkdir pax
 (cd pax
 TEST_TAR_FORMAT=pax
@@ -34350,11 +25074,11 @@ echo "Test archive"
 tar -t -M -f arc.1 -f arc.2 -f arc.3
 echo "Compare archive"
 tar -d -M -f arc.1 -f arc.2 -f arc.3
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "Pass 1: Split between data blocks
 Create archive
 Test archive
@@ -34367,29 +25091,25 @@ sparsefile
 Compare archive
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/spmvp01.at:24"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/spmvp01.at:24"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
 
 
 
-  $at_traceoff
+  set +x
   $at_times_p && times >"$at_times_file"
-) 5>&1 2>&1 | eval $at_tee_pipe
-at_status=`cat "$at_status_file"`
+) 5>&1 2>&1 7>&- | eval $at_tee_pipe
+read at_status <"$at_status_file"
 #AT_STOP_97
 #AT_START_98
-# 98. spmvp10.at:21: sparse files in PAX MV archives, v.1.0
-at_setup_line='spmvp10.at:21'
-at_desc="sparse files in PAX MV archives, v.1.0"
-$at_quiet $as_echo_n " 98: $at_desc         "
+at_fn_group_banner 98 'spmvp10.at:21' \
+  "sparse files in PAX MV archives, v.1.0" "         "
 at_xfail=no
       test -f $XFAILFILE && at_xfail=yes
-echo "#                             -*- compilation -*-" >> "$at_group_log"
 (
-  $as_echo "98. spmvp10.at:21: testing ..."
+  $as_echo "98. $at_setup_line: testing $at_desc ..."
   $at_traceon
 
 
@@ -34397,7 +25117,7 @@ echo "#                             -*-
 
 
 
-  { $at_traceoff
+  { set +x
 $as_echo "$at_srcdir/spmvp10.at:24:
 mkdir pax
 (cd pax
@@ -34426,41 +25146,8 @@ tar -t -M -f arc.1 -f arc.2 -f arc.3
 echo \"Compare archive\"
 tar -d -M -f arc.1 -f arc.2 -f arc.3
 )"
-echo spmvp10.at:24 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir pax
-(cd pax
-TEST_TAR_FORMAT=pax
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H pax"
-export TAR_OPTIONS
-rm -rf *
-
-exec <&-
-genfile --sparse --file sparsefile 0 ABCDEFGH 1M ABCDEFGHI || exit 77
-echo "Pass 1: Split between data blocks"
-echo "Create archive"
-tar --sparse --sparse-version=1.0 -c --record-size=512 -M -L6 -f arc.1 -f arc.2 -f arc.3 sparsefile
-echo "Test archive"
-tar -t -M -f arc.1 -f arc.2 -f arc.3
-echo "Compare archive"
-tar -d -M -f arc.1 -f arc.2 -f arc.3
-
-echo "Pass 2: Split within a data block"
-genfile --sparse --file sparsefile 0 ABCDEFG 1M ABCDEFGHI || exit 77
-echo "Create archive"
-tar --sparse --sparse-version=1.0 -c --record-size=512 -M -L6 -f arc.1 -f arc.2 -f arc.3 sparsefile
-echo "Test archive"
-tar -t -M -f arc.1 -f arc.2 -f arc.3
-echo "Compare archive"
-tar -d -M -f arc.1 -f arc.2 -f arc.3
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'an embedded newline' "spmvp10.at:24"
+( $at_check_trace;
 mkdir pax
 (cd pax
 TEST_TAR_FORMAT=pax
@@ -34487,11 +25174,11 @@ echo "Test archive"
 tar -t -M -f arc.1 -f arc.2 -f arc.3
 echo "Compare archive"
 tar -d -M -f arc.1 -f arc.2 -f arc.3
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "Pass 1: Split between data blocks
 Create archive
 Test archive
@@ -34504,36 +25191,32 @@ sparsefile
 Compare archive
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/spmvp10.at:24"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/spmvp10.at:24"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
 
 
 
-  $at_traceoff
+  set +x
   $at_times_p && times >"$at_times_file"
-) 5>&1 2>&1 | eval $at_tee_pipe
-at_status=`cat "$at_status_file"`
+) 5>&1 2>&1 7>&- | eval $at_tee_pipe
+read at_status <"$at_status_file"
 #AT_STOP_98
 #AT_START_99
-# 99. update.at:28: update unchanged directories
-at_setup_line='update.at:28'
-at_desc="update unchanged directories"
-$at_quiet $as_echo_n " 99: $at_desc                   "
+at_fn_group_banner 99 'update.at:28' \
+  "update unchanged directories" "                   "
 at_xfail=no
       test -f $XFAILFILE && at_xfail=yes
-echo "#                             -*- compilation -*-" >> "$at_group_log"
 (
-  $as_echo "99. update.at:28: testing ..."
+  $as_echo "99. $at_setup_line: testing $at_desc ..."
   $at_traceon
 
 
 
 
 
-  { $at_traceoff
+  { set +x
 $as_echo "$at_srcdir/update.at:31:
 mkdir v7
 (cd v7
@@ -34544,7 +25227,7 @@ export TAR_OPTIONS
 rm -rf *
 
 
-test -z "`sort < /dev/null 2>&1`" || exit 77
+test -z \"\`sort < /dev/null 2>&1\`\" || exit 77
 
 mkdir directory
 genfile --length 10240 --pattern zeros --file directory/file1
@@ -34556,35 +25239,8 @@ tar uf archive directory || exit 1
 echo separator
 tar tf archive | sort || exit 1
 )"
-echo update.at:31 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir v7
-(cd v7
-TEST_TAR_FORMAT=v7
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H v7"
-export TAR_OPTIONS
-rm -rf *
-
-
-test -z "`sort < /dev/null 2>&1`" || exit 77
-
-mkdir directory
-genfile --length 10240 --pattern zeros --file directory/file1
-genfile --length 10240 --pattern default --file directory/file2
-
-tar cf archive directory || exit 1
-echo separator
-tar uf archive directory || exit 1
-echo separator
-tar tf archive | sort || exit 1
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'a `...` command substitution' "update.at:31"
+( $at_check_trace;
 mkdir v7
 (cd v7
 TEST_TAR_FORMAT=v7
@@ -34605,11 +25261,11 @@ echo separator
 tar uf archive directory || exit 1
 echo separator
 tar tf archive | sort || exit 1
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "separator
 separator
 directory/
@@ -34617,12 +25273,11 @@ directory/file1
 directory/file2
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/update.at:31"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/update.at:31"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/update.at:31:
 mkdir oldgnu
 (cd oldgnu
@@ -34633,7 +25288,7 @@ export TAR_OPTIONS
 rm -rf *
 
 
-test -z "`sort < /dev/null 2>&1`" || exit 77
+test -z \"\`sort < /dev/null 2>&1\`\" || exit 77
 
 mkdir directory
 genfile --length 10240 --pattern zeros --file directory/file1
@@ -34645,35 +25300,8 @@ tar uf archive directory || exit 1
 echo separator
 tar tf archive | sort || exit 1
 )"
-echo update.at:31 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir oldgnu
-(cd oldgnu
-TEST_TAR_FORMAT=oldgnu
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H oldgnu"
-export TAR_OPTIONS
-rm -rf *
-
-
-test -z "`sort < /dev/null 2>&1`" || exit 77
-
-mkdir directory
-genfile --length 10240 --pattern zeros --file directory/file1
-genfile --length 10240 --pattern default --file directory/file2
-
-tar cf archive directory || exit 1
-echo separator
-tar uf archive directory || exit 1
-echo separator
-tar tf archive | sort || exit 1
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'a `...` command substitution' "update.at:31"
+( $at_check_trace;
 mkdir oldgnu
 (cd oldgnu
 TEST_TAR_FORMAT=oldgnu
@@ -34694,11 +25322,11 @@ echo separator
 tar uf archive directory || exit 1
 echo separator
 tar tf archive | sort || exit 1
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "separator
 separator
 directory/
@@ -34706,12 +25334,11 @@ directory/file1
 directory/file2
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/update.at:31"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/update.at:31"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/update.at:31:
 mkdir ustar
 (cd ustar
@@ -34722,7 +25349,7 @@ export TAR_OPTIONS
 rm -rf *
 
 
-test -z "`sort < /dev/null 2>&1`" || exit 77
+test -z \"\`sort < /dev/null 2>&1\`\" || exit 77
 
 mkdir directory
 genfile --length 10240 --pattern zeros --file directory/file1
@@ -34734,35 +25361,8 @@ tar uf archive directory || exit 1
 echo separator
 tar tf archive | sort || exit 1
 )"
-echo update.at:31 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir ustar
-(cd ustar
-TEST_TAR_FORMAT=ustar
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H ustar"
-export TAR_OPTIONS
-rm -rf *
-
-
-test -z "`sort < /dev/null 2>&1`" || exit 77
-
-mkdir directory
-genfile --length 10240 --pattern zeros --file directory/file1
-genfile --length 10240 --pattern default --file directory/file2
-
-tar cf archive directory || exit 1
-echo separator
-tar uf archive directory || exit 1
-echo separator
-tar tf archive | sort || exit 1
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'a `...` command substitution' "update.at:31"
+( $at_check_trace;
 mkdir ustar
 (cd ustar
 TEST_TAR_FORMAT=ustar
@@ -34783,11 +25383,11 @@ echo separator
 tar uf archive directory || exit 1
 echo separator
 tar tf archive | sort || exit 1
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "separator
 separator
 directory/
@@ -34795,12 +25395,11 @@ directory/file1
 directory/file2
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/update.at:31"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/update.at:31"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/update.at:31:
 mkdir posix
 (cd posix
@@ -34811,7 +25410,7 @@ export TAR_OPTIONS
 rm -rf *
 
 
-test -z "`sort < /dev/null 2>&1`" || exit 77
+test -z \"\`sort < /dev/null 2>&1\`\" || exit 77
 
 mkdir directory
 genfile --length 10240 --pattern zeros --file directory/file1
@@ -34823,35 +25422,8 @@ tar uf archive directory || exit 1
 echo separator
 tar tf archive | sort || exit 1
 )"
-echo update.at:31 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir posix
-(cd posix
-TEST_TAR_FORMAT=posix
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H posix"
-export TAR_OPTIONS
-rm -rf *
-
-
-test -z "`sort < /dev/null 2>&1`" || exit 77
-
-mkdir directory
-genfile --length 10240 --pattern zeros --file directory/file1
-genfile --length 10240 --pattern default --file directory/file2
-
-tar cf archive directory || exit 1
-echo separator
-tar uf archive directory || exit 1
-echo separator
-tar tf archive | sort || exit 1
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'a `...` command substitution' "update.at:31"
+( $at_check_trace;
 mkdir posix
 (cd posix
 TEST_TAR_FORMAT=posix
@@ -34872,11 +25444,11 @@ echo separator
 tar uf archive directory || exit 1
 echo separator
 tar tf archive | sort || exit 1
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "separator
 separator
 directory/
@@ -34884,12 +25456,11 @@ directory/file1
 directory/file2
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/update.at:31"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/update.at:31"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/update.at:31:
 mkdir gnu
 (cd gnu
@@ -34900,7 +25471,7 @@ export TAR_OPTIONS
 rm -rf *
 
 
-test -z "`sort < /dev/null 2>&1`" || exit 77
+test -z \"\`sort < /dev/null 2>&1\`\" || exit 77
 
 mkdir directory
 genfile --length 10240 --pattern zeros --file directory/file1
@@ -34912,35 +25483,8 @@ tar uf archive directory || exit 1
 echo separator
 tar tf archive | sort || exit 1
 )"
-echo update.at:31 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir gnu
-(cd gnu
-TEST_TAR_FORMAT=gnu
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H gnu"
-export TAR_OPTIONS
-rm -rf *
-
-
-test -z "`sort < /dev/null 2>&1`" || exit 77
-
-mkdir directory
-genfile --length 10240 --pattern zeros --file directory/file1
-genfile --length 10240 --pattern default --file directory/file2
-
-tar cf archive directory || exit 1
-echo separator
-tar uf archive directory || exit 1
-echo separator
-tar tf archive | sort || exit 1
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'a `...` command substitution' "update.at:31"
+( $at_check_trace;
 mkdir gnu
 (cd gnu
 TEST_TAR_FORMAT=gnu
@@ -34961,11 +25505,11 @@ echo separator
 tar uf archive directory || exit 1
 echo separator
 tar tf archive | sort || exit 1
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "separator
 separator
 directory/
@@ -34973,36 +25517,32 @@ directory/file1
 directory/file2
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/update.at:31"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/update.at:31"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
 
 
 
-  $at_traceoff
+  set +x
   $at_times_p && times >"$at_times_file"
-) 5>&1 2>&1 | eval $at_tee_pipe
-at_status=`cat "$at_status_file"`
+) 5>&1 2>&1 7>&- | eval $at_tee_pipe
+read at_status <"$at_status_file"
 #AT_STOP_99
 #AT_START_100
-# 100. update01.at:29: update directories
-at_setup_line='update01.at:29'
-at_desc="update directories"
-$at_quiet $as_echo_n "100: $at_desc                             "
+at_fn_group_banner 100 'update01.at:29' \
+  "update directories" "                             "
 at_xfail=no
       test -f $XFAILFILE && at_xfail=yes
-echo "#                             -*- compilation -*-" >> "$at_group_log"
 (
-  $as_echo "100. update01.at:29: testing ..."
+  $as_echo "100. $at_setup_line: testing $at_desc ..."
   $at_traceon
 
 
 
 
 
-  { $at_traceoff
+  { set +x
 $as_echo "$at_srcdir/update01.at:32:
 mkdir v7
 (cd v7
@@ -35013,7 +25553,7 @@ export TAR_OPTIONS
 rm -rf *
 
 
-test -z "`sort < /dev/null 2>&1`" || exit 77
+test -z \"\`sort < /dev/null 2>&1\`\" || exit 77
 
 mkdir a
 genfile --file a/b
@@ -35029,39 +25569,8 @@ tar ufv arc a
 echo \"separator\"
 tar tf arc | sort || exit 1
 )"
-echo update01.at:32 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir v7
-(cd v7
-TEST_TAR_FORMAT=v7
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H v7"
-export TAR_OPTIONS
-rm -rf *
-
-
-test -z "`sort < /dev/null 2>&1`" || exit 77
-
-mkdir a
-genfile --file a/b
-
-tar cf arc a
-
-echo "separator"
-
-sleep 2
-genfile --file a/c
-
-tar ufv arc a
-echo "separator"
-tar tf arc | sort || exit 1
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'a `...` command substitution' "update01.at:32"
+( $at_check_trace;
 mkdir v7
 (cd v7
 TEST_TAR_FORMAT=v7
@@ -35078,92 +25587,60 @@ genfile --file a/b
 
 tar cf arc a
 
-echo "separator"
-
-sleep 2
-genfile --file a/c
-
-tar ufv arc a
-echo "separator"
-tar tf arc | sort || exit 1
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
-echo >>"$at_stdout"; $as_echo "separator
-a/c
-separator
-a/
-a/b
-a/c
-" | \
-  $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/update01.at:32"
-
-$at_failed && at_func_log_failure
-$at_traceon; }
-
-              { $at_traceoff
-$as_echo "$at_srcdir/update01.at:32:
-mkdir oldgnu
-(cd oldgnu
-TEST_TAR_FORMAT=oldgnu
-export TEST_TAR_FORMAT
-TAR_OPTIONS=\"-H oldgnu\"
-export TAR_OPTIONS
-rm -rf *
-
-
-test -z "`sort < /dev/null 2>&1`" || exit 77
-
-mkdir a
-genfile --file a/b
-
-tar cf arc a
-
-echo \"separator\"
+echo "separator"
 
 sleep 2
 genfile --file a/c
 
 tar ufv arc a
-echo \"separator\"
+echo "separator"
 tar tf arc | sort || exit 1
-)"
-echo update01.at:32 >"$at_check_line_file"
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
+echo >>"$at_stdout"; $as_echo "separator
+a/c
+separator
+a/
+a/b
+a/c
+" | \
+  $at_diff - "$at_stdout" || at_failed=:
+at_fn_check_status 0 $at_status "$at_srcdir/update01.at:32"
+$at_failed && at_fn_log_failure
+$at_traceon; }
 
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
+              { set +x
+$as_echo "$at_srcdir/update01.at:32:
 mkdir oldgnu
 (cd oldgnu
 TEST_TAR_FORMAT=oldgnu
 export TEST_TAR_FORMAT
-TAR_OPTIONS="-H oldgnu"
+TAR_OPTIONS=\"-H oldgnu\"
 export TAR_OPTIONS
 rm -rf *
 
 
-test -z "`sort < /dev/null 2>&1`" || exit 77
+test -z \"\`sort < /dev/null 2>&1\`\" || exit 77
 
 mkdir a
 genfile --file a/b
 
 tar cf arc a
 
-echo "separator"
+echo \"separator\"
 
 sleep 2
 genfile --file a/c
 
 tar ufv arc a
-echo "separator"
+echo \"separator\"
 tar tf arc | sort || exit 1
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+)"
+at_fn_check_prepare_notrace 'a `...` command substitution' "update01.at:32"
+( $at_check_trace;
 mkdir oldgnu
 (cd oldgnu
 TEST_TAR_FORMAT=oldgnu
@@ -35188,11 +25665,11 @@ genfile --file a/c
 tar ufv arc a
 echo "separator"
 tar tf arc | sort || exit 1
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "separator
 a/c
 separator
@@ -35201,12 +25678,11 @@ a/b
 a/c
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/update01.at:32"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/update01.at:32"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/update01.at:32:
 mkdir ustar
 (cd ustar
@@ -35217,7 +25693,7 @@ export TAR_OPTIONS
 rm -rf *
 
 
-test -z "`sort < /dev/null 2>&1`" || exit 77
+test -z \"\`sort < /dev/null 2>&1\`\" || exit 77
 
 mkdir a
 genfile --file a/b
@@ -35233,39 +25709,8 @@ tar ufv arc a
 echo \"separator\"
 tar tf arc | sort || exit 1
 )"
-echo update01.at:32 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir ustar
-(cd ustar
-TEST_TAR_FORMAT=ustar
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H ustar"
-export TAR_OPTIONS
-rm -rf *
-
-
-test -z "`sort < /dev/null 2>&1`" || exit 77
-
-mkdir a
-genfile --file a/b
-
-tar cf arc a
-
-echo "separator"
-
-sleep 2
-genfile --file a/c
-
-tar ufv arc a
-echo "separator"
-tar tf arc | sort || exit 1
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'a `...` command substitution' "update01.at:32"
+( $at_check_trace;
 mkdir ustar
 (cd ustar
 TEST_TAR_FORMAT=ustar
@@ -35290,11 +25735,11 @@ genfile --file a/c
 tar ufv arc a
 echo "separator"
 tar tf arc | sort || exit 1
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "separator
 a/c
 separator
@@ -35303,12 +25748,11 @@ a/b
 a/c
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/update01.at:32"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/update01.at:32"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/update01.at:32:
 mkdir posix
 (cd posix
@@ -35319,7 +25763,7 @@ export TAR_OPTIONS
 rm -rf *
 
 
-test -z "`sort < /dev/null 2>&1`" || exit 77
+test -z \"\`sort < /dev/null 2>&1\`\" || exit 77
 
 mkdir a
 genfile --file a/b
@@ -35335,39 +25779,8 @@ tar ufv arc a
 echo \"separator\"
 tar tf arc | sort || exit 1
 )"
-echo update01.at:32 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir posix
-(cd posix
-TEST_TAR_FORMAT=posix
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H posix"
-export TAR_OPTIONS
-rm -rf *
-
-
-test -z "`sort < /dev/null 2>&1`" || exit 77
-
-mkdir a
-genfile --file a/b
-
-tar cf arc a
-
-echo "separator"
-
-sleep 2
-genfile --file a/c
-
-tar ufv arc a
-echo "separator"
-tar tf arc | sort || exit 1
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'a `...` command substitution' "update01.at:32"
+( $at_check_trace;
 mkdir posix
 (cd posix
 TEST_TAR_FORMAT=posix
@@ -35392,11 +25805,11 @@ genfile --file a/c
 tar ufv arc a
 echo "separator"
 tar tf arc | sort || exit 1
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "separator
 a/c
 separator
@@ -35405,12 +25818,11 @@ a/b
 a/c
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/update01.at:32"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/update01.at:32"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/update01.at:32:
 mkdir gnu
 (cd gnu
@@ -35421,7 +25833,7 @@ export TAR_OPTIONS
 rm -rf *
 
 
-test -z "`sort < /dev/null 2>&1`" || exit 77
+test -z \"\`sort < /dev/null 2>&1\`\" || exit 77
 
 mkdir a
 genfile --file a/b
@@ -35437,39 +25849,8 @@ tar ufv arc a
 echo \"separator\"
 tar tf arc | sort || exit 1
 )"
-echo update01.at:32 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir gnu
-(cd gnu
-TEST_TAR_FORMAT=gnu
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H gnu"
-export TAR_OPTIONS
-rm -rf *
-
-
-test -z "`sort < /dev/null 2>&1`" || exit 77
-
-mkdir a
-genfile --file a/b
-
-tar cf arc a
-
-echo "separator"
-
-sleep 2
-genfile --file a/c
-
-tar ufv arc a
-echo "separator"
-tar tf arc | sort || exit 1
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'a `...` command substitution' "update01.at:32"
+( $at_check_trace;
 mkdir gnu
 (cd gnu
 TEST_TAR_FORMAT=gnu
@@ -35494,11 +25875,11 @@ genfile --file a/c
 tar ufv arc a
 echo "separator"
 tar tf arc | sort || exit 1
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "separator
 a/c
 separator
@@ -35507,36 +25888,32 @@ a/b
 a/c
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/update01.at:32"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/update01.at:32"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
 
 
 
-  $at_traceoff
+  set +x
   $at_times_p && times >"$at_times_file"
-) 5>&1 2>&1 | eval $at_tee_pipe
-at_status=`cat "$at_status_file"`
+) 5>&1 2>&1 7>&- | eval $at_tee_pipe
+read at_status <"$at_status_file"
 #AT_STOP_100
 #AT_START_101
-# 101. update02.at:26: update changed files
-at_setup_line='update02.at:26'
-at_desc="update changed files"
-$at_quiet $as_echo_n "101: $at_desc                           "
+at_fn_group_banner 101 'update02.at:26' \
+  "update changed files" "                           "
 at_xfail=no
       test -f $XFAILFILE && at_xfail=yes
-echo "#                             -*- compilation -*-" >> "$at_group_log"
 (
-  $as_echo "101. update02.at:26: testing ..."
+  $as_echo "101. $at_setup_line: testing $at_desc ..."
   $at_traceon
 
 
 
 
 
-  { $at_traceoff
+  { set +x
 $as_echo "$at_srcdir/update02.at:29:
 mkdir v7
 (cd v7
@@ -35547,7 +25924,7 @@ export TAR_OPTIONS
 rm -rf *
 
 
-test -z "`sort < /dev/null 2>&1`" || exit 77
+test -z \"\`sort < /dev/null 2>&1\`\" || exit 77
 
 mkdir a
 genfile --file a/b
@@ -35563,39 +25940,8 @@ tar ufv arc a
 echo \"separator\"
 tar tf arc | sort || exit 1
 )"
-echo update02.at:29 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir v7
-(cd v7
-TEST_TAR_FORMAT=v7
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H v7"
-export TAR_OPTIONS
-rm -rf *
-
-
-test -z "`sort < /dev/null 2>&1`" || exit 77
-
-mkdir a
-genfile --file a/b
-
-tar cf arc a
-
-echo "separator"
-
-sleep 2
-touch a/b
-
-tar ufv arc a
-echo "separator"
-tar tf arc | sort || exit 1
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'a `...` command substitution' "update02.at:29"
+( $at_check_trace;
 mkdir v7
 (cd v7
 TEST_TAR_FORMAT=v7
@@ -35620,11 +25966,11 @@ touch a/b
 tar ufv arc a
 echo "separator"
 tar tf arc | sort || exit 1
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "separator
 a/b
 separator
@@ -35633,12 +25979,11 @@ a/b
 a/b
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/update02.at:29"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/update02.at:29"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/update02.at:29:
 mkdir oldgnu
 (cd oldgnu
@@ -35649,7 +25994,7 @@ export TAR_OPTIONS
 rm -rf *
 
 
-test -z "`sort < /dev/null 2>&1`" || exit 77
+test -z \"\`sort < /dev/null 2>&1\`\" || exit 77
 
 mkdir a
 genfile --file a/b
@@ -35665,39 +26010,8 @@ tar ufv arc a
 echo \"separator\"
 tar tf arc | sort || exit 1
 )"
-echo update02.at:29 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir oldgnu
-(cd oldgnu
-TEST_TAR_FORMAT=oldgnu
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H oldgnu"
-export TAR_OPTIONS
-rm -rf *
-
-
-test -z "`sort < /dev/null 2>&1`" || exit 77
-
-mkdir a
-genfile --file a/b
-
-tar cf arc a
-
-echo "separator"
-
-sleep 2
-touch a/b
-
-tar ufv arc a
-echo "separator"
-tar tf arc | sort || exit 1
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'a `...` command substitution' "update02.at:29"
+( $at_check_trace;
 mkdir oldgnu
 (cd oldgnu
 TEST_TAR_FORMAT=oldgnu
@@ -35722,11 +26036,11 @@ touch a/b
 tar ufv arc a
 echo "separator"
 tar tf arc | sort || exit 1
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "separator
 a/b
 separator
@@ -35735,12 +26049,11 @@ a/b
 a/b
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/update02.at:29"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/update02.at:29"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/update02.at:29:
 mkdir ustar
 (cd ustar
@@ -35751,7 +26064,7 @@ export TAR_OPTIONS
 rm -rf *
 
 
-test -z "`sort < /dev/null 2>&1`" || exit 77
+test -z \"\`sort < /dev/null 2>&1\`\" || exit 77
 
 mkdir a
 genfile --file a/b
@@ -35767,39 +26080,8 @@ tar ufv arc a
 echo \"separator\"
 tar tf arc | sort || exit 1
 )"
-echo update02.at:29 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir ustar
-(cd ustar
-TEST_TAR_FORMAT=ustar
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H ustar"
-export TAR_OPTIONS
-rm -rf *
-
-
-test -z "`sort < /dev/null 2>&1`" || exit 77
-
-mkdir a
-genfile --file a/b
-
-tar cf arc a
-
-echo "separator"
-
-sleep 2
-touch a/b
-
-tar ufv arc a
-echo "separator"
-tar tf arc | sort || exit 1
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'a `...` command substitution' "update02.at:29"
+( $at_check_trace;
 mkdir ustar
 (cd ustar
 TEST_TAR_FORMAT=ustar
@@ -35824,11 +26106,11 @@ touch a/b
 tar ufv arc a
 echo "separator"
 tar tf arc | sort || exit 1
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "separator
 a/b
 separator
@@ -35837,12 +26119,11 @@ a/b
 a/b
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/update02.at:29"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/update02.at:29"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/update02.at:29:
 mkdir posix
 (cd posix
@@ -35853,7 +26134,7 @@ export TAR_OPTIONS
 rm -rf *
 
 
-test -z "`sort < /dev/null 2>&1`" || exit 77
+test -z \"\`sort < /dev/null 2>&1\`\" || exit 77
 
 mkdir a
 genfile --file a/b
@@ -35869,39 +26150,8 @@ tar ufv arc a
 echo \"separator\"
 tar tf arc | sort || exit 1
 )"
-echo update02.at:29 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir posix
-(cd posix
-TEST_TAR_FORMAT=posix
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H posix"
-export TAR_OPTIONS
-rm -rf *
-
-
-test -z "`sort < /dev/null 2>&1`" || exit 77
-
-mkdir a
-genfile --file a/b
-
-tar cf arc a
-
-echo "separator"
-
-sleep 2
-touch a/b
-
-tar ufv arc a
-echo "separator"
-tar tf arc | sort || exit 1
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'a `...` command substitution' "update02.at:29"
+( $at_check_trace;
 mkdir posix
 (cd posix
 TEST_TAR_FORMAT=posix
@@ -35926,11 +26176,11 @@ touch a/b
 tar ufv arc a
 echo "separator"
 tar tf arc | sort || exit 1
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "separator
 a/b
 separator
@@ -35939,71 +26189,39 @@ a/b
 a/b
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/update02.at:29"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/update02.at:29"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
-$as_echo "$at_srcdir/update02.at:29:
-mkdir gnu
-(cd gnu
-TEST_TAR_FORMAT=gnu
-export TEST_TAR_FORMAT
-TAR_OPTIONS=\"-H gnu\"
-export TAR_OPTIONS
-rm -rf *
-
-
-test -z "`sort < /dev/null 2>&1`" || exit 77
-
-mkdir a
-genfile --file a/b
-
-tar cf arc a
-
-echo \"separator\"
-
-sleep 2
-touch a/b
-
-tar ufv arc a
-echo \"separator\"
-tar tf arc | sort || exit 1
-)"
-echo update02.at:29 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
+              { set +x
+$as_echo "$at_srcdir/update02.at:29:
 mkdir gnu
 (cd gnu
 TEST_TAR_FORMAT=gnu
 export TEST_TAR_FORMAT
-TAR_OPTIONS="-H gnu"
+TAR_OPTIONS=\"-H gnu\"
 export TAR_OPTIONS
 rm -rf *
 
 
-test -z "`sort < /dev/null 2>&1`" || exit 77
+test -z \"\`sort < /dev/null 2>&1\`\" || exit 77
 
 mkdir a
 genfile --file a/b
 
 tar cf arc a
 
-echo "separator"
+echo \"separator\"
 
 sleep 2
 touch a/b
 
 tar ufv arc a
-echo "separator"
+echo \"separator\"
 tar tf arc | sort || exit 1
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+)"
+at_fn_check_prepare_notrace 'a `...` command substitution' "update02.at:29"
+( $at_check_trace;
 mkdir gnu
 (cd gnu
 TEST_TAR_FORMAT=gnu
@@ -36028,11 +26246,11 @@ touch a/b
 tar ufv arc a
 echo "separator"
 tar tf arc | sort || exit 1
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "separator
 a/b
 separator
@@ -36041,36 +26259,32 @@ a/b
 a/b
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/update02.at:29"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/update02.at:29"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
 
 
 
-  $at_traceoff
+  set +x
   $at_times_p && times >"$at_times_file"
-) 5>&1 2>&1 | eval $at_tee_pipe
-at_status=`cat "$at_status_file"`
+) 5>&1 2>&1 7>&- | eval $at_tee_pipe
+read at_status <"$at_status_file"
 #AT_STOP_101
 #AT_START_102
-# 102. volume.at:23: volume
-at_setup_line='volume.at:23'
-at_desc="volume"
-$at_quiet $as_echo_n "102: $at_desc                                         "
+at_fn_group_banner 102 'volume.at:23' \
+  "volume" "                                         "
 at_xfail=no
       test -f $XFAILFILE && at_xfail=yes
-echo "#                             -*- compilation -*-" >> "$at_group_log"
 (
-  $as_echo "102. volume.at:23: testing ..."
+  $as_echo "102. $at_setup_line: testing $at_desc ..."
   $at_traceon
 
 
 
 
 
-  { $at_traceoff
+  { set +x
 $as_echo "$at_srcdir/volume.at:26:
 mkdir gnu
 (cd gnu
@@ -36096,38 +26310,8 @@ echo 1>&2 -----
 tar xfV archive babel
 test \$? = 2
 )"
-echo volume.at:26 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir gnu
-(cd gnu
-TEST_TAR_FORMAT=gnu
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H gnu"
-export TAR_OPTIONS
-rm -rf *
-
-tar -cf archive -V label -T /dev/null || exit 1
-
-tar xfV archive label || exit 1
-tar xfV archive 'la?el' || exit 1
-tar xfV archive 'l*l' || exit 1
-
-echo 1>&2 -----
-tar xfV archive lab
-test $? = 2 || exit 1
-echo 1>&2 -----
-tar xfV archive bel
-test $? = 2 || exit 1
-echo 1>&2 -----
-tar xfV archive babel
-test $? = 2
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'an embedded newline' "volume.at:26"
+( $at_check_trace;
 mkdir gnu
 (cd gnu
 TEST_TAR_FORMAT=gnu
@@ -36151,10 +26335,10 @@ test $? = 2 || exit 1
 echo 1>&2 -----
 tar xfV archive babel
 test $? = 2
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
 echo >>"$at_stderr"; $as_echo "-----
 tar: Volume \`label' does not match \`lab'
 tar: Error is not recoverable: exiting now
@@ -36166,13 +26350,12 @@ tar: Volume \`label' does not match \`ba
 tar: Error is not recoverable: exiting now
 " | \
   $at_diff - "$at_stderr" || at_failed=:
-at_func_diff_devnull "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/volume.at:26"
-
-$at_failed && at_func_log_failure
+at_fn_diff_devnull "$at_stdout" || at_failed=:
+at_fn_check_status 0 $at_status "$at_srcdir/volume.at:26"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/volume.at:26:
 mkdir oldgnu
 (cd oldgnu
@@ -36198,38 +26381,8 @@ echo 1>&2 -----
 tar xfV archive babel
 test \$? = 2
 )"
-echo volume.at:26 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir oldgnu
-(cd oldgnu
-TEST_TAR_FORMAT=oldgnu
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H oldgnu"
-export TAR_OPTIONS
-rm -rf *
-
-tar -cf archive -V label -T /dev/null || exit 1
-
-tar xfV archive label || exit 1
-tar xfV archive 'la?el' || exit 1
-tar xfV archive 'l*l' || exit 1
-
-echo 1>&2 -----
-tar xfV archive lab
-test $? = 2 || exit 1
-echo 1>&2 -----
-tar xfV archive bel
-test $? = 2 || exit 1
-echo 1>&2 -----
-tar xfV archive babel
-test $? = 2
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'an embedded newline' "volume.at:26"
+( $at_check_trace;
 mkdir oldgnu
 (cd oldgnu
 TEST_TAR_FORMAT=oldgnu
@@ -36253,10 +26406,10 @@ test $? = 2 || exit 1
 echo 1>&2 -----
 tar xfV archive babel
 test $? = 2
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
 echo >>"$at_stderr"; $as_echo "-----
 tar: Volume \`label' does not match \`lab'
 tar: Error is not recoverable: exiting now
@@ -36268,37 +26421,33 @@ tar: Volume \`label' does not match \`ba
 tar: Error is not recoverable: exiting now
 " | \
   $at_diff - "$at_stderr" || at_failed=:
-at_func_diff_devnull "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/volume.at:26"
-
-$at_failed && at_func_log_failure
+at_fn_diff_devnull "$at_stdout" || at_failed=:
+at_fn_check_status 0 $at_status "$at_srcdir/volume.at:26"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
 
 
 
-  $at_traceoff
+  set +x
   $at_times_p && times >"$at_times_file"
-) 5>&1 2>&1 | eval $at_tee_pipe
-at_status=`cat "$at_status_file"`
+) 5>&1 2>&1 7>&- | eval $at_tee_pipe
+read at_status <"$at_status_file"
 #AT_STOP_102
 #AT_START_103
-# 103. volsize.at:29: volume header size
-at_setup_line='volsize.at:29'
-at_desc="volume header size"
-$at_quiet $as_echo_n "103: $at_desc                             "
+at_fn_group_banner 103 'volsize.at:29' \
+  "volume header size" "                             "
 at_xfail=no
       test -f $XFAILFILE && at_xfail=yes
-echo "#                             -*- compilation -*-" >> "$at_group_log"
 (
-  $as_echo "103. volsize.at:29: testing ..."
+  $as_echo "103. $at_setup_line: testing $at_desc ..."
   $at_traceon
 
 
 
 
 
-  { $at_traceoff
+  { set +x
 $as_echo "$at_srcdir/volsize.at:32:
 mkdir v7
 (cd v7
@@ -36309,11 +26458,11 @@ export TAR_OPTIONS
 rm -rf *
 
 
-test -z "`sort < /dev/null 2>&1`" || exit 77
+test -z \"\`sort < /dev/null 2>&1\`\" || exit 77
 
 
-test -z "$TEST_DATA_DIR" && exit 77
-tarball_prereq abc.tar 540f196ceddcad9e7bd2f2d7533d0474 $TEST_DATA_DIR $TEST_DATA_URL || exit 77
+test -z \"\$TEST_DATA_DIR\" && exit 77
+tarball_prereq abc.tar 540f196ceddcad9e7bd2f2d7533d0474 \$TEST_DATA_DIR \$TEST_DATA_URL || exit 77
 
 echo Short Listing
 tar tf \$TEST_DATA_DIR/abc.tar
@@ -36323,37 +26472,8 @@ echo Extracted directory
 tar xf \$TEST_DATA_DIR/abc.tar
 find abc|sort
 )"
-echo volsize.at:32 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir v7
-(cd v7
-TEST_TAR_FORMAT=v7
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H v7"
-export TAR_OPTIONS
-rm -rf *
-
-
-test -z "`sort < /dev/null 2>&1`" || exit 77
-
-
-test -z "$TEST_DATA_DIR" && exit 77
-tarball_prereq abc.tar 540f196ceddcad9e7bd2f2d7533d0474 $TEST_DATA_DIR $TEST_DATA_URL || exit 77
-
-echo Short Listing
-tar tf $TEST_DATA_DIR/abc.tar
-echo Verbose Listing
-tar --utc -tvf $TEST_DATA_DIR/abc.tar
-echo Extracted directory
-tar xf $TEST_DATA_DIR/abc.tar
-find abc|sort
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'a `...` command substitution' "volsize.at:32"
+( $at_check_trace;
 mkdir v7
 (cd v7
 TEST_TAR_FORMAT=v7
@@ -36376,11 +26496,11 @@ tar --utc -tvf $TEST_DATA_DIR/abc.tar
 echo Extracted directory
 tar xf $TEST_DATA_DIR/abc.tar
 find abc|sort
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "Short Listing
 abc/not-a-file.gif
 abc/CCC
@@ -36392,12 +26512,11 @@ abc
 abc/CCC
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/volsize.at:32"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/volsize.at:32"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/volsize.at:32:
 mkdir oldgnu
 (cd oldgnu
@@ -36408,11 +26527,11 @@ export TAR_OPTIONS
 rm -rf *
 
 
-test -z "`sort < /dev/null 2>&1`" || exit 77
+test -z \"\`sort < /dev/null 2>&1\`\" || exit 77
 
 
-test -z "$TEST_DATA_DIR" && exit 77
-tarball_prereq abc.tar 540f196ceddcad9e7bd2f2d7533d0474 $TEST_DATA_DIR $TEST_DATA_URL || exit 77
+test -z \"\$TEST_DATA_DIR\" && exit 77
+tarball_prereq abc.tar 540f196ceddcad9e7bd2f2d7533d0474 \$TEST_DATA_DIR \$TEST_DATA_URL || exit 77
 
 echo Short Listing
 tar tf \$TEST_DATA_DIR/abc.tar
@@ -36422,37 +26541,8 @@ echo Extracted directory
 tar xf \$TEST_DATA_DIR/abc.tar
 find abc|sort
 )"
-echo volsize.at:32 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir oldgnu
-(cd oldgnu
-TEST_TAR_FORMAT=oldgnu
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H oldgnu"
-export TAR_OPTIONS
-rm -rf *
-
-
-test -z "`sort < /dev/null 2>&1`" || exit 77
-
-
-test -z "$TEST_DATA_DIR" && exit 77
-tarball_prereq abc.tar 540f196ceddcad9e7bd2f2d7533d0474 $TEST_DATA_DIR $TEST_DATA_URL || exit 77
-
-echo Short Listing
-tar tf $TEST_DATA_DIR/abc.tar
-echo Verbose Listing
-tar --utc -tvf $TEST_DATA_DIR/abc.tar
-echo Extracted directory
-tar xf $TEST_DATA_DIR/abc.tar
-find abc|sort
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'a `...` command substitution' "volsize.at:32"
+( $at_check_trace;
 mkdir oldgnu
 (cd oldgnu
 TEST_TAR_FORMAT=oldgnu
@@ -36475,11 +26565,11 @@ tar --utc -tvf $TEST_DATA_DIR/abc.tar
 echo Extracted directory
 tar xf $TEST_DATA_DIR/abc.tar
 find abc|sort
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "Short Listing
 abc/not-a-file.gif
 abc/CCC
@@ -36491,12 +26581,11 @@ abc
 abc/CCC
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/volsize.at:32"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/volsize.at:32"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/volsize.at:32:
 mkdir ustar
 (cd ustar
@@ -36507,11 +26596,11 @@ export TAR_OPTIONS
 rm -rf *
 
 
-test -z "`sort < /dev/null 2>&1`" || exit 77
+test -z \"\`sort < /dev/null 2>&1\`\" || exit 77
 
 
-test -z "$TEST_DATA_DIR" && exit 77
-tarball_prereq abc.tar 540f196ceddcad9e7bd2f2d7533d0474 $TEST_DATA_DIR $TEST_DATA_URL || exit 77
+test -z \"\$TEST_DATA_DIR\" && exit 77
+tarball_prereq abc.tar 540f196ceddcad9e7bd2f2d7533d0474 \$TEST_DATA_DIR \$TEST_DATA_URL || exit 77
 
 echo Short Listing
 tar tf \$TEST_DATA_DIR/abc.tar
@@ -36521,11 +26610,8 @@ echo Extracted directory
 tar xf \$TEST_DATA_DIR/abc.tar
 find abc|sort
 )"
-echo volsize.at:32 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
+at_fn_check_prepare_notrace 'a `...` command substitution' "volsize.at:32"
+( $at_check_trace;
 mkdir ustar
 (cd ustar
 TEST_TAR_FORMAT=ustar
@@ -36548,37 +26634,11 @@ tar --utc -tvf $TEST_DATA_DIR/abc.tar
 echo Extracted directory
 tar xf $TEST_DATA_DIR/abc.tar
 find abc|sort
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
-mkdir ustar
-(cd ustar
-TEST_TAR_FORMAT=ustar
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H ustar"
-export TAR_OPTIONS
-rm -rf *
-
-
-test -z "`sort < /dev/null 2>&1`" || exit 77
-
-
-test -z "$TEST_DATA_DIR" && exit 77
-tarball_prereq abc.tar 540f196ceddcad9e7bd2f2d7533d0474 $TEST_DATA_DIR $TEST_DATA_URL || exit 77
-
-echo Short Listing
-tar tf $TEST_DATA_DIR/abc.tar
-echo Verbose Listing
-tar --utc -tvf $TEST_DATA_DIR/abc.tar
-echo Extracted directory
-tar xf $TEST_DATA_DIR/abc.tar
-find abc|sort
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "Short Listing
 abc/not-a-file.gif
 abc/CCC
@@ -36590,12 +26650,11 @@ abc
 abc/CCC
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/volsize.at:32"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/volsize.at:32"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/volsize.at:32:
 mkdir posix
 (cd posix
@@ -36606,11 +26665,11 @@ export TAR_OPTIONS
 rm -rf *
 
 
-test -z "`sort < /dev/null 2>&1`" || exit 77
+test -z \"\`sort < /dev/null 2>&1\`\" || exit 77
 
 
-test -z "$TEST_DATA_DIR" && exit 77
-tarball_prereq abc.tar 540f196ceddcad9e7bd2f2d7533d0474 $TEST_DATA_DIR $TEST_DATA_URL || exit 77
+test -z \"\$TEST_DATA_DIR\" && exit 77
+tarball_prereq abc.tar 540f196ceddcad9e7bd2f2d7533d0474 \$TEST_DATA_DIR \$TEST_DATA_URL || exit 77
 
 echo Short Listing
 tar tf \$TEST_DATA_DIR/abc.tar
@@ -36620,37 +26679,8 @@ echo Extracted directory
 tar xf \$TEST_DATA_DIR/abc.tar
 find abc|sort
 )"
-echo volsize.at:32 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir posix
-(cd posix
-TEST_TAR_FORMAT=posix
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H posix"
-export TAR_OPTIONS
-rm -rf *
-
-
-test -z "`sort < /dev/null 2>&1`" || exit 77
-
-
-test -z "$TEST_DATA_DIR" && exit 77
-tarball_prereq abc.tar 540f196ceddcad9e7bd2f2d7533d0474 $TEST_DATA_DIR $TEST_DATA_URL || exit 77
-
-echo Short Listing
-tar tf $TEST_DATA_DIR/abc.tar
-echo Verbose Listing
-tar --utc -tvf $TEST_DATA_DIR/abc.tar
-echo Extracted directory
-tar xf $TEST_DATA_DIR/abc.tar
-find abc|sort
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'a `...` command substitution' "volsize.at:32"
+( $at_check_trace;
 mkdir posix
 (cd posix
 TEST_TAR_FORMAT=posix
@@ -36673,11 +26703,11 @@ tar --utc -tvf $TEST_DATA_DIR/abc.tar
 echo Extracted directory
 tar xf $TEST_DATA_DIR/abc.tar
 find abc|sort
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "Short Listing
 abc/not-a-file.gif
 abc/CCC
@@ -36689,12 +26719,11 @@ abc
 abc/CCC
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/volsize.at:32"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/volsize.at:32"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/volsize.at:32:
 mkdir gnu
 (cd gnu
@@ -36705,11 +26734,11 @@ export TAR_OPTIONS
 rm -rf *
 
 
-test -z "`sort < /dev/null 2>&1`" || exit 77
+test -z \"\`sort < /dev/null 2>&1\`\" || exit 77
 
 
-test -z "$TEST_DATA_DIR" && exit 77
-tarball_prereq abc.tar 540f196ceddcad9e7bd2f2d7533d0474 $TEST_DATA_DIR $TEST_DATA_URL || exit 77
+test -z \"\$TEST_DATA_DIR\" && exit 77
+tarball_prereq abc.tar 540f196ceddcad9e7bd2f2d7533d0474 \$TEST_DATA_DIR \$TEST_DATA_URL || exit 77
 
 echo Short Listing
 tar tf \$TEST_DATA_DIR/abc.tar
@@ -36719,37 +26748,8 @@ echo Extracted directory
 tar xf \$TEST_DATA_DIR/abc.tar
 find abc|sort
 )"
-echo volsize.at:32 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir gnu
-(cd gnu
-TEST_TAR_FORMAT=gnu
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H gnu"
-export TAR_OPTIONS
-rm -rf *
-
-
-test -z "`sort < /dev/null 2>&1`" || exit 77
-
-
-test -z "$TEST_DATA_DIR" && exit 77
-tarball_prereq abc.tar 540f196ceddcad9e7bd2f2d7533d0474 $TEST_DATA_DIR $TEST_DATA_URL || exit 77
-
-echo Short Listing
-tar tf $TEST_DATA_DIR/abc.tar
-echo Verbose Listing
-tar --utc -tvf $TEST_DATA_DIR/abc.tar
-echo Extracted directory
-tar xf $TEST_DATA_DIR/abc.tar
-find abc|sort
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'a `...` command substitution' "volsize.at:32"
+( $at_check_trace;
 mkdir gnu
 (cd gnu
 TEST_TAR_FORMAT=gnu
@@ -36772,11 +26772,11 @@ tar --utc -tvf $TEST_DATA_DIR/abc.tar
 echo Extracted directory
 tar xf $TEST_DATA_DIR/abc.tar
 find abc|sort
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "Short Listing
 abc/not-a-file.gif
 abc/CCC
@@ -36788,29 +26788,25 @@ abc
 abc/CCC
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/volsize.at:32"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/volsize.at:32"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
 
 
 
-  $at_traceoff
+  set +x
   $at_times_p && times >"$at_times_file"
-) 5>&1 2>&1 | eval $at_tee_pipe
-at_status=`cat "$at_status_file"`
+) 5>&1 2>&1 7>&- | eval $at_tee_pipe
+read at_status <"$at_status_file"
 #AT_STOP_103
 #AT_START_104
-# 104. comprec.at:21: compressed format recognition
-at_setup_line='comprec.at:21'
-at_desc="compressed format recognition"
-$at_quiet $as_echo_n "104: $at_desc                  "
+at_fn_group_banner 104 'comprec.at:21' \
+  "compressed format recognition" "                  "
 at_xfail=no
       test -f $XFAILFILE && at_xfail=yes
-echo "#                             -*- compilation -*-" >> "$at_group_log"
 (
-  $as_echo "104. comprec.at:21: testing ..."
+  $as_echo "104. $at_setup_line: testing $at_desc ..."
   $at_traceon
 
 
@@ -36818,7 +26814,7 @@ echo "#                             -*-
 
 
 
-  { $at_traceoff
+  { set +x
 $as_echo "$at_srcdir/comprec.at:25:
 mkdir v7
 (cd v7
@@ -36839,33 +26835,8 @@ mv file1 orig
 tar xfv archive --warning=no-timestamp
 cmp orig file1
 )"
-echo comprec.at:25 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir v7
-(cd v7
-TEST_TAR_FORMAT=v7
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H v7"
-export TAR_OPTIONS
-rm -rf *
-
-
-cat /dev/null | gzip - > /dev/null 2>&1 || exit 77
-
-genfile --length 10240 --file file1
-echo "separator"
-tar cfz archive file1
-echo "separator"
-mv file1 orig
-tar xfv archive --warning=no-timestamp
-cmp orig file1
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'an embedded newline' "comprec.at:25"
+( $at_check_trace;
 mkdir v7
 (cd v7
 TEST_TAR_FORMAT=v7
@@ -36884,52 +26855,27 @@ echo "separator"
 mv file1 orig
 tar xfv archive --warning=no-timestamp
 cmp orig file1
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "separator
 separator
 file1
 " | \
-  $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/comprec.at:25"
-
-$at_failed && at_func_log_failure
-$at_traceon; }
-
-              { $at_traceoff
-$as_echo "$at_srcdir/comprec.at:25:
-mkdir oldgnu
-(cd oldgnu
-TEST_TAR_FORMAT=oldgnu
-export TEST_TAR_FORMAT
-TAR_OPTIONS=\"-H oldgnu\"
-export TAR_OPTIONS
-rm -rf *
-
-
-cat /dev/null | gzip - > /dev/null 2>&1 || exit 77
-
-genfile --length 10240 --file file1
-echo \"separator\"
-tar cfz archive file1
-echo \"separator\"
-mv file1 orig
-tar xfv archive --warning=no-timestamp
-cmp orig file1
-)"
-echo comprec.at:25 >"$at_check_line_file"
+  $at_diff - "$at_stdout" || at_failed=:
+at_fn_check_status 0 $at_status "$at_srcdir/comprec.at:25"
+$at_failed && at_fn_log_failure
+$at_traceon; }
 
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
+              { set +x
+$as_echo "$at_srcdir/comprec.at:25:
 mkdir oldgnu
 (cd oldgnu
 TEST_TAR_FORMAT=oldgnu
 export TEST_TAR_FORMAT
-TAR_OPTIONS="-H oldgnu"
+TAR_OPTIONS=\"-H oldgnu\"
 export TAR_OPTIONS
 rm -rf *
 
@@ -36937,16 +26883,15 @@ rm -rf *
 cat /dev/null | gzip - > /dev/null 2>&1 || exit 77
 
 genfile --length 10240 --file file1
-echo "separator"
+echo \"separator\"
 tar cfz archive file1
-echo "separator"
+echo \"separator\"
 mv file1 orig
 tar xfv archive --warning=no-timestamp
 cmp orig file1
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+)"
+at_fn_check_prepare_notrace 'an embedded newline' "comprec.at:25"
+( $at_check_trace;
 mkdir oldgnu
 (cd oldgnu
 TEST_TAR_FORMAT=oldgnu
@@ -36965,22 +26910,21 @@ echo "separator"
 mv file1 orig
 tar xfv archive --warning=no-timestamp
 cmp orig file1
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "separator
 separator
 file1
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/comprec.at:25"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/comprec.at:25"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/comprec.at:25:
 mkdir ustar
 (cd ustar
@@ -37001,33 +26945,8 @@ mv file1 orig
 tar xfv archive --warning=no-timestamp
 cmp orig file1
 )"
-echo comprec.at:25 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir ustar
-(cd ustar
-TEST_TAR_FORMAT=ustar
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H ustar"
-export TAR_OPTIONS
-rm -rf *
-
-
-cat /dev/null | gzip - > /dev/null 2>&1 || exit 77
-
-genfile --length 10240 --file file1
-echo "separator"
-tar cfz archive file1
-echo "separator"
-mv file1 orig
-tar xfv archive --warning=no-timestamp
-cmp orig file1
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'an embedded newline' "comprec.at:25"
+( $at_check_trace;
 mkdir ustar
 (cd ustar
 TEST_TAR_FORMAT=ustar
@@ -37046,22 +26965,21 @@ echo "separator"
 mv file1 orig
 tar xfv archive --warning=no-timestamp
 cmp orig file1
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "separator
 separator
 file1
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/comprec.at:25"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/comprec.at:25"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/comprec.at:25:
 mkdir posix
 (cd posix
@@ -37082,33 +27000,8 @@ mv file1 orig
 tar xfv archive --warning=no-timestamp
 cmp orig file1
 )"
-echo comprec.at:25 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir posix
-(cd posix
-TEST_TAR_FORMAT=posix
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H posix"
-export TAR_OPTIONS
-rm -rf *
-
-
-cat /dev/null | gzip - > /dev/null 2>&1 || exit 77
-
-genfile --length 10240 --file file1
-echo "separator"
-tar cfz archive file1
-echo "separator"
-mv file1 orig
-tar xfv archive --warning=no-timestamp
-cmp orig file1
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'an embedded newline' "comprec.at:25"
+( $at_check_trace;
 mkdir posix
 (cd posix
 TEST_TAR_FORMAT=posix
@@ -37127,22 +27020,21 @@ echo "separator"
 mv file1 orig
 tar xfv archive --warning=no-timestamp
 cmp orig file1
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "separator
 separator
 file1
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/comprec.at:25"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/comprec.at:25"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/comprec.at:25:
 mkdir gnu
 (cd gnu
@@ -37163,33 +27055,8 @@ mv file1 orig
 tar xfv archive --warning=no-timestamp
 cmp orig file1
 )"
-echo comprec.at:25 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir gnu
-(cd gnu
-TEST_TAR_FORMAT=gnu
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H gnu"
-export TAR_OPTIONS
-rm -rf *
-
-
-cat /dev/null | gzip - > /dev/null 2>&1 || exit 77
-
-genfile --length 10240 --file file1
-echo "separator"
-tar cfz archive file1
-echo "separator"
-mv file1 orig
-tar xfv archive --warning=no-timestamp
-cmp orig file1
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'an embedded newline' "comprec.at:25"
+( $at_check_trace;
 mkdir gnu
 (cd gnu
 TEST_TAR_FORMAT=gnu
@@ -37208,46 +27075,42 @@ echo "separator"
 mv file1 orig
 tar xfv archive --warning=no-timestamp
 cmp orig file1
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "separator
 separator
 file1
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/comprec.at:25"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/comprec.at:25"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
 
 
 
-  $at_traceoff
+  set +x
   $at_times_p && times >"$at_times_file"
-) 5>&1 2>&1 | eval $at_tee_pipe
-at_status=`cat "$at_status_file"`
+) 5>&1 2>&1 7>&- | eval $at_tee_pipe
+read at_status <"$at_status_file"
 #AT_STOP_104
 #AT_START_105
-# 105. shortfile.at:26: short input files
-at_setup_line='shortfile.at:26'
-at_desc="short input files"
-$at_quiet $as_echo_n "105: $at_desc                              "
+at_fn_group_banner 105 'shortfile.at:26' \
+  "short input files" "                              "
 at_xfail=no
       test -f $XFAILFILE && at_xfail=yes
-echo "#                             -*- compilation -*-" >> "$at_group_log"
 (
-  $as_echo "105. shortfile.at:26: testing ..."
+  $as_echo "105. $at_setup_line: testing $at_desc ..."
   $at_traceon
 
 
 
 
 
-  { $at_traceoff
+  { set +x
 $as_echo "$at_srcdir/shortfile.at:29:
 mkdir gnu
 (cd gnu
@@ -37260,11 +27123,8 @@ rm -rf *
 genfile --length 511 --file foo || exit 5
 tar tf foo
 )"
-echo shortfile.at:29 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
+at_fn_check_prepare_notrace 'an embedded newline' "shortfile.at:29"
+( $at_check_trace;
 mkdir gnu
 (cd gnu
 TEST_TAR_FORMAT=gnu
@@ -37275,59 +27135,41 @@ rm -rf *
 
 genfile --length 511 --file foo || exit 5
 tar tf foo
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
-mkdir gnu
-(cd gnu
-TEST_TAR_FORMAT=gnu
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H gnu"
-export TAR_OPTIONS
-rm -rf *
-
-genfile --length 511 --file foo || exit 5
-tar tf foo
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
 echo >>"$at_stderr"; $as_echo "tar: This does not look like a tar archive
 tar: Exiting with failure status due to previous errors
 " | \
   $at_diff - "$at_stderr" || at_failed=:
-at_func_diff_devnull "$at_stdout" || at_failed=:
-at_func_check_status 2 $at_status "$at_srcdir/shortfile.at:29"
-
-$at_failed && at_func_log_failure
+at_fn_diff_devnull "$at_stdout" || at_failed=:
+at_fn_check_status 2 $at_status "$at_srcdir/shortfile.at:29"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
 
 
 
-  $at_traceoff
+  set +x
   $at_times_p && times >"$at_times_file"
-) 5>&1 2>&1 | eval $at_tee_pipe
-at_status=`cat "$at_status_file"`
+) 5>&1 2>&1 7>&- | eval $at_tee_pipe
+read at_status <"$at_status_file"
 #AT_STOP_105
 #AT_START_106
-# 106. shortupd.at:29: updating short archives
-at_setup_line='shortupd.at:29'
-at_desc="updating short archives"
-$at_quiet $as_echo_n "106: $at_desc                        "
+at_fn_group_banner 106 'shortupd.at:29' \
+  "updating short archives" "                        "
 at_xfail=no
       test -f $XFAILFILE && at_xfail=yes
-echo "#                             -*- compilation -*-" >> "$at_group_log"
 (
-  $as_echo "106. shortupd.at:29: testing ..."
+  $as_echo "106. $at_setup_line: testing $at_desc ..."
   $at_traceon
 
 
 
 
 
-  { $at_traceoff
+  { set +x
 $as_echo "$at_srcdir/shortupd.at:32:
 mkdir v7
 (cd v7
@@ -37340,25 +27182,8 @@ rm -rf *
 touch foo
 tar uf archive foo
 )"
-echo shortupd.at:32 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir v7
-(cd v7
-TEST_TAR_FORMAT=v7
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H v7"
-export TAR_OPTIONS
-rm -rf *
-
-touch foo
-tar uf archive foo
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'an embedded newline' "shortupd.at:32"
+( $at_check_trace;
 mkdir v7
 (cd v7
 TEST_TAR_FORMAT=v7
@@ -37369,18 +27194,17 @@ rm -rf *
 
 touch foo
 tar uf archive foo
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
-at_func_diff_devnull "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/shortupd.at:32"
-
-$at_failed && at_func_log_failure
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
+at_fn_diff_devnull "$at_stdout" || at_failed=:
+at_fn_check_status 0 $at_status "$at_srcdir/shortupd.at:32"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/shortupd.at:32:
 mkdir oldgnu
 (cd oldgnu
@@ -37393,25 +27217,8 @@ rm -rf *
 touch foo
 tar uf archive foo
 )"
-echo shortupd.at:32 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir oldgnu
-(cd oldgnu
-TEST_TAR_FORMAT=oldgnu
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H oldgnu"
-export TAR_OPTIONS
-rm -rf *
-
-touch foo
-tar uf archive foo
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'an embedded newline' "shortupd.at:32"
+( $at_check_trace;
 mkdir oldgnu
 (cd oldgnu
 TEST_TAR_FORMAT=oldgnu
@@ -37422,18 +27229,17 @@ rm -rf *
 
 touch foo
 tar uf archive foo
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
-at_func_diff_devnull "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/shortupd.at:32"
-
-$at_failed && at_func_log_failure
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
+at_fn_diff_devnull "$at_stdout" || at_failed=:
+at_fn_check_status 0 $at_status "$at_srcdir/shortupd.at:32"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/shortupd.at:32:
 mkdir ustar
 (cd ustar
@@ -37446,25 +27252,8 @@ rm -rf *
 touch foo
 tar uf archive foo
 )"
-echo shortupd.at:32 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir ustar
-(cd ustar
-TEST_TAR_FORMAT=ustar
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H ustar"
-export TAR_OPTIONS
-rm -rf *
-
-touch foo
-tar uf archive foo
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'an embedded newline' "shortupd.at:32"
+( $at_check_trace;
 mkdir ustar
 (cd ustar
 TEST_TAR_FORMAT=ustar
@@ -37475,18 +27264,17 @@ rm -rf *
 
 touch foo
 tar uf archive foo
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
-at_func_diff_devnull "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/shortupd.at:32"
-
-$at_failed && at_func_log_failure
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
+at_fn_diff_devnull "$at_stdout" || at_failed=:
+at_fn_check_status 0 $at_status "$at_srcdir/shortupd.at:32"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/shortupd.at:32:
 mkdir posix
 (cd posix
@@ -37499,25 +27287,8 @@ rm -rf *
 touch foo
 tar uf archive foo
 )"
-echo shortupd.at:32 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir posix
-(cd posix
-TEST_TAR_FORMAT=posix
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H posix"
-export TAR_OPTIONS
-rm -rf *
-
-touch foo
-tar uf archive foo
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'an embedded newline' "shortupd.at:32"
+( $at_check_trace;
 mkdir posix
 (cd posix
 TEST_TAR_FORMAT=posix
@@ -37528,18 +27299,17 @@ rm -rf *
 
 touch foo
 tar uf archive foo
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
-at_func_diff_devnull "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/shortupd.at:32"
-
-$at_failed && at_func_log_failure
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
+at_fn_diff_devnull "$at_stdout" || at_failed=:
+at_fn_check_status 0 $at_status "$at_srcdir/shortupd.at:32"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/shortupd.at:32:
 mkdir gnu
 (cd gnu
@@ -37552,25 +27322,8 @@ rm -rf *
 touch foo
 tar uf archive foo
 )"
-echo shortupd.at:32 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir gnu
-(cd gnu
-TEST_TAR_FORMAT=gnu
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H gnu"
-export TAR_OPTIONS
-rm -rf *
-
-touch foo
-tar uf archive foo
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'an embedded newline' "shortupd.at:32"
+( $at_check_trace;
 mkdir gnu
 (cd gnu
 TEST_TAR_FORMAT=gnu
@@ -37581,42 +27334,38 @@ rm -rf *
 
 touch foo
 tar uf archive foo
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
-at_func_diff_devnull "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/shortupd.at:32"
-
-$at_failed && at_func_log_failure
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
+at_fn_diff_devnull "$at_stdout" || at_failed=:
+at_fn_check_status 0 $at_status "$at_srcdir/shortupd.at:32"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
 
 
 
-  $at_traceoff
+  set +x
   $at_times_p && times >"$at_times_file"
-) 5>&1 2>&1 | eval $at_tee_pipe
-at_status=`cat "$at_status_file"`
+) 5>&1 2>&1 7>&- | eval $at_tee_pipe
+read at_status <"$at_status_file"
 #AT_STOP_106
 #AT_START_107
-# 107. truncate.at:29: truncate
-at_setup_line='truncate.at:29'
-at_desc="truncate"
-$at_quiet $as_echo_n "107: $at_desc                                       "
+at_fn_group_banner 107 'truncate.at:29' \
+  "truncate" "                                       "
 at_xfail=no
       test -f $XFAILFILE && at_xfail=yes
-echo "#                             -*- compilation -*-" >> "$at_group_log"
 (
-  $as_echo "107. truncate.at:29: testing ..."
+  $as_echo "107. $at_setup_line: testing $at_desc ..."
   $at_traceon
 
 
 
 
 
-  { $at_traceoff
+  { set +x
 $as_echo "$at_srcdir/truncate.at:32:
 mkdir v7
 (cd v7
@@ -37634,30 +27383,8 @@ echo separator
 sleep 1
 genfile --file foo --seek 49995k --length 5k --pattern=zeros
 tar dvf bar)"
-echo truncate.at:32 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir v7
-(cd v7
-TEST_TAR_FORMAT=v7
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H v7"
-export TAR_OPTIONS
-rm -rf *
-
-genfile --file foo --length 50000k
-genfile --file baz
-genfile --run --checkpoint 10 --length 49995k --truncate foo -- tar --checkpoint -vcf bar foo baz
-echo Exit status: $?
-echo separator
-sleep 1
-genfile --file foo --seek 49995k --length 5k --pattern=zeros
-tar dvf bar) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'an embedded newline' "truncate.at:32"
+( $at_check_trace;
 mkdir v7
 (cd v7
 TEST_TAR_FORMAT=v7
@@ -37673,10 +27400,10 @@ echo Exit status: $?
 echo separator
 sleep 1
 genfile --file foo --seek 49995k --length 5k --pattern=zeros
-tar dvf bar) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
+tar dvf bar)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
 echo >>"$at_stderr"; $as_echo "tar: foo: File shrank by 5120 bytes; padding with zeros
 " | \
   $at_diff - "$at_stderr" || at_failed=:
@@ -37689,12 +27416,11 @@ foo: Mod time differs
 baz
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 1 $at_status "$at_srcdir/truncate.at:32"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 1 $at_status "$at_srcdir/truncate.at:32"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/truncate.at:32:
 mkdir oldgnu
 (cd oldgnu
@@ -37712,30 +27438,8 @@ echo separator
 sleep 1
 genfile --file foo --seek 49995k --length 5k --pattern=zeros
 tar dvf bar)"
-echo truncate.at:32 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir oldgnu
-(cd oldgnu
-TEST_TAR_FORMAT=oldgnu
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H oldgnu"
-export TAR_OPTIONS
-rm -rf *
-
-genfile --file foo --length 50000k
-genfile --file baz
-genfile --run --checkpoint 10 --length 49995k --truncate foo -- tar --checkpoint -vcf bar foo baz
-echo Exit status: $?
-echo separator
-sleep 1
-genfile --file foo --seek 49995k --length 5k --pattern=zeros
-tar dvf bar) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'an embedded newline' "truncate.at:32"
+( $at_check_trace;
 mkdir oldgnu
 (cd oldgnu
 TEST_TAR_FORMAT=oldgnu
@@ -37751,10 +27455,10 @@ echo Exit status: $?
 echo separator
 sleep 1
 genfile --file foo --seek 49995k --length 5k --pattern=zeros
-tar dvf bar) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
+tar dvf bar)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
 echo >>"$at_stderr"; $as_echo "tar: foo: File shrank by 5120 bytes; padding with zeros
 " | \
   $at_diff - "$at_stderr" || at_failed=:
@@ -37767,12 +27471,11 @@ foo: Mod time differs
 baz
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 1 $at_status "$at_srcdir/truncate.at:32"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 1 $at_status "$at_srcdir/truncate.at:32"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/truncate.at:32:
 mkdir ustar
 (cd ustar
@@ -37790,30 +27493,8 @@ echo separator
 sleep 1
 genfile --file foo --seek 49995k --length 5k --pattern=zeros
 tar dvf bar)"
-echo truncate.at:32 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir ustar
-(cd ustar
-TEST_TAR_FORMAT=ustar
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H ustar"
-export TAR_OPTIONS
-rm -rf *
-
-genfile --file foo --length 50000k
-genfile --file baz
-genfile --run --checkpoint 10 --length 49995k --truncate foo -- tar --checkpoint -vcf bar foo baz
-echo Exit status: $?
-echo separator
-sleep 1
-genfile --file foo --seek 49995k --length 5k --pattern=zeros
-tar dvf bar) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'an embedded newline' "truncate.at:32"
+( $at_check_trace;
 mkdir ustar
 (cd ustar
 TEST_TAR_FORMAT=ustar
@@ -37829,10 +27510,10 @@ echo Exit status: $?
 echo separator
 sleep 1
 genfile --file foo --seek 49995k --length 5k --pattern=zeros
-tar dvf bar) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
+tar dvf bar)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
 echo >>"$at_stderr"; $as_echo "tar: foo: File shrank by 5120 bytes; padding with zeros
 " | \
   $at_diff - "$at_stderr" || at_failed=:
@@ -37845,12 +27526,11 @@ foo: Mod time differs
 baz
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 1 $at_status "$at_srcdir/truncate.at:32"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 1 $at_status "$at_srcdir/truncate.at:32"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/truncate.at:32:
 mkdir posix
 (cd posix
@@ -37868,30 +27548,8 @@ echo separator
 sleep 1
 genfile --file foo --seek 49995k --length 5k --pattern=zeros
 tar dvf bar)"
-echo truncate.at:32 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir posix
-(cd posix
-TEST_TAR_FORMAT=posix
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H posix"
-export TAR_OPTIONS
-rm -rf *
-
-genfile --file foo --length 50000k
-genfile --file baz
-genfile --run --checkpoint 10 --length 49995k --truncate foo -- tar --checkpoint -vcf bar foo baz
-echo Exit status: $?
-echo separator
-sleep 1
-genfile --file foo --seek 49995k --length 5k --pattern=zeros
-tar dvf bar) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'an embedded newline' "truncate.at:32"
+( $at_check_trace;
 mkdir posix
 (cd posix
 TEST_TAR_FORMAT=posix
@@ -37907,10 +27565,10 @@ echo Exit status: $?
 echo separator
 sleep 1
 genfile --file foo --seek 49995k --length 5k --pattern=zeros
-tar dvf bar) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
+tar dvf bar)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
 echo >>"$at_stderr"; $as_echo "tar: foo: File shrank by 5120 bytes; padding with zeros
 " | \
   $at_diff - "$at_stderr" || at_failed=:
@@ -37923,53 +27581,30 @@ foo: Mod time differs
 baz
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 1 $at_status "$at_srcdir/truncate.at:32"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 1 $at_status "$at_srcdir/truncate.at:32"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/truncate.at:32:
 mkdir gnu
 (cd gnu
 TEST_TAR_FORMAT=gnu
 export TEST_TAR_FORMAT
-TAR_OPTIONS=\"-H gnu\"
-export TAR_OPTIONS
-rm -rf *
-
-genfile --file foo --length 50000k
-genfile --file baz
-genfile --run --checkpoint 10 --length 49995k --truncate foo -- tar --checkpoint -vcf bar foo baz
-echo Exit status: \$?
-echo separator
-sleep 1
-genfile --file foo --seek 49995k --length 5k --pattern=zeros
-tar dvf bar)"
-echo truncate.at:32 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir gnu
-(cd gnu
-TEST_TAR_FORMAT=gnu
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H gnu"
+TAR_OPTIONS=\"-H gnu\"
 export TAR_OPTIONS
 rm -rf *
 
 genfile --file foo --length 50000k
 genfile --file baz
 genfile --run --checkpoint 10 --length 49995k --truncate foo -- tar --checkpoint -vcf bar foo baz
-echo Exit status: $?
+echo Exit status: \$?
 echo separator
 sleep 1
 genfile --file foo --seek 49995k --length 5k --pattern=zeros
-tar dvf bar) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+tar dvf bar)"
+at_fn_check_prepare_notrace 'an embedded newline' "truncate.at:32"
+( $at_check_trace;
 mkdir gnu
 (cd gnu
 TEST_TAR_FORMAT=gnu
@@ -37985,10 +27620,10 @@ echo Exit status: $?
 echo separator
 sleep 1
 genfile --file foo --seek 49995k --length 5k --pattern=zeros
-tar dvf bar) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
+tar dvf bar)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
 echo >>"$at_stderr"; $as_echo "tar: foo: File shrank by 5120 bytes; padding with zeros
 " | \
   $at_diff - "$at_stderr" || at_failed=:
@@ -38001,36 +27636,32 @@ foo: Mod time differs
 baz
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 1 $at_status "$at_srcdir/truncate.at:32"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 1 $at_status "$at_srcdir/truncate.at:32"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
 
 
 
-  $at_traceoff
+  set +x
   $at_times_p && times >"$at_times_file"
-) 5>&1 2>&1 | eval $at_tee_pipe
-at_status=`cat "$at_status_file"`
+) 5>&1 2>&1 7>&- | eval $at_tee_pipe
+read at_status <"$at_status_file"
 #AT_STOP_107
 #AT_START_108
-# 108. grow.at:24: grow
-at_setup_line='grow.at:24'
-at_desc="grow"
-$at_quiet $as_echo_n "108: $at_desc                                           "
+at_fn_group_banner 108 'grow.at:24' \
+  "grow" "                                           "
 at_xfail=no
       test -f $XFAILFILE && at_xfail=yes
-echo "#                             -*- compilation -*-" >> "$at_group_log"
 (
-  $as_echo "108. grow.at:24: testing ..."
+  $as_echo "108. $at_setup_line: testing $at_desc ..."
   $at_traceon
 
 
 
 
 
-  { $at_traceoff
+  { set +x
 $as_echo "$at_srcdir/grow.at:27:
 mkdir v7
 (cd v7
@@ -38044,26 +27675,8 @@ genfile --file foo --length 50000k
 genfile --file baz
 genfile --run --checkpoint 10 --length 1024 --append foo -- tar --checkpoint -vcf bar foo baz
 )"
-echo grow.at:27 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir v7
-(cd v7
-TEST_TAR_FORMAT=v7
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H v7"
-export TAR_OPTIONS
-rm -rf *
-
-genfile --file foo --length 50000k
-genfile --file baz
-genfile --run --checkpoint 10 --length 1024 --append foo -- tar --checkpoint -vcf bar foo baz
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'an embedded newline' "grow.at:27"
+( $at_check_trace;
 mkdir v7
 (cd v7
 TEST_TAR_FORMAT=v7
@@ -38075,10 +27688,10 @@ rm -rf *
 genfile --file foo --length 50000k
 genfile --file baz
 genfile --run --checkpoint 10 --length 1024 --append foo -- tar --checkpoint -vcf bar foo baz
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
 echo >>"$at_stderr"; $as_echo "tar: foo: file changed as we read it
 " | \
   $at_diff - "$at_stderr" || at_failed=:
@@ -38086,12 +27699,11 @@ echo >>"$at_stdout"; $as_echo "foo
 baz
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 1 $at_status "$at_srcdir/grow.at:27"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 1 $at_status "$at_srcdir/grow.at:27"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/grow.at:27:
 mkdir oldgnu
 (cd oldgnu
@@ -38105,26 +27717,8 @@ genfile --file foo --length 50000k
 genfile --file baz
 genfile --run --checkpoint 10 --length 1024 --append foo -- tar --checkpoint -vcf bar foo baz
 )"
-echo grow.at:27 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir oldgnu
-(cd oldgnu
-TEST_TAR_FORMAT=oldgnu
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H oldgnu"
-export TAR_OPTIONS
-rm -rf *
-
-genfile --file foo --length 50000k
-genfile --file baz
-genfile --run --checkpoint 10 --length 1024 --append foo -- tar --checkpoint -vcf bar foo baz
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'an embedded newline' "grow.at:27"
+( $at_check_trace;
 mkdir oldgnu
 (cd oldgnu
 TEST_TAR_FORMAT=oldgnu
@@ -38136,10 +27730,10 @@ rm -rf *
 genfile --file foo --length 50000k
 genfile --file baz
 genfile --run --checkpoint 10 --length 1024 --append foo -- tar --checkpoint -vcf bar foo baz
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
 echo >>"$at_stderr"; $as_echo "tar: foo: file changed as we read it
 " | \
   $at_diff - "$at_stderr" || at_failed=:
@@ -38147,12 +27741,11 @@ echo >>"$at_stdout"; $as_echo "foo
 baz
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 1 $at_status "$at_srcdir/grow.at:27"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 1 $at_status "$at_srcdir/grow.at:27"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/grow.at:27:
 mkdir ustar
 (cd ustar
@@ -38166,26 +27759,8 @@ genfile --file foo --length 50000k
 genfile --file baz
 genfile --run --checkpoint 10 --length 1024 --append foo -- tar --checkpoint -vcf bar foo baz
 )"
-echo grow.at:27 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir ustar
-(cd ustar
-TEST_TAR_FORMAT=ustar
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H ustar"
-export TAR_OPTIONS
-rm -rf *
-
-genfile --file foo --length 50000k
-genfile --file baz
-genfile --run --checkpoint 10 --length 1024 --append foo -- tar --checkpoint -vcf bar foo baz
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'an embedded newline' "grow.at:27"
+( $at_check_trace;
 mkdir ustar
 (cd ustar
 TEST_TAR_FORMAT=ustar
@@ -38197,10 +27772,10 @@ rm -rf *
 genfile --file foo --length 50000k
 genfile --file baz
 genfile --run --checkpoint 10 --length 1024 --append foo -- tar --checkpoint -vcf bar foo baz
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
 echo >>"$at_stderr"; $as_echo "tar: foo: file changed as we read it
 " | \
   $at_diff - "$at_stderr" || at_failed=:
@@ -38208,12 +27783,11 @@ echo >>"$at_stdout"; $as_echo "foo
 baz
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 1 $at_status "$at_srcdir/grow.at:27"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 1 $at_status "$at_srcdir/grow.at:27"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/grow.at:27:
 mkdir posix
 (cd posix
@@ -38227,26 +27801,8 @@ genfile --file foo --length 50000k
 genfile --file baz
 genfile --run --checkpoint 10 --length 1024 --append foo -- tar --checkpoint -vcf bar foo baz
 )"
-echo grow.at:27 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir posix
-(cd posix
-TEST_TAR_FORMAT=posix
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H posix"
-export TAR_OPTIONS
-rm -rf *
-
-genfile --file foo --length 50000k
-genfile --file baz
-genfile --run --checkpoint 10 --length 1024 --append foo -- tar --checkpoint -vcf bar foo baz
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'an embedded newline' "grow.at:27"
+( $at_check_trace;
 mkdir posix
 (cd posix
 TEST_TAR_FORMAT=posix
@@ -38258,10 +27814,10 @@ rm -rf *
 genfile --file foo --length 50000k
 genfile --file baz
 genfile --run --checkpoint 10 --length 1024 --append foo -- tar --checkpoint -vcf bar foo baz
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
 echo >>"$at_stderr"; $as_echo "tar: foo: file changed as we read it
 " | \
   $at_diff - "$at_stderr" || at_failed=:
@@ -38269,12 +27825,11 @@ echo >>"$at_stdout"; $as_echo "foo
 baz
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 1 $at_status "$at_srcdir/grow.at:27"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 1 $at_status "$at_srcdir/grow.at:27"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
-              { $at_traceoff
+              { set +x
 $as_echo "$at_srcdir/grow.at:27:
 mkdir gnu
 (cd gnu
@@ -38288,26 +27843,8 @@ genfile --file foo --length 50000k
 genfile --file baz
 genfile --run --checkpoint 10 --length 1024 --append foo -- tar --checkpoint -vcf bar foo baz
 )"
-echo grow.at:27 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir gnu
-(cd gnu
-TEST_TAR_FORMAT=gnu
-export TEST_TAR_FORMAT
-TAR_OPTIONS="-H gnu"
-export TAR_OPTIONS
-rm -rf *
-
-genfile --file foo --length 50000k
-genfile --file baz
-genfile --run --checkpoint 10 --length 1024 --append foo -- tar --checkpoint -vcf bar foo baz
-) ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'an embedded newline' "grow.at:27"
+( $at_check_trace;
 mkdir gnu
 (cd gnu
 TEST_TAR_FORMAT=gnu
@@ -38319,10 +27856,10 @@ rm -rf *
 genfile --file foo --length 50000k
 genfile --file baz
 genfile --run --checkpoint 10 --length 1024 --append foo -- tar --checkpoint -vcf bar foo baz
-) ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
+)
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
 echo >>"$at_stderr"; $as_echo "tar: foo: file changed as we read it
 " | \
   $at_diff - "$at_stderr" || at_failed=:
@@ -38330,48 +27867,44 @@ echo >>"$at_stdout"; $as_echo "foo
 baz
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 1 $at_status "$at_srcdir/grow.at:27"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 1 $at_status "$at_srcdir/grow.at:27"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
 
 
 
-  $at_traceoff
+  set +x
   $at_times_p && times >"$at_times_file"
-) 5>&1 2>&1 | eval $at_tee_pipe
-at_status=`cat "$at_status_file"`
+) 5>&1 2>&1 7>&- | eval $at_tee_pipe
+read at_status <"$at_status_file"
 #AT_STOP_108
 #AT_START_109
-# 109. remfiles01.at:28: remove-files with compression
-at_setup_line='remfiles01.at:28'
-at_desc="remove-files with compression"
-$at_quiet $as_echo_n "109: $at_desc                  "
+at_fn_group_banner 109 'remfiles01.at:28' \
+  "remove-files with compression" "                  "
 at_xfail=no
-echo "#                             -*- compilation -*-" >> "$at_group_log"
 (
-  $as_echo "109. remfiles01.at:28: testing ..."
+  $as_echo "109. $at_setup_line: testing $at_desc ..."
   $at_traceon
 
 
 
 unset TAR_OPTIONS
-{ $at_traceoff
+{ set +x
 $as_echo "$at_srcdir/remfiles01.at:32:
 
-echo "test" > $$
-chmod 0 $$
-cat $$ > /dev/null 2>&1
-result=$?
-rm -f $$
-test $result -eq 0 && exit 77
+echo \"test\" > \$\$
+chmod 0 \$\$
+cat \$\$ > /dev/null 2>&1
+result=\$?
+rm -f \$\$
+test \$result -eq 0 && exit 77
 
 
 cat /dev/null | gzip - > /dev/null 2>&1 || exit 77
 
 
-test -z "`sort < /dev/null 2>&1`" || exit 77
+test -z \"\`sort < /dev/null 2>&1\`\" || exit 77
 
 
 mkdir dir
@@ -38398,11 +27931,8 @@ rm err
 find . | sort
 exit \$EC
 "
-echo remfiles01.at:32 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
+at_fn_check_prepare_notrace 'a `...` command substitution' "remfiles01.at:32"
+( $at_check_trace;
 
 echo "test" > $$
 chmod 0 $$
@@ -38441,52 +27971,10 @@ sed -n '/(child)/p' err >&2
 rm err
 find . | sort
 exit $EC
- ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
-
-echo "test" > $$
-chmod 0 $$
-cat $$ > /dev/null 2>&1
-result=$?
-rm -f $$
-test $result -eq 0 && exit 77
-
-
-cat /dev/null | gzip - > /dev/null 2>&1 || exit 77
-
-
-test -z "`sort < /dev/null 2>&1`" || exit 77
-
-
-mkdir dir
-cd dir
-genfile --file a --length 0
-chmod 0 a
-genfile --file b
-mkdir c
-
-# Depending on when the SIGPIPE gets delivered, the invocation below
-# may finish with either
-#  tar: a: Cannot write: Broken pipe
-# or
-#  tar: Child returned status 2
 
-# Discard diagnostics that some shells generate about broken pipes,
-# and discard all of tar's diagnostics except for the ones saying "(child)".
-# Gzip's exit code is propagated to the shell.  Usually it is 141.
-# Convert all non-zero exits to 2 to make it predictable.
-(tar -c -f a -z --remove-files b c 2>err || (exit 2) ) 2>/dev/null
-EC=$?
-sed -n '/(child)/p' err >&2
-rm err
-find . | sort
-exit $EC
- ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
 echo >>"$at_stderr"; $as_echo "tar (child): a: Cannot open: Permission denied
 tar (child): Error is not recoverable: exiting now
 " | \
@@ -38497,38 +27985,34 @@ echo >>"$at_stdout"; $as_echo ".
 ./c
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 2 $at_status "$at_srcdir/remfiles01.at:32"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 2 $at_status "$at_srcdir/remfiles01.at:32"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
 
-  $at_traceoff
+  set +x
   $at_times_p && times >"$at_times_file"
-) 5>&1 2>&1 | eval $at_tee_pipe
-at_status=`cat "$at_status_file"`
+) 5>&1 2>&1 7>&- | eval $at_tee_pipe
+read at_status <"$at_status_file"
 #AT_STOP_109
 #AT_START_110
-# 110. remfiles02.at:28: remove-files with compression: grand-child
-at_setup_line='remfiles02.at:28'
-at_desc="remove-files with compression: grand-child"
-$at_quiet $as_echo_n "110: $at_desc     "
+at_fn_group_banner 110 'remfiles02.at:28' \
+  "remove-files with compression: grand-child" "     "
 at_xfail=no
-echo "#                             -*- compilation -*-" >> "$at_group_log"
 (
-  $as_echo "110. remfiles02.at:28: testing ..."
+  $as_echo "110. $at_setup_line: testing $at_desc ..."
   $at_traceon
 
 
 
 unset TAR_OPTIONS
-{ $at_traceoff
+{ set +x
 $as_echo "$at_srcdir/remfiles02.at:32:
 
 cat /dev/null | gzip - > /dev/null 2>&1 || exit 77
 
 
-test -z "`sort < /dev/null 2>&1`" || exit 77
+test -z \"\`sort < /dev/null 2>&1\`\" || exit 77
 
 
 mkdir dir
@@ -38544,11 +28028,8 @@ rm err
 find . | sort
 exit \$EC
 "
-echo remfiles02.at:32 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
+at_fn_check_prepare_notrace 'a `...` command substitution' "remfiles02.at:32"
+( $at_check_trace;
 
 cat /dev/null | gzip - > /dev/null 2>&1 || exit 77
 
@@ -38568,33 +28049,10 @@ sed -n '/(child)/p' err >&2
 rm err
 find . | sort
 exit $EC
- ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
-
-cat /dev/null | gzip - > /dev/null 2>&1 || exit 77
-
-
-test -z "`sort < /dev/null 2>&1`" || exit 77
-
-
-mkdir dir
-cd dir
-mkdir a
-genfile --file b
-mkdir c
 
-tar -c -f a -z --remove-files b c 2>err
-EC=$?
-sed -n '/(child)/p' err >&2
-rm err
-find . | sort
-exit $EC
- ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
 echo >>"$at_stderr"; $as_echo "tar (child): a: Cannot open: Is a directory
 tar (child): Error is not recoverable: exiting now
 " | \
@@ -38605,31 +28063,27 @@ echo >>"$at_stdout"; $as_echo ".
 ./c
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 2 $at_status "$at_srcdir/remfiles02.at:32"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 2 $at_status "$at_srcdir/remfiles02.at:32"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
 
-  $at_traceoff
+  set +x
   $at_times_p && times >"$at_times_file"
-) 5>&1 2>&1 | eval $at_tee_pipe
-at_status=`cat "$at_status_file"`
+) 5>&1 2>&1 7>&- | eval $at_tee_pipe
+read at_status <"$at_status_file"
 #AT_STOP_110
 #AT_START_111
-# 111. remfiles03.at:28: remove-files with symbolic links
-at_setup_line='remfiles03.at:28'
-at_desc="remove-files with symbolic links"
-$at_quiet $as_echo_n "111: $at_desc               "
+at_fn_group_banner 111 'remfiles03.at:28' \
+  "remove-files with symbolic links" "               "
 at_xfail=no
-echo "#                             -*- compilation -*-" >> "$at_group_log"
 (
-  $as_echo "111. remfiles03.at:28: testing ..."
+  $as_echo "111. $at_setup_line: testing $at_desc ..."
   $at_traceon
 
 
 
-{ $at_traceoff
+{ set +x
 $as_echo "$at_srcdir/remfiles03.at:31:
 mkdir a
 mkdir a/b
@@ -38637,53 +28091,37 @@ ln -s b a/c || exit 77
 tar --remove-files -cf a.tar a
 genfile --stat a
 "
-echo remfiles03.at:31 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-mkdir a
-mkdir a/b
-ln -s b a/c || exit 77
-tar --remove-files -cf a.tar a
-genfile --stat a
- ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'an embedded newline' "remfiles03.at:31"
+( $at_check_trace;
 mkdir a
 mkdir a/b
 ln -s b a/c || exit 77
 tar --remove-files -cf a.tar a
 genfile --stat a
- ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
+
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
 echo >>"$at_stderr"; $as_echo "genfile: stat(a) failed: No such file or directory
 " | \
   $at_diff - "$at_stderr" || at_failed=:
-at_func_diff_devnull "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/remfiles03.at:31"
-
-$at_failed && at_func_log_failure
+at_fn_diff_devnull "$at_stdout" || at_failed=:
+at_fn_check_status 0 $at_status "$at_srcdir/remfiles03.at:31"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
 
-  $at_traceoff
+  set +x
   $at_times_p && times >"$at_times_file"
-) 5>&1 2>&1 | eval $at_tee_pipe
-at_status=`cat "$at_status_file"`
+) 5>&1 2>&1 7>&- | eval $at_tee_pipe
+read at_status <"$at_status_file"
 #AT_STOP_111
 #AT_START_112
-# 112. sigpipe.at:19: sigpipe handling
-at_setup_line='sigpipe.at:19'
-at_desc="sigpipe handling"
-$at_quiet $as_echo_n "112: $at_desc                               "
+at_fn_group_banner 112 'sigpipe.at:19' \
+  "sigpipe handling" "                               "
 at_xfail=no
-echo "#                             -*- compilation -*-" >> "$at_group_log"
 (
-  $as_echo "112. sigpipe.at:19: testing ..."
+  $as_echo "112. $at_setup_line: testing $at_desc ..."
   $at_traceon
 
 
@@ -38694,7 +28132,7 @@ echo "#                             -*-
 # References: http://lists.gnu.org/archive/html/bug-tar/2010-03/msg00039.html
 #             <20100319184141.GC30047@wo.int.altlinux.org>
 
-{ $at_traceoff
+{ set +x
 $as_echo "$at_srcdir/sigpipe.at:28:
 genfile --length 2048 --file first
 genfile --length 2048 --file second
@@ -38705,23 +28143,8 @@ tar cf archive first second third
 # Discard diagnostics that some shells generate about broken pipes.
 (tar tf archive 2>&3 | :) 3>&2 2>/dev/null
 "
-echo sigpipe.at:28 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
-genfile --length 2048 --file first
-genfile --length 2048 --file second
-genfile --length 2049 --file third
-
-tar cf archive first second third
-
-# Discard diagnostics that some shells generate about broken pipes.
-(tar tf archive 2>&3 | :) 3>&2 2>/dev/null
- ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
+at_fn_check_prepare_notrace 'an embedded newline' "sigpipe.at:28"
+( $at_check_trace;
 genfile --length 2048 --file first
 genfile --length 2048 --file second
 genfile --length 2049 --file third
@@ -38730,73 +28153,56 @@ tar cf archive first second third
 
 # Discard diagnostics that some shells generate about broken pipes.
 (tar tf archive 2>&3 | :) 3>&2 2>/dev/null
- ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
-at_func_diff_devnull "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/sigpipe.at:28"
 
-$at_failed && at_func_log_failure
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
+at_fn_diff_devnull "$at_stdout" || at_failed=:
+at_fn_check_status 0 $at_status "$at_srcdir/sigpipe.at:28"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
 
-  $at_traceoff
+  set +x
   $at_times_p && times >"$at_times_file"
-) 5>&1 2>&1 | eval $at_tee_pipe
-at_status=`cat "$at_status_file"`
+) 5>&1 2>&1 7>&- | eval $at_tee_pipe
+read at_status <"$at_status_file"
 #AT_STOP_112
 #AT_START_113
-# 113. gtarfail.at:21: gtarfail
-at_setup_line='gtarfail.at:21'
-at_desc="gtarfail"
-$at_quiet $as_echo_n "113: $at_desc                                       "
+at_fn_group_banner 113 'gtarfail.at:21' \
+  "gtarfail" "                                       "
 at_xfail=no
-echo "#                             -*- compilation -*-" >> "$at_group_log"
 (
-  $as_echo "113. gtarfail.at:21: testing ..."
+  $as_echo "113. $at_setup_line: testing $at_desc ..."
   $at_traceon
 
 
 
 unset TAR_OPTIONS
 
-{ $at_traceoff
+{ set +x
 $as_echo "$at_srcdir/gtarfail.at:26:
 
-test -z "$STAR_TESTSCRIPTS" && exit 77
-tarball_prereq gtarfail.tar bf7612e401aaa679edbb07ae1183811b $STAR_TESTSCRIPTS $STAR_DATA_URL || exit 77
+test -z \"\$STAR_TESTSCRIPTS\" && exit 77
+tarball_prereq gtarfail.tar bf7612e401aaa679edbb07ae1183811b \$STAR_TESTSCRIPTS \$STAR_DATA_URL || exit 77
 
 
 tar --utc -tvf \$STAR_TESTSCRIPTS/gtarfail.tar
 "
-echo gtarfail.at:26 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
+at_fn_check_prepare_notrace 'an embedded newline' "gtarfail.at:26"
+( $at_check_trace;
 
 test -z "$STAR_TESTSCRIPTS" && exit 77
 tarball_prereq gtarfail.tar bf7612e401aaa679edbb07ae1183811b $STAR_TESTSCRIPTS $STAR_DATA_URL || exit 77
 
 
 tar --utc -tvf $STAR_TESTSCRIPTS/gtarfail.tar
- ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
-
-test -z "$STAR_TESTSCRIPTS" && exit 77
-tarball_prereq gtarfail.tar bf7612e401aaa679edbb07ae1183811b $STAR_TESTSCRIPTS $STAR_DATA_URL || exit 77
 
-
-tar --utc -tvf $STAR_TESTSCRIPTS/gtarfail.tar
- ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "-rw-r--r-- jes/glone       518 2001-05-25 14:41 vedpowered.gif
 -rw-r--r-- jes/glone      6825 1997-04-29 00:19 cd.gif
 -rw-r--r-- jes/glone     33354 1999-06-22 12:17 DSCN0049c.JPG
@@ -38805,64 +28211,48 @@ echo >>"$at_stdout"; $as_echo "-rw-r--r-
 -rw-rw-rw- jes/glone    148753 1998-09-15 13:08 billyboy.jpg
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/gtarfail.at:26"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/gtarfail.at:26"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
 
-  $at_traceoff
+  set +x
   $at_times_p && times >"$at_times_file"
-) 5>&1 2>&1 | eval $at_tee_pipe
-at_status=`cat "$at_status_file"`
+) 5>&1 2>&1 7>&- | eval $at_tee_pipe
+read at_status <"$at_status_file"
 #AT_STOP_113
 #AT_START_114
-# 114. gtarfail2.at:21: gtarfail2
-at_setup_line='gtarfail2.at:21'
-at_desc="gtarfail2"
-$at_quiet $as_echo_n "114: $at_desc                                      "
+at_fn_group_banner 114 'gtarfail2.at:21' \
+  "gtarfail2" "                                      "
 at_xfail=no
-echo "#                             -*- compilation -*-" >> "$at_group_log"
 (
-  $as_echo "114. gtarfail2.at:21: testing ..."
+  $as_echo "114. $at_setup_line: testing $at_desc ..."
   $at_traceon
 
 
 
 unset TAR_OPTIONS
 
-{ $at_traceoff
+{ set +x
 $as_echo "$at_srcdir/gtarfail2.at:26:
 
-test -z "$STAR_TESTSCRIPTS" && exit 77
-tarball_prereq gtarfail2.tar 6b607d1faec14b82f69525d9c5b66e53 $STAR_TESTSCRIPTS $STAR_DATA_URL || exit 77
+test -z \"\$STAR_TESTSCRIPTS\" && exit 77
+tarball_prereq gtarfail2.tar 6b607d1faec14b82f69525d9c5b66e53 \$STAR_TESTSCRIPTS \$STAR_DATA_URL || exit 77
 
 tar --utc -tvf \$STAR_TESTSCRIPTS/gtarfail2.tar
 "
-echo gtarfail2.at:26 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
+at_fn_check_prepare_notrace 'an embedded newline' "gtarfail2.at:26"
+( $at_check_trace;
 
 test -z "$STAR_TESTSCRIPTS" && exit 77
 tarball_prereq gtarfail2.tar 6b607d1faec14b82f69525d9c5b66e53 $STAR_TESTSCRIPTS $STAR_DATA_URL || exit 77
 
 tar --utc -tvf $STAR_TESTSCRIPTS/gtarfail2.tar
- ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
-
-test -z "$STAR_TESTSCRIPTS" && exit 77
-tarball_prereq gtarfail2.tar 6b607d1faec14b82f69525d9c5b66e53 $STAR_TESTSCRIPTS $STAR_DATA_URL || exit 77
 
-tar --utc -tvf $STAR_TESTSCRIPTS/gtarfail2.tar
- ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "-rwxr-xr-x jes/glone       214 2001-09-21 14:08 .clean
 lrwxrwxrwx jes/cats          0 1998-05-07 12:39 RULES -> makefiles/RULES
 drwxr-sr-x jes/glone         0 2001-12-10 00:00 build/
@@ -38875,51 +28265,44 @@ lrwxrwxrwx jes/glone         0 2001-08-2
 lrwxrwxrwx jes/glone         0 2001-08-29 10:54 build/psmake/astoi.c -> ../../lib/astoi.c
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/gtarfail2.at:26"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/gtarfail2.at:26"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
 
-  $at_traceoff
+  set +x
   $at_times_p && times >"$at_times_file"
-) 5>&1 2>&1 | eval $at_tee_pipe
-at_status=`cat "$at_status_file"`
+) 5>&1 2>&1 7>&- | eval $at_tee_pipe
+read at_status <"$at_status_file"
 #AT_STOP_114
 #AT_START_115
-# 115. multi-fail.at:21: multi-fail
-at_setup_line='multi-fail.at:21'
-at_desc="multi-fail"
-$at_quiet $as_echo_n "115: $at_desc                                     "
+at_fn_group_banner 115 'multi-fail.at:21' \
+  "multi-fail" "                                     "
 at_xfail=no
-echo "#                             -*- compilation -*-" >> "$at_group_log"
 (
-  $as_echo "115. multi-fail.at:21: testing ..."
+  $as_echo "115. $at_setup_line: testing $at_desc ..."
   $at_traceon
 
 
 
 unset TAR_OPTIONS
 
-{ $at_traceoff
+{ set +x
 $as_echo "$at_srcdir/multi-fail.at:26:
 
-test -z "$STAR_TESTSCRIPTS" && exit 77
-tarball_prereq gnu-multi-fail-volume1.gtar 7c28663dd98b0bd91ceb4be7af55254e $STAR_TESTSCRIPTS $STAR_DATA_URL || exit 77
+test -z \"\$STAR_TESTSCRIPTS\" && exit 77
+tarball_prereq gnu-multi-fail-volume1.gtar 7c28663dd98b0bd91ceb4be7af55254e \$STAR_TESTSCRIPTS \$STAR_DATA_URL || exit 77
 
 
-test -z "$STAR_TESTSCRIPTS" && exit 77
-tarball_prereq gnu-multi-fail-volume2.gtar b5d41c4c3ec440687d4a44957b5079a8 $STAR_TESTSCRIPTS $STAR_DATA_URL || exit 77
+test -z \"\$STAR_TESTSCRIPTS\" && exit 77
+tarball_prereq gnu-multi-fail-volume2.gtar b5d41c4c3ec440687d4a44957b5079a8 \$STAR_TESTSCRIPTS \$STAR_DATA_URL || exit 77
 
 
 tar --utc -tvM -f \$STAR_TESTSCRIPTS/gnu-multi-fail-volume1.gtar \\
                -f \$STAR_TESTSCRIPTS/gnu-multi-fail-volume2.gtar <&-
 "
-echo multi-fail.at:26 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
+at_fn_check_prepare_notrace 'an embedded newline' "multi-fail.at:26"
+( $at_check_trace;
 
 test -z "$STAR_TESTSCRIPTS" && exit 77
 tarball_prereq gnu-multi-fail-volume1.gtar 7c28663dd98b0bd91ceb4be7af55254e $STAR_TESTSCRIPTS $STAR_DATA_URL || exit 77
@@ -38931,26 +28314,11 @@ tarball_prereq gnu-multi-fail-volume2.gt
 
 tar --utc -tvM -f $STAR_TESTSCRIPTS/gnu-multi-fail-volume1.gtar \
                -f $STAR_TESTSCRIPTS/gnu-multi-fail-volume2.gtar <&-
- ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
-
-test -z "$STAR_TESTSCRIPTS" && exit 77
-tarball_prereq gnu-multi-fail-volume1.gtar 7c28663dd98b0bd91ceb4be7af55254e $STAR_TESTSCRIPTS $STAR_DATA_URL || exit 77
-
-
-test -z "$STAR_TESTSCRIPTS" && exit 77
-tarball_prereq gnu-multi-fail-volume2.gtar b5d41c4c3ec440687d4a44957b5079a8 $STAR_TESTSCRIPTS $STAR_DATA_URL || exit 77
-
 
-tar --utc -tvM -f $STAR_TESTSCRIPTS/gnu-multi-fail-volume1.gtar \
-               -f $STAR_TESTSCRIPTS/gnu-multi-fail-volume2.gtar <&-
- ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
-at_func_diff_devnull "$at_stderr" || at_failed=:
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
+at_fn_diff_devnull "$at_stderr" || at_failed=:
 echo >>"$at_stdout"; $as_echo "drwxrwsr-x joerg/bs          0 2003-10-11 14:32 OBJ/i386-sunos5-gcc/
 -rw-r--r-- joerg/bs          1 2003-10-11 14:32 OBJ/i386-sunos5-gcc/Dnull
 -rw-r--r-- joerg/bs       1743 2003-10-10 18:06 OBJ/i386-sunos5-gcc/star.d
@@ -39005,49 +28373,42 @@ echo >>"$at_stdout"; $as_echo "drwxrwsr-
 -rw-r--r-- joerg/bs       2756 2003-10-07 17:53 OBJ/i386-sunos5-gcc/table.o
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/multi-fail.at:26"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/multi-fail.at:26"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
 
-  $at_traceoff
+  set +x
   $at_times_p && times >"$at_times_file"
-) 5>&1 2>&1 | eval $at_tee_pipe
-at_status=`cat "$at_status_file"`
+) 5>&1 2>&1 7>&- | eval $at_tee_pipe
+read at_status <"$at_status_file"
 #AT_STOP_115
 #AT_START_116
-# 116. ustar-big-2g.at:21: ustar-big-2g
-at_setup_line='ustar-big-2g.at:21'
-at_desc="ustar-big-2g"
-$at_quiet $as_echo_n "116: $at_desc                                   "
+at_fn_group_banner 116 'ustar-big-2g.at:21' \
+  "ustar-big-2g" "                                   "
 at_xfail=no
-echo "#                             -*- compilation -*-" >> "$at_group_log"
 (
-  $as_echo "116. ustar-big-2g.at:21: testing ..."
+  $as_echo "116. $at_setup_line: testing $at_desc ..."
   $at_traceon
 
 
 
 unset TAR_OPTIONS
 
-{ $at_traceoff
+{ set +x
 $as_echo "$at_srcdir/ustar-big-2g.at:26:
 
 cat /dev/null | bzip2 - > /dev/null 2>&1 || exit 77
 
 
-test -z "$STAR_TESTSCRIPTS" && exit 77
-tarball_prereq ustar-big-2g.tar.bz2 b63979733629c8fcdf40b60065422767 $STAR_TESTSCRIPTS $STAR_DATA_URL || exit 77
+test -z \"\$STAR_TESTSCRIPTS\" && exit 77
+tarball_prereq ustar-big-2g.tar.bz2 b63979733629c8fcdf40b60065422767 \$STAR_TESTSCRIPTS \$STAR_DATA_URL || exit 77
 
 
 tar --utc -tvjf \$STAR_TESTSCRIPTS/ustar-big-2g.tar.bz2
 "
-echo ustar-big-2g.at:26 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
+at_fn_check_prepare_notrace 'an embedded newline' "ustar-big-2g.at:26"
+( $at_check_trace;
 
 cat /dev/null | bzip2 - > /dev/null 2>&1 || exit 77
 
@@ -39057,31 +28418,17 @@ tarball_prereq ustar-big-2g.tar.bz2 b639
 
 
 tar --utc -tvjf $STAR_TESTSCRIPTS/ustar-big-2g.tar.bz2
- ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
-
-cat /dev/null | bzip2 - > /dev/null 2>&1 || exit 77
-
-
-test -z "$STAR_TESTSCRIPTS" && exit 77
-tarball_prereq ustar-big-2g.tar.bz2 b63979733629c8fcdf40b60065422767 $STAR_TESTSCRIPTS $STAR_DATA_URL || exit 77
 
-
-tar --utc -tvjf $STAR_TESTSCRIPTS/ustar-big-2g.tar.bz2
- ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
 echo stderr:; tee stderr <"$at_stderr"
 echo >>"$at_stdout"; $as_echo "-rw------- jes/glone 2147483647 2002-06-15 14:53 big
 -rw-r--r-- jes/glone          0 2002-06-15 14:53 file
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/ustar-big-2g.at:26"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/ustar-big-2g.at:26"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
 
@@ -39098,43 +28445,37 @@ do
 done
 
 
-  $at_traceoff
+  set +x
   $at_times_p && times >"$at_times_file"
-) 5>&1 2>&1 | eval $at_tee_pipe
-at_status=`cat "$at_status_file"`
+) 5>&1 2>&1 7>&- | eval $at_tee_pipe
+read at_status <"$at_status_file"
 #AT_STOP_116
 #AT_START_117
-# 117. ustar-big-8g.at:21: ustar-big-8g
-at_setup_line='ustar-big-8g.at:21'
-at_desc="ustar-big-8g"
-$at_quiet $as_echo_n "117: $at_desc                                   "
+at_fn_group_banner 117 'ustar-big-8g.at:21' \
+  "ustar-big-8g" "                                   "
 at_xfail=no
-echo "#                             -*- compilation -*-" >> "$at_group_log"
 (
-  $as_echo "117. ustar-big-8g.at:21: testing ..."
+  $as_echo "117. $at_setup_line: testing $at_desc ..."
   $at_traceon
 
 
 
 unset TAR_OPTIONS
 
-{ $at_traceoff
+{ set +x
 $as_echo "$at_srcdir/ustar-big-8g.at:26:
 
 cat /dev/null | bzip2 - > /dev/null 2>&1 || exit 77
 
 
-test -z "$STAR_TESTSCRIPTS" && exit 77
-tarball_prereq ustar-big-8g.tar.bz2 60ff503fa4b8288bef7ada89e9c91b0f $STAR_TESTSCRIPTS $STAR_DATA_URL || exit 77
+test -z \"\$STAR_TESTSCRIPTS\" && exit 77
+tarball_prereq ustar-big-8g.tar.bz2 60ff503fa4b8288bef7ada89e9c91b0f \$STAR_TESTSCRIPTS \$STAR_DATA_URL || exit 77
 
 
 tar --utc -tvjf \$STAR_TESTSCRIPTS/ustar-big-8g.tar.bz2
 "
-echo ustar-big-8g.at:26 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
+at_fn_check_prepare_notrace 'an embedded newline' "ustar-big-8g.at:26"
+( $at_check_trace;
 
 cat /dev/null | bzip2 - > /dev/null 2>&1 || exit 77
 
@@ -39144,31 +28485,17 @@ tarball_prereq ustar-big-8g.tar.bz2 60ff
 
 
 tar --utc -tvjf $STAR_TESTSCRIPTS/ustar-big-8g.tar.bz2
- ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
 
-cat /dev/null | bzip2 - > /dev/null 2>&1 || exit 77
-
-
-test -z "$STAR_TESTSCRIPTS" && exit 77
-tarball_prereq ustar-big-8g.tar.bz2 60ff503fa4b8288bef7ada89e9c91b0f $STAR_TESTSCRIPTS $STAR_DATA_URL || exit 77
-
-
-tar --utc -tvjf $STAR_TESTSCRIPTS/ustar-big-8g.tar.bz2
- ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
 echo stderr:; tee stderr <"$at_stderr"
 echo >>"$at_stdout"; $as_echo "-rw------- jes/glone 8589934591 2002-06-15 15:08 8gb-1
 -rw-r--r-- jes/glone          0 2002-06-15 14:53 file
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/ustar-big-8g.at:26"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/ustar-big-8g.at:26"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
 
@@ -39185,43 +28512,37 @@ do
 done
 
 
-  $at_traceoff
+  set +x
   $at_times_p && times >"$at_times_file"
-) 5>&1 2>&1 | eval $at_tee_pipe
-at_status=`cat "$at_status_file"`
+) 5>&1 2>&1 7>&- | eval $at_tee_pipe
+read at_status <"$at_status_file"
 #AT_STOP_117
 #AT_START_118
-# 118. pax-big-10g.at:21: pax-big-10g
-at_setup_line='pax-big-10g.at:21'
-at_desc="pax-big-10g"
-$at_quiet $as_echo_n "118: $at_desc                                    "
+at_fn_group_banner 118 'pax-big-10g.at:21' \
+  "pax-big-10g" "                                    "
 at_xfail=no
-echo "#                             -*- compilation -*-" >> "$at_group_log"
 (
-  $as_echo "118. pax-big-10g.at:21: testing ..."
+  $as_echo "118. $at_setup_line: testing $at_desc ..."
   $at_traceon
 
 
 
 unset TAR_OPTIONS
 
-{ $at_traceoff
+{ set +x
 $as_echo "$at_srcdir/pax-big-10g.at:26:
 
 cat /dev/null | bzip2 - > /dev/null 2>&1 || exit 77
 
 
-test -z "$STAR_TESTSCRIPTS" && exit 77
-tarball_prereq pax-big-10g.tar.bz2 ca15c23acc8d8bb1f27e60113a5f8bff $STAR_TESTSCRIPTS $STAR_DATA_URL || exit 77
+test -z \"\$STAR_TESTSCRIPTS\" && exit 77
+tarball_prereq pax-big-10g.tar.bz2 ca15c23acc8d8bb1f27e60113a5f8bff \$STAR_TESTSCRIPTS \$STAR_DATA_URL || exit 77
 
 
 tar --utc -tvjf \$STAR_TESTSCRIPTS/pax-big-10g.tar.bz2
 "
-echo pax-big-10g.at:26 >"$at_check_line_file"
-
-if { echo 'Not enabling shell tracing (command contains an embedded newline)'
-   false; }; then
-  ( $at_traceon;
+at_fn_check_prepare_notrace 'an embedded newline' "pax-big-10g.at:26"
+( $at_check_trace;
 
 cat /dev/null | bzip2 - > /dev/null 2>&1 || exit 77
 
@@ -39231,31 +28552,17 @@ tarball_prereq pax-big-10g.tar.bz2 ca15c
 
 
 tar --utc -tvjf $STAR_TESTSCRIPTS/pax-big-10g.tar.bz2
- ) >"$at_stdout" 2>"$at_stder1"
-  at_func_filter_trace $?
-else
-  ( :;
-
-cat /dev/null | bzip2 - > /dev/null 2>&1 || exit 77
 
-
-test -z "$STAR_TESTSCRIPTS" && exit 77
-tarball_prereq pax-big-10g.tar.bz2 ca15c23acc8d8bb1f27e60113a5f8bff $STAR_TESTSCRIPTS $STAR_DATA_URL || exit 77
-
-
-tar --utc -tvjf $STAR_TESTSCRIPTS/pax-big-10g.tar.bz2
- ) >"$at_stdout" 2>"$at_stderr"
-fi
-at_status=$?
-at_failed=false
+) >>"$at_stdout" 2>>"$at_stderr"
+at_status=$? at_failed=false
+$at_check_filter
 echo stderr:; tee stderr <"$at_stderr"
 echo >>"$at_stdout"; $as_echo "-rw------- jes/glone 10737418240 2002-06-15 21:18 10g
 -rw-r--r-- jes/glone           0 2002-06-15 14:53 file
 " | \
   $at_diff - "$at_stdout" || at_failed=:
-at_func_check_status 0 $at_status "$at_srcdir/pax-big-10g.at:26"
-
-$at_failed && at_func_log_failure
+at_fn_check_status 0 $at_status "$at_srcdir/pax-big-10g.at:26"
+$at_failed && at_fn_log_failure
 $at_traceon; }
 
 
@@ -39272,8 +28579,8 @@ do
 done
 
 
-  $at_traceoff
+  set +x
   $at_times_p && times >"$at_times_file"
-) 5>&1 2>&1 | eval $at_tee_pipe
-at_status=`cat "$at_status_file"`
+) 5>&1 2>&1 7>&- | eval $at_tee_pipe
+read at_status <"$at_status_file"
 #AT_STOP_118
--- tar-1.25.orig/tests/Makefile.in
+++ tar-1.25/tests/Makefile.in
@@ -663,6 +663,7 @@ PACKAGE_BUGREPORT = @PACKAGE_BUGREPORT@
 PACKAGE_NAME = @PACKAGE_NAME@
 PACKAGE_STRING = @PACKAGE_STRING@
 PACKAGE_TARNAME = @PACKAGE_TARNAME@
+PACKAGE_URL = @PACKAGE_URL@
 PACKAGE_VERSION = @PACKAGE_VERSION@
 PATH_SEPARATOR = @PATH_SEPARATOR@
 POSUB = @POSUB@
