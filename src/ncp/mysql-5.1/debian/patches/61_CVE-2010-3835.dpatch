#! /bin/sh /usr/share/dpatch/dpatch-run
# Description: fix denial of service via user-variable assignment expression.
# Origin: upstream, http://bazaar.launchpad.net/~mysql/mysql-server/mysql-5.1/revision/3461.1.18
# Bug: http://bugs.mysql.com/bug.php?id=55564

@DPATCH@
diff -urNad '--exclude=CVS' '--exclude=.svn' '--exclude=.git' '--exclude=.arch' '--exclude=.hg' '--exclude=_darcs' '--exclude=.bzr' mysql-5.1-5.1.49~/mysql-test/r/user_var.result mysql-5.1-5.1.49/mysql-test/r/user_var.result
--- mysql-5.1-5.1.49~/mysql-test/r/user_var.result	2010-07-09 09:03:13.000000000 -0400
+++ mysql-5.1-5.1.49/mysql-test/r/user_var.result	2010-11-08 11:03:36.000000000 -0500
@@ -430,4 +430,21 @@
 INSERT INTO t1 VALUES (1);
 INSERT INTO t1 VALUES (1);
 DROP TABLE t1;
+CREATE TABLE t1(a INT);
+INSERT INTO t1 VALUES (0),(0);
+# BUG#55615 : should not crash
+SELECT (@a:=(SELECT @a:=1 FROM t1 LIMIT 1)) AND COUNT(1) FROM t1 GROUP BY @a;
+(@a:=(SELECT @a:=1 FROM t1 LIMIT 1)) AND COUNT(1)
+1
+1
+# BUG#55564 : should not crash
+SELECT IF(
+@v:=LEAST((SELECT 1 FROM t1 t2 LEFT JOIN t1 ON (@v) GROUP BY t1.a), a),
+count(*), 1) 
+FROM t1 GROUP BY a LIMIT 1;
+IF(
+@v:=LEAST((SELECT 1 FROM t1 t2 LEFT JOIN t1 ON (@v) GROUP BY t1.a), a),
+count(*), 1)
+1
+DROP TABLE t1;
 End of 5.1 tests
diff -urNad '--exclude=CVS' '--exclude=.svn' '--exclude=.git' '--exclude=.arch' '--exclude=.hg' '--exclude=_darcs' '--exclude=.bzr' mysql-5.1-5.1.49~/mysql-test/t/user_var.test mysql-5.1-5.1.49/mysql-test/t/user_var.test
--- mysql-5.1-5.1.49~/mysql-test/t/user_var.test	2010-07-09 09:02:46.000000000 -0400
+++ mysql-5.1-5.1.49/mysql-test/t/user_var.test	2010-11-08 11:03:36.000000000 -0500
@@ -328,4 +328,22 @@
 INSERT INTO t1 VALUES (1);
 DROP TABLE t1;
 
+#
+# Bug #55615: debug assertion after using variable in assignment and
+# referred to
+# Bug #55564: crash with user variables, assignments, joins...
+#
+
+CREATE TABLE t1(a INT);
+INSERT INTO t1 VALUES (0),(0);
+--echo # BUG#55615 : should not crash
+SELECT (@a:=(SELECT @a:=1 FROM t1 LIMIT 1)) AND COUNT(1) FROM t1 GROUP BY @a;
+--echo # BUG#55564 : should not crash
+SELECT IF(
+  @v:=LEAST((SELECT 1 FROM t1 t2 LEFT JOIN t1 ON (@v) GROUP BY t1.a), a),
+  count(*), 1) 
+FROM t1 GROUP BY a LIMIT 1;
+
+DROP TABLE t1;
+
 --echo End of 5.1 tests
diff -urNad '--exclude=CVS' '--exclude=.svn' '--exclude=.git' '--exclude=.arch' '--exclude=.hg' '--exclude=_darcs' '--exclude=.bzr' mysql-5.1-5.1.49~/sql/item_func.cc mysql-5.1-5.1.49/sql/item_func.cc
--- mysql-5.1-5.1.49~/sql/item_func.cc	2010-11-08 11:03:31.000000000 -0500
+++ mysql-5.1-5.1.49/sql/item_func.cc	2010-11-08 11:03:36.000000000 -0500
@@ -4275,6 +4275,14 @@
   return entry->val_int(&null_value);
 }
 
+bool Item_func_set_user_var::val_bool_result()
+{
+  DBUG_ASSERT(fixed == 1);
+  check(TRUE);
+  update();					// Store expression
+  return entry->val_int(&null_value) != 0;
+}
+
 String *Item_func_set_user_var::str_result(String *str)
 {
   DBUG_ASSERT(fixed == 1);
diff -urNad '--exclude=CVS' '--exclude=.svn' '--exclude=.git' '--exclude=.arch' '--exclude=.hg' '--exclude=_darcs' '--exclude=.bzr' mysql-5.1-5.1.49~/sql/item_func.h mysql-5.1-5.1.49/sql/item_func.h
--- mysql-5.1-5.1.49~/sql/item_func.h	2010-07-09 08:35:10.000000000 -0400
+++ mysql-5.1-5.1.49/sql/item_func.h	2010-11-08 11:03:36.000000000 -0500
@@ -1353,6 +1353,7 @@
   my_decimal *val_decimal(my_decimal *);
   double val_result();
   longlong val_int_result();
+  bool val_bool_result();
   String *str_result(String *str);
   my_decimal *val_decimal_result(my_decimal *);
   bool is_null_result();
