#! /bin/sh /usr/share/dpatch/dpatch-run
# Description: fixdenial of service via certain queries with nested joins.
# Origin: upstream, http://bazaar.launchpad.net/~mysql/mysql-server/mysql-5.1/revision/3461.3.1
# Bug: http://bugs.mysql.com/bug.php?id=53544

@DPATCH@
diff -urNad '--exclude=CVS' '--exclude=.svn' '--exclude=.git' '--exclude=.arch' '--exclude=.hg' '--exclude=_darcs' '--exclude=.bzr' mysql-5.1-5.1.49~/mysql-test/r/join.result mysql-5.1-5.1.49/mysql-test/r/join.result
--- mysql-5.1-5.1.49~/mysql-test/r/join.result	2010-11-08 11:04:33.000000000 -0500
+++ mysql-5.1-5.1.49/mysql-test/r/join.result	2010-11-08 11:05:51.000000000 -0500
@@ -1200,4 +1200,24 @@
 1
 1
 DROP TABLE t1;
+#
+# Bug #53544: Server hangs during JOIN query in stored procedure called
+#             twice in a row
+#
+CREATE TABLE t1(c INT);
+INSERT INTO t1 VALUES (1), (2);
+PREPARE stmt FROM "SELECT t2.c AS f1 FROM t1 LEFT JOIN
+                                        t1 t2 ON t1.c=t2.c RIGHT JOIN
+                                        t1 t3 ON t1.c=t3.c 
+                   GROUP BY f1;";
+EXECUTE stmt;
+f1
+1
+2
+EXECUTE stmt;
+f1
+1
+2
+DEALLOCATE PREPARE stmt;
+DROP TABLE t1;
 End of 5.1 tests
diff -urNad '--exclude=CVS' '--exclude=.svn' '--exclude=.git' '--exclude=.arch' '--exclude=.hg' '--exclude=_darcs' '--exclude=.bzr' mysql-5.1-5.1.49~/mysql-test/t/join.test mysql-5.1-5.1.49/mysql-test/t/join.test
--- mysql-5.1-5.1.49~/mysql-test/t/join.test	2010-11-08 11:04:33.000000000 -0500
+++ mysql-5.1-5.1.49/mysql-test/t/join.test	2010-11-08 11:05:10.000000000 -0500
@@ -901,4 +901,24 @@
 
 DROP TABLE t1;
 
+--echo #
+--echo # Bug #53544: Server hangs during JOIN query in stored procedure called
+--echo #             twice in a row
+--echo #
+
+CREATE TABLE t1(c INT);
+
+INSERT INTO t1 VALUES (1), (2);
+
+PREPARE stmt FROM "SELECT t2.c AS f1 FROM t1 LEFT JOIN
+                                        t1 t2 ON t1.c=t2.c RIGHT JOIN
+                                        t1 t3 ON t1.c=t3.c 
+                   GROUP BY f1;";
+
+EXECUTE stmt;
+EXECUTE stmt;
+
+DEALLOCATE PREPARE stmt;
+DROP TABLE t1;
+
 --echo End of 5.1 tests
diff -urNad '--exclude=CVS' '--exclude=.svn' '--exclude=.git' '--exclude=.arch' '--exclude=.hg' '--exclude=_darcs' '--exclude=.bzr' mysql-5.1-5.1.49~/sql/sql_select.cc mysql-5.1-5.1.49/sql/sql_select.cc
--- mysql-5.1-5.1.49~/sql/sql_select.cc	2010-11-08 11:04:33.000000000 -0500
+++ mysql-5.1-5.1.49/sql/sql_select.cc	2010-11-08 11:05:10.000000000 -0500
@@ -8883,10 +8883,10 @@
     
   /* Flatten nested joins that can be flattened. */
   TABLE_LIST *right_neighbor= NULL;
-  bool fix_name_res= FALSE;
   li.rewind();
   while ((table= li++))
   {
+    bool fix_name_res= FALSE;
     nested_join= table->nested_join;
     if (nested_join && !table->on_expr)
     {
