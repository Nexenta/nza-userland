#! /bin/sh /usr/share/dpatch/dpatch-run
# Description: fix denial of service via longblob and union or update with subquery.
# Origin: upstream, http://bazaar.launchpad.net/~mysql/mysql-server/mysql-5.1/revision/3461.1.8
# Bug: http://bugs.mysql.com/bug.php?id=54461

@DPATCH@
diff -urNad '--exclude=CVS' '--exclude=.svn' '--exclude=.git' '--exclude=.arch' '--exclude=.hg' '--exclude=_darcs' '--exclude=.bzr' mysql-5.1-5.1.49~/mysql-test/r/func_misc.result mysql-5.1-5.1.49/mysql-test/r/func_misc.result
--- mysql-5.1-5.1.49~/mysql-test/r/func_misc.result	2010-07-09 09:02:55.000000000 -0400
+++ mysql-5.1-5.1.49/mysql-test/r/func_misc.result	2010-11-08 11:04:23.000000000 -0500
@@ -336,4 +336,19 @@
 select connection_id() > 0;
 connection_id() > 0
 1
+#
+# Bug #54461: crash with longblob and union or update with subquery
+#
+CREATE TABLE t1 (a INT, b LONGBLOB);
+INSERT INTO t1 VALUES (1, '2'), (2, '3'), (3, '2');
+SELECT DISTINCT LEAST(a, (SELECT b FROM t1 LIMIT 1)) FROM t1 UNION SELECT 1;
+LEAST(a, (SELECT b FROM t1 LIMIT 1))
+1
+2
+SELECT DISTINCT GREATEST(a, (SELECT b FROM t1 LIMIT 1)) FROM t1 UNION SELECT 1;
+GREATEST(a, (SELECT b FROM t1 LIMIT 1))
+2
+3
+1
+DROP TABLE t1;
 End of tests
diff -urNad '--exclude=CVS' '--exclude=.svn' '--exclude=.git' '--exclude=.arch' '--exclude=.hg' '--exclude=_darcs' '--exclude=.bzr' mysql-5.1-5.1.49~/mysql-test/t/func_misc.test mysql-5.1-5.1.49/mysql-test/t/func_misc.test
--- mysql-5.1-5.1.49~/mysql-test/t/func_misc.test	2010-07-09 09:02:27.000000000 -0400
+++ mysql-5.1-5.1.49/mysql-test/t/func_misc.test	2010-11-08 11:04:23.000000000 -0500
@@ -467,4 +467,16 @@
 
 select connection_id() > 0;
 
+--echo #
+--echo # Bug #54461: crash with longblob and union or update with subquery
+--echo #
+
+CREATE TABLE t1 (a INT, b LONGBLOB);
+INSERT INTO t1 VALUES (1, '2'), (2, '3'), (3, '2');
+
+SELECT DISTINCT LEAST(a, (SELECT b FROM t1 LIMIT 1)) FROM t1 UNION SELECT 1;
+SELECT DISTINCT GREATEST(a, (SELECT b FROM t1 LIMIT 1)) FROM t1 UNION SELECT 1;
+
+DROP TABLE t1;
+
 --echo End of tests
diff -urNad '--exclude=CVS' '--exclude=.svn' '--exclude=.git' '--exclude=.arch' '--exclude=.hg' '--exclude=_darcs' '--exclude=.bzr' mysql-5.1-5.1.49~/sql/item_func.cc mysql-5.1-5.1.49/sql/item_func.cc
--- mysql-5.1-5.1.49~/sql/item_func.cc	2010-11-08 11:04:19.000000000 -0500
+++ mysql-5.1-5.1.49/sql/item_func.cc	2010-11-08 11:04:23.000000000 -0500
@@ -2243,6 +2243,8 @@
     max_length= my_decimal_precision_to_length_no_truncation(max_int_part +
                                                              decimals, decimals,
                                                              unsigned_flag);
+  else if (cmp_type == REAL_RESULT)
+    max_length= float_length(decimals);
   cached_field_type= agg_field_type(args, arg_count);
 }
 
