libpoppler-0.10

making luatex compile with libpoppler 0.10 release line

 source/configure                               |    6 +--
 source/texk/web2c/Makefile.in                  |   10 +++---
 source/texk/web2c/luatexdir/image/pdftoepdf.cc |   39 ++++++++++++-------------
 source/texk/web2c/luatexdir/luatexextra.in     |    2 -
 source/texk/web2c/luatexdir/utils/utils.c      |    6 +--
 5 files changed, 33 insertions(+), 30 deletions(-)

Index: luatex-0.40.0/source/configure
===================================================================
--- luatex-0.40.0.orig/source/configure	2009-04-22 12:06:12.000000000 +0200
+++ luatex-0.40.0/source/configure	2009-04-22 21:47:49.000000000 +0200
@@ -2388,7 +2388,7 @@
 esac
 
 test "x$enable_web2c:$enable_pdftex" = xyes:yes && {
-  need_xpdf=yes
+  need_xpdf=no
   need_libpng=yes
   need_obsdcompat=yes
 }
@@ -2402,7 +2402,7 @@
 esac
 
 test "x$enable_web2c:$enable_luatex" = xyes:yes && {
-  need_xpdf=yes
+  need_xpdf=no
   need_libpng=yes
   need_obsdcompat=yes
 }
@@ -2416,7 +2416,7 @@
 esac
 
 test "x$enable_web2c:$enable_xetex" = xyes:yes && {
-  need_xpdf=yes
+  need_xpdf=no
   need_libpng=yes
   need_freetype2=yes
   need_icu=yes
Index: luatex-0.40.0/source/texk/web2c/luatexdir/image/pdftoepdf.cc
===================================================================
--- luatex-0.40.0.orig/source/texk/web2c/luatexdir/image/pdftoepdf.cc	2009-04-22 12:05:46.000000000 +0200
+++ luatex-0.40.0/source/texk/web2c/luatexdir/image/pdftoepdf.cc	2009-04-22 21:46:46.000000000 +0200
@@ -24,23 +24,24 @@
 #include <stdio.h>
 #include <string.h>
 #include <ctype.h>
-#include <aconf.h>
-#include <GString.h>
-#include <gmem.h>
-#include <gfile.h>
 #include <assert.h>
-#include "Object.h"
-#include "Stream.h"
-#include "Array.h"
-#include "Dict.h"
-#include "XRef.h"
-#include "Catalog.h"
-#include "Link.h"
-#include "Page.h"
-#include "GfxFont.h"
-#include "PDFDoc.h"
-#include "GlobalParams.h"
-#include "Error.h"
+#include <dirent.h>
+#include <poppler/poppler-config.h>
+#include <poppler/goo/GooString.h>
+#include <poppler/goo/gmem.h>
+#include <poppler/goo/gfile.h>
+#include "poppler/Object.h"
+#include "poppler/Stream.h"
+#include "poppler/Array.h"
+#include "poppler/Dict.h"
+#include "poppler/XRef.h"
+#include "poppler/Link.h"
+#include "poppler/Catalog.h"
+#include "poppler/Page.h"
+#include "poppler/GfxFont.h"
+#include "poppler/PDFDoc.h"
+#include "poppler/GlobalParams.h"
+#include "poppler/Error.h"
 
 #include "epdf.h"
 
@@ -163,7 +164,7 @@
         pdf_doc->file_path = xstrdup(file_path);
         void **aa = avl_probe(PdfDocumentTree, pdf_doc);
         assert(aa != NULL);
-        GString *docName = new GString(pdf_doc->file_path);
+        GooString *docName = new GooString(pdf_doc->file_path);
         pdf_doc->doc = new PDFDoc(docName);     // takes ownership of docName
         if (!pdf_doc->doc->isOk() || !pdf_doc->doc->okToPrint())
             pdftex_fail("xpdf: reading PDF image failed");
@@ -533,7 +534,7 @@
     int i, l, c;
     Ref ref;
     char *p;
-    GString *s;
+    GooString *s;
     if (obj->isBool()) {
         pdf_printf("%s", obj->getBool()? "true" : "false");
     } else if (obj->isInt()) {
@@ -725,7 +726,7 @@
     img_totalpages(idict) = pdf_doc->doc->getCatalog()->getNumPages();
     if (img_pagename(idict)) {
         // get page by name
-        GString name(img_pagename(idict));
+        GooString name(img_pagename(idict));
         LinkDest *link = pdf_doc->doc->findDest(&name);
         if (link == NULL || !link->isOk())
             pdftex_fail("PDF inclusion: invalid destination <%s>",
Index: luatex-0.40.0/source/texk/web2c/luatexdir/luatexextra.in
===================================================================
--- luatex-0.40.0.orig/source/texk/web2c/luatexdir/luatexextra.in	2009-04-22 12:06:07.000000000 +0200
+++ luatex-0.40.0/source/texk/web2c/luatexdir/luatexextra.in	2009-04-22 21:46:46.000000000 +0200
@@ -25,7 +25,7 @@
    (generated from ../lib/texmfmp.c).
 */
 
-#define BANNER "This is LuaTeX, Version LUATEX-VERSION"
+#define BANNER "This is LuaTeX using libpoppler, Version LUATEX-VERSION"
 #define COPYRIGHT_HOLDER "Taco Hoekwater"
 #define AUTHOR NULL
 #define PROGRAM_HELP LUATEXHELP
Index: luatex-0.40.0/source/texk/web2c/luatexdir/utils/utils.c
===================================================================
--- luatex-0.40.0.orig/source/texk/web2c/luatexdir/utils/utils.c	2009-04-22 12:06:01.000000000 +0200
+++ luatex-0.40.0/source/texk/web2c/luatexdir/utils/utils.c	2009-04-22 21:46:46.000000000 +0200
@@ -40,7 +40,7 @@
 #include "ptexlib.h"
 
 #include "png.h"
-#include "xpdf/config.h"        /* just to get the xpdf version */
+#include "poppler/poppler-config.h"        /* just to get the xpdf version */
 
 static const char __svn_version[] =
     "$Id: utils.c 2329 2009-04-18 14:25:30Z hhenkel $ "
@@ -1125,9 +1125,9 @@
     (void) asprintf(versions,
                     "Compiled with libpng %s; using libpng %s\n"
                     "Compiled with zlib %s; using zlib %s\n"
-                    "Compiled with xpdf version %s\n",
+                    "Compiled with poppler version %s\n",
                     PNG_LIBPNG_VER_STRING, png_libpng_ver,
-                    ZLIB_VERSION, zlib_version, xpdfVersion);
+                    ZLIB_VERSION, zlib_version, POPPLERVERSION);
 }
 
 /*************************************************/
Index: luatex-0.40.0/source/texk/web2c/Makefile.in
===================================================================
--- luatex-0.40.0.orig/source/texk/web2c/Makefile.in	2009-04-22 14:15:38.000000000 +0200
+++ luatex-0.40.0/source/texk/web2c/Makefile.in	2009-04-22 21:48:48.000000000 +0200
@@ -913,10 +913,10 @@
 	-I$(srcdir)/mplibdir -Dextra_version_info=`date +-%Y%m%d%H`
 luatex_ldadd = libluatex.a libff.a libluamisc.a libzzip.a \
 	libluasocket.a liblua51.a $(LIBPNG_LIBS) $(ZLIB_LIBS) \
-	$(XPDF_LIBS) $(OBSDCOMPAT_LIBS) libmd5.a libmplib.a
+	-lpoppler $(OBSDCOMPAT_LIBS) libmd5.a libmplib.a
 luatex_LDADD = $(luatex_ldadd) $(LDADD) $(socketlibs)
 luatex_DEPENDENCIES = $(proglib) libluatex.a $(LIBPNG_DEPEND) \
-	$(ZLIB_DEPEND) $(XPDF_DEPEND) $(OBSDCOMPAT_DEPEND) libmd5.a \
+	$(ZLIB_DEPEND) $(OBSDCOMPAT_DEPEND) libmd5.a \
 	libmplib.a
 luatex_c_h = luatexini.c luatex0.c luatexcoerce.h luatexd.h
 nodist_luatex_SOURCES = $(luatex_c_h) luatex-pool.c luatexextra.c luatexdir/luatexextra.h
@@ -1191,11 +1191,13 @@
 	luatexdir/luafontloader/src/ffdummies.c \
 	luatexdir/luafontloader/src/luafflib.c
 
+POPPLERVERSION=`pkg-config --modversion poppler`
+
 libluatex_a_DEPENDENCIES = libff.a
 libluatex_a_CPPFLAGS = $(ZLIB_INCLUDES) $(LIBPNG_INCLUDES) \
-	$(XPDF_INCLUDES) $(OBSDCOMPAT_INCLUDES) -I$(srcdir)/libmd5 \
+	-I/usr/include/poppler $(OBSDCOMPAT_INCLUDES) -I$(srcdir)/libmd5 \
 	-Iluatexdir -I$(srcdir)/luatexdir -I$(srcdir)/luatexdir/lua51 \
-	-DpdfTeX
+	-DpdfTeX -DPOPPLERVERSION=\"$(POPPLERVERSION)\"
 libluatex_a_SOURCES = \
 	luatexdir/commands.h \
 	luatexdir/font/dofont.c \
