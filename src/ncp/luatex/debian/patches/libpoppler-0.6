libpoppler-0.6

making luatex compile with libpoppler 0.6 release line

 src/configure                               |    6 ++--
 src/configure.in                            |    8 ++---
 src/texk/web2c/luatexdir/Makefile.in        |    3 --
 src/texk/web2c/luatexdir/image/pdftoepdf.cc |   41 +++++++++++++---------------
 src/texk/web2c/luatexdir/luatex.mk          |    5 ++-
 src/texk/web2c/luatexdir/luatexextra.in     |    2 -
 src/texk/web2c/luatexdir/utils.c            |    4 +-
 7 files changed, 35 insertions(+), 34 deletions(-)

Index: luatex-0.35.0/src/configure
===================================================================
--- luatex-0.35.0.orig/src/configure	2008-07-15 12:49:28.000000000 +0200
+++ luatex-0.35.0/src/configure	2009-02-26 18:09:10.000000000 +0100
@@ -6827,9 +6827,9 @@
 
 # we need libxpdf for pdf[ex]tex, xetex
 test ! -d $srcdir/$LIBXPDFDIR && : ${needs_libxpdf=no}
-test "$with_pdftex"  != no    && : ${needs_libxpdf=yes}
-test "$with_pdfetex" != no    && : ${needs_libxpdf=yes}
-test "$with_xetex"   != no    && : ${needs_libxpdf=yes}
+test "$with_pdftex"  != no    && : ${needs_libxpdf=no}
+test "$with_pdfetex" != no    && : ${needs_libxpdf=no}
+test "$with_xetex"   != no    && : ${needs_libxpdf=no}
 : ${needs_libxpdf=no}
 export needs_libxpdf
 
Index: luatex-0.35.0/src/configure.in
===================================================================
--- luatex-0.35.0.orig/src/configure.in	2008-07-15 12:49:28.000000000 +0200
+++ luatex-0.35.0/src/configure.in	2009-02-26 18:09:10.000000000 +0100
@@ -163,9 +163,9 @@
 
 # we need libxpdf for pdf[ex]tex, xetex
 test ! -d $srcdir/$LIBXPDFDIR && : ${needs_libxpdf=no}
-test "$with_pdftex"  != no    && : ${needs_libxpdf=yes}
-test "$with_pdfetex" != no    && : ${needs_libxpdf=yes}
-test "$with_xetex"   != no    && : ${needs_libxpdf=yes}
+test "$with_pdftex"  != no    && : ${needs_libxpdf=no}
+test "$with_pdfetex" != no    && : ${needs_libxpdf=no}
+test "$with_xetex"   != no    && : ${needs_libxpdf=no}
 : ${needs_libxpdf=no}
 export needs_libxpdf
 
@@ -220,7 +220,7 @@
 sinclude(libs/ncurses/ncurses.ac)
 sinclude(libs/zlib/zlib.ac)
 sinclude(libs/libpng/libpng.ac)
-sinclude(libs/xpdf/libxpdf.ac)
+#sinclude(libs/xpdf/libxpdf.ac)
 sinclude(libs/t1lib/t1lib.ac)
 sinclude(libs/freetype/freetype.ac)
 sinclude(libs/freetype2/freetype2.ac)
Index: luatex-0.35.0/src/texk/web2c/luatexdir/image/pdftoepdf.cc
===================================================================
--- luatex-0.35.0.orig/src/texk/web2c/luatexdir/image/pdftoepdf.cc	2008-10-06 11:52:07.000000000 +0200
+++ luatex-0.35.0/src/texk/web2c/luatexdir/image/pdftoepdf.cc	2009-02-26 18:09:10.000000000 +0100
@@ -24,25 +24,24 @@
 #include <stdio.h>
 #include <string.h>
 #include <ctype.h>
-#include <aconf.h>
-#include <GString.h>
-#include <gmem.h>
-#include <gfile.h>
-#include <config.h>
 #include <assert.h>
-#include "Object.h"
-#include "Stream.h"
-#include "Array.h"
-#include "Dict.h"
-#include "XRef.h"
-#include "Catalog.h"
-#include "Link.h"
-#include "Page.h"
-#include "GfxFont.h"
-#include "PDFDoc.h"
-#include "GlobalParams.h"
-#include "Error.h"
-
+#include <dirent.h>
+#include <poppler/poppler-config.h>
+#include <poppler/goo/GooString.h>
+#include <poppler/goo/gmem.h>
+#include <poppler/goo/gfile.h>
+#include "poppler/Object.h"
+#include "poppler/Stream.h"
+#include "poppler/Array.h"
+#include "poppler/Dict.h"
+#include "poppler/XRef.h"
+#include "poppler/Link.h"
+#include "poppler/Catalog.h"
+#include "poppler/Page.h"
+#include "poppler/GfxFont.h"
+#include "poppler/PDFDoc.h"
+#include "poppler/GlobalParams.h"
+#include "poppler/Error.h"
 #include "epdf.h"
 
 static const char _svn_version[] =
@@ -163,7 +162,7 @@
         pdf_doc->file_path = xstrdup(file_path);
         void **aa = avl_probe(PdfDocumentTree, pdf_doc);
         assert(aa != NULL);
-        GString *docName = new GString(pdf_doc->file_path);
+        GooString *docName = new GooString(pdf_doc->file_path);
         pdf_doc->doc = new PDFDoc(docName);     // takes ownership of docName
         if (!pdf_doc->doc->isOk() || !pdf_doc->doc->okToPrint())
             pdftex_fail("xpdf: reading PDF image failed");
@@ -533,7 +532,7 @@
     int i, l, c;
     Ref ref;
     char *p;
-    GString *s;
+    GooString *s;
     if (obj->isBool()) {
         pdf_printf("%s", obj->getBool()? "true" : "false");
     } else if (obj->isInt()) {
@@ -725,7 +724,7 @@
     img_totalpages(idict) = pdf_doc->doc->getCatalog()->getNumPages();
     if (img_pagename(idict)) {
         // get page by name
-        GString name(img_pagename(idict));
+        GooString name(img_pagename(idict));
         LinkDest *link = pdf_doc->doc->findDest(&name);
         if (link == NULL || !link->isOk())
             pdftex_fail("PDF inclusion: invalid destination <%s>",
Index: luatex-0.35.0/src/texk/web2c/luatexdir/luatexextra.in
===================================================================
--- luatex-0.35.0.orig/src/texk/web2c/luatexdir/luatexextra.in	2009-02-23 15:44:44.000000000 +0100
+++ luatex-0.35.0/src/texk/web2c/luatexdir/luatexextra.in	2009-02-26 18:10:08.000000000 +0100
@@ -25,7 +25,7 @@
    (generated from ../lib/texmfmp.c).
 */
 
-#define BANNER "This is LuaTeX, Version LUATEX-VERSION"
+#define BANNER "This is LuaTeX using libpoppler, Version LUATEX-VERSION"
 #define COPYRIGHT_HOLDER "Taco Hoekwater"
 #define AUTHOR NULL
 #define PROGRAM_HELP LUATEXHELP
Index: luatex-0.35.0/src/texk/web2c/luatexdir/luatex.mk
===================================================================
--- luatex-0.35.0.orig/src/texk/web2c/luatexdir/luatex.mk	2009-01-24 01:09:02.000000000 +0100
+++ luatex-0.35.0/src/texk/web2c/luatexdir/luatex.mk	2009-02-26 18:10:54.000000000 +0100
@@ -3,6 +3,9 @@
 # differ between releases of luatex
 # $Id: luatex.mk 1831 2009-01-24 00:09:02Z oneiros $
 
+# use libpoppler instead of included xpdf code
+ADDLDFLAGS = -lpoppler
+
 # We build luatex
 luatex = @LTEX@ luatex
 luatexdir = luatexdir
@@ -43,7 +46,7 @@
 
 # Making luatex
 luatex: luatexd.h $(luatex_o) $(luatexextra_o) $(luatexlibsdep)
-	@CXXHACKLINK@ $(luatex_o) $(luatexextra_o) $(luatexlibs) $(socketlibs) @SOCKETHACK@ @CXXHACKLDLIBS@ @CXXLDEXTRA@
+	@CXXHACKLINK@ $(luatex_o) $(luatexextra_o) $(luatexlibs) $(socketlibs) @SOCKETHACK@ @CXXHACKLDLIBS@ @CXXLDEXTRA@ $(ADDLDFLAGS)
 
 # C file dependencies.
 $(luatex_c) luatexcoerce.h luatexd.h: luatex.p $(web2c_texmf) $(srcdir)/$(luatexdir)/luatex.defines $(srcdir)/$(luatexdir)/luatex.h
Index: luatex-0.35.0/src/texk/web2c/luatexdir/Makefile.in
===================================================================
--- luatex-0.35.0.orig/src/texk/web2c/luatexdir/Makefile.in	2009-01-24 01:09:02.000000000 +0100
+++ luatex-0.35.0/src/texk/web2c/luatexdir/Makefile.in	2009-02-26 18:11:37.000000000 +0100
@@ -12,10 +12,9 @@
 ALL_CXXFLAGS = @CXXFLAGS@ @DEFS@ $(XXCFLAGS) \
   -I. -I$(srcdir) \
   -I$(kpathsea_dir_parent) -I$(kpathsea_srcdir_parent) \
-  @LIBXPDFCPPFLAGS@ \
+  -I/usr/include/poppler \
   -I$(LIBOBSDCOMPATDIR) -I$(LIBOBSDCOMPATDIR)/.. \
   -I$(LIBOBSDCOMPATFSRCDIR) -I$(LIBOBSDCOMPATFSRCDIR)/.. \
-  -I$(LIBPNGSRCDIR) -I$(ZLIBSRCDIR) \
   -DPDF_PARSER_ONLY -DDISABLE_OUTLINE -I../../../../src/libs/obsdcompat
 CXX = @CXX@
 
Index: luatex-0.35.0/src/texk/web2c/luatexdir/utils.c
===================================================================
--- luatex-0.35.0.orig/src/texk/web2c/luatexdir/utils.c	2009-02-23 15:44:44.000000000 +0100
+++ luatex-0.35.0/src/texk/web2c/luatexdir/utils.c	2009-02-26 18:09:10.000000000 +0100
@@ -41,7 +41,7 @@
 #include "ptexlib.h"
 
 #include "png.h"
-#include "xpdf/config.h"        /* just to get the xpdf version */
+#include "poppler/poppler-config.h"        /* just to get the xpdf version */
 
 static const char __svn_version[] =
     "$Id: utils.c 1897 2009-02-23 14:44:44Z taco $ $URL: svn://scm.foundry.supelec.fr/svn/luatex/tags/beta-0.35.0/src/texk/web2c/luatexdir/utils.c $";
@@ -1131,7 +1131,7 @@
     (void) asprintf(versions,
                     "Compiled with libpng %s; using libpng %s\n"
                     "Compiled with zlib %s; using zlib %s\n"
-                    "Compiled with xpdf version %s\n",
+                    "Compiled with libpoppler/xpdf version %s\n",
                     PNG_LIBPNG_VER_STRING, png_libpng_ver,
                     ZLIB_VERSION, zlib_version, xpdfVersion);
 }
