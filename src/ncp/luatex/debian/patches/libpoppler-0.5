libpoppler-0.5

adaption of the texlive 30_libpoppler_new patch to compile luatex with
the new libpoppler 0.5

 src/configure                               |    6 +--
 src/configure.in                            |    8 ++--
 src/texk/web2c/luatexdir/Makefile.in        |    2 -
 src/texk/web2c/luatexdir/image/pdftoepdf.cc |   53 +++++++++++++---------------
 src/texk/web2c/luatexdir/luatex.mk          |    5 ++
 src/texk/web2c/luatexdir/luatexextra.in     |    2 -
 src/texk/web2c/luatexdir/pdftosrc.cc        |   40 +++++++++++----------
 src/texk/web2c/luatexdir/utils.c            |    4 +-
 8 files changed, 62 insertions(+), 58 deletions(-)

Index: luatex-0.15/src/configure
===================================================================
--- luatex-0.15.orig/src/configure	2007-10-29 09:49:19.000000000 +0100
+++ luatex-0.15/src/configure	2007-10-30 07:38:52.000000000 +0100
@@ -3450,9 +3450,9 @@
 
 # we need libxpdf for pdf[ex]tex, xetex
 test ! -d $srcdir/$LIBXPDFDIR && : ${needs_libxpdf=no}
-test "$with_pdftex"  != no    && : ${needs_libxpdf=yes}
-test "$with_pdfetex" != no    && : ${needs_libxpdf=yes}
-test "$with_xetex"   != no    && : ${needs_libxpdf=yes}
+test "$with_pdftex"  != no    && : ${needs_libxpdf=no}
+test "$with_pdfetex" != no    && : ${needs_libxpdf=no}
+test "$with_xetex"   != no    && : ${needs_libxpdf=no}
 : ${needs_libxpdf=no}
 export needs_libxpdf
 
Index: luatex-0.15/src/configure.in
===================================================================
--- luatex-0.15.orig/src/configure.in	2007-10-29 09:49:19.000000000 +0100
+++ luatex-0.15/src/configure.in	2007-10-30 07:38:52.000000000 +0100
@@ -157,9 +157,9 @@
 
 # we need libxpdf for pdf[ex]tex, xetex
 test ! -d $srcdir/$LIBXPDFDIR && : ${needs_libxpdf=no}
-test "$with_pdftex"  != no    && : ${needs_libxpdf=yes}
-test "$with_pdfetex" != no    && : ${needs_libxpdf=yes}
-test "$with_xetex"   != no    && : ${needs_libxpdf=yes}
+test "$with_pdftex"  != no    && : ${needs_libxpdf=no}
+test "$with_pdfetex" != no    && : ${needs_libxpdf=no}
+test "$with_xetex"   != no    && : ${needs_libxpdf=no}
 : ${needs_libxpdf=no}
 export needs_libxpdf
 
@@ -207,7 +207,7 @@
 sinclude(libs/libpng/libpng.ac)
 sinclude(libs/zlib/zlib.ac)
 sinclude(libs/ncurses/ncurses.ac)
-sinclude(libs/xpdf/libxpdf.ac)
+#sinclude(libs/xpdf/libxpdf.ac)
 sinclude(libs/t1lib/t1lib.ac)
 sinclude(libs/gd/gd.ac)
 sinclude(libs/freetype/freetype.ac)
Index: luatex-0.15/src/texk/web2c/luatexdir/image/pdftoepdf.cc
===================================================================
--- luatex-0.15.orig/src/texk/web2c/luatexdir/image/pdftoepdf.cc	2007-10-29 09:49:11.000000000 +0100
+++ luatex-0.15/src/texk/web2c/luatexdir/image/pdftoepdf.cc	2007-10-30 07:38:52.000000000 +0100
@@ -26,25 +26,24 @@
 #include <stdio.h>
 #include <string.h>
 #include <ctype.h>
-#include <aconf.h>
-#include <GString.h>
-#include <gmem.h>
-#include <gfile.h>
-#include <config.h>
 #include <assert.h>
-#include "Object.h"
-#include "Stream.h"
-#include "Array.h"
-#include "Dict.h"
-#include "XRef.h"
-#include "Catalog.h"
-#include "Link.h"
-#include "Page.h"
-#include "GfxFont.h"
-#include "PDFDoc.h"
-#include "GlobalParams.h"
-#include "Error.h"
-
+#include <dirent.h>
+#include <poppler/poppler-config.h>
+#include <poppler/goo/GooString.h>
+#include <poppler/goo/gmem.h>
+#include <poppler/goo/gfile.h>
+#include "poppler/Object.h"
+#include "poppler/Stream.h"
+#include "poppler/Array.h"
+#include "poppler/Dict.h"
+#include "poppler/XRef.h"
+#include "poppler/Link.h"
+#include "poppler/Catalog.h"
+#include "poppler/Page.h"
+#include "poppler/GfxFont.h"
+#include "poppler/PDFDoc.h"
+#include "poppler/GlobalParams.h"
+#include "poppler/Error.h"
 #include "epdf.h"
 
 // This file is mostly C and not very much C++; it's just used to interface
@@ -169,7 +168,7 @@
     fprintf(stderr, "\npdfTeX Debug: Creating %s (%d)\n", p->file_name,
             p->occurences);
 #endif
-    GString *docName = new GString(p->file_name);
+    GooString *docName = new GooString(p->file_name);
     p->doc = new PDFDoc(docName);       // takes ownership of docName
     if (!p->doc->isOk() || !p->doc->okToPrint()) {
         pdftex_fail("xpdf: reading PDF image failed");
@@ -212,7 +211,7 @@
     obj->initDict(xref);
     for (int i = 0, l = dict->getLength(); i < l; i++) {
         Object obj1;
-        obj->dictAdd(copyString(dict->getKey(i)), dict->getValNF(i, &obj1));
+        obj->dictAdd(*(new UGooString (*dict->getKey(i))), dict->getValNF(i, &obj1));
     }
 }
 
@@ -291,7 +290,7 @@
 static void copyDictEntry(Object * obj, int i)
 {
     PdfObject obj1;
-    copyName(obj->dictGetKey(i));
+    copyName(obj->dictGetKey(i)->getCString());
     pdf_puts(" ");
     obj->dictGetValNF(i, &obj1);
     copyObject(&obj1);
@@ -318,7 +317,7 @@
     pdf_puts("<<\n");
     assert(r->type == objFont); // FontDescriptor is in fd_tree
     for (i = 0, l = obj->dictGetLength(); i < l; ++i) {
-        key = obj->dictGetKey(i);
+        key = obj->dictGetKey(i)->getCString();
         if (strncmp("FontDescriptor", key, strlen("FontDescriptor")) == 0
             || strncmp("BaseFont", key, strlen("BaseFont")) == 0
             || strncmp("Encoding", key, strlen("Encoding")) == 0)
@@ -425,7 +424,7 @@
     for (i = 0, l = obj->dictGetLength(); i < l; ++i) {
         obj->dictGetValNF(i, &fontRef);
         if (fontRef->isRef())
-            copyFont(obj->dictGetKey(i), &fontRef);
+            copyFont(obj->dictGetKey(i)->getCString(), &fontRef);
         else
             pdftex_fail("PDF inclusion: invalid font in reference type <%s>",
                         fontRef->getTypeName());
@@ -512,7 +511,7 @@
     int i, l, c;
     Ref ref;
     char *p;
-    GString *s;
+    GooString *s;
     if (obj->isBool()) {
         pdf_printf("%s", obj->getBool()? "true" : "false");
     } else if (obj->isInt()) {
@@ -678,7 +677,7 @@
     float pdf_version_found, pdf_version_wanted;
     // initialize
     if (!isInit) {
-        globalParams = new GlobalParams();
+        globalParams = new GlobalParams(NULL);
         globalParams->setErrQuiet(gFalse);
         isInit = gTrue;
     }
@@ -704,7 +703,7 @@
     epdf_num_pages = pdf_doc->doc->getCatalog()->getNumPages();
     if (page_name) {
         // get page by name
-        GString name(page_name);
+        UGooString name(page_name);
         LinkDest *link = pdf_doc->doc->findDest(&name);
         if (link == 0 || !link->isOk())
             pdftex_fail("PDF inclusion: invalid destination <%s>", page_name);
@@ -925,7 +924,7 @@
         pdf_puts("/Resources <<\n");
         for (i = 0, l = obj1->dictGetLength(); i < l; ++i) {
             obj1->dictGetVal(i, &obj2);
-            key = obj1->dictGetKey(i);
+            key = obj1->dictGetKey(i)->getCString();
             if (strcmp("Font", key) == 0)
                 copyFontResources(&obj2);
             else if (strcmp("ProcSet", key) == 0)
Index: luatex-0.15/src/texk/web2c/luatexdir/luatexextra.in
===================================================================
--- luatex-0.15.orig/src/texk/web2c/luatexdir/luatexextra.in	2007-10-29 09:49:14.000000000 +0100
+++ luatex-0.15/src/texk/web2c/luatexdir/luatexextra.in	2007-10-30 07:38:52.000000000 +0100
@@ -26,7 +26,7 @@
    (generated from ../lib/texmfmp.c).
 */
 
-#define BANNER "This is luaTeX, Version 3.141592-LUATEX-VERSION-ETEX-VERSION"
+#define BANNER "This is luaTeX using libpoppler, Version 3.141592-LUATEX-VERSION-ETEX-VERSION"
 #define COPYRIGHT_HOLDER "Taco Hoekwater"
 #define AUTHOR NULL
 #define PROGRAM_HELP LUATEXHELP
Index: luatex-0.15/src/texk/web2c/luatexdir/luatex.mk
===================================================================
--- luatex-0.15.orig/src/texk/web2c/luatexdir/luatex.mk	2007-10-29 09:49:14.000000000 +0100
+++ luatex-0.15/src/texk/web2c/luatexdir/luatex.mk	2007-10-30 07:38:52.000000000 +0100
@@ -2,6 +2,9 @@
 # This fragment contains the parts of the makefile that are most likely to
 # differ between releases of pdfeTeX.
 
+# use libpoppler instead of included xpdf code
+ADDLDFLAGS = -lpoppler
+
 # We build luatex
 luatex = @LTEX@ luatex
 luatexdir = luatexdir
@@ -30,7 +33,7 @@
 
 # Making luatex
 luatex: luatexd.h $(luatex_o) $(luatexextra_o) $(luatexlibsdep)
-	@CXXHACKLINK@ $(luatex_o) $(luatexextra_o) $(luatexlibs) $(socketlibs) @CXXHACKLDLIBS@ @CXXLDEXTRA@
+	@CXXHACKLINK@ $(luatex_o) $(luatexextra_o) $(luatexlibs) $(socketlibs) @CXXHACKLDLIBS@ @CXXLDEXTRA@ $(ADDLDFLAGS)
 
 # C file dependencies.
 $(luatex_c) luatexcoerce.h luatexd.h: luatex.p $(web2c_texmf) $(srcdir)/$(luatexdir)/luatex.defines $(srcdir)/$(luatexdir)/luatex.h
Index: luatex-0.15/src/texk/web2c/luatexdir/Makefile.in
===================================================================
--- luatex-0.15.orig/src/texk/web2c/luatexdir/Makefile.in	2007-10-29 09:49:14.000000000 +0100
+++ luatex-0.15/src/texk/web2c/luatexdir/Makefile.in	2007-10-30 07:38:52.000000000 +0100
@@ -8,7 +8,7 @@
 kpathsea_srcdir_parent = $(srcdir)/../..
 kpathsea_dir_parent = ../..
 
-ALL_CXXFLAGS = @CXXFLAGS@ @DEFS@ $(XXCFLAGS) -I. -I$(srcdir) -I$(kpathsea_dir_parent) -I$(kpathsea_srcdir_parent) @LIBXPDFCPPFLAGS@ -I$(LIBOBSDCOMPATDIR) -I$(LIBOBSDCOMPATDIR)/.. -I$(LIBOBSDCOMPATFSRCDIR) -I$(LIBOBSDCOMPATFSRCDIR)/..
+ALL_CXXFLAGS = @CXXFLAGS@ @DEFS@ $(XXCFLAGS) -I. -I$(srcdir) -I$(kpathsea_dir_parent) -I$(kpathsea_srcdir_parent) -I/usr/include/poppler -I$(LIBOBSDCOMPATDIR) -I$(LIBOBSDCOMPATDIR)/.. -I$(LIBOBSDCOMPATFSRCDIR) -I$(LIBOBSDCOMPATFSRCDIR)/..
 CXX = @CXX@
 
 .SUFFIXES: .cc .o
Index: luatex-0.15/src/texk/web2c/luatexdir/pdftosrc.cc
===================================================================
--- luatex-0.15.orig/src/texk/web2c/luatexdir/pdftosrc.cc	2007-10-29 09:49:14.000000000 +0100
+++ luatex-0.15/src/texk/web2c/luatexdir/pdftosrc.cc	2007-10-30 07:38:52.000000000 +0100
@@ -25,22 +25,24 @@
 #include <stdio.h>
 #include <string.h>
 #include <ctype.h>
-#include <aconf.h>
 #include <assert.h>
-#include <GString.h>
-#include <gmem.h>
-#include <gfile.h>
-#include "Object.h"
-#include "Stream.h"
-#include "Array.h"
-#include "Dict.h"
-#include "XRef.h"
-#include "Catalog.h"
-#include "Page.h"
-#include "GfxFont.h"
-#include "PDFDoc.h"
-#include "GlobalParams.h"
-#include "Error.h"
+
+#include <dirent.h>
+#include <poppler/goo/GooString.h>
+#include <poppler/goo/gmem.h>
+#include <poppler/goo/gfile.h>
+#include "poppler/Object.h"
+#include "poppler/UGooString.h"
+#include "poppler/Stream.h"
+#include "poppler/Array.h"
+#include "poppler/Dict.h"
+#include "poppler/XRef.h"
+#include "poppler/Catalog.h"
+#include "poppler/Page.h"
+#include "poppler/GfxFont.h"
+#include "poppler/PDFDoc.h"
+#include "poppler/GlobalParams.h"
+#include "poppler/Error.h"
 
 static XRef *xref = 0;
 
@@ -48,7 +50,7 @@
 {
     char *p, buf[1024];
     PDFDoc *doc;
-    GString *fileName;
+    GooString *fileName;
     Stream *s;
     Object srcStream, srcName, catalogDict;
     FILE *outfile;
@@ -62,8 +64,8 @@
                 "Usage: pdftosrc <PDF-file> [<stream-object-number>]\n");
         exit(1);
     }
-    fileName = new GString(argv[1]);
-    globalParams = new GlobalParams();
+    fileName = new GooString(argv[1]);
+    globalParams = new GlobalParams(NULL);
     doc = new PDFDoc(fileName);
     if (!doc->isOk()) {
         fprintf(stderr, "Invalid PDF file\n");
@@ -83,7 +85,7 @@
     }
     srcStream.initNull();
     if (objnum == 0) {
-        catalogDict.dictLookup("SourceObject", &srcStream);
+        catalogDict.dictLookup(UGooString("SourceObject"), &srcStream);
         if (!srcStream.isStream("SourceFile")) {
             fprintf(stderr, "No SourceObject found\n");
             exit(1);
Index: luatex-0.15/src/texk/web2c/luatexdir/utils.c
===================================================================
--- luatex-0.15.orig/src/texk/web2c/luatexdir/utils.c	2007-10-29 09:49:14.000000000 +0100
+++ luatex-0.15/src/texk/web2c/luatexdir/utils.c	2007-10-30 07:39:33.000000000 +0100
@@ -40,7 +40,7 @@
 
 #include "openbsd-compat.h"
 #include "png.h"
-#include "xpdf/config.h"        /* just to get the xpdf version */
+#include "poppler/poppler-config.h"        /* just to get the xpdf version */
 
 #define check_nprintf(size_get, size_want) \
     if ((unsigned)(size_get) >= (unsigned)(size_want)) \
@@ -1126,7 +1126,7 @@
 					"This is build %d, created on %dT%dZ\n"
                     "Compiled with libpng %s; using libpng %s\n"
                     "Compiled with zlib %s; using zlib %s\n"
-                    "Compiled with xpdf version %s\n",
+                    "Compiled with libpoppler version %s\n",
 					get_build_revision(), BUILD_DATE, BUILD_TIME,
                     PNG_LIBPNG_VER_STRING, png_libpng_ver,
                     ZLIB_VERSION, zlib_version, xpdfVersion);
