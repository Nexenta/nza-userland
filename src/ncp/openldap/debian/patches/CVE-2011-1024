Origin: cvs PatchSet 24620 from OPENLDAP_REL_ENG_2_4
Description: fix successful anonymous bind via chain overlay when using
 forwarded authentication failures
Bug: http://www.openldap.org/its/index.cgi/Software%20Bugs?id=6607

Index: openldap-2.4.23/servers/slapd/back-ldap/chain.c
===================================================================
--- openldap-2.4.23.orig/servers/slapd/back-ldap/chain.c	2011-03-16 09:21:55.000000000 -0500
+++ openldap-2.4.23/servers/slapd/back-ldap/chain.c	2011-03-16 09:22:02.000000000 -0500
@@ -854,6 +854,7 @@
 
 	/* we need this to know if back-ldap returned any result */
 	lb.lb_lc = lc;
+	sc2.sc_next = sc->sc_next;
 	sc2.sc_private = &lb;
 	sc2.sc_response = ldap_chain_cb_response;
 	op->o_callback = &sc2;
@@ -947,6 +948,7 @@
 
 	case LDAP_SUCCESS:
 	case LDAP_REFERRAL:
+		sr_err = rs->sr_err;
 		/* slapd-ldap sent response */
 		if ( !op->o_abandon && lb.lb_status != LDAP_CH_RES ) {
 			/* FIXME: should we send response? */
@@ -974,7 +976,7 @@
 		default:
 #endif /* LDAP_CONTROL_X_CHAINING_BEHAVIOR */
 			if ( LDAP_CHAIN_RETURN_ERR( lc ) ) {
-				rs->sr_err = rc;
+				sr_err = rs->sr_err = rc;
 				rs->sr_type = sr_type;
 
 			} else {
@@ -992,7 +994,8 @@
 	}
 
 	if ( lb.lb_status == LDAP_CH_NONE && rc != SLAPD_ABANDON ) {
-		op->o_callback = NULL;
+		/* give the remaining callbacks a chance */
+		op->o_callback = sc->sc_next;
 		rc = rs->sr_err = slap_map_api2result( rs );
 		send_ldap_result( op, rs );
 	}
