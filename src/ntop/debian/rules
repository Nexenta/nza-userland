#!/usr/bin/make -f
# Sample debian/rules that uses debhelper.
# GNU copyright 1997 to 1999 by Joey Hess.

# Uncomment this to turn on verbose mode.
#export DH_VERBOSE=1

# This is the debhelper compatability version to use.
export DH_COMPAT=4

configure: configure-stamp-gdchart configure-stamp-ntop
configure-stamp-gdchart:
	dh_testdir

	touch configure-stamp-gdchart

configure-stamp-ntop:
	dh_testdir
	./configure CFLAGS=-DMAKE_WITH_IGNORE_SIGPIPE \
		--prefix=/usr --libdir=/usr/lib \
		--sysconfdir=/etc --localstatedir=/var/lib --bindir=/usr/sbin \
		--mandir=/usr/share/man --enable-tcpwrap \
		--with-zlib-lib=/usr/lib --with-zlib-include=/usr/include \
		--with-libpng-lib=/usr/lib --with-libpng-include=/usr/include \
		--with-gd-lib=/usr/lib --with-gd-include=/usr/include \
	        --enable-sslv3 --enable-i18n

	touch configure-stamp-ntop

build: configure-stamp-gdchart build-stamp-gdchart configure-stamp-ntop build-stamp-ntop
build-stamp-gdchart:
	dh_testdir

	touch build-stamp-gdchart


build-stamp-ntop:
	dh_testdir

	$(MAKE)

	touch build-stamp-ntop

clean:
	dh_testdir
	dh_testroot
	rm -f build-stamp* configure-stamp*
#	debconf-updatepo

	# Add here commands to clean up after the build process.
	-$(MAKE) clean
	-$(MAKE) distclean

	-rm -f config.status config.cache config.log
	find . -type d -name ".deps" | xargs rm -Rf

	#cleanup generated files
	dh_clean plugins/*.inc plugins/*.la faq.html html/faq.html version.c

install: build
	dh_testdir
	dh_testroot
	dh_clean -k
	dh_installdirs

	$(MAKE) install DESTDIR=$(CURDIR)/debian/ntop
	$(MAKE) install-data-as DESTDIR=$(CURDIR)/debian/ntop

	cp debian/protocol.list $(CURDIR)/debian/ntop/etc/ntop
	chmod -x $(CURDIR)/debian/ntop/etc/ntop/*.*
	gunzip $(CURDIR)/debian/ntop/etc/ntop/*.gz
	cp debian/init.cfg $(CURDIR)/debian/ntop/etc/default/ntop

	# Added things for logcheck ignoring.
	cp debian/logcheck $(CURDIR)/debian/ntop/etc/logcheck/ignore.d.server/ntop
	cp debian/logcheck $(CURDIR)/debian/ntop/etc/logcheck/ignore.d.workstation/ntop
	cp debian/logcheck.paranoid $(CURDIR)/debian/ntop/etc/logcheck/ignore.d.paranoid/ntop
	# Added logrotate file.
	cp debian/logrotate $(CURDIR)/debian/ntop/etc/logrotate.d/ntop

	cp ChangeLog $(CURDIR)/debian/ntop/usr/share/doc/ntop/changelog
	find $(CURDIR)/debian/ntop/usr/share/ntop/html/ -type f \
		-exec chmod -x {} \;

# docs for dh_installdirs
DOCS=docs/FAQ docs/HACKING docs/KNOWN_BUGS \
	docs/README docs/TODO

binary-indep:

# Build architecture-dependent files here.
binary-arch: build install
	dh_testdir
	dh_testroot
	dh_installdebconf -n
	dh_installdocs $(DOCS)
	dh_installexamples
	dh_installmenu
	dh_installinit -n
	dh_installcron
	dh_installmanpages png.5 zlib.3 libpng.3 libpngpf.3 ; \
	dh_installinfo
	dh_installchangelogs
	dh_link
	dh_strip
	dh_compress
	dh_fixperms
	dh_installdeb
	dh_shlibdeps
	dh_gencontrol
	dh_md5sums
	dh_builddeb

binary: binary-arch
.PHONY: build clean binary-arch binary install configure
