#!/usr/bin/make -f

BUILD = build-tree

CFLAGS += \
		  -Wformat -Wformat-security -D_FORTIFY_SOURCE=2 \
		  -fstack-protector

LDFLAGS = -lssp_nonshared -lssp

CC_32 = gcc -m32
CC_64 = gcc -m64

CFLAGS_32 = 
CFLAGS_64 = 

LDFLAGS_32 =
LDFLAGS_64 =

# See config.layout
APR_LAYOUT32=Nexenta
APR_LAYOUT64=$(APR_LAYOUT32)-amd64

CONFIGURE_OPTIONS_COMMON = \
    --enable-threads \
    --enable-other-child \
    --enable-nonportable-atomics \
    --enable-shared

CONFIGURE_OPTIONS_32 = \
    --includedir=\$${prefix}/usr/include/apr-1.0 \
    --with-installbuilddir=\$${prefix}/usr/share/apr-1.0/build \
    --enable-layout=${APR_LAYOUT32} \

CONFIGURE_OPTIONS_64 = \
    --includedir=\$${prefix}/usr/include/amd64/apr-1.0 \
    --with-installbuilddir=\$${prefix}/usr/share/apr-1.0/amd64/build/ \
    --enable-layout=${APR_LAYOUT64} \

build binary clean binary-indep binary-arch install:
	dh $@


# We use specific configure options
override_dh_auto_configure: configure32-stamp configure64-stamp
configure%-stamp: configure
	mkdir -p $(BUILD)/$*
	cd $(BUILD)/$* && $(CURDIR)/configure \
		$(CONFIGURE_OPTIONS_COMMON) \
		$(CONFIGURE_OPTIONS_$*) \
		CC="$(CC_$*)" \
		CFLAGS="$(CFLAGS_$*) $(CFLAGS)" \
		LDFLAGS="$(LDFLAGS_$*) $(LDFLAGS)"
	touch $@

override_dh_auto_build: build32-stamp build64-stamp $(BUILD)/32/docs/dox/apr.tag

configure: buildconf
	/bin/bash ./buildconf

# Build docs
$(BUILD)/32/docs/dox/apr.tag:
	mkdir -p $(BUILD)/32/docs/dox
	$(MAKE) -C $(BUILD)/32 dox


build%-stamp: configure%-stamp
	make -C $(BUILD)/$*
	touch $@

override_dh_auto_test:

override_dh_strip:
	dh_strip -p libapr1 --dbg-package=libapr1-dbg
	dh_strip --remaining-packages

override_dh_auto_install: install32-stamp install64-stamp
	sed -i "s,^dependency_libs=.*,dependency_libs=''," \
		$(CURDIR)/debian/tmp/usr/lib/{,amd64/}libapr-1.la

install%-stamp: build%-stamp
	make -C $(BUILD)/$* install DESTDIR=$(CURDIR)/debian/tmp


override_dh_auto_clean:
	rm -rf $(BUILD)
	rm -f *-stamp
	rm -f net
	rm -f configure

