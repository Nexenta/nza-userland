#! /bin/sh /usr/share/dpatch/dpatch-run
# Description: fix denial of service via PolyFromWKB() function and improper data.
# Origin: upstream, http://bazaar.launchpad.net/~mysql/mysql-server/mysql-5.1/revision/3452.1.42
# Bug: http://bugs.mysql.com/bug.php?id=51875

@DPATCH@
diff -urNad '--exclude=CVS' '--exclude=.svn' '--exclude=.git' '--exclude=.arch' '--exclude=.hg' '--exclude=_darcs' '--exclude=.bzr' mysql-5.1-5.1.49~/mysql-test/r/gis.result mysql-5.1-5.1.49/mysql-test/r/gis.result
--- mysql-5.1-5.1.49~/mysql-test/r/gis.result	2010-07-09 09:02:56.000000000 -0400
+++ mysql-5.1-5.1.49/mysql-test/r/gis.result	2010-11-08 11:07:09.000000000 -0500
@@ -1057,4 +1057,11 @@
 SELECT Polygon(12345123,'');
 Polygon(12345123,'')
 NULL
+#
+# BUG#51875: crash when loading data into geometry function polyfromwkb
+#
+SET @a=0x00000000030000000100000000000000000000000000144000000000000014400000000000001840000000000000184000000000000014400000000000001440;
+SET @a=POLYFROMWKB(@a);
+SET @a=0x00000000030000000000000000000000000000000000144000000000000014400000000000001840000000000000184000000000000014400000000000001440;
+SET @a=POLYFROMWKB(@a);
 End of 5.1 tests
diff -urNad '--exclude=CVS' '--exclude=.svn' '--exclude=.git' '--exclude=.arch' '--exclude=.hg' '--exclude=_darcs' '--exclude=.bzr' mysql-5.1-5.1.49~/mysql-test/t/gis.test mysql-5.1-5.1.49/mysql-test/t/gis.test
--- mysql-5.1-5.1.49~/mysql-test/t/gis.test	2010-07-09 09:02:27.000000000 -0400
+++ mysql-5.1-5.1.49/mysql-test/t/gis.test	2010-11-08 11:07:09.000000000 -0500
@@ -722,4 +722,14 @@
 SELECT Polygon(1234512,'');
 SELECT Polygon(12345123,'');
 
+
+--echo #
+--echo # BUG#51875: crash when loading data into geometry function polyfromwkb
+--echo #
+SET @a=0x00000000030000000100000000000000000000000000144000000000000014400000000000001840000000000000184000000000000014400000000000001440;
+SET @a=POLYFROMWKB(@a);
+SET @a=0x00000000030000000000000000000000000000000000144000000000000014400000000000001840000000000000184000000000000014400000000000001440;
+SET @a=POLYFROMWKB(@a);
+
+
 --echo End of 5.1 tests
diff -urNad '--exclude=CVS' '--exclude=.svn' '--exclude=.git' '--exclude=.arch' '--exclude=.hg' '--exclude=_darcs' '--exclude=.bzr' mysql-5.1-5.1.49~/sql/spatial.cc mysql-5.1-5.1.49/sql/spatial.cc
--- mysql-5.1-5.1.49~/sql/spatial.cc	2010-07-09 08:35:15.000000000 -0400
+++ mysql-5.1-5.1.49/sql/spatial.cc	2010-11-08 11:07:09.000000000 -0500
@@ -522,7 +522,7 @@
   n_points= wkb_get_uint(wkb, bo);
   proper_length= 4 + n_points * POINT_DATA_SIZE;
 
-  if (len < proper_length || res->reserve(proper_length))
+  if (!n_points || len < proper_length || res->reserve(proper_length))
     return 0;
 
   res->q_append(n_points);
@@ -740,7 +740,9 @@
   if (len < 4)
     return 0;
 
-  n_linear_rings= wkb_get_uint(wkb, bo);
+  if (!(n_linear_rings= wkb_get_uint(wkb, bo)))
+    return 0;
+
   if (res->reserve(4, 512))
     return 0;
   wkb+= 4;
